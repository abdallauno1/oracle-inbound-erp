CREATE OR REPLACE PACKAGE "PKG_XTEL_IMPORT_C" AS

  -- ---------------------------------------------------------
  -- SM1 VERSION 6.0
  -- ---------------------------------------------------------

  -- ---------------------------------------------------------
  -- NOTES FOR MERGE AND CHANGE OF RELEASE
  -- This Package is version SM1 VERSION 6.0

  -- DO NOT MERGE IT TO PREVIOUS VERSIONS WITHOUT ASKING XTEL TEAM

  -- This Package reads and works only with its configuration set on
     --T904TABHEADX_INT
     --T906TABROWSX_INT

     --T904TABHEADX where CODTAB In ("REFDAT|FIELD_INFO", "REFDAT|WF_STATUS", "REFDAT|XIN_TABLES", "REFDAT|XOUT_TABLES")
     --T906TABROWSX where CODTAB In ("REFDAT|FIELD_INFO", "REFDAT|WF_STATUS", "REFDAT|XIN_TABLES", "REFDAT|XOUT_TABLES")

  -- ---------------------------------------------------------

  -- ---------------------------------------------------------
  -- History
  -- ---------------------------------------------------------

  -- 2014 12 19: 026; Mbandiera; WI 33433; Enhancement: common; calls PKG_UTILS.get_optinfo_as_string specify source table
  --                                                               T906TABROWSX_INT in order to gain performance in P_INIT_FIELD_ARRAY procedure
  -- 2014 12 19: 026; Mbandiera; WI 33433; Fixes : T062; fixed error on updating T062UMCONV
  -- 2014 12 19: 025; Mbandiera; WI 33433; Fixes : Orders; product hier; f_check_format_d
  -- 2014 11 13; 024: AZumbo   ; WI 33433; Fix trim dati in input nelle F_CHECK_FORMAT_X
  -- 2014 10 23; 023: MBandiera; WI 33433; Enhancement T920EXCHANGERATES import
  -- 2014 10 07; 022: MBandiera; WI 33200; TA5152_PROMOARTICLE_LISTfixed a bug on deleting no more present promo price ( it has not to compare DTEFROM field)
  -- 2014 08 08; 021: Mbandiera; WI 32462;  some changes in T064PARTLIST import
                      -- 1. T064 loading has been splitted from T060 import

  -- 2014 07 14; 020: Mbandiera; WI 32087;  some changes in T078WHSBALANCE import
                      -- 1. T078 loading will be splitted from T060 import . it will be a loading procedure  aside the article one.
                      -- 2. T078 will load only warehouse of type "PHISICAL WAREHOUSES" and it will not touch the "VAN SALES " ones.    see  t078.codwhs= T902[WHS].codtab -->  T902[WHS].optinfo = 0 (phisical); T902[WHS].optinfo = 1 (van sales)
                      -- 3. before deleting T078WHSBALANCE we need to delete first child table T078WHSBALANCE_BATCH records ( it is for van sales only so it should contain zero records for phisical wharehouses )

  -- 2014 07 14; 019: Mbandiera; WI 32070;
  --                             1. bugfix T064 kit, for each article when an error is found on a kit record it skips all other kit records on the same article
  --                             2. bugfix T902 , if T900.CODCONFIG is set to 'SM1' then it has to skip T902 loading
  -- 2014 05 16; 018: Mbandiera; WI 29729; Added record initialization in order not to get error if some new "not null" field will be added on master data
  -- 2014 04 04; 017: Mbandiera; WI 29729; Added Projected Invoices T661REAL
  -- 2014 02 26; 016: Mbandiera; WI 28211; Passive invoices, Products, Promo --> Added external configuration for first workflow status
  -- 2014 02 20; 015: Mbandiera; WI 28211; Changed Passive invoices loading bug on FLGFAKE maintenance
  -- 2014 02 13; 014: Mbandiera; WI 28211; Changed Passive invoices loading logig from UPDATE/INSERT to DELETE/INSERT
  -- 2014 02 13; 013: Mbandiera; WI 28211; Added SUPPLIER flow
  -- 2013 12 04; 012; Mbandiera; WI 28211; TA5150/TA5151/TA5152 + Added fields allignment +
  -- 2013 11 15; 012; Mbandiera; WI 28211; Added fields allignment
  -- 2013 11 15; 012; Mbandiera; WI 28211; PRICELIST; Changed the closure of details that are no more loaded from ERP ( it closes the dtetodetail and set no more flgann=-1)
  -- 2013 10 07; 011: Mbandiera;  New Format Check enhancement
  -- 2013 09 18; 010: Mbandiera;  Added new DSD fields on T030, T041, T060
  -- 2013 05 16; 010: Mbandiera;  modified check on T035LOGGEDUSER when starting mainload ;
  -- 2013 03 19; 009: Mbandiera;  added check on T035LOGGEDUSER when record seems to be locked
  -- 2013 02 06; 008; Mbandiera;  F_CHECK_FORMAT_S; Changed call from LENGTH(CHAR Unit of measure) to LENGTHB( BYTE Unit of measure)
  --                              because we could have different parameter NLS_LENGTH_SEMANTICS (BYTE or CHAR) and the default in COL table is
  --                              always in BYTE unit of measure.
  -- 2013 02 01; 007; IVasilescu;  LOAD_TA500X_PROMO ; Added Promo Loader
  -- 2013 01 03; 006; Mbandiera;  LOAD_TA019X_SURVEYS ; Added Activities Loader

  -- 2012 12 31; 005; Mbandiera;  P_INIT_SM1_FIELD_ARRAY ;Moved the configuratio of SM1 Fields from T906TABROWSX to T906TABROWSX_INT
  --                              F_CHECK_FORMAT_N; Added Check on numeric data length
  -- 2012 12 27; 004; Mbandiera;  P_T062_UPD_UMCONV ; Added PI_CODART/PI_CODDIV As optional input
  --                              LOAD_T06X_PRODUCTS ; calls P_T062_UPD_UMCONV only for modified articles

  -- 2012 12 27; 003; Mbandiera; LOAD_T04X_CUSTOMERS; added new fields to T049PVCATEGORY ( CODPARTY_CLUSTER  VARCHAR2(30),
  --                                                                  CODLEV_CLUSTER    VARCHAR2(30),
  --                                                                  CODHIER_CLUSTER   VARCHAR2(30),
  --                                                                  CODASSORTMENTTYPE_CLUSTER VARCHAR2(30))
  -- 2012 12 24; 002; Mbandiera; maintenance of default value for each field
  -- 2012 12 19; 001; Mbandiera; LOAD_T07X_PRICELIST; Added T073CUSTOMERTOAPPLY maintenance
  -- P R O C E D U R E
  /*============================================================================*/
  /*         Main Procedure  for Data Load                                      */
  /*============================================================================*/


  PROCEDURE MAINLOAD(PI_OPERATION    IN VARCHAR2,
                   PO_CODPROCESS    OUT NUMBER,
                   PO_MSG           OUT VARCHAR2,
                   PO_STATUS        OUT NUMBER,
                   PI_CODE_CHAR_A IN VARCHAR2 DEFAULT NULL,
                   PI_CODE_CHAR_B  IN VARCHAR2 DEFAULT NULL,
                   PI_CODE_NUM_A IN NUMBER DEFAULT NULL,
                   PI_CODE_NUM_B  IN NUMBER DEFAULT NULL,
                   PI_DATE_A       IN DATE DEFAULT NULL,
                   PI_DATE_B        IN DATE DEFAULT NULL);



  --
   PROCEDURE P_T062_UPD_UMCONV(PI_PROGR_H         IN NUMBER,
                                 PI_PROGR_D         IN NUMBER,
                                 PI_CODART          IN VARCHAR2 DEFAULT NULL,
                                 PI_CODDIV          IN VARCHAR2 DEFAULT NULL);

   PROCEDURE LOAD_TA5150_PROMO_HIER(pi_progr_h  IN NUMBER,
                                   po_msg      OUT VARCHAR2,
                                   po_status   OUT NUMBER);



   /*
CREATE OR REPLACE TYPE "X_FIELD_INFO_T"                                          AS OBJECT (
   FIELD_NAME             VARCHAR2(60),
   FIELD_LENGTH           NUMBER(9),
   FLG_DB_NULLABLE        NUMBER(1),
   FLG_SM1_NULLABLE       NUMBER(1),
   FLG_SM1                NUMBER(1),
   FIELD_DEF_DB_VALUE     VARCHAR2(255),
   FIELD_DEF_SM1_VALUE    VARCHAR2(255),
   FIELD_QTAB             VARCHAR2(60),
   FIELD_QTAB_MANDATORY   NUMBER(1),
   FIELD_RANGE            VARCHAR2(60),
   FIELD_TYPE             VARCHAR2(2))*/


   TYPE X_FIELD_INFO_ARRAY IS table of X_FIELD_INFO_T index by VARCHAR2(255);

   PROCEDURE P_INIT_SM1_FIELD_ARRAY ( PI_TABLE_NAME    IN VARCHAR2,
                                    PO_F_INFO          OUT X_FIELD_INFO_ARRAY,
                                    PO_STATUS          OUT NUMBER,
                                    PO_MESSAGE         OUT VARCHAR2);

   FUNCTION F_CHECK_FORMAT_S ( PI_CODDIV        IN VARCHAR2,
                              PI_DATA_VALUE    IN VARCHAR2,
                              PI_DATA_NAME     IN VARCHAR2,
                              PI_FIELD_INFO    IN X_FIELD_INFO_ARRAY,
                              PIO_STATUS       IN OUT NUMBER,
                              PIO_MSG          IN OUT VARCHAR2) RETURN VARCHAR2;

    FUNCTION F_CHECK_FORMAT_N ( PI_CODDIV        IN VARCHAR2,
                              PI_DATA_VALUE    IN VARCHAR2,
                              PI_DATA_NAME     IN VARCHAR2,
                              PI_FIELD_INFO    IN X_FIELD_INFO_ARRAY,
                              PIO_STATUS       IN OUT NUMBER,
                              PIO_MSG          IN OUT VARCHAR2) RETURN NUMBER;
    FUNCTION F_CHECK_FORMAT_D ( PI_CODDIV        IN VARCHAR2,
                              PI_DATA_VALUE    IN VARCHAR2,
                              PI_DATA_NAME     IN VARCHAR2,
                              PI_FIELD_INFO    IN X_FIELD_INFO_ARRAY,
                              PIO_STATUS       IN OUT NUMBER,
                              PIO_MSG          IN OUT VARCHAR2) RETURN DATE ;
END PKG_XTEL_IMPORT_C;
/
CREATE OR REPLACE PACKAGE BODY "PKG_XTEL_IMPORT_C" AS

  GL_INIT_REC VARCHAR2(4000):=NULL; -- Used to init records with default values
  ----
  ---- Order Status
  GL_STORD_ANN_BY_ERP      VARCHAR2(30) := ''; -- Order Head Cancelled by ERP
  GL_STORD_SENT_TO_ERP     VARCHAR2(30) := ''; -- Order Head sent from  SM1 to ERP
  GL_STORD_RECEIVED_BY_ERP VARCHAR2(30) := ''; -- Order Head received by ERP
  GL_STORD_NOT_UPDATABLE   VARCHAR2(30) := ''; -- Order Head no more updatable by ERP
  GL_STROW_ANN_BY_ERP      VARCHAR2(30) := ''; -- Order Row Cancelled by ERP
  GL_STROW_NOT_UPDATABLE   VARCHAR2(30) := ''; -- Order Row no more updatable by ERP
  GL_STROW_CANC            VARCHAR2(30) := '';
  GL_STROW_ANN             VARCHAR2(30) := '';
       VLMSGERRORDATA  varchar2(100) := 'A';
       VLMSGERRORDATA_0 INT :=-1;

 --
  GL_ERP_USERS             VARCHAR2(50) := ''; -- ERP recognized users
  -- Used to recognize those rows no more returned by ERP
 C_T106_STATUS_PREFIX     VARCHAR2(20):= 'NOTRETURNED-';
  -- C_T106_STATUS_PREFIX     VARCHAR2(20):= '';--- Ganesh Testing
  C_T106_STATUS_PREFIX_LEN NUMBER      := LENGTH(C_T106_STATUS_PREFIX);

  TYPE rec_type_row is table of VARCHAR2(50) index by VARCHAR2(50);
  gl_st_T100  rec_type_row;


  --- CONSTANTS
  C_ADDR_DEF VARCHAR2(1):= '1';
  --
  C_PRICELIST_DOCTYPE VARCHAR2(1):= 'P';
  --
  C_DAYS_OF_LOG NUMBER := 90;
  --
  C_SYSUSR VARCHAR2(5) := 'SYSH';
  C_XINSTATUS_LOCK NUMBER := 3;
  C_XINSTATUS_ERR  NUMBER := 9;
  C_XINSTATUS_OK   NUMBER := 0;
  --
  -- FORMATS
  C_SAP_FORMAT_DATE   VARCHAR2(30) := 'YYYY/MM/DD';
  --C_SM1_FORMAT_NUMBER VARCHAR2(30) := '99999999999999999999.999999999';
  C_SM1_FORMAT_DATE   VARCHAR2(30) := 'MM/DD/YYYY HH24:MI:SS';
  C_SM1_NULL_DATE     DATE := TO_DATE ('12/30/1899','MM/DD/YYYY');
  C_SM1_FROM_DATE     DATE := TO_DATE ('01/01/2000','MM/DD/YYYY');
  C_SM1_TO_DATE       DATE := TO_DATE ('12/31/9999','MM/DD/YYYY');
  --
  C_SM1_NULL_CODPROCESS NUMBER(1):= 0;
  --
  C_UPDATED_BY_HOST   NUMBER(1) := 0; -- when the field si set to updated by host it means that the value should be read from XIN
                                                        -- otherwise it means that the field is managed by sm1
  -- WORKFLOW management

  C_WORKFLOWID_T060   TA2302WORKFLOWSTATES.WORKFLOWID%TYPE   := 60;
  C_WORKFLOWID_TA1050 TA2302WORKFLOWSTATES.WORKFLOWID%TYPE   := 2000;
  C_WORKFLOWID_TA5000 TA2302WORKFLOWSTATES.WORKFLOWID%TYPE   := 5000;


  -- ARRAY

  /*create   TYPE X_FIELD_INFO_T AS OBJECT (

   FIELD_NAME            VARCHAR2(60),
   FIELD_LENGTH          NUMBER(9),
   FLG_NULLABLE          NUMBER(1),
   FLG_SM1               NUMBER(1),
   FIELD_DEF_SM1_VALUE   VARCHAR2(255),
   FIELD_DEF_DB_VALUE    VARCHAR2(255),
   FIELD_TYPE            VARCHAR2(2))
   */
  -- FUNCTIONS AND PROCEDURES

   -- -------------------------------------------------------------------------------
   -- Login user
   -- vForce != 0 ---> previous login will be erased

   -- Return IDSession
   --         NULL when login is denied

   -- MB -- 2013 05 16; 010: this version differs from PKG_UTILS in two parts

   --  first: because it allows
   --       same user to log with different vappname. We need it because PKG_XTEL_IMPORT_C
   --       should be allowed to run concurrently with different VOPERATION parameters
   --       EG. CUSTOMERS and PRODUCT import should be allowed to run at same time
   --  second: it consider a T035 record tobe valid only last db check has been done within 1 day.
   --
   -- --------------------------------------------------------------------------------
   FUNCTION F_USER_LOGIN(vcodusr IN VARCHAR,
                       vforce IN NUMBER DEFAULT 0,
                       vappname IN VARCHAR2 DEFAULT NULL,
                       vmachine IN VARCHAR2 DEFAULT NULL) RETURN VARCHAR2 IS
      PRAGMA AUTONOMOUS_TRANSACTION;
      vidsession VARCHAR2(30):=null;
      vidlog NUMBER;
   BEGIN

      IF vforce != 0 THEN
         DELETE t035loggedusers
          WHERE codusr = vcodusr;
      END IF;

      BEGIN

      SELECT idsession
        INTO vidsession
        FROM t035loggedusers
       WHERE codusr  = vcodusr
        AND  appname = vappname
        AND  ( xsysdate - lastcheck ) < 1;

      EXCEPTION WHEN OTHERS THEN
        NULL;
      END;

      IF vidsession is null then

            PKG_UTILS.getprogressive('IDSESSION',
                           vidsession);

            INSERT INTO t035loggedusers
               (codusr,
                idsession,
                dtelogin,
                machine,
                flgkilled,
                appname,
                lastcheck)
            VALUES
               (vcodusr,
                vidsession,
                xsysdate,
                vmachine,
                0,
                vappname,
                xsysdate);

            vidlog := PKG_UTILS.log_start('USE',
                                'LOCAL',
                                NULL,
                                NULL,
                                'PKG_UTILS.USER_LOGIN',
                                vidsession,
                                vcodusr);
            COMMIT;
      ELSE
         vidsession := null;
      END IF;

      RETURN vidsession;
   END;

  /*============================================================================*\
  /* Name: F_CHECK_FORMAT_S
     Description: check if the string in input is in correct format (length) to be stored in SM1 field

     Input parameters :     PI_DATA_VALUE    -- value in xin table
                            PI_DATA_NAME     -- field name
                            PI_FIELD_INFO    -- field info
                            PIO_STATUS IN OUT Parameter, -1 if errors , PIO_STATUS prev value if no errors
                            PIO_MSG    IN OUT Parameter, Sql errmsg if errors , prev value if no errors

     To each value loaded from SSA tables to SM1 tables will be applied the following checks:
     •  Field type and format: the value on SSA field must be converted in the SM1 original field type and format should follow the format described in paragraph “1.2.2 Data Type and Format”
     •  Field length: value length should not exceed the original field length.
     •  Field Mandatory : when set in the configuration, field value should not be empty
     •  Mandatory Decode Table: when set in the configuration, field value should be present in the respective decode table
     •  Value Range: when set in the configuration, field value should be in the value range .(NOT IMPLEMENTED YET)
     •  Default value: If the field value is null(empty) and the field is not nullable on db, then it takes first the SM1 default value(when exists) then the db default(when exists)

     Returns the STRING if it is in correct format
     Returns error when an error occours

     Author : Mariangela Bandiera
     Creation Date : 23 August 2012
     ----
     Updates :
       -- 2013 10 07; 011: Mbandiera;  New Format Check enhancement; qtabs info, qtabs mandatorym field mandatory, value range
       -- 2012 12 24; 002; Mbandiera; maintenance of default value for each field
       --
       -- 2013 02 06; 008; Mbandiera;  F_CHECK_FORMAT_S; Changed call from LENGTH(CHAR Unit of measure) to LENGTHB( BYTE Unit of measure)
       --                              because we could have different parameter NLS_LENGTH_SEMANTICS (BYTE or CHAR) and the default in COL table is
       --                              always in BYTE unit of measure.

    ============================================================================ */
  FUNCTION F_CHECK_FORMAT_S ( PI_CODDIV        IN VARCHAR2,
                              PI_DATA_VALUE    IN VARCHAR2,
                              PI_DATA_NAME     IN VARCHAR2,
                              PI_FIELD_INFO    IN X_FIELD_INFO_ARRAY,
                              PIO_STATUS       IN OUT NOCOPY NUMBER,
                              PIO_MSG          IN OUT NOCOPY VARCHAR2) RETURN VARCHAR2 AS

   VL_DATA    VARCHAR2(4000);
   VL_LENGTH  NUMBER:= 0;
   VL_MESSAGE VARCHAR2(2000);
   VL_DEF_FIELD_VALUE VARCHAR2(255);
   VL_FIELD_NULLABLE NUMBER:=0;
   VL_DECODE   NUMBER;
   --VL_DATANAME VARCHAR2(60):= PI_DATA_NAME||'.'||NVL(PI_CODDIV, 'ALL');
   VL_DATANAME VARCHAR2(60):= PI_DATA_NAME||'.'||'ALL'; -- DIVISIONAL PROPERTIES IS NOT IMPLEMENTED YET
    BEGIN
     -- def_value contains the default value on T906 and ( if it is null the default value on db )
      -- Special values 'NULL' --> null

     VL_DEF_FIELD_VALUE    := CASE WHEN PI_FIELD_INFO(VL_DATANAME).FIELD_DEF_SM1_VALUE IS NULL OR PI_FIELD_INFO(VL_DATANAME).FIELD_DEF_SM1_VALUE = 'NULL'
                                   THEN PI_FIELD_INFO(VL_DATANAME).FIELD_DEF_DB_VALUE
                                   ELSE PI_FIELD_INFO(VL_DATANAME).FIELD_DEF_SM1_VALUE END;

     VL_LENGTH             := PI_FIELD_INFO(VL_DATANAME).FIELD_LENGTH;
     VL_FIELD_NULLABLE     := CASE WHEN PI_FIELD_INFO(VL_DATANAME).FLG_DB_NULLABLE + PI_FIELD_INFO(VL_DATANAME).FLG_SM1_NULLABLE = -2
                              THEN -1
                              ELSE 0 END;
     --- ----------------------
     --- DEFAULT VALUE
     ---- ---------------------
     -- When field is not nullable and it is empty in SSA ( or it is sm1 managed only ) then we apply default value
     -- in fist case ( field is sm1 managed only) then default value will be applied only on fist row insert
     IF (  PI_FIELD_INFO(VL_DATANAME).FLG_SM1 <> 0 OR ( trim(PI_DATA_VALUE) IS NULL AND  VL_FIELD_NULLABLE = 0)) THEN
         VL_DATA := VL_DEF_FIELD_VALUE;
     ELSE
     --  no default value, value from SSA taken
         VL_DATA := trim(PI_DATA_VALUE);
     END IF;

     -- -----------------------
     -- Checks the length
     -- -----------------------
     IF TRIM(VL_DATA) IS NULL THEN
       VL_LENGTH := 0;
     ELSE
       VL_LENGTH := LENGTHB(VL_DATA) ;
     END IF;

     IF VL_LENGTH > PI_FIELD_INFO(VL_DATANAME).FIELD_LENGTH  THEN
       VL_MESSAGE := 'Value too long for '||PI_DATA_NAME|| ' found: '||VL_LENGTH||' , expected: '||PI_FIELD_INFO(VL_DATANAME).FIELD_LENGTH||'; ';
       PIO_STATUS := -1;
     END IF;

     -- -----------------------
     -- Mandatory decode table
     -- -----------------------
     IF ( PI_FIELD_INFO(VL_DATANAME).FIELD_QTAB_MANDATORY <> 0 ) THEN
     BEGIN
        select count(*) into vl_decode
        from QTABS where codtab = PI_FIELD_INFO(VL_DATANAME).FIELD_QTAB
                   and   codsys in ( PI_CODDIV, 'ALL')
                   and   cod = VL_DATA;

     EXCEPTION WHEN OTHERS THEN
       VL_MESSAGE := 'Error on retrieving decode for '||PI_DATA_NAME|| '; division: '||PI_CODDIV|| '; value: '||VL_DATA||'; qtabs: '||PI_FIELD_INFO(VL_DATANAME).FIELD_QTAB||'; ';
       PIO_STATUS := -1;
     END;
       IF vl_decode = 0 THEN
         VL_MESSAGE := 'No decode found for '||PI_DATA_NAME|| '; division: '||PI_CODDIV|| '; value: '||VL_DATA||'; qtabs: '||PI_FIELD_INFO(VL_DATANAME).FIELD_QTAB||'; ';
         PIO_STATUS := -1;
       END IF;
     END IF;


     -- -----------------------
     -- Range Value  COMING SOON .....
     -- -----------------------



     IF PIO_STATUS = 0 THEN
       RETURN VL_DATA;
     ELSE
       PIO_MSG    := PIO_MSG ||' '||VL_MESSAGE ;
       RETURN NULL;
     END IF;

  EXCEPTION WHEN OTHERS THEN
   PIO_STATUS := -1;
   PIO_MSG    := PIO_MSG ||' '||VL_DATANAME||' '||dbms_utility.format_error_backtrace() || ' ' || SQLERRM ;
   RETURN NULL;
  END F_CHECK_FORMAT_S;




  /*============================================================================*\
  /* Name: F_CHECK_FORMAT_N
     Description: check if the string in input is in correct format (length) to be stored in SM1 field
     The string shoul be stored in a field number of format C_SM1_FORMAT_NUMBER

     Input parameters :     PI_DATA_VALUE    - string value
                            PI_DATA_NAME     - sm1 field name
                            PI_FIELD_INFO    - field info
                            PIO_STATUS IN OUT Parameter, -1 if errors , PIO_STATUS prev value if no errors
                            PIO_MSG    IN OUT Parameter, Sql errmsg if errors , prev value if no errors

     To each value loaded from SSA tables to SM1 tables will be applied the following checks:
     •  Field type and format: the value on SSA field must be converted in the SM1 original field type and format should follow the format described in paragraph “1.2.2 Data Type and Format”
     •  Field length: value length should not exceed the original field length.
     •  Field Mandatory : when set in the configuration, field value should not be empty
     •  Value Range: when set in the configuration, field value should be in the value range .(NOT IMPLEMENTED YET)
     •  Default value: If the field value is null(empty) and the field is not nullable on db, then it takes first the SM1 default value(when exists) then the db default(when exists)

     Returns the NUMBER if it is in correct format
     Returns error when an error occours

     Author : Mariangela Bandiera
     Creation Date : 23 August 2012
     ----
     Updates :
     -- 2013 10 07; 011: Mbandiera;  New Format Check enhancement; qtabs info, qtabs mandatorym field mandatory, value range
     MB 24/12/2012 -- maintenance of field default value
     MB 31/12/2012 -- check on data length

    ============================================================================ */

  FUNCTION F_CHECK_FORMAT_N ( PI_CODDIV        IN VARCHAR2,
                              PI_DATA_VALUE    IN VARCHAR2,
                              PI_DATA_NAME     IN VARCHAR2,
                              PI_FIELD_INFO    IN X_FIELD_INFO_ARRAY,
                              PIO_STATUS       IN OUT NOCOPY NUMBER,
                              PIO_MSG          IN OUT NOCOPY VARCHAR2) RETURN NUMBER AS

   VL_DATA   VARCHAR2(255):= NULL;
   VL_NUMBER NUMBER:= NULL;
   VL_MESSAGE VARCHAR2(2000);
   VL_LENGTH    NUMBER;
   VL_DATALENGTH    NUMBER;
   --VL_DATANAME VARCHAR2(60):= PI_DATA_NAME||'.'||NVL(PI_CODDIV, 'ALL');
   VL_DATANAME VARCHAR2(60):= PI_DATA_NAME||'.'|| 'ALL'; -- DIVISIONAL PROPERTIES IS NOT IMPLEMENTED YET


   VL_DEF_FIELD_VALUE VARCHAR2(255):= NULL;
   VL_FIELD_NULLABLE NUMBER:=0;

   BEGIN

     -- def_value contains the default value on T906 and ( if it is null the default value on db )
      -- Special values 'NULL' --> null
     VL_DEF_FIELD_VALUE    := REPLACE( TRIM (
                               CASE WHEN PI_FIELD_INFO(VL_DATANAME).FIELD_DEF_SM1_VALUE IS NULL OR PI_FIELD_INFO(VL_DATANAME).FIELD_DEF_SM1_VALUE = 'NULL'
                                   THEN PI_FIELD_INFO(VL_DATANAME).FIELD_DEF_DB_VALUE
                                   ELSE PI_FIELD_INFO(VL_DATANAME).FIELD_DEF_SM1_VALUE
                              END ) , ',','.');

     VL_LENGTH             := PI_FIELD_INFO(VL_DATANAME).FIELD_LENGTH;
     VL_FIELD_NULLABLE     := CASE WHEN PI_FIELD_INFO(VL_DATANAME).FLG_DB_NULLABLE + PI_FIELD_INFO(VL_DATANAME).FLG_SM1_NULLABLE  = -2
                              THEN -1
                              ELSE 0 END;


    --- ----------------------
     --- DEFAULT VALUE
     ---- ---------------------
     -- When field is not nullable and it is empty in SSA ( or it is sm1 managed only ) then we apply default value
     -- in fist case ( field is sm1 managed only) then default value will be applied only on fist row insert
     IF (  PI_FIELD_INFO(VL_DATANAME).FLG_SM1 <> 0 OR ( trim(PI_DATA_VALUE) IS NULL AND  VL_FIELD_NULLABLE = 0)) THEN
         VL_DATA := VL_DEF_FIELD_VALUE;
     ELSE
     --  no default value, value from SSA taken
         VL_DATA := REPLACE(TRIM(trim(PI_DATA_VALUE)), ',','.');
     END IF;


     -- if it is a flag and it is null then the default value is always 0
     -- if it is a flag and it is not null then the default value is always -1
     IF ( VL_LENGTH = 1 AND INSTR(PI_DATA_NAME, 'FLG') > 0 AND VL_DATA IS NULL )
       THEN VL_NUMBER:=0;
     ELSIF( VL_LENGTH = 1 AND INSTR(PI_DATA_NAME, 'FLG') > 0 AND VL_DATA IS NOT NULL AND VL_DATA <> 0 )
       THEN VL_NUMBER:=-1;
     ELSE VL_NUMBER := to_number(VL_DATA);
     END IF;


     -- lENGTH CHECK
     VL_DATALENGTH := length (to_char((round(abs(vl_number),0))));
     IF ( VL_DATALENGTH > ROUND(VL_LENGTH)) THEN
       VL_MESSAGE := 'Value too long for '||PI_DATA_NAME|| ' found: '||VL_DATALENGTH||' , expected: '||VL_LENGTH||'; ';
       PIO_STATUS := -1;
       PIO_MSG    := PIO_MSG ||' '||VL_MESSAGE ;
     END IF;

     IF PIO_STATUS = 0 THEN
        RETURN VL_NUMBER;
     ELSE
        RETURN NULL;
     END IF;

   EXCEPTION WHEN OTHERS THEN
   PIO_STATUS := -1;
   PIO_MSG    := PIO_MSG ||' '||VL_DATANAME||': *'||VL_DATA||'* '||dbms_utility.format_error_backtrace() || ' ' || SQLERRM ;
   RETURN NULL;
   --

  END F_CHECK_FORMAT_N;

  --
  --
  /*============================================================================*\
  /* Name: F_CHECK_FORMAT_D
     Description: check if the string in input is in correct format  to be stored in SM1 field
     The string should be stored in a field date of format C_SM1_FORMAT_DATE

     Input parameters :     PI_DATA_VALUE    - string value
                            PI_DATA_NAME     - sm1 field name
                            PI_FIELD_INFO    - field info
                            PIO_STATUS IN OUT Parameter, -1 if errors , PIO_STATUS prev value if no errors
                            PIO_MSG    IN OUT Parameter, Sql errmsg if errors , prev value if no errors


    To each value loaded from SSA tables to SM1 tables will be applied the following checks:
     •  Field type and format: the value on SSA field must be converted in the SM1 original field type and format should follow the format described in paragraph “1.2.2 Data Type and Format”
     •  Field Mandatory : when set in the configuration, field value should not be empty
     •  Value Range: when set in the configuration, field value should be in the value range .(NOT IMPLEMENTED YET)
     •  Default value: If the field value is null(empty) and the field is not nullable on db, then it takes first the SM1 default value(when exists) then the db default(when exists)


     Returns the DATE if it is in correct format
     Returns error when an error occours

     Author : Mariangela Bandiera
     Creation Date : 23 August 2012
     ----
     Updates :
      -- 2013 10 07; 011: Mbandiera;  New Format Check enhancement; qtabs info, qtabs mandatorym field mandatory, value range
       MB 24/12/2012 -- maintenance of field default value

    ============================================================================ */
  FUNCTION F_CHECK_FORMAT_D ( PI_CODDIV        IN VARCHAR2,
                              PI_DATA_VALUE    IN VARCHAR2,
                              PI_DATA_NAME     IN VARCHAR2,
                              PI_FIELD_INFO    IN X_FIELD_INFO_ARRAY,
                              PIO_STATUS       IN OUT NOCOPY NUMBER,
                              PIO_MSG          IN OUT NOCOPY VARCHAR2) RETURN DATE AS


   VL_DATA DATE;
   VL_DEF_FIELD_VALUE_STR VARCHAR2(2000);
   VL_DEF_FIELD_VALUE DATE;
   VL_FIELD_NULLABLE NUMBER;

   --VL_DATANAME VARCHAR2(60):= PI_DATA_NAME||'.'||NVL(PI_CODDIV, 'ALL');
   VL_DATANAME VARCHAR2(60):= PI_DATA_NAME||'.'|| 'ALL'; -- DIVISIONAL PROPERTIES IS NOT IMPLEMENTED YET


   BEGIN

     -- def_value contains the default value on T906 and ( if it is null the default value on db )
     -- Special values 'NULL' --> null
     ---               'SYSDATE' or  'XSYSDATE' --> xsysdate

     VL_DEF_FIELD_VALUE_STR  :=  CASE WHEN PI_FIELD_INFO(VL_DATANAME).FIELD_DEF_SM1_VALUE IS NULL OR PI_FIELD_INFO(VL_DATANAME).FIELD_DEF_SM1_VALUE = 'NULL'
                                   THEN PI_FIELD_INFO(VL_DATANAME).FIELD_DEF_DB_VALUE
                                   ELSE PI_FIELD_INFO(VL_DATANAME).FIELD_DEF_SM1_VALUE
                                 END;


     VL_DEF_FIELD_VALUE    := CASE WHEN INSTR (UPPER(VL_DEF_FIELD_VALUE_STR), 'SYSDATE') > 0
                                THEN XSYSDATE
                                ELSE TO_DATE(VL_DEF_FIELD_VALUE_STR, C_SM1_FORMAT_DATE)
                               END;


     VL_FIELD_NULLABLE     := CASE WHEN PI_FIELD_INFO(VL_DATANAME).FLG_DB_NULLABLE + PI_FIELD_INFO(VL_DATANAME).FLG_SM1_NULLABLE  = -2
                              THEN -1
                              ELSE 0 END;


/*
     --- ----------------------
     --- DEFAULT VALUE
     ---- ---------------------
     -- When field is not nullable and it is empty in SSA ( or it is sm1 managed only ) then we apply default value
     -- in fist case ( field is sm1 managed only) then default value will be applied only on fist row insert
     IF (  PI_FIELD_INFO(VL_DATANAME).FLG_SM1 <> 0 OR ( trim(PI_DATA_VALUE) IS NULL AND  VL_FIELD_NULLABLE = 0)) THEN
         VL_DATA := TO_DATE(VL_DEF_FIELD_VALUE, C_SM1_FORMAT_DATE);
     ELSE
     --  no default value, value from SSA taken
         VL_DATA := TRUNC(TO_DATE(trim(PI_DATA_VALUE), C_SM1_FORMAT_DATE));
     END IF;
*/


     RETURN VL_DATA;

  EXCEPTION WHEN OTHERS THEN
   PIO_STATUS := -1;
   PIO_MSG    := PIO_MSG ||' '||PI_DATA_NAME||' '||dbms_utility.format_error_backtrace() || ' ' || SQLERRM||'; ';
   RETURN NULL;
   --

  END F_CHECK_FORMAT_D;

  /*============================================================================*\
  /* Name: P_INIT_SM1_FIELD_ARRAY
     Loads in a array the fields directly maintained by sm1
     Loads in a array the field length indexed by field name

     Input parameters :
                            PI_TABLE_NAME    - table name
     Output parameters :
                            PO_F_INFO   array with field info

     Return the ARRAYS


     Author : Mariangela Bandiera
     Creation Date : 23 August 2012
     ----
     Updates :

     -- 2013 10 07; 011: Mbandiera;  New Format Check enhancement; qtabs info, qtabs mandatorym field mandatory, value range
     -- 2012 12 31; 005; Mbandiera;  P_INIT_SM1_FIELD_ARRAY ;Moved the configuratio of SM1 Fields from T906TABROWSX to T906TABROWSX_INT

    ============================================================================ */

  PROCEDURE P_INIT_SM1_FIELD_ARRAY ( PI_TABLE_NAME    IN VARCHAR2,
                                     PO_F_INFO        OUT NOCOPY X_FIELD_INFO_ARRAY,
                                     PO_STATUS        OUT NOCOPY NUMBER,
                                     PO_MESSAGE       OUT NOCOPY VARCHAR2)  IS



   VL_FIELD_INFO    X_FIELD_INFO_T;
   --
   vl_size_start pls_integer;
   vl_size_end   pls_integer;
   vl_init_value varchar2(4000):= null;



   -- Array with fields INFO
/*
CREATE OR REPLACE TYPE "X_FIELD_INFO_T"                                          AS OBJECT (
   FIELD_NAME             VARCHAR2(60),
   FIELD_LENGTH           NUMBER(9),
   FLG_DB_NULLABLE        NUMBER(1),
   FLG_SM1_NULLABLE       NUMBER(1),
   FLG_SM1                NUMBER(1),
   FIELD_DEF_DB_VALUE     VARCHAR2(255),
   FIELD_DEF_SM1_VALUE    VARCHAR2(255),
   FIELD_QTAB             VARCHAR2(60),
   FIELD_QTAB_MANDATORY   NUMBER(1),
   FIELD_RANGE            VARCHAR2(60),
   FIELD_TYPE             VARCHAR2(2))*/


   CURSOR CL_COL IS
       SELECT CNAME FIELDNAME,
              C.coltype AS COLTYPE,
              CASE WHEN SCALE IS NULL THEN WIDTH
                   WHEN SCALE = 0 THEN PRECISION
                   ELSE PRECISION + (SCALE/10)
              END AS FIELD_LENGTH,
              CASE WHEN UPPER(C.NULLS) = 'NULL' THEN -1 ELSE 0 END AS FLG_DB_NULLABLE,
              -- When field is configurated in T906 then keep the default value in DESTABROW
              -- when the field si set to updated by host it means that the value should be read from XIN
              -- otherwise it means that the field is managed by sm1 and in DESTABROW there is the devault init value)
              -- IF DEFAULT value in T906 IS NULL then it takes the default value defined in the table
              C.defaultval,
              PKG_UTILS.GET_OPTINFO_EXT_AS_STRING(nvl(T.CODSYS,'ALL'),'FIELD_INFO',T.CODTABROW ,'DEF_VALUE')       AS DEFVALUE,
              PKG_UTILS.GET_OPTINFO_EXT_AS_BOOL  (nvl(T.CODSYS,'ALL'),'FIELD_INFO',T.CODTABROW ,'SM1_MANAGED')     AS FLG_SM1,
              PKG_UTILS.GET_OPTINFO_EXT_AS_STRING(nvl(T.CODSYS,'ALL'),'FIELD_INFO',T.CODTABROW ,'RANGE')           AS FIELD_RANGE,
              PKG_UTILS.GET_OPTINFO_EXT_AS_BOOL  (nvl(T.CODSYS,'ALL'),'FIELD_INFO',T.CODTABROW ,'MANDATORY_VALUE') AS FLG_SM1_MANDATORY,
              PKG_UTILS.GET_OPTINFO_EXT_AS_BOOL  (nvl(T.CODSYS,'ALL'),'FIELD_INFO',T.CODTABROW ,'MANDATORY_QTABS') AS FIELD_QTAB_MANDATORY,
              C.WIDTH, C.SCALE, C.PRECISION,
              S.COMMENTS             AS COMMENTS,
              NVL(T.CODSYS, 'ALL')   AS CODDIV
      FROM COL C
      inner join all_col_comments s on (s.table_name  = c.tname AND
                                        s.column_name = c.cname AND
                                        s.owner =  SYS_CONTEXT('USERENV','CURRENT_USER') )
      LEFT JOIN T906TABROWSX_INT T ON (T.CODTAB = 'FIELD_INFO' AND T.CODTABROW = C.TNAME||'.'||C.CNAME AND CODSYS = 'ALL' AND FLGANN = 0)
      WHERE TNAME  = PI_TABLE_NAME
      ORDER BY C.colno ASC;

   BEGIN

    GL_INIT_REC := NULL;

    FOR RL_COL IN CL_COL LOOP

         VL_FIELD_INFO:=NEW X_FIELD_INFO_T(NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL);


         VL_FIELD_INFO.FIELD_LENGTH     := RL_COL.FIELD_LENGTH;
         VL_FIELD_INFO.FLG_DB_NULLABLE  := NVL(RL_COL.FLG_DB_NULLABLE, -1);
         VL_FIELD_INFO.FLG_SM1_NULLABLE := (NVL(RL_COL.FLG_SM1_MANDATORY, 0)+1)*-1;
         VL_FIELD_INFO.FLG_SM1          := NVL(RL_COL.FLG_SM1, 0);


         VL_FIELD_INFO.FIELD_DEF_DB_VALUE :=
                                                       REPLACE(
                                                       REPLACE(SUBSTR(RL_COL.DEFAULTVAL,1,255),
                                                       CHR(10),''),
                                                       CHR(13),'');


         VL_FIELD_INFO.FIELD_DEF_SM1_VALUE := REPLACE(
                                              REPLACE(SUBSTR(RL_COL.DEFVALUE,1,255),
                                              CHR(10),''),
                                              CHR(13),'');


         -- ----------------------------------------------------------------------------------------------------------------------------------
         -- This is a workaround in order to avoid the exception "cannot insert null into field x " for all fields that will be
         -- added in the future in the SM1 master data with db clause NOT NULL.

         -- here we init the record with default values. First it applies db default value, If default value is missing
         -- it put 0 for numbers, ' ' for varchar, 30/12/1899 for date

         -- this value will be overwritten by all maintainted field in this package and will be applied
         -- for all fields not directly maintained by this package ( added fields )

         vl_init_value :=  case when VL_FIELD_INFO.FLG_DB_NULLABLE <> 0
                                -- field is nullable, we do not care to initialize it, it won't catch any error
                                then 'NULL'
                                else
                                -- field is not nullable we need to initialize it
                                     case when VL_FIELD_INFO.FIELD_DEF_DB_VALUE is not null
                                          -- there is the db default value, we apply it
                                          then VL_FIELD_INFO.FIELD_DEF_DB_VALUE

                                          else case when instr(RL_COL.COLTYPE, 'CHAR') > 0 THEN ''' '''
                                                    when RL_COL.COLTYPE ='NUMBER' THEN '0'
                                                    when RL_COL.COLTYPE ='DATE'   THEN 'to_date('''||C_SM1_NULL_DATE||''','''|| C_SM1_FORMAT_DATE||''')'
                                               end
                                     end
                           end;

        SELECT   CASE WHEN GL_INIT_REC IS NULL
                       THEN vl_init_value
                       ELSE GL_INIT_REC ||','||vl_init_value
                 END
         INTO GL_INIT_REC
         FROM DUAL  ;

         -- ----------------------------------------------------------------------------------------------------------------------------------

         VL_FIELD_INFO.FIELD_QTAB_MANDATORY := NVL(RL_COL.FIELD_QTAB_MANDATORY, 0);
         VL_FIELD_INFO.FIELD_RANGE          := REPLACE(
                                               REPLACE(SUBSTR(RL_COL.FIELD_RANGE,1,60),
                                               CHR(10),''),
                                               CHR(13),'');



         if instr(RL_COL.COMMENTS, 'QTABS=') > 0 then

               vl_size_start := instr(RL_COL.COMMENTS, 'QTABS=') +6;

               VL_FIELD_INFO.FIELD_QTAB  := trim(SUBSTRB( RL_COL.COMMENTS, vl_size_start, 60));

               vl_size_end := instr(VL_FIELD_INFO.FIELD_QTAB , '.COD') -1;
               if vl_size_end = -1 then
                  vl_size_end := instr(VL_FIELD_INFO.FIELD_QTAB , ',') -1;
               if vl_size_end = -1 then
                  vl_size_end := instr(VL_FIELD_INFO.FIELD_QTAB , ']')-1;
               end if;
               end if;

               VL_FIELD_INFO.FIELD_QTAB  := trim(SUBSTRB( VL_FIELD_INFO.FIELD_QTAB , 1, vl_size_end ));
         end if;


         PO_F_INFO(RL_COL.FIELDNAME||'.'||RL_COL.CODDIV):=VL_FIELD_INFO;
    END LOOP;


    GL_INIT_REC := 'SELECT '||GL_INIT_REC||'  FROM DUAL';


    PO_STATUS := 0;
    PO_MESSAGE := NULL;

   EXCEPTION WHEN OTHERS THEN
    PO_STATUS := -1;
    PO_MESSAGE := 'Error while retrieving SM1 info on '||PI_TABLE_NAME||' '||dbms_utility.format_error_backtrace() || ' ' || SQLERRM;


  END P_INIT_SM1_FIELD_ARRAY;

  /*============================================================================*\
  /* Name: P_XIN_MOVE_TO_LOG
     Moves staging area table into Log staging area table
     Does not move records in status LOCKED BY USER because it tries to reload them next import

     Input parameters :     PI_PROGR_H - unique sm1 job number ( T800SYSTEMACTIVITYLOG )
                            PI_PROGR_D  - detail process number
                            PI_TABLE_NAME    - table name

     Logs in T800 when error

     Author : Mariangela Bandiera
     Creation Date : 23 August 2012
     ----
     Updates :


    ============================================================================ */
  PROCEDURE P_XIN_MOVE_TO_LOG ( PI_PROGR_H IN NUMBER,
                               PI_PROGR_D IN NUMBER,
                               PI_TABLE_NAME    IN VARCHAR2)

  IS
  VL_SQL VARCHAR2(4000):=NULL;
  BEGIN


  VL_SQL := 'INSERT INTO XIN_'||PI_TABLE_NAME||'_LOG SELECT * FROM XIN_'||PI_TABLE_NAME||' WHERE SM1_CODPROCESS = '||PI_PROGR_H||' AND SM1_STATUS <> '||C_XINSTATUS_LOCK;
  EXECUTE IMMEDIATE (VL_SQL);
  VL_SQL := 'DELETE FROM XIN_'||PI_TABLE_NAME||' WHERE SM1_CODPROCESS = '||PI_PROGR_H||' AND SM1_STATUS <> '||C_XINSTATUS_LOCK;
  EXECUTE IMMEDIATE (VL_SQL);
  VL_SQL := 'UPDATE XIN_'||PI_TABLE_NAME||' SET SM1_CODPROCESS = '||C_SM1_NULL_CODPROCESS||' WHERE SM1_CODPROCESS = '||PI_PROGR_H;
  EXECUTE IMMEDIATE (VL_SQL);
  COMMIT;


  EXCEPTION WHEN OTHERS THEN
   ROLLBACK;
   PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                  PI_PROGR_D,
                                  TRIM(SUBSTR(SQLCODE, 1, 255)),
                                  TRIM(SUBSTR(VL_SQL||' '||PI_TABLE_NAME||' '||dbms_utility.format_error_backtrace() || ' ' || SQLERRM, 1, 255)));


  END P_XIN_MOVE_TO_LOG;

   /*============================================================================*\
  /* Name: P_XIN_INIT_INDEXES
     Init and rebuild indexes on XIN tables
     Rebuilds statistics

     Input parameters :      PI_PROGR_H - unique sm1 job number ( T800SYSTEMACTIVITYLOG )
                             PI_TABLE_NAME    - table name

     Logs in T800 when error

     Author : Mariangela Bandiera
     Creation Date : 10 Dec 2013
     ----
     Updates :


    ============================================================================ */
  PROCEDURE P_XIN_INIT_INDEXES ( PI_PROGR_H    IN NUMBER,
                                 PI_TABLE_NAME IN VARCHAR2)

  IS

  VL_PROGR_D NUMBER(9):=0;
  VL_SQL VARCHAR2(4000):=NULL;
  vl_Type VARCHAR2(30) := 'Mandatory';

  BEGIN

      vl_Type := 'Mandatory';
      VL_SQL := 'Alter index idx1_XIN_'||PI_TABLE_NAME||' rebuild compress';
      EXECUTE IMMEDIATE (VL_SQL);


      vl_Type := 'NOT Mandatory'; -- it has been created only for few tables ( See PKG_UTILS.BUILD_STAGING_AREA)
      VL_SQL := 'Alter index idx3_XIN_'||PI_TABLE_NAME||' rebuild compress';
      EXECUTE IMMEDIATE (VL_SQL);

      vl_Type := 'NOT Mandatory'; -- it works only for Enterprise edition
      VL_SQL := 'Analyze table XIN_'||PI_TABLE_NAME||' compute statistics';
      EXECUTE IMMEDIATE (VL_SQL);


   EXCEPTION WHEN OTHERS THEN
   ROLLBACK;

      if  vl_Type = 'Mandatory' then

          VL_PROGR_D := PKG_UTILS.LOG_NEW_DETAIL(PI_PROGR_H,
                                                 'INIT INDEXES',
                                                 'XIN_'||PI_TABLE_NAME,
                                                 0,
                                                 NULL);

          PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                         VL_PROGR_D,
                                         SQLCODE,
                                         SUBSTR(VL_SQL||' '||dbms_utility.format_error_backtrace() || ' ' || SQLERRM, 2000));

          --
          PKG_UTILS.LOG_END_DETAIL(PI_PROGR_H,
                                   VL_PROGR_D,
                                   0,
                                   3,
                                   3,
                                   0);

      else
        NULL;
      end if;

  END P_XIN_INIT_INDEXES;
   /*============================================================================*\
  /* Name: P_XIN_CLEANUP_LOG
     Clean XIN LOG tables from records older than C_DAYS_OF_LOG days

     Input parameters :      PI_PROGR_H - unique sm1 job number ( T800SYSTEMACTIVITYLOG )
                             PI_TABLE_NAME    - table name

     Logs in T800 when error

     Author : Mariangela Bandiera
     Creation Date : 23 August 2012
     ----
     Updates :


    ============================================================================ */
  PROCEDURE P_XIN_CLEANUP_LOG ( PI_PROGR_H    IN NUMBER,
                                PI_TABLE_NAME IN VARCHAR2)

  IS

  VL_PROGR_D NUMBER(9):=0;
  VL_SQL VARCHAR2(4000):=NULL;

  BEGIN

      VL_SQL := 'DELETE XIN_'||PI_TABLE_NAME||'_LOG WHERE SM1_DTEPROCESS < SYSDATE - '||C_DAYS_OF_LOG;
      EXECUTE IMMEDIATE (VL_SQL);

      COMMIT;

   EXCEPTION WHEN OTHERS THEN
   ROLLBACK;
      VL_PROGR_D := PKG_UTILS.LOG_NEW_DETAIL(PI_PROGR_H,
                                             'CLEAN UP',
                                             'XIN_'||PI_TABLE_NAME||'_LOG',
                                             0,
                                             NULL);

      PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                     VL_PROGR_D,
                                     SQLCODE,
                                     SUBSTR(VL_SQL||' '||dbms_utility.format_error_backtrace() || ' ' || SQLERRM, 2000));

      --
      PKG_UTILS.LOG_END_DETAIL(PI_PROGR_H,
                               VL_PROGR_D,
                               0,
                               1,
                               1,
                               0);


  END P_XIN_CLEANUP_LOG;
  /*============================================================================*\
  /* Name:  T062_UPD_UMCONV
     Description: inserts into T062UMCONV all possible combinations of conversions
                  UMTO-UMFROM deduced by the existing ones in the original T062UMCONV

     Example if already exists   ART=1 DIV=1 UMFROM=Kg UMTO=Hg
                                 ART=1 DIV=1 UMFROM=Hg UMTO=Gr

             it creates          ART=1 DIV=1 UMFROM=Kg UMTO=Gr
                                 ART=1 DIV=1 UMFROM=Gr UMTO=Kg
                                 ART=1 DIV=1 UMFROM=Hg UMTO=Kg
                                 ART=1 DIV=1 UMFROM=Gr UMTO=Hg

     The procedure is called from T06X_PRODUCTS , but can be run by itself
     It use recoursive procedure T062_UPD_UMCONV_RIC to step into all nodes of the unis measure graph.

     Input parameters :     PI_PROGR_H - unique sm1 job number ( T800SYSTEMACTIVITYLOG )
                            PI_PROGR_D - unique sm1 job detail number ( T800SYSTEMACTIVITYLOG )
                            PI_CODART  - (not mandatory) -- if null it creates the graph for every articles
                            PI_CODDIV  - (not mandatory) -- if null it creates the graph for every division

     Author : Mariangela Bandiera - Elisa Rizzi
     Creation Date : 2009
     ----
     Updates : 17/09/2012 Mariangela Bandiera, updated to be standard
               27/12/2012 Mariangela Bandiera, Added input CODART and CODDIV


    ============================================================================ */
   PROCEDURE P_T062_UPD_UMCONV(PI_PROGR_H         IN NUMBER,
                               PI_PROGR_D         IN NUMBER,
                               PI_CODART          IN VARCHAR2 DEFAULT NULL,
                               PI_CODDIV          IN VARCHAR2 DEFAULT NULL) IS

    --- ------------------------
    --- Cursor on all records
    --- ------------------------
    CURSOR CL_T062UMCONV IS
    SELECT CODART,
           CODDIV,
           UMFROM,
           UMTO,
           VALCONVFACT,
           VALCONVFACTREV

    FROM  T062UMCONV
    WHERE CODART = NVL(PI_CODART, CODART)
     AND  CODDIV = NVL(PI_CODDIV, CODDIV);

    -- -------------------------------------------------------
    -- cursor that extracts all linked records to be inserted
    -- -------------------------------------------------------
    CURSOR CL_T062UMCONV_LINK(CI_CODART VARCHAR2, CI_CODDIV VARCHAR2, CI_UMFROM VARCHAR2, CI_UMTO VARCHAR2, CI_VALCONVFACT FLOAT, CI_VALCONVFACTREV FLOAT) IS
      -- All linked records included the original one
      SELECT CODART,
             CODDIV,
             UMFROM,
             UMTO,
             CASE WHEN NVL(VALCONVFACT, 1) = 0   THEN 1 ELSE NVL(VALCONVFACT,1) END AS VALCONVFACT,
             CASE WHEN NVL(VALCONVFACTREV,1) = 0 THEN 1 ELSE NVL(VALCONVFACTREV,1) END AS VALCONVFACTREV
        FROM T062UMCONV
       WHERE CODART = CI_CODART
         AND CODDIV = CI_CODDIV
         -- Unit conversion linked to the original one by UMFROM or UMTO unit measure
         AND ( UMFROM IN ( CI_UMFROM, CI_UMTO ) OR
               UMTO   IN ( CI_UMFROM, CI_UMTO) )

       ORDER BY CODART, CODDIV;

    VL_PROGR_D   NUMBER := 0;
    VL_INS       NUMBER := 0;
    VL_INS_ART   NUMBER := 0;
    VL_MESSAGE_H   VARCHAR2(300) := NULL;
    VL_MESSAGE_D   VARCHAR2(300) := NULL;
    VL_VALCONVFACT    T062UMCONV.VALCONVFACT%TYPE;
    VL_VALCONVFACTREV T062UMCONV.VALCONVFACTREV%TYPE;
    VL_UMFROM    T062UMCONV.UMFROM%TYPE;
    VL_UMTO    T062UMCONV.UMTO%TYPE;
  BEGIN

  IF PI_PROGR_D IS NULL THEN
    VL_PROGR_D := PKG_UTILS.LOG_NEW_DETAIL(PI_PROGR_H,
                                          'COMPLETE T062 GRAPH',
                                          'T062UMCONV',
                                           0,
                                           NULL);
  ELSE
     VL_PROGR_D := PI_PROGR_D;
  END IF;


  FOR RL_T062 IN CL_T062UMCONV LOOP
      VL_MESSAGE_H := 'CODART: '||RL_T062.CODART||' '||
                      'CODDIV: '||RL_T062.CODDIV||' '||
                      'UMFROM: '||RL_T062.UMFROM||' '||
                      'UMTO  : '||RL_T062.UMTO;

      VL_INS_ART:= 0;
      FOR RL_T062_LINK IN CL_T062UMCONV_LINK(RL_T062.CODART, RL_T062.CODDIV, RL_T062.UMFROM, RL_T062.UMTO, RL_T062.VALCONVFACT, RL_T062.VALCONVFACTREV) LOOP
          BEGIN

          -- inserts records
          VL_MESSAGE_D := VL_MESSAGE_H ||' '||
                          'UMFROM_L: '||RL_T062_LINK.UMFROM||' '||
                          'UMTO_L  : '||RL_T062_LINK.UMTO;

          CASE WHEN RL_T062.UMFROM = RL_T062_LINK.UMFROM AND RL_T062.UMTO = RL_T062_LINK.UMTO THEN
               -- Original Record, it inserts the Reverse one
                 VL_UMFROM         := RL_T062_LINK.UMTO;
                 VL_UMTO           := RL_T062_LINK.UMFROM;
                 VL_VALCONVFACT    := RL_T062_LINK.VALCONVFACTREV;

               WHEN RL_T062.UMFROM = RL_T062_LINK.UMFROM THEN
                 -- e.g. T062 PZ-->KG = 2 and T062_LINK PZ-->GR = 2000 generates  KG-->GR = 1000
                 VL_UMFROM  := CASE WHEN RL_T062.VALCONVFACT <= RL_T062_LINK.VALCONVFACT THEN RL_T062.UMTO ELSE RL_T062_LINK.UMTO END;
                 VL_UMTO    := CASE WHEN RL_T062.VALCONVFACT <= RL_T062_LINK.VALCONVFACT THEN RL_T062_LINK.UMTO ELSE RL_T062.UMTO END;
                 VL_VALCONVFACT := CASE WHEN RL_T062.VALCONVFACT <= RL_T062_LINK.VALCONVFACT THEN RL_T062_LINK.VALCONVFACT/RL_T062.VALCONVFACT
                                                                                             ELSE 1/(RL_T062_LINK.VALCONVFACT/RL_T062.VALCONVFACT) END;

               WHEN RL_T062.UMTO   = RL_T062_LINK.UMTO   THEN
                 -- e.g. T062 PZ-->KG = 2 and T062_LINK PL-->KG = 10 generates  PL-->PZ = 5
                 VL_UMFROM  := CASE WHEN RL_T062.VALCONVFACT <= RL_T062_LINK.VALCONVFACT THEN RL_T062_LINK.UMFROM ELSE RL_T062.UMFROM END;
                 VL_UMTO    := CASE WHEN RL_T062.VALCONVFACT <= RL_T062_LINK.VALCONVFACT THEN RL_T062.UMFROM ELSE RL_T062_LINK.UMFROM END;

                 VL_VALCONVFACT := CASE WHEN RL_T062.VALCONVFACT <= RL_T062_LINK.VALCONVFACT THEN RL_T062_LINK.VALCONVFACT/RL_T062.VALCONVFACT
                                                                                             ELSE 1/(RL_T062_LINK.VALCONVFACT/RL_T062.VALCONVFACT) END;


               WHEN RL_T062.UMFROM = RL_T062_LINK.UMTO   THEN
                 -- e.g. T062 PZ-->KG = 2 and T062_LINK QN-->PZ = 50   generates  QN-->KG = 100
                 VL_UMFROM  := CASE WHEN RL_T062.VALCONVFACT <= RL_T062_LINK.VALCONVFACT THEN RL_T062_LINK.UMFROM ELSE RL_T062.UMTO END;
                 VL_UMTO    := CASE WHEN RL_T062.VALCONVFACT <= RL_T062_LINK.VALCONVFACT THEN RL_T062.UMTO ELSE RL_T062_LINK.UMFROM END;

                 VL_VALCONVFACT := CASE WHEN RL_T062.VALCONVFACT <= RL_T062_LINK.VALCONVFACT THEN RL_T062_LINK.VALCONVFACT*RL_T062.VALCONVFACT
                                                                                             ELSE 1/(RL_T062_LINK.VALCONVFACT*RL_T062.VALCONVFACT) END;


               WHEN RL_T062.UMTO   = RL_T062_LINK.UMFROM THEN
                 -- e.g. T062 PZ-->KG = 2 and T062_LINK KG-->GR = 1000   generates  PZ-->GR = 2000
                 VL_UMFROM  := CASE WHEN RL_T062.VALCONVFACT <= RL_T062_LINK.VALCONVFACT THEN RL_T062.UMFROM ELSE RL_T062_LINK.UMTO END;
                 VL_UMTO    := CASE WHEN RL_T062.VALCONVFACT <= RL_T062_LINK.VALCONVFACT THEN RL_T062_LINK.UMTO ELSE RL_T062.UMFROM END;
                 VL_VALCONVFACT := CASE WHEN RL_T062.VALCONVFACT <= RL_T062_LINK.VALCONVFACT THEN RL_T062_LINK.VALCONVFACT*RL_T062.VALCONVFACT
                                                                                             ELSE 1/(RL_T062_LINK.VALCONVFACT*RL_T062.VALCONVFACT) END;

          END CASE;

          VL_VALCONVFACTREV := ROUND(1/VL_VALCONVFACT, 4);
          VL_VALCONVFACT    := ROUND(VL_VALCONVFACT  , 4);

          IF ( VL_UMFROM <> VL_UMTO ) THEN

              INSERT INTO T062UMCONV
                (CODART, CODDIV, UMFROM, UMTO, VALCONVFACT, VALCONVFACTREV)
              (SELECT
                RL_T062.CODART,
                RL_T062.CODDIV,
                VL_UMFROM,
                VL_UMTO,
                VL_VALCONVFACT,
                VL_VALCONVFACTREV FROM DUAL WHERE NOT EXISTS (SELECT NULL FROM T062UMCONV B
                                                                WHERE B.CODART =  RL_T062.CODART AND
                                                                      B.CODDIV =  RL_T062.CODDIV AND
                                                                      B.UMFROM= VL_UMFROM));


              VL_INS_ART := VL_INS_ART + SQL%ROWCOUNT;
              COMMIT;

          END IF;

         EXCEPTION WHEN DUP_VAL_ON_INDEX THEN
            -- Already exists
            NULL;

         WHEN OTHERS THEN
            ROLLBACK;

            VL_MESSAGE_D := SUBSTR(VL_MESSAGE_D||' '||dbms_utility.format_error_backtrace() || ' ' || SQLERRM, 1, 255);
            PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                           VL_PROGR_D,
                                           SQLCODE,
                                           VL_MESSAGE_D);


         END;
    END LOOP;
    VL_INS := VL_INS + VL_INS_ART;

         IF VL_INS_ART > 0 THEN
             --- When new records have been inserted it does a recoursive call to complete the unit measure graph
             P_T062_UPD_UMCONV(PI_PROGR_H ,
                               VL_PROGR_D ,
                               RL_T062.CODART ,
                               RL_T062.CODDIV);

        END IF;



    END LOOP;

    IF PI_PROGR_D IS NULL THEN
    PKG_UTILS.LOG_END_DETAIL(PI_PROGR_H,
                                   VL_PROGR_D,
                                   0,
                                   VL_INS,
                                   VL_INS,
                                   0);
    END IF;


  END P_T062_UPD_UMCONV;

  /*============================================================================

    Name: P_GET_WF_INIT_STATUS
     gets WorkFlow state id informations.
     1. Soft state initial status in the Integration configuration T906TABROWSX_INT[WF_STATUS]
     2. Hard state linked to soft state in ta2302workflowstates configuration

  ============================================================================*/

  PROCEDURE P_GET_WF_INIT_STATUS(PI_WORKFLOWID IN NUMBER, PI_TABLENAME IN VARCHAR2, PO_stateid OUT NUMBER,PO_codstatehard OUT VARCHAR2, PO_STATUS IN OUT NUMBER)
  IS
    BEGIN

    PO_stateid := PKG_UTILS.get_optinfo_ext_as_number('ALL','WF_STATUS',PI_TABLENAME,'IDWFSTATE');
    select t.codstatehard
    into PO_codstatehard
    from ta2302workflowstates t
    where t.workflowid = PI_WORKFLOWID
     and  t.stateid    = PO_stateid;

     PO_STATUS := 0;
  EXCEPTION WHEN OTHERS THEN
    PO_STATUS := -1;
  END P_GET_WF_INIT_STATUS;
 /*============================================================================

    Name: P_INS_WF_FIRST_STEP
      -- insert first step on workflow
      -- COMMIT MADE BY CALLER
  ============================================================================*/


   PROCEDURE P_INS_WF_FIRST_STEP(PI_PROGR_H IN NUMBER, PI_PROGR_D IN NUMBER, PI_WORKFLOWID IN NUMBER ,
               PI_DOCUMENTKEY IN VARCHAR2, PI_stateid IN NUMBER, PO_status IN OUT NUMBER ) IS
   vl_msg varchar2(4000);
   BEGIN

      Insert into ta2358wfsteps
              (parentkey,
              stepid,
              workflowid,
              transitionid,
              resultstateid,
              stepdate,
              completiondate,
              codusr,
              stepcomment)
              values ( PI_DOCUMENTKEY,
                     1,  -- setpid w
                     PI_WORKFLOWID, --workflowid
                     0 , --transitionid
                     PI_stateid, --resultstateid -- valid
                     xsysdate, --stepdate
                     xsysdate, --completiondate c
                     'SYSH', -- Codusr
                     'AUTO' ); -- stepcomment


        EXCEPTION WHEN OTHERS THEN
           po_status := -1;
           vl_msg := SUBSTR(dbms_utility.format_error_backtrace() || ' ' || SQLERRM,1,4000);

          PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                   pi_PROGR_D,
                                   SQLCODE,
                                   vl_msg);

        END;


  /*============================================================================*\
  /* Name: LOAD_T90X_DECODES
     Loads SM1 tables:
        • T900TABHEAD- Decode Table Head. It contains both HOST and SM1 decodes. When in SM1 column comments you find something like[CONF:QTABS=CUR.COD] it means that the column could be a Combo in SM1 and the Decode Table is in T900TABHEAD with CODTAB = 'CUR'
        • T902TABROWS- Decode Table Rows. It contains all values and descriptions for Decode Table Heads in T900TABHEAD
        Staging Area (SSA) tables, Chronological Order expected in SSA (for each decode set):
        1.  XIN_T902TABROWS
        2.  XIN_T900TABHEAD

        Loading logic: all decode tables grouped by CODTAB, CODSYS are loaded with An UPDATE+INSERT logic. Detail records no more loaded from ERP will be set to “no more valid status” (T902TABROWS.FLGANN=-1).

        T900.CODCONFIG is a field managed in SM1 and it is set by default to  “ERP” on first loading then it will be configured directly in SM1, you have not to send this information in the XIN table. It is used by SM1 to lead some loading logics.
        Possible values:
        • ERP all detail fields in T902 are Entirely Managed by ERP
        • SM1 all details fields in T902 are Entirely Managed by SM1 – do not load from ERP
        • SM1BOTH Fields T902.NumOptional e T902.OptInfo are managed by SM1, codes and descriptions are loaded by ERP
        • SM1OPTINFO  Field T902.OptInfo is managed by SM1, codes, descriptions and numoptional are loaded by ERP

        T900.CODFUNCTION is a field managed in SM1, you have not to send this information in the XIN table.

        You cannot send to SSA a decode table named “CDIV” (T900.CODTAB=”CDIV” ) as it is a internal SM1 code.

        Validity Checks:
        • Decodes found on staging area are loaded to SM1 main tables only if they are not already opened for update by a SM1 user. In that case records remain in staging area ready to be loaded on next import run.
        • New Head T900 should have a CODTAB code not already existing on QTABS view. In that case head+details will be discarded and the error will be logged on T852/T854
        • Detail Records found on  XIN_T902TABROWS are loaded only if there is the head record in XIN_T900TABHEAD.

        Error handling:
        • All Errors will be logged in T852/T854 SM1 log tables and all staging area records will be stored into staging area log with sm1_status = 9.
        • Error on head record,  it is discarded with all its details.
        • Error on detail record, it is discarded and import procedure skips to next detail.

        How to delete
        • a Decode Head : you cannot delete logically or physically a decode head, you can logically delete all the details belonging to it.
        • a Decode Row: records are logically deleted by flagging XIN_T902TABROWS.FLGANN=-1 or simply not writing it in the staging area on the next import run.

     Input parameters :     PI_PROGR_H - unique sm1 job number ( T800SYSTEMACTIVITYLOG )
                            PI_SESSION_ID    - unique login session (T035LOGGEDUSERS)
                            PI_MODE          - 'HEAD+DET'         it reads XIN_T900 and XIN_T902
                                             - != 'HEAD+DET'      it reads only XIN_T902
                        parameter PI_MODE is linked to MAINLOAD parameter  PI_CODE_CHAR_A.
     Outputparameters :     PO_MSG           - message of error if procedure exit with error
                            PO_STATUS        - 0 OK; -1 Error
     Author : Mariangela Bandiera
     Creation Date : 23 August 2012
     ----
     Updates :
     2014 07 14; 019: Mbandiera; WI 32070;  bugfix T902 , if T900.CODCONFIG is set to 'SM1' then it has to skip T902 loading

     12/03/2013; MB; Added check on existence T900.CODTAB on QTABS view before inserting it new
     13/05/2013; MB; Added "only Detail t902" management

    ============================================================================ */

   PROCEDURE LOAD_T90X_DECODES(PI_PROGR_H       IN NUMBER,
                               PI_SESSION_ID    IN NUMBER,
                               PI_MODE          IN  VARCHAR2,
                               PO_MSG           OUT NOCOPY VARCHAR2,
                               PO_STATUS        OUT NOCOPY NUMBER ) IS

    -- -----------------------------------------
    -- Cursor on Decode Head
    -- -----------------------------------------
    CURSOR CL_XIN_T900 IS
    SELECT CODSYS, CODTAB, DESTAB, CODMODULE, CODCONFIG, CODFUNCTION, SM1_DTECRE FROM
     ( SELECT
          CODSYS,
          CODTAB,
          DESTAB,

          CODMODULE,
          CODCONFIG,
          CODFUNCTION,

          SM1_DTECRE
        FROM  XIN_T900TABHEAD XIN
        WHERE SM1_CODPROCESS = PI_PROGR_H
         AND  NVL(PI_MODE, '@') = 'HEAD+DET'
      )
      UNION
      (
      SELECT
          CODSYS,
          CODTAB,
          DESTAB,

          CODMODULE,
          CODCONFIG,
          CODFUNCTION,

          C_SM1_TO_DATE AS SM1_DTECRE
        FROM  T900TABHEAD T900
        WHERE ( T900.CODSYS , T900.CODTAB ) IN
        ( SELECT DISTINCT T902.CODSYS, T902.CODTAB FROM XIN_T902TABROWS T902
        WHERE  T902.CODTAB = T900.CODTAB
        AND    T902.CODSYS = T900.CODSYS
        AND   T902.SM1_CODPROCESS = PI_PROGR_H
        AND   T902.SM1_STATUS = C_XINSTATUS_OK )

        AND T900.CODCONFIG NOT IN ( 'SM1', 'SYS')
        AND NVL(PI_MODE, '@') != 'HEAD+DET'
      )

       ORDER BY CODTAB, CODSYS,SM1_DTECRE;


    -- -----------------------------------------
    -- Cursor on Users Division Info T902USERDIV
    -- -----------------------------------------
    CURSOR CL_XIN_T902(CI_CODTAB VARCHAR2, CI_CODSYS VARCHAR2, CI_SM1_DTECRE DATE) IS
      SELECT
       *

        FROM  XIN_T902TABROWS
        WHERE CODTAB = CI_CODTAB
        AND   CODSYS = CI_CODSYS
        AND   SM1_CODPROCESS = PI_PROGR_H
        AND   SM1_DTECRE <= CI_SM1_DTECRE
        AND SM1_STATUS = C_XINSTATUS_OK -- Only those that have not processed yet (in case of double record in xin)
        ORDER BY CODSYS, CODTAB, SM1_DTECRE;
    --
    VL_MESSAGE_H   VARCHAR2(4000) := 'Error while loading Decode Tables T900';
    VL_MESSAGE_D   VARCHAR2(4000) := NULL;
    --
    VL_PROGR_D_T900    NUMBER := 0;
    VL_COUNT_XIN_T900  NUMBER := 0;
    VL_INS_T900        NUMBER := 0;
    --
    VL_PROGR_D_T902    NUMBER := 0;
    VL_COUNT_XIN_T902  NUMBER := 0;
    VL_INS_T902        NUMBER := 0;
    VL_INS             NUMBER := 0;
    --
    REC_T900      T900TABHEAD%ROWTYPE := NULL;
    REC_T900_INIT T900TABHEAD%ROWTYPE := NULL;
    REC_T902      T902TABROWS%ROWTYPE := NULL;
    REC_T902_INIT T902TABROWS%ROWTYPE := NULL;
    --
    VL_DES_T900     X_FIELD_INFO_ARRAY;-- Array with fields db info
    --
    VL_DES_T902     X_FIELD_INFO_ARRAY;-- Array with fields db info
    --
    VL_RECORD_LOCKED NUMBER := 0;
    VL_COUNT        NUMBER:= 0;
    VL_STATUS       NUMBER:= 0;
    VL_STEP   NUMBER:= 0; -- Used to ping t035
    --
    EX_EXIT  EXCEPTION;
    --
    VL_CODDIV VARCHAR2(30) := NULL;

  BEGIN

    -- init indexes and rebuild statistics
    P_XIN_INIT_INDEXES (PI_PROGR_H, 'T900TABHEAD');
    P_XIN_INIT_INDEXES (PI_PROGR_H, 'T902TABROWS');
    -- clean log
    P_XIN_CLEANUP_LOG (PI_PROGR_H, 'T900TABHEAD');
    P_XIN_CLEANUP_LOG (PI_PROGR_H, 'T902TABROWS');

    VL_PROGR_D_T900 := PKG_UTILS.LOG_NEW_DETAIL(PI_PROGR_H,
                                       'DECODE HEAD',
                                       'IMPORT --> T900TABHEAD',
                                        0,
                                        NULL);
    VL_PROGR_D_T902 := PKG_UTILS.LOG_NEW_DETAIL(PI_PROGR_H,
                                       'DECODE ROW',
                                       'IMPORT --> T902TABROWS',
                                        0,
                                        NULL);

    BEGIN
        --
        -- ----------------------------------------------------------
        -- Init arrays with FIELD_NAME=LENGTH and FIELDNAME=SM1_DEFAULT for all fields of table
        -- ----------------------------------------------------------
        VL_DES_T900.DELETE;
        P_INIT_SM1_FIELD_ARRAY ('T900TABHEAD',VL_DES_T900, VL_STATUS, VL_MESSAGE_H);
        execute immediate ( GL_INIT_REC) INTO REC_T900_INIT;

        --
        VL_DES_T902.DELETE;
        P_INIT_SM1_FIELD_ARRAY ('T902TABROWS',VL_DES_T902, VL_STATUS, VL_MESSAGE_H);
        execute immediate ( GL_INIT_REC) INTO REC_T902_INIT;

        IF (VL_STATUS <> 0 ) THEN
            VL_MESSAGE_D := GL_INIT_REC;
            RAISE EX_EXIT;
        END IF;
    EXCEPTION WHEN OTHERS THEN
        VL_MESSAGE_D := GL_INIT_REC;
        RAISE EX_EXIT;
    END;
    -- --------------------------------------------------------------
    -- Identifies Xin records to be loaded
    -- --------------------------------------------------------------
    BEGIN

    IF ( PI_MODE = 'HEAD+DET' ) then

        VL_MESSAGE_D := 'XIN_T900TABHEAD';
        UPDATE XIN_T900TABHEAD
        SET SM1_CODPROCESS = PI_PROGR_H,
            SM1_STATUS = 0,
            SM1_DTEPROCESS = XSYSDATE
            WHERE SM1_CODPROCESS = C_SM1_NULL_CODPROCESS
            AND  CODTAB <> 'CDIV';

        VL_COUNT_XIN_T900 := SQL%ROWCOUNT;

        VL_MESSAGE_D := 'XIN_T902TABROWS';
        UPDATE XIN_T902TABROWS D
        SET D.SM1_CODPROCESS = PI_PROGR_H,
            D.SM1_STATUS = 0,
            D.SM1_DTEPROCESS = XSYSDATE
            WHERE D.SM1_CODPROCESS = C_SM1_NULL_CODPROCESS
            AND (D.CODTAB, D.CODSYS) IN ( SELECT H.CODTAB, H.CODSYS FROM XIN_T900TABHEAD H WHERE H.SM1_CODPROCESS = PI_PROGR_H AND H.SM1_DTECRE >= D.SM1_DTECRE );

        VL_COUNT_XIN_T902 := SQL%ROWCOUNT;

    ELSE

        VL_MESSAGE_D := 'XIN_T902TABROWS';
        UPDATE XIN_T902TABROWS D
        SET D.SM1_CODPROCESS = PI_PROGR_H,
            D.SM1_STATUS = 0,
            D.SM1_DTEPROCESS = XSYSDATE
            WHERE D.SM1_CODPROCESS = C_SM1_NULL_CODPROCESS;

        VL_COUNT_XIN_T902 := SQL%ROWCOUNT;
    END IF;

    COMMIT;
    EXCEPTION WHEN OTHERS THEN
      ROLLBACK;
      VL_MESSAGE_H := 'Error while Reading Staging area: '||VL_MESSAGE_D;
      RAISE EX_EXIT;

    END;

    -- --------------------------------------------------------------
    -- loop in main table T900TABHEAD
    -- --------------------------------------------------------------

    FOR RL_XIN_T900 IN CL_XIN_T900 LOOP


      VL_MESSAGE_H :=   'Decode Code: '||RL_XIN_T900.CODTAB||' '||
                        'Division: '   ||RL_XIN_T900.CODSYS;
      --
      VL_CODDIV := RL_XIN_T900.CODSYS;
      BEGIN --- HEAD T900

        -- Data Format Check
        VL_MESSAGE_D := 'Format Conversion ';

        REC_T900.CODSYS      := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T900.CODSYS,'CODSYS', VL_DES_T900,VL_STATUS, VL_MESSAGE_D);
        REC_T900.CODTAB      := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T900.CODTAB,'CODTAB', VL_DES_T900,VL_STATUS, VL_MESSAGE_D);
        REC_T900.DESTAB      := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T900.DESTAB,'DESTAB', VL_DES_T900,VL_STATUS, VL_MESSAGE_D);
        REC_T900.CODMODULE   := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T900.CODMODULE,'CODMODULE', VL_DES_T900,VL_STATUS, VL_MESSAGE_D);
        REC_T900.CODCONFIG   := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T900.CODCONFIG, 'CODCONFIG', VL_DES_T900,VL_STATUS, VL_MESSAGE_D);
        REC_T900.CODFUNCTION :=  F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T900.CODFUNCTION, 'CODFUNCTION', VL_DES_T900,VL_STATUS, VL_MESSAGE_D);
        --- Technical fields
        REC_T900.DTECRE     := XSYSDATE;
        REC_T900.CODUSRCRE  := C_SYSUSR;
        REC_T900.CODUSRMOD  := C_SYSUSR;
        REC_T900.DTEMOD     := XSYSDATE;
        REC_T900.CODUSRCREREAL  := C_SYSUSR;
        REC_T900.CODUSRMODREAL  := C_SYSUSR;

        -- lock fields
        REC_T900.CODUSRLCK     := C_SYSUSR;
        REC_T900.IDSESSIONLCK  := PI_SESSION_ID;
        REC_T900.DTELCK        := XSYSDATE;

        IF (VL_STATUS <> 0 ) THEN

             VL_MESSAGE_H := SUBSTR(VL_MESSAGE_H||' '||VL_MESSAGE_D||' '||dbms_utility.format_error_backtrace() || ' ' || SQLERRM,1,4000);

             PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                           VL_PROGR_D_T900,
                                           SQLCODE,
                                           VL_MESSAGE_H);
        ELSE


          IF (VL_STATUS = 0 AND  REC_T900.CODCONFIG not in ('SM1','SYS') ) THEN
             VL_MESSAGE_D := 'Update T900TABHEAD ';


             UPDATE T900TABHEAD
             SET
              -- it modifies the descrption only if the mode is HEAD+DET and if it is not configured in T906 to preserve the value in destab
              DESTAB = CASE WHEN
                       PI_MODE = 'HEAD+DET' AND
                       VL_DES_T900('DESTAB.ALL').FLG_SM1 = C_UPDATED_BY_HOST THEN REC_T900.DESTAB ELSE DESTAB END,


              --- Technical fields
              CODUSRMOD = REC_T900.CODUSRMOD,
              DTEMOD    = REC_T900.DTEMOD,
              -- lock fields
              CODUSRLCK    = REC_T900.CODUSRLCK,
              IDSESSIONLCK = REC_T900.IDSESSIONLCK,
              DTELCK       = REC_T900.DTELCK

           WHERE CODTAB = REC_T900.CODTAB
            AND  CODSYS = REC_T900.CODSYS
           and not exists ( select null from T035LOGGEDUSERS T035 where T035.IDSESSION = NVL(IDSESSIONLCK, '@') AND T035.LASTCHECK > TRUNC(XSYSDATE)-1 );


          -- no data found, it could be
          --   a. record does not exists
          --   b. record is locked by another sm1 user

          IF SQL%ROWCOUNT = 0 THEN


            VL_COUNT := 0;
            SELECT COUNT(*) INTO VL_COUNT FROM T900TABHEAD
             WHERE CODTAB = REC_T900.CODTAB
               AND CODSYS = REC_T900.CODSYS;


            IF ( VL_COUNT = 0 AND PI_MODE = 'HEAD+DET'  ) THEN
                -- Before inserting this brand new head, it checks if it is already present on QTABS view.
                -- in that case we cannot accept it to avoid duplicate values on QTABS view

                VL_COUNT := 0;
                SELECT COUNT(*) INTO VL_COUNT FROM QTABS
                WHERE CODTAB = REC_T900.CODTAB;

                IF VL_COUNT = 0 THEN
                  VL_MESSAGE_D := 'Insert T900TABHEAD ';
                   REC_T900.CODCONFIG := 'ERP'; -- By default Decode is full maintained by ERP
                   -- Record does not exists, we insert it
                  INSERT INTO T900TABHEAD VALUES REC_T900;
                ELSE
                 VL_STATUS := -1;
                 PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                             VL_PROGR_D_T900,
                                             SQLCODE,
                                             'SubTable '||VL_MESSAGE_H||' not accepted because already present on QTABS');

                END IF;

             ELSIF( VL_COUNT=0) THEN
              VL_STATUS := -1;
              VL_RECORD_LOCKED := -1;
              PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                             VL_PROGR_D_T900,
                                             SQLCODE,
                                             'Record is locked; import has failed :'||VL_MESSAGE_H);

            END IF; -- Record has been inserted
          END IF; -- Record has been updated
          END IF; -- VL_STATUS = 0

          END IF;


        EXCEPTION WHEN OTHERS THEN
             VL_STATUS := -1;
             VL_MESSAGE_H := SUBSTR(VL_MESSAGE_H||' '||VL_MESSAGE_D||' '||dbms_utility.format_error_backtrace() || ' ' || SQLERRM,1,4000);

             PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                           VL_PROGR_D_T900,
                                           SQLCODE,
                                           VL_MESSAGE_H);

        END; -- HEAD T900


       -- -----------------------------------
        -- T902TABROWS DIVISION INFO
        -- -----------------------------------

        --
        VL_INS :=0;
        IF ( VL_STATUS = 0  AND REC_T900.CODCONFIG not in ('SM1','SYS') ) THEN
              -- Division info T902TABROWS
              FOR RL_XIN_T902 IN CL_XIN_T902(RL_XIN_T900.CODTAB, RL_XIN_T900.CODSYS, RL_XIN_T900.SM1_DTECRE) LOOP
               -- pings to t035 every 1000 cicles--
                VL_STEP := VL_STEP + 1;
                IF ( MOD(VL_STEP, 1000) = 0 ) THEN
                   PKG_UTILS.user_ping(PI_SESSION_ID);
                END IF;
                ---
               IF ( VL_STATUS = 0 ) THEN
               BEGIN
                VL_MESSAGE_H := 'Decode Rows: '|| RL_XIN_T902.CODTAB || '/' ||
                                                  RL_XIN_T902.CODSYS || '/' ||
                                                  RL_XIN_T902.CODTABROW;

                  -- Format Data Check
                  VL_MESSAGE_D := 'Format Conversion ';
                  REC_T902.CODSYS := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T902.CODSYS,'CODSYS', VL_DES_T902,VL_STATUS, VL_MESSAGE_D);
                  REC_T902.CODTAB := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T902.CODTAB,'CODTAB', VL_DES_T902,VL_STATUS, VL_MESSAGE_D);
                  REC_T902.CODTABROW := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T902.CODTABROW,'CODTABROW', VL_DES_T902,VL_STATUS, VL_MESSAGE_D);
                  REC_T902.DESTABROW := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T902.DESTABROW,'DESTABROW', VL_DES_T902,VL_STATUS, VL_MESSAGE_D);
                  REC_T902.NUMOPTIONAL := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T902.NUMOPTIONAL,'NUMOPTIONAL', VL_DES_T902,VL_STATUS, VL_MESSAGE_D);
                  REC_T902.OPTINFO := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T902.OPTINFO,'OPTINFO', VL_DES_T902,VL_STATUS, VL_MESSAGE_D);
                  REC_T902.FLGANN := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T902.FLGANN,'FLGANN', VL_DES_T902,VL_STATUS, VL_MESSAGE_D);
                 IF (VL_STATUS <> 0 ) THEN
                   VL_MESSAGE_H := SUBSTR(VL_MESSAGE_H||' '||VL_MESSAGE_D||' '||dbms_utility.format_error_backtrace() || ' ' || SQLERRM,1,4000);
                   PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                           VL_PROGR_D_T902,
                                           SQLCODE,
                                           VL_MESSAGE_H);
                 END IF;
                --

                IF ( VL_INS = 0 ) THEN
                  UPDATE T902TABROWS SET FLGANN = -1 WHERE CODTAB =REC_T902.CODTAB AND CODSYS =  REC_T902.CODSYS;
                  VL_INS := 1;
                END IF;

               --   ----------------------------------------------------------------------------------------------------------------
               --   T900.CODCONFIG    is set with these codes
               --              ERP  Entirely Managed by ERP
               --              SM1  Entirely Managed by SM1 – do not load from ERP
               --              SM1BOTH   Fields NumOptional e OptInfo are managed by SM1, codes and descriptions are loaded by ERP
               --              SM1OPTINFO Field  OptInfo is managed by SM1, codes, descriptions and numoptional are loaded by ERP
               --   ----------------------------------------------------------------------------------------------------------------

                VL_MESSAGE_D := 'Update T902 ';
               -- when status <> 0 some fields have incorrect format. Log t800 has been already wrote by F_CHECK function
               -- Update article if already exists

                UPDATE T902TABROWS
                   SET
                      CODTABROW = CASE VL_DES_T902('CODTABROW.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T902.CODTABROW ELSE CODTABROW END,
                      DESTABROW = CASE VL_DES_T902('DESTABROW.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T902.DESTABROW ELSE DESTABROW END,
                      NUMOPTIONAL = CASE REC_T900.CODCONFIG
                                    WHEN 'SM1'     THEN NUMOPTIONAL
                                    WHEN 'SM1BOTH' THEN NUMOPTIONAL
                                    ELSE  CASE VL_DES_T902('NUMOPTIONAL.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T902.NUMOPTIONAL ELSE NUMOPTIONAL END
                                    END,
                      OPTINFO =   CASE REC_T900.CODCONFIG
                                    WHEN 'ERP'  THEN CASE VL_DES_T902('OPTINFO.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T902.OPTINFO ELSE OPTINFO END
                                    ELSE OPTINFO
                                    END,
                      FLGANN = CASE VL_DES_T902('FLGANN.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T902.FLGANN ELSE FLGANN END

                 WHERE CODTAB    = REC_T902.CODTAB
                   AND CODSYS    = REC_T902.CODSYS
                   AND CODTABROW = REC_T902.CODTABROW;
                --
                IF SQL%ROWCOUNT = 0 THEN
                  -- record does not exists , we insert it
                  VL_MESSAGE_D := 'Insert T902 ';
                  INSERT INTO T902TABROWS VALUES REC_T902;

                END IF;
                  VL_INS_T902 := VL_INS_T902 + 1;

           -- catch the exception and skip to next detail
           EXCEPTION WHEN OTHERS THEN
                 VL_STATUS := -1;
                 VL_MESSAGE_H := SUBSTR(VL_MESSAGE_H||' '||VL_MESSAGE_D||' '||dbms_utility.format_error_backtrace() || ' ' || SQLERRM,1,4000);

                 PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                               VL_PROGR_D_T902,
                                               SQLCODE,
                                               VL_MESSAGE_H);

           END;
         -- Set the record on ssa with error and skip to next detail
         END IF; -- VL_STATUS = 0
         IF ( VL_STATUS <> 0 ) THEN
            UPDATE XIN_T902TABROWS
             SET   SM1_STATUS =  C_XINSTATUS_ERR
             WHERE CODTAB = RL_XIN_T902.CODTAB
             AND   CODSYS = RL_XIN_T902.CODSYS
             AND   CODTABROW = RL_XIN_T902.CODTABROW
             AND   SM1_CODPROCESS = PI_PROGR_H
             AND   SM1_DTECRE = RL_XIN_T902.SM1_DTECRE;
         END IF;


         END LOOP;   --T902TABROWS
       END IF;



    --- Commit or Rollback of prev Decode set
    IF ( VL_STATUS = 0  ) THEN
       VL_INS_T900 := VL_INS_T900 + 1;
      COMMIT;
    ELSE
      ROLLBACK;
    END IF;

    IF  (VL_STATUS <> 0 OR VL_RECORD_LOCKED <> 0) THEN
        IF ( PI_MODE = 'HEAD+DET' ) THEN

         UPDATE XIN_T900TABHEAD
              SET  SM1_STATUS =  CASE WHEN VL_STATUS = 0          THEN C_XINSTATUS_OK
                                  WHEN VL_RECORD_LOCKED <> 0  THEN C_XINSTATUS_LOCK
                                  ELSE C_XINSTATUS_ERR END
              WHERE CODTAB = RL_XIN_T900.CODTAB
              AND   CODSYS = RL_XIN_T900.CODSYS
              AND   SM1_CODPROCESS = PI_PROGR_H
              AND   SM1_DTECRE  = RL_XIN_T900.SM1_DTECRE
              AND   SM1_STATUS  = C_XINSTATUS_OK;
        END IF;



        UPDATE XIN_T902TABROWS
              SET SM1_STATUS =   CASE WHEN VL_STATUS = 0          THEN C_XINSTATUS_OK
                                  WHEN VL_RECORD_LOCKED <> 0  THEN C_XINSTATUS_LOCK
                                  ELSE C_XINSTATUS_ERR END
              WHERE CODTAB = RL_XIN_T900.CODTAB
              AND   CODSYS = RL_XIN_T900.CODSYS
              AND   SM1_CODPROCESS = PI_PROGR_H
              AND   SM1_DTECRE     <= RL_XIN_T900.SM1_DTECRE
              AND   SM1_STATUS = C_XINSTATUS_OK;
     END IF;



      COMMIT;
    VL_STATUS := 0;

    -- Release updated records
    UPDATE T900TABHEAD
    SET       DTELCK          = NULL,
              IDSESSIONLCK    = NULL,
              CODUSRLCK       = NULL
    WHERE CODUSRLCK = C_SYSUSR AND IDSESSIONLCK = PI_SESSION_ID;
    COMMIT;
    END LOOP;  -- T900TABHEAD


    -- Moves records from staging area to log staging area
    P_XIN_MOVE_TO_LOG(PI_PROGR_H, VL_PROGR_D_T900,'T902TABROWS');
    IF ( PI_MODE = 'HEAD+DET' ) THEN
      P_XIN_MOVE_TO_LOG(PI_PROGR_H, VL_PROGR_D_T900,'T900TABHEAD');
    END IF;
   -- Close Logs
    PKG_UTILS.LOG_END_DETAIL(PI_PROGR_H,
                             VL_PROGR_D_T902,
                             0,
                             VL_COUNT_XIN_T902,
                             VL_INS_T902,
                             VL_COUNT_XIN_T902 - VL_INS_T902);

    PKG_UTILS.LOG_END_DETAIL(PI_PROGR_H,
                             VL_PROGR_D_T900,
                             0,
                             VL_COUNT_XIN_T900,
                             VL_INS_T900,
                             VL_COUNT_XIN_T900 - VL_INS_T900);


    PO_MSG    := VL_INS_T902||'/'||VL_COUNT_XIN_T902||' Decode Rows loaded';
    PO_STATUS := VL_INS_T902;


    --
  EXCEPTION WHEN EX_EXIT THEN

          ROLLBACK;
          VL_MESSAGE_H       := VL_MESSAGE_H || TRIM(SUBSTR(dbms_utility.format_error_backtrace() || ' ' || SQLERRM, 1, 255));
          PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                         VL_PROGR_D_T900,
                                         SQLCODE,
                                         VL_MESSAGE_H);

          PO_MSG := VL_MESSAGE_H;
          PO_STATUS := -1;

   WHEN OTHERS THEN

          ROLLBACK;
         -- Release updated records
            UPDATE T900TABHEAD
            SET       DTELCK          = NULL,
                      IDSESSIONLCK    = NULL,
                      CODUSRLCK       = NULL
            WHERE CODUSRLCK = C_SYSUSR AND IDSESSIONLCK = PI_SESSION_ID;
            COMMIT;
          -- Moves records from staging area to log staging area
          P_XIN_MOVE_TO_LOG(PI_PROGR_H, VL_PROGR_D_T900,'T902TABROWS');
          IF ( PI_MODE = 'HEAD+DET' ) THEN
            P_XIN_MOVE_TO_LOG(PI_PROGR_H, VL_PROGR_D_T900,'T900TABHEAD');
          END IF;

          VL_MESSAGE_H       := VL_MESSAGE_H || TRIM(SUBSTR(dbms_utility.format_error_backtrace() || ' ' || SQLERRM, 1, 255));

          PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                         VL_PROGR_D_T900,
                                         SQLCODE,
                                         VL_MESSAGE_H);

          PO_MSG    := VL_MESSAGE_H;
          PO_STATUS := VL_STATUS;

  END LOAD_T90X_DECODES;


 /*============================================================================*\
  /* Name: LOAD_T920_EXCHANGERATES  KIT

       Loads SM1 tables

     •  T920EXCHANGERATES - Currency rates

      Staging Area (SSA) tables :
      1. XIN_T920EXCHANGERATES

      Loading logic:
      T920 UPDATE + INSERT. IT updates the record if already exists, it inserts the record if it does not exist

      Error handling:
      • All Errors will be logged in T852/T854 SM1 log tables and all staging area records will be stored into staging area log with sm1_status = 9.
      • Error on one record: record is discarded

      How to delete records on SM1
      • You cannot delete a rate by ERP data integration

      Checks
       --1. before insert new one, we close the active previous one
       --2. codcurfrom and codcurto must belong to T902 ?
       --3. if valconvfactrev is 0 or null we calculate it as 1/valconvfact
       --3. Range time validity dtefrom <= dteto


     Input parameters :     PI_PROGR_H - unique sm1 job number ( T800SYSTEMACTIVITYLOG )
                            PI_SESSION_ID    - unique login session (T035LOGGEDUSERS)
     Outputparameters :     PO_MSG           - message of error if procedure exit with error
                            PO_STATUS        - 0 OK; -1 Error
     Author : Mariangela Bandiera

     Creation Date :  2014 10 23; 023: Mbandiera; WI 33433

    ============================================================================ */

  PROCEDURE LOAD_T920_EXCHANGERATES(PI_PROGR_H       IN NUMBER,
                                    PI_SESSION_ID    IN NUMBER,
                                    PO_MSG           OUT NOCOPY VARCHAR2,
                                    PO_STATUS        OUT NOCOPY NUMBER ) IS
    --
    -- rates
    --

    CURSOR CL_XIN_T920 IS
      SELECT  *
        FROM XIN_T920EXCHANGERATES
       WHERE SM1_CODPROCESS = PI_PROGR_H
         AND SM1_STATUS = C_XINSTATUS_OK -- Only those that have not processed yet (in case of double record in xin)
          ORDER BY CODCURFROM, CODCURTO, SM1_DTECRE;

    --
    VL_MESSAGE_H   VARCHAR2(4000) := 'Error while loading EXCHANGE RATES T920';
    VL_MESSAGE_D   VARCHAR2(4000) := NULL;
    --
    VL_PROGR_D_T920         NUMBER := 0;
    VL_COUNT_XIN_T920       NUMBER := 0;
    VL_INS_T920             NUMBER := 0;
    --

    REC_T920 T920EXCHANGERATES%ROWTYPE         := NULL;
    REC_T920_INIT T920EXCHANGERATES%ROWTYPE    := NULL;

    VL_DES_T920     X_FIELD_INFO_ARRAY;-- Array with fields db info
    --
    VL_STATUS   NUMBER:= 0;
    VL_COUNT    NUMBER:= 0;
    VL_STEP     NUMBER:= 0; -- Used to ping t035
    --
    EX_EXIT  EXCEPTION;
    --
    VL_CODDIV VARCHAR2(30) := NULL;


  BEGIN

    -- Rebuild indexes and compute statistics ( table contains few records, no need for idexing)
 ---   P_XIN_INIT_INDEXES (PI_PROGR_H, 'T920EXCHANGERATES');
    -- Clean up older log
    P_XIN_CLEANUP_LOG (PI_PROGR_H, 'T920EXCHANGERATES');
    --
    VL_PROGR_D_T920 := PKG_UTILS.LOG_NEW_DETAIL(PI_PROGR_H,
                                                     'EXCHANGERATES',
                                                     'IMPORT --> T920EXCHANGERATES',
                                                      0,
                                                      NULL);
     VL_MESSAGE_H := GL_INIT_REC;
     BEGIN
      -- ----------------------------------------------------------
      -- Init arrays with FIELD_NAME=LENGTH and FIELDNAME=SM1_DEFAULT for all fields of table
      -- ----------------------------------------------------------
      VL_DES_T920.DELETE;
      P_INIT_SM1_FIELD_ARRAY ('T920EXCHANGERATES',VL_DES_T920,VL_STATUS, VL_MESSAGE_H);
      execute immediate ( GL_INIT_REC)  INTO REC_T920_INIT;

      IF (VL_STATUS <> 0 ) THEN
          VL_MESSAGE_D := GL_INIT_REC;
          RAISE EX_EXIT;
      END IF;
      EXCEPTION WHEN OTHERS THEN
          VL_MESSAGE_D := GL_INIT_REC;
          RAISE EX_EXIT;
      END;
      -- --------------------------------------------------------------
      -- Identifies Xin records to be loaded
      -- --------------------------------------------------------------
      BEGIN

          VL_MESSAGE_D := 'XIN_T920EXCHANGERATES';
          UPDATE XIN_T920EXCHANGERATES D
          SET D.SM1_CODPROCESS = PI_PROGR_H,
              D.SM1_STATUS = 0,
              D.SM1_DTEPROCESS = XSYSDATE
          WHERE  SM1_CODPROCESS = C_SM1_NULL_CODPROCESS;
          VL_COUNT_XIN_T920 := SQL%ROWCOUNT;

      COMMIT;
      EXCEPTION WHEN OTHERS THEN
        ROLLBACK;
        VL_MESSAGE_H := 'Error while Reading Staging area: '||VL_MESSAGE_D;
        RAISE EX_EXIT;
      END;

    -- --------------------------------------------------------------
    -- loop in XIN_T920
    -- --------------------------------------------------------------
    FOR RL_XIN_T920 IN CL_XIN_T920 LOOP
    BEGIN -- RATES T920



      -- pings to t035 every 1000 cicles--
      VL_STEP := VL_STEP + 1;
      IF ( MOD(VL_STEP, 1000) = 0 ) THEN
         PKG_UTILS.user_ping(PI_SESSION_ID);
      END IF;

      VL_MESSAGE_H :=   'CODCURFROM: ' ||RL_XIN_T920.CODCURFROM || '/' ||
                        ' CODCURTO: '   ||RL_XIN_T920.CODCURTO   || '/' ||
                        ' DTEFROM: '    ||RL_XIN_T920.DTEFROM    || '/' ||
                        ' DTEEND: '     ||RL_XIN_T920.DTEEND ;

      VL_MESSAGE_D := 'field conversion ';
      VL_CODDIV:= 'ALL';
      REC_T920 := REC_T920_INIT;
       REC_T920.CODCURFROM     := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T920.CODCURFROM,'CODCURFROM', VL_DES_T920,VL_STATUS, VL_MESSAGE_D);
       REC_T920.CODCURTO       := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T920.CODCURTO,'CODCURTO', VL_DES_T920,VL_STATUS, VL_MESSAGE_D);
       REC_T920.DTEFROM        := F_CHECK_FORMAT_D( VL_CODDIV, RL_XIN_T920.DTEFROM,'DTEFROM', VL_DES_T920,VL_STATUS, VL_MESSAGE_D);
       REC_T920.DTEEND         := F_CHECK_FORMAT_D( VL_CODDIV, RL_XIN_T920.DTEEND,'DTEEND', VL_DES_T920,VL_STATUS, VL_MESSAGE_D);
       REC_T920.VALCONVFACT    := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T920.VALCONVFACT,'VALCONVFACT', VL_DES_T920,VL_STATUS, VL_MESSAGE_D);
       REC_T920.VALCONVFACTREV := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T920.VALCONVFACTREV,'VALCONVFACTREV', VL_DES_T920,VL_STATUS, VL_MESSAGE_D);

      IF (VL_STATUS <> 0 ) THEN

         VL_MESSAGE_H := SUBSTR(VL_MESSAGE_H||' '||VL_MESSAGE_D||' '||dbms_utility.format_error_backtrace() || ' ' || SQLERRM,1,4000);
         PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                 VL_PROGR_D_T920,
                                 SQLCODE,
                                 VL_MESSAGE_H);


      ELSE -- TRY UPDATE

        --check4 dtefrom <=dteend
         if REC_T920.dtefrom>REC_T920.dteend then
           vl_status := -1;
           vl_message_d := 'Not valid range of time';
         else
             --check1 before insert new one, we close the active previous one
             if xsysdate between rec_t920.dtefrom and rec_t920.dteend then
                update t920exchangerates
                set dteend = rec_t920.dtefrom-1
                where codcurfrom = rec_t920.codcurfrom
                  and codcurto   = rec_t920.codcurto
                  and xsysdate between dtefrom and dteend;
              end if;
             --check2 codcurfrom and codcurto must belong to T902 ?

             --check3 . if valconvfactrev is 0 or null we calculate it as 1/valconvfact
             if nvl(REC_T920.valconvfactrev,0)=0 and nvl(REC_T920.valconvfact,0)<>0 then
                 REC_T920.valconvfactrev := 1/REC_T920.valconvfact;
             end if;

             VL_MESSAGE_D := 'Update T920EXCHANGERATES ';
             UPDATE T920EXCHANGERATES
               SET
                   -- when the field si set to updated by host it means that the value should be read from XIN
                   -- otherwise it means that the field is managed by sm1 and it maintains its original value
                    VALCONVFACT    = CASE VL_DES_T920('VALCONVFACT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T920.VALCONVFACT ELSE VALCONVFACT END,
                    VALCONVFACTREV = CASE VL_DES_T920('VALCONVFACTREV.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T920.VALCONVFACTREV ELSE VALCONVFACTREV END,
                    DTEEND        = CASE VL_DES_T920('DTEEND.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T920.DTEEND ELSE DTEEND END

             WHERE CODCURFROM = REC_T920.CODCURFROM
               and CODCURTO   = REC_T920.CODCURTO
               and DTEFROM    = REC_T920.DTEFROM;


          IF (SQL%ROWCOUNT = 0 ) THEN
             VL_MESSAGE_D := 'Insert T920 ';
             INSERT INTO T920EXCHANGERATES VALUES REC_T920;
          END IF;
           VL_INS_T920 := VL_INS_T920 + 1;
        end if;
    END IF;
      EXCEPTION
          WHEN OTHERS THEN
             VL_STATUS := -1;

             VL_MESSAGE_H := SUBSTR(VL_MESSAGE_H||' '||VL_MESSAGE_D||' '||dbms_utility.format_error_backtrace() || ' ' || SQLERRM,1,2000);

             PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                             VL_PROGR_D_T920,
                                             SQLCODE,
                                             VL_MESSAGE_H);

     END; --- ECHANGE RATES T920

    IF VL_STATUS = 0 THEN
       COMMIT;
    ELSE
       ROLLBACK;

          VL_MESSAGE_H       := VL_MESSAGE_H ||' '||vl_message_d||' '|| TRIM(SUBSTR(dbms_utility.format_error_backtrace() || ' ' || SQLERRM, 1, 255));
          PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                                  VL_PROGR_D_T920,
                                                  SQLCODE,
                                                  VL_MESSAGE_H);

           -- set the status to err to the single record in order to go ahead to another detail
            UPDATE XIN_T920EXCHANGERATES
                       SET SM1_STATUS = C_XINSTATUS_ERR
                       WHERE CODCURFROM = RL_XIN_T920.CODCURFROM
                        AND  CODCURTO = RL_XIN_T920.CODCURTO
                        AND  DTEFROM = RL_XIN_T920.DTEFROM
                        AND  SM1_CODPROCESS = PI_PROGR_H
                        AND  SM1_STATUS  = C_XINSTATUS_OK
                        AND  SM1_CODPROCESS  = PI_PROGR_H;
            COMMIT;

    END IF;

  END LOOP;



    -- Moves records from staging area to log staging area
    P_XIN_MOVE_TO_LOG(PI_PROGR_H,VL_PROGR_D_T920,'T920EXCHANGERATES');
    --
    -- Close Logs
    PKG_UTILS.LOG_END_DETAIL(PI_PROGR_H,
                                      VL_PROGR_D_T920,
                                      0,
                                      VL_COUNT_XIN_T920,
                                      VL_INS_T920,
                                      VL_COUNT_XIN_T920 - VL_INS_T920);


    PO_MSG := VL_INS_T920||' EXCHANGE RATES loaded';
    PO_STATUS :=VL_INS_T920;


  EXCEPTION WHEN EX_EXIT THEN

          ROLLBACK;
          VL_MESSAGE_H       := VL_MESSAGE_H || TRIM(SUBSTR(dbms_utility.format_error_backtrace() || ' ' || SQLERRM, 1, 255));
          PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                                  VL_PROGR_D_T920,
                                                  SQLCODE,
                                                  VL_MESSAGE_H);

          PO_MSG := VL_MESSAGE_H;
          PO_STATUS := -1;

   WHEN OTHERS THEN

          ROLLBACK;

          -- Moves records from staging area to log staging area
          P_XIN_MOVE_TO_LOG(PI_PROGR_H,VL_PROGR_D_T920,'T920EXCHANGERATES');

          VL_MESSAGE_H       := VL_MESSAGE_H || TRIM(SUBSTR(dbms_utility.format_error_backtrace() || ' ' || SQLERRM, 1, 255));
          PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                                  VL_PROGR_D_T920,
                                                  SQLCODE,
                                                  VL_MESSAGE_H);

          PO_MSG := VL_MESSAGE_H;
          PO_STATUS := VL_STATUS;

  END LOAD_T920_EXCHANGERATES;


  --
  /*============================================================================*\
  /* Name: T03X_users
       Loads SM1 tables:
      • T030USERS - Users master data
      • T031USERDIV  - Users info information

      Staging Area (SSA) tables (in Chronological Order expected in SSA for each user):
      1.  XIN_T031USERDIV
      2.  XIN_T030USER

      Loading logic:
      T030/T031 UPDATE + INSERT. Each record is updated if already exists (checking by primary key) and it is not already locked, record is inserted if it does not exist yet.

      Validity Checks:
      • Users found on staging area are loaded to SM1 main tables only if they are not already opened for update by a SM1 user. In that case records remain in staging area ready to be loaded on next import run.
      • Details Records found on  XIN_T031USERDIV are loaded only if there is the head record in XIN_T030USER.

      Error handling:
      • All Errors will be logged in T852/T854 SM1 log tables and all staging area records will be stored into staging area log with sm1_status = 9.
      • Error on head record,  it is discarded with all its details.
      • Error on detail record,  it is discarded with its head and all other head details

      How to delete:
      • A whole User (T030): users can be logically deleted by setting field XIN_T030USER.FLGANN=-1.
      • user detail (T031): details cannot be deleted by integration host.


     Input parameters :     PI_PROGR_H - unique sm1 job number ( T800SYSTEMACTIVITYLOG )
                            PI_SESSION_ID    - unique login session (T035LOGGEDUSERS)
     Outputparameters :     PO_MSG           - message of error if procedure exit with error
                            PO_STATUS        - 0 OK; -1 Error
     Author : Mariangela Bandiera
     Creation Date : 23 August 2012
     ----
     Updates :
       18 September 2013 Maintained new fields in T030
        T030USER.FLG_DSD_PRICINGVARIATION NUMBER(1) default 0 not null;
        T030USER.FLG_DSD_HIDEPRICES       NUMBER(1) default 0 not null;
        T030USER.DSD_PRICEMAXPERC         NUMBER(5,2);
        T030USER.DSD_DISCOUNTMAXPERC      NUMBER(5,2);
        T030USER.DSD_MAXFREEGOOD          NUMBER(12,2);
        T030USER.FLG_DSD_PREORDER         NUMBER(1) default 0 not null;

      31 July 2014 Maintained new fields
        T030.CODAUTHORIZATION VARCHAR2(255) Y   Authorization code
        T031.FLGMANDATORYCHECK  NUMBER(1)   0 When true, every Van Load order has to be checked from Warehouse Manager

    ============================================================================ */

   PROCEDURE LOAD_T03X_USERS(PI_PROGR_H       IN NUMBER,
                         PI_SESSION_ID    IN NUMBER,
                         PO_MSG           OUT NOCOPY VARCHAR2,
                         PO_STATUS        OUT NOCOPY NUMBER ) IS

    -- -----------------------------------------
    -- Cursor on Users table T030USERS
    -- -----------------------------------------
    CURSOR CL_XIN_T030 IS
      SELECT
        *
        FROM  XIN_T030USER
        WHERE SM1_CODPROCESS = PI_PROGR_H
        ORDER BY CODUSR, SM1_DTECRE;

    -- -----------------------------------------
    -- Cursor on Users Division Info T031USERDIV
    -- -----------------------------------------
    CURSOR CL_XIN_T031(CI_CODUSR VARCHAR2, CI_SM1_DTECRE DATE) IS
      SELECT
        *
        FROM  XIN_T031USERDIV
        WHERE CODUSR = CI_CODUSR
        AND   SM1_CODPROCESS = PI_PROGR_H
        AND   SM1_DTECRE <= CI_SM1_DTECRE
        AND SM1_STATUS = C_XINSTATUS_OK -- Only those that have not processed yet (in case of double record in xin)
        ORDER BY SM1_DTECRE;
    --
    VL_MESSAGE_H   VARCHAR2(4000) := 'Error while loading Users T030';
    VL_MESSAGE_D   VARCHAR2(4000) := NULL;
    --
    VL_PROGR_D_T030    NUMBER := 0;
    VL_COUNT_XIN_T030  NUMBER := 0;
    VL_INS_T030        NUMBER := 0;
    --
    VL_PROGR_D_T031    NUMBER := 0;
    VL_COUNT_XIN_T031  NUMBER := 0;
    VL_INS_T031        NUMBER := 0;
    --
    REC_T030      T030USER%ROWTYPE    := NULL;
    REC_T030_INIT T030USER%ROWTYPE    := NULL;
    REC_T031      T031USERDIV%ROWTYPE := NULL;
    REC_T031_INIT T031USERDIV%ROWTYPE := NULL;
    --
    VL_DES_T030     X_FIELD_INFO_ARRAY;-- Array with fields db info
    --
    VL_DES_T031     X_FIELD_INFO_ARRAY;-- Array with fields db info
    --

    VL_RECORD_LOCKED NUMBER := 0;

    VL_STATUS NUMBER:= 0;
    VL_STEP   NUMBER:= 0; -- Used to ping t035
    VL_COUNT  NUMBER:= 0;
    --
    EX_EXIT  EXCEPTION;
    --
    VL_CODDIV VARCHAR2(30) := NULL;

  BEGIN
    -- init indexes and rebuild statistics
    P_XIN_INIT_INDEXES (PI_PROGR_H, 'T030USER');
    P_XIN_INIT_INDEXES (PI_PROGR_H, 'T031USERDIV');
    -- clean log
    P_XIN_CLEANUP_LOG (PI_PROGR_H, 'T030USER');
    P_XIN_CLEANUP_LOG (PI_PROGR_H, 'T031USERDIV');


    VL_PROGR_D_T030 := PKG_UTILS.LOG_NEW_DETAIL(PI_PROGR_H,
                                       'USERS',
                                       'IMPORT --> T030USER',
                                        0,
                                        NULL);
    VL_PROGR_D_T031 := PKG_UTILS.LOG_NEW_DETAIL(PI_PROGR_H,
                                       'USER DIV INFO',
                                       'IMPORT --> T031USERDIV',
                                        0,
                                        NULL);

    BEGIN
        --
        -- ----------------------------------------------------------
        -- Init arrays with FIELD_NAME=LENGTH and FIELDNAME=SM1_DEFAULT for all fields of table
        -- ----------------------------------------------------------
        VL_DES_T030.DELETE;
        P_INIT_SM1_FIELD_ARRAY ('T030USER', VL_DES_T030, VL_STATUS, VL_MESSAGE_H);
        execute immediate ( GL_INIT_REC) INTO REC_T030_INIT;


        VL_DES_T031.DELETE;
        P_INIT_SM1_FIELD_ARRAY ('T031USERDIV', VL_DES_T031, VL_STATUS, VL_MESSAGE_H);
        execute immediate ( GL_INIT_REC) INTO REC_T031_INIT;

        IF (VL_STATUS <> 0 ) THEN
            VL_MESSAGE_D := GL_INIT_REC;
            RAISE EX_EXIT;
        END IF;
    EXCEPTION WHEN OTHERS THEN
        VL_MESSAGE_D := GL_INIT_REC;
        RAISE EX_EXIT;
    END;


    -- --------------------------------------------------------------
    -- Identifies Xin records to be loaded
    -- --------------------------------------------------------------
    BEGIN
        VL_MESSAGE_D := 'XIN_T030USER';
        UPDATE XIN_T030USER
        SET SM1_CODPROCESS = PI_PROGR_H,
            SM1_STATUS = 0,
            SM1_DTEPROCESS = XSYSDATE
            WHERE NVL(SM1_CODPROCESS, 0) = C_SM1_NULL_CODPROCESS;

        VL_COUNT_XIN_T030 := SQL%ROWCOUNT;

        VL_MESSAGE_D := 'XIN_T031USERDIV';
        UPDATE XIN_T031USERDIV D
        SET D.SM1_CODPROCESS = PI_PROGR_H,
            D.SM1_STATUS = 0,
            D.SM1_DTEPROCESS = XSYSDATE
            WHERE D.SM1_CODPROCESS = C_SM1_NULL_CODPROCESS
            AND D.CODUSR IN ( SELECT H.CODUSR FROM XIN_T030USER H WHERE H.SM1_CODPROCESS = PI_PROGR_H AND H.SM1_DTECRE >= D.SM1_DTECRE );

        VL_COUNT_XIN_T031 := SQL%ROWCOUNT;

    COMMIT;
    EXCEPTION WHEN OTHERS THEN
      ROLLBACK;
      VL_MESSAGE_H := 'Error while Reading Staging area: '||VL_MESSAGE_D;
      RAISE EX_EXIT;

    END;

    -- --------------------------------------------------------------
    -- loop in main table T030USER
    -- --------------------------------------------------------------
    FOR RL_XIN_T030 IN CL_XIN_T030 LOOP
     -- pings to t035 every 100 cicles--
      VL_STEP := VL_STEP + 1;

      IF ( MOD(VL_STEP, 100) = 0 ) THEN
         PKG_UTILS.user_ping(PI_SESSION_ID);
      END IF;

      --
      VL_STATUS := 0;
      --
      VL_MESSAGE_H :=   'UserCode : '   ||RL_XIN_T030.CODUSR;
      --
      BEGIN --- HEAD T030

        -- Data Format Check
        VL_MESSAGE_D := 'Format Conversion ';
        VL_CODDIV := 'ALL';
        REC_T030.CODUSR := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T030.CODUSR,'CODUSR', VL_DES_T030,VL_STATUS, VL_MESSAGE_D);
        REC_T030.USRID := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T030.USRID,'USRID', VL_DES_T030,VL_STATUS, VL_MESSAGE_D);
        REC_T030.USRGROUP := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T030.USRGROUP,'USRGROUP', VL_DES_T030,VL_STATUS, VL_MESSAGE_D);
        REC_T030.USRPWD := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T030.USRPWD,'USRPWD', VL_DES_T030,VL_STATUS, VL_MESSAGE_D);
        REC_T030.USRTYPE := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T030.USRTYPE,'USRTYPE', VL_DES_T030,VL_STATUS, VL_MESSAGE_D);
        REC_T030.LINKTYPE := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T030.LINKTYPE,'LINKTYPE', VL_DES_T030,VL_STATUS, VL_MESSAGE_D);
        REC_T030.DTELASTLOGIN := F_CHECK_FORMAT_D( VL_CODDIV,  RL_XIN_T030.DTELASTLOGIN,'DTELASTLOGIN', VL_DES_T030,VL_STATUS, VL_MESSAGE_D);
        REC_T030.CODDEFDIV := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T030.CODDEFDIV,'CODDEFDIV', VL_DES_T030,VL_STATUS, VL_MESSAGE_D);
        REC_T030.CODUSRSUPFIRST := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T030.CODUSRSUPFIRST,'CODUSRSUPFIRST', VL_DES_T030,VL_STATUS, VL_MESSAGE_D);
        REC_T030.DESUSR := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T030.DESUSR,'DESUSR', VL_DES_T030,VL_STATUS, VL_MESSAGE_D);
        REC_T030.DESADDR := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T030.DESADDR,'DESADDR', VL_DES_T030,VL_STATUS, VL_MESSAGE_D);
        REC_T030.CODZIP := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T030.CODZIP,'CODZIP', VL_DES_T030,VL_STATUS, VL_MESSAGE_D);
        REC_T030.CODPRV := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T030.CODPRV,'CODPRV', VL_DES_T030,VL_STATUS, VL_MESSAGE_D);
        REC_T030.DESLOC := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T030.DESLOC,'DESLOC', VL_DES_T030,VL_STATUS, VL_MESSAGE_D);
        REC_T030.CODNATION := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T030.CODNATION,'CODNATION', VL_DES_T030,VL_STATUS, VL_MESSAGE_D);
        REC_T030.NUMPHONE1 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T030.NUMPHONE1,'NUMPHONE1', VL_DES_T030,VL_STATUS, VL_MESSAGE_D);
        REC_T030.NUMPHONE2 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T030.NUMPHONE2,'NUMPHONE2', VL_DES_T030,VL_STATUS, VL_MESSAGE_D);
        REC_T030.NUMFAX := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T030.NUMFAX,'NUMFAX', VL_DES_T030,VL_STATUS, VL_MESSAGE_D);
        REC_T030.DESNOTE1 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T030.DESNOTE1,'DESNOTE1', VL_DES_T030,VL_STATUS, VL_MESSAGE_D);
        REC_T030.EMAIL1 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T030.EMAIL1,'EMAIL1', VL_DES_T030,VL_STATUS, VL_MESSAGE_D);
        REC_T030.EMAIL2 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T030.EMAIL2,'EMAIL2', VL_DES_T030,VL_STATUS, VL_MESSAGE_D);
        REC_T030.DESNOTE2 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T030.DESNOTE2,'DESNOTE2', VL_DES_T030,VL_STATUS, VL_MESSAGE_D);
        REC_T030.CODDISCLISMAX := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T030.CODDISCLISMAX,'CODDISCLISMAX', VL_DES_T030,VL_STATUS, VL_MESSAGE_D);
        REC_T030.CODDISCLISBLK := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T030.CODDISCLISBLK,'CODDISCLISBLK', VL_DES_T030,VL_STATUS, VL_MESSAGE_D);
        REC_T030.ALLOWLOGIN := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T030.ALLOWLOGIN,'ALLOWLOGIN', VL_DES_T030,VL_STATUS, VL_MESSAGE_D);
        REC_T030.FLGANN := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T030.FLGANN,'FLGANN', VL_DES_T030,VL_STATUS, VL_MESSAGE_D);
        REC_T030.CODLNG := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T030.CODLNG,'CODLNG', VL_DES_T030,VL_STATUS, VL_MESSAGE_D);
        REC_T030.CODVAT := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T030.CODVAT,'CODVAT', VL_DES_T030,VL_STATUS, VL_MESSAGE_D);
        REC_T030.CODVATSTAT := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T030.CODVATSTAT,'CODVATSTAT', VL_DES_T030,VL_STATUS, VL_MESSAGE_D);
        REC_T030.NUMMAT := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T030.NUMMAT,'NUMMAT', VL_DES_T030,VL_STATUS, VL_MESSAGE_D);
        REC_T030.CODNATGIU := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T030.CODNATGIU,'CODNATGIU', VL_DES_T030,VL_STATUS, VL_MESSAGE_D);
        REC_T030.CODAREA := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T030.CODAREA,'CODAREA', VL_DES_T030,VL_STATUS, VL_MESSAGE_D);
        REC_T030.CODCHKVAT := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T030.CODCHKVAT,'CODCHKVAT', VL_DES_T030,VL_STATUS, VL_MESSAGE_D);
        REC_T030.CODFIS := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T030.CODFIS,'CODFIS', VL_DES_T030,VL_STATUS, VL_MESSAGE_D);
        REC_T030.NRPATENT := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T030.NRPATENT,'NRPATENT', VL_DES_T030,VL_STATUS, VL_MESSAGE_D);
        REC_T030.DTEENDPATENT := F_CHECK_FORMAT_D( VL_CODDIV,  RL_XIN_T030.DTEENDPATENT,'DTEENDPATENT',VL_DES_T030,VL_STATUS, VL_MESSAGE_D);
        REC_T030.CODAUTHMODE := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T030.CODAUTHMODE,'CODAUTHMODE', VL_DES_T030,VL_STATUS, VL_MESSAGE_D);
        REC_T030.USRGROUPOFFLINE := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T030.USRGROUPOFFLINE,'USRGROUPOFFLINE', VL_DES_T030,VL_STATUS, VL_MESSAGE_D);
        REC_T030.VALLATITUDE := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T030.VALLATITUDE,'VALLATITUDE', VL_DES_T030,VL_STATUS, VL_MESSAGE_D);
        REC_T030.VALLONGITUDE := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T030.VALLONGITUDE,'VALLONGITUDE', VL_DES_T030,VL_STATUS, VL_MESSAGE_D);
        REC_T030.UDLTEMPLATE := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T030.UDLTEMPLATE,'UDLTEMPLATE', VL_DES_T030,VL_STATUS, VL_MESSAGE_D);
        REC_T030.FLGISUDLTEMPLATE := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T030.FLGISUDLTEMPLATE,'FLGISUDLTEMPLATE', VL_DES_T030,VL_STATUS, VL_MESSAGE_D);
        REC_T030.FLGISPDATEMPLATE := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T030.FLGISPDATEMPLATE,'FLGISPDATEMPLATE', VL_DES_T030,VL_STATUS, VL_MESSAGE_D);
        REC_T030.PDATEMPLATE := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T030.PDATEMPLATE,'PDATEMPLATE', VL_DES_T030,VL_STATUS, VL_MESSAGE_D);
        REC_T030.DESMON := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T030.DESMON,'DESMON', VL_DES_T030,VL_STATUS, VL_MESSAGE_D);
        REC_T030.DESTUE := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T030.DESTUE,'DESTUE', VL_DES_T030,VL_STATUS, VL_MESSAGE_D);
        REC_T030.DESWED := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T030.DESWED,'DESWED', VL_DES_T030,VL_STATUS, VL_MESSAGE_D);
        REC_T030.DESTHU := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T030.DESTHU,'DESTHU', VL_DES_T030,VL_STATUS, VL_MESSAGE_D);
        REC_T030.DESFRI := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T030.DESFRI,'DESFRI', VL_DES_T030,VL_STATUS, VL_MESSAGE_D);
        REC_T030.DESSAT := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T030.DESSAT,'DESSAT', VL_DES_T030,VL_STATUS, VL_MESSAGE_D);
        REC_T030.DESSUN := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T030.DESSUN,'DESSUN', VL_DES_T030,VL_STATUS, VL_MESSAGE_D);

        REC_T030.FLG_DSD_PRICINGVARIATION := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T030.FLG_DSD_PRICINGVARIATION,'FLG_DSD_PRICINGVARIATION', VL_DES_T030,VL_STATUS, VL_MESSAGE_D);
        REC_T030.FLG_DSD_HIDEPRICES       := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T030.FLG_DSD_HIDEPRICES,'FLG_DSD_HIDEPRICES', VL_DES_T030,VL_STATUS, VL_MESSAGE_D);
        REC_T030.DSD_PRICEMAXPERC         := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T030.DSD_PRICEMAXPERC,'DSD_PRICEMAXPERC', VL_DES_T030,VL_STATUS, VL_MESSAGE_D);
        REC_T030.DSD_DISCOUNTMAXPERC      := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T030.DSD_DISCOUNTMAXPERC,'DSD_DISCOUNTMAXPERC', VL_DES_T030,VL_STATUS, VL_MESSAGE_D);
        REC_T030.DSD_MAXFREEGOOD          := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T030.DSD_MAXFREEGOOD,'DSD_MAXFREEGOOD', VL_DES_T030,VL_STATUS, VL_MESSAGE_D);
        REC_T030.FLG_DSD_PREORDER         := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T030.FLG_DSD_PREORDER,'FLG_DSD_PREORDER', VL_DES_T030,VL_STATUS, VL_MESSAGE_D);
        REC_T030.CODAUTHORIZATION         := F_CHECK_FORMAT_S( VL_CODDIV,  RL_XIN_T030.CODAUTHORIZATION,'CODAUTHORIZATION', VL_DES_T030,VL_STATUS, VL_MESSAGE_D);


        -- Customised fields for migration (DAL)

         REC_T030.Z_CODDEPT := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T030.Z_CODDEPT,'Z_CODDEPT', VL_DES_T030,VL_STATUS, VL_MESSAGE_D);
         REC_T030.Z_CODSECTION := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T030.Z_CODSECTION,'Z_CODSECTION', VL_DES_T030,VL_STATUS, VL_MESSAGE_D);


          --- Technical fields
        REC_T030.DTECRE     := XSYSDATE;
        REC_T030.CODUSRMOD  := C_SYSUSR;
        REC_T030.DTEMOD     := XSYSDATE;
        REC_T030.CODUSRMODREAL := C_SYSUSR;
        REC_T030.CODUSRCREREAL := C_SYSUSR;
        -- lock fields
        REC_T030.CODUSRLCK     := C_SYSUSR;
        REC_T030.IDSESSIONLCK  := PI_SESSION_ID;
        REC_T030.DTELCK        := XSYSDATE;
       -- Document Key
        REC_T030.DOCUMENTKEY   := PKG_UTILS.documentkey_for_t030(REC_T030.CODUSR);


        IF (VL_STATUS <> 0 ) THEN

             VL_MESSAGE_H := SUBSTR(VL_MESSAGE_H||' '||VL_MESSAGE_D||' '||dbms_utility.format_error_backtrace() || ' ' || SQLERRM,1,4000);

             PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                           VL_PROGR_D_T030,
                                           SQLCODE,
                                           VL_MESSAGE_H);
        END IF;


        IF (VL_STATUS = 0 ) THEN
          -- when status <> 0 some fields have incorrect format. Log t800 has been already wrote by F_CHECK function
          -- Update article if already exists

           VL_MESSAGE_D := 'Update T030USER ';
           UPDATE T030USER
           SET
               -- when the field si set to updated by host it means that the value should be read from XIN
               -- otherwise it means that the field is managed by sm1 and it maintains its original value
              USRID = CASE VL_DES_T030('USRID.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T030.USRID ELSE USRID END,
              USRGROUP = CASE VL_DES_T030('USRGROUP.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T030.USRGROUP ELSE USRGROUP END,
              USRPWD = CASE VL_DES_T030('USRPWD.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T030.USRPWD ELSE USRPWD END,
              USRTYPE = CASE VL_DES_T030('USRTYPE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T030.USRTYPE ELSE USRTYPE END,
              LINKTYPE = CASE VL_DES_T030('LINKTYPE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T030.LINKTYPE ELSE LINKTYPE END,
              DTELASTLOGIN = CASE VL_DES_T030('DTELASTLOGIN.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T030.DTELASTLOGIN ELSE DTELASTLOGIN END,
              CODDEFDIV = CASE VL_DES_T030('CODDEFDIV.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T030.CODDEFDIV ELSE CODDEFDIV END,
              CODUSRSUPFIRST = CASE VL_DES_T030('CODUSRSUPFIRST.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T030.CODUSRSUPFIRST ELSE CODUSRSUPFIRST END,
              DESUSR = CASE VL_DES_T030('DESUSR.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T030.DESUSR ELSE DESUSR END,
              DESADDR = CASE VL_DES_T030('DESADDR.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T030.DESADDR ELSE DESADDR END,
              CODZIP = CASE VL_DES_T030('CODZIP.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T030.CODZIP ELSE CODZIP END,
              CODPRV = CASE VL_DES_T030('CODPRV.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T030.CODPRV ELSE CODPRV END,
              DESLOC = CASE VL_DES_T030('DESLOC.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T030.DESLOC ELSE DESLOC END,
              CODNATION = CASE VL_DES_T030('CODNATION.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T030.CODNATION ELSE CODNATION END,
              NUMPHONE1 = CASE VL_DES_T030('NUMPHONE1.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T030.NUMPHONE1 ELSE NUMPHONE1 END,
              NUMPHONE2 = CASE VL_DES_T030('NUMPHONE2.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T030.NUMPHONE2 ELSE NUMPHONE2 END,
              NUMFAX = CASE VL_DES_T030('NUMFAX.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T030.NUMFAX ELSE NUMFAX END,
              DESNOTE1 = CASE VL_DES_T030('DESNOTE1.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T030.DESNOTE1 ELSE DESNOTE1 END,
              EMAIL1 = CASE VL_DES_T030('EMAIL1.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T030.EMAIL1 ELSE EMAIL1 END,
              EMAIL2 = CASE VL_DES_T030('EMAIL2.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T030.EMAIL2 ELSE EMAIL2 END,
              DESNOTE2 = CASE VL_DES_T030('DESNOTE2.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T030.DESNOTE2 ELSE DESNOTE2 END,
              CODDISCLISMAX = CASE VL_DES_T030('CODDISCLISMAX.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T030.CODDISCLISMAX ELSE CODDISCLISMAX END,
              CODDISCLISBLK = CASE VL_DES_T030('CODDISCLISBLK.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T030.CODDISCLISBLK ELSE CODDISCLISBLK END,
              ALLOWLOGIN = CASE VL_DES_T030('ALLOWLOGIN.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T030.ALLOWLOGIN ELSE ALLOWLOGIN END,
              FLGANN = CASE VL_DES_T030('FLGANN.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T030.FLGANN ELSE FLGANN END,
              CODLNG = CASE VL_DES_T030('CODLNG.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T030.CODLNG ELSE CODLNG END,
              CODVAT = CASE VL_DES_T030('CODVAT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T030.CODVAT ELSE CODVAT END,
              CODVATSTAT = CASE VL_DES_T030('CODVATSTAT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T030.CODVATSTAT ELSE CODVATSTAT END,
              NUMMAT = CASE VL_DES_T030('NUMMAT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T030.NUMMAT ELSE NUMMAT END,
              CODNATGIU = CASE VL_DES_T030('CODNATGIU.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T030.CODNATGIU ELSE CODNATGIU END,
              CODAREA = CASE VL_DES_T030('CODAREA.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T030.CODAREA ELSE CODAREA END,
              CODCHKVAT = CASE VL_DES_T030('CODCHKVAT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T030.CODCHKVAT ELSE CODCHKVAT END,
              CODFIS = CASE VL_DES_T030('CODFIS.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T030.CODFIS ELSE CODFIS END,
              NRPATENT = CASE VL_DES_T030('NRPATENT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T030.NRPATENT ELSE NRPATENT END,
              DTEENDPATENT = CASE VL_DES_T030('DTEENDPATENT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T030.DTEENDPATENT ELSE DTEENDPATENT END,
              CODAUTHMODE = CASE VL_DES_T030('CODAUTHMODE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T030.CODAUTHMODE ELSE CODAUTHMODE END,
              USRGROUPOFFLINE = CASE VL_DES_T030('USRGROUPOFFLINE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T030.USRGROUPOFFLINE ELSE USRGROUPOFFLINE END,
              VALLATITUDE = CASE VL_DES_T030('VALLATITUDE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T030.VALLATITUDE ELSE VALLATITUDE END,
              VALLONGITUDE = CASE VL_DES_T030('VALLONGITUDE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T030.VALLONGITUDE ELSE VALLONGITUDE END,
              UDLTEMPLATE = CASE VL_DES_T030('UDLTEMPLATE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T030.UDLTEMPLATE ELSE UDLTEMPLATE END,
              FLGISUDLTEMPLATE = CASE VL_DES_T030('FLGISUDLTEMPLATE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T030.FLGISUDLTEMPLATE ELSE FLGISUDLTEMPLATE END,
              FLGISPDATEMPLATE = CASE VL_DES_T030('FLGISPDATEMPLATE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T030.FLGISPDATEMPLATE ELSE FLGISPDATEMPLATE END,
              PDATEMPLATE = CASE VL_DES_T030('PDATEMPLATE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T030.PDATEMPLATE ELSE PDATEMPLATE END,
              DESMON = CASE VL_DES_T030('DESMON.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T030.DESMON ELSE DESMON END,
              DESTUE = CASE VL_DES_T030('DESTUE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T030.DESTUE ELSE DESTUE END,
              DESWED = CASE VL_DES_T030('DESWED.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T030.DESWED ELSE DESWED END,
              DESTHU = CASE VL_DES_T030('DESTHU.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T030.DESTHU ELSE DESTHU END,
              DESFRI = CASE VL_DES_T030('DESFRI.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T030.DESFRI ELSE DESFRI END,
              DESSAT = CASE VL_DES_T030('DESSAT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T030.DESSAT ELSE DESSAT END,
              DESSUN = CASE VL_DES_T030('DESSUN.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T030.DESSUN ELSE DESSUN END,

              FLG_DSD_PRICINGVARIATION = CASE VL_DES_T030('FLG_DSD_PRICINGVARIATION.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T030.FLG_DSD_PRICINGVARIATION ELSE FLG_DSD_PRICINGVARIATION END,
              FLG_DSD_HIDEPRICES       = CASE VL_DES_T030('FLG_DSD_HIDEPRICES.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T030.FLG_DSD_HIDEPRICES ELSE FLG_DSD_HIDEPRICES END,
              DSD_PRICEMAXPERC         = CASE VL_DES_T030('DSD_PRICEMAXPERC.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T030.DSD_PRICEMAXPERC ELSE DSD_PRICEMAXPERC END,
              DSD_DISCOUNTMAXPERC      = CASE VL_DES_T030('DSD_DISCOUNTMAXPERC.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T030.DSD_DISCOUNTMAXPERC ELSE DSD_DISCOUNTMAXPERC END,
              DSD_MAXFREEGOOD          = CASE VL_DES_T030('DSD_MAXFREEGOOD.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T030.DSD_MAXFREEGOOD ELSE DSD_MAXFREEGOOD END,
              FLG_DSD_PREORDER         = CASE VL_DES_T030('FLG_DSD_PREORDER.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T030.FLG_DSD_PREORDER ELSE FLG_DSD_PREORDER END,

              CODAUTHORIZATION         = CASE VL_DES_T030('CODAUTHORIZATION.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T030.CODAUTHORIZATION ELSE CODAUTHORIZATION END,

               --- Technical fields
               CODUSRMOD = REC_T030.CODUSRMOD,
               DTEMOD    = REC_T030.DTEMOD,
               -- lock fields
               CODUSRLCK    = REC_T030.CODUSRLCK,
               IDSESSIONLCK = REC_T030.IDSESSIONLCK,
               DTELCK       = REC_T030.DTELCK

         WHERE CODUSR = REC_T030.CODUSR
         and not exists ( select null from T035LOGGEDUSERS T035 where T035.IDSESSION = NVL(IDSESSIONLCK, '@') AND T035.LASTCHECK > TRUNC(XSYSDATE)-1 );


        -- no data found, it could be
        --   a. record does not exists
        --   b. record is locked by another sm1 user

        IF SQL%ROWCOUNT = 0 THEN


          VL_COUNT := 0;
          SELECT COUNT(*) INTO VL_COUNT FROM T030USER
           WHERE CODUSR = REC_T030.CODUSR;


          IF ( VL_COUNT = 0 ) THEN

              VL_MESSAGE_D := 'Insert T030USER ';
              -- Record does not exists, we insert it
              INSERT INTO T030USER VALUES REC_T030;
          ELSE
            VL_STATUS := -1;
            VL_RECORD_LOCKED := -1;
            PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                           VL_PROGR_D_T030,
                                           SQLCODE,
                                           'Record is locked; import has failed :'||VL_MESSAGE_H);

          END IF; -- Record has been inserted
        END IF; -- Record has been updated
        END IF; -- VL_STATUS = 0


        EXCEPTION WHEN OTHERS THEN
             VL_STATUS := -1;
             VL_MESSAGE_H := SUBSTR(VL_MESSAGE_H||' '||VL_MESSAGE_D||' '||dbms_utility.format_error_backtrace() || ' ' || SQLERRM,1,4000);

             PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                           VL_PROGR_D_T030,
                                           SQLCODE,
                                           VL_MESSAGE_H);

        END; -- HEAD T030


       -- -----------------------------------
        -- T031USER DIVISION INFO
        -- -----------------------------------
        BEGIN
        --
        IF ( VL_STATUS = 0  ) THEN
              -- Division info T031USERDIV

              FOR RL_XIN_T031 IN CL_XIN_T031(RL_XIN_T030.CODUSR, RL_XIN_T030.SM1_DTECRE) LOOP

                VL_MESSAGE_H := 'Division Info: '|| RL_XIN_T031.CODUSR || '/' ||
                                                    RL_XIN_T031.CODDIV;

                  VL_MESSAGE_D := 'Format Conversion ';
                VL_CODDIV := RL_XIN_T031.CODDIV;
                REC_T031.CODUSR := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T031.CODUSR,'CODUSR', VL_DES_T031,VL_STATUS, VL_MESSAGE_D);
                REC_T031.CODDIV := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T031.CODDIV,'CODDIV', VL_DES_T031,VL_STATUS, VL_MESSAGE_D);
                REC_T031.CODUSRSUP1 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T031.CODUSRSUP1,'CODUSRSUP1', VL_DES_T031,VL_STATUS, VL_MESSAGE_D);
                REC_T031.CODUSRSUP2 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T031.CODUSRSUP2,'CODUSRSUP2', VL_DES_T031,VL_STATUS, VL_MESSAGE_D);
                REC_T031.CODUSRSUP3 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T031.CODUSRSUP3,'CODUSRSUP3', VL_DES_T031,VL_STATUS, VL_MESSAGE_D);
                REC_T031.CODUSRSUP4 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T031.CODUSRSUP4,'CODUSRSUP4', VL_DES_T031,VL_STATUS, VL_MESSAGE_D);
                REC_T031.CODUSRSUP5 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T031.CODUSRSUP5,'CODUSRSUP5', VL_DES_T031,VL_STATUS, VL_MESSAGE_D);
                REC_T031.CODUSRSUP6 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T031.CODUSRSUP6,'CODUSRSUP6', VL_DES_T031,VL_STATUS, VL_MESSAGE_D);
                REC_T031.CODPARTY := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T031.CODPARTY,'CODPARTY', VL_DES_T031,VL_STATUS, VL_MESSAGE_D);
                REC_T031.USRGROUP := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T031.USRGROUP,'USRGROUP', VL_DES_T031,VL_STATUS, VL_MESSAGE_D);
                REC_T031.USRTYPE := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T031.USRTYPE,'USRTYPE', VL_DES_T031,VL_STATUS, VL_MESSAGE_D);
                REC_T031.FLGISUSER := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T031.FLGISUSER,'FLGISUSER', VL_DES_T031,VL_STATUS, VL_MESSAGE_D);
                REC_T031.FLGISSALES := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T031.FLGISSALES,'FLGISSALES', VL_DES_T031,VL_STATUS, VL_MESSAGE_D);
                REC_T031.CODDISCLISMAX := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T031.CODDISCLISMAX,'CODDISCLISMAX', VL_DES_T031,VL_STATUS, VL_MESSAGE_D);
                REC_T031.CODSTATUS := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T031.CODSTATUS,'CODSTATUS', VL_DES_T031,VL_STATUS, VL_MESSAGE_D);
                REC_T031.DTEMODSTATUS := F_CHECK_FORMAT_D( VL_CODDIV,   RL_XIN_T031.DTEMODSTATUS,'DTEMODSTATUS',VL_DES_T031,VL_STATUS, VL_MESSAGE_D);
                REC_T031.CODUSRMODSTATUS := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T031.CODUSRMODSTATUS,'CODUSRMODSTATUS', VL_DES_T031,VL_STATUS, VL_MESSAGE_D);
                REC_T031.CODWHSSALES := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T031.CODWHSSALES,'CODWHSSALES', VL_DES_T031,VL_STATUS, VL_MESSAGE_D);
                REC_T031.CODWHSDELIV := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T031.CODWHSDELIV,'CODWHSDELIV', VL_DES_T031,VL_STATUS, VL_MESSAGE_D);
                REC_T031.CODSHIPPER := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T031.CODSHIPPER,'CODSHIPPER', VL_DES_T031,VL_STATUS, VL_MESSAGE_D);
                REC_T031.CODZONE := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T031.CODZONE,'CODZONE', VL_DES_T031,VL_STATUS, VL_MESSAGE_D);
                REC_T031.VALCREDIT := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T031.VALCREDIT,'VALCREDIT', VL_DES_T031,VL_STATUS, VL_MESSAGE_D);
                REC_T031.CODCUR := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T031.CODCUR,'CODCUR', VL_DES_T031,VL_STATUS, VL_MESSAGE_D);
                REC_T031.CODDISCLISBLK := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T031.CODDISCLISBLK,'CODDISCLISBLK', VL_DES_T031,VL_STATUS, VL_MESSAGE_D);
                REC_T031.FLGAUTO := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T031.FLGAUTO,'FLGAUTO', VL_DES_T031,VL_STATUS, VL_MESSAGE_D);
                REC_T031.CODVEHICLE := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T031.CODVEHICLE,'CODVEHICLE', VL_DES_T031,VL_STATUS, VL_MESSAGE_D);
                REC_T031.CODTOWING := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T031.CODTOWING,'CODTOWING', VL_DES_T031,VL_STATUS, VL_MESSAGE_D);
                REC_T031.CODAGREEMENT := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T031.CODAGREEMENT,'CODAGREEMENT', VL_DES_T031,VL_STATUS, VL_MESSAGE_D);
                REC_T031.DTESTARTAGREE := F_CHECK_FORMAT_D( VL_CODDIV,   RL_XIN_T031.DTESTARTAGREE,'DTESTARTAGREE',VL_DES_T031, VL_STATUS, VL_MESSAGE_D);
                REC_T031.DTEENDAGREE := F_CHECK_FORMAT_D( VL_CODDIV,   RL_XIN_T031.DTEENDAGREE,'DTEENDAGREE',VL_DES_T031,VL_STATUS, VL_MESSAGE_D);
                REC_T031.DTEBLC := F_CHECK_FORMAT_D( VL_CODDIV,  RL_XIN_T031.DTEBLC,'DTEBLC',VL_DES_T031,VL_STATUS, VL_MESSAGE_D);
                REC_T031.CODUSRBLC := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T031.CODUSRBLC,'CODUSRBLC', VL_DES_T031,VL_STATUS, VL_MESSAGE_D);
                REC_T031.FLGFFS := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T031.FLGFFS,'FLGFFS', VL_DES_T031,VL_STATUS, VL_MESSAGE_D);
                REC_T031.CODMODLIQ := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T031.CODMODLIQ,'CODMODLIQ', VL_DES_T031,VL_STATUS, VL_MESSAGE_D);
                REC_T031.USRGROUPOFFLINE := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T031.USRGROUPOFFLINE,'USRGROUPOFFLINE', VL_DES_T031,VL_STATUS, VL_MESSAGE_D);
                REC_T031.CODBS := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T031.CODBS,'CODBS', VL_DES_T031,VL_STATUS, VL_MESSAGE_D);

                REC_T031.FLGMANDATORYCHECK := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T031.FLGMANDATORYCHECK,'FLGMANDATORYCHECK', VL_DES_T031,VL_STATUS, VL_MESSAGE_D);


                 IF (VL_STATUS <> 0 ) THEN
                   VL_MESSAGE_H := SUBSTR(VL_MESSAGE_H||' '||VL_MESSAGE_D||' '||dbms_utility.format_error_backtrace() || ' ' || SQLERRM,1,4000);
                   PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                           VL_PROGR_D_T031,
                                           SQLCODE,
                                           VL_MESSAGE_H);
                 END IF;

                --
                IF (VL_STATUS = 0 ) THEN
                VL_MESSAGE_D := 'Update T031 ';
                UPDATE T031USERDIV
                   SET
                      CODUSRSUP1 = CASE VL_DES_T031('CODUSRSUP1.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T031.CODUSRSUP1 ELSE CODUSRSUP1 END,
                      CODUSRSUP2 = CASE VL_DES_T031('CODUSRSUP2.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T031.CODUSRSUP2 ELSE CODUSRSUP2 END,
                      CODUSRSUP3 = CASE VL_DES_T031('CODUSRSUP3.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T031.CODUSRSUP3 ELSE CODUSRSUP3 END,
                      CODUSRSUP4 = CASE VL_DES_T031('CODUSRSUP4.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T031.CODUSRSUP4 ELSE CODUSRSUP4 END,
                      CODUSRSUP5 = CASE VL_DES_T031('CODUSRSUP5.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T031.CODUSRSUP5 ELSE CODUSRSUP5 END,
                      CODUSRSUP6 = CASE VL_DES_T031('CODUSRSUP6.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T031.CODUSRSUP6 ELSE CODUSRSUP6 END,
                      CODPARTY = CASE VL_DES_T031('CODPARTY.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T031.CODPARTY ELSE CODPARTY END,
                      USRGROUP = CASE VL_DES_T031('USRGROUP.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T031.USRGROUP ELSE USRGROUP END,
                      USRTYPE = CASE VL_DES_T031('USRTYPE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T031.USRTYPE ELSE USRTYPE END,
                      FLGISUSER = CASE VL_DES_T031('FLGISUSER.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T031.FLGISUSER ELSE FLGISUSER END,
                      FLGISSALES = CASE VL_DES_T031('FLGISSALES.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T031.FLGISSALES ELSE FLGISSALES END,
                      CODDISCLISMAX = CASE VL_DES_T031('CODDISCLISMAX.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T031.CODDISCLISMAX ELSE CODDISCLISMAX END,
                      CODSTATUS = CASE VL_DES_T031('CODSTATUS.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T031.CODSTATUS ELSE CODSTATUS END,
                      DTEMODSTATUS = CASE VL_DES_T031('DTEMODSTATUS.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T031.DTEMODSTATUS ELSE DTEMODSTATUS END,
                      CODUSRMODSTATUS = CASE VL_DES_T031('CODUSRMODSTATUS.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T031.CODUSRMODSTATUS ELSE CODUSRMODSTATUS END,
                      CODWHSSALES = CASE VL_DES_T031('CODWHSSALES.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T031.CODWHSSALES ELSE CODWHSSALES END,
                      CODWHSDELIV = CASE VL_DES_T031('CODWHSDELIV.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T031.CODWHSDELIV ELSE CODWHSDELIV END,
                      CODSHIPPER = CASE VL_DES_T031('CODSHIPPER.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T031.CODSHIPPER ELSE CODSHIPPER END,
                      CODZONE = CASE VL_DES_T031('CODZONE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T031.CODZONE ELSE CODZONE END,
                      VALCREDIT = CASE VL_DES_T031('VALCREDIT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T031.VALCREDIT ELSE VALCREDIT END,
                      CODCUR = CASE VL_DES_T031('CODCUR.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T031.CODCUR ELSE CODCUR END,
                      CODDISCLISBLK = CASE VL_DES_T031('CODDISCLISBLK.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T031.CODDISCLISBLK ELSE CODDISCLISBLK END,
                      FLGAUTO = CASE VL_DES_T031('FLGAUTO.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T031.FLGAUTO ELSE FLGAUTO END,
                      CODVEHICLE = CASE VL_DES_T031('CODVEHICLE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T031.CODVEHICLE ELSE CODVEHICLE END,
                      CODTOWING = CASE VL_DES_T031('CODTOWING.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T031.CODTOWING ELSE CODTOWING END,
                      CODAGREEMENT = CASE VL_DES_T031('CODAGREEMENT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T031.CODAGREEMENT ELSE CODAGREEMENT END,
                      DTESTARTAGREE = CASE VL_DES_T031('DTESTARTAGREE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T031.DTESTARTAGREE ELSE DTESTARTAGREE END,
                      DTEENDAGREE = CASE VL_DES_T031('DTEENDAGREE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T031.DTEENDAGREE ELSE DTEENDAGREE END,
                      DTEBLC = CASE VL_DES_T031('DTEBLC.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T031.DTEBLC ELSE DTEBLC END,
                      CODUSRBLC = CASE VL_DES_T031('CODUSRBLC.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T031.CODUSRBLC ELSE CODUSRBLC END,
                      FLGFFS = CASE VL_DES_T031('FLGFFS.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T031.FLGFFS ELSE FLGFFS END,
                      CODMODLIQ = CASE VL_DES_T031('CODMODLIQ.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T031.CODMODLIQ ELSE CODMODLIQ END,
                      USRGROUPOFFLINE = CASE VL_DES_T031('USRGROUPOFFLINE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T031.USRGROUPOFFLINE ELSE USRGROUPOFFLINE END,
                      CODBS = CASE VL_DES_T031('CODBS.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T031.CODBS ELSE CODBS END,
                      FLGMANDATORYCHECK = CASE VL_DES_T031('FLGMANDATORYCHECK.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T031.FLGMANDATORYCHECK ELSE FLGMANDATORYCHECK END

                 WHERE CODUSR = REC_T031.CODUSR
                   AND CODDIV = REC_T031.CODDIV;
                --
                IF SQL%ROWCOUNT = 0 THEN
                  -- record does not exists , we insert it
                  VL_MESSAGE_D := 'Insert T031 ';
                  INSERT INTO T031USERDIV VALUES REC_T031;
                END IF;
                VL_INS_T031 := VL_INS_T031 + 1;
                --
                END IF;
         END LOOP;   --T031USERDIV
       END IF;
       EXCEPTION WHEN OTHERS THEN
             VL_STATUS := -1;
             VL_MESSAGE_H := SUBSTR(VL_MESSAGE_H||' '||VL_MESSAGE_D||' '||dbms_utility.format_error_backtrace() || ' ' || SQLERRM,1,4000);

             PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                           VL_PROGR_D_T031,
                                           SQLCODE,
                                           VL_MESSAGE_H);

      END; -- DIVISION T031
      -- if all records have been stored with success then it makes the commit
      IF VL_STATUS = 0 THEN
         VL_INS_T030 := VL_INS_T030 + 1;
         COMMIT;
      ELSE
        ROLLBACK;
      END IF;

      IF (VL_STATUS <> 0 OR VL_RECORD_LOCKED <> 0) THEN
          UPDATE XIN_T031USERDIV
          SET  SM1_STATUS= CASE
                                WHEN VL_RECORD_LOCKED <> 0  THEN C_XINSTATUS_LOCK
                                ELSE C_XINSTATUS_ERR END
          WHERE CODUSR = RL_XIN_T030.CODUSR
           AND  SM1_CODPROCESS = PI_PROGR_H
           AND  SM1_DTECRE     = RL_XIN_T030.SM1_DTECRE
           AND  SM1_STATUS     = C_XINSTATUS_OK;

          -- TO CHECK this update is  not correct in case of double record .
          UPDATE XIN_T030USER
          SET  SM1_STATUS= CASE
                                WHEN VL_RECORD_LOCKED <> 0  THEN C_XINSTATUS_LOCK
                                ELSE C_XINSTATUS_ERR END
          WHERE CODUSR = RL_XIN_T030.CODUSR
           AND  SM1_CODPROCESS = PI_PROGR_H
           AND  SM1_DTECRE     <= RL_XIN_T030.SM1_DTECRE
           AND  SM1_STATUS     = C_XINSTATUS_OK;

          COMMIT;
      END IF;

        -- Release updated records
          UPDATE T030USER
          SET       DTELCK          = NULL,
                    IDSESSIONLCK    = NULL,
                    CODUSRLCK       = NULL
          WHERE CODUSR = REC_T030.CODUSR AND CODUSRLCK = C_SYSUSR AND IDSESSIONLCK = PI_SESSION_ID;
          COMMIT;
    END LOOP;  -- T030USER


    -- Moves records from staging area to log staging area
    P_XIN_MOVE_TO_LOG(PI_PROGR_H, VL_PROGR_D_T030,'T031USERDIV');
    P_XIN_MOVE_TO_LOG(PI_PROGR_H, VL_PROGR_D_T030,'T030USER');

   -- Close Logs
    PKG_UTILS.LOG_END_DETAIL(PI_PROGR_H,
                             VL_PROGR_D_T031,
                             0,
                             VL_COUNT_XIN_T031,
                             VL_INS_T031,
                             VL_COUNT_XIN_T031 - VL_INS_T031);

    PKG_UTILS.LOG_END_DETAIL(PI_PROGR_H,
                             VL_PROGR_D_T030,
                             0,
                             VL_COUNT_XIN_T030,
                             VL_INS_T030,
                             VL_COUNT_XIN_T030 - VL_INS_T030);


    PO_MSG    := VL_INS_T030||'/'||VL_COUNT_XIN_T030||' Users loaded';
    PO_STATUS := VL_INS_T030;


    --
  EXCEPTION WHEN EX_EXIT THEN

          ROLLBACK;
          VL_MESSAGE_H       := VL_MESSAGE_H || TRIM(SUBSTR(dbms_utility.format_error_backtrace() || ' ' || SQLERRM, 1, 255));
          PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                         VL_PROGR_D_T030,
                                         SQLCODE,
                                         VL_MESSAGE_H);

          PO_MSG := VL_MESSAGE_H;
          PO_STATUS := -1;

   WHEN OTHERS THEN

          ROLLBACK;
         -- Release updated records
            UPDATE T030USER
            SET       DTELCK          = NULL,
                      IDSESSIONLCK    = NULL,
                      CODUSRLCK       = NULL
            WHERE CODUSRLCK = C_SYSUSR AND IDSESSIONLCK = PI_SESSION_ID;
            COMMIT;
          -- Moves records from staging area to log staging area
          P_XIN_MOVE_TO_LOG(PI_PROGR_H, VL_PROGR_D_T030,'T031USERDIV');
          P_XIN_MOVE_TO_LOG(PI_PROGR_H, VL_PROGR_D_T030,'T030USER');

          VL_MESSAGE_H       := VL_MESSAGE_H || TRIM(SUBSTR(dbms_utility.format_error_backtrace() || ' ' || SQLERRM, 1, 255));

          PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                         VL_PROGR_D_T030,
                                         SQLCODE,
                                         VL_MESSAGE_H);

          PO_MSG := VL_MESSAGE_H;
          PO_STATUS := VL_STATUS;

  END LOAD_T03X_USERS;
  --

  /*============================================================================*\
  /* Name: T04X_CUSTOMERS
        Loads SM1 tables
        • T040PARTY            Customers master data. The table contains customer common data (data shared between all the divisions). One master data entity can be of different typologies: a) Delivery Customer b) Invoice Customer c) Point of Sales d) Customer hierarchy node e) Doctor, Hospital,  Pharmacy. One customer entity can play more than one role.
        • T041PARTYDIV         Divisional customer master data
        • T042PARTYADDR Customer addresses
        • T045PARTYWEEK Customer weekly plans. In this table are store customer weekly plans like Closure days, visit days, delivery days etc... for each weekly plan the value can be: a time range (from hour/to hour); two time ranges; a decode table value (QTABS); a free text
        • T046PARTYBANK Customer bank data
        • T047PARTYCONTACT  Contacts registry.
        • T049PVCATEGORY  Point of Sales product category specific information
        • TA4410NOTES Customer Notes

        Staging Area (SSA) tables (Chronological Order expected in SSA  for each customer):
        1.  XIN_T045PARTYWEEK
        2.  XIN_T046PARTYBANK
        3.  XIN_T047PARTYCONTACT
        4.  XIN_T049PVCATEGORY
        5.  XIN_TA4410NOTES_CUST
        6.  XIN_T042PARTYADDR
        7.  XIN_T041PARTYDIV
        8.  XIN_T040PARTY

        Loading logic:
        • T040/T041/T042  UPDATE + INSERT each record is updated if already exists (checking by primary key) and it is not already locked, and inserted new if it does not exist yet.
        • TA4410/T045/T046/T047/T049  DELETE whole customer record set + INSERT: on each import all records on same customer/division are deleted and inserted new.

        Validity Checks:
        • Customers found on staging area are loaded to SM1 main tables only if they are not already opened for update by a SM1 user. In that case records remain in staging area ready to be loaded on next import run.
        • Details Records found on  XIN_T041, XIN_T042, XIN_TA4410  are loaded only if there is the head record in XIN_T040PARTY.
        • Details in XIN_T045, XIN_T046, XIN_T047, XIN_T049 are loaded only if there is a record in XIN_T041 with same customer/division ( CODPARTY/CODDIV)

        Error handling:
        • All Errors will be logged in T852/T854 SM1 log tables and all staging area records will be stored into staging area log with sm1_status = 9.
        • Error on head record XIN_T040,  it is discarded with all its details.
        • Error on detail record XIN_T041, XIN_T042,  it is discarded with its head and all other customer details.
        • Error on detail record XIN_TA4410, XIN_T045, XIN_T046, XIN_T047, XIN_T049, all detail records in the same XIN will be skipped in order to maintain the old version of that detail. All other records of the same customer will be successfully stored in SM1.

        How to delete :
        • a whole Customer: customers can be logically deleted by setting field XIN_T040PARTY.FLGANN=-1.
        • customer detail T041/T042: you cannot delete this type of detail by integration host.
        • customer detail TA4410/T045/T046/T047/T049: if you want to maintain the history you can set FLGANN=-1 field where available, otherwise you can simply not write anymore to SSA the detail you want to delete.


     Input parameters :     PI_PROGR_H - unique sm1 job number ( T800SYSTEMACTIVITYLOG )
                            PI_SESSION_ID    - unique login session (T035LOGGEDUSERS)
     Outputparameters :     PO_MSG           - message of error if procedure exit with error
                            PO_STATUS        - 0 OK; -1 Error
     Author : Mariangela Bandiera
     Creation Date : 14 September 2012
     ----
     Updates :
     MBandiera 19 september 2013 added new fields
         T041.FLG_DSD_PRINT_PRICES
         T041.FLG_DSD_BLK_PAYTRM
         T041.DSD_CODBLK_VALCREDIT
         T041.FLG_DSD_PAPARLESS

     MBandiera 31 JULY 2014 added new fields

     T040.FLGCUSTWHS  NUMBER(1)   Warehouse flag.
     T040.FLGCUSTVAN  NUMBER(1)   Van flag.
     T041.CODPAYMOD2  VARCHAR2(30)      Payment mode code 2 [CONF:QTABS=CPMOD]
     T041.CODPAYTRM2  VARCHAR2(30)      Payment term code 2 [CONF:QTABS=CPTRM]

    ============================================================================ */

   PROCEDURE LOAD_T04X_CUSTOMERS(PI_PROGR_H       IN NUMBER,
                           PI_SESSION_ID    IN NUMBER,
                           PO_MSG           OUT NOCOPY VARCHAR2,
                           PO_STATUS        OUT NOCOPY NUMBER ) IS

    -- -----------------------------------------
    -- Cursor on main Customer table T040PARTY
    -- -----------------------------------------
    CURSOR CL_XIN_T040 IS
      SELECT
          *
        FROM  XIN_T040PARTY
        WHERE SM1_CODPROCESS = PI_PROGR_H
        -- BEAWARE : his order is mandatory for a correct loading, if it is needed to change it, the whole procedure must be reviewed
        ORDER BY CODPARTY, SM1_DTECRE ASC;

    -- -------------------------------------
    -- Cursor on Division info T041PARTYDIV
    -- -------------------------------------
    CURSOR CL_XIN_T041(CI_CODPARTY VARCHAR2, CI_SM1_DTECRE DATE) IS
      SELECT *
        FROM XIN_T041PARTYDIV
       WHERE CODPARTY = CI_CODPARTY
         AND SM1_CODPROCESS = PI_PROGR_H
       --  AND SM1_DTECRE <= CI_SM1_DTECRE
         AND SM1_STATUS = C_XINSTATUS_OK -- Only those that have not processed yet (in case of double record in xin)
         ORDER BY SM1_DTECRE;

    -- -------------------------------------
    -- Cursor on Address info T042PARTYADDR
    -- -------------------------------------

    CURSOR CL_XIN_T042(CI_CODPARTY VARCHAR2, CI_SM1_DTECRE DATE) IS
      SELECT  *

        FROM XIN_T042PARTYADDR
       WHERE CODPARTY = CI_CODPARTY
         AND SM1_CODPROCESS = PI_PROGR_H
        -- AND SM1_DTECRE <= CI_SM1_DTECRE
         AND SM1_STATUS = C_XINSTATUS_OK -- Only those that have not processed yet (in case of double record in xin)
          ORDER BY SM1_DTECRE;

    -- -------------------------------------
    -- Cursor on Customer Notes Ta4410Notes
    -- -------------------------------------
    CURSOR CL_XIN_TA4410(CI_CODPARTY VARCHAR2, CI_SM1_DTECRE DATE) IS
      SELECT
         *

        FROM XIN_TA4410NOTES_CUST
       WHERE CODPARTY = CI_CODPARTY
         AND SM1_CODPROCESS = PI_PROGR_H
       --  AND SM1_DTECRE <= CI_SM1_DTECRE
         AND SM1_STATUS = C_XINSTATUS_OK -- Only those that have not processed yet (in case of double record in xin)
          ORDER BY SM1_DTECRE;

    -- -------------------------------------
    -- Cursor on Weekly plan Info T046PartyBank
    -- -------------------------------------
    CURSOR CL_XIN_T045(CI_CODPARTY VARCHAR2, CI_CODDIV VARCHAR2, CI_SM1_DTECRE DATE) IS
      SELECT
          *
        FROM XIN_T045PARTYWEEK
       WHERE CODPARTY = CI_CODPARTY
         AND CODDIV   = CI_CODDIV
         AND SM1_CODPROCESS = PI_PROGR_H
        -- AND SM1_DTECRE <= CI_SM1_DTECRE
         AND SM1_STATUS = C_XINSTATUS_OK -- Only those that have not processed yet (in case of double record in xin)
          ORDER BY SM1_DTECRE;

    -- -------------------------------------
    -- Cursor on Bank Info T046PartyBank
    -- -------------------------------------

    CURSOR CL_XIN_T046(CI_CODPARTY VARCHAR2, CI_CODDIV VARCHAR2, CI_SM1_DTECRE DATE) IS
      SELECT
          *

        FROM XIN_T046PARTYBANK
       WHERE CODPARTY = CI_CODPARTY
         AND CODDIV   = CI_CODDIV
         AND SM1_CODPROCESS = PI_PROGR_H
       --  AND SM1_DTECRE <= CI_SM1_DTECRE
         AND SM1_STATUS = C_XINSTATUS_OK -- Only those that have not processed yet (in case of double record in xin)
          ORDER BY SM1_DTECRE;


    -- -------------------------------------
    -- Cursor on Contact Info T047PartyContact
    -- -------------------------------------

    CURSOR CL_XIN_T047(CI_CODPARTY VARCHAR2, CI_CODDIV VARCHAR2, CI_SM1_DTECRE DATE) IS
      SELECT
         *

        FROM XIN_T047PARTYCONTACT
       WHERE CODPARTY = CI_CODPARTY
         AND CODDIV   = CI_CODDIV
         AND SM1_CODPROCESS = PI_PROGR_H
        -- AND SM1_DTECRE <= CI_SM1_DTECRE
         AND SM1_STATUS = C_XINSTATUS_OK -- Only those that have not processed yet (in case of double record in xin)
          ORDER BY SM1_DTECRE;

    -- -------------------------------------
    -- Cursor on Category Info T049PVcategoru
    -- -------------------------------------

    CURSOR CL_XIN_T049(CI_CODPARTY VARCHAR2, CI_CODDIV VARCHAR2, CI_SM1_DTECRE DATE) IS
      SELECT
          *

        FROM XIN_T049PVCATEGORY
       WHERE CODPARTY = CI_CODPARTY
         AND CODDIV   = CI_CODDIV
         AND SM1_CODPROCESS = PI_PROGR_H
      --   AND SM1_DTECRE <= CI_SM1_DTECRE
         AND SM1_STATUS = C_XINSTATUS_OK -- Only those that have not processed yet (in case of double record in xin)
          ORDER BY SM1_DTECRE;


    --
    VL_MESSAGE_H   VARCHAR2(4000) := 'Error while loading CUSTOMERS T04X';
    VL_MESSAGE_D   VARCHAR2(4000) := NULL;
    --
    VL_PROGR_D_T040    NUMBER := 0;
    VL_COUNT_XIN_T040  NUMBER := 0;
    VL_INS_T040        NUMBER := 0;
    --
    VL_PROGR_D_T041    NUMBER := 0;
    VL_COUNT_XIN_T041  NUMBER := 0;
    VL_INS_T041        NUMBER := 0;
    --
    VL_PROGR_D_T042    NUMBER := 0;
    VL_COUNT_XIN_T042  NUMBER := 0;
    VL_INS_T042        NUMBER := 0;
    --
    VL_PROGR_D_TA4410    NUMBER := 0;
    VL_COUNT_XIN_TA4410  NUMBER := 0;
    VL_INS_TA4410        NUMBER := 0;
    --
    VL_PROGR_D_T045    NUMBER := 0;
    VL_COUNT_XIN_T045  NUMBER := 0;
    VL_INS_T045        NUMBER := 0;
    --
    VL_PROGR_D_T046    NUMBER := 0;
    VL_COUNT_XIN_T046  NUMBER := 0;
    VL_INS_T046        NUMBER := 0;
    --
    VL_PROGR_D_T047    NUMBER := 0;
    VL_COUNT_XIN_T047  NUMBER := 0;
    VL_INS_T047        NUMBER := 0;
    --
    VL_PROGR_D_T049    NUMBER := 0;
    VL_COUNT_XIN_T049  NUMBER := 0;
    VL_INS_T049        NUMBER := 0;
    --
    REC_T040 T040PARTY%ROWTYPE          := NULL;
    REC_T041 T041PARTYDIV%ROWTYPE       := NULL;
    REC_T042 T042PARTYADDR%ROWTYPE      := NULL;
    REC_TA4410 TA4410NOTES%ROWTYPE      := NULL;
    REC_T045 T045PARTYWEEK%ROWTYPE      := NULL;
    REC_T046 T046PARTYBANK%ROWTYPE      := NULL;
    REC_T047 T047PARTYCONTACT%ROWTYPE   := NULL;
    REC_T049 T049PVCATEGORY%ROWTYPE     := NULL;
    --
    REC_T040_INIT T040PARTY%ROWTYPE          := NULL;
    REC_T041_INIT T041PARTYDIV%ROWTYPE       := NULL;
    REC_T042_INIT T042PARTYADDR%ROWTYPE      := NULL;
    REC_TA4410_INIT TA4410NOTES%ROWTYPE      := NULL;
    REC_T045_INIT T045PARTYWEEK%ROWTYPE      := NULL;
    REC_T046_INIT T046PARTYBANK%ROWTYPE      := NULL;
    REC_T047_INIT T047PARTYCONTACT%ROWTYPE   := NULL;
    REC_T049_INIT T049PVCATEGORY%ROWTYPE     := NULL;
    --
    VL_DES_T040     X_FIELD_INFO_ARRAY;-- Array with fields db info
    VL_DES_T041     X_FIELD_INFO_ARRAY;-- Array with fields db info
    VL_DES_T042     X_FIELD_INFO_ARRAY;-- Array with fields db info
    VL_DES_TA4410   X_FIELD_INFO_ARRAY;-- Array with fields db info
    VL_DES_T045     X_FIELD_INFO_ARRAY;-- Array with fields db info
    VL_DES_T046     X_FIELD_INFO_ARRAY;-- Array with fields db info
    VL_DES_T047     X_FIELD_INFO_ARRAY;-- Array with fields db info
    VL_DES_T049     X_FIELD_INFO_ARRAY;-- Array with fields db info
    --
    VL_RECORD_LOCKED NUMBER := 0;
    VL_STATUS NUMBER:= 0;
    VL_COUNT  NUMBER:= 0;
    VL_STEP   NUMBER:= 0; -- Used to ping t035
    --
    VL_D_SM1_DTECRE DATE:= C_SM1_NULL_DATE;
    --
    EX_EXIT  EXCEPTION;
    --
    VL_CODDIV VARCHAR2(30) := NULL;

  BEGIN

     -- Rebuild indexes and compute statistics
    P_XIN_INIT_INDEXES (PI_PROGR_H, 'T040PARTY');
    P_XIN_INIT_INDEXES (PI_PROGR_H, 'T041PARTYDIV');
    P_XIN_INIT_INDEXES (PI_PROGR_H, 'T042PARTYADDR');
   -- P_XIN_INIT_INDEXES (PI_PROGR_H, 'TA4410NOTES_CUST');
    P_XIN_INIT_INDEXES (PI_PROGR_H, 'T045PARTYWEEK');
    P_XIN_INIT_INDEXES (PI_PROGR_H, 'T046PARTYBANK');
    P_XIN_INIT_INDEXES (PI_PROGR_H, 'T047PARTYCONTACT');
    P_XIN_INIT_INDEXES (PI_PROGR_H, 'T049PVCATEGORY');
    -- Clean up older log

    P_XIN_CLEANUP_LOG (PI_PROGR_H, 'T040PARTY');
    P_XIN_CLEANUP_LOG (PI_PROGR_H, 'T041PARTYDIV');
    P_XIN_CLEANUP_LOG (PI_PROGR_H, 'T042PARTYADDR');
    P_XIN_CLEANUP_LOG (PI_PROGR_H, 'TA4410NOTES_CUST');
    P_XIN_CLEANUP_LOG (PI_PROGR_H, 'T045PARTYWEEK');
    P_XIN_CLEANUP_LOG (PI_PROGR_H, 'T046PARTYBANK');
    P_XIN_CLEANUP_LOG (PI_PROGR_H, 'T047PARTYCONTACT');
    P_XIN_CLEANUP_LOG (PI_PROGR_H, 'T049PVCATEGORY');
    --

    VL_PROGR_D_T040 := PKG_UTILS.LOG_NEW_DETAIL(PI_PROGR_H,
                                                'CUSTOMER HEAD',
                                                'IMPORT --> T040PARTY',
                                                 0,
                                                 NULL);
    --
    VL_PROGR_D_T041 := PKG_UTILS.LOG_NEW_DETAIL(PI_PROGR_H,
                                                'CUSTOMER DIV INFO',
                                                 'IMPORT --> T041PARTYDIV',
                                                  0,
                                                   NULL);
    --
    VL_PROGR_D_T042 := PKG_UTILS.LOG_NEW_DETAIL(PI_PROGR_H,
                                                'CUSTOMER ADDR',
                                                 'IMPORT --> T042PARTYADDR',
                                                  0,
                                                  NULL);
   --
    VL_PROGR_D_TA4410 := PKG_UTILS.LOG_NEW_DETAIL(PI_PROGR_H,
                                                'CUSTOMER NOTES',
                                                 'IMPORT --> TA4410NOTES',
                                                  0,
                                                  NULL);
 --
    VL_PROGR_D_T045 := PKG_UTILS.LOG_NEW_DETAIL(PI_PROGR_H,
                                                'CUSTOMER WEEK PLAN',
                                                 'IMPORT --> T045PARTYWEEK',
                                                  0,
                                                  NULL);
 --
    VL_PROGR_D_T046 := PKG_UTILS.LOG_NEW_DETAIL(PI_PROGR_H,
                                                'CUSTOMER BANK INFO',
                                                 'IMPORT --> T046PARTYBANK',
                                                  0,
                                                  NULL);
 --
    VL_PROGR_D_T047 := PKG_UTILS.LOG_NEW_DETAIL(PI_PROGR_H,
                                                'CUSTOMER CONTACTS',
                                                 'IMPORT --> T047PARTYCONTACT',
                                                  0,
                                                  NULL);
 --
    VL_PROGR_D_T049 := PKG_UTILS.LOG_NEW_DETAIL(PI_PROGR_H,
                                                'CUSTOMER PV CATEGORY',
                                                 'IMPORT --> T049PVCATEGORY',
                                                  0,
                                                  NULL);

    BEGIN
        --
        -- ----------------------------------------------------------
        -- Init arrays with FIELD_NAME=LENGTH and FIELDNAME=SM1_DEFAULT for all fields of table
        -- ----------------------------------------------------------
        VL_DES_T040.DELETE;
        P_INIT_SM1_FIELD_ARRAY ('T040PARTY',VL_DES_T040, VL_STATUS, VL_MESSAGE_H);
        execute immediate ( GL_INIT_REC) INTO REC_T040_INIT;


        VL_DES_T041.DELETE;
        P_INIT_SM1_FIELD_ARRAY ('T041PARTYDIV',VL_DES_T041,VL_STATUS, VL_MESSAGE_H);
        execute immediate ( GL_INIT_REC) INTO REC_T041_INIT;

        VL_DES_T042.DELETE;
        P_INIT_SM1_FIELD_ARRAY ('T042PARTYADDR',VL_DES_T042,VL_STATUS, VL_MESSAGE_H);
        execute immediate ( GL_INIT_REC) INTO REC_T042_INIT;

        VL_DES_TA4410.DELETE;
        P_INIT_SM1_FIELD_ARRAY ('TA4410NOTES',VL_DES_TA4410,VL_STATUS, VL_MESSAGE_H);
        execute immediate ( GL_INIT_REC) INTO REC_TA4410_INIT;

        VL_DES_T045.DELETE;
        P_INIT_SM1_FIELD_ARRAY ('T045PARTYWEEK',VL_DES_T045,VL_STATUS, VL_MESSAGE_H);
        execute immediate ( GL_INIT_REC) INTO REC_T045_INIT;

        VL_DES_T046.DELETE;
        P_INIT_SM1_FIELD_ARRAY ( 'T046PARTYBANK',VL_DES_T046,VL_STATUS, VL_MESSAGE_H);
        execute immediate ( GL_INIT_REC) INTO REC_T046_INIT;

        VL_DES_T047.DELETE;
        P_INIT_SM1_FIELD_ARRAY ('T047PARTYCONTACT',VL_DES_T047,VL_STATUS, VL_MESSAGE_H);
        execute immediate ( GL_INIT_REC) INTO REC_T047_INIT;

        VL_DES_T049.DELETE;
        P_INIT_SM1_FIELD_ARRAY ('T049PVCATEGORY', VL_DES_T049,VL_STATUS, VL_MESSAGE_H);
        execute immediate ( GL_INIT_REC) INTO REC_T049_INIT;


        IF (VL_STATUS <> 0 ) THEN
            VL_MESSAGE_D := GL_INIT_REC;
            RAISE EX_EXIT;
        END IF;
    EXCEPTION WHEN OTHERS THEN
        VL_MESSAGE_D := GL_INIT_REC;
        RAISE EX_EXIT;
    END;



    -- --------------------------------------------------------------
    -- Identifies Xin records to be loaded
    -- --------------------------------------------------------------
    BEGIN
        VL_MESSAGE_D := 'XIN_T040PARTY';
        UPDATE XIN_T040PARTY
        SET SM1_CODPROCESS = PI_PROGR_H,
            SM1_STATUS = 0,
            SM1_DTEPROCESS = XSYSDATE
            WHERE NVL(SM1_CODPROCESS, 0) = C_SM1_NULL_CODPROCESS;
          --  and CODPARTY IN ('IC20957', 'IC86244' ) ;
        VL_COUNT_XIN_T040 := SQL%ROWCOUNT;

  dbms_output.put_line('row count in xin_t040 ='  || VL_COUNT_XIN_T040 || 'C_SM1_NULL_CODPROCESS =' ||C_SM1_NULL_CODPROCESS);
        VL_MESSAGE_D := 'XIN_T041PARTYDIV';
        UPDATE XIN_T041PARTYDIV D
        SET D.SM1_CODPROCESS = PI_PROGR_H,
            D.SM1_STATUS = 0,
            D.SM1_DTEPROCESS = XSYSDATE
        WHERE D.CODPARTY IN (SELECT H.CODPARTY FROM XIN_T040PARTY H WHERE H.SM1_CODPROCESS = PI_PROGR_H 
    --AND H.SM1_DTECRE >= D.SM1_DTECRE 
    )
        AND NVL(SM1_CODPROCESS, 0) = C_SM1_NULL_CODPROCESS;
       VL_COUNT_XIN_T041 := SQL%ROWCOUNT;

        VL_MESSAGE_D := 'XIN_T042PARTYADDR';
        UPDATE XIN_T042PARTYADDR D
        SET D.SM1_CODPROCESS = PI_PROGR_H,
            D.SM1_STATUS = 0,
            D.SM1_DTEPROCESS = XSYSDATE
        WHERE D.CODPARTY IN (SELECT H.CODPARTY FROM XIN_T040PARTY H WHERE H.SM1_CODPROCESS = PI_PROGR_H 
    -- AND H.SM1_DTECRE >= D.SM1_DTECRE 
    )
        AND NVL(SM1_CODPROCESS, 0) = C_SM1_NULL_CODPROCESS;
        VL_COUNT_XIN_T042 := SQL%ROWCOUNT;

        VL_MESSAGE_D := 'XIN_TA4410NOTES_CUST';
        UPDATE XIN_TA4410NOTES_CUST D
        SET D.SM1_CODPROCESS = PI_PROGR_H,
            D.SM1_STATUS = 0,
            D.SM1_DTEPROCESS = XSYSDATE
        WHERE D.CODPARTY IN (SELECT H.CODPARTY FROM XIN_T040PARTY H WHERE H.SM1_CODPROCESS = PI_PROGR_H 
    -- AND H.SM1_DTECRE >= D.SM1_DTECRE 
    )
        AND NVL(SM1_CODPROCESS, 0) = C_SM1_NULL_CODPROCESS;
        VL_COUNT_XIN_TA4410 := SQL%ROWCOUNT;

        VL_MESSAGE_D := 'XIN_T045PARTYWEEK';
        UPDATE XIN_T045PARTYWEEK D
        SET D.SM1_CODPROCESS = PI_PROGR_H,
            D.SM1_STATUS = 0,
            D.SM1_DTEPROCESS = XSYSDATE
        WHERE (D.CODPARTY, D.CODDIV) IN (SELECT H.CODPARTY, H.CODDIV FROM XIN_T041PARTYDIV H WHERE H.SM1_CODPROCESS = PI_PROGR_H 
    --AND H.SM1_DTECRE >= D.SM1_DTECRE
    )
        AND NVL(SM1_CODPROCESS, 0) = C_SM1_NULL_CODPROCESS;
        VL_COUNT_XIN_T045 := SQL%ROWCOUNT;

        VL_MESSAGE_D := 'XIN_T046PARTYBANK';
        UPDATE XIN_T046PARTYBANK D
        SET D.SM1_CODPROCESS = PI_PROGR_H,
            D.SM1_STATUS = 0,
            D.SM1_DTEPROCESS = XSYSDATE
        WHERE (D.CODPARTY, D.CODDIV) IN (SELECT H.CODPARTY, H.CODDIV FROM XIN_T041PARTYDIV H WHERE H.SM1_CODPROCESS = PI_PROGR_H AND H.SM1_DTECRE >= D.SM1_DTECRE )
        AND NVL(SM1_CODPROCESS, 0) = C_SM1_NULL_CODPROCESS;
        VL_COUNT_XIN_T046 := SQL%ROWCOUNT;

        VL_MESSAGE_D := 'XIN_T047PARTYCONTACT';
        UPDATE XIN_T047PARTYCONTACT D
        SET D.SM1_CODPROCESS = PI_PROGR_H,
            D.SM1_STATUS = 0,
            D.SM1_DTEPROCESS = XSYSDATE
        WHERE (D.CODPARTY, D.CODDIV) IN (SELECT H.CODPARTY, H.CODDIV FROM XIN_T041PARTYDIV H WHERE H.SM1_CODPROCESS = PI_PROGR_H 
    --AND H.SM1_DTECRE >= D.SM1_DTECRE 
    )
        AND NVL(SM1_CODPROCESS, 0) = C_SM1_NULL_CODPROCESS;
        VL_COUNT_XIN_T047 := SQL%ROWCOUNT;

        VL_MESSAGE_D := 'XIN_T049PVCATEGORY';
        UPDATE XIN_T049PVCATEGORY D
        SET D.SM1_CODPROCESS = PI_PROGR_H,
            D.SM1_STATUS = 0,
            D.SM1_DTEPROCESS = XSYSDATE
        WHERE (D.CODPARTY, D.CODDIV) IN (SELECT H.CODPARTY, H.CODDIV FROM XIN_T041PARTYDIV H WHERE H.SM1_CODPROCESS = PI_PROGR_H 
    -- AND H.SM1_DTECRE >= D.SM1_DTECRE 
    )
        AND NVL(SM1_CODPROCESS, 0) = C_SM1_NULL_CODPROCESS;
        VL_COUNT_XIN_T049 := SQL%ROWCOUNT;

    COMMIT;
    EXCEPTION WHEN OTHERS THEN
      ROLLBACK;
      VL_MESSAGE_H := 'Error while Reading Staging area: '||VL_MESSAGE_D;
      RAISE EX_EXIT;
    END;
    -- --------------------------------------------------------------
    -- loop in main table T040PARTY
    -- --------------------------------------------------------------
    FOR RL_XIN_T040 IN CL_XIN_T040 LOOP

      -- pings to t035 every 1000 cicles--
      VL_STEP := VL_STEP + 1;
      IF ( MOD(VL_STEP, 1000) = 0 ) THEN
         PKG_UTILS.user_ping(PI_SESSION_ID);
      END IF;

      --
      VL_STATUS := 0;
      VL_RECORD_LOCKED := 0;
      --
      VL_MESSAGE_H :=   'Customer: '||RL_XIN_T040.CODPARTY;
      --
      BEGIN --- HEAD T040

       -- Data Format Check
        VL_MESSAGE_D := 'Format Conversion ';
        VL_CODDIV:= 'ALL';
        REC_T040.CODPARTY := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T040.CODPARTY,'CODPARTY', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.DESPARTY1 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T040.DESPARTY1,'DESPARTY1', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.DESPARTY2 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T040.DESPARTY2,'DESPARTY2', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.CODSIGN := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T040.CODSIGN,'CODSIGN', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.CODNIELSENAREA := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T040.CODNIELSENAREA,'CODNIELSENAREA', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.CODZONE := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T040.CODZONE,'CODZONE', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.CODCHANNEL := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T040.CODCHANNEL,'CODCHANNEL', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.CODFIS := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T040.CODFIS,'CODFIS', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.CODVAT := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T040.CODVAT,'CODVAT', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.CODVATINTRA := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T040.CODVATINTRA,'CODVATINTRA', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.CODCAT1 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T040.CODCAT1,'CODCAT1', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.CODCAT2 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T040.CODCAT2,'CODCAT2', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.CODCAT3 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T040.CODCAT3,'CODCAT3', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.CODCAT4 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T040.CODCAT4,'CODCAT4', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.CODCAT5 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T040.CODCAT5,'CODCAT5', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.CODNATGIU := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T040.CODNATGIU,'CODNATGIU', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.FLGCUSTINV := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T040.FLGCUSTINV,'FLGCUSTINV', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.CODVATCERT := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T040.CODVATCERT,'CODVATCERT', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.FLGCUSTDELIV := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T040.FLGCUSTDELIV,'FLGCUSTDELIV', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.CODMODINVOICE := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T040.CODMODINVOICE,'CODMODINVOICE', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.FLGCUSTSALE := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T040.FLGCUSTSALE,'FLGCUSTSALE', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.FLGCUSTCONC := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T040.FLGCUSTCONC,'FLGCUSTCONC', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.CODMODDELREP := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T040.CODMODDELREP,'CODMODDELREP', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.CODCUSTINV := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T040.CODCUSTINV,'CODCUSTINV', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.CODCUSTDELIV := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T040.CODCUSTDELIV,'CODCUSTDELIV', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.CODCUSTCONC := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T040.CODCUSTCONC,'CODCUSTCONC', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.CODVATMGMT := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T040.CODVATMGMT,'CODVATMGMT', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.CODCUR := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T040.CODCUR,'CODCUR', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.CODADJGROUP := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T040.CODADJGROUP,'CODADJGROUP', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.VALCREDIT := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T040.VALCREDIT,'VALCREDIT', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.DTEMODCREDIT := F_CHECK_FORMAT_D( VL_CODDIV,  RL_XIN_T040.DTEMODCREDIT,'DTEMODCREDIT', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.FLGANN := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T040.FLGANN,'FLGANN', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.CODCUSTXTEL := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T040.CODCUSTXTEL,'CODCUSTXTEL', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.DTEVALIDSTART := F_CHECK_FORMAT_D( VL_CODDIV,  RL_XIN_T040.DTEVALIDSTART,'DTEVALIDSTART', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        IF (REC_T040.DTEVALIDSTART IS NULL) THEN
            REC_T040.DTEVALIDSTART := C_SM1_FROM_DATE; -- Presence of dtevalid start is mandatory for customer navigator
        END IF;
        REC_T040.PRGDELIVERY := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T040.PRGDELIVERY,'PRGDELIVERY', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.FLGVIRTUAL := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T040.FLGVIRTUAL,'FLGVIRTUAL', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.RIFERIMENTO_INTERNO := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T040.RIFERIMENTO_INTERNO,'RIFERIMENTO_INTERNO', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.DTESTARTESENZIONE := F_CHECK_FORMAT_D( VL_CODDIV,  RL_XIN_T040.DTESTARTESENZIONE,'DTESTARTESENZIONE', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.DTEENDESENZIONE := F_CHECK_FORMAT_D( VL_CODDIV,  RL_XIN_T040.DTEENDESENZIONE,'DTEENDESENZIONE', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.NUMESENZIONE := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T040.NUMESENZIONE,'NUMESENZIONE', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.VALEXPOSED := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T040.VALEXPOSED,'VALEXPOSED', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.FLGDTEORD := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T040.FLGDTEORD,'FLGDTEORD', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.EMAIL := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T040.EMAIL,'EMAIL', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.CODCLUSTER := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T040.CODCLUSTER,'CODCLUSTER', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.CODCLUSTERCUST := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T040.CODCLUSTERCUST,'CODCLUSTERCUST', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.CODCLUSTERINT := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T040.CODCLUSTERINT,'CODCLUSTERINT', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.TOTSALESSURFACE := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T040.TOTSALESSURFACE,'TOTSALESSURFACE', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.TOTFOODSURFACE := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T040.TOTFOODSURFACE,'TOTFOODSURFACE', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.GLOBALINDEXPOT := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T040.GLOBALINDEXPOT,'GLOBALINDEXPOT', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.NUMCASSE := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T040.NUMCASSE,'NUMCASSE', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.NUMCASSEATTR := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T040.NUMCASSEATTR,'NUMCASSEATTR', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.NUMADDETTI := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T040.NUMADDETTI,'NUMADDETTI', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.CODNIELSENPARTY := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T040.CODNIELSENPARTY,'CODNIELSENPARTY', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.DESCEDEC := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T040.DESCEDEC,'DESCEDEC', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.QTYLINEARI := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T040.QTYLINEARI,'QTYLINEARI', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.TOTNONFOODSURFACE := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T040.TOTNONFOODSURFACE,'TOTNONFOODSURFACE', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.FLGDOCTOR := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T040.FLGDOCTOR,'FLGDOCTOR', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.FLGSTRUCTURE := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T040.FLGSTRUCTURE,'FLGSTRUCTURE', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.CODACTIVITYDOTT := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T040.CODACTIVITYDOTT,'CODACTIVITYDOTT', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.CODDEGREE := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T040.CODDEGREE,'CODDEGREE', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.CODIMP := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T040.CODIMP,'CODIMP', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.CODOCCUPATION := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T040.CODOCCUPATION,'CODOCCUPATION', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.CODSPECIALIZATION := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T040.CODSPECIALIZATION,'CODSPECIALIZATION', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.CODSPECIALIZATION2 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T040.CODSPECIALIZATION2,'CODSPECIALIZATION2', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.CODTYPESTRUCTURE := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T040.CODTYPESTRUCTURE,'CODTYPESTRUCTURE', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.FLGAPPOINTMENT := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T040.FLGAPPOINTMENT,'FLGAPPOINTMENT', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.CODGENDER := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T040.CODGENDER,'CODGENDER', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.CODSEASON := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T040.CODSEASON,'CODSEASON', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.CODSEASONSTART := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T040.CODSEASONSTART,'CODSEASONSTART', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.CODCLOSESTART := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T040.CODCLOSESTART,'CODCLOSESTART', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.CODCLOSEEND := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T040.CODCLOSEEND,'CODCLOSEEND', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.CODSEASONEND := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T040.CODSEASONEND,'CODSEASONEND', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.FLGPHARMACY := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T040.FLGPHARMACY,'FLGPHARMACY', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.CODMINISTERIAL := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T040.CODMINISTERIAL,'CODMINISTERIAL', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.CODTURNOVER := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T040.CODTURNOVER,'CODTURNOVER', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.NUMWINDOWS := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T040.NUMWINDOWS,'NUMWINDOWS', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.CODPRESCRIPTION := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T040.CODPRESCRIPTION,'CODPRESCRIPTION', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.CODCOLLEGE := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T040.CODCOLLEGE,'CODCOLLEGE', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.CODOPINIONLEAD := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T040.CODOPINIONLEAD,'CODOPINIONLEAD', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.CODPUBBLICATION := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T040.CODPUBBLICATION,'CODPUBBLICATION', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.CODPROFESSIONALMAGAZINE := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T040.CODPROFESSIONALMAGAZINE,'CODPROFESSIONALMAGAZINE', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.FLGCUSTPAYER := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T040.FLGCUSTPAYER,'FLGCUSTPAYER', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.FLGCUSTBILLTO := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T040.FLGCUSTBILLTO,'FLGCUSTBILLTO', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.CODCUSTPAYER := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T040.CODCUSTPAYER,'CODCUSTPAYER', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.FLGPERSON := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T040.FLGPERSON,'FLGPERSON', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.CODTITLE := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T040.CODTITLE,'CODTITLE', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.DESNOTE := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T040.DESNOTE,'DESNOTE', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.DTEBIRTHDAY := F_CHECK_FORMAT_D( VL_CODDIV, RL_XIN_T040.DTEBIRTHDAY,'DTEBIRTHDAY', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);

        REC_T040.FLGCUSTWHS := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T040.FLGCUSTWHS,'FLGCUSTWHS', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.FLGCUSTVAN := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T040.FLGCUSTVAN,'FLGCUSTVAN', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        --- New Customised fields for DAL
        REC_T040.Z_FLGEXTERNAL := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T040.Z_FLGEXTERNAL,'Z_FLGEXTERNAL', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);

        --- Technical fields
        REC_T040.DTECRE     := XSYSDATE;
        REC_T040.CODUSRMOD  := C_SYSUSR;
        REC_T040.CODUSRMODREAL  := C_SYSUSR;
        REC_T040.CODUSRCREREAL  := C_SYSUSR;
        REC_T040.DTEMOD     := XSYSDATE;
        -- lock fields
        REC_T040.CODUSRLCK     := C_SYSUSR;
        REC_T040.IDSESSIONLCK  := PI_SESSION_ID;
        REC_T040.DTELCK        := XSYSDATE;
        -- DocumentKey
        REC_T040.DOCUMENTKEY   := PKG_UTILS.documentkey_for_t040(REC_T040.CODPARTY);
        IF (VL_STATUS <> 0 ) THEN

         VL_MESSAGE_H := SUBSTR(VL_MESSAGE_H||' '||VL_MESSAGE_D||' '||dbms_utility.format_error_backtrace() || ' ' || SQLERRM,1,4000);

             PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                           VL_PROGR_D_T040,
                                           SQLCODE,
                                           VL_MESSAGE_H);
        END IF;

        IF (VL_STATUS = 0 ) THEN
          -- when status <> 0 some fields have incorrect format. Log t800 has been already wrote by F_CHECK function
          -- Update article if already exists

           VL_MESSAGE_D := 'Update T040Party ';
           UPDATE T040PARTY
           SET
               -- when the field si set to updated by host it means that the value should be read from XIN
               -- otherwise it means that the field is managed by sm1 and it maintains its original value
                DESPARTY1 = CASE VL_DES_T040('DESPARTY1.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T040.DESPARTY1 ELSE DESPARTY1 END,
             /*   DESPARTY2 = CASE VL_DES_T040('DESPARTY2.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T040.DESPARTY2 ELSE DESPARTY2 END,
                CODSIGN = CASE VL_DES_T040('CODSIGN.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T040.CODSIGN ELSE CODSIGN END,
                CODNIELSENAREA = CASE VL_DES_T040('CODNIELSENAREA.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T040.CODNIELSENAREA ELSE CODNIELSENAREA END,
                CODZONE = CASE VL_DES_T040('CODZONE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T040.CODZONE ELSE CODZONE END,
                CODCHANNEL = CASE VL_DES_T040('CODCHANNEL.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T040.CODCHANNEL ELSE CODCHANNEL END,
                CODFIS = CASE VL_DES_T040('CODFIS.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T040.CODFIS ELSE CODFIS END, */
                CODVAT = CASE VL_DES_T040('CODVAT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T040.CODVAT ELSE CODVAT END,
               /* CODVATINTRA = CASE VL_DES_T040('CODVATINTRA.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T040.CODVATINTRA ELSE CODVATINTRA END,
                CODCAT1 = CASE VL_DES_T040('CODCAT1.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T040.CODCAT1 ELSE CODCAT1 END,
                CODCAT2 = CASE VL_DES_T040('CODCAT2.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T040.CODCAT2 ELSE CODCAT2 END,
                CODCAT3 = CASE VL_DES_T040('CODCAT3.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T040.CODCAT3 ELSE CODCAT3 END,
                CODCAT4 = CASE VL_DES_T040('CODCAT4.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T040.CODCAT4 ELSE CODCAT4 END,
                CODCAT5 = CASE VL_DES_T040('CODCAT5.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T040.CODCAT5 ELSE CODCAT5 END,
                CODNATGIU = CASE VL_DES_T040('CODNATGIU.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T040.CODNATGIU ELSE CODNATGIU END,
                FLGCUSTINV = CASE VL_DES_T040('FLGCUSTINV.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T040.FLGCUSTINV ELSE FLGCUSTINV END,
                CODVATCERT = CASE VL_DES_T040('CODVATCERT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T040.CODVATCERT ELSE CODVATCERT END, */
                FLGCUSTDELIV = CASE VL_DES_T040('FLGCUSTDELIV.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T040.FLGCUSTDELIV ELSE FLGCUSTDELIV END,
               -- CODMODINVOICE = CASE VL_DES_T040('CODMODINVOICE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T040.CODMODINVOICE ELSE CODMODINVOICE END,
                FLGCUSTSALE = CASE VL_DES_T040('FLGCUSTSALE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T040.FLGCUSTSALE ELSE FLGCUSTSALE END,
              /*  FLGCUSTCONC = CASE VL_DES_T040('FLGCUSTCONC.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T040.FLGCUSTCONC ELSE FLGCUSTCONC END,
                CODMODDELREP = CASE VL_DES_T040('CODMODDELREP.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T040.CODMODDELREP ELSE CODMODDELREP END,*/
                CODCUSTINV = CASE VL_DES_T040('CODCUSTINV.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T040.CODCUSTINV ELSE CODCUSTINV END,
               /* CODCUSTDELIV = CASE VL_DES_T040('CODCUSTDELIV.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T040.CODCUSTDELIV ELSE CODCUSTDELIV END,
                CODCUSTCONC = CASE VL_DES_T040('CODCUSTCONC.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T040.CODCUSTCONC ELSE CODCUSTCONC END,
                CODVATMGMT = CASE VL_DES_T040('CODVATMGMT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T040.CODVATMGMT ELSE CODVATMGMT END, */
                CODCUR = CASE VL_DES_T040('CODCUR.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T040.CODCUR ELSE CODCUR END,
               /* CODADJGROUP = CASE VL_DES_T040('CODADJGROUP.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T040.CODADJGROUP ELSE CODADJGROUP END,
                VALCREDIT = CASE VL_DES_T040('VALCREDIT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T040.VALCREDIT ELSE VALCREDIT END,
                DTEMODCREDIT = CASE VL_DES_T040('DTEMODCREDIT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T040.DTEMODCREDIT ELSE DTEMODCREDIT END,
                FLGANN = CASE VL_DES_T040('FLGANN.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T040.FLGANN ELSE FLGANN END,
                CODCUSTXTEL = CASE VL_DES_T040('CODCUSTXTEL.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T040.CODCUSTXTEL ELSE CODCUSTXTEL END,
                DTEVALIDSTART = CASE VL_DES_T040('DTEVALIDSTART.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T040.DTEVALIDSTART ELSE DTEVALIDSTART END,
                PRGDELIVERY = CASE VL_DES_T040('PRGDELIVERY.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T040.PRGDELIVERY ELSE PRGDELIVERY END,
                FLGVIRTUAL = CASE VL_DES_T040('FLGVIRTUAL.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T040.FLGVIRTUAL ELSE FLGVIRTUAL END,
                RIFERIMENTO_INTERNO = CASE VL_DES_T040('RIFERIMENTO_INTERNO.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T040.RIFERIMENTO_INTERNO ELSE RIFERIMENTO_INTERNO END,
                DTESTARTESENZIONE = CASE VL_DES_T040('DTESTARTESENZIONE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T040.DTESTARTESENZIONE ELSE DTESTARTESENZIONE END,
                DTEENDESENZIONE = CASE VL_DES_T040('DTEENDESENZIONE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T040.DTEENDESENZIONE ELSE DTEENDESENZIONE END,
                NUMESENZIONE = CASE VL_DES_T040('NUMESENZIONE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T040.NUMESENZIONE ELSE NUMESENZIONE END,
                VALEXPOSED = CASE VL_DES_T040('VALEXPOSED.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T040.VALEXPOSED ELSE VALEXPOSED END,
                FLGDTEORD = CASE VL_DES_T040('FLGDTEORD.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T040.FLGDTEORD ELSE FLGDTEORD END,
                EMAIL = CASE VL_DES_T040('EMAIL.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T040.EMAIL ELSE EMAIL END,
                CODCLUSTER = CASE VL_DES_T040('CODCLUSTER.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T040.CODCLUSTER ELSE CODCLUSTER END,
                CODCLUSTERCUST = CASE VL_DES_T040('CODCLUSTERCUST.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T040.CODCLUSTERCUST ELSE CODCLUSTERCUST END,
                CODCLUSTERINT = CASE VL_DES_T040('CODCLUSTERINT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T040.CODCLUSTERINT ELSE CODCLUSTERINT END,
                TOTSALESSURFACE = CASE VL_DES_T040('TOTSALESSURFACE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T040.TOTSALESSURFACE ELSE TOTSALESSURFACE END,
                TOTFOODSURFACE = CASE VL_DES_T040('TOTFOODSURFACE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T040.TOTFOODSURFACE ELSE TOTFOODSURFACE END,
                GLOBALINDEXPOT = CASE VL_DES_T040('GLOBALINDEXPOT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T040.GLOBALINDEXPOT ELSE GLOBALINDEXPOT END,
                NUMCASSE = CASE VL_DES_T040('NUMCASSE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T040.NUMCASSE ELSE NUMCASSE END,
                NUMCASSEATTR = CASE VL_DES_T040('NUMCASSEATTR.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T040.NUMCASSEATTR ELSE NUMCASSEATTR END,
                NUMADDETTI = CASE VL_DES_T040('NUMADDETTI.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T040.NUMADDETTI ELSE NUMADDETTI END,
                CODNIELSENPARTY = CASE VL_DES_T040('CODNIELSENPARTY.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T040.CODNIELSENPARTY ELSE CODNIELSENPARTY END,
                DESCEDEC = CASE VL_DES_T040('DESCEDEC.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T040.DESCEDEC ELSE DESCEDEC END,
                QTYLINEARI = CASE VL_DES_T040('QTYLINEARI.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T040.QTYLINEARI ELSE QTYLINEARI END,
                TOTNONFOODSURFACE = CASE VL_DES_T040('TOTNONFOODSURFACE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T040.TOTNONFOODSURFACE ELSE TOTNONFOODSURFACE END,
                FLGDOCTOR = CASE VL_DES_T040('FLGDOCTOR.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T040.FLGDOCTOR ELSE FLGDOCTOR END,
                FLGSTRUCTURE = CASE VL_DES_T040('FLGSTRUCTURE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T040.FLGSTRUCTURE ELSE FLGSTRUCTURE END,
                CODACTIVITYDOTT = CASE VL_DES_T040('CODACTIVITYDOTT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T040.CODACTIVITYDOTT ELSE CODACTIVITYDOTT END,
                CODDEGREE = CASE VL_DES_T040('CODDEGREE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T040.CODDEGREE ELSE CODDEGREE END,
                CODIMP = CASE VL_DES_T040('CODIMP.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T040.CODIMP ELSE CODIMP END,
                CODOCCUPATION = CASE VL_DES_T040('CODOCCUPATION.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T040.CODOCCUPATION ELSE CODOCCUPATION END,
                CODSPECIALIZATION = CASE VL_DES_T040('CODSPECIALIZATION.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T040.CODSPECIALIZATION ELSE CODSPECIALIZATION END,
                CODSPECIALIZATION2 = CASE VL_DES_T040('CODSPECIALIZATION2.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T040.CODSPECIALIZATION2 ELSE CODSPECIALIZATION2 END,
                CODTYPESTRUCTURE = CASE VL_DES_T040('CODTYPESTRUCTURE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T040.CODTYPESTRUCTURE ELSE CODTYPESTRUCTURE END,
                FLGAPPOINTMENT = CASE VL_DES_T040('FLGAPPOINTMENT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T040.FLGAPPOINTMENT ELSE FLGAPPOINTMENT END,
                CODGENDER = CASE VL_DES_T040('CODGENDER.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T040.CODGENDER ELSE CODGENDER END,
                CODSEASON = CASE VL_DES_T040('CODSEASON.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T040.CODSEASON ELSE CODSEASON END,
                CODSEASONSTART = CASE VL_DES_T040('CODSEASONSTART.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T040.CODSEASONSTART ELSE CODSEASONSTART END,
                CODCLOSESTART = CASE VL_DES_T040('CODCLOSESTART.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T040.CODCLOSESTART ELSE CODCLOSESTART END,
                CODCLOSEEND = CASE VL_DES_T040('CODCLOSEEND.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T040.CODCLOSEEND ELSE CODCLOSEEND END,
                CODSEASONEND = CASE VL_DES_T040('CODSEASONEND.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T040.CODSEASONEND ELSE CODSEASONEND END,
                FLGPHARMACY = CASE VL_DES_T040('FLGPHARMACY.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T040.FLGPHARMACY ELSE FLGPHARMACY END,
                CODMINISTERIAL = CASE VL_DES_T040('CODMINISTERIAL.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T040.CODMINISTERIAL ELSE CODMINISTERIAL END,
                CODTURNOVER = CASE VL_DES_T040('CODTURNOVER.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T040.CODTURNOVER ELSE CODTURNOVER END,
                NUMWINDOWS = CASE VL_DES_T040('NUMWINDOWS.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T040.NUMWINDOWS ELSE NUMWINDOWS END,
                CODPRESCRIPTION = CASE VL_DES_T040('CODPRESCRIPTION.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T040.CODPRESCRIPTION ELSE CODPRESCRIPTION END,
                CODCOLLEGE = CASE VL_DES_T040('CODCOLLEGE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T040.CODCOLLEGE ELSE CODCOLLEGE END,
                CODOPINIONLEAD = CASE VL_DES_T040('CODOPINIONLEAD.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T040.CODOPINIONLEAD ELSE CODOPINIONLEAD END,
                CODPUBBLICATION = CASE VL_DES_T040('CODPUBBLICATION.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T040.CODPUBBLICATION ELSE CODPUBBLICATION END,
                CODPROFESSIONALMAGAZINE = CASE VL_DES_T040('CODPROFESSIONALMAGAZINE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T040.CODPROFESSIONALMAGAZINE ELSE CODPROFESSIONALMAGAZINE END,
                FLGCUSTPAYER = CASE VL_DES_T040('FLGCUSTPAYER.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T040.FLGCUSTPAYER ELSE FLGCUSTPAYER END,
                FLGCUSTBILLTO = CASE VL_DES_T040('FLGCUSTBILLTO.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T040.FLGCUSTBILLTO ELSE FLGCUSTBILLTO END,
                CODCUSTPAYER = CASE VL_DES_T040('CODCUSTPAYER.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T040.CODCUSTPAYER ELSE CODCUSTPAYER END,
                FLGPERSON = CASE VL_DES_T040('FLGPERSON.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T040.FLGPERSON ELSE FLGPERSON END,
                CODTITLE = CASE VL_DES_T040('CODTITLE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T040.CODTITLE ELSE CODTITLE END,
                DESNOTE = CASE VL_DES_T040('DESNOTE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T040.DESNOTE ELSE DESNOTE END,
                DTEBIRTHDAY = CASE VL_DES_T040('DTEBIRTHDAY.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T040.DTEBIRTHDAY ELSE DTEBIRTHDAY END,

                FLGCUSTWHS = CASE VL_DES_T040('FLGCUSTWHS.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T040.FLGCUSTWHS ELSE FLGCUSTWHS END,
                FLGCUSTVAN = CASE VL_DES_T040('FLGCUSTVAN.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T040.FLGCUSTVAN ELSE FLGCUSTVAN END,
          */
                --- Technical fields
                CODUSRMOD = REC_T040.CODUSRMOD,
                DTEMOD    = REC_T040.DTEMOD,
                -- lock fields
                CODUSRLCK    = REC_T040.CODUSRLCK,
                IDSESSIONLCK = REC_T040.IDSESSIONLCK,
                DTELCK       = REC_T040.DTELCK

         WHERE CODPARTY = REC_T040.CODPARTY
        /* WHERE TRIM(CODPARTY) IN (SELECT TRIM(CODPARTY) FROM
         T041PARTYDIV WHERE TRIM(CODCATDIV1)= TRIM(REC_T040.CODPARTY) AND ROWNUM=1)
         AND LENGTH(TRIM(DESPARTY1))<=2
         and not exists ( select null from T035LOGGEDUSERS T035 where T035.IDSESSION = NVL(IDSESSIONLCK, '@') AND T035.LASTCHECK > TRUNC(XSYSDATE)-1 )*/
     -- above line commented by vikas
     ;

        -- no data found, it could be
        --   a. record does not exists
        --   b. record is locked by another sm1 user
        -- commented by Fowza for DAL-Sage Integration .
        /*
        IF SQL%ROWCOUNT = 0 THEN

          VL_COUNT := 0;
          SELECT COUNT(*) INTO VL_COUNT FROM T040PARTY
           WHERE CODPARTY = REC_T040.CODPARTY;

          IF ( VL_COUNT = 0 ) THEN
              VL_MESSAGE_D := 'Insert T040Party ';
              -- Record does not exists, we insert it
              INSERT INTO T040PARTY VALUES REC_T040;
           ELSE
            VL_STATUS := -1;
            VL_RECORD_LOCKED := -1;
            PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                           VL_PROGR_D_T040,
                                           SQLCODE,
                                           'Record is locked; import has failed :'||VL_MESSAGE_H);

          END IF; -- Record has been inserted
        END IF; -- Record has been updated
        */

        END IF; -- VL_STATUS = 0

        EXCEPTION WHEN OTHERS THEN
             VL_STATUS := -1;
             VL_MESSAGE_H := SUBSTR(VL_MESSAGE_H||' '||VL_MESSAGE_D||' '||dbms_utility.format_error_backtrace() || ' ' || SQLERRM,1,4000);

             PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                           VL_PROGR_D_T040,
                                           SQLCODE,
                                           VL_MESSAGE_H);
        END; -- HEAD T040

        -- -----------------------------------
        -- T041PARTYDIV DIVISION INFO
        -- -----------------------------------
        BEGIN
        --
        IF ( VL_STATUS = 0  ) THEN
              -- Division info T041PARTYDIV

              FOR RL_XIN_T041 IN CL_XIN_T041(RL_XIN_T040.CODPARTY, RL_XIN_T040.SM1_DTECRE) LOOP

                VL_MESSAGE_H := 'Customer: '|| RL_XIN_T041.CODPARTY || '/' ||
                                'Division: '|| RL_XIN_T041.CODDIV;

                VL_MESSAGE_D := 'Format Conversion ';
                VL_CODDIV:= RL_XIN_T041.CODDIV;
                REC_T041.CODPARTY := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T041.CODPARTY,'CODPARTY', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.CODDIV := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T041.CODDIV,'CODDIV', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.CODUSR1 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T041.CODUSR1,'CODUSR1', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.CODPAYMOD := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T041.CODPAYMOD,'CODPAYMOD', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.CODPAYTRM := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T041.CODPAYTRM,'CODPAYTRM', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.CODABC := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T041.CODABC,'CODABC', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.CODASS := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T041.CODASS,'CODASS', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.FLGALTART := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T041.FLGALTART,'FLGALTART', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.CODSTATPARTY := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T041.CODSTATPARTY,'CODSTATPARTY', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.CODSHIPPER := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T041.CODSHIPPER,'CODSHIPPER', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.FLGORDEREXTRACT := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T041.FLGORDEREXTRACT,'FLGORDEREXTRACT', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.CODBLCCAUSE := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T041.CODBLCCAUSE,'CODBLCCAUSE', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.FLGLINEEXTRACT := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T041.FLGLINEEXTRACT,'FLGLINEEXTRACT', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.CODSTATUS := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T041.CODSTATUS,'CODSTATUS', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.MINORDVAL := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T041.MINORDVAL,'MINORDVAL', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.MAXORDVAL := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T041.MAXORDVAL,'MAXORDVAL', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.VALSCO1 := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T041.VALSCO1,'VALSCO1', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.VALSCO2 := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T041.VALSCO2,'VALSCO2', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.VALSCO3 := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T041.VALSCO3,'VALSCO3', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.VALSCO4 := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T041.VALSCO4,'VALSCO4', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.VALSCO5 := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T041.VALSCO5,'VALSCO5', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.FLGACCBKORD := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T041.FLGACCBKORD,'FLGACCBKORD', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.CODWHS := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T041.CODWHS,'CODWHS', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.NUMTRASPDAYS := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T041.NUMTRASPDAYS,'NUMTRASPDAYS', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.FLGACPSALPRICE := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T041.FLGACPSALPRICE,'FLGACPSALPRICE', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.CODCATDIV1 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T041.CODCATDIV1,'CODCATDIV1', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.CODCATDIV2 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T041.CODCATDIV2,'CODCATDIV2', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.CODCATDIV3 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T041.CODCATDIV3,'CODCATDIV3', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.CODCATDIV4 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T041.CODCATDIV4,'CODCATDIV4', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.CODCATDIV5 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T041.CODCATDIV5,'CODCATDIV5', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.CODUSR3 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T041.CODUSR3,'CODUSR3', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.CODUSR2 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T041.CODUSR2,'CODUSR2', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.CODUSR4 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T041.CODUSR4,'CODUSR4', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.CODUSR6 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T041.CODUSR6,'CODUSR6', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.CODUSR5 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T041.CODUSR5,'CODUSR5', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.CODDISCLIS1 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T041.CODDISCLIS1,'CODDISCLIS1', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.CODDISCLIS2 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T041.CODDISCLIS2,'CODDISCLIS2', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.CODDISCLIS3 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T041.CODDISCLIS3,'CODDISCLIS3', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.CODDISCLIS4 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T041.CODDISCLIS4,'CODDISCLIS4', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.CODDISCLIS5 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T041.CODDISCLIS5,'CODDISCLIS5', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.CODMODSHIP := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T041.CODMODSHIP,'CODMODSHIP', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.CODMODDEL := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T041.CODMODDEL,'CODMODDEL', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.CODENDUSERLIS := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T041.CODENDUSERLIS,'CODENDUSERLIS', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.CODDISCLISMAX := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T041.CODDISCLISMAX,'CODDISCLISMAX', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.CODDISCLISBLK := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T041.CODDISCLISBLK,'CODDISCLISBLK', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.CODLIST := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T041.CODLIST,'CODLIST', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.FLGANN := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T041.FLGANN,'FLGANN', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.QTYORDMIN := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T041.QTYORDMIN,'QTYORDMIN', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.QTYORDMAX := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T041.QTYORDMAX,'QTYORDMAX', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.UMORDQTY := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T041.UMORDQTY,'UMORDQTY', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.CODSUBSTPARTY := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T041.CODSUBSTPARTY,'CODSUBSTPARTY', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.DTEEND := F_CHECK_FORMAT_D( VL_CODDIV,  RL_XIN_T041.DTEEND,'DTEEND', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.CODSUPPLIER := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T041.CODSUPPLIER,'CODSUPPLIER', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.CODUSRCORR := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T041.CODUSRCORR,'CODUSRCORR', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.CODSUPPLIER1 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T041.CODSUPPLIER1,'CODSUPPLIER1', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.CODSUPPLIER2 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T041.CODSUPPLIER2,'CODSUPPLIER2', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.COD_ATTR_PROIEZIONI := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T041.COD_ATTR_PROIEZIONI,'COD_ATTR_PROIEZIONI', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.CODTYPCONTE := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T041.CODTYPCONTE,'CODTYPCONTE', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.CODTYPEVASION := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T041.CODTYPEVASION,'CODTYPEVASION', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.FLAG_BLOCK_LIQ := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T041.FLAG_BLOCK_LIQ,'FLAG_BLOCK_LIQ', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.EC_AGENTE := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T041.EC_AGENTE,'EC_AGENTE', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.CODSTOREFORMAT := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T041.CODSTOREFORMAT,'CODSTOREFORMAT', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.CODCUSTDELIV := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T041.CODCUSTDELIV,'CODCUSTDELIV', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.CODCUSTDELIV2 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T041.CODCUSTDELIV2,'CODCUSTDELIV2', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.FLGASSOVERIFY := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T041.FLGASSOVERIFY,'FLGASSOVERIFY', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.FLGPROMOVERIFY := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T041.FLGPROMOVERIFY,'FLGPROMOVERIFY', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.CODPANEL := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T041.CODPANEL,'CODPANEL', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.INDEXPOT := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T041.INDEXPOT,'INDEXPOT', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.CODDISCLIS6 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T041.CODDISCLIS6,'CODDISCLIS6', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.CODDISCLIS7 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T041.CODDISCLIS7,'CODDISCLIS7', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.FLGAUTH := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T041.FLGAUTH,'FLGAUTH', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.DTESUBSTPARTY := F_CHECK_FORMAT_D( VL_CODDIV,  RL_XIN_T041.DTESUBSTPARTY,'DTESUBSTPARTY', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.CODVISITFREQUENCE := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T041.CODVISITFREQUENCE,'CODVISITFREQUENCE', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.CODCLUSTER := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T041.CODCLUSTER,'CODCLUSTER', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.CODCLUSTERCUST := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T041.CODCLUSTERCUST,'CODCLUSTERCUST', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.CODCLUSTERINT := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T041.CODCLUSTERINT,'CODCLUSTERINT', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.FLGENCASHMENT := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T041.FLGENCASHMENT,'FLGENCASHMENT', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.IDEVALASSORTMENT      := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T041.IDEVALASSORTMENT,'IDEVALASSORTMENT', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.IDEVALPRICELIST       := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T041.IDEVALPRICELIST,'IDEVALPRICELIST', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.IDEVALDISCOUNTLIST    := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T041.IDEVALDISCOUNTLIST,'IDEVALDISCOUNTLIST', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.DTEEVALASSO           := F_CHECK_FORMAT_D( VL_CODDIV,  RL_XIN_T041.DTEEVALASSO,'DTEEVALASSO', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.CODUSR1ERP            := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T041.CODUSR1ERP,'CODUSR1ERP', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);

                REC_T041.FLG_DSD_PRINT_PRICES  := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T041.FLG_DSD_PRINT_PRICES ,'FLG_DSD_PRINT_PRICES', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.FLG_DSD_BLK_PAYTRM    := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T041.FLG_DSD_BLK_PAYTRM,'FLG_DSD_BLK_PAYTRM', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.DSD_CODBLK_VALCREDIT  := F_CHECK_FORMAT_S( VL_CODDIV,  RL_XIN_T041.DSD_CODBLK_VALCREDIT,'DSD_CODBLK_VALCREDIT', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.FLG_DSD_PAPARLESS     := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T041.FLG_DSD_PAPARLESS,'FLG_DSD_PAPARLESS', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.CODAVAILABILITY       := F_CHECK_FORMAT_S( VL_CODDIV,  RL_XIN_T041.CODAVAILABILITY,'CODAVAILABILITY', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);

                REC_T041.CODPAYMOD2            := F_CHECK_FORMAT_S( VL_CODDIV,  RL_XIN_T041.CODPAYMOD2,'CODPAYMOD2', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.CODPAYTRM2            := F_CHECK_FORMAT_S( VL_CODDIV,  RL_XIN_T041.CODPAYTRM2,'CODPAYTRM2', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);

                 IF (VL_STATUS <> 0 ) THEN
                   VL_MESSAGE_H := SUBSTR(VL_MESSAGE_H||' '||VL_MESSAGE_D||' '||dbms_utility.format_error_backtrace() || ' ' || SQLERRM,1,4000);
                   PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                           VL_PROGR_D_T041,
                                           SQLCODE,
                                           VL_MESSAGE_H);
                 END IF;

                IF (VL_STATUS = 0 ) THEN
                --
                VL_MESSAGE_D := 'Update T041 ';
                UPDATE T041PARTYDIV
                   SET
                     -- CODUSR1 = CASE VL_DES_T041('CODUSR1.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.CODUSR1 ELSE CODUSR1 END,
            CODDIV = CASE VL_DES_T041('CODDIV.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.CODDIV ELSE CODDIV END, -- VIKAS
                      CODPAYMOD = CASE VL_DES_T041('CODPAYMOD.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.CODPAYMOD ELSE CODPAYMOD END,

                      CODPAYTRM = CASE VL_DES_T041('CODPAYTRM.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.CODPAYTRM ELSE CODPAYTRM END
                      /*CODABC = CASE VL_DES_T041('CODABC.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.CODABC ELSE CODABC END,
                      CODASS = CASE VL_DES_T041('CODASS.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.CODASS ELSE CODASS END,
                      FLGALTART = CASE VL_DES_T041('FLGALTART.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.FLGALTART ELSE FLGALTART END,
                      CODSTATPARTY = CASE VL_DES_T041('CODSTATPARTY.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.CODSTATPARTY ELSE CODSTATPARTY END,
                      CODSHIPPER = CASE VL_DES_T041('CODSHIPPER.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.CODSHIPPER ELSE CODSHIPPER END,
                      FLGORDEREXTRACT = CASE VL_DES_T041('FLGORDEREXTRACT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.FLGORDEREXTRACT ELSE FLGORDEREXTRACT END,
                      CODBLCCAUSE = CASE VL_DES_T041('CODBLCCAUSE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.CODBLCCAUSE ELSE CODBLCCAUSE END,
                      FLGLINEEXTRACT = CASE VL_DES_T041('FLGLINEEXTRACT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.FLGLINEEXTRACT ELSE FLGLINEEXTRACT END,
                      CODSTATUS = CASE VL_DES_T041('CODSTATUS.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.CODSTATUS ELSE CODSTATUS END,
                      MINORDVAL = CASE VL_DES_T041('MINORDVAL.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.MINORDVAL ELSE MINORDVAL END,
                      MAXORDVAL = CASE VL_DES_T041('MAXORDVAL.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.MAXORDVAL ELSE MAXORDVAL END,
                      VALSCO1 = CASE VL_DES_T041('VALSCO1.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.VALSCO1 ELSE VALSCO1 END,
                      VALSCO2 = CASE VL_DES_T041('VALSCO2.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.VALSCO2 ELSE VALSCO2 END,
                      VALSCO3 = CASE VL_DES_T041('VALSCO3.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.VALSCO3 ELSE VALSCO3 END,
                      VALSCO4 = CASE VL_DES_T041('VALSCO4.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.VALSCO4 ELSE VALSCO4 END,
                      VALSCO5 = CASE VL_DES_T041('VALSCO5.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.VALSCO5 ELSE VALSCO5 END,
                      FLGACCBKORD = CASE VL_DES_T041('FLGACCBKORD.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.FLGACCBKORD ELSE FLGACCBKORD END,
                      CODWHS = CASE VL_DES_T041('CODWHS.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.CODWHS ELSE CODWHS END,
                      NUMTRASPDAYS = CASE VL_DES_T041('NUMTRASPDAYS.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.NUMTRASPDAYS ELSE NUMTRASPDAYS END,
                      FLGACPSALPRICE = CASE VL_DES_T041('FLGACPSALPRICE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.FLGACPSALPRICE ELSE FLGACPSALPRICE END,
                      CODCATDIV1 = CASE VL_DES_T041('CODCATDIV1.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.CODCATDIV1 ELSE CODCATDIV1 END,
                      CODCATDIV2 = CASE VL_DES_T041('CODCATDIV2.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.CODCATDIV2 ELSE CODCATDIV2 END,
                      CODCATDIV3 = CASE VL_DES_T041('CODCATDIV3.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.CODCATDIV3 ELSE CODCATDIV3 END,
                      CODCATDIV4 = CASE VL_DES_T041('CODCATDIV4.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.CODCATDIV4 ELSE CODCATDIV4 END,
                      CODCATDIV5 = CASE VL_DES_T041('CODCATDIV5.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.CODCATDIV5 ELSE CODCATDIV5 END,
                      CODUSR3 = CASE VL_DES_T041('CODUSR3.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.CODUSR3 ELSE CODUSR3 END,
                      CODUSR2 = CASE VL_DES_T041('CODUSR2.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.CODUSR2 ELSE CODUSR2 END,
                      CODUSR4 = CASE VL_DES_T041('CODUSR4.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.CODUSR4 ELSE CODUSR4 END,
                      CODUSR6 = CASE VL_DES_T041('CODUSR6.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.CODUSR6 ELSE CODUSR6 END,
                      CODUSR5 = CASE VL_DES_T041('CODUSR5.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.CODUSR5 ELSE CODUSR5 END,
                      CODDISCLIS1 = CASE VL_DES_T041('CODDISCLIS1.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.CODDISCLIS1 ELSE CODDISCLIS1 END,
                      CODDISCLIS2 = CASE VL_DES_T041('CODDISCLIS2.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.CODDISCLIS2 ELSE CODDISCLIS2 END,
                      CODDISCLIS3 = CASE VL_DES_T041('CODDISCLIS3.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.CODDISCLIS3 ELSE CODDISCLIS3 END,
                      CODDISCLIS4 = CASE VL_DES_T041('CODDISCLIS4.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.CODDISCLIS4 ELSE CODDISCLIS4 END,
                      CODDISCLIS5 = CASE VL_DES_T041('CODDISCLIS5.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.CODDISCLIS5 ELSE CODDISCLIS5 END,
                      CODMODSHIP = CASE VL_DES_T041('CODMODSHIP.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.CODMODSHIP ELSE CODMODSHIP END,
                      CODMODDEL = CASE VL_DES_T041('CODMODDEL.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.CODMODDEL ELSE CODMODDEL END,
                      CODENDUSERLIS = CASE VL_DES_T041('CODENDUSERLIS.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.CODENDUSERLIS ELSE CODENDUSERLIS END,
                      CODDISCLISMAX = CASE VL_DES_T041('CODDISCLISMAX.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.CODDISCLISMAX ELSE CODDISCLISMAX END,
                      CODDISCLISBLK = CASE VL_DES_T041('CODDISCLISBLK.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.CODDISCLISBLK ELSE CODDISCLISBLK END,
                      CODLIST = CASE VL_DES_T041('CODLIST.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.CODLIST ELSE CODLIST END,
                      FLGANN = CASE VL_DES_T041('FLGANN.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.FLGANN ELSE FLGANN END,
                      QTYORDMIN = CASE VL_DES_T041('QTYORDMIN.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.QTYORDMIN ELSE QTYORDMIN END,
                      QTYORDMAX = CASE VL_DES_T041('QTYORDMAX.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.QTYORDMAX ELSE QTYORDMAX END,
                      UMORDQTY = CASE VL_DES_T041('UMORDQTY.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.UMORDQTY ELSE UMORDQTY END,
                      CODSUBSTPARTY = CASE VL_DES_T041('CODSUBSTPARTY.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.CODSUBSTPARTY ELSE CODSUBSTPARTY END,
                      DTEEND = CASE VL_DES_T041('DTEEND.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.DTEEND ELSE DTEEND END,
                      CODSUPPLIER = CASE VL_DES_T041('CODSUPPLIER.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.CODSUPPLIER ELSE CODSUPPLIER END,
                      CODUSRCORR = CASE VL_DES_T041('CODUSRCORR.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.CODUSRCORR ELSE CODUSRCORR END,
                      CODSUPPLIER1 = CASE VL_DES_T041('CODSUPPLIER1.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.CODSUPPLIER1 ELSE CODSUPPLIER1 END,
                      CODSUPPLIER2 = CASE VL_DES_T041('CODSUPPLIER2.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.CODSUPPLIER2 ELSE CODSUPPLIER2 END,
                      COD_ATTR_PROIEZIONI = CASE VL_DES_T041('COD_ATTR_PROIEZIONI.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.COD_ATTR_PROIEZIONI ELSE COD_ATTR_PROIEZIONI END,
                      CODTYPCONTE = CASE VL_DES_T041('CODTYPCONTE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.CODTYPCONTE ELSE CODTYPCONTE END,
                      CODTYPEVASION = CASE VL_DES_T041('CODTYPEVASION.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.CODTYPEVASION ELSE CODTYPEVASION END,
                      FLAG_BLOCK_LIQ = CASE VL_DES_T041('FLAG_BLOCK_LIQ.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.FLAG_BLOCK_LIQ ELSE FLAG_BLOCK_LIQ END,
                      EC_AGENTE = CASE VL_DES_T041('EC_AGENTE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.EC_AGENTE ELSE EC_AGENTE END,
                      CODSTOREFORMAT = CASE VL_DES_T041('CODSTOREFORMAT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.CODSTOREFORMAT ELSE CODSTOREFORMAT END,
                      CODCUSTDELIV = CASE VL_DES_T041('CODCUSTDELIV.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.CODCUSTDELIV ELSE CODCUSTDELIV END,
                      CODCUSTDELIV2 = CASE VL_DES_T041('CODCUSTDELIV2.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.CODCUSTDELIV2 ELSE CODCUSTDELIV2 END,
                      FLGASSOVERIFY = CASE VL_DES_T041('FLGASSOVERIFY.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.FLGASSOVERIFY ELSE FLGASSOVERIFY END,
                      FLGPROMOVERIFY = CASE VL_DES_T041('FLGPROMOVERIFY.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.FLGPROMOVERIFY ELSE FLGPROMOVERIFY END,
                      CODPANEL = CASE VL_DES_T041('CODPANEL.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.CODPANEL ELSE CODPANEL END,
                      INDEXPOT = CASE VL_DES_T041('INDEXPOT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.INDEXPOT ELSE INDEXPOT END,
                      CODDISCLIS6 = CASE VL_DES_T041('CODDISCLIS6.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.CODDISCLIS6 ELSE CODDISCLIS6 END,
                      CODDISCLIS7 = CASE VL_DES_T041('CODDISCLIS7.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.CODDISCLIS7 ELSE CODDISCLIS7 END,
                      FLGAUTH = CASE VL_DES_T041('FLGAUTH.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.FLGAUTH ELSE FLGAUTH END,
                      DTESUBSTPARTY = CASE VL_DES_T041('DTESUBSTPARTY.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.DTESUBSTPARTY ELSE DTESUBSTPARTY END,
                      CODVISITFREQUENCE = CASE VL_DES_T041('CODVISITFREQUENCE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.CODVISITFREQUENCE ELSE CODVISITFREQUENCE END,
                      CODCLUSTER = CASE VL_DES_T041('CODCLUSTER.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.CODCLUSTER ELSE CODCLUSTER END,
                      CODCLUSTERCUST = CASE VL_DES_T041('CODCLUSTERCUST.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.CODCLUSTERCUST ELSE CODCLUSTERCUST END,
                      CODCLUSTERINT = CASE VL_DES_T041('CODCLUSTERINT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.CODCLUSTERINT ELSE CODCLUSTERINT END,
                      FLGENCASHMENT = CASE VL_DES_T041('FLGENCASHMENT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.FLGENCASHMENT ELSE FLGENCASHMENT END,
                      IDEVALASSORTMENT = CASE VL_DES_T041('IDEVALASSORTMENT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.IDEVALASSORTMENT ELSE IDEVALASSORTMENT END,
                      IDEVALPRICELIST = CASE VL_DES_T041('IDEVALPRICELIST.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.IDEVALPRICELIST ELSE IDEVALPRICELIST END,
                      IDEVALDISCOUNTLIST = CASE VL_DES_T041('IDEVALDISCOUNTLIST.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.IDEVALDISCOUNTLIST ELSE IDEVALDISCOUNTLIST END,
                      DTEEVALASSO = CASE VL_DES_T041('DTEEVALASSO.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.DTEEVALASSO ELSE DTEEVALASSO END,
                      CODUSR1ERP = CASE VL_DES_T041('CODUSR1ERP.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.CODUSR1ERP ELSE CODUSR1ERP END,

                      FLG_DSD_PRINT_PRICES = CASE VL_DES_T041('FLG_DSD_PRINT_PRICES.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.FLG_DSD_PRINT_PRICES ELSE FLG_DSD_PRINT_PRICES END,
                      FLG_DSD_BLK_PAYTRM   = CASE VL_DES_T041('FLG_DSD_BLK_PAYTRM.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.FLG_DSD_BLK_PAYTRM ELSE FLG_DSD_BLK_PAYTRM END,
                      DSD_CODBLK_VALCREDIT = CASE VL_DES_T041('DSD_CODBLK_VALCREDIT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.DSD_CODBLK_VALCREDIT ELSE DSD_CODBLK_VALCREDIT END,
                      FLG_DSD_PAPARLESS    = CASE VL_DES_T041('FLG_DSD_PAPARLESS.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.FLG_DSD_PAPARLESS ELSE FLG_DSD_PAPARLESS END,
                      CODAVAILABILITY      = CASE VL_DES_T041('CODAVAILABILITY.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.CODAVAILABILITY ELSE CODAVAILABILITY END,

                      CODPAYMOD2      = CASE VL_DES_T041('CODPAYMOD2.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.CODPAYMOD2 ELSE CODPAYMOD2 END,
                      CODPAYTRM2      = CASE VL_DES_T041('CODPAYTRM2.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.CODPAYTRM2 ELSE CODPAYTRM2 END
*/

                -- WHERE CODPARTY = REC_T041.CODPARTY
                WHERE -- TRIM(CODCATDIV1)= REC_T041.CODPARTY  -- COMMNETED BY VIKAS 
           TRIM(CODPARTY)= REC_T041.CODPARTY
                   AND CODDIV   = REC_T041.CODDIV;
                --
               /* IF SQL%ROWCOUNT = 0 THEN
                  -- record does not exists , we insert it
                  VL_MESSAGE_D := 'Insert T041 ';
                  INSERT INTO T041PARTYDIV VALUES REC_T041;
                END IF;*/
                VL_INS_T041 := VL_INS_T041 + 1;
                --
                END IF;
                --
                -- T045PARTYWEEK
                --
                /*
                IF ( VL_STATUS = 0 ) THEN

                FOR RL_XIN_T045 IN CL_XIN_T045(RL_XIN_T041.CODPARTY, RL_XIN_T041.CODDIV, RL_XIN_T041.SM1_DTECRE) LOOP
                BEGIN
                SAVEPOINT S_T045PARTYWEEK;
                   VL_D_SM1_DTECRE := RL_XIN_T045.SM1_DTECRE;
                   VL_MESSAGE_H := 'Weekly Plan Info: '|| RL_XIN_T045.CODPARTY || '/' ||
                                                          RL_XIN_T045.CODDIV   || '/' ||
                                                          RL_XIN_T045.CODPLAN;

                  VL_MESSAGE_D := 'Format Conversion ';
                  REC_T045.CODPARTY := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T045.CODPARTY,'CODPARTY', VL_DES_T045,VL_STATUS, VL_MESSAGE_D);
                  REC_T045.CODDIV := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T045.CODDIV,'CODDIV', VL_DES_T045,VL_STATUS, VL_MESSAGE_D);
                  REC_T045.CODPLAN := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T045.CODPLAN,'CODPLAN', VL_DES_T045,VL_STATUS, VL_MESSAGE_D);
                  REC_T045.DESMON := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T045.DESMON,'DESMON', VL_DES_T045,VL_STATUS, VL_MESSAGE_D);
                  REC_T045.DESTUE := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T045.DESTUE,'DESTUE', VL_DES_T045,VL_STATUS, VL_MESSAGE_D);
                  REC_T045.DESWED := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T045.DESWED,'DESWED', VL_DES_T045,VL_STATUS, VL_MESSAGE_D);
                  REC_T045.DESTHU := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T045.DESTHU,'DESTHU', VL_DES_T045,VL_STATUS, VL_MESSAGE_D);
                  REC_T045.DESFRI := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T045.DESFRI,'DESFRI', VL_DES_T045,VL_STATUS, VL_MESSAGE_D);
                  REC_T045.DESSAT := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T045.DESSAT,'DESSAT', VL_DES_T045,VL_STATUS, VL_MESSAGE_D);
                  REC_T045.DESSUN := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T045.DESSUN,'DESSUN', VL_DES_T045,VL_STATUS, VL_MESSAGE_D);
                  REC_T045.FLGANN := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T045.FLGANN,'FLGANN', VL_DES_T045,VL_STATUS, VL_MESSAGE_D);


                 IF (VL_STATUS <> 0 ) THEN
                   VL_MESSAGE_H := SUBSTR(VL_MESSAGE_H||' '||VL_MESSAGE_D||' '||dbms_utility.format_error_backtrace() || ' ' || SQLERRM,1,4000);
                   PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                           VL_PROGR_D_T045,
                                           SQLCODE,
                                           VL_MESSAGE_H);
                 END IF;
                 IF (VL_STATUS = 0 ) THEN
                --
                 VL_MESSAGE_D := 'Update T045 ';
                 UPDATE T045PARTYWEEK
                   SET
                      DESMON = CASE VL_DES_T045('DESMON.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T045.DESMON ELSE DESMON END,
                      DESTUE = CASE VL_DES_T045('DESTUE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T045.DESTUE ELSE DESTUE END,
                      DESWED = CASE VL_DES_T045('DESWED.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T045.DESWED ELSE DESWED END,
                      DESTHU = CASE VL_DES_T045('DESTHU.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T045.DESTHU ELSE DESTHU END,
                      DESFRI = CASE VL_DES_T045('DESFRI.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T045.DESFRI ELSE DESFRI END,
                      DESSAT = CASE VL_DES_T045('DESSAT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T045.DESSAT ELSE DESSAT END,
                      DESSUN = CASE VL_DES_T045('DESSUN.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T045.DESSUN ELSE DESSUN END,
                      FLGANN = CASE VL_DES_T045('FLGANN.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T045.FLGANN ELSE FLGANN END

                 WHERE CODPARTY = REC_T045.CODPARTY
                   AND CODDIV   = REC_T045.CODDIV
                   AND CODPLAN  = REC_T045.CODPLAN;
                --
                IF SQL%ROWCOUNT = 0 THEN
                  -- record does not exists , we insert it
                  VL_MESSAGE_D := 'Insert T045 ';
                  INSERT INTO T045PARTYWEEK VALUES REC_T045;

                END IF;
                VL_INS_T045 := VL_INS_T045 + 1;
                --
                END IF;
               EXCEPTION WHEN OTHERS THEN
                     VL_STATUS := -1;
                     ROLLBACK TO SAVEPOINT S_T045PARTYWEEK; -- Rollback all the the details of the customer/division
                     VL_MESSAGE_H := SUBSTR(VL_MESSAGE_H||' '||VL_MESSAGE_D||' '||dbms_utility.format_error_backtrace() || ' ' || SQLERRM,1,4000);

                     PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                                   VL_PROGR_D_T045,
                                                   SQLCODE,
                                                   VL_MESSAGE_H);
                END; -- T045

                IF (VL_STATUS <> 0 ) THEN

                 -- set the status to err to the single record in order to go ahead to another detail
                  UPDATE XIN_T045PARTYWEEK
                     SET SM1_STATUS = C_XINSTATUS_ERR
                     WHERE CODPARTY = RL_XIN_T045.CODPARTY
                      AND  CODDIV   = RL_XIN_T045.CODDIV
                      AND  SM1_CODPROCESS = PI_PROGR_H
                      AND  SM1_STATUS  = C_XINSTATUS_OK
                      AND  SM1_DTECRE = VL_D_SM1_DTECRE;
                      VL_STATUS := 0; -- RE- SET THE STATUS TO 0 TO CONTINUE WITH THE OTHER DETAILS
                END IF;
              END LOOP; -- T045PARTYWEEK


            END IF; -- VL_STATUS = 0 T045PARTYWEEK

            --
            -- T046PARTYBANK
            --

            IF ( VL_STATUS = 0 ) THEN
            FOR RL_XIN_T046 IN CL_XIN_T046(RL_XIN_T041.CODPARTY, RL_XIN_T041.CODDIV, RL_XIN_T041.SM1_DTECRE) LOOP
            BEGIN
            SAVEPOINT S_T046PARTYBANK;

               VL_D_SM1_DTECRE := RL_XIN_T046.SM1_DTECRE;
               VL_MESSAGE_H := 'Bank Info Customer: '|| RL_XIN_T046.CODPARTY || '/' ||
                               'Division: '||RL_XIN_T046.CODDIV   || '/' ||
                               'ABI code: '||RL_XIN_T046.CODABI   || '/' ||
                               'CAB code: '||RL_XIN_T046.CODCAB;

                  VL_MESSAGE_D := 'Format Conversion ';
                  VL_CODDIV:= RL_XIN_T046.CODDIV;
                  REC_T046.CODPARTY := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T046.CODPARTY,'CODPARTY', VL_DES_T046,VL_STATUS, VL_MESSAGE_D);
                  REC_T046.CODDIV := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T046.CODDIV,'CODDIV', VL_DES_T046,VL_STATUS, VL_MESSAGE_D);
                  REC_T046.CODABI := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T046.CODABI,'CODABI', VL_DES_T046,VL_STATUS, VL_MESSAGE_D);
                  REC_T046.CODCAB := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T046.CODCAB,'CODCAB', VL_DES_T046,VL_STATUS, VL_MESSAGE_D);
                  REC_T046.DESBAN := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T046.DESBAN,'DESBAN', VL_DES_T046,VL_STATUS, VL_MESSAGE_D);
                  REC_T046.DESBRA := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T046.DESBRA,'DESBRA', VL_DES_T046,VL_STATUS, VL_MESSAGE_D);
                  REC_T046.DESADDR := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T046.DESADDR,'DESADDR', VL_DES_T046,VL_STATUS, VL_MESSAGE_D);
                  REC_T046.DESLOC := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T046.DESLOC,'DESLOC', VL_DES_T046,VL_STATUS, VL_MESSAGE_D);
                  REC_T046.DESPRV := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T046.DESPRV,'DESPRV', VL_DES_T046,VL_STATUS, VL_MESSAGE_D);
                  REC_T046.CODPRV := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T046.CODPRV,'CODPRV', VL_DES_T046,VL_STATUS, VL_MESSAGE_D);
                  REC_T046.CODACCOUNT := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T046.CODACCOUNT,'CODACCOUNT', VL_DES_T046,VL_STATUS, VL_MESSAGE_D);
                  REC_T046.CODCONTROL := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T046.CODCONTROL,'CODCONTROL', VL_DES_T046,VL_STATUS, VL_MESSAGE_D);
                  REC_T046.CODCIN := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T046.CODCIN,'CODCIN', VL_DES_T046,VL_STATUS, VL_MESSAGE_D);
                  REC_T046.CODIBAN := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T046.CODIBAN,'CODIBAN', VL_DES_T046,VL_STATUS, VL_MESSAGE_D);
                  REC_T046.CODSWIFT := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T046.CODSWIFT,'CODSWIFT', VL_DES_T046,VL_STATUS, VL_MESSAGE_D);



                 IF (VL_STATUS <> 0 ) THEN
                   VL_MESSAGE_H := SUBSTR(VL_MESSAGE_H||' '||VL_MESSAGE_D||' '||dbms_utility.format_error_backtrace() || ' ' || SQLERRM,1,4000);
                   PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                           VL_PROGR_D_T046,
                                           SQLCODE,
                                           VL_MESSAGE_H);
                 END IF;
                 IF (VL_STATUS = 0 ) THEN
                --
                 VL_MESSAGE_D := 'Update T046 ';
                 UPDATE T046PARTYBANK
                   SET
                      DESBAN = CASE VL_DES_T046('DESBAN.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T046.DESBAN ELSE DESBAN END,
                      DESBRA = CASE VL_DES_T046('DESBRA.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T046.DESBRA ELSE DESBRA END,
                      DESADDR = CASE VL_DES_T046('DESADDR.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T046.DESADDR ELSE DESADDR END,
                      DESLOC = CASE VL_DES_T046('DESLOC.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T046.DESLOC ELSE DESLOC END,
                      DESPRV = CASE VL_DES_T046('DESPRV.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T046.DESPRV ELSE DESPRV END,
                      CODPRV = CASE VL_DES_T046('CODPRV.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T046.CODPRV ELSE CODPRV END,
                      CODACCOUNT = CASE VL_DES_T046('CODACCOUNT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T046.CODACCOUNT ELSE CODACCOUNT END,
                      CODCONTROL = CASE VL_DES_T046('CODCONTROL.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T046.CODCONTROL ELSE CODCONTROL END,
                      CODCIN = CASE VL_DES_T046('CODCIN.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T046.CODCIN ELSE CODCIN END,
                      CODIBAN = CASE VL_DES_T046('CODIBAN.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T046.CODIBAN ELSE CODIBAN END,
                      CODSWIFT = CASE VL_DES_T046('CODSWIFT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T046.CODSWIFT ELSE CODSWIFT END


                 WHERE CODPARTY = REC_T046.CODPARTY
                   AND CODDIV   = REC_T046.CODDIV
                   AND CODABI   = REC_T046.CODABI
                   AND CODCAB   = REC_T046.CODCAB;
                --
                IF SQL%ROWCOUNT = 0 THEN
                  -- record does not exists , we insert it
                  VL_MESSAGE_D := 'Insert T046 ';
                  INSERT INTO T046PARTYBANK VALUES REC_T046;

                END IF;
                VL_INS_T046 := VL_INS_T046 + 1;
                END IF;
                 --

              EXCEPTION WHEN OTHERS THEN
                   VL_STATUS := -1;
                   ROLLBACK TO SAVEPOINT S_T046PARTYBANK;
                   VL_MESSAGE_H := SUBSTR(VL_MESSAGE_H||' '||VL_MESSAGE_D||' '||dbms_utility.format_error_backtrace() || ' ' || SQLERRM,1,4000);

                   PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                                 VL_PROGR_D_T046,
                                                 SQLCODE,
                                                 VL_MESSAGE_H);
              END; -- T046
              IF (VL_STATUS <> 0 ) THEN

               -- set the status to err to the single record in order to go ahead to another detail
                UPDATE XIN_T046PARTYBANK
                   SET SM1_STATUS = C_XINSTATUS_ERR
                   WHERE CODPARTY = RL_XIN_T046.CODPARTY
                    AND  CODDIV   = RL_XIN_T046.CODDIV
                    AND  CODABI   = RL_XIN_T046.CODABI
                    AND  CODCAB   = RL_XIN_T046.CODCAB
                    AND  SM1_CODPROCESS = PI_PROGR_H
                    AND  SM1_STATUS  = C_XINSTATUS_OK
                    AND  SM1_DTECRE = VL_D_SM1_DTECRE;
                    VL_STATUS := 0; -- RE- SET THE STATUS TO 0 TO CONTINUE WITH THE OTHER DETAILS
              END IF;
              END LOOP; -- T046PARTYBANK


            END IF; -- VL_STATUS = 0 T046PARTYBANK
            --
            -- T047PARTYCONTACT
            --
            IF ( VL_STATUS = 0 ) THEN

            FOR RL_XIN_T047 IN CL_XIN_T047(RL_XIN_T041.CODPARTY, RL_XIN_T041.CODDIV, RL_XIN_T041.SM1_DTECRE) LOOP
            BEGIN
            SAVEPOINT S_T047PARTYCONTACT;
                 VL_D_SM1_DTECRE := RL_XIN_T047.SM1_DTECRE;
                 VL_MESSAGE_H := 'Contact Info. Customer: '|| RL_XIN_T047.CODPARTY || '/' ||
                                'Division: '||RL_XIN_T047.CODDIV   || '/' ||
                                'Contact code:'||RL_XIN_T047.CODPER   || '/' ||
                                                RL_XIN_T047.CODASSOC;

                  VL_MESSAGE_D := 'Format Conversion ';
                  VL_CODDIV:= RL_XIN_T047.CODDIV;
                  REC_T047.CODPARTY := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T047.CODPARTY,'CODPARTY', VL_DES_T047,VL_STATUS, VL_MESSAGE_D);
                  REC_T047.CODDIV := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T047.CODDIV,'CODDIV', VL_DES_T047,VL_STATUS, VL_MESSAGE_D);
                  REC_T047.CODPER := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T047.CODPER,'CODPER', VL_DES_T047,VL_STATUS, VL_MESSAGE_D);
                  REC_T047.DTEFROM := F_CHECK_FORMAT_D( VL_CODDIV,   RL_XIN_T047.DTEFROM,'DTEFROM', VL_DES_T047,VL_STATUS, VL_MESSAGE_D);
                  REC_T047.DTETO := F_CHECK_FORMAT_D( VL_CODDIV,   RL_XIN_T047.DTETO,'DTETO', VL_DES_T047,VL_STATUS, VL_MESSAGE_D);
                  REC_T047.CODROLE1 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T047.CODROLE1,'CODROLE1', VL_DES_T047,VL_STATUS, VL_MESSAGE_D);
                  REC_T047.CODROLE2 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T047.CODROLE2,'CODROLE2', VL_DES_T047,VL_STATUS, VL_MESSAGE_D);
                  REC_T047.CODROLE3 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T047.CODROLE3,'CODROLE3', VL_DES_T047,VL_STATUS, VL_MESSAGE_D);
                  REC_T047.FLGPRIMARY := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T047.FLGPRIMARY,'FLGPRIMARY', VL_DES_T047,VL_STATUS, VL_MESSAGE_D);
                  REC_T047.DESNOTE := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T047.DESNOTE,'DESNOTE', VL_DES_T047,VL_STATUS, VL_MESSAGE_D);
                  REC_T047.CODSTATUS := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T047.CODSTATUS,'CODSTATUS', VL_DES_T047,VL_STATUS, VL_MESSAGE_D);
                  REC_T047.CODASSOC := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T047.CODASSOC,'CODASSOC', VL_DES_T047,VL_STATUS, VL_MESSAGE_D);



                 IF (VL_STATUS <> 0 ) THEN
                   VL_MESSAGE_H := SUBSTR(VL_MESSAGE_H||' '||VL_MESSAGE_D||' '||dbms_utility.format_error_backtrace() || ' ' || SQLERRM,1,4000);
                   PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                           VL_PROGR_D_T047,
                                           SQLCODE,
                                           VL_MESSAGE_H);
                 END IF;
                 IF (VL_STATUS = 0 ) THEN
                --
                 VL_MESSAGE_D := 'Update T047 ';
                 UPDATE T047PARTYCONTACT
                   SET
                      DTEFROM = CASE VL_DES_T047('DTEFROM.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T047.DTEFROM ELSE DTEFROM END,
                      DTETO = CASE VL_DES_T047('DTETO.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T047.DTETO ELSE DTETO END,
                      CODROLE1 = CASE VL_DES_T047('CODROLE1.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T047.CODROLE1 ELSE CODROLE1 END,
                      CODROLE2 = CASE VL_DES_T047('CODROLE2.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T047.CODROLE2 ELSE CODROLE2 END,
                      CODROLE3 = CASE VL_DES_T047('CODROLE3.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T047.CODROLE3 ELSE CODROLE3 END,
                      FLGPRIMARY = CASE VL_DES_T047('FLGPRIMARY.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T047.FLGPRIMARY ELSE FLGPRIMARY END,
                      DESNOTE = CASE VL_DES_T047('DESNOTE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T047.DESNOTE ELSE DESNOTE END,
                      CODSTATUS = CASE VL_DES_T047('CODSTATUS.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T047.CODSTATUS ELSE CODSTATUS END
                 WHERE CODPARTY = REC_T047.CODPARTY
                   AND CODDIV   = REC_T047.CODDIV
                   AND CODPER   = REC_T047.CODPER
                   AND CODASSOC   = REC_T047.CODASSOC;
                --
                IF SQL%ROWCOUNT = 0 THEN
                  -- record does not exists , we insert it
                  VL_MESSAGE_D := 'Insert T047 ';
                  INSERT INTO T047PARTYCONTACT VALUES REC_T047;

                END IF;
                VL_INS_T047 := VL_INS_T047 + 1;
                --
                END IF;
               EXCEPTION WHEN OTHERS THEN
                 VL_STATUS := -1;
                 ROLLBACK TO SAVEPOINT S_T047PARTYCONTACT;
                 VL_MESSAGE_H := SUBSTR(VL_MESSAGE_H||' '||VL_MESSAGE_D||' '||dbms_utility.format_error_backtrace() || ' ' || SQLERRM,1,4000);

                 PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                               VL_PROGR_D_T047,
                                               SQLCODE,
                                               VL_MESSAGE_H);

                END; -- T047
                IF (VL_STATUS <> 0 ) THEN
                   -- set the status to err to the single record in order to go ahead to another detail
                   UPDATE XIN_T047PARTYCONTACT
                             SET SM1_STATUS = C_XINSTATUS_ERR
                             WHERE CODPARTY = RL_XIN_T047.CODPARTY
                              AND  CODDIV   = RL_XIN_T047.CODDIV
                              AND  CODPER   = RL_XIN_T047.CODPER
                              AND  CODASSOC = RL_XIN_T047.CODASSOC
                              AND  SM1_CODPROCESS = PI_PROGR_H
                              AND  SM1_STATUS  = C_XINSTATUS_OK
                              AND  SM1_DTECRE = VL_D_SM1_DTECRE;
                   VL_STATUS := 0; -- RE- SET THE STATUS TO 0 TO CONTINUE WITH THE OTHER DETAILS
                END IF;
              END LOOP; -- T047PARTYCONTACT

            END IF; -- VL_STATUS = 0 T047PARTYCONTACT
            --
            -- T049PVCATEGORY ONLY FOR SALE POINTS
            --
            IF ( VL_STATUS = 0  AND REC_T040.FLGCUSTSALE <> 0) THEN

              FOR RL_XIN_T049 IN CL_XIN_T049(RL_XIN_T041.CODPARTY, RL_XIN_T041.CODDIV, RL_XIN_T041.SM1_DTECRE) LOOP
              BEGIN
              SAVEPOINT S_T049PVCATEGORY;
               VL_D_SM1_DTECRE := RL_XIN_T049.SM1_DTECRE;

               VL_MESSAGE_H := 'Category Info. Customer: '|| RL_XIN_T049.CODPARTY    || '/' ||
                               'Division: '     ||RL_XIN_T049.CODDIV      || '/' ||
                               'Category code: '||RL_XIN_T049.CODCATEGORY || '/' ||
                               'Cluster code: ' ||RL_XIN_T049.CODCLUSTERCUST;

                  VL_MESSAGE_D := 'Format Conversion ';
                  VL_CODDIV:= RL_XIN_T049.CODDIV;
                  REC_T049.CODPARTY := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T049.CODPARTY,'CODPARTY', VL_DES_T049,VL_STATUS, VL_MESSAGE_D);
                  REC_T049.CODDIV := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T049.CODDIV,'CODDIV', VL_DES_T049,VL_STATUS, VL_MESSAGE_D);
                  REC_T049.CODCATEGORY := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T049.CODCATEGORY,'CODCATEGORY', VL_DES_T049,VL_STATUS, VL_MESSAGE_D);
                  REC_T049.INDEXPOT := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T049.INDEXPOT,'INDEXPOT', VL_DES_T049,VL_STATUS, VL_MESSAGE_D);
                  REC_T049.CODCATEGORYROLE := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T049.CODCATEGORYROLE,'CODCATEGORYROLE', VL_DES_T049,VL_STATUS, VL_MESSAGE_D);
                  REC_T049.QTYLINEARI := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T049.QTYLINEARI,'QTYLINEARI', VL_DES_T049,VL_STATUS, VL_MESSAGE_D);
                  REC_T049.NUMAVANCASSE := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T049.NUMAVANCASSE,'NUMAVANCASSE', VL_DES_T049,VL_STATUS, VL_MESSAGE_D);
                  REC_T049.CODVISITFREQUENCE := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T049.CODVISITFREQUENCE,'CODVISITFREQUENCE', VL_DES_T049,VL_STATUS, VL_MESSAGE_D);
                  REC_T049.CODCLUSTERCUST := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T049.CODCLUSTERCUST,'CODCLUSTERCUST', VL_DES_T049,VL_STATUS, VL_MESSAGE_D);
                  REC_T049.CODCLUSTER := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T049.CODCLUSTER,'CODCLUSTER', VL_DES_T049,VL_STATUS, VL_MESSAGE_D);
                  REC_T049.CODCLUSTERINT := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T049.CODCLUSTERINT,'CODCLUSTERINT', VL_DES_T049,VL_STATUS, VL_MESSAGE_D);
                  REC_T049.CODPARTY_CLUSTER  := F_CHECK_FORMAT_S(VL_CODDIV, RL_XIN_T049.CODPARTY_CLUSTER,
                                                                 'CODPARTY_CLUSTER',
                                                                 VL_DES_T049,
                                                                 VL_STATUS,
                                                                 VL_MESSAGE_D);
                 REC_T049.CODLEV_CLUSTER  := F_CHECK_FORMAT_S(VL_CODDIV, RL_XIN_T049.CODLEV_CLUSTER,
                                                                 'CODLEV_CLUSTER',
                                                                 VL_DES_T049,
                                                                 VL_STATUS,
                                                                 VL_MESSAGE_D);
                 REC_T049.CODHIER_CLUSTER  := F_CHECK_FORMAT_S(VL_CODDIV, RL_XIN_T049.CODHIER_CLUSTER,
                                                                 'CODHIER_CLUSTER',
                                                                 VL_DES_T049,
                                                                 VL_STATUS,
                                                                 VL_MESSAGE_D);
                 REC_T049.CODASSORTMENTTYPE_CLUSTER  := F_CHECK_FORMAT_S(VL_CODDIV, RL_XIN_T049.CODASSORTMENTTYPE_CLUSTER,
                                                                 'CODASSORTMENTTYPE_CLUSTER',
                                                                 VL_DES_T049,
                                                                 VL_STATUS,
                                                                 VL_MESSAGE_D);

                 IF (VL_STATUS <> 0 ) THEN
                   VL_MESSAGE_H := SUBSTR(VL_MESSAGE_H||' '||VL_MESSAGE_D||' '||dbms_utility.format_error_backtrace() || ' ' || SQLERRM,1,4000);
                   PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                           VL_PROGR_D_T049,
                                           SQLCODE,
                                           VL_MESSAGE_H);
                  END IF;
                 IF (VL_STATUS = 0 ) THEN
                --
                 VL_MESSAGE_D := 'Update T049 ';
                 UPDATE T049PVCATEGORY
                   SET
                      INDEXPOT = CASE VL_DES_T049('INDEXPOT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T049.INDEXPOT ELSE INDEXPOT END,
                      CODCATEGORYROLE = CASE VL_DES_T049('CODCATEGORYROLE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T049.CODCATEGORYROLE ELSE CODCATEGORYROLE END,
                      QTYLINEARI = CASE VL_DES_T049('QTYLINEARI.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T049.QTYLINEARI ELSE QTYLINEARI END,
                      NUMAVANCASSE = CASE VL_DES_T049('NUMAVANCASSE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T049.NUMAVANCASSE ELSE NUMAVANCASSE END,
                      CODVISITFREQUENCE = CASE VL_DES_T049('CODVISITFREQUENCE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T049.CODVISITFREQUENCE ELSE CODVISITFREQUENCE END,
                      CODCLUSTER = CASE VL_DES_T049('CODCLUSTER.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T049.CODCLUSTER ELSE CODCLUSTER END,
                      CODCLUSTERINT = CASE VL_DES_T049('CODCLUSTERINT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T049.CODCLUSTERINT ELSE CODCLUSTERINT END,
                      CODPARTY_CLUSTER     = CASE VL_DES_T049('CODPARTY_CLUSTER.ALL').FLG_SM1  WHEN C_UPDATED_BY_HOST THEN REC_T049.CODPARTY_CLUSTER ELSE CODPARTY_CLUSTER END,
                      CODLEV_CLUSTER     = CASE VL_DES_T049('CODLEV_CLUSTER.ALL').FLG_SM1  WHEN C_UPDATED_BY_HOST THEN REC_T049.CODLEV_CLUSTER ELSE CODLEV_CLUSTER END,
                      CODHIER_CLUSTER     = CASE VL_DES_T049('CODHIER_CLUSTER.ALL').FLG_SM1  WHEN C_UPDATED_BY_HOST THEN REC_T049.CODHIER_CLUSTER ELSE CODHIER_CLUSTER END,
                      CODASSORTMENTTYPE_CLUSTER     = CASE VL_DES_T049('CODASSORTMENTTYPE_CLUSTER.ALL').FLG_SM1  WHEN C_UPDATED_BY_HOST THEN REC_T049.CODASSORTMENTTYPE_CLUSTER ELSE CODASSORTMENTTYPE_CLUSTER END

                 WHERE CODPARTY = REC_T049.CODPARTY
                   AND CODDIV   = REC_T049.CODDIV
                   AND CODCATEGORY   = REC_T049.CODCATEGORY
                   AND CODCLUSTERCUST= REC_T049.CODCLUSTERCUST;
                --
                IF SQL%ROWCOUNT = 0 THEN
                  -- record does not exists , we insert it
                  VL_MESSAGE_D := 'Insert T049 ';
                  INSERT INTO T049PVCATEGORY VALUES REC_T049;

                END IF;
                VL_INS_T049 := VL_INS_T049 + 1;
                --
                END IF;
                 EXCEPTION WHEN OTHERS THEN
                         VL_STATUS := -1;
                         ROLLBACK TO SAVEPOINT S_T049PVCATEGORY;
                         VL_MESSAGE_H := SUBSTR(VL_MESSAGE_H||' '||VL_MESSAGE_D||' '||dbms_utility.format_error_backtrace() || ' ' || SQLERRM,1,4000);

                         PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                                       VL_PROGR_D_T049,
                                                       SQLCODE,
                                                       VL_MESSAGE_H);



                END; -- T049
                IF (VL_STATUS <> 0 ) THEN
                 -- set the status to err to the single record in order to go ahead to another detail
                  UPDATE XIN_T049PVCATEGORY
                     SET SM1_STATUS = C_XINSTATUS_ERR
                     WHERE CODPARTY = RL_XIN_T049.CODPARTY
                      AND  CODDIV   = RL_XIN_T049.CODDIV
                      AND  SM1_CODPROCESS = PI_PROGR_H
                      AND  SM1_STATUS  = C_XINSTATUS_OK
                      AND  SM1_DTECRE = VL_D_SM1_DTECRE;
                      VL_STATUS := 0; -- RE- SET THE STATUS TO 0 TO CONTINUE WITH THE OTHER DETAILS
                 END IF;
              END LOOP; -- T049PVCATEGORY

        END IF; -- VL_STATUS = 0 T049PVCATEGORY
      */
      END LOOP; -- T041

      END IF; --( VL_STATUS = 0 AND VL_RECORD_LOCKED = 0 )
        --
      EXCEPTION
        WHEN OTHERS THEN
           VL_STATUS := -1;
           VL_MESSAGE_H := SUBSTR(VL_MESSAGE_H||' '||VL_MESSAGE_D||' '||dbms_utility.format_error_backtrace() || ' ' || SQLERRM,1,4000);

           PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                           VL_PROGR_D_T041,
                                           SQLCODE,
                                           VL_MESSAGE_H);

      END; --- DIVISION INFO T041

      --- ---------------------------------
      --- T042PARTYADDR CUSTOMER ADDRESSES
      --- ---------------------------------
      
      BEGIN -- ADDRESSES T042PARTYADDR

        IF ( VL_STATUS = 0 ) THEN
              -- ADDR
              FOR RL_XIN_T042 IN CL_XIN_T042(RL_XIN_T040.CODPARTY, RL_XIN_T040.SM1_DTECRE) LOOP
              --
                  VL_MESSAGE_H := 'Address. Customer: '|| RL_XIN_T042.CODPARTY || '/' ||
                                  'Adr Code: '||RL_XIN_T042.CODADDR;

                  VL_MESSAGE_D := 'Format Conversion ';
                  VL_CODDIV:= 'ALL';
                  REC_T042.CODPARTY := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T042.CODPARTY,'CODPARTY', VL_DES_T042,VL_STATUS, VL_MESSAGE_D);
                  REC_T042.CODADDR := NVL(F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T042.CODADDR,'CODADDR', VL_DES_T042,VL_STATUS, VL_MESSAGE_D),
                                          C_ADDR_DEF);
                  REC_T042.DESADDR1 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T042.DESADDR1,'DESADDR1', VL_DES_T042,VL_STATUS, VL_MESSAGE_D);
                  REC_T042.DESADDR2 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T042.DESADDR2,'DESADDR2', VL_DES_T042,VL_STATUS, VL_MESSAGE_D);
                  REC_T042.DESLOC1 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T042.DESLOC1,'DESLOC1', VL_DES_T042,VL_STATUS, VL_MESSAGE_D);
                  REC_T042.DESLOC2 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T042.DESLOC2,'DESLOC2', VL_DES_T042,VL_STATUS, VL_MESSAGE_D);
                  REC_T042.NUMPHONE1 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T042.NUMPHONE1,'NUMPHONE1', VL_DES_T042,VL_STATUS, VL_MESSAGE_D);
                  REC_T042.NUMPHONE2 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T042.NUMPHONE2,'NUMPHONE2', VL_DES_T042,VL_STATUS, VL_MESSAGE_D);
                  REC_T042.NUMFAX1 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T042.NUMFAX1,'NUMFAX1', VL_DES_T042,VL_STATUS, VL_MESSAGE_D);
                  REC_T042.NUMFAX2 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T042.NUMFAX2,'NUMFAX2', VL_DES_T042,VL_STATUS, VL_MESSAGE_D);
                  REC_T042.CODZIP := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T042.CODZIP,'CODZIP', VL_DES_T042,VL_STATUS, VL_MESSAGE_D);
                  REC_T042.CODPRV := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T042.CODPRV,'CODPRV', VL_DES_T042,VL_STATUS, VL_MESSAGE_D);
                  REC_T042.CODAREA := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T042.CODAREA,'CODAREA', VL_DES_T042,VL_STATUS, VL_MESSAGE_D);
                  REC_T042.CODZONE := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T042.CODZONE,'CODZONE', VL_DES_T042,VL_STATUS, VL_MESSAGE_D);
                  REC_T042.CODNATION := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T042.CODNATION,'CODNATION', VL_DES_T042,VL_STATUS, VL_MESSAGE_D);
                  REC_T042.EMAIL1 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T042.EMAIL1,'EMAIL1', VL_DES_T042,VL_STATUS, VL_MESSAGE_D);
                  REC_T042.WEBSITE1 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T042.WEBSITE1,'WEBSITE1', VL_DES_T042,VL_STATUS, VL_MESSAGE_D);
                  REC_T042.WEBSITE2 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T042.WEBSITE2,'WEBSITE2', VL_DES_T042,VL_STATUS, VL_MESSAGE_D);
                  REC_T042.CODTYPADDR := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T042.CODTYPADDR,'CODTYPADDR', VL_DES_T042,VL_STATUS, VL_MESSAGE_D);
                  REC_T042.VALLATITUDE := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T042.VALLATITUDE,'VALLATITUDE', VL_DES_T042,VL_STATUS, VL_MESSAGE_D);
                  REC_T042.VALLONGITUDE := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T042.VALLONGITUDE,'VALLONGITUDE', VL_DES_T042,VL_STATUS, VL_MESSAGE_D);

                  --- Customised field for DAL
                  REC_T042.Z_CODREGION := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T042.Z_CODREGION,'Z_CODREGION', VL_DES_T042,VL_STATUS, VL_MESSAGE_D);
                  REC_T042.Z_CODDISTRICT := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T042.Z_CODDISTRICT,'Z_CODDISTRICT', VL_DES_T042,VL_STATUS, VL_MESSAGE_D);
                  REC_T042.Z_CODLOC := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T042.Z_CODLOC,'Z_CODLOC', VL_DES_T042,VL_STATUS, VL_MESSAGE_D);
                  REC_T042.Z_CODTERRITORY := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T042.Z_CODTERRITORY,'Z_CODTERRITORY', VL_DES_T042,VL_STATUS, VL_MESSAGE_D);



                 IF (VL_STATUS <> 0 ) THEN
                   VL_MESSAGE_H := SUBSTR(VL_MESSAGE_H||' '||VL_MESSAGE_D||' '||dbms_utility.format_error_backtrace() || ' ' || SQLERRM,1,4000);
                   PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                           VL_PROGR_D_T042,
                                           SQLCODE,
                                           VL_MESSAGE_H);
                 ELSE
                --
                VL_MESSAGE_D := 'Update T042 ';

                UPDATE T042PARTYADDR
                   SET
                    DESADDR1 = CASE VL_DES_T042('DESADDR1.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T042.DESADDR1 ELSE DESADDR1 END,
          CODADDR = CASE VL_DES_T042('CODADDR.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T042.CODADDR ELSE CODADDR END -- ADDED BY VIKAS
                   /* DESADDR2 = CASE VL_DES_T042('DESADDR2.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T042.DESADDR2 ELSE DESADDR2 END,
                    DESLOC1 = CASE VL_DES_T042('DESLOC1.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T042.DESLOC1 ELSE DESLOC1 END,
                    DESLOC2 = CASE VL_DES_T042('DESLOC2.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T042.DESLOC2 ELSE DESLOC2 END,
                    NUMPHONE1 = CASE VL_DES_T042('NUMPHONE1.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T042.NUMPHONE1 ELSE NUMPHONE1 END,
                    NUMPHONE2 = CASE VL_DES_T042('NUMPHONE2.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T042.NUMPHONE2 ELSE NUMPHONE2 END,
                    NUMFAX1 = CASE VL_DES_T042('NUMFAX1.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T042.NUMFAX1 ELSE NUMFAX1 END,
                    NUMFAX2 = CASE VL_DES_T042('NUMFAX2.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T042.NUMFAX2 ELSE NUMFAX2 END,
                    CODZIP = CASE VL_DES_T042('CODZIP.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T042.CODZIP ELSE CODZIP END,
                    CODPRV = CASE VL_DES_T042('CODPRV.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T042.CODPRV ELSE CODPRV END,
                    CODAREA = CASE VL_DES_T042('CODAREA.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T042.CODAREA ELSE CODAREA END,
                    CODZONE = CASE VL_DES_T042('CODZONE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T042.CODZONE ELSE CODZONE END,
                    CODNATION = CASE VL_DES_T042('CODNATION.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T042.CODNATION ELSE CODNATION END,
                    EMAIL1 = CASE VL_DES_T042('EMAIL1.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T042.EMAIL1 ELSE EMAIL1 END,
                    WEBSITE1 = CASE VL_DES_T042('WEBSITE1.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T042.WEBSITE1 ELSE WEBSITE1 END,
                    WEBSITE2 = CASE VL_DES_T042('WEBSITE2.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T042.WEBSITE2 ELSE WEBSITE2 END,
                    CODTYPADDR = CASE VL_DES_T042('CODTYPADDR.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T042.CODTYPADDR ELSE CODTYPADDR END,
                    VALLATITUDE = CASE VL_DES_T042('VALLATITUDE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T042.VALLATITUDE ELSE VALLATITUDE END,
                    VALLONGITUDE = CASE VL_DES_T042('VALLONGITUDE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T042.VALLONGITUDE ELSE VALLONGITUDE END,

Z_CODREGION = CASE VL_DES_T042('Z_CODREGION.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T042.Z_CODREGION ELSE Z_CODREGION END,
Z_CODDISTRICT = CASE VL_DES_T042('Z_CODDISTRICT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T042.Z_CODDISTRICT ELSE Z_CODDISTRICT END,
Z_CODLOC = CASE VL_DES_T042('Z_CODLOC.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T042.Z_CODLOC ELSE Z_CODLOC END,
Z_CODTERRITORY = CASE VL_DES_T042('Z_CODTERRITORY.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T042.Z_CODTERRITORY ELSE Z_CODTERRITORY END
          */      

 

                 WHERE CODPARTY  = REC_T042.CODPARTY;
                   --AND CODADDR   = REC_T042.CODADDR; --VIKAS

                --
                IF SQL%ROWCOUNT = 0 THEN
                  -- record does not exists , we insert it
                  VL_MESSAGE_D := 'Insert T042 ';
                 -- INSERT INTO T042PARTYADDR VALUES REC_T042; --COMMENTED BY VIKAS
                END IF;
                VL_INS_T042 := VL_INS_T042 + 1;
                END IF;
                --
              END LOOP;  --- T042PARTY ADDR
      END IF; --( VL_STATUS = 0 AND VL_RECORD_LOCKED = 0 )
        --
      EXCEPTION
        WHEN OTHERS THEN
           VL_STATUS := -1;
           VL_MESSAGE_H := SUBSTR(VL_MESSAGE_H||' '||VL_MESSAGE_D||' '||dbms_utility.format_error_backtrace() || ' ' || SQLERRM,1,4000);

           PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                           VL_PROGR_D_T042,
                                           SQLCODE,
                                           VL_MESSAGE_H);

      END; --- ADDRESSES T042
      
      --- ---------------------------------
      --- TA4410NOTES CUSTOMER NOTES
      --- ---------------------------------
  /*
        IF ( VL_STATUS = 0 ) THEN
              -- NOTES

              FOR RL_XIN_TA4410 IN CL_XIN_TA4410(RL_XIN_T040.CODPARTY, RL_XIN_T040.SM1_DTECRE) LOOP
              --
              BEGIN -- NOTES TA4410NOTES
              SAVEPOINT S_TA4410NOTES;

                VL_MESSAGE_H := 'Customer: '|| RL_XIN_TA4410.CODPARTY || '/' ||
                                'Note Type: ' || RL_XIN_TA4410.NOTETYPE || '/' ||
                                'Seq: ' || RL_XIN_TA4410.IDSEQ;
                 VL_MESSAGE_D := 'Format Conversion ';
                  VL_CODDIV:= 'ALL';
                  VL_D_SM1_DTECRE := RL_XIN_TA4410.SM1_DTECRE;

                  REC_TA4410.NOTETYPE := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_TA4410.NOTETYPE,'NOTETYPE', VL_DES_TA4410,VL_STATUS, VL_MESSAGE_D);
                  REC_TA4410.IDSEQ := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_TA4410.IDSEQ,'IDSEQ', VL_DES_TA4410,VL_STATUS, VL_MESSAGE_D);
                  REC_TA4410.NOTE := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_TA4410.NOTE,'NOTE', VL_DES_TA4410,VL_STATUS, VL_MESSAGE_D);
                  REC_TA4410.CODUSRCRE  := REC_T040.CODUSRCREREAL;
                  REC_TA4410.CODUSRMOD  := REC_T040.CODUSRMODREAL;
                  REC_TA4410.DTECRE     := REC_T040.DTECRE;
                  REC_TA4410.DTEMOD     := REC_T040.DTEMOD;
                  --
                  REC_TA4410.PARENTKEY := REC_T040.DOCUMENTKEY;-- DOCUMENT KEY FROM T040 RECORD
                  --
                 IF (VL_STATUS <> 0 ) THEN
                   VL_MESSAGE_H := SUBSTR(VL_MESSAGE_H||' '||VL_MESSAGE_D||' '||dbms_utility.format_error_backtrace() || ' ' || SQLERRM,1,4000);
                   PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                           VL_PROGR_D_TA4410,
                                           SQLCODE,
                                           VL_MESSAGE_H);
                 ELSE
                    --
                    VL_MESSAGE_D := 'Update TA4410 ';

                    UPDATE TA4410NOTES
                       SET NOTE = CASE VL_DES_TA4410('NOTE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA4410.NOTE ELSE NOTE END
                     WHERE PARENTKEY = REC_TA4410.PARENTKEY
                       AND NOTETYPE  = REC_TA4410.NOTETYPE
                       AND IDSEQ     = REC_TA4410.IDSEQ;

                    --
                    IF SQL%ROWCOUNT = 0 THEN
                      -- record does not exists , we insert it
                      VL_MESSAGE_D := 'Insert TA4410 ';

                      INSERT INTO TA4410NOTES  VALUES REC_TA4410;
                    END IF;
                    VL_INS_TA4410 := VL_INS_TA4410 + 1;
                END IF;
                --
                           --
              EXCEPTION
                WHEN OTHERS THEN
                   VL_STATUS := -1;
                   ROLLBACK TO SAVEPOINT S_TA4410NOTES;
                   VL_MESSAGE_H := SUBSTR(VL_MESSAGE_H||' '||VL_MESSAGE_D||' '||dbms_utility.format_error_backtrace() || ' ' || SQLERRM,1,4000);

                   PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                                   VL_PROGR_D_TA4410,
                                                   SQLCODE,
                                                   VL_MESSAGE_H);


              END; --- NOTES TA4410

              IF (VL_STATUS <> 0 ) THEN
                 -- set the status to err to the single record in order to go ahead to another detail
                UPDATE XIN_TA4410NOTES_CUST
                             SET SM1_STATUS = C_XINSTATUS_ERR
                             WHERE CODPARTY = RL_XIN_TA4410.CODPARTY
                              AND  SM1_CODPROCESS = PI_PROGR_H
                              AND  SM1_STATUS  = C_XINSTATUS_OK
                              AND  SM1_DTECRE = VL_D_SM1_DTECRE;
                      VL_STATUS := 0; -- RE- SET THE STATUS TO 0 TO CONTINUE WITH THE OTHER DETAILS
              END IF;

              END LOOP;  --- TA4410NOTES


      END IF; --( VL_STATUS = 0 AND VL_RECORD_LOCKED = 0 )
*/
 -- if all records have been stored with success then it makes the commit
      IF VL_STATUS = 0 THEN
         VL_INS_T040 := VL_INS_T040 + 1;
         COMMIT;
      ELSE
        ROLLBACK;
      END IF;
      -- Into the loop we set only records on error
      IF ( VL_STATUS <> 0 OR VL_RECORD_LOCKED <> 0 ) THEN
              UPDATE XIN_T040PARTY
              SET   SM1_STATUS = CASE
                                      WHEN VL_RECORD_LOCKED <> 0  THEN C_XINSTATUS_LOCK
                                      ELSE C_XINSTATUS_ERR END
              WHERE CODPARTY = RL_XIN_T040.CODPARTY
               AND  SM1_CODPROCESS = PI_PROGR_H
               AND  SM1_DTECRE     = RL_XIN_T040.SM1_DTECRE
               AND  SM1_STATUS     = C_XINSTATUS_OK;


              UPDATE XIN_T041PARTYDIV
              SET SM1_STATUS = CASE
                                    WHEN VL_RECORD_LOCKED <> 0  THEN C_XINSTATUS_LOCK
                                    ELSE C_XINSTATUS_ERR END
              WHERE CODPARTY = RL_XIN_T040.CODPARTY
               AND  SM1_CODPROCESS = PI_PROGR_H
               AND  SM1_DTECRE <= RL_XIN_T040.SM1_DTECRE
               AND  SM1_STATUS     = C_XINSTATUS_OK;

              UPDATE XIN_T042PARTYADDR
              SET SM1_STATUS = CASE
                                    WHEN VL_RECORD_LOCKED <> 0  THEN C_XINSTATUS_LOCK
                                    ELSE C_XINSTATUS_ERR END
              WHERE CODPARTY = RL_XIN_T040.CODPARTY
               AND  SM1_CODPROCESS = PI_PROGR_H
               AND  SM1_DTECRE <= RL_XIN_T040.SM1_DTECRE
               AND  SM1_STATUS     = C_XINSTATUS_OK;

              UPDATE XIN_TA4410NOTES_CUST
              SET SM1_STATUS = CASE
                                    WHEN VL_RECORD_LOCKED <> 0  THEN C_XINSTATUS_LOCK
                                    ELSE C_XINSTATUS_ERR END
              WHERE CODPARTY = RL_XIN_T040.CODPARTY
                AND  SM1_CODPROCESS = PI_PROGR_H
               AND  SM1_DTECRE <= RL_XIN_T040.SM1_DTECRE
               AND  SM1_STATUS     = C_XINSTATUS_OK;

              UPDATE XIN_T045PARTYWEEK
              SET SM1_STATUS = CASE
                                    WHEN VL_RECORD_LOCKED <> 0  THEN C_XINSTATUS_LOCK
                                    ELSE C_XINSTATUS_ERR END
              WHERE CODPARTY = RL_XIN_T040.CODPARTY
                AND  SM1_CODPROCESS = PI_PROGR_H
               AND  SM1_DTECRE <= RL_XIN_T040.SM1_DTECRE
               AND  SM1_STATUS     = C_XINSTATUS_OK;

              UPDATE XIN_T046PARTYBANK
              SET SM1_STATUS= CASE
                                    WHEN VL_RECORD_LOCKED <> 0  THEN C_XINSTATUS_LOCK
                                    ELSE C_XINSTATUS_ERR END
              WHERE CODPARTY = RL_XIN_T040.CODPARTY
                AND  SM1_CODPROCESS = PI_PROGR_H
               AND  SM1_DTECRE <= RL_XIN_T040.SM1_DTECRE
               AND  SM1_STATUS     = C_XINSTATUS_OK;

              UPDATE XIN_T047PARTYCONTACT
              SET SM1_STATUS = CASE
                                    WHEN VL_RECORD_LOCKED <> 0  THEN C_XINSTATUS_LOCK
                                    ELSE C_XINSTATUS_ERR END
              WHERE CODPARTY = RL_XIN_T040.CODPARTY
               AND  SM1_CODPROCESS = PI_PROGR_H
               AND  SM1_DTECRE <= RL_XIN_T040.SM1_DTECRE
               AND  SM1_STATUS     = C_XINSTATUS_OK;

              UPDATE XIN_T049PVCATEGORY
              SET SM1_STATUS= CASE
                                    WHEN VL_RECORD_LOCKED <> 0  THEN C_XINSTATUS_LOCK
                                    ELSE C_XINSTATUS_ERR END
              WHERE CODPARTY = RL_XIN_T040.CODPARTY
                AND  SM1_CODPROCESS = PI_PROGR_H
               AND  SM1_DTECRE <= RL_XIN_T040.SM1_DTECRE
               AND  SM1_STATUS     = C_XINSTATUS_OK;

             COMMIT;
        END IF;


       -- Release Record
        UPDATE T040PARTY
        SET       DTELCK          = NULL,
                  IDSESSIONLCK    = NULL,
                  CODUSRLCK       = NULL
        WHERE CODPARTY     = REC_T040.CODPARTY
          AND IDSESSIONLCK = PI_SESSION_ID
          AND CODUSRLCK    = C_SYSUSR;

        COMMIT;

    END LOOP;  -- T040PARTY



    BEGIN

       -- Moves records from staging area to log staging area
       P_XIN_MOVE_TO_LOG(PI_PROGR_H, VL_PROGR_D_T049,'T049PVCATEGORY');
       P_XIN_MOVE_TO_LOG(PI_PROGR_H, VL_PROGR_D_T047,'T047PARTYCONTACT');
       P_XIN_MOVE_TO_LOG(PI_PROGR_H, VL_PROGR_D_T046,'T046PARTYBANK');
       P_XIN_MOVE_TO_LOG(PI_PROGR_H, VL_PROGR_D_T045,'T045PARTYWEEK');
       P_XIN_MOVE_TO_LOG(PI_PROGR_H, VL_PROGR_D_T042,'T042PARTYADDR');
       P_XIN_MOVE_TO_LOG(PI_PROGR_H, VL_PROGR_D_TA4410,'TA4410NOTES_CUST');
       P_XIN_MOVE_TO_LOG(PI_PROGR_H, VL_PROGR_D_T041,'T041PARTYDIV');
       P_XIN_MOVE_TO_LOG(PI_PROGR_H, VL_PROGR_D_T040,'T040PARTY');       --
    END;



   -- Close Logs

    --
     PKG_UTILS.LOG_END_DETAIL(PI_PROGR_H,
                                      VL_PROGR_D_T049,
                                      0,
                                      VL_COUNT_XIN_T049,
                                      VL_INS_T049,
                                      VL_COUNT_XIN_T049 - VL_INS_T049);
    --
    PKG_UTILS.LOG_END_DETAIL(PI_PROGR_H,
                                      VL_PROGR_D_T047,
                                      0,
                                      VL_COUNT_XIN_T047,
                                      VL_INS_T047,
                                      VL_COUNT_XIN_T047 - VL_INS_T047);
    --
    PKG_UTILS.LOG_END_DETAIL(PI_PROGR_H,
                                      VL_PROGR_D_T046,
                                      0,
                                      VL_COUNT_XIN_T046,
                                      VL_INS_T046,
                                      VL_COUNT_XIN_T046 - VL_INS_T046);
    --
    PKG_UTILS.LOG_END_DETAIL(PI_PROGR_H,
                                      VL_PROGR_D_T045,
                                      0,
                                      VL_COUNT_XIN_T045,
                                      VL_INS_T045,
                                      VL_COUNT_XIN_T045 - VL_INS_T045);
    --
    PKG_UTILS.LOG_END_DETAIL(PI_PROGR_H,
                                      VL_PROGR_D_TA4410,
                                      0,
                                      VL_COUNT_XIN_TA4410,
                                      VL_INS_TA4410,
                                      VL_COUNT_XIN_TA4410 - VL_INS_TA4410);
    --
    PKG_UTILS.LOG_END_DETAIL(PI_PROGR_H,
                                      VL_PROGR_D_T042,
                                      0,
                                      VL_COUNT_XIN_T042,
                                      VL_INS_T042,
                                      VL_COUNT_XIN_T042 - VL_INS_T042);
    --
    PKG_UTILS.LOG_END_DETAIL(PI_PROGR_H,
                                      VL_PROGR_D_T041,
                                      0,
                                      VL_COUNT_XIN_T041,
                                      VL_INS_T041,
                                      VL_COUNT_XIN_T041 - VL_INS_T041);
    --
    PKG_UTILS.LOG_END_DETAIL(PI_PROGR_H,
                                      VL_PROGR_D_T040,
                                      0,
                                      VL_COUNT_XIN_T040,
                                      VL_INS_T040,
                                      VL_COUNT_XIN_T040 - VL_INS_T040);


    PO_MSG    := VL_INS_T040||'/'||VL_COUNT_XIN_T040||' Customers loaded';
    PO_STATUS := VL_INS_T040;


    --
  EXCEPTION WHEN EX_EXIT THEN

          ROLLBACK;
          VL_MESSAGE_H       := VL_MESSAGE_H || TRIM(SUBSTR(dbms_utility.format_error_backtrace() || ' ' || SQLERRM, 1, 255));
          PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                                  VL_PROGR_D_T040,
                                                  SQLCODE,
                                                  VL_MESSAGE_H);

          PO_MSG := VL_MESSAGE_H;
          PO_STATUS := -1;

   WHEN OTHERS THEN

          ROLLBACK;

          BEGIN
              -- Release updated records
              UPDATE T040PARTY
              SET       DTELCK          = NULL,
                        IDSESSIONLCK    = NULL,
                        CODUSRLCK       = NULL
              WHERE CODUSRLCK = C_SYSUSR AND IDSESSIONLCK = PI_SESSION_ID;
              COMMIT;

             -- Moves records from staging area to log staging area
             P_XIN_MOVE_TO_LOG(PI_PROGR_H, VL_PROGR_D_T049,'T049PVCATEGORY');
             P_XIN_MOVE_TO_LOG(PI_PROGR_H, VL_PROGR_D_T047,'T047PARTYCONTACT');
             P_XIN_MOVE_TO_LOG(PI_PROGR_H, VL_PROGR_D_T046,'T046PARTYBANK');
             P_XIN_MOVE_TO_LOG(PI_PROGR_H, VL_PROGR_D_T045,'T045PARTYWEEK');
             P_XIN_MOVE_TO_LOG(PI_PROGR_H, VL_PROGR_D_TA4410,'TA4410NOTES_CUST');
             P_XIN_MOVE_TO_LOG(PI_PROGR_H, VL_PROGR_D_T042,'T042PARTYADDR');
             P_XIN_MOVE_TO_LOG(PI_PROGR_H, VL_PROGR_D_T041,'T041PARTYDIV');
             P_XIN_MOVE_TO_LOG(PI_PROGR_H, VL_PROGR_D_T040,'T040PARTY');

          END;

          VL_MESSAGE_H       := VL_MESSAGE_H || TRIM(SUBSTR(dbms_utility.format_error_backtrace() || ' ' || SQLERRM, 1, 255));
          PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                                  VL_PROGR_D_T040,
                                                  SQLCODE,
                                                  VL_MESSAGE_H);

          PO_MSG := VL_MESSAGE_H;
          PO_STATUS := VL_STATUS;

  END LOAD_T04X_CUSTOMERS;
  --





PROCEDURE LOAD_T04X_CUSTOMERS_INSERT(PI_PROGR_H       IN NUMBER,
                           PI_SESSION_ID    IN NUMBER,
                           PO_MSG           OUT NOCOPY VARCHAR2,
                           PO_STATUS        OUT NOCOPY NUMBER ) IS

    -- -----------------------------------------
    -- Cursor on main Customer table T040PARTY
    -- -----------------------------------------
    CURSOR CL_XIN_T040 IS
      SELECT
          *
        FROM  Z_XIN_T040PARTY
        WHERE SM1_CODPROCESS = PI_PROGR_H
        -- BEAWARE : his order is mandatory for a correct loading, if it is needed to change it, the whole procedure must be reviewed
        ORDER BY CODPARTY, SM1_DTECRE ASC;

    -- -------------------------------------
    -- Cursor on Division info T041PARTYDIV
    -- -------------------------------------
    CURSOR CL_XIN_T041(CI_CODPARTY VARCHAR2, CI_SM1_DTECRE DATE) IS
      SELECT *
        FROM Z_XIN_T041PARTYDIV
       WHERE CODPARTY = CI_CODPARTY
         AND SM1_CODPROCESS = PI_PROGR_H
         --AND SM1_DTECRE <= CI_SM1_DTECRE
         AND SM1_STATUS = C_XINSTATUS_OK -- Only those that have not processed yet (in case of double record in xin)
         ORDER BY SM1_DTECRE;

    -- -------------------------------------
    -- Cursor on Address info T042PARTYADDR
    -- -------------------------------------

    CURSOR CL_XIN_T042(CI_CODPARTY VARCHAR2, CI_SM1_DTECRE DATE) IS
      SELECT  *

        FROM Z_XIN_T042PARTYADDR
       WHERE CODPARTY = CI_CODPARTY
         AND SM1_CODPROCESS = PI_PROGR_H
         --AND SM1_DTECRE <= CI_SM1_DTECRE
         AND SM1_STATUS = C_XINSTATUS_OK -- Only those that have not processed yet (in case of double record in xin)
          ORDER BY SM1_DTECRE;

    -- -------------------------------------
    -- Cursor on Customer Notes Ta4410Notes
    -- -------------------------------------
    CURSOR CL_XIN_TA4410(CI_CODPARTY VARCHAR2, CI_SM1_DTECRE DATE) IS
      SELECT
         *

        FROM XIN_TA4410NOTES_CUST
       WHERE CODPARTY = CI_CODPARTY
         AND SM1_CODPROCESS = PI_PROGR_H
         --AND SM1_DTECRE <= CI_SM1_DTECRE
         AND SM1_STATUS = C_XINSTATUS_OK -- Only those that have not processed yet (in case of double record in xin)
          ORDER BY SM1_DTECRE;

    -- -------------------------------------
    -- Cursor on Weekly plan Info T046PartyBank
    -- -------------------------------------
    CURSOR CL_XIN_T045(CI_CODPARTY VARCHAR2, CI_CODDIV VARCHAR2, CI_SM1_DTECRE DATE) IS
      SELECT
          *
        FROM Z_XIN_T045PARTYWEEK
       WHERE CODPARTY = CI_CODPARTY
         AND CODDIV   = CI_CODDIV
         AND SM1_CODPROCESS = PI_PROGR_H
         --AND SM1_DTECRE <= CI_SM1_DTECRE
         AND SM1_STATUS = C_XINSTATUS_OK -- Only those that have not processed yet (in case of double record in xin)
          ORDER BY SM1_DTECRE;

    -- -------------------------------------
    -- Cursor on Bank Info T046PartyBank
    -- -------------------------------------

    CURSOR CL_XIN_T046(CI_CODPARTY VARCHAR2, CI_CODDIV VARCHAR2, CI_SM1_DTECRE DATE) IS
      SELECT
          *

        FROM Z_XIN_T046PARTYBANK
       WHERE CODPARTY = CI_CODPARTY
         AND CODDIV   = CI_CODDIV
         AND SM1_CODPROCESS = PI_PROGR_H
         --AND SM1_DTECRE <= CI_SM1_DTECRE
         AND SM1_STATUS = C_XINSTATUS_OK -- Only those that have not processed yet (in case of double record in xin)
          ORDER BY SM1_DTECRE;


    -- -------------------------------------
    -- Cursor on Contact Info T047PartyContact
    -- -------------------------------------

    CURSOR CL_XIN_T047(CI_CODPARTY VARCHAR2, CI_CODDIV VARCHAR2, CI_SM1_DTECRE DATE) IS
      SELECT
         *

        FROM Z_XIN_T047PARTYCONTACT
       WHERE CODPARTY = CI_CODPARTY
         AND CODDIV   = CI_CODDIV
         AND SM1_CODPROCESS = PI_PROGR_H
         --AND SM1_DTECRE <= CI_SM1_DTECRE
         AND SM1_STATUS = C_XINSTATUS_OK -- Only those that have not processed yet (in case of double record in xin)
          ORDER BY SM1_DTECRE;

    -- -------------------------------------
    -- Cursor on Category Info T049PVcategoru
    -- -------------------------------------

    CURSOR CL_XIN_T049(CI_CODPARTY VARCHAR2, CI_CODDIV VARCHAR2, CI_SM1_DTECRE DATE) IS
      SELECT
          *

        FROM Z_XIN_T049PVCATEGORY
       WHERE CODPARTY = CI_CODPARTY
         AND CODDIV   = CI_CODDIV
         AND SM1_CODPROCESS = PI_PROGR_H
         --AND SM1_DTECRE <= CI_SM1_DTECRE
         AND SM1_STATUS = C_XINSTATUS_OK -- Only those that have not processed yet (in case of double record in xin)
          ORDER BY SM1_DTECRE;


    --
    VL_MESSAGE_H   VARCHAR2(4000) := 'Error while loading CUSTOMERS T04X';
    VL_MESSAGE_D   VARCHAR2(4000) := NULL;
    --
    VL_PROGR_D_T040    NUMBER := 0;
    VL_COUNT_XIN_T040  NUMBER := 0;
    VL_INS_T040        NUMBER := 0;
    --
    VL_PROGR_D_T041    NUMBER := 0;
    VL_COUNT_XIN_T041  NUMBER := 0;
    VL_INS_T041        NUMBER := 0;
    --
    VL_PROGR_D_T042    NUMBER := 0;
    VL_COUNT_XIN_T042  NUMBER := 0;
    VL_INS_T042        NUMBER := 0;
    --
    VL_PROGR_D_TA4410    NUMBER := 0;
    VL_COUNT_XIN_TA4410  NUMBER := 0;
    VL_INS_TA4410        NUMBER := 0;
    --
    VL_PROGR_D_T045    NUMBER := 0;
    VL_COUNT_XIN_T045  NUMBER := 0;
    VL_INS_T045        NUMBER := 0;
    --
    VL_PROGR_D_T046    NUMBER := 0;
    VL_COUNT_XIN_T046  NUMBER := 0;
    VL_INS_T046        NUMBER := 0;
    --
    VL_PROGR_D_T047    NUMBER := 0;
    VL_COUNT_XIN_T047  NUMBER := 0;
    VL_INS_T047        NUMBER := 0;
    --
    VL_PROGR_D_T049    NUMBER := 0;
    VL_COUNT_XIN_T049  NUMBER := 0;
    VL_INS_T049        NUMBER := 0;
    --
    REC_T040 T040PARTY%ROWTYPE          := NULL;
    REC_T041 T041PARTYDIV%ROWTYPE       := NULL;
    REC_T042 T042PARTYADDR%ROWTYPE      := NULL;
    REC_TA4410 TA4410NOTES%ROWTYPE      := NULL;
    REC_T045 T045PARTYWEEK%ROWTYPE      := NULL;
    REC_T046 T046PARTYBANK%ROWTYPE      := NULL;
    REC_T047 T047PARTYCONTACT%ROWTYPE   := NULL;
    REC_T049 T049PVCATEGORY%ROWTYPE     := NULL;
    --
    REC_T040_INIT T040PARTY%ROWTYPE          := NULL;
    REC_T041_INIT T041PARTYDIV%ROWTYPE       := NULL;
    REC_T042_INIT T042PARTYADDR%ROWTYPE      := NULL;
    REC_TA4410_INIT TA4410NOTES%ROWTYPE      := NULL;
    REC_T045_INIT T045PARTYWEEK%ROWTYPE      := NULL;
    REC_T046_INIT T046PARTYBANK%ROWTYPE      := NULL;
    REC_T047_INIT T047PARTYCONTACT%ROWTYPE   := NULL;
    REC_T049_INIT T049PVCATEGORY%ROWTYPE     := NULL;
    --
    VL_DES_T040     X_FIELD_INFO_ARRAY;-- Array with fields db info
    VL_DES_T041     X_FIELD_INFO_ARRAY;-- Array with fields db info
    VL_DES_T042     X_FIELD_INFO_ARRAY;-- Array with fields db info
    VL_DES_TA4410   X_FIELD_INFO_ARRAY;-- Array with fields db info
    VL_DES_T045     X_FIELD_INFO_ARRAY;-- Array with fields db info
    VL_DES_T046     X_FIELD_INFO_ARRAY;-- Array with fields db info
    VL_DES_T047     X_FIELD_INFO_ARRAY;-- Array with fields db info
    VL_DES_T049     X_FIELD_INFO_ARRAY;-- Array with fields db info
    --
    VL_RECORD_LOCKED NUMBER := 0;
    VL_STATUS NUMBER:= 0;
    VL_COUNT  NUMBER:= 0;
    VL_STEP   NUMBER:= 0; -- Used to ping t035
    --
    VL_D_SM1_DTECRE DATE:= C_SM1_NULL_DATE;
    --
    EX_EXIT  EXCEPTION;
    --
    VL_CODDIV VARCHAR2(30) := NULL;

  BEGIN

     -- Rebuild indexes and compute statistics
    P_XIN_INIT_INDEXES (PI_PROGR_H, 'T040PARTY');
    P_XIN_INIT_INDEXES (PI_PROGR_H, 'T041PARTYDIV');
    P_XIN_INIT_INDEXES (PI_PROGR_H, 'T042PARTYADDR');
   -- P_XIN_INIT_INDEXES (PI_PROGR_H, 'TA4410NOTES_CUST');
    P_XIN_INIT_INDEXES (PI_PROGR_H, 'T045PARTYWEEK');
    P_XIN_INIT_INDEXES (PI_PROGR_H, 'T046PARTYBANK');
    P_XIN_INIT_INDEXES (PI_PROGR_H, 'T047PARTYCONTACT');
    P_XIN_INIT_INDEXES (PI_PROGR_H, 'T049PVCATEGORY');
    -- Clean up older log

    P_XIN_CLEANUP_LOG (PI_PROGR_H, 'T040PARTY');
    P_XIN_CLEANUP_LOG (PI_PROGR_H, 'T041PARTYDIV');
    P_XIN_CLEANUP_LOG (PI_PROGR_H, 'T042PARTYADDR');
    P_XIN_CLEANUP_LOG (PI_PROGR_H, 'TA4410NOTES_CUST');
    P_XIN_CLEANUP_LOG (PI_PROGR_H, 'T045PARTYWEEK');
    P_XIN_CLEANUP_LOG (PI_PROGR_H, 'T046PARTYBANK');
    P_XIN_CLEANUP_LOG (PI_PROGR_H, 'T047PARTYCONTACT');
    P_XIN_CLEANUP_LOG (PI_PROGR_H, 'T049PVCATEGORY');
    --

    VL_PROGR_D_T040 := PKG_UTILS.LOG_NEW_DETAIL(PI_PROGR_H,
                                                'CUSTOMER HEAD',
                                                'IMPORT --> T040PARTY',
                                                 0,
                                                 NULL);
    --
    VL_PROGR_D_T041 := PKG_UTILS.LOG_NEW_DETAIL(PI_PROGR_H,
                                                'CUSTOMER DIV INFO',
                                                 'IMPORT --> T041PARTYDIV',
                                                  0,
                                                   NULL);
    --
    VL_PROGR_D_T042 := PKG_UTILS.LOG_NEW_DETAIL(PI_PROGR_H,
                                                'CUSTOMER ADDR',
                                                 'IMPORT --> T042PARTYADDR',
                                                  0,
                                                  NULL);
   --
    VL_PROGR_D_TA4410 := PKG_UTILS.LOG_NEW_DETAIL(PI_PROGR_H,
                                                'CUSTOMER NOTES',
                                                 'IMPORT --> TA4410NOTES',
                                                  0,
                                                  NULL);
 --
    VL_PROGR_D_T045 := PKG_UTILS.LOG_NEW_DETAIL(PI_PROGR_H,
                                                'CUSTOMER WEEK PLAN',
                                                 'IMPORT --> T045PARTYWEEK',
                                                  0,
                                                  NULL);
 --
    VL_PROGR_D_T046 := PKG_UTILS.LOG_NEW_DETAIL(PI_PROGR_H,
                                                'CUSTOMER BANK INFO',
                                                 'IMPORT --> T046PARTYBANK',
                                                  0,
                                                  NULL);
 --
    VL_PROGR_D_T047 := PKG_UTILS.LOG_NEW_DETAIL(PI_PROGR_H,
                                                'CUSTOMER CONTACTS',
                                                 'IMPORT --> T047PARTYCONTACT',
                                                  0,
                                                  NULL);
 --
    VL_PROGR_D_T049 := PKG_UTILS.LOG_NEW_DETAIL(PI_PROGR_H,
                                                'CUSTOMER PV CATEGORY',
                                                 'IMPORT --> T049PVCATEGORY',
                                                  0,
                                                  NULL);

    BEGIN
        --
        -- ----------------------------------------------------------
        -- Init arrays with FIELD_NAME=LENGTH and FIELDNAME=SM1_DEFAULT for all fields of table
        -- ----------------------------------------------------------
        VL_DES_T040.DELETE;
        P_INIT_SM1_FIELD_ARRAY ('T040PARTY',VL_DES_T040, VL_STATUS, VL_MESSAGE_H);
        execute immediate ( GL_INIT_REC) INTO REC_T040_INIT;


        VL_DES_T041.DELETE;
        P_INIT_SM1_FIELD_ARRAY ('T041PARTYDIV',VL_DES_T041,VL_STATUS, VL_MESSAGE_H);
        execute immediate ( GL_INIT_REC) INTO REC_T041_INIT;

        VL_DES_T042.DELETE;
        P_INIT_SM1_FIELD_ARRAY ('T042PARTYADDR',VL_DES_T042,VL_STATUS, VL_MESSAGE_H);
        execute immediate ( GL_INIT_REC) INTO REC_T042_INIT;

        VL_DES_TA4410.DELETE;
        P_INIT_SM1_FIELD_ARRAY ('TA4410NOTES',VL_DES_TA4410,VL_STATUS, VL_MESSAGE_H);
        execute immediate ( GL_INIT_REC) INTO REC_TA4410_INIT;

        VL_DES_T045.DELETE;
        P_INIT_SM1_FIELD_ARRAY ('T045PARTYWEEK',VL_DES_T045,VL_STATUS, VL_MESSAGE_H);
        execute immediate ( GL_INIT_REC) INTO REC_T045_INIT;

        VL_DES_T046.DELETE;
        P_INIT_SM1_FIELD_ARRAY ( 'T046PARTYBANK',VL_DES_T046,VL_STATUS, VL_MESSAGE_H);
        execute immediate ( GL_INIT_REC) INTO REC_T046_INIT;

        VL_DES_T047.DELETE;
        P_INIT_SM1_FIELD_ARRAY ('T047PARTYCONTACT',VL_DES_T047,VL_STATUS, VL_MESSAGE_H);
        execute immediate ( GL_INIT_REC) INTO REC_T047_INIT;

        VL_DES_T049.DELETE;
        P_INIT_SM1_FIELD_ARRAY ('T049PVCATEGORY', VL_DES_T049,VL_STATUS, VL_MESSAGE_H);
        execute immediate ( GL_INIT_REC) INTO REC_T049_INIT;


        IF (VL_STATUS <> 0 ) THEN
            VL_MESSAGE_D := GL_INIT_REC;
            RAISE EX_EXIT;
        END IF;
    EXCEPTION WHEN OTHERS THEN
        VL_MESSAGE_D := GL_INIT_REC;
        RAISE EX_EXIT;
    END;



    -- --------------------------------------------------------------
    -- Identifies Xin records to be loaded
    -- --------------------------------------------------------------
    BEGIN
        VL_MESSAGE_D := 'Z_XIN_T040PARTY';
        UPDATE Z_XIN_T040PARTY
        SET SM1_CODPROCESS = PI_PROGR_H,
            SM1_STATUS = 0,
            SM1_DTEPROCESS = XSYSDATE
            WHERE NVL(SM1_CODPROCESS,0) = C_SM1_NULL_CODPROCESS;
          --  and CODPARTY IN ('IC20957', 'IC86244' ) ;
        VL_COUNT_XIN_T040 := SQL%ROWCOUNT;


        VL_MESSAGE_D := 'Z_XIN_T041PARTYDIV';
        UPDATE Z_XIN_T041PARTYDIV D
        SET D.SM1_CODPROCESS = PI_PROGR_H,
            D.SM1_STATUS = 0,
            D.SM1_DTEPROCESS = XSYSDATE
        WHERE D.CODPARTY IN (SELECT H.CODPARTY FROM Z_XIN_T040PARTY H WHERE H.SM1_CODPROCESS = PI_PROGR_H
    -- AND H.SM1_DTECRE >= D.SM1_DTECRE 
    )
        AND NVL(SM1_CODPROCESS,0) = C_SM1_NULL_CODPROCESS;
       VL_COUNT_XIN_T041 := SQL%ROWCOUNT;

        VL_MESSAGE_D := 'Z_XIN_T042PARTYADDR';
        UPDATE Z_XIN_T042PARTYADDR D
        SET D.SM1_CODPROCESS = PI_PROGR_H,
            D.SM1_STATUS = 0,
            D.SM1_DTEPROCESS = XSYSDATE
        WHERE D.CODPARTY IN (SELECT H.CODPARTY FROM Z_XIN_T040PARTY H WHERE H.SM1_CODPROCESS = PI_PROGR_H 
    -- AND H.SM1_DTECRE >= D.SM1_DTECRE
    )
        AND NVL(SM1_CODPROCESS,0) = C_SM1_NULL_CODPROCESS;
        VL_COUNT_XIN_T042 := SQL%ROWCOUNT;

        VL_MESSAGE_D := 'XIN_TA4410NOTES_CUST';
        UPDATE XIN_TA4410NOTES_CUST D
        SET D.SM1_CODPROCESS = PI_PROGR_H,
            D.SM1_STATUS = 0,
            D.SM1_DTEPROCESS = XSYSDATE
        WHERE D.CODPARTY IN (SELECT H.CODPARTY FROM Z_XIN_T040PARTY H WHERE H.SM1_CODPROCESS = PI_PROGR_H 
    --AND H.SM1_DTECRE >= D.SM1_DTECRE
    )
        AND NVL(SM1_CODPROCESS,0) = C_SM1_NULL_CODPROCESS;
        VL_COUNT_XIN_TA4410 := SQL%ROWCOUNT;

        VL_MESSAGE_D := 'Z_XIN_T045PARTYWEEK';
        UPDATE Z_XIN_T045PARTYWEEK D
        SET D.SM1_CODPROCESS = PI_PROGR_H,
            D.SM1_STATUS = 0,
            D.SM1_DTEPROCESS = XSYSDATE
        WHERE (D.CODPARTY, D.CODDIV) IN (SELECT H.CODPARTY, H.CODDIV FROM Z_XIN_T041PARTYDIV H WHERE H.SM1_CODPROCESS = PI_PROGR_H 
    --AND H.SM1_DTECRE >= D.SM1_DTECRE
    )
        AND NVL(SM1_CODPROCESS,0) = C_SM1_NULL_CODPROCESS;
        VL_COUNT_XIN_T045 := SQL%ROWCOUNT;

        VL_MESSAGE_D := 'Z_XIN_T046PARTYBANK';
        UPDATE Z_XIN_T046PARTYBANK D
        SET D.SM1_CODPROCESS = PI_PROGR_H,
            D.SM1_STATUS = 0,
            D.SM1_DTEPROCESS = XSYSDATE
        WHERE (D.CODPARTY, D.CODDIV) IN (SELECT H.CODPARTY, H.CODDIV FROM Z_XIN_T041PARTYDIV H WHERE H.SM1_CODPROCESS = PI_PROGR_H 
    --AND H.SM1_DTECRE >= D.SM1_DTECRE
    )
        AND NVL(SM1_CODPROCESS,0) = C_SM1_NULL_CODPROCESS;
        VL_COUNT_XIN_T046 := SQL%ROWCOUNT;

        VL_MESSAGE_D := 'Z_XIN_T047PARTYCONTACT';
        UPDATE Z_XIN_T047PARTYCONTACT D
        SET D.SM1_CODPROCESS = PI_PROGR_H,
            D.SM1_STATUS = 0,
            D.SM1_DTEPROCESS = XSYSDATE
        WHERE (D.CODPARTY, D.CODDIV) IN (SELECT H.CODPARTY, H.CODDIV FROM Z_XIN_T041PARTYDIV H WHERE H.SM1_CODPROCESS = PI_PROGR_H 
    --AND H.SM1_DTECRE >= D.SM1_DTECRE 
    )
        AND NVL(SM1_CODPROCESS,0) = C_SM1_NULL_CODPROCESS;
        VL_COUNT_XIN_T047 := SQL%ROWCOUNT;

        VL_MESSAGE_D := 'Z_XIN_T049PVCATEGORY';
        UPDATE Z_XIN_T049PVCATEGORY D
        SET D.SM1_CODPROCESS = PI_PROGR_H,
            D.SM1_STATUS = 0,
            D.SM1_DTEPROCESS = XSYSDATE
        WHERE (D.CODPARTY, D.CODDIV) IN (SELECT H.CODPARTY, H.CODDIV FROM Z_XIN_T041PARTYDIV H WHERE H.SM1_CODPROCESS = PI_PROGR_H 
    --AND H.SM1_DTECRE >= D.SM1_DTECRE
    )
        AND NVL(SM1_CODPROCESS,0) = C_SM1_NULL_CODPROCESS;
        VL_COUNT_XIN_T049 := SQL%ROWCOUNT;

    COMMIT;
    EXCEPTION WHEN OTHERS THEN
      ROLLBACK;
      VL_MESSAGE_H := 'Error while Reading Staging area: '||VL_MESSAGE_D;
      RAISE EX_EXIT;
    END;
    -- --------------------------------------------------------------
    -- loop in main table T040PARTY
    -- --------------------------------------------------------------
    FOR RL_XIN_T040 IN CL_XIN_T040 LOOP

      -- pings to t035 every 1000 cicles--
      VL_STEP := VL_STEP + 1;
      IF ( MOD(VL_STEP, 1000) = 0 ) THEN
         PKG_UTILS.user_ping(PI_SESSION_ID);
      END IF;

      --
      VL_STATUS := 0;
      VL_RECORD_LOCKED := 0;
      --
      VL_MESSAGE_H :=   'Customer: '||RL_XIN_T040.CODPARTY;
      --
      BEGIN --- HEAD T040

       -- Data Format Check
        VL_MESSAGE_D := 'Format Conversion ';
        VL_CODDIV:= 'ALL';
        REC_T040.CODPARTY := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T040.CODPARTY,'CODPARTY', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.DESPARTY1 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T040.DESPARTY1,'DESPARTY1', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.DESPARTY2 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T040.DESPARTY2,'DESPARTY2', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.CODSIGN := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T040.CODSIGN,'CODSIGN', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.CODNIELSENAREA := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T040.CODNIELSENAREA,'CODNIELSENAREA', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.CODZONE := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T040.CODZONE,'CODZONE', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.CODCHANNEL := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T040.CODCHANNEL,'CODCHANNEL', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.CODFIS := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T040.CODFIS,'CODFIS', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.CODVAT := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T040.CODVAT,'CODVAT', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.CODVATINTRA := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T040.CODVATINTRA,'CODVATINTRA', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.CODCAT1 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T040.CODCAT1,'CODCAT1', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.CODCAT2 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T040.CODCAT2,'CODCAT2', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.CODCAT3 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T040.CODCAT3,'CODCAT3', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.CODCAT4 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T040.CODCAT4,'CODCAT4', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.CODCAT5 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T040.CODCAT5,'CODCAT5', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.CODNATGIU := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T040.CODNATGIU,'CODNATGIU', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.FLGCUSTINV := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T040.FLGCUSTINV,'FLGCUSTINV', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.CODVATCERT := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T040.CODVATCERT,'CODVATCERT', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.FLGCUSTDELIV := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T040.FLGCUSTDELIV,'FLGCUSTDELIV', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.CODMODINVOICE := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T040.CODMODINVOICE,'CODMODINVOICE', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.FLGCUSTSALE := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T040.FLGCUSTSALE,'FLGCUSTSALE', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.FLGCUSTCONC := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T040.FLGCUSTCONC,'FLGCUSTCONC', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.CODMODDELREP := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T040.CODMODDELREP,'CODMODDELREP', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.CODCUSTINV := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T040.CODCUSTINV,'CODCUSTINV', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.CODCUSTDELIV := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T040.CODCUSTDELIV,'CODCUSTDELIV', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.CODCUSTCONC := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T040.CODCUSTCONC,'CODCUSTCONC', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.CODVATMGMT := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T040.CODVATMGMT,'CODVATMGMT', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.CODCUR := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T040.CODCUR,'CODCUR', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.CODADJGROUP := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T040.CODADJGROUP,'CODADJGROUP', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.VALCREDIT := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T040.VALCREDIT,'VALCREDIT', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.DTEMODCREDIT := F_CHECK_FORMAT_D( VL_CODDIV,  RL_XIN_T040.DTEMODCREDIT,'DTEMODCREDIT', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.FLGANN := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T040.FLGANN,'FLGANN', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.CODCUSTXTEL := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T040.CODCUSTXTEL,'CODCUSTXTEL', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.DTEVALIDSTART := F_CHECK_FORMAT_D( VL_CODDIV,  RL_XIN_T040.DTEVALIDSTART,'DTEVALIDSTART', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        IF (REC_T040.DTEVALIDSTART IS NULL) THEN
            REC_T040.DTEVALIDSTART := C_SM1_FROM_DATE; -- Presence of dtevalid start is mandatory for customer navigator
        END IF;
        REC_T040.PRGDELIVERY := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T040.PRGDELIVERY,'PRGDELIVERY', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.FLGVIRTUAL := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T040.FLGVIRTUAL,'FLGVIRTUAL', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.RIFERIMENTO_INTERNO := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T040.RIFERIMENTO_INTERNO,'RIFERIMENTO_INTERNO', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.DTESTARTESENZIONE := F_CHECK_FORMAT_D( VL_CODDIV,  RL_XIN_T040.DTESTARTESENZIONE,'DTESTARTESENZIONE', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.DTEENDESENZIONE := F_CHECK_FORMAT_D( VL_CODDIV,  RL_XIN_T040.DTEENDESENZIONE,'DTEENDESENZIONE', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.NUMESENZIONE := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T040.NUMESENZIONE,'NUMESENZIONE', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.VALEXPOSED := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T040.VALEXPOSED,'VALEXPOSED', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.FLGDTEORD := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T040.FLGDTEORD,'FLGDTEORD', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.EMAIL := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T040.EMAIL,'EMAIL', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.CODCLUSTER := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T040.CODCLUSTER,'CODCLUSTER', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.CODCLUSTERCUST := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T040.CODCLUSTERCUST,'CODCLUSTERCUST', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.CODCLUSTERINT := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T040.CODCLUSTERINT,'CODCLUSTERINT', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.TOTSALESSURFACE := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T040.TOTSALESSURFACE,'TOTSALESSURFACE', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.TOTFOODSURFACE := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T040.TOTFOODSURFACE,'TOTFOODSURFACE', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.GLOBALINDEXPOT := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T040.GLOBALINDEXPOT,'GLOBALINDEXPOT', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.NUMCASSE := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T040.NUMCASSE,'NUMCASSE', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.NUMCASSEATTR := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T040.NUMCASSEATTR,'NUMCASSEATTR', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.NUMADDETTI := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T040.NUMADDETTI,'NUMADDETTI', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.CODNIELSENPARTY := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T040.CODNIELSENPARTY,'CODNIELSENPARTY', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.DESCEDEC := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T040.DESCEDEC,'DESCEDEC', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.QTYLINEARI := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T040.QTYLINEARI,'QTYLINEARI', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.TOTNONFOODSURFACE := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T040.TOTNONFOODSURFACE,'TOTNONFOODSURFACE', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.FLGDOCTOR := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T040.FLGDOCTOR,'FLGDOCTOR', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.FLGSTRUCTURE := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T040.FLGSTRUCTURE,'FLGSTRUCTURE', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.CODACTIVITYDOTT := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T040.CODACTIVITYDOTT,'CODACTIVITYDOTT', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.CODDEGREE := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T040.CODDEGREE,'CODDEGREE', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.CODIMP := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T040.CODIMP,'CODIMP', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.CODOCCUPATION := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T040.CODOCCUPATION,'CODOCCUPATION', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.CODSPECIALIZATION := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T040.CODSPECIALIZATION,'CODSPECIALIZATION', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.CODSPECIALIZATION2 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T040.CODSPECIALIZATION2,'CODSPECIALIZATION2', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.CODTYPESTRUCTURE := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T040.CODTYPESTRUCTURE,'CODTYPESTRUCTURE', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.FLGAPPOINTMENT := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T040.FLGAPPOINTMENT,'FLGAPPOINTMENT', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.CODGENDER := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T040.CODGENDER,'CODGENDER', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.CODSEASON := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T040.CODSEASON,'CODSEASON', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.CODSEASONSTART := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T040.CODSEASONSTART,'CODSEASONSTART', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.CODCLOSESTART := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T040.CODCLOSESTART,'CODCLOSESTART', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.CODCLOSEEND := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T040.CODCLOSEEND,'CODCLOSEEND', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.CODSEASONEND := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T040.CODSEASONEND,'CODSEASONEND', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.FLGPHARMACY := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T040.FLGPHARMACY,'FLGPHARMACY', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.CODMINISTERIAL := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T040.CODMINISTERIAL,'CODMINISTERIAL', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.CODTURNOVER := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T040.CODTURNOVER,'CODTURNOVER', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.NUMWINDOWS := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T040.NUMWINDOWS,'NUMWINDOWS', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.CODPRESCRIPTION := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T040.CODPRESCRIPTION,'CODPRESCRIPTION', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.CODCOLLEGE := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T040.CODCOLLEGE,'CODCOLLEGE', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.CODOPINIONLEAD := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T040.CODOPINIONLEAD,'CODOPINIONLEAD', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.CODPUBBLICATION := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T040.CODPUBBLICATION,'CODPUBBLICATION', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.CODPROFESSIONALMAGAZINE := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T040.CODPROFESSIONALMAGAZINE,'CODPROFESSIONALMAGAZINE', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.FLGCUSTPAYER := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T040.FLGCUSTPAYER,'FLGCUSTPAYER', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.FLGCUSTBILLTO := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T040.FLGCUSTBILLTO,'FLGCUSTBILLTO', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.CODCUSTPAYER := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T040.CODCUSTPAYER,'CODCUSTPAYER', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.FLGPERSON := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T040.FLGPERSON,'FLGPERSON', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.CODTITLE := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T040.CODTITLE,'CODTITLE', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.DESNOTE := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T040.DESNOTE,'DESNOTE', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.DTEBIRTHDAY := F_CHECK_FORMAT_D( VL_CODDIV, RL_XIN_T040.DTEBIRTHDAY,'DTEBIRTHDAY', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);

        REC_T040.FLGCUSTWHS := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T040.FLGCUSTWHS,'FLGCUSTWHS', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        REC_T040.FLGCUSTVAN := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T040.FLGCUSTVAN,'FLGCUSTVAN', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);
        --- New Customised fields for DAL
        REC_T040.Z_FLGEXTERNAL := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T040.Z_FLGEXTERNAL,'Z_FLGEXTERNAL', VL_DES_T040,VL_STATUS, VL_MESSAGE_D);

        --- Technical fields
        REC_T040.DTECRE     := XSYSDATE;
        REC_T040.CODUSRMOD  := C_SYSUSR;
        REC_T040.CODUSRMODREAL  := C_SYSUSR;
        REC_T040.CODUSRCREREAL  := C_SYSUSR;
        REC_T040.DTEMOD     := XSYSDATE;
        -- lock fields
        REC_T040.CODUSRLCK     := C_SYSUSR;
        REC_T040.IDSESSIONLCK  := PI_SESSION_ID;
        REC_T040.DTELCK        := XSYSDATE;
        -- DocumentKey
        REC_T040.DOCUMENTKEY   := PKG_UTILS.documentkey_for_t040(REC_T040.CODPARTY);
        IF (VL_STATUS <> 0 ) THEN

         VL_MESSAGE_H := SUBSTR(VL_MESSAGE_H||' '||VL_MESSAGE_D||' '||dbms_utility.format_error_backtrace() || ' ' || SQLERRM,1,4000);

             PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                           VL_PROGR_D_T040,
                                           SQLCODE,
                                           VL_MESSAGE_H);
        END IF;

        IF (VL_STATUS = 0 ) THEN
          -- when status <> 0 some fields have incorrect format. Log t800 has been already wrote by F_CHECK function

          VL_COUNT := 0;
          SELECT COUNT(*) INTO VL_COUNT FROM T040PARTY
           WHERE CODPARTY = REC_T040.CODPARTY;

          IF ( VL_COUNT = 0 ) THEN
              VL_MESSAGE_D := 'Insert T040Party ';
              -- Record does not exists, we insert it
              INSERT INTO T040PARTY VALUES REC_T040;
           ELSE
            VL_STATUS := -1;
            VL_RECORD_LOCKED := -1;
            PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                           VL_PROGR_D_T040,
                                           SQLCODE,
                                           'Record is locked; import has failed :'||VL_MESSAGE_H);

          END IF; -- Record has been inserted
       
        

        END IF; -- VL_STATUS = 0

        EXCEPTION WHEN OTHERS THEN
             VL_STATUS := -1;
             VL_MESSAGE_H := SUBSTR(VL_MESSAGE_H||' '||VL_MESSAGE_D||' '||dbms_utility.format_error_backtrace() || ' ' || SQLERRM,1,4000);

             PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                           VL_PROGR_D_T040,
                                           SQLCODE,
                                           VL_MESSAGE_H);
        END; -- HEAD T040

        -- -----------------------------------
        -- T041PARTYDIV DIVISION INFO
        -- -----------------------------------
        BEGIN
        --
        IF ( VL_STATUS = 0  ) THEN
              -- Division info T041PARTYDIV

              FOR RL_XIN_T041 IN CL_XIN_T041(RL_XIN_T040.CODPARTY, RL_XIN_T040.SM1_DTECRE) LOOP

                VL_MESSAGE_H := 'Customer: '|| RL_XIN_T041.CODPARTY || '/' ||
                                'Division: '|| RL_XIN_T041.CODDIV;

                VL_MESSAGE_D := 'Format Conversion ';
                VL_CODDIV:= RL_XIN_T041.CODDIV;
                REC_T041.CODPARTY := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T041.CODPARTY,'CODPARTY', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.CODDIV := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T041.CODDIV,'CODDIV', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.CODUSR1 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T041.CODUSR1,'CODUSR1', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.CODPAYMOD := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T041.CODPAYMOD,'CODPAYMOD', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.CODPAYTRM := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T041.CODPAYTRM,'CODPAYTRM', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.CODABC := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T041.CODABC,'CODABC', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.CODASS := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T041.CODASS,'CODASS', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.FLGALTART := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T041.FLGALTART,'FLGALTART', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.CODSTATPARTY := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T041.CODSTATPARTY,'CODSTATPARTY', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.CODSHIPPER := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T041.CODSHIPPER,'CODSHIPPER', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.FLGORDEREXTRACT := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T041.FLGORDEREXTRACT,'FLGORDEREXTRACT', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.CODBLCCAUSE := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T041.CODBLCCAUSE,'CODBLCCAUSE', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.FLGLINEEXTRACT := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T041.FLGLINEEXTRACT,'FLGLINEEXTRACT', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.CODSTATUS := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T041.CODSTATUS,'CODSTATUS', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.MINORDVAL := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T041.MINORDVAL,'MINORDVAL', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.MAXORDVAL := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T041.MAXORDVAL,'MAXORDVAL', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.VALSCO1 := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T041.VALSCO1,'VALSCO1', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.VALSCO2 := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T041.VALSCO2,'VALSCO2', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.VALSCO3 := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T041.VALSCO3,'VALSCO3', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.VALSCO4 := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T041.VALSCO4,'VALSCO4', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.VALSCO5 := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T041.VALSCO5,'VALSCO5', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.FLGACCBKORD := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T041.FLGACCBKORD,'FLGACCBKORD', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.CODWHS := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T041.CODWHS,'CODWHS', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.NUMTRASPDAYS := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T041.NUMTRASPDAYS,'NUMTRASPDAYS', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.FLGACPSALPRICE := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T041.FLGACPSALPRICE,'FLGACPSALPRICE', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.CODCATDIV1 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T041.CODCATDIV1,'CODCATDIV1', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.CODCATDIV2 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T041.CODCATDIV2,'CODCATDIV2', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.CODCATDIV3 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T041.CODCATDIV3,'CODCATDIV3', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.CODCATDIV4 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T041.CODCATDIV4,'CODCATDIV4', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.CODCATDIV5 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T041.CODCATDIV5,'CODCATDIV5', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.CODUSR3 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T041.CODUSR3,'CODUSR3', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.CODUSR2 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T041.CODUSR2,'CODUSR2', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.CODUSR4 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T041.CODUSR4,'CODUSR4', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.CODUSR6 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T041.CODUSR6,'CODUSR6', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.CODUSR5 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T041.CODUSR5,'CODUSR5', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.CODDISCLIS1 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T041.CODDISCLIS1,'CODDISCLIS1', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.CODDISCLIS2 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T041.CODDISCLIS2,'CODDISCLIS2', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.CODDISCLIS3 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T041.CODDISCLIS3,'CODDISCLIS3', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.CODDISCLIS4 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T041.CODDISCLIS4,'CODDISCLIS4', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.CODDISCLIS5 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T041.CODDISCLIS5,'CODDISCLIS5', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.CODMODSHIP := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T041.CODMODSHIP,'CODMODSHIP', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.CODMODDEL := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T041.CODMODDEL,'CODMODDEL', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.CODENDUSERLIS := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T041.CODENDUSERLIS,'CODENDUSERLIS', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.CODDISCLISMAX := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T041.CODDISCLISMAX,'CODDISCLISMAX', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.CODDISCLISBLK := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T041.CODDISCLISBLK,'CODDISCLISBLK', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.CODLIST := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T041.CODLIST,'CODLIST', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.FLGANN := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T041.FLGANN,'FLGANN', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.QTYORDMIN := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T041.QTYORDMIN,'QTYORDMIN', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.QTYORDMAX := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T041.QTYORDMAX,'QTYORDMAX', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.UMORDQTY := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T041.UMORDQTY,'UMORDQTY', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.CODSUBSTPARTY := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T041.CODSUBSTPARTY,'CODSUBSTPARTY', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.DTEEND := F_CHECK_FORMAT_D( VL_CODDIV,  RL_XIN_T041.DTEEND,'DTEEND', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.CODSUPPLIER := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T041.CODSUPPLIER,'CODSUPPLIER', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.CODUSRCORR := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T041.CODUSRCORR,'CODUSRCORR', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.CODSUPPLIER1 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T041.CODSUPPLIER1,'CODSUPPLIER1', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.CODSUPPLIER2 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T041.CODSUPPLIER2,'CODSUPPLIER2', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.COD_ATTR_PROIEZIONI := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T041.COD_ATTR_PROIEZIONI,'COD_ATTR_PROIEZIONI', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.CODTYPCONTE := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T041.CODTYPCONTE,'CODTYPCONTE', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.CODTYPEVASION := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T041.CODTYPEVASION,'CODTYPEVASION', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.FLAG_BLOCK_LIQ := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T041.FLAG_BLOCK_LIQ,'FLAG_BLOCK_LIQ', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.EC_AGENTE := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T041.EC_AGENTE,'EC_AGENTE', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.CODSTOREFORMAT := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T041.CODSTOREFORMAT,'CODSTOREFORMAT', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.CODCUSTDELIV := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T041.CODCUSTDELIV,'CODCUSTDELIV', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.CODCUSTDELIV2 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T041.CODCUSTDELIV2,'CODCUSTDELIV2', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.FLGASSOVERIFY := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T041.FLGASSOVERIFY,'FLGASSOVERIFY', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.FLGPROMOVERIFY := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T041.FLGPROMOVERIFY,'FLGPROMOVERIFY', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.CODPANEL := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T041.CODPANEL,'CODPANEL', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.INDEXPOT := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T041.INDEXPOT,'INDEXPOT', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.CODDISCLIS6 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T041.CODDISCLIS6,'CODDISCLIS6', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.CODDISCLIS7 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T041.CODDISCLIS7,'CODDISCLIS7', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.FLGAUTH := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T041.FLGAUTH,'FLGAUTH', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.DTESUBSTPARTY := F_CHECK_FORMAT_D( VL_CODDIV,  RL_XIN_T041.DTESUBSTPARTY,'DTESUBSTPARTY', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.CODVISITFREQUENCE := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T041.CODVISITFREQUENCE,'CODVISITFREQUENCE', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.CODCLUSTER := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T041.CODCLUSTER,'CODCLUSTER', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.CODCLUSTERCUST := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T041.CODCLUSTERCUST,'CODCLUSTERCUST', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.CODCLUSTERINT := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T041.CODCLUSTERINT,'CODCLUSTERINT', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.FLGENCASHMENT := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T041.FLGENCASHMENT,'FLGENCASHMENT', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.IDEVALASSORTMENT      := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T041.IDEVALASSORTMENT,'IDEVALASSORTMENT', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.IDEVALPRICELIST       := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T041.IDEVALPRICELIST,'IDEVALPRICELIST', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.IDEVALDISCOUNTLIST    := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T041.IDEVALDISCOUNTLIST,'IDEVALDISCOUNTLIST', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.DTEEVALASSO           := F_CHECK_FORMAT_D( VL_CODDIV,  RL_XIN_T041.DTEEVALASSO,'DTEEVALASSO', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.CODUSR1ERP            := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T041.CODUSR1ERP,'CODUSR1ERP', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);

                REC_T041.FLG_DSD_PRINT_PRICES  := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T041.FLG_DSD_PRINT_PRICES ,'FLG_DSD_PRINT_PRICES', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.FLG_DSD_BLK_PAYTRM    := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T041.FLG_DSD_BLK_PAYTRM,'FLG_DSD_BLK_PAYTRM', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.DSD_CODBLK_VALCREDIT  := F_CHECK_FORMAT_S( VL_CODDIV,  RL_XIN_T041.DSD_CODBLK_VALCREDIT,'DSD_CODBLK_VALCREDIT', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.FLG_DSD_PAPARLESS     := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T041.FLG_DSD_PAPARLESS,'FLG_DSD_PAPARLESS', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.CODAVAILABILITY       := F_CHECK_FORMAT_S( VL_CODDIV,  RL_XIN_T041.CODAVAILABILITY,'CODAVAILABILITY', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);

                REC_T041.CODPAYMOD2            := F_CHECK_FORMAT_S( VL_CODDIV,  RL_XIN_T041.CODPAYMOD2,'CODPAYMOD2', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);
                REC_T041.CODPAYTRM2            := F_CHECK_FORMAT_S( VL_CODDIV,  RL_XIN_T041.CODPAYTRM2,'CODPAYTRM2', VL_DES_T041,VL_STATUS, VL_MESSAGE_D);

                 IF (VL_STATUS <> 0 ) THEN
                   VL_MESSAGE_H := SUBSTR(VL_MESSAGE_H||' '||VL_MESSAGE_D||' '||dbms_utility.format_error_backtrace() || ' ' || SQLERRM,1,4000);
                   PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                           VL_PROGR_D_T041,
                                           SQLCODE,
                                           VL_MESSAGE_H);
                 END IF;

                IF (VL_STATUS = 0 ) THEN
                --
                VL_MESSAGE_D := 'Update T041 ';
                UPDATE T041PARTYDIV
                   SET
                     -- CODUSR1 = CASE VL_DES_T041('CODUSR1.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.CODUSR1 ELSE CODUSR1 END,
                      CODPAYMOD = CASE VL_DES_T041('CODPAYMOD.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.CODPAYMOD ELSE CODPAYMOD END,

                      CODPAYTRM = CASE VL_DES_T041('CODPAYTRM.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.CODPAYTRM ELSE CODPAYTRM END
                      /*CODABC = CASE VL_DES_T041('CODABC.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.CODABC ELSE CODABC END,
                      CODASS = CASE VL_DES_T041('CODASS.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.CODASS ELSE CODASS END,
                      FLGALTART = CASE VL_DES_T041('FLGALTART.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.FLGALTART ELSE FLGALTART END,
                      CODSTATPARTY = CASE VL_DES_T041('CODSTATPARTY.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.CODSTATPARTY ELSE CODSTATPARTY END,
                      CODSHIPPER = CASE VL_DES_T041('CODSHIPPER.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.CODSHIPPER ELSE CODSHIPPER END,
                      FLGORDEREXTRACT = CASE VL_DES_T041('FLGORDEREXTRACT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.FLGORDEREXTRACT ELSE FLGORDEREXTRACT END,
                      CODBLCCAUSE = CASE VL_DES_T041('CODBLCCAUSE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.CODBLCCAUSE ELSE CODBLCCAUSE END,
                      FLGLINEEXTRACT = CASE VL_DES_T041('FLGLINEEXTRACT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.FLGLINEEXTRACT ELSE FLGLINEEXTRACT END,
                      CODSTATUS = CASE VL_DES_T041('CODSTATUS.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.CODSTATUS ELSE CODSTATUS END,
                      MINORDVAL = CASE VL_DES_T041('MINORDVAL.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.MINORDVAL ELSE MINORDVAL END,
                      MAXORDVAL = CASE VL_DES_T041('MAXORDVAL.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.MAXORDVAL ELSE MAXORDVAL END,
                      VALSCO1 = CASE VL_DES_T041('VALSCO1.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.VALSCO1 ELSE VALSCO1 END,
                      VALSCO2 = CASE VL_DES_T041('VALSCO2.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.VALSCO2 ELSE VALSCO2 END,
                      VALSCO3 = CASE VL_DES_T041('VALSCO3.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.VALSCO3 ELSE VALSCO3 END,
                      VALSCO4 = CASE VL_DES_T041('VALSCO4.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.VALSCO4 ELSE VALSCO4 END,
                      VALSCO5 = CASE VL_DES_T041('VALSCO5.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.VALSCO5 ELSE VALSCO5 END,
                      FLGACCBKORD = CASE VL_DES_T041('FLGACCBKORD.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.FLGACCBKORD ELSE FLGACCBKORD END,
                      CODWHS = CASE VL_DES_T041('CODWHS.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.CODWHS ELSE CODWHS END,
                      NUMTRASPDAYS = CASE VL_DES_T041('NUMTRASPDAYS.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.NUMTRASPDAYS ELSE NUMTRASPDAYS END,
                      FLGACPSALPRICE = CASE VL_DES_T041('FLGACPSALPRICE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.FLGACPSALPRICE ELSE FLGACPSALPRICE END,
                      CODCATDIV1 = CASE VL_DES_T041('CODCATDIV1.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.CODCATDIV1 ELSE CODCATDIV1 END,
                      CODCATDIV2 = CASE VL_DES_T041('CODCATDIV2.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.CODCATDIV2 ELSE CODCATDIV2 END,
                      CODCATDIV3 = CASE VL_DES_T041('CODCATDIV3.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.CODCATDIV3 ELSE CODCATDIV3 END,
                      CODCATDIV4 = CASE VL_DES_T041('CODCATDIV4.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.CODCATDIV4 ELSE CODCATDIV4 END,
                      CODCATDIV5 = CASE VL_DES_T041('CODCATDIV5.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.CODCATDIV5 ELSE CODCATDIV5 END,
                      CODUSR3 = CASE VL_DES_T041('CODUSR3.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.CODUSR3 ELSE CODUSR3 END,
                      CODUSR2 = CASE VL_DES_T041('CODUSR2.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.CODUSR2 ELSE CODUSR2 END,
                      CODUSR4 = CASE VL_DES_T041('CODUSR4.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.CODUSR4 ELSE CODUSR4 END,
                      CODUSR6 = CASE VL_DES_T041('CODUSR6.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.CODUSR6 ELSE CODUSR6 END,
                      CODUSR5 = CASE VL_DES_T041('CODUSR5.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.CODUSR5 ELSE CODUSR5 END,
                      CODDISCLIS1 = CASE VL_DES_T041('CODDISCLIS1.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.CODDISCLIS1 ELSE CODDISCLIS1 END,
                      CODDISCLIS2 = CASE VL_DES_T041('CODDISCLIS2.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.CODDISCLIS2 ELSE CODDISCLIS2 END,
                      CODDISCLIS3 = CASE VL_DES_T041('CODDISCLIS3.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.CODDISCLIS3 ELSE CODDISCLIS3 END,
                      CODDISCLIS4 = CASE VL_DES_T041('CODDISCLIS4.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.CODDISCLIS4 ELSE CODDISCLIS4 END,
                      CODDISCLIS5 = CASE VL_DES_T041('CODDISCLIS5.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.CODDISCLIS5 ELSE CODDISCLIS5 END,
                      CODMODSHIP = CASE VL_DES_T041('CODMODSHIP.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.CODMODSHIP ELSE CODMODSHIP END,
                      CODMODDEL = CASE VL_DES_T041('CODMODDEL.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.CODMODDEL ELSE CODMODDEL END,
                      CODENDUSERLIS = CASE VL_DES_T041('CODENDUSERLIS.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.CODENDUSERLIS ELSE CODENDUSERLIS END,
                      CODDISCLISMAX = CASE VL_DES_T041('CODDISCLISMAX.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.CODDISCLISMAX ELSE CODDISCLISMAX END,
                      CODDISCLISBLK = CASE VL_DES_T041('CODDISCLISBLK.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.CODDISCLISBLK ELSE CODDISCLISBLK END,
                      CODLIST = CASE VL_DES_T041('CODLIST.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.CODLIST ELSE CODLIST END,
                      FLGANN = CASE VL_DES_T041('FLGANN.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.FLGANN ELSE FLGANN END,
                      QTYORDMIN = CASE VL_DES_T041('QTYORDMIN.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.QTYORDMIN ELSE QTYORDMIN END,
                      QTYORDMAX = CASE VL_DES_T041('QTYORDMAX.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.QTYORDMAX ELSE QTYORDMAX END,
                      UMORDQTY = CASE VL_DES_T041('UMORDQTY.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.UMORDQTY ELSE UMORDQTY END,
                      CODSUBSTPARTY = CASE VL_DES_T041('CODSUBSTPARTY.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.CODSUBSTPARTY ELSE CODSUBSTPARTY END,
                      DTEEND = CASE VL_DES_T041('DTEEND.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.DTEEND ELSE DTEEND END,
                      CODSUPPLIER = CASE VL_DES_T041('CODSUPPLIER.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.CODSUPPLIER ELSE CODSUPPLIER END,
                      CODUSRCORR = CASE VL_DES_T041('CODUSRCORR.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.CODUSRCORR ELSE CODUSRCORR END,
                      CODSUPPLIER1 = CASE VL_DES_T041('CODSUPPLIER1.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.CODSUPPLIER1 ELSE CODSUPPLIER1 END,
                      CODSUPPLIER2 = CASE VL_DES_T041('CODSUPPLIER2.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.CODSUPPLIER2 ELSE CODSUPPLIER2 END,
                      COD_ATTR_PROIEZIONI = CASE VL_DES_T041('COD_ATTR_PROIEZIONI.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.COD_ATTR_PROIEZIONI ELSE COD_ATTR_PROIEZIONI END,
                      CODTYPCONTE = CASE VL_DES_T041('CODTYPCONTE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.CODTYPCONTE ELSE CODTYPCONTE END,
                      CODTYPEVASION = CASE VL_DES_T041('CODTYPEVASION.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.CODTYPEVASION ELSE CODTYPEVASION END,
                      FLAG_BLOCK_LIQ = CASE VL_DES_T041('FLAG_BLOCK_LIQ.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.FLAG_BLOCK_LIQ ELSE FLAG_BLOCK_LIQ END,
                      EC_AGENTE = CASE VL_DES_T041('EC_AGENTE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.EC_AGENTE ELSE EC_AGENTE END,
                      CODSTOREFORMAT = CASE VL_DES_T041('CODSTOREFORMAT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.CODSTOREFORMAT ELSE CODSTOREFORMAT END,
                      CODCUSTDELIV = CASE VL_DES_T041('CODCUSTDELIV.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.CODCUSTDELIV ELSE CODCUSTDELIV END,
                      CODCUSTDELIV2 = CASE VL_DES_T041('CODCUSTDELIV2.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.CODCUSTDELIV2 ELSE CODCUSTDELIV2 END,
                      FLGASSOVERIFY = CASE VL_DES_T041('FLGASSOVERIFY.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.FLGASSOVERIFY ELSE FLGASSOVERIFY END,
                      FLGPROMOVERIFY = CASE VL_DES_T041('FLGPROMOVERIFY.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.FLGPROMOVERIFY ELSE FLGPROMOVERIFY END,
                      CODPANEL = CASE VL_DES_T041('CODPANEL.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.CODPANEL ELSE CODPANEL END,
                      INDEXPOT = CASE VL_DES_T041('INDEXPOT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.INDEXPOT ELSE INDEXPOT END,
                      CODDISCLIS6 = CASE VL_DES_T041('CODDISCLIS6.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.CODDISCLIS6 ELSE CODDISCLIS6 END,
                      CODDISCLIS7 = CASE VL_DES_T041('CODDISCLIS7.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.CODDISCLIS7 ELSE CODDISCLIS7 END,
                      FLGAUTH = CASE VL_DES_T041('FLGAUTH.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.FLGAUTH ELSE FLGAUTH END,
                      DTESUBSTPARTY = CASE VL_DES_T041('DTESUBSTPARTY.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.DTESUBSTPARTY ELSE DTESUBSTPARTY END,
                      CODVISITFREQUENCE = CASE VL_DES_T041('CODVISITFREQUENCE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.CODVISITFREQUENCE ELSE CODVISITFREQUENCE END,
                      CODCLUSTER = CASE VL_DES_T041('CODCLUSTER.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.CODCLUSTER ELSE CODCLUSTER END,
                      CODCLUSTERCUST = CASE VL_DES_T041('CODCLUSTERCUST.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.CODCLUSTERCUST ELSE CODCLUSTERCUST END,
                      CODCLUSTERINT = CASE VL_DES_T041('CODCLUSTERINT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.CODCLUSTERINT ELSE CODCLUSTERINT END,
                      FLGENCASHMENT = CASE VL_DES_T041('FLGENCASHMENT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.FLGENCASHMENT ELSE FLGENCASHMENT END,
                      IDEVALASSORTMENT = CASE VL_DES_T041('IDEVALASSORTMENT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.IDEVALASSORTMENT ELSE IDEVALASSORTMENT END,
                      IDEVALPRICELIST = CASE VL_DES_T041('IDEVALPRICELIST.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.IDEVALPRICELIST ELSE IDEVALPRICELIST END,
                      IDEVALDISCOUNTLIST = CASE VL_DES_T041('IDEVALDISCOUNTLIST.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.IDEVALDISCOUNTLIST ELSE IDEVALDISCOUNTLIST END,
                      DTEEVALASSO = CASE VL_DES_T041('DTEEVALASSO.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.DTEEVALASSO ELSE DTEEVALASSO END,
                      CODUSR1ERP = CASE VL_DES_T041('CODUSR1ERP.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.CODUSR1ERP ELSE CODUSR1ERP END,

                      FLG_DSD_PRINT_PRICES = CASE VL_DES_T041('FLG_DSD_PRINT_PRICES.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.FLG_DSD_PRINT_PRICES ELSE FLG_DSD_PRINT_PRICES END,
                      FLG_DSD_BLK_PAYTRM   = CASE VL_DES_T041('FLG_DSD_BLK_PAYTRM.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.FLG_DSD_BLK_PAYTRM ELSE FLG_DSD_BLK_PAYTRM END,
                      DSD_CODBLK_VALCREDIT = CASE VL_DES_T041('DSD_CODBLK_VALCREDIT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.DSD_CODBLK_VALCREDIT ELSE DSD_CODBLK_VALCREDIT END,
                      FLG_DSD_PAPARLESS    = CASE VL_DES_T041('FLG_DSD_PAPARLESS.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.FLG_DSD_PAPARLESS ELSE FLG_DSD_PAPARLESS END,
                      CODAVAILABILITY      = CASE VL_DES_T041('CODAVAILABILITY.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.CODAVAILABILITY ELSE CODAVAILABILITY END,

                      CODPAYMOD2      = CASE VL_DES_T041('CODPAYMOD2.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.CODPAYMOD2 ELSE CODPAYMOD2 END,
                      CODPAYTRM2      = CASE VL_DES_T041('CODPAYTRM2.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T041.CODPAYTRM2 ELSE CODPAYTRM2 END
*/

                -- WHERE CODPARTY = REC_T041.CODPARTY
                WHERE TRIM(CODCATDIV1)= REC_T041.CODPARTY
                   AND CODDIV   = REC_T041.CODDIV;
                --
               /* IF SQL%ROWCOUNT = 0 THEN
                  -- record does not exists , we insert it
                  VL_MESSAGE_D := 'Insert T041 ';
                  INSERT INTO T041PARTYDIV VALUES REC_T041;
                END IF;*/
                VL_INS_T041 := VL_INS_T041 + 1;
                --
                END IF;
                --
                -- T045PARTYWEEK
                --
                /*
                IF ( VL_STATUS = 0 ) THEN

                FOR RL_XIN_T045 IN CL_XIN_T045(RL_XIN_T041.CODPARTY, RL_XIN_T041.CODDIV, RL_XIN_T041.SM1_DTECRE) LOOP
                BEGIN
                SAVEPOINT S_T045PARTYWEEK;
                   VL_D_SM1_DTECRE := RL_XIN_T045.SM1_DTECRE;
                   VL_MESSAGE_H := 'Weekly Plan Info: '|| RL_XIN_T045.CODPARTY || '/' ||
                                                          RL_XIN_T045.CODDIV   || '/' ||
                                                          RL_XIN_T045.CODPLAN;

                  VL_MESSAGE_D := 'Format Conversion ';
                  REC_T045.CODPARTY := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T045.CODPARTY,'CODPARTY', VL_DES_T045,VL_STATUS, VL_MESSAGE_D);
                  REC_T045.CODDIV := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T045.CODDIV,'CODDIV', VL_DES_T045,VL_STATUS, VL_MESSAGE_D);
                  REC_T045.CODPLAN := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T045.CODPLAN,'CODPLAN', VL_DES_T045,VL_STATUS, VL_MESSAGE_D);
                  REC_T045.DESMON := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T045.DESMON,'DESMON', VL_DES_T045,VL_STATUS, VL_MESSAGE_D);
                  REC_T045.DESTUE := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T045.DESTUE,'DESTUE', VL_DES_T045,VL_STATUS, VL_MESSAGE_D);
                  REC_T045.DESWED := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T045.DESWED,'DESWED', VL_DES_T045,VL_STATUS, VL_MESSAGE_D);
                  REC_T045.DESTHU := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T045.DESTHU,'DESTHU', VL_DES_T045,VL_STATUS, VL_MESSAGE_D);
                  REC_T045.DESFRI := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T045.DESFRI,'DESFRI', VL_DES_T045,VL_STATUS, VL_MESSAGE_D);
                  REC_T045.DESSAT := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T045.DESSAT,'DESSAT', VL_DES_T045,VL_STATUS, VL_MESSAGE_D);
                  REC_T045.DESSUN := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T045.DESSUN,'DESSUN', VL_DES_T045,VL_STATUS, VL_MESSAGE_D);
                  REC_T045.FLGANN := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T045.FLGANN,'FLGANN', VL_DES_T045,VL_STATUS, VL_MESSAGE_D);


                 IF (VL_STATUS <> 0 ) THEN
                   VL_MESSAGE_H := SUBSTR(VL_MESSAGE_H||' '||VL_MESSAGE_D||' '||dbms_utility.format_error_backtrace() || ' ' || SQLERRM,1,4000);
                   PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                           VL_PROGR_D_T045,
                                           SQLCODE,
                                           VL_MESSAGE_H);
                 END IF;
                 IF (VL_STATUS = 0 ) THEN
                --
                 VL_MESSAGE_D := 'Update T045 ';
                 UPDATE T045PARTYWEEK
                   SET
                      DESMON = CASE VL_DES_T045('DESMON.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T045.DESMON ELSE DESMON END,
                      DESTUE = CASE VL_DES_T045('DESTUE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T045.DESTUE ELSE DESTUE END,
                      DESWED = CASE VL_DES_T045('DESWED.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T045.DESWED ELSE DESWED END,
                      DESTHU = CASE VL_DES_T045('DESTHU.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T045.DESTHU ELSE DESTHU END,
                      DESFRI = CASE VL_DES_T045('DESFRI.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T045.DESFRI ELSE DESFRI END,
                      DESSAT = CASE VL_DES_T045('DESSAT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T045.DESSAT ELSE DESSAT END,
                      DESSUN = CASE VL_DES_T045('DESSUN.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T045.DESSUN ELSE DESSUN END,
                      FLGANN = CASE VL_DES_T045('FLGANN.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T045.FLGANN ELSE FLGANN END

                 WHERE CODPARTY = REC_T045.CODPARTY
                   AND CODDIV   = REC_T045.CODDIV
                   AND CODPLAN  = REC_T045.CODPLAN;
                --
                IF SQL%ROWCOUNT = 0 THEN
                  -- record does not exists , we insert it
                  VL_MESSAGE_D := 'Insert T045 ';
                  INSERT INTO T045PARTYWEEK VALUES REC_T045;

                END IF;
                VL_INS_T045 := VL_INS_T045 + 1;
                --
                END IF;
               EXCEPTION WHEN OTHERS THEN
                     VL_STATUS := -1;
                     ROLLBACK TO SAVEPOINT S_T045PARTYWEEK; -- Rollback all the the details of the customer/division
                     VL_MESSAGE_H := SUBSTR(VL_MESSAGE_H||' '||VL_MESSAGE_D||' '||dbms_utility.format_error_backtrace() || ' ' || SQLERRM,1,4000);

                     PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                                   VL_PROGR_D_T045,
                                                   SQLCODE,
                                                   VL_MESSAGE_H);
                END; -- T045

                IF (VL_STATUS <> 0 ) THEN

                 -- set the status to err to the single record in order to go ahead to another detail
                  UPDATE Z_XIN_T045PARTYWEEK
                     SET SM1_STATUS = C_XINSTATUS_ERR
                     WHERE CODPARTY = RL_XIN_T045.CODPARTY
                      AND  CODDIV   = RL_XIN_T045.CODDIV
                      AND  SM1_CODPROCESS = PI_PROGR_H
                      AND  SM1_STATUS  = C_XINSTATUS_OK
                      AND  SM1_DTECRE = VL_D_SM1_DTECRE;
                      VL_STATUS := 0; -- RE- SET THE STATUS TO 0 TO CONTINUE WITH THE OTHER DETAILS
                END IF;
              END LOOP; -- T045PARTYWEEK


            END IF; -- VL_STATUS = 0 T045PARTYWEEK

            --
            -- T046PARTYBANK
            --

            IF ( VL_STATUS = 0 ) THEN
            FOR RL_XIN_T046 IN CL_XIN_T046(RL_XIN_T041.CODPARTY, RL_XIN_T041.CODDIV, RL_XIN_T041.SM1_DTECRE) LOOP
            BEGIN
            SAVEPOINT S_T046PARTYBANK;

               VL_D_SM1_DTECRE := RL_XIN_T046.SM1_DTECRE;
               VL_MESSAGE_H := 'Bank Info Customer: '|| RL_XIN_T046.CODPARTY || '/' ||
                               'Division: '||RL_XIN_T046.CODDIV   || '/' ||
                               'ABI code: '||RL_XIN_T046.CODABI   || '/' ||
                               'CAB code: '||RL_XIN_T046.CODCAB;

                  VL_MESSAGE_D := 'Format Conversion ';
                  VL_CODDIV:= RL_XIN_T046.CODDIV;
                  REC_T046.CODPARTY := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T046.CODPARTY,'CODPARTY', VL_DES_T046,VL_STATUS, VL_MESSAGE_D);
                  REC_T046.CODDIV := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T046.CODDIV,'CODDIV', VL_DES_T046,VL_STATUS, VL_MESSAGE_D);
                  REC_T046.CODABI := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T046.CODABI,'CODABI', VL_DES_T046,VL_STATUS, VL_MESSAGE_D);
                  REC_T046.CODCAB := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T046.CODCAB,'CODCAB', VL_DES_T046,VL_STATUS, VL_MESSAGE_D);
                  REC_T046.DESBAN := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T046.DESBAN,'DESBAN', VL_DES_T046,VL_STATUS, VL_MESSAGE_D);
                  REC_T046.DESBRA := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T046.DESBRA,'DESBRA', VL_DES_T046,VL_STATUS, VL_MESSAGE_D);
                  REC_T046.DESADDR := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T046.DESADDR,'DESADDR', VL_DES_T046,VL_STATUS, VL_MESSAGE_D);
                  REC_T046.DESLOC := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T046.DESLOC,'DESLOC', VL_DES_T046,VL_STATUS, VL_MESSAGE_D);
                  REC_T046.DESPRV := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T046.DESPRV,'DESPRV', VL_DES_T046,VL_STATUS, VL_MESSAGE_D);
                  REC_T046.CODPRV := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T046.CODPRV,'CODPRV', VL_DES_T046,VL_STATUS, VL_MESSAGE_D);
                  REC_T046.CODACCOUNT := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T046.CODACCOUNT,'CODACCOUNT', VL_DES_T046,VL_STATUS, VL_MESSAGE_D);
                  REC_T046.CODCONTROL := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T046.CODCONTROL,'CODCONTROL', VL_DES_T046,VL_STATUS, VL_MESSAGE_D);
                  REC_T046.CODCIN := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T046.CODCIN,'CODCIN', VL_DES_T046,VL_STATUS, VL_MESSAGE_D);
                  REC_T046.CODIBAN := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T046.CODIBAN,'CODIBAN', VL_DES_T046,VL_STATUS, VL_MESSAGE_D);
                  REC_T046.CODSWIFT := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T046.CODSWIFT,'CODSWIFT', VL_DES_T046,VL_STATUS, VL_MESSAGE_D);



                 IF (VL_STATUS <> 0 ) THEN
                   VL_MESSAGE_H := SUBSTR(VL_MESSAGE_H||' '||VL_MESSAGE_D||' '||dbms_utility.format_error_backtrace() || ' ' || SQLERRM,1,4000);
                   PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                           VL_PROGR_D_T046,
                                           SQLCODE,
                                           VL_MESSAGE_H);
                 END IF;
                 IF (VL_STATUS = 0 ) THEN
                --
                 VL_MESSAGE_D := 'Update T046 ';
                 UPDATE T046PARTYBANK
                   SET
                      DESBAN = CASE VL_DES_T046('DESBAN.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T046.DESBAN ELSE DESBAN END,
                      DESBRA = CASE VL_DES_T046('DESBRA.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T046.DESBRA ELSE DESBRA END,
                      DESADDR = CASE VL_DES_T046('DESADDR.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T046.DESADDR ELSE DESADDR END,
                      DESLOC = CASE VL_DES_T046('DESLOC.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T046.DESLOC ELSE DESLOC END,
                      DESPRV = CASE VL_DES_T046('DESPRV.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T046.DESPRV ELSE DESPRV END,
                      CODPRV = CASE VL_DES_T046('CODPRV.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T046.CODPRV ELSE CODPRV END,
                      CODACCOUNT = CASE VL_DES_T046('CODACCOUNT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T046.CODACCOUNT ELSE CODACCOUNT END,
                      CODCONTROL = CASE VL_DES_T046('CODCONTROL.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T046.CODCONTROL ELSE CODCONTROL END,
                      CODCIN = CASE VL_DES_T046('CODCIN.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T046.CODCIN ELSE CODCIN END,
                      CODIBAN = CASE VL_DES_T046('CODIBAN.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T046.CODIBAN ELSE CODIBAN END,
                      CODSWIFT = CASE VL_DES_T046('CODSWIFT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T046.CODSWIFT ELSE CODSWIFT END


                 WHERE CODPARTY = REC_T046.CODPARTY
                   AND CODDIV   = REC_T046.CODDIV
                   AND CODABI   = REC_T046.CODABI
                   AND CODCAB   = REC_T046.CODCAB;
                --
                IF SQL%ROWCOUNT = 0 THEN
                  -- record does not exists , we insert it
                  VL_MESSAGE_D := 'Insert T046 ';
                  INSERT INTO T046PARTYBANK VALUES REC_T046;

                END IF;
                VL_INS_T046 := VL_INS_T046 + 1;
                END IF;
                 --

              EXCEPTION WHEN OTHERS THEN
                   VL_STATUS := -1;
                   ROLLBACK TO SAVEPOINT S_T046PARTYBANK;
                   VL_MESSAGE_H := SUBSTR(VL_MESSAGE_H||' '||VL_MESSAGE_D||' '||dbms_utility.format_error_backtrace() || ' ' || SQLERRM,1,4000);

                   PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                                 VL_PROGR_D_T046,
                                                 SQLCODE,
                                                 VL_MESSAGE_H);
              END; -- T046
              IF (VL_STATUS <> 0 ) THEN

               -- set the status to err to the single record in order to go ahead to another detail
                UPDATE Z_XIN_T046PARTYBANK
                   SET SM1_STATUS = C_XINSTATUS_ERR
                   WHERE CODPARTY = RL_XIN_T046.CODPARTY
                    AND  CODDIV   = RL_XIN_T046.CODDIV
                    AND  CODABI   = RL_XIN_T046.CODABI
                    AND  CODCAB   = RL_XIN_T046.CODCAB
                    AND  SM1_CODPROCESS = PI_PROGR_H
                    AND  SM1_STATUS  = C_XINSTATUS_OK
                    AND  SM1_DTECRE = VL_D_SM1_DTECRE;
                    VL_STATUS := 0; -- RE- SET THE STATUS TO 0 TO CONTINUE WITH THE OTHER DETAILS
              END IF;
              END LOOP; -- T046PARTYBANK


            END IF; -- VL_STATUS = 0 T046PARTYBANK
            --
            -- T047PARTYCONTACT
            --
            IF ( VL_STATUS = 0 ) THEN

            FOR RL_XIN_T047 IN CL_XIN_T047(RL_XIN_T041.CODPARTY, RL_XIN_T041.CODDIV, RL_XIN_T041.SM1_DTECRE) LOOP
            BEGIN
            SAVEPOINT S_T047PARTYCONTACT;
                 VL_D_SM1_DTECRE := RL_XIN_T047.SM1_DTECRE;
                 VL_MESSAGE_H := 'Contact Info. Customer: '|| RL_XIN_T047.CODPARTY || '/' ||
                                'Division: '||RL_XIN_T047.CODDIV   || '/' ||
                                'Contact code:'||RL_XIN_T047.CODPER   || '/' ||
                                                RL_XIN_T047.CODASSOC;

                  VL_MESSAGE_D := 'Format Conversion ';
                  VL_CODDIV:= RL_XIN_T047.CODDIV;
                  REC_T047.CODPARTY := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T047.CODPARTY,'CODPARTY', VL_DES_T047,VL_STATUS, VL_MESSAGE_D);
                  REC_T047.CODDIV := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T047.CODDIV,'CODDIV', VL_DES_T047,VL_STATUS, VL_MESSAGE_D);
                  REC_T047.CODPER := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T047.CODPER,'CODPER', VL_DES_T047,VL_STATUS, VL_MESSAGE_D);
                  REC_T047.DTEFROM := F_CHECK_FORMAT_D( VL_CODDIV,   RL_XIN_T047.DTEFROM,'DTEFROM', VL_DES_T047,VL_STATUS, VL_MESSAGE_D);
                  REC_T047.DTETO := F_CHECK_FORMAT_D( VL_CODDIV,   RL_XIN_T047.DTETO,'DTETO', VL_DES_T047,VL_STATUS, VL_MESSAGE_D);
                  REC_T047.CODROLE1 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T047.CODROLE1,'CODROLE1', VL_DES_T047,VL_STATUS, VL_MESSAGE_D);
                  REC_T047.CODROLE2 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T047.CODROLE2,'CODROLE2', VL_DES_T047,VL_STATUS, VL_MESSAGE_D);
                  REC_T047.CODROLE3 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T047.CODROLE3,'CODROLE3', VL_DES_T047,VL_STATUS, VL_MESSAGE_D);
                  REC_T047.FLGPRIMARY := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T047.FLGPRIMARY,'FLGPRIMARY', VL_DES_T047,VL_STATUS, VL_MESSAGE_D);
                  REC_T047.DESNOTE := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T047.DESNOTE,'DESNOTE', VL_DES_T047,VL_STATUS, VL_MESSAGE_D);
                  REC_T047.CODSTATUS := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T047.CODSTATUS,'CODSTATUS', VL_DES_T047,VL_STATUS, VL_MESSAGE_D);
                  REC_T047.CODASSOC := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T047.CODASSOC,'CODASSOC', VL_DES_T047,VL_STATUS, VL_MESSAGE_D);



                 IF (VL_STATUS <> 0 ) THEN
                   VL_MESSAGE_H := SUBSTR(VL_MESSAGE_H||' '||VL_MESSAGE_D||' '||dbms_utility.format_error_backtrace() || ' ' || SQLERRM,1,4000);
                   PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                           VL_PROGR_D_T047,
                                           SQLCODE,
                                           VL_MESSAGE_H);
                 END IF;
                 IF (VL_STATUS = 0 ) THEN
                --
                 VL_MESSAGE_D := 'Update T047 ';
                 UPDATE T047PARTYCONTACT
                   SET
                      DTEFROM = CASE VL_DES_T047('DTEFROM.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T047.DTEFROM ELSE DTEFROM END,
                      DTETO = CASE VL_DES_T047('DTETO.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T047.DTETO ELSE DTETO END,
                      CODROLE1 = CASE VL_DES_T047('CODROLE1.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T047.CODROLE1 ELSE CODROLE1 END,
                      CODROLE2 = CASE VL_DES_T047('CODROLE2.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T047.CODROLE2 ELSE CODROLE2 END,
                      CODROLE3 = CASE VL_DES_T047('CODROLE3.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T047.CODROLE3 ELSE CODROLE3 END,
                      FLGPRIMARY = CASE VL_DES_T047('FLGPRIMARY.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T047.FLGPRIMARY ELSE FLGPRIMARY END,
                      DESNOTE = CASE VL_DES_T047('DESNOTE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T047.DESNOTE ELSE DESNOTE END,
                      CODSTATUS = CASE VL_DES_T047('CODSTATUS.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T047.CODSTATUS ELSE CODSTATUS END
                 WHERE CODPARTY = REC_T047.CODPARTY
                   AND CODDIV   = REC_T047.CODDIV
                   AND CODPER   = REC_T047.CODPER
                   AND CODASSOC   = REC_T047.CODASSOC;
                --
                IF SQL%ROWCOUNT = 0 THEN
                  -- record does not exists , we insert it
                  VL_MESSAGE_D := 'Insert T047 ';
                  INSERT INTO T047PARTYCONTACT VALUES REC_T047;

                END IF;
                VL_INS_T047 := VL_INS_T047 + 1;
                --
                END IF;
               EXCEPTION WHEN OTHERS THEN
                 VL_STATUS := -1;
                 ROLLBACK TO SAVEPOINT S_T047PARTYCONTACT;
                 VL_MESSAGE_H := SUBSTR(VL_MESSAGE_H||' '||VL_MESSAGE_D||' '||dbms_utility.format_error_backtrace() || ' ' || SQLERRM,1,4000);

                 PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                               VL_PROGR_D_T047,
                                               SQLCODE,
                                               VL_MESSAGE_H);

                END; -- T047
                IF (VL_STATUS <> 0 ) THEN
                   -- set the status to err to the single record in order to go ahead to another detail
                   UPDATE Z_XIN_T047PARTYCONTACT
                             SET SM1_STATUS = C_XINSTATUS_ERR
                             WHERE CODPARTY = RL_XIN_T047.CODPARTY
                              AND  CODDIV   = RL_XIN_T047.CODDIV
                              AND  CODPER   = RL_XIN_T047.CODPER
                              AND  CODASSOC = RL_XIN_T047.CODASSOC
                              AND  SM1_CODPROCESS = PI_PROGR_H
                              AND  SM1_STATUS  = C_XINSTATUS_OK
                              AND  SM1_DTECRE = VL_D_SM1_DTECRE;
                   VL_STATUS := 0; -- RE- SET THE STATUS TO 0 TO CONTINUE WITH THE OTHER DETAILS
                END IF;
              END LOOP; -- T047PARTYCONTACT

            END IF; -- VL_STATUS = 0 T047PARTYCONTACT
            --
            -- T049PVCATEGORY ONLY FOR SALE POINTS
            --
            IF ( VL_STATUS = 0  AND REC_T040.FLGCUSTSALE <> 0) THEN

              FOR RL_XIN_T049 IN CL_XIN_T049(RL_XIN_T041.CODPARTY, RL_XIN_T041.CODDIV, RL_XIN_T041.SM1_DTECRE) LOOP
              BEGIN
              SAVEPOINT S_T049PVCATEGORY;
               VL_D_SM1_DTECRE := RL_XIN_T049.SM1_DTECRE;

               VL_MESSAGE_H := 'Category Info. Customer: '|| RL_XIN_T049.CODPARTY    || '/' ||
                               'Division: '     ||RL_XIN_T049.CODDIV      || '/' ||
                               'Category code: '||RL_XIN_T049.CODCATEGORY || '/' ||
                               'Cluster code: ' ||RL_XIN_T049.CODCLUSTERCUST;

                  VL_MESSAGE_D := 'Format Conversion ';
                  VL_CODDIV:= RL_XIN_T049.CODDIV;
                  REC_T049.CODPARTY := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T049.CODPARTY,'CODPARTY', VL_DES_T049,VL_STATUS, VL_MESSAGE_D);
                  REC_T049.CODDIV := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T049.CODDIV,'CODDIV', VL_DES_T049,VL_STATUS, VL_MESSAGE_D);
                  REC_T049.CODCATEGORY := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T049.CODCATEGORY,'CODCATEGORY', VL_DES_T049,VL_STATUS, VL_MESSAGE_D);
                  REC_T049.INDEXPOT := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T049.INDEXPOT,'INDEXPOT', VL_DES_T049,VL_STATUS, VL_MESSAGE_D);
                  REC_T049.CODCATEGORYROLE := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T049.CODCATEGORYROLE,'CODCATEGORYROLE', VL_DES_T049,VL_STATUS, VL_MESSAGE_D);
                  REC_T049.QTYLINEARI := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T049.QTYLINEARI,'QTYLINEARI', VL_DES_T049,VL_STATUS, VL_MESSAGE_D);
                  REC_T049.NUMAVANCASSE := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T049.NUMAVANCASSE,'NUMAVANCASSE', VL_DES_T049,VL_STATUS, VL_MESSAGE_D);
                  REC_T049.CODVISITFREQUENCE := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T049.CODVISITFREQUENCE,'CODVISITFREQUENCE', VL_DES_T049,VL_STATUS, VL_MESSAGE_D);
                  REC_T049.CODCLUSTERCUST := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T049.CODCLUSTERCUST,'CODCLUSTERCUST', VL_DES_T049,VL_STATUS, VL_MESSAGE_D);
                  REC_T049.CODCLUSTER := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T049.CODCLUSTER,'CODCLUSTER', VL_DES_T049,VL_STATUS, VL_MESSAGE_D);
                  REC_T049.CODCLUSTERINT := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T049.CODCLUSTERINT,'CODCLUSTERINT', VL_DES_T049,VL_STATUS, VL_MESSAGE_D);
                  REC_T049.CODPARTY_CLUSTER  := F_CHECK_FORMAT_S(VL_CODDIV, RL_XIN_T049.CODPARTY_CLUSTER,
                                                                 'CODPARTY_CLUSTER',
                                                                 VL_DES_T049,
                                                                 VL_STATUS,
                                                                 VL_MESSAGE_D);
                 REC_T049.CODLEV_CLUSTER  := F_CHECK_FORMAT_S(VL_CODDIV, RL_XIN_T049.CODLEV_CLUSTER,
                                                                 'CODLEV_CLUSTER',
                                                                 VL_DES_T049,
                                                                 VL_STATUS,
                                                                 VL_MESSAGE_D);
                 REC_T049.CODHIER_CLUSTER  := F_CHECK_FORMAT_S(VL_CODDIV, RL_XIN_T049.CODHIER_CLUSTER,
                                                                 'CODHIER_CLUSTER',
                                                                 VL_DES_T049,
                                                                 VL_STATUS,
                                                                 VL_MESSAGE_D);
                 REC_T049.CODASSORTMENTTYPE_CLUSTER  := F_CHECK_FORMAT_S(VL_CODDIV, RL_XIN_T049.CODASSORTMENTTYPE_CLUSTER,
                                                                 'CODASSORTMENTTYPE_CLUSTER',
                                                                 VL_DES_T049,
                                                                 VL_STATUS,
                                                                 VL_MESSAGE_D);

                 IF (VL_STATUS <> 0 ) THEN
                   VL_MESSAGE_H := SUBSTR(VL_MESSAGE_H||' '||VL_MESSAGE_D||' '||dbms_utility.format_error_backtrace() || ' ' || SQLERRM,1,4000);
                   PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                           VL_PROGR_D_T049,
                                           SQLCODE,
                                           VL_MESSAGE_H);
                  END IF;
                 IF (VL_STATUS = 0 ) THEN
                --
                 VL_MESSAGE_D := 'Update T049 ';
                 UPDATE T049PVCATEGORY
                   SET
                      INDEXPOT = CASE VL_DES_T049('INDEXPOT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T049.INDEXPOT ELSE INDEXPOT END,
                      CODCATEGORYROLE = CASE VL_DES_T049('CODCATEGORYROLE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T049.CODCATEGORYROLE ELSE CODCATEGORYROLE END,
                      QTYLINEARI = CASE VL_DES_T049('QTYLINEARI.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T049.QTYLINEARI ELSE QTYLINEARI END,
                      NUMAVANCASSE = CASE VL_DES_T049('NUMAVANCASSE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T049.NUMAVANCASSE ELSE NUMAVANCASSE END,
                      CODVISITFREQUENCE = CASE VL_DES_T049('CODVISITFREQUENCE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T049.CODVISITFREQUENCE ELSE CODVISITFREQUENCE END,
                      CODCLUSTER = CASE VL_DES_T049('CODCLUSTER.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T049.CODCLUSTER ELSE CODCLUSTER END,
                      CODCLUSTERINT = CASE VL_DES_T049('CODCLUSTERINT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T049.CODCLUSTERINT ELSE CODCLUSTERINT END,
                      CODPARTY_CLUSTER     = CASE VL_DES_T049('CODPARTY_CLUSTER.ALL').FLG_SM1  WHEN C_UPDATED_BY_HOST THEN REC_T049.CODPARTY_CLUSTER ELSE CODPARTY_CLUSTER END,
                      CODLEV_CLUSTER     = CASE VL_DES_T049('CODLEV_CLUSTER.ALL').FLG_SM1  WHEN C_UPDATED_BY_HOST THEN REC_T049.CODLEV_CLUSTER ELSE CODLEV_CLUSTER END,
                      CODHIER_CLUSTER     = CASE VL_DES_T049('CODHIER_CLUSTER.ALL').FLG_SM1  WHEN C_UPDATED_BY_HOST THEN REC_T049.CODHIER_CLUSTER ELSE CODHIER_CLUSTER END,
                      CODASSORTMENTTYPE_CLUSTER     = CASE VL_DES_T049('CODASSORTMENTTYPE_CLUSTER.ALL').FLG_SM1  WHEN C_UPDATED_BY_HOST THEN REC_T049.CODASSORTMENTTYPE_CLUSTER ELSE CODASSORTMENTTYPE_CLUSTER END

                 WHERE CODPARTY = REC_T049.CODPARTY
                   AND CODDIV   = REC_T049.CODDIV
                   AND CODCATEGORY   = REC_T049.CODCATEGORY
                   AND CODCLUSTERCUST= REC_T049.CODCLUSTERCUST;
                --
                IF SQL%ROWCOUNT = 0 THEN
                  -- record does not exists , we insert it
                  VL_MESSAGE_D := 'Insert T049 ';
                  INSERT INTO T049PVCATEGORY VALUES REC_T049;

                END IF;
                VL_INS_T049 := VL_INS_T049 + 1;
                --
                END IF;
                 EXCEPTION WHEN OTHERS THEN
                         VL_STATUS := -1;
                         ROLLBACK TO SAVEPOINT S_T049PVCATEGORY;
                         VL_MESSAGE_H := SUBSTR(VL_MESSAGE_H||' '||VL_MESSAGE_D||' '||dbms_utility.format_error_backtrace() || ' ' || SQLERRM,1,4000);

                         PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                                       VL_PROGR_D_T049,
                                                       SQLCODE,
                                                       VL_MESSAGE_H);



                END; -- T049
                IF (VL_STATUS <> 0 ) THEN
                 -- set the status to err to the single record in order to go ahead to another detail
                  UPDATE Z_XIN_T049PVCATEGORY
                     SET SM1_STATUS = C_XINSTATUS_ERR
                     WHERE CODPARTY = RL_XIN_T049.CODPARTY
                      AND  CODDIV   = RL_XIN_T049.CODDIV
                      AND  SM1_CODPROCESS = PI_PROGR_H
                      AND  SM1_STATUS  = C_XINSTATUS_OK
                      AND  SM1_DTECRE = VL_D_SM1_DTECRE;
                      VL_STATUS := 0; -- RE- SET THE STATUS TO 0 TO CONTINUE WITH THE OTHER DETAILS
                 END IF;
              END LOOP; -- T049PVCATEGORY

        END IF; -- VL_STATUS = 0 T049PVCATEGORY
      */
      END LOOP; -- T041

      END IF; --( VL_STATUS = 0 AND VL_RECORD_LOCKED = 0 )
        --
      EXCEPTION
        WHEN OTHERS THEN
           VL_STATUS := -1;
           VL_MESSAGE_H := SUBSTR(VL_MESSAGE_H||' '||VL_MESSAGE_D||' '||dbms_utility.format_error_backtrace() || ' ' || SQLERRM,1,4000);

           PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                           VL_PROGR_D_T041,
                                           SQLCODE,
                                           VL_MESSAGE_H);

      END; --- DIVISION INFO T041

      --- ---------------------------------
      --- T042PARTYADDR CUSTOMER ADDRESSES
      --- ---------------------------------
      /*
      BEGIN -- ADDRESSES T042PARTYADDR

        IF ( VL_STATUS = 0 ) THEN
              -- ADDR
              FOR RL_XIN_T042 IN CL_XIN_T042(RL_XIN_T040.CODPARTY, RL_XIN_T040.SM1_DTECRE) LOOP
              --
                  VL_MESSAGE_H := 'Address. Customer: '|| RL_XIN_T042.CODPARTY || '/' ||
                                  'Adr Code: '||RL_XIN_T042.CODADDR;

                  VL_MESSAGE_D := 'Format Conversion ';
                  VL_CODDIV:= 'ALL';
                  REC_T042.CODPARTY := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T042.CODPARTY,'CODPARTY', VL_DES_T042,VL_STATUS, VL_MESSAGE_D);
                  REC_T042.CODADDR := NVL(F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T042.CODADDR,'CODADDR', VL_DES_T042,VL_STATUS, VL_MESSAGE_D),
                                          C_ADDR_DEF);
                  REC_T042.DESADDR1 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T042.DESADDR1,'DESADDR1', VL_DES_T042,VL_STATUS, VL_MESSAGE_D);
                  REC_T042.DESADDR2 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T042.DESADDR2,'DESADDR2', VL_DES_T042,VL_STATUS, VL_MESSAGE_D);
                  REC_T042.DESLOC1 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T042.DESLOC1,'DESLOC1', VL_DES_T042,VL_STATUS, VL_MESSAGE_D);
                  REC_T042.DESLOC2 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T042.DESLOC2,'DESLOC2', VL_DES_T042,VL_STATUS, VL_MESSAGE_D);
                  REC_T042.NUMPHONE1 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T042.NUMPHONE1,'NUMPHONE1', VL_DES_T042,VL_STATUS, VL_MESSAGE_D);
                  REC_T042.NUMPHONE2 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T042.NUMPHONE2,'NUMPHONE2', VL_DES_T042,VL_STATUS, VL_MESSAGE_D);
                  REC_T042.NUMFAX1 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T042.NUMFAX1,'NUMFAX1', VL_DES_T042,VL_STATUS, VL_MESSAGE_D);
                  REC_T042.NUMFAX2 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T042.NUMFAX2,'NUMFAX2', VL_DES_T042,VL_STATUS, VL_MESSAGE_D);
                  REC_T042.CODZIP := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T042.CODZIP,'CODZIP', VL_DES_T042,VL_STATUS, VL_MESSAGE_D);
                  REC_T042.CODPRV := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T042.CODPRV,'CODPRV', VL_DES_T042,VL_STATUS, VL_MESSAGE_D);
                  REC_T042.CODAREA := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T042.CODAREA,'CODAREA', VL_DES_T042,VL_STATUS, VL_MESSAGE_D);
                  REC_T042.CODZONE := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T042.CODZONE,'CODZONE', VL_DES_T042,VL_STATUS, VL_MESSAGE_D);
                  REC_T042.CODNATION := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T042.CODNATION,'CODNATION', VL_DES_T042,VL_STATUS, VL_MESSAGE_D);
                  REC_T042.EMAIL1 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T042.EMAIL1,'EMAIL1', VL_DES_T042,VL_STATUS, VL_MESSAGE_D);
                  REC_T042.WEBSITE1 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T042.WEBSITE1,'WEBSITE1', VL_DES_T042,VL_STATUS, VL_MESSAGE_D);
                  REC_T042.WEBSITE2 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T042.WEBSITE2,'WEBSITE2', VL_DES_T042,VL_STATUS, VL_MESSAGE_D);
                  REC_T042.CODTYPADDR := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T042.CODTYPADDR,'CODTYPADDR', VL_DES_T042,VL_STATUS, VL_MESSAGE_D);
                  REC_T042.VALLATITUDE := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T042.VALLATITUDE,'VALLATITUDE', VL_DES_T042,VL_STATUS, VL_MESSAGE_D);
                  REC_T042.VALLONGITUDE := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T042.VALLONGITUDE,'VALLONGITUDE', VL_DES_T042,VL_STATUS, VL_MESSAGE_D);

                  --- Customised field for DAL
                  REC_T042.Z_CODREGION := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T042.Z_CODREGION,'Z_CODREGION', VL_DES_T042,VL_STATUS, VL_MESSAGE_D);
                  REC_T042.Z_CODDISTRICT := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T042.Z_CODDISTRICT,'Z_CODDISTRICT', VL_DES_T042,VL_STATUS, VL_MESSAGE_D);
                  REC_T042.Z_CODLOC := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T042.Z_CODLOC,'Z_CODLOC', VL_DES_T042,VL_STATUS, VL_MESSAGE_D);
                  REC_T042.Z_CODTERRITORY := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T042.Z_CODTERRITORY,'Z_CODTERRITORY', VL_DES_T042,VL_STATUS, VL_MESSAGE_D);



                 IF (VL_STATUS <> 0 ) THEN
                   VL_MESSAGE_H := SUBSTR(VL_MESSAGE_H||' '||VL_MESSAGE_D||' '||dbms_utility.format_error_backtrace() || ' ' || SQLERRM,1,4000);
                   PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                           VL_PROGR_D_T042,
                                           SQLCODE,
                                           VL_MESSAGE_H);
                 ELSE
                --
                VL_MESSAGE_D := 'Update T042 ';

                UPDATE T042PARTYADDR
                   SET
                    DESADDR1 = CASE VL_DES_T042('DESADDR1.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T042.DESADDR1 ELSE DESADDR1 END,
                    DESADDR2 = CASE VL_DES_T042('DESADDR2.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T042.DESADDR2 ELSE DESADDR2 END,
                    DESLOC1 = CASE VL_DES_T042('DESLOC1.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T042.DESLOC1 ELSE DESLOC1 END,
                    DESLOC2 = CASE VL_DES_T042('DESLOC2.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T042.DESLOC2 ELSE DESLOC2 END,
                    NUMPHONE1 = CASE VL_DES_T042('NUMPHONE1.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T042.NUMPHONE1 ELSE NUMPHONE1 END,
                    NUMPHONE2 = CASE VL_DES_T042('NUMPHONE2.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T042.NUMPHONE2 ELSE NUMPHONE2 END,
                    NUMFAX1 = CASE VL_DES_T042('NUMFAX1.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T042.NUMFAX1 ELSE NUMFAX1 END,
                    NUMFAX2 = CASE VL_DES_T042('NUMFAX2.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T042.NUMFAX2 ELSE NUMFAX2 END,
                    CODZIP = CASE VL_DES_T042('CODZIP.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T042.CODZIP ELSE CODZIP END,
                    CODPRV = CASE VL_DES_T042('CODPRV.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T042.CODPRV ELSE CODPRV END,
                    CODAREA = CASE VL_DES_T042('CODAREA.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T042.CODAREA ELSE CODAREA END,
                    CODZONE = CASE VL_DES_T042('CODZONE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T042.CODZONE ELSE CODZONE END,
                    CODNATION = CASE VL_DES_T042('CODNATION.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T042.CODNATION ELSE CODNATION END,
                    EMAIL1 = CASE VL_DES_T042('EMAIL1.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T042.EMAIL1 ELSE EMAIL1 END,
                    WEBSITE1 = CASE VL_DES_T042('WEBSITE1.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T042.WEBSITE1 ELSE WEBSITE1 END,
                    WEBSITE2 = CASE VL_DES_T042('WEBSITE2.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T042.WEBSITE2 ELSE WEBSITE2 END,
                    CODTYPADDR = CASE VL_DES_T042('CODTYPADDR.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T042.CODTYPADDR ELSE CODTYPADDR END,
                    VALLATITUDE = CASE VL_DES_T042('VALLATITUDE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T042.VALLATITUDE ELSE VALLATITUDE END,
                    VALLONGITUDE = CASE VL_DES_T042('VALLONGITUDE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T042.VALLONGITUDE ELSE VALLONGITUDE END,

Z_CODREGION = CASE VL_DES_T042('Z_CODREGION.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T042.Z_CODREGION ELSE Z_CODREGION END,
Z_CODDISTRICT = CASE VL_DES_T042('Z_CODDISTRICT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T042.Z_CODDISTRICT ELSE Z_CODDISTRICT END,
Z_CODLOC = CASE VL_DES_T042('Z_CODLOC.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T042.Z_CODLOC ELSE Z_CODLOC END,
Z_CODTERRITORY = CASE VL_DES_T042('Z_CODTERRITORY.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T042.Z_CODTERRITORY ELSE Z_CODTERRITORY END

                 WHERE CODPARTY  = REC_T042.CODPARTY
                   AND CODADDR   = REC_T042.CODADDR;

                --
                IF SQL%ROWCOUNT = 0 THEN
                  -- record does not exists , we insert it
                  VL_MESSAGE_D := 'Insert T042 ';
                  INSERT INTO T042PARTYADDR VALUES REC_T042;
                END IF;
                VL_INS_T042 := VL_INS_T042 + 1;
                END IF;
                --
              END LOOP;  --- T042PARTY ADDR
      END IF; --( VL_STATUS = 0 AND VL_RECORD_LOCKED = 0 )
        --
      EXCEPTION
        WHEN OTHERS THEN
           VL_STATUS := -1;
           VL_MESSAGE_H := SUBSTR(VL_MESSAGE_H||' '||VL_MESSAGE_D||' '||dbms_utility.format_error_backtrace() || ' ' || SQLERRM,1,4000);

           PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                           VL_PROGR_D_T042,
                                           SQLCODE,
                                           VL_MESSAGE_H);

      END; --- ADDRESSES T042
      */
      --- ---------------------------------
      --- TA4410NOTES CUSTOMER NOTES
      --- ---------------------------------
  /*
        IF ( VL_STATUS = 0 ) THEN
              -- NOTES

              FOR RL_XIN_TA4410 IN CL_XIN_TA4410(RL_XIN_T040.CODPARTY, RL_XIN_T040.SM1_DTECRE) LOOP
              --
              BEGIN -- NOTES TA4410NOTES
              SAVEPOINT S_TA4410NOTES;

                VL_MESSAGE_H := 'Customer: '|| RL_XIN_TA4410.CODPARTY || '/' ||
                                'Note Type: ' || RL_XIN_TA4410.NOTETYPE || '/' ||
                                'Seq: ' || RL_XIN_TA4410.IDSEQ;
                 VL_MESSAGE_D := 'Format Conversion ';
                  VL_CODDIV:= 'ALL';
                  VL_D_SM1_DTECRE := RL_XIN_TA4410.SM1_DTECRE;

                  REC_TA4410.NOTETYPE := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_TA4410.NOTETYPE,'NOTETYPE', VL_DES_TA4410,VL_STATUS, VL_MESSAGE_D);
                  REC_TA4410.IDSEQ := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_TA4410.IDSEQ,'IDSEQ', VL_DES_TA4410,VL_STATUS, VL_MESSAGE_D);
                  REC_TA4410.NOTE := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_TA4410.NOTE,'NOTE', VL_DES_TA4410,VL_STATUS, VL_MESSAGE_D);
                  REC_TA4410.CODUSRCRE  := REC_T040.CODUSRCREREAL;
                  REC_TA4410.CODUSRMOD  := REC_T040.CODUSRMODREAL;
                  REC_TA4410.DTECRE     := REC_T040.DTECRE;
                  REC_TA4410.DTEMOD     := REC_T040.DTEMOD;
                  --
                  REC_TA4410.PARENTKEY := REC_T040.DOCUMENTKEY;-- DOCUMENT KEY FROM T040 RECORD
                  --
                 IF (VL_STATUS <> 0 ) THEN
                   VL_MESSAGE_H := SUBSTR(VL_MESSAGE_H||' '||VL_MESSAGE_D||' '||dbms_utility.format_error_backtrace() || ' ' || SQLERRM,1,4000);
                   PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                           VL_PROGR_D_TA4410,
                                           SQLCODE,
                                           VL_MESSAGE_H);
                 ELSE
                    --
                    VL_MESSAGE_D := 'Update TA4410 ';

                    UPDATE TA4410NOTES
                       SET NOTE = CASE VL_DES_TA4410('NOTE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA4410.NOTE ELSE NOTE END
                     WHERE PARENTKEY = REC_TA4410.PARENTKEY
                       AND NOTETYPE  = REC_TA4410.NOTETYPE
                       AND IDSEQ     = REC_TA4410.IDSEQ;

                    --
                    IF SQL%ROWCOUNT = 0 THEN
                      -- record does not exists , we insert it
                      VL_MESSAGE_D := 'Insert TA4410 ';

                      INSERT INTO TA4410NOTES  VALUES REC_TA4410;
                    END IF;
                    VL_INS_TA4410 := VL_INS_TA4410 + 1;
                END IF;
                --
                           --
              EXCEPTION
                WHEN OTHERS THEN
                   VL_STATUS := -1;
                   ROLLBACK TO SAVEPOINT S_TA4410NOTES;
                   VL_MESSAGE_H := SUBSTR(VL_MESSAGE_H||' '||VL_MESSAGE_D||' '||dbms_utility.format_error_backtrace() || ' ' || SQLERRM,1,4000);

                   PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                                   VL_PROGR_D_TA4410,
                                                   SQLCODE,
                                                   VL_MESSAGE_H);


              END; --- NOTES TA4410

              IF (VL_STATUS <> 0 ) THEN
                 -- set the status to err to the single record in order to go ahead to another detail
                UPDATE XIN_TA4410NOTES_CUST
                             SET SM1_STATUS = C_XINSTATUS_ERR
                             WHERE CODPARTY = RL_XIN_TA4410.CODPARTY
                              AND  SM1_CODPROCESS = PI_PROGR_H
                              AND  SM1_STATUS  = C_XINSTATUS_OK
                              AND  SM1_DTECRE = VL_D_SM1_DTECRE;
                      VL_STATUS := 0; -- RE- SET THE STATUS TO 0 TO CONTINUE WITH THE OTHER DETAILS
              END IF;

              END LOOP;  --- TA4410NOTES


      END IF; --( VL_STATUS = 0 AND VL_RECORD_LOCKED = 0 )
*/
 -- if all records have been stored with success then it makes the commit
      IF VL_STATUS = 0 THEN
         VL_INS_T040 := VL_INS_T040 + 1;
         COMMIT;
      ELSE
        ROLLBACK;
      END IF;
      -- Into the loop we set only records on error
      IF ( VL_STATUS <> 0 OR VL_RECORD_LOCKED <> 0 ) THEN
              UPDATE Z_XIN_T040PARTY
              SET   SM1_STATUS = CASE
                                      WHEN VL_RECORD_LOCKED <> 0  THEN C_XINSTATUS_LOCK
                                      ELSE C_XINSTATUS_ERR END
              WHERE CODPARTY = RL_XIN_T040.CODPARTY
               AND  SM1_CODPROCESS = PI_PROGR_H
               AND  SM1_DTECRE     = RL_XIN_T040.SM1_DTECRE
               AND  SM1_STATUS     = C_XINSTATUS_OK;


              UPDATE Z_XIN_T041PARTYDIV
              SET SM1_STATUS = CASE
                                    WHEN VL_RECORD_LOCKED <> 0  THEN C_XINSTATUS_LOCK
                                    ELSE C_XINSTATUS_ERR END
              WHERE CODPARTY = RL_XIN_T040.CODPARTY
               AND  SM1_CODPROCESS = PI_PROGR_H
               AND  SM1_DTECRE <= RL_XIN_T040.SM1_DTECRE
               AND  SM1_STATUS     = C_XINSTATUS_OK;

              UPDATE Z_XIN_T042PARTYADDR
              SET SM1_STATUS = CASE
                                    WHEN VL_RECORD_LOCKED <> 0  THEN C_XINSTATUS_LOCK
                                    ELSE C_XINSTATUS_ERR END
              WHERE CODPARTY = RL_XIN_T040.CODPARTY
               AND  SM1_CODPROCESS = PI_PROGR_H
               AND  SM1_DTECRE <= RL_XIN_T040.SM1_DTECRE
               AND  SM1_STATUS     = C_XINSTATUS_OK;

              UPDATE XIN_TA4410NOTES_CUST
              SET SM1_STATUS = CASE
                                    WHEN VL_RECORD_LOCKED <> 0  THEN C_XINSTATUS_LOCK
                                    ELSE C_XINSTATUS_ERR END
              WHERE CODPARTY = RL_XIN_T040.CODPARTY
                AND  SM1_CODPROCESS = PI_PROGR_H
               AND  SM1_DTECRE <= RL_XIN_T040.SM1_DTECRE
               AND  SM1_STATUS     = C_XINSTATUS_OK;

              UPDATE Z_XIN_T045PARTYWEEK
              SET SM1_STATUS = CASE
                                    WHEN VL_RECORD_LOCKED <> 0  THEN C_XINSTATUS_LOCK
                                    ELSE C_XINSTATUS_ERR END
              WHERE CODPARTY = RL_XIN_T040.CODPARTY
                AND  SM1_CODPROCESS = PI_PROGR_H
               AND  SM1_DTECRE <= RL_XIN_T040.SM1_DTECRE
               AND  SM1_STATUS     = C_XINSTATUS_OK;

              UPDATE Z_XIN_T046PARTYBANK
              SET SM1_STATUS= CASE
                                    WHEN VL_RECORD_LOCKED <> 0  THEN C_XINSTATUS_LOCK
                                    ELSE C_XINSTATUS_ERR END
              WHERE CODPARTY = RL_XIN_T040.CODPARTY
                AND  SM1_CODPROCESS = PI_PROGR_H
               AND  SM1_DTECRE <= RL_XIN_T040.SM1_DTECRE
               AND  SM1_STATUS     = C_XINSTATUS_OK;

              UPDATE Z_XIN_T047PARTYCONTACT
              SET SM1_STATUS = CASE
                                    WHEN VL_RECORD_LOCKED <> 0  THEN C_XINSTATUS_LOCK
                                    ELSE C_XINSTATUS_ERR END
              WHERE CODPARTY = RL_XIN_T040.CODPARTY
               AND  SM1_CODPROCESS = PI_PROGR_H
               AND  SM1_DTECRE <= RL_XIN_T040.SM1_DTECRE
               AND  SM1_STATUS     = C_XINSTATUS_OK;

              UPDATE Z_XIN_T049PVCATEGORY
              SET SM1_STATUS= CASE
                                    WHEN VL_RECORD_LOCKED <> 0  THEN C_XINSTATUS_LOCK
                                    ELSE C_XINSTATUS_ERR END
              WHERE CODPARTY = RL_XIN_T040.CODPARTY
                AND  SM1_CODPROCESS = PI_PROGR_H
               AND  SM1_DTECRE <= RL_XIN_T040.SM1_DTECRE
               AND  SM1_STATUS     = C_XINSTATUS_OK;

             COMMIT;
        END IF;


       -- Release Record
        UPDATE T040PARTY
        SET       DTELCK          = NULL,
                  IDSESSIONLCK    = NULL,
                  CODUSRLCK       = NULL
        WHERE CODPARTY     = REC_T040.CODPARTY
          AND IDSESSIONLCK = PI_SESSION_ID
          AND CODUSRLCK    = C_SYSUSR;

        COMMIT;

    END LOOP;  -- T040PARTY



    BEGIN

       -- Moves records from staging area to log staging area
       P_XIN_MOVE_TO_LOG(PI_PROGR_H, VL_PROGR_D_T049,'T049PVCATEGORY');
       P_XIN_MOVE_TO_LOG(PI_PROGR_H, VL_PROGR_D_T047,'T047PARTYCONTACT');
       P_XIN_MOVE_TO_LOG(PI_PROGR_H, VL_PROGR_D_T046,'T046PARTYBANK');
       P_XIN_MOVE_TO_LOG(PI_PROGR_H, VL_PROGR_D_T045,'T045PARTYWEEK');
       P_XIN_MOVE_TO_LOG(PI_PROGR_H, VL_PROGR_D_T042,'T042PARTYADDR');
       P_XIN_MOVE_TO_LOG(PI_PROGR_H, VL_PROGR_D_TA4410,'TA4410NOTES_CUST');
       P_XIN_MOVE_TO_LOG(PI_PROGR_H, VL_PROGR_D_T041,'T041PARTYDIV');
       P_XIN_MOVE_TO_LOG(PI_PROGR_H, VL_PROGR_D_T040,'T040PARTY');       --
    END;



   -- Close Logs

    --
     PKG_UTILS.LOG_END_DETAIL(PI_PROGR_H,
                                      VL_PROGR_D_T049,
                                      0,
                                      VL_COUNT_XIN_T049,
                                      VL_INS_T049,
                                      VL_COUNT_XIN_T049 - VL_INS_T049);
    --
    PKG_UTILS.LOG_END_DETAIL(PI_PROGR_H,
                                      VL_PROGR_D_T047,
                                      0,
                                      VL_COUNT_XIN_T047,
                                      VL_INS_T047,
                                      VL_COUNT_XIN_T047 - VL_INS_T047);
    --
    PKG_UTILS.LOG_END_DETAIL(PI_PROGR_H,
                                      VL_PROGR_D_T046,
                                      0,
                                      VL_COUNT_XIN_T046,
                                      VL_INS_T046,
                                      VL_COUNT_XIN_T046 - VL_INS_T046);
    --
    PKG_UTILS.LOG_END_DETAIL(PI_PROGR_H,
                                      VL_PROGR_D_T045,
                                      0,
                                      VL_COUNT_XIN_T045,
                                      VL_INS_T045,
                                      VL_COUNT_XIN_T045 - VL_INS_T045);
    --
    PKG_UTILS.LOG_END_DETAIL(PI_PROGR_H,
                                      VL_PROGR_D_TA4410,
                                      0,
                                      VL_COUNT_XIN_TA4410,
                                      VL_INS_TA4410,
                                      VL_COUNT_XIN_TA4410 - VL_INS_TA4410);
    --
    PKG_UTILS.LOG_END_DETAIL(PI_PROGR_H,
                                      VL_PROGR_D_T042,
                                      0,
                                      VL_COUNT_XIN_T042,
                                      VL_INS_T042,
                                      VL_COUNT_XIN_T042 - VL_INS_T042);
    --
    PKG_UTILS.LOG_END_DETAIL(PI_PROGR_H,
                                      VL_PROGR_D_T041,
                                      0,
                                      VL_COUNT_XIN_T041,
                                      VL_INS_T041,
                                      VL_COUNT_XIN_T041 - VL_INS_T041);
    --
    PKG_UTILS.LOG_END_DETAIL(PI_PROGR_H,
                                      VL_PROGR_D_T040,
                                      0,
                                      VL_COUNT_XIN_T040,
                                      VL_INS_T040,
                                      VL_COUNT_XIN_T040 - VL_INS_T040);


    PO_MSG    := VL_INS_T040||'/'||VL_COUNT_XIN_T040||' Customers loaded';
    PO_STATUS := VL_INS_T040;


    --
  EXCEPTION WHEN EX_EXIT THEN

          ROLLBACK;
          VL_MESSAGE_H       := VL_MESSAGE_H || TRIM(SUBSTR(dbms_utility.format_error_backtrace() || ' ' || SQLERRM, 1, 255));
          PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                                  VL_PROGR_D_T040,
                                                  SQLCODE,
                                                  VL_MESSAGE_H);

          PO_MSG := VL_MESSAGE_H;
          PO_STATUS := -1;

   WHEN OTHERS THEN

          ROLLBACK;

          BEGIN
              -- Release updated records
              UPDATE T040PARTY
              SET       DTELCK          = NULL,
                        IDSESSIONLCK    = NULL,
                        CODUSRLCK       = NULL
              WHERE CODUSRLCK = C_SYSUSR AND IDSESSIONLCK = PI_SESSION_ID;
              COMMIT;

             -- Moves records from staging area to log staging area
             P_XIN_MOVE_TO_LOG(PI_PROGR_H, VL_PROGR_D_T049,'T049PVCATEGORY');
             P_XIN_MOVE_TO_LOG(PI_PROGR_H, VL_PROGR_D_T047,'T047PARTYCONTACT');
             P_XIN_MOVE_TO_LOG(PI_PROGR_H, VL_PROGR_D_T046,'T046PARTYBANK');
             P_XIN_MOVE_TO_LOG(PI_PROGR_H, VL_PROGR_D_T045,'T045PARTYWEEK');
             P_XIN_MOVE_TO_LOG(PI_PROGR_H, VL_PROGR_D_TA4410,'TA4410NOTES_CUST');
             P_XIN_MOVE_TO_LOG(PI_PROGR_H, VL_PROGR_D_T042,'T042PARTYADDR');
             P_XIN_MOVE_TO_LOG(PI_PROGR_H, VL_PROGR_D_T041,'T041PARTYDIV');
             P_XIN_MOVE_TO_LOG(PI_PROGR_H, VL_PROGR_D_T040,'T040PARTY');

          END;

          VL_MESSAGE_H       := VL_MESSAGE_H || TRIM(SUBSTR(dbms_utility.format_error_backtrace() || ' ' || SQLERRM, 1, 255));
          PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                                  VL_PROGR_D_T040,
                                                  SQLCODE,
                                                  VL_MESSAGE_H);

          PO_MSG := VL_MESSAGE_H;
          PO_STATUS := VL_STATUS;

  END LOAD_T04X_CUSTOMERS_INSERT;





  /*============================================================================*\
  /* Name: T048_CREDIT
        Loads SM1 tables
      • T048PARTYAMOUNT Invoice customer financial data: customer credit, exposition, etc..
      • Staging Area (SSA) tables
      • XIN_ T048PARTYAMOUNT

      Loading logic:
      UPDATE + INSERT record is updated if already exists (checking by primary key) and it is not already locked, record is inserted if it does not exist yet.

      Validity Checks:
      • Record found on  XIN_T048PARTYAMOUNT is loaded only if there is the head record in T040PARTY.

      Error handling:
      • All Errors will be logged in T852/T854 SM1 log tables and all staging area records will be stored into staging area log with sm1_status = 9.
      • Error on record,  it is discarded and import skip to next record to be loaded

      How to delete a record : you cannot delete records in T048PARTYAMOUNT by integration host.


     Input parameters :     PI_PROGR_H - unique sm1 job number ( T800SYSTEMACTIVITYLOG )
                            PI_SESSION_ID    - unique login session (T035LOGGEDUSERS)
     Outputparameters :     PO_MSG           - message of error if procedure exit with error
                            PO_STATUS        - 0 OK; -1 Error
     Author : Mariangela Bandiera
     Creation Date : 14 September 2012
     ----
     Updates :


    ============================================================================ */

   PROCEDURE LOAD_T048_CREDIT(PI_PROGR_H       IN NUMBER,
                         PI_SESSION_ID    IN NUMBER,
                         PO_MSG           OUT NOCOPY VARCHAR2,
                         PO_STATUS        OUT NOCOPY NUMBER ) IS

    -- -----------------------------------------
    -- Cursor on Customer Credit table T048PARTYAMOUNT
    -- -----------------------------------------
    CURSOR CL_XIN_T048 IS
      SELECT                           
        CODPARTY,   --Customer code
        VALORDERED,   --Ordered amount: sum of orders amount placed but no yet delivered [CONF:UMQTABS=CUR]
        VALDELIVERED,   --Delivered amount: sum of orders amount delivered but no yet invoiced [CONF:UMQTABS=CUR]
        VALMATURED,   --Expired invoices amount [CONF:UMQTABS=CUR]
        VALNOTMATURED,   --Not expired invoices amount [CONF:UMQTABS=CUR]
        VALEXPOSED,   --Total exposition (VALORDERED + VALDELIVERED + VALMATURED + VALNOTMATURED) [CONF:UMQTABS=CUR]
        CODDIV,   --Division code [CONF:QTABS=CDIV.COD]
        DTEVALIDCREDIT,   --Amounts last modification date
        VALCREDIT,   --Customer credit [CONF:UMQTABS=CUR]
        DTEMODCREDIT,   --Credit last modification date
        VALORDEREDX,   --Ordered amount for orders placed in SM1 and not sent to host
        DTEMODORDERDX,   --Last Modify date of total amount of the orders that havn't been sent to HOST yet.
        DTELASTCHECK,   --Last check of customer credit value. This date will be taken in account by the SM1 order module.When DteLastCheck <= DteValidCredit or DteModCredit or DteModOrderedX then the order is enabled, else the order is not enabled.
        VALDELTA,   --Delta between customer credit value and total sum of passive documents of the customer.This field is managed by the check credit value batch. [CONF:UMQTABS=CUR]
        AVGDAYSPAYRETARD,   --Average payment delay (in days)
        AVGDAYSOPENRETARD,   --
        DTEMAXCONT,   --contentious date
        CODMAXCONT,   --contentious code
    Z_INVOICE_AMOUNT,  --Overdue Amount/Expired invoices amount , If >0 new orders will blocked
        --
        SM1_DTECRE

        FROM  XIN_T048PARTYAMOUNT
        WHERE SM1_CODPROCESS = PI_PROGR_H
        ORDER BY CODPARTY,SM1_DTECRE;

    --
    VL_MESSAGE_H   VARCHAR2(4000) := 'Error while loading CUSTOMERS Credit T048';
    VL_MESSAGE_D   VARCHAR2(4000) := NULL;
    --
    VL_PROGR_D_T048    NUMBER := 0;
    VL_COUNT_XIN_T048  NUMBER := 0;
    VL_INS_T048        NUMBER := 0;
    --
    REC_T048 T048PARTYAMOUNT%ROWTYPE    := NULL;
    REC_T048_INIT T048PARTYAMOUNT%ROWTYPE    := NULL;
    --
    VL_DES_T048     X_FIELD_INFO_ARRAY;-- Array with fields db info
    --
    VL_STATUS NUMBER:= 0;
    VL_COUNT  NUMBER:= 0;
    --
    EX_EXIT  EXCEPTION;
    --
    VL_STEP   NUMBER:= 0; -- Used to ping t035
    VL_CODDIV VARCHAR2(30) := NULL;

  BEGIN

     -- init indexes and rebuild statistics
    P_XIN_INIT_INDEXES (PI_PROGR_H, 'T048PARTYAMOUNT');
    -- clean log
    P_XIN_CLEANUP_LOG (PI_PROGR_H, 'T048PARTYAMOUNT');
    --
    VL_PROGR_D_T048 := PKG_UTILS.LOG_NEW_DETAIL(PI_PROGR_H,
                                                'CUSTOMER CREDIT',
                                                'IMPORT --> T048PARTYAMOUNT',
                                                 0,
                                                 NULL);


    BEGIN
        --
        -- ----------------------------------------------------------
        -- Init arrays with FIELD_NAME=LENGTH and FIELDNAME=SM1_DEFAULT for all fields of table
        -- ----------------------------------------------------------
       VL_DES_T048.DELETE;
       P_INIT_SM1_FIELD_ARRAY ('T048PARTYAMOUNT',VL_DES_T048,VL_STATUS, VL_MESSAGE_H);
       execute immediate ( GL_INIT_REC) INTO REC_T048_INIT;

        IF (VL_STATUS <> 0 ) THEN
            VL_MESSAGE_D := GL_INIT_REC;
            RAISE EX_EXIT;
        END IF;
    EXCEPTION WHEN OTHERS THEN
        VL_MESSAGE_D := GL_INIT_REC;
        RAISE EX_EXIT;
    END;


    -- --------------------------------------------------------------
    -- Identifies Xin records to be loaded
    -- --------------------------------------------------------------
    BEGIN
        VL_MESSAGE_D := 'XIN_T048PARTYAMOUNT';
        UPDATE XIN_T048PARTYAMOUNT
        SET SM1_CODPROCESS = PI_PROGR_H,
            SM1_STATUS = 0,
            SM1_DTEPROCESS = XSYSDATE
            WHERE SM1_CODPROCESS = C_SM1_NULL_CODPROCESS;

        VL_COUNT_XIN_T048 := SQL%ROWCOUNT;

    COMMIT;
    EXCEPTION WHEN OTHERS THEN
      ROLLBACK;
      VL_MESSAGE_H := 'Error while Reading Staging area: '||VL_MESSAGE_D;
      RAISE EX_EXIT;

    END;
    -- --------------------------------------------------------------
    -- loop in main table T048PARTYAMOUNT
    -- --------------------------------------------------------------
    FOR RL_XIN_T048 IN CL_XIN_T048 LOOP
      -- pings to t035 every 1000 cicles--
      VL_STEP := VL_STEP + 1;
      IF ( MOD(VL_STEP, 1000) = 0 ) THEN
         PKG_UTILS.user_ping(PI_SESSION_ID);
      END IF;

      --
      VL_STATUS := 0;
      --
      VL_MESSAGE_H :=   'Customer : '||RL_XIN_T048.CODPARTY||' '||
                        'Division : '||RL_XIN_T048.CODDIV;
      --
      BEGIN --- HEAD T048

       -- Data Format Check
        VL_MESSAGE_D := 'Format Conversion ';
        VL_CODDIV:= RL_XIN_T048.CODDIV;
        REC_T048.CODPARTY := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T048.CODPARTY,'CODPARTY', VL_DES_T048,VL_STATUS, VL_MESSAGE_D);
        REC_T048.VALORDERED := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T048.VALORDERED,'VALORDERED', VL_DES_T048,VL_STATUS, VL_MESSAGE_D);
        REC_T048.VALDELIVERED := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T048.VALDELIVERED,'VALDELIVERED', VL_DES_T048,VL_STATUS, VL_MESSAGE_D);
        REC_T048.VALMATURED := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T048.VALMATURED,'VALMATURED', VL_DES_T048,VL_STATUS, VL_MESSAGE_D);
        REC_T048.VALNOTMATURED := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T048.VALNOTMATURED,'VALNOTMATURED', VL_DES_T048,VL_STATUS, VL_MESSAGE_D);
        REC_T048.VALEXPOSED := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T048.VALEXPOSED,'VALEXPOSED', VL_DES_T048,VL_STATUS, VL_MESSAGE_D);
        REC_T048.CODDIV := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T048.CODDIV,'CODDIV', VL_DES_T048,VL_STATUS, VL_MESSAGE_D);
        REC_T048.DTEVALIDCREDIT := SYSDATE ;-- F_CHECK_FORMAT_D( VL_CODDIV,   RL_XIN_T048.DTEVALIDCREDIT,'DTEVALIDCREDIT', VL_DES_T048,VL_STATUS, VL_MESSAGE_D);
        REC_T048.VALCREDIT := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T048.VALCREDIT,'VALCREDIT', VL_DES_T048,VL_STATUS, VL_MESSAGE_D);
        REC_T048.DTEMODCREDIT :=SYSDATE ;-- F_CHECK_FORMAT_D( VL_CODDIV,   RL_XIN_T048.DTEMODCREDIT,'DTEMODCREDIT', VL_DES_T048,VL_STATUS, VL_MESSAGE_D);
        REC_T048.VALORDEREDX := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T048.VALORDEREDX,'VALORDEREDX', VL_DES_T048,VL_STATUS, VL_MESSAGE_D);
        REC_T048.DTEMODORDERDX := SYSDATE ;-- F_CHECK_FORMAT_D( VL_CODDIV,   RL_XIN_T048.DTEMODORDERDX,'DTEMODORDERDX', VL_DES_T048,VL_STATUS, VL_MESSAGE_D);
        REC_T048.DTELASTCHECK := SYSDATE ;-- F_CHECK_FORMAT_D( VL_CODDIV,   RL_XIN_T048.DTELASTCHECK,'DTELASTCHECK', VL_DES_T048,VL_STATUS, VL_MESSAGE_D);
        REC_T048.VALDELTA := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T048.VALDELTA,'VALDELTA', VL_DES_T048,VL_STATUS, VL_MESSAGE_D);
        REC_T048.AVGDAYSPAYRETARD := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T048.AVGDAYSPAYRETARD,'AVGDAYSPAYRETARD', VL_DES_T048,VL_STATUS, VL_MESSAGE_D);
        REC_T048.AVGDAYSOPENRETARD := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T048.AVGDAYSOPENRETARD,'AVGDAYSOPENRETARD', VL_DES_T048,VL_STATUS, VL_MESSAGE_D);
        REC_T048.DTEMAXCONT := SYSDATE ;-- F_CHECK_FORMAT_D( VL_CODDIV,   RL_XIN_T048.DTEMAXCONT,'DTEMAXCONT', VL_DES_T048,VL_STATUS, VL_MESSAGE_D);
        REC_T048.CODMAXCONT := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T048.CODMAXCONT,'CODMAXCONT', VL_DES_T048,VL_STATUS, VL_MESSAGE_D);
    -- new column added for CR05(expired invoice amount )
    REC_T048.Z_INVOICE_AMOUNT := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T048.Z_INVOICE_AMOUNT,'Z_INVOICE_AMOUNT', VL_DES_T048,VL_STATUS, VL_MESSAGE_D);

        --- Technical fields
        REC_T048.DTEMOD     := XSYSDATE;
        -- Check Customer Existence
        VL_COUNT := 0;
         select count(*) into VL_COUNT from T041PARTYDIV WHERE CODPARTY = REC_T048.CODPARTY AND CODDIV = REC_T048.CODDIV ;
         -- select count(*) into VL_COUNT from T041PARTYDIV WHERE TRIM(CODCATDIV1) = REC_T048.CODPARTY AND CODDIV = REC_T048.CODDIV ;

        IF VL_COUNT = 0 THEN
           VL_MESSAGE_D := 'Customer does not exist  ';
           VL_STATUS := -1;
        ELSE
       select CODPARTY into  REC_T048.CODPARTY from T041PARTYDIV WHERE CODPARTY = REC_T048.CODPARTY AND CODDIV = REC_T048.CODDIV ;
        -- select CODPARTY into  REC_T048.CODPARTY from T041PARTYDIV WHERE TRIM(CODCATDIV1) = REC_T048.CODPARTY AND CODDIV = REC_T048.CODDIV ;

        END IF;


        IF (VL_STATUS <> 0 ) THEN

             VL_MESSAGE_H := SUBSTR(VL_MESSAGE_H||' '||VL_MESSAGE_D||' '||dbms_utility.format_error_backtrace() || ' ' || SQLERRM,1,4000);

             PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                           VL_PROGR_D_T048,
                                           SQLCODE,
                                           VL_MESSAGE_H);
        END IF;


        IF (VL_STATUS = 0 ) THEN
          -- when status <> 0 some fields have incorrect format. Log t800 has been already wrote by F_CHECK function
          -- Update article if already exists

           VL_MESSAGE_D := 'Update T048PartyAmount ';
           UPDATE T048PARTYAMOUNT
           SET
               -- when the field si set to updated by host it means that the value should be read from XIN
               -- otherwise it means that the field is managed by sm1 and it maintains its original value
                VALORDERED = CASE VL_DES_T048('VALORDERED.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T048.VALORDERED ELSE VALORDERED END,
                VALDELIVERED = CASE VL_DES_T048('VALDELIVERED.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T048.VALDELIVERED ELSE VALDELIVERED END,
                VALMATURED = CASE VL_DES_T048('VALMATURED.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T048.VALMATURED ELSE VALMATURED END,
                VALNOTMATURED = CASE VL_DES_T048('VALNOTMATURED.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T048.VALNOTMATURED ELSE VALNOTMATURED END,
                VALEXPOSED = CASE VL_DES_T048('VALEXPOSED.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T048.VALEXPOSED ELSE VALEXPOSED END,
                DTEVALIDCREDIT = CASE VL_DES_T048('DTEVALIDCREDIT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T048.DTEVALIDCREDIT ELSE DTEVALIDCREDIT END,
                VALCREDIT = CASE VL_DES_T048('VALCREDIT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T048.VALCREDIT ELSE VALCREDIT END,
                DTEMODCREDIT = CASE VL_DES_T048('DTEMODCREDIT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T048.DTEMODCREDIT ELSE DTEMODCREDIT END,
                VALORDEREDX = CASE VL_DES_T048('VALORDEREDX.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T048.VALORDEREDX ELSE VALORDEREDX END,
                DTEMODORDERDX = CASE VL_DES_T048('DTEMODORDERDX.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T048.DTEMODORDERDX ELSE DTEMODORDERDX END,
                DTELASTCHECK = CASE VL_DES_T048('DTELASTCHECK.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T048.DTELASTCHECK ELSE DTELASTCHECK END,
                VALDELTA = CASE VL_DES_T048('VALDELTA.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T048.VALDELTA ELSE VALDELTA END,
                AVGDAYSPAYRETARD = CASE VL_DES_T048('AVGDAYSPAYRETARD.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T048.AVGDAYSPAYRETARD ELSE AVGDAYSPAYRETARD END,
                AVGDAYSOPENRETARD = CASE VL_DES_T048('AVGDAYSOPENRETARD.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T048.AVGDAYSOPENRETARD ELSE AVGDAYSOPENRETARD END,
                DTEMAXCONT = CASE VL_DES_T048('DTEMAXCONT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T048.DTEMAXCONT ELSE DTEMAXCONT END,
                CODMAXCONT = CASE VL_DES_T048('CODMAXCONT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T048.CODMAXCONT ELSE CODMAXCONT END,
        
        Z_INVOICE_AMOUNT = CASE VL_DES_T048('Z_INVOICE_AMOUNT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T048.Z_INVOICE_AMOUNT ELSE Z_INVOICE_AMOUNT END,
        
                --- Technical fields
                DTEMOD    = REC_T048.DTEMOD

         WHERE CODPARTY = REC_T048.CODPARTY
           AND CODDIV   = REC_T048.CODDIV;


        -- no data found, it could be
        --   a. record does not exists

        IF SQL%ROWCOUNT = 0 THEN

              VL_MESSAGE_D := 'Insert T048PartyAmount ';
              -- Record does not exists, we insert it
              INSERT INTO T048PARTYAMOUNT VALUES REC_T048;
              --

        END IF; -- Record has been updated
          VL_INS_T048 := VL_INS_T048 + 1;
        END IF; -- vl_status

        EXCEPTION WHEN OTHERS THEN
             VL_STATUS := -1;
             VL_MESSAGE_H := SUBSTR(VL_MESSAGE_H||' '||VL_MESSAGE_D||' '||dbms_utility.format_error_backtrace() || ' ' || SQLERRM,1,4000);

             PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                           VL_PROGR_D_T048,
                                           SQLCODE,
                                           VL_MESSAGE_H);

        END; -- HEAD T048

      -- if all records have been stored with success then it makes the commit
      IF VL_STATUS = 0 THEN
         COMMIT;
      ELSE
        ROLLBACK;


      UPDATE XIN_T048PARTYAMOUNT
      SET  SM1_STATUS  = C_XINSTATUS_ERR
      WHERE CODPARTY = RL_XIN_T048.CODPARTY
       AND  CODDIV   = RL_XIN_T048.CODDIV
       AND  SM1_CODPROCESS = PI_PROGR_H
       AND  SM1_DTECRE = RL_XIN_T048.SM1_DTECRE
       AND  SM1_STATUS     = C_XINSTATUS_OK;
       VL_STATUS := 0;

      COMMIT;
      END IF;
    END LOOP;  -- T048PARTYAMOUNT

   /*
      UPDATE XIN_T048PARTYAMOUNT
      SET  SM1_STATUS =  C_XINSTATUS_OK
      WHERE SM1_CODPROCESS = PI_PROGR_H
       AND  SM1_STATUS     = C_XINSTATUS_OK;

      COMMIT;*/
    -- Moves records from staging area to log staging area
    P_XIN_MOVE_TO_LOG(PI_PROGR_H, VL_PROGR_D_T048,'T048PARTYAMOUNT');

   -- Close Logs
    PKG_UTILS.LOG_END_DETAIL(PI_PROGR_H,
                             VL_PROGR_D_T048,
                             0,
                             VL_COUNT_XIN_T048,
                             VL_INS_T048,
                             VL_COUNT_XIN_T048 - VL_INS_T048);


    PO_MSG    := VL_INS_T048||'/'||VL_COUNT_XIN_T048||' Credit info loaded';
    PO_STATUS := VL_INS_T048;


    --
  EXCEPTION WHEN EX_EXIT THEN

          ROLLBACK;
          VL_MESSAGE_H       := VL_MESSAGE_H || TRIM(SUBSTR(dbms_utility.format_error_backtrace() || ' ' || SQLERRM, 1, 255));
          PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                         VL_PROGR_D_T048,
                                         SQLCODE,
                                         VL_MESSAGE_H);

          PO_MSG := VL_MESSAGE_H;
          PO_STATUS := -1;

   WHEN OTHERS THEN

          ROLLBACK;
          -- Moves records from staging area to log staging area
          P_XIN_MOVE_TO_LOG(PI_PROGR_H, VL_PROGR_D_T048,'T048PARTYAMOUNT');

          VL_MESSAGE_H       := VL_MESSAGE_H || TRIM(SUBSTR(dbms_utility.format_error_backtrace() || ' ' || SQLERRM, 1, 255));
          PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                         VL_PROGR_D_T048,
                                         SQLCODE,
                                         VL_MESSAGE_H);

          PO_MSG := VL_MESSAGE_H;
          PO_STATUS := VL_STATUS;

  END LOAD_T048_CREDIT;




 /*============================================================================*\
  /* Name: T06X_PRODUCTS
       Loads SM1 tables
      • T060ARTICLE - product master data
      • T062UMCONV  - product unit of measure

      Staging Area (SSA) tables (Chronological Order expected in SSA  for each product):
      1.  XIN_T062UMCONV
      2.  XIN_T060ARTICLE

      Loading logic:
      T060 UPDATE + INSERT. Record is updated if already exists (checking by primary key) and it is not already locked, record is inserted if it does not exist yet.
      T062 DELETE whole product details + INSERT.

      Validity Checks:
      • Articles found on staging area are loaded to SM1 main tables only if they are not already opened for update by a SM1 user. In that case records remain in staging area ready to be loaded on next import run.
      • Details Records found on  XIN_T062 are loaded only if there is the head record in XIN_T060ARTICLE

      Error handling:
      • All Errors will be logged in T852/T854 SM1 log tables and all staging area records will be stored into staging area log with sm1_status = 9.
      • Error on head record (XIN_T060),  it is discarded with all its details.
      • Error on detail record (XIN_T062/XIN_T064),  ALL detail will be discarded.

      How to delete
      • a whole Product: products can be logically deleted by setting field XIN_T060ARTICLE.FLGANN=-1.
      • Product detail: if you need to maintain the history you can set FLGANN=-1 field where available, otherwise you can simply not write the detail on SSA anymore.



     Input parameters :     PI_PROGR_H - unique sm1 job number ( T800SYSTEMACTIVITYLOG )
                            PI_SESSION_ID    - unique login session (T035LOGGEDUSERS)
     Outputparameters :     PO_MSG           - message of error if procedure exit with error
                            PO_STATUS        - 0 OK; -1 Error
     Author : Mariangela Bandiera
     Creation Date : 23 August 2012
     ----
     Updates :

    2014 07 14; 020: Mbandiera; WI 32087;  some changes in T078WHSBALANCE import
                      -- 1. T078 loading will be splitted from T060 import . it will be a loading procedure  aside the article one.

    2014 07 14; 019: Mbandiera; WI 32070;
                                 1. bugfix T064 kit, for each article when an error is found on a kit record it skips all other kit records on the same article

     MBandiera 19 September 2013 , added new fields to T060
          T060ARTICLE.FLGBATCHNUMBER    NUMBER(1) default 0 not null;
          T060ARTICLE.CODEQUIPMENT      VARCHAR2(30);
          T060ARTICLE.FLGVARIABLEWEIGHT NUMBER(1) default 0 not null;
          T060ARTICLE.DSD_CODBLCCAUSE    VARCHAR2(30);
          T060ARTICLE.DSD_DELTAUMPERC   NUMBER(5,2);

     MBandiera 4 Dicember 2013 added new fields
                               + for new products a confirmed status is set in Workflow management


     MBandiera 31 July 2014 , added new fields to T060

     T060.UMWHS VARCHAR2(30)     Warehous unit of measure (smallest UM managed in the warehouse) [CONF:QTABS=UMART.COD]
     T060.CODPERISH VARCHAR2(30) Perish product; related to customer payment mode and term

    ============================================================================ */

  PROCEDURE LOAD_T06X_PRODUCTS(PI_PROGR_H  IN NUMBER,
                          PI_SESSION_ID    IN NUMBER,
                          PO_MSG           OUT NOCOPY VARCHAR2,
                          PO_STATUS        OUT NOCOPY NUMBER ) IS
    --
    -- Cursor on main Product table
    --
    CURSOR CL_XIN_T060 IS
      SELECT
          *

        FROM  XIN_T060ARTICLE
        WHERE SM1_CODPROCESS = PI_PROGR_H
        -- BEAWARE : his order is mandatory for a correct loading, if it is needed to change it, the whole procedure must be reviewed
        ORDER BY CODART, CODDIV, SM1_DTECRE ASC;

    --
    -- Unit Measure
    --
    CURSOR CL_XIN_T062(CI_CODART VARCHAR2, CI_CODDIV VARCHAR2, CI_SM1_DTECRE DATE) IS
      SELECT *
      --
        FROM XIN_T062UMCONV
       WHERE CODART = CI_CODART
         AND CODDIV = CI_CODDIV
         AND SM1_CODPROCESS = PI_PROGR_H
         AND SM1_DTECRE <= CI_SM1_DTECRE
         AND SM1_STATUS = C_XINSTATUS_OK -- Only those that have not processed yet (in case of double record in xin)
          ORDER BY SM1_DTECRE;


      --
    VL_MESSAGE_H   VARCHAR2(4000) := 'Error while loading PRODUCTS T06X';
    VL_MESSAGE_D   VARCHAR2(4000) := NULL;
    --
    VL_PROGR_D_T060         NUMBER := 0;
    VL_COUNT_XIN_T060       NUMBER := 0;
    VL_INS_T060             NUMBER := 0;
    --
    VL_PROGR_D_T062         NUMBER := 0;
    VL_COUNT_XIN_T062       NUMBER := 0;
    VL_INS_T062             NUMBER := 0;
     --
    vl_wf_stateid       TA2302WORKFLOWSTATES.STATEID%TYPE      := null;
    vl_wf_codstatehard  TA2302WORKFLOWSTATES.CODSTATEHARD%TYPE := null;
    --
    REC_T060      T060ARTICLE%ROWTYPE     := NULL;
    REC_T060_INIT T060ARTICLE%ROWTYPE     := NULL;

    REC_T062 T062UMCONV%ROWTYPE           := NULL;
    REC_T062_INIT T062UMCONV%ROWTYPE      := NULL;
     --
    VL_DES_T060     X_FIELD_INFO_ARRAY;
    VL_DES_T062     X_FIELD_INFO_ARRAY;-- Array with fields db info
   --
    VL_RECORD_LOCKED NUMBER := 0;

    VL_STATUS   NUMBER:= 0;
    VL_STATUS_D NUMBER:= 0;
    VL_COUNT    NUMBER:= 0;
    VL_STEP     NUMBER:= 0; -- Used to ping t035
    --
    EX_EXIT  EXCEPTION;
    --
    VL_CODDIV VARCHAR2(30) := NULL;


  BEGIN

    -- Rebuild indexes and compute statistics
    P_XIN_INIT_INDEXES (PI_PROGR_H, 'T060ARTICLE');
    P_XIN_INIT_INDEXES (PI_PROGR_H, 'T062UMCONV');

    -- Clean up older log
    P_XIN_CLEANUP_LOG (PI_PROGR_H, 'T060ARTICLE');
    P_XIN_CLEANUP_LOG (PI_PROGR_H, 'T062UMCONV');
    --

    VL_PROGR_D_T060 := PKG_UTILS.LOG_NEW_DETAIL(PI_PROGR_H,
                                                     'PRODUCTS HEAD',
                                                     'IMPORT --> T060ARTICLE',
                                                      0,
                                                      NULL);
    --
    VL_PROGR_D_T062 := PKG_UTILS.LOG_NEW_DETAIL(PI_PROGR_H,
                                                     'UNIT OF MEASURE',
                                                     'IMPORT --> T062UMCONV',
                                                      0,
                                                      NULL);
     VL_MESSAGE_H := GL_INIT_REC;
     BEGIN
          -- ----------------------------------------------------------
          -- Init arrays with FIELD_NAME=LENGTH and FIELDNAME=SM1_DEFAULT for all fields of table
          -- ----------------------------------------------------------
          VL_DES_T060.DELETE;
          P_INIT_SM1_FIELD_ARRAY('T060ARTICLE',VL_DES_T060,VL_STATUS, VL_MESSAGE_H);
          execute immediate ( GL_INIT_REC) INTO REC_T060_INIT;

          VL_DES_T062.DELETE;
          P_INIT_SM1_FIELD_ARRAY ('T062UMCONV',VL_DES_T062,VL_STATUS, VL_MESSAGE_H);
          execute immediate ( GL_INIT_REC)  INTO REC_T062_INIT;

        IF (VL_STATUS <> 0 ) THEN
            VL_MESSAGE_D := GL_INIT_REC;
            RAISE EX_EXIT;
        END IF;
    EXCEPTION WHEN OTHERS THEN
        VL_MESSAGE_D := GL_INIT_REC;
        RAISE EX_EXIT;
    END;
    -- --------------------------------------------------------------
    -- Identifies Xin records to be loaded
    -- --------------------------------------------------------------
    BEGIN
        VL_MESSAGE_D := 'XIN_T060ARTICLE';
        UPDATE XIN_T060ARTICLE
        SET SM1_CODPROCESS = PI_PROGR_H,
            SM1_STATUS = 0,
            SM1_DTEPROCESS = XSYSDATE
            WHERE SM1_CODPROCESS = C_SM1_NULL_CODPROCESS;
        VL_COUNT_XIN_T060 := SQL%ROWCOUNT;


        VL_MESSAGE_D := 'XIN_T062UMCONV';
        UPDATE XIN_T062UMCONV D
        SET D.SM1_CODPROCESS = PI_PROGR_H,
            D.SM1_STATUS = 0,
            D.SM1_DTEPROCESS = XSYSDATE
        WHERE (D.CODART, D.CODDIV) IN (SELECT H.CODART, H.CODDIV FROM XIN_T060ARTICLE H WHERE H.SM1_CODPROCESS = PI_PROGR_H AND H.SM1_DTECRE >= D.SM1_DTECRE )
        AND SM1_CODPROCESS = C_SM1_NULL_CODPROCESS;
       VL_COUNT_XIN_T062 := SQL%ROWCOUNT;

    COMMIT;
    EXCEPTION WHEN OTHERS THEN
      ROLLBACK;
      VL_MESSAGE_H := 'Error while Reading Staging area: '||VL_MESSAGE_D;
      RAISE EX_EXIT;
    END;

    -- --------------------------------------------------------------
    -- Work flow init status
    -- --------------------------------------------------------------
   /* BEGIN

    P_GET_WF_INIT_STATUS(C_WORKFLOWID_T060, 'T060ARTICLE', vl_wf_stateid,vl_wf_codstatehard, VL_STATUS);

    if (vl_status <> 0 ) then
      VL_MESSAGE_H := 'Error retrieving Workflow init status';
      RAISE EX_EXIT;
    end if;

    EXCEPTION WHEN OTHERS THEN
      VL_MESSAGE_H := 'Error retrieving Workflow init status';
      RAISE EX_EXIT;
    END;
    */
    -- ------------------------------------------------------------------

    -- --------------------------------------------------------------
    -- loop in main table T060ARTICLE
    -- --------------------------------------------------------------
    FOR RL_XIN_T060 IN CL_XIN_T060 LOOP
      -- pings to t035 every 1000 cicles--
      VL_STEP := VL_STEP + 1;
      IF ( MOD(VL_STEP, 1000) = 0 ) THEN
         PKG_UTILS.user_ping(PI_SESSION_ID);
      END IF;

      --
      VL_STATUS := 0;
      VL_RECORD_LOCKED := 0;
      --
      VL_MESSAGE_H :=   'Product: '||RL_XIN_T060.CODART || '/' ||
                        RL_XIN_T060.CODDIV;
      --
      BEGIN --- HEAD T060
        REC_T060 := REC_T060_INIT;
      -- Data Format Check
        VL_MESSAGE_D := 'Format Conversion ';
        VL_CODDIV:= RL_XIN_T060.CODDIV;
        REC_T060.CODART     := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T060.CODART,'CODART', VL_DES_T060,VL_STATUS,VL_MESSAGE_D);
        REC_T060.CODDIV     := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T060.CODDIV,'CODDIV', VL_DES_T060,VL_STATUS, VL_MESSAGE_D);
        REC_T060.CODART2    := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T060.CODART2,'CODART2', VL_DES_T060,VL_STATUS, VL_MESSAGE_D);
        REC_T060.CODART3    := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T060.CODART3,'CODART3', VL_DES_T060,VL_STATUS, VL_MESSAGE_D);
        REC_T060.DESART     := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T060.DESART,'DESART', VL_DES_T060,VL_STATUS, VL_MESSAGE_D);
        REC_T060.DESART2    := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T060.DESART2,'DESART2', VL_DES_T060,VL_STATUS, VL_MESSAGE_D);
        REC_T060.CODEAN13   := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T060.CODEAN13,'CODEAN13', VL_DES_T060,VL_STATUS, VL_MESSAGE_D);
        REC_T060.CODCATMER  := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T060.CODCATMER,'CODCATMER', VL_DES_T060,VL_STATUS, VL_MESSAGE_D);
        REC_T060.CODSAL1    := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T060.CODSAL1,'CODSAL1', VL_DES_T060,VL_STATUS, VL_MESSAGE_D);
        REC_T060.CODLINMER  := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T060.CODLINMER,'CODLINMER', VL_DES_T060,VL_STATUS, VL_MESSAGE_D);
        REC_T060.CODSAL2    := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T060.CODSAL2,'CODSAL2', VL_DES_T060,VL_STATUS, VL_MESSAGE_D);
        REC_T060.CODFAMMER  := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T060.CODFAMMER,'CODFAMMER', VL_DES_T060,VL_STATUS, VL_MESSAGE_D);
        REC_T060.CODSAL3    := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T060.CODSAL3,'CODSAL3', VL_DES_T060,VL_STATUS, VL_MESSAGE_D);
        REC_T060.CODBRAND   := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T060.CODBRAND,'CODBRAND', VL_DES_T060,VL_STATUS, VL_MESSAGE_D);
        REC_T060.CODSAL4    := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T060.CODSAL4,'CODSAL4', VL_DES_T060,VL_STATUS, VL_MESSAGE_D);
        REC_T060.CODFRMT    := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T060.CODFRMT,'CODFRMT', VL_DES_T060,VL_STATUS, VL_MESSAGE_D);
        REC_T060.CODSAL5    := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T060.CODSAL5,'CODSAL5', VL_DES_T060,VL_STATUS, VL_MESSAGE_D);
        REC_T060.CODPRODMGR := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T060.CODPRODMGR,'CODPRODMGR', VL_DES_T060,VL_STATUS, VL_MESSAGE_D);
        REC_T060.CODPUR1    := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T060.CODPUR1,'CODPUR1', VL_DES_T060,VL_STATUS, VL_MESSAGE_D);
        REC_T060.CODPUR2    := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T060.CODPUR2,'CODPUR2', VL_DES_T060,VL_STATUS, VL_MESSAGE_D);
        REC_T060.CODPUR3    := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T060.CODPUR3,'CODPUR3', VL_DES_T060,VL_STATUS, VL_MESSAGE_D);
        REC_T060.CODPUR4    := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T060.CODPUR4,'CODPUR4', VL_DES_T060,VL_STATUS, VL_MESSAGE_D);
        REC_T060.CODPUR5    := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T060.CODPUR5,'CODPUR5', VL_DES_T060,VL_STATUS, VL_MESSAGE_D);
        REC_T060.VALHEIGHT  := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T060.VALHEIGHT,'VALHEIGHT', VL_DES_T060,VL_STATUS, VL_MESSAGE_D);
        REC_T060.VALWIDTH   := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T060.VALWIDTH,'VALWIDTH', VL_DES_T060,VL_STATUS, VL_MESSAGE_D);
        REC_T060.VALDEPTH   := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T060.VALDEPTH,'VALDEPTH', VL_DES_T060,VL_STATUS, VL_MESSAGE_D);
        REC_T060.UMDIMENSION    := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T060.UMDIMENSION,'UMDIMENSION', VL_DES_T060,VL_STATUS, VL_MESSAGE_D);
        REC_T060.VALNETWEIGHT   := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T060.VALNETWEIGHT,'VALNETWEIGHT', VL_DES_T060,VL_STATUS, VL_MESSAGE_D);
        REC_T060.VALGROSSWEIGHT := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T060.VALGROSSWEIGHT,'VALGROSSWEIGHT', VL_DES_T060,VL_STATUS, VL_MESSAGE_D);
        REC_T060.UMWEIGHT       := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T060.UMWEIGHT,'UMWEIGHT', VL_DES_T060,VL_STATUS, VL_MESSAGE_D);
        REC_T060.VALVOLUME      := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T060.VALVOLUME,'VALVOLUME', VL_DES_T060,VL_STATUS, VL_MESSAGE_D);
        REC_T060.UMVOLUME       := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T060.UMVOLUME,'UMVOLUME', VL_DES_T060,VL_STATUS, VL_MESSAGE_D);
        REC_T060.UMINV1         := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T060.UMINV1,'UMINV1', VL_DES_T060,VL_STATUS, VL_MESSAGE_D);
        REC_T060.UMINV2         := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T060.UMINV2,'UMINV2', VL_DES_T060,VL_STATUS, VL_MESSAGE_D);
        REC_T060.UMDEL          := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T060.UMDEL,'UMDEL', VL_DES_T060,VL_STATUS, VL_MESSAGE_D);
        REC_T060.UMORDMIN       := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T060.UMORDMIN,'UMORDMIN', VL_DES_T060,VL_STATUS, VL_MESSAGE_D);
        REC_T060.UMORD1         := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T060.UMORD1,'UMORD1', VL_DES_T060,VL_STATUS, VL_MESSAGE_D);
        REC_T060.FLGCHKAVAIL    := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T060.FLGCHKAVAIL,'FLGCHKAVAIL', VL_DES_T060,VL_STATUS, VL_MESSAGE_D);
        REC_T060.UMORD2         := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T060.UMORD2,'UMORD2', VL_DES_T060,VL_STATUS, VL_MESSAGE_D);
        REC_T060.FLGARTCOMP     := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T060.FLGARTCOMP,'FLGARTCOMP', VL_DES_T060,VL_STATUS, VL_MESSAGE_D);
        REC_T060.UMORD4         := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T060.UMORD4,'UMORD4', VL_DES_T060,VL_STATUS, VL_MESSAGE_D);
        REC_T060.UMORD5         := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T060.UMORD5,'UMORD5', VL_DES_T060,VL_STATUS, VL_MESSAGE_D);
        REC_T060.UMORD3         := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T060.UMORD3,'UMORD3', VL_DES_T060,VL_STATUS, VL_MESSAGE_D);
        REC_T060.FLGARTKIT      := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T060.FLGARTKIT,'FLGARTKIT', VL_DES_T060,VL_STATUS, VL_MESSAGE_D);
        REC_T060.PRCIVA         := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T060.PRCIVA,'PRCIVA', VL_DES_T060,VL_STATUS, VL_MESSAGE_D);
        REC_T060.CODSTATUS      := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T060.CODSTATUS,'CODSTATUS', VL_DES_T060,VL_STATUS, VL_MESSAGE_D);
        REC_T060.DTEORDFROM     := F_CHECK_FORMAT_D( VL_CODDIV,  RL_XIN_T060.DTEORDFROM,'DTEORDFROM', VL_DES_T060,VL_STATUS, VL_MESSAGE_D);
        REC_T060.CODBLCCAUSE    := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T060.CODBLCCAUSE,'CODBLCCAUSE', VL_DES_T060,VL_STATUS, VL_MESSAGE_D);
        REC_T060.FLGGIFT        := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T060.FLGGIFT,'FLGGIFT', VL_DES_T060,VL_STATUS, VL_MESSAGE_D);
        REC_T060.DTEORDTO       := F_CHECK_FORMAT_D( VL_CODDIV,  RL_XIN_T060.DTEORDTO,'DTEORDTO', VL_DES_T060,VL_STATUS, VL_MESSAGE_D);
        REC_T060.FLGORDERABLE   := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T060.FLGORDERABLE,'FLGORDERABLE', VL_DES_T060,VL_STATUS, VL_MESSAGE_D);
        REC_T060.FLGANN         := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T060.FLGANN,'FLGANN', VL_DES_T060,VL_STATUS, VL_MESSAGE_D);
        REC_T060.QTYORDMIN      := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T060.QTYORDMIN,'QTYORDMIN', VL_DES_T060,VL_STATUS, VL_MESSAGE_D);
        REC_T060.FLGRETURNABLE  := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T060.FLGRETURNABLE,'FLGRETURNABLE', VL_DES_T060,VL_STATUS, VL_MESSAGE_D);
        REC_T060.FLGBUDGET      := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T060.FLGBUDGET,'FLGBUDGET', VL_DES_T060,VL_STATUS, VL_MESSAGE_D);
        REC_T060.CODCAUSEKIT    := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T060.CODCAUSEKIT,'CODCAUSEKIT', VL_DES_T060,VL_STATUS, VL_MESSAGE_D);
        REC_T060.FLG_TRA_PERIF  := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T060.FLG_TRA_PERIF,'FLG_TRA_PERIF', VL_DES_T060,VL_STATUS, VL_MESSAGE_D);
        REC_T060.CODSTATUSCUST  := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T060.CODSTATUSCUST,'CODSTATUSCUST', VL_DES_T060,VL_STATUS, VL_MESSAGE_D);
        REC_T060.FLGPROMO       := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T060.FLGPROMO,'FLGPROMO', VL_DES_T060,VL_STATUS, VL_MESSAGE_D);
        REC_T060.CODCATEGORY    := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T060.CODCATEGORY,'CODCATEGORY', VL_DES_T060,VL_STATUS, VL_MESSAGE_D);
        REC_T060.CODSEGM        := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T060.CODSEGM,'CODSEGM', VL_DES_T060,VL_STATUS, VL_MESSAGE_D);
        REC_T060.FLGARTFITTIZIO := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T060.FLGARTFITTIZIO,'FLGARTFITTIZIO', VL_DES_T060,VL_STATUS, VL_MESSAGE_D);
        REC_T060.CODARTSOURCE   := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T060.CODARTSOURCE,'CODARTSOURCE', VL_DES_T060,VL_STATUS, VL_MESSAGE_D);
        REC_T060.FLGCOMPETITOR  := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T060.FLGCOMPETITOR,'FLGCOMPETITOR', VL_DES_T060,VL_STATUS, VL_MESSAGE_D);
        REC_T060.FLGTOP         := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T060.FLGTOP,'FLGTOP', VL_DES_T060,VL_STATUS, VL_MESSAGE_D);
        REC_T060.CODSAL6        := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T060.CODSAL6,'CODSAL6', VL_DES_T060,VL_STATUS, VL_MESSAGE_D);
        REC_T060.CODSAL7        := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T060.CODSAL7,'CODSAL7', VL_DES_T060,VL_STATUS, VL_MESSAGE_D);
        REC_T060.CODSAL8        := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T060.CODSAL8,'CODSAL8', VL_DES_T060,VL_STATUS, VL_MESSAGE_D);
        REC_T060.CODSAL9        := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T060.CODSAL9,'CODSAL9', VL_DES_T060,VL_STATUS, VL_MESSAGE_D);
        REC_T060.CODSAL10       := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T060.CODSAL10,'CODSAL10', VL_DES_T060,VL_STATUS, VL_MESSAGE_D);
        REC_T060.FLGSEASONAL    := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T060.FLGSEASONAL,'FLGSEASONAL', VL_DES_T060,VL_STATUS, VL_MESSAGE_D);
        REC_T060.CODARTSUBST    := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T060.CODARTSUBST,'CODARTSUBST', VL_DES_T060,VL_STATUS, VL_MESSAGE_D);
        REC_T060.NUMSHELFLIFE   := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T060.NUMSHELFLIFE,'NUMSHELFLIFE', VL_DES_T060,VL_STATUS, VL_MESSAGE_D);

        REC_T060.FLGBATCHNUMBER    := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T060.FLGBATCHNUMBER,'FLGBATCHNUMBER', VL_DES_T060,VL_STATUS, VL_MESSAGE_D);
        REC_T060.CODEQUIPMENT      := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T060.CODEQUIPMENT,'CODEQUIPMENT', VL_DES_T060,VL_STATUS, VL_MESSAGE_D);
        REC_T060.FLGVARIABLEWEIGHT := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T060.FLGVARIABLEWEIGHT,'FLGVARIABLEWEIGHT', VL_DES_T060,VL_STATUS, VL_MESSAGE_D);
        REC_T060.DSD_CODBLCCAUSE   := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T060.DSD_CODBLCCAUSE,'DSD_CODBLCCAUSE', VL_DES_T060,VL_STATUS, VL_MESSAGE_D);
        REC_T060.DSD_DELTAUMPERC   := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T060.DSD_DELTAUMPERC,'DSD_DELTAUMPERC', VL_DES_T060,VL_STATUS, VL_MESSAGE_D);
        --
        REC_T060.CODARTBLREF       := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T060.CODARTBLREF,'CODARTBLREF', VL_DES_T060,VL_STATUS, VL_MESSAGE_D);
        REC_T060.EST_QTY           := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T060.EST_QTY,    'EST_QTY',     VL_DES_T060,VL_STATUS, VL_MESSAGE_D);
        REC_T060.FLGDISPLAY        := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T060.FLGDISPLAY, 'FLGDISPLAY',  VL_DES_T060,VL_STATUS, VL_MESSAGE_D);
        REC_T060.VALBLCONV         := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T060.VALBLCONV,  'VALBLCONV',   VL_DES_T060,VL_STATUS, VL_MESSAGE_D);

        REC_T060.UMWHS             := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T060.UMWHS,'UMWHS', VL_DES_T060,VL_STATUS, VL_MESSAGE_D);
        REC_T060.CODPERISH         := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T060.CODPERISH,'CODPERISH', VL_DES_T060,VL_STATUS, VL_MESSAGE_D);


        --- DCODE-DAL Customisation Parts (Migration pupose )

        REC_T060.Z_DESARTLONG      := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T060.Z_DESARTLONG,'Z_DESARTLONG', VL_DES_T060,VL_STATUS, VL_MESSAGE_D);
        REC_T060.Z_FLGFASTMOVE     := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T060.Z_FLGFASTMOVE,'Z_FLGFASTMOVE', VL_DES_T060,VL_STATUS, VL_MESSAGE_D);

        REC_T060.Z_RNCCAT          := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T060.Z_RNCCAT,'Z_RNCCAT', VL_DES_T060,VL_STATUS, VL_MESSAGE_D);
        REC_T060.Z_XTELCAT         := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T060.Z_XTELCAT,'Z_XTELCAT', VL_DES_T060,VL_STATUS, VL_MESSAGE_D);

        REC_T060.Z_DALCAT          := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T060.Z_DALCAT,'Z_DALCAT', VL_DES_T060,VL_STATUS, VL_MESSAGE_D);
        REC_T060.Z_FLGRCPRODUCT    := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T060.Z_FLGRCPRODUCT,'Z_FLGRCPRODUCT', VL_DES_T060,VL_STATUS, VL_MESSAGE_D);
        REC_T060.Z_FLGDAL          := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T060.Z_FLGDAL,'Z_FLGDAL', VL_DES_T060,VL_STATUS, VL_MESSAGE_D);



        --- Technical fields
        REC_T060.DTECRE     := XSYSDATE;
        REC_T060.CODUSRMOD  := C_SYSUSR;
        REC_T060.CODUSRMODREAL  := C_SYSUSR;
        REC_T060.CODUSRCREREAL  := C_SYSUSR;
        REC_T060.DTEMOD     := XSYSDATE;
        -- workflow fields
        -- new article is always confermed
        REC_T060.IDWFSTATE      :=4;-- vl_wf_stateid;
        REC_T060.IDWFMODEL      := 60;-- C_WORKFLOWID_T060; -- Workflow for products
        REC_T060.CODWFSTATEHARD := 'BOZ';--vl_wf_codstatehard; -- confirmed
        -- lock fields
        REC_T060.CODUSRLCK     := C_SYSUSR;
        REC_T060.IDSESSIONLCK  := PI_SESSION_ID;
        REC_T060.DTELCK        := XSYSDATE;
        -- DocumentKey
        REC_T060.DOCUMENTKEY   := PKG_UTILS.documentkey_for_t060(REC_T060.CODART,REC_T060.CODDIV);

        IF (VL_STATUS <> 0 ) THEN

         VL_MESSAGE_H := SUBSTR(VL_MESSAGE_H||' '||VL_MESSAGE_D||' '||dbms_utility.format_error_backtrace() || ' ' || SQLERRM,1,4000);

             PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                           VL_PROGR_D_T060,
                                           SQLCODE,
                                           VL_MESSAGE_H);
        END IF;

        IF (VL_STATUS = 0 ) THEN
          -- when status <> 0 some fields have incorrect format. Log t800 has been already wrote by F_CHECK function
          -- Update article if already exists



     VL_MESSAGE_D := 'Update T060article ';


         UPDATE T060ARTICLE
           SET
               -- when the field si set to updated by host it means that the value should be read from XIN
               -- otherwise it means that the field is managed by sm1 and it maintains its original value
                  CODART2     = CASE VL_DES_T060('CODART2.ALL').FLG_SM1 WHEN 0 THEN REC_T060.CODART2 ELSE CODART2 END,
               /*   CODART3     = CASE VL_DES_T060('CODART3.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T060.CODART3 ELSE CODART3 END,
                  DESART      = CASE VL_DES_T060('DESART.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T060.DESART ELSE DESART END,
                  DESART2     = CASE VL_DES_T060('DESART2.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T060.DESART2 ELSE DESART2 END,
                  CODEAN13    = CASE VL_DES_T060('CODEAN13.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T060.CODEAN13 ELSE CODEAN13 END,
                  CODCATMER   = CASE VL_DES_T060('CODCATMER.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T060.CODCATMER ELSE CODCATMER END,
                  CODSAL1     = CASE VL_DES_T060('CODSAL1.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T060.CODSAL1 ELSE CODSAL1 END,
                  CODLINMER   = CASE VL_DES_T060('CODLINMER.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T060.CODLINMER ELSE CODLINMER END,
                  CODSAL2     = CASE VL_DES_T060('CODSAL2.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T060.CODSAL2 ELSE CODSAL2 END,
                  CODFAMMER   = CASE VL_DES_T060('CODFAMMER.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T060.CODFAMMER ELSE CODFAMMER END,
                  CODSAL3     = CASE VL_DES_T060('CODSAL3.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T060.CODSAL3 ELSE CODSAL3 END,
                  CODBRAND    = CASE VL_DES_T060('CODBRAND.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T060.CODBRAND ELSE CODBRAND END,
                  CODSAL4     = CASE VL_DES_T060('CODSAL4.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T060.CODSAL4 ELSE CODSAL4 END,
                  CODFRMT     = CASE VL_DES_T060('CODFRMT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T060.CODFRMT ELSE CODFRMT END,
                  CODSAL5     = CASE VL_DES_T060('CODSAL5.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T060.CODSAL5 ELSE CODSAL5 END,
                  CODPRODMGR  = CASE VL_DES_T060('CODPRODMGR.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T060.CODPRODMGR ELSE CODPRODMGR END,
                  CODPUR1     = CASE VL_DES_T060('CODPUR1.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T060.CODPUR1 ELSE CODPUR1 END,
                  CODPUR2     = CASE VL_DES_T060('CODPUR2.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T060.CODPUR2 ELSE CODPUR2 END,
                  CODPUR3     = CASE VL_DES_T060('CODPUR3.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T060.CODPUR3 ELSE CODPUR3 END,
                  CODPUR4     = CASE VL_DES_T060('CODPUR4.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T060.CODPUR4 ELSE CODPUR4 END,
                  CODPUR5     = CASE VL_DES_T060('CODPUR5.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T060.CODPUR5 ELSE CODPUR5 END,
                  VALHEIGHT   = CASE VL_DES_T060('VALHEIGHT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T060.VALHEIGHT ELSE VALHEIGHT END,
                  VALWIDTH    = CASE VL_DES_T060('VALWIDTH.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T060.VALWIDTH ELSE VALWIDTH END,
                  VALDEPTH    = CASE VL_DES_T060('VALDEPTH.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T060.VALDEPTH ELSE VALDEPTH END,
                  UMDIMENSION = CASE VL_DES_T060('UMDIMENSION.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T060.UMDIMENSION ELSE UMDIMENSION END,
                  VALNETWEIGHT = CASE VL_DES_T060('VALNETWEIGHT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T060.VALNETWEIGHT ELSE VALNETWEIGHT END,
                  VALGROSSWEIGHT = CASE VL_DES_T060('VALGROSSWEIGHT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T060.VALGROSSWEIGHT ELSE VALGROSSWEIGHT END,
                  UMWEIGHT       = CASE VL_DES_T060('UMWEIGHT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T060.UMWEIGHT ELSE UMWEIGHT END,
                  VALVOLUME   = CASE VL_DES_T060('VALVOLUME.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T060.VALVOLUME ELSE VALVOLUME END,
                  UMVOLUME    = CASE VL_DES_T060('UMVOLUME.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T060.UMVOLUME ELSE UMVOLUME END,
                  */
                  UMORD1      = CASE VL_DES_T060('UMORD1.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T060.UMORD1 ELSE UMORD1 END,
                  UMINV1      = CASE VL_DES_T060('UMINV1.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T060.UMINV1 ELSE UMINV1 END,
                  /*UMINV2      = CASE VL_DES_T060('UMINV2.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T060.UMINV2 ELSE UMINV2 END,
                  UMDEL       = CASE VL_DES_T060('UMDEL.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T060.UMDEL ELSE UMDEL END,
                  UMORDMIN    = CASE VL_DES_T060('UMORDMIN.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T060.UMORDMIN ELSE UMORDMIN END,

                  FLGCHKAVAIL = CASE VL_DES_T060('FLGCHKAVAIL.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T060.FLGCHKAVAIL ELSE FLGCHKAVAIL END,
                  UMORD2      = CASE VL_DES_T060('UMORD2.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T060.UMORD2 ELSE UMORD2 END,
                  FLGARTCOMP = CASE VL_DES_T060('FLGARTCOMP.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T060.FLGARTCOMP ELSE FLGARTCOMP END,
                  UMORD4     = CASE VL_DES_T060('UMORD4.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T060.UMORD4 ELSE UMORD4 END,
                  UMORD5     = CASE VL_DES_T060('UMORD5.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T060.UMORD5 ELSE UMORD5 END,
                  UMORD3     = CASE VL_DES_T060('UMORD3.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T060.UMORD3 ELSE UMORD3 END,
                  FLGARTKIT  = CASE VL_DES_T060('FLGARTKIT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T060.FLGARTKIT ELSE FLGARTKIT END,
                  PRCIVA     = CASE VL_DES_T060('PRCIVA.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T060.PRCIVA ELSE PRCIVA END,
                  CODSTATUS  = CASE VL_DES_T060('CODSTATUS.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T060.CODSTATUS ELSE CODSTATUS END,
                  DTEORDFROM = CASE VL_DES_T060('DTEORDFROM.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T060.DTEORDFROM ELSE DTEORDFROM END,
                  CODBLCCAUSE = CASE VL_DES_T060('CODBLCCAUSE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T060.CODBLCCAUSE ELSE CODBLCCAUSE END,
                  FLGGIFT     = CASE VL_DES_T060('FLGGIFT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T060.FLGGIFT ELSE FLGGIFT END,
                  DTEORDTO    = CASE VL_DES_T060('DTEORDTO.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T060.DTEORDTO ELSE DTEORDTO END,
                  FLGORDERABLE = CASE VL_DES_T060('FLGORDERABLE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T060.FLGORDERABLE ELSE FLGORDERABLE END,
                  FLGANN       = CASE VL_DES_T060('FLGANN.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T060.FLGANN ELSE FLGANN END,
                  QTYORDMIN    = CASE VL_DES_T060('QTYORDMIN.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T060.QTYORDMIN ELSE QTYORDMIN END,
                  FLGRETURNABLE = CASE VL_DES_T060('FLGRETURNABLE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T060.FLGRETURNABLE ELSE FLGRETURNABLE END,
                  FLGBUDGET     = CASE VL_DES_T060('FLGBUDGET.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T060.FLGBUDGET ELSE FLGBUDGET END,
                  CODCAUSEKIT   = CASE VL_DES_T060('CODCAUSEKIT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T060.CODCAUSEKIT ELSE CODCAUSEKIT END,
                  FLG_TRA_PERIF = CASE VL_DES_T060('FLG_TRA_PERIF.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T060.FLG_TRA_PERIF ELSE FLG_TRA_PERIF END,
                  CODSTATUSCUST = CASE VL_DES_T060('CODSTATUSCUST.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T060.CODSTATUSCUST ELSE CODSTATUSCUST END,
                  FLGPROMO      = CASE VL_DES_T060('FLGPROMO.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T060.FLGPROMO ELSE FLGPROMO END,
                  CODCATEGORY   = CASE VL_DES_T060('CODCATEGORY.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T060.CODCATEGORY ELSE CODCATEGORY END,
                  CODSEGM       = CASE VL_DES_T060('CODSEGM.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T060.CODSEGM ELSE CODSEGM END,
                  FLGARTFITTIZIO = CASE VL_DES_T060('FLGARTFITTIZIO.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T060.FLGARTFITTIZIO ELSE FLGARTFITTIZIO END,
                  CODARTSOURCE   = CASE VL_DES_T060('CODARTSOURCE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T060.CODARTSOURCE ELSE CODARTSOURCE END,
                  FLGCOMPETITOR = CASE VL_DES_T060('FLGCOMPETITOR.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T060.FLGCOMPETITOR ELSE FLGCOMPETITOR END,
                  FLGTOP        = CASE VL_DES_T060('FLGTOP.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T060.FLGTOP ELSE FLGTOP END,
                  CODSAL6       = CASE VL_DES_T060('CODSAL6.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T060.CODSAL6 ELSE CODSAL6 END,
                  CODSAL7       = CASE VL_DES_T060('CODSAL7.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T060.CODSAL7 ELSE CODSAL7 END,
                  CODSAL8       = CASE VL_DES_T060('CODSAL8.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T060.CODSAL8 ELSE CODSAL8 END,
                  CODSAL9       = CASE VL_DES_T060('CODSAL9.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T060.CODSAL9 ELSE CODSAL9 END,
                  CODSAL10      = CASE VL_DES_T060('CODSAL10.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T060.CODSAL10 ELSE CODSAL10 END,
                  FLGSEASONAL   = CASE VL_DES_T060('FLGSEASONAL.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T060.FLGSEASONAL ELSE FLGSEASONAL END,
                  CODARTSUBST   = CASE VL_DES_T060('CODARTSUBST.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T060.CODARTSUBST ELSE CODARTSUBST END,
                  NUMSHELFLIFE  = CASE VL_DES_T060('NUMSHELFLIFE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T060.NUMSHELFLIFE ELSE NUMSHELFLIFE END,
                  FLGBATCHNUMBER  = CASE VL_DES_T060('FLGBATCHNUMBER.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T060.FLGBATCHNUMBER ELSE FLGBATCHNUMBER END,
                  CODEQUIPMENT    = CASE VL_DES_T060('CODEQUIPMENT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T060.CODEQUIPMENT ELSE CODEQUIPMENT END,
                  FLGVARIABLEWEIGHT  = CASE VL_DES_T060('FLGVARIABLEWEIGHT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T060.FLGVARIABLEWEIGHT ELSE FLGVARIABLEWEIGHT END,
                  DSD_CODBLCCAUSE    = CASE VL_DES_T060('DSD_CODBLCCAUSE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T060.DSD_CODBLCCAUSE ELSE DSD_CODBLCCAUSE END,
                  DSD_DELTAUMPERC    = CASE VL_DES_T060('DSD_DELTAUMPERC.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T060.DSD_DELTAUMPERC ELSE DSD_DELTAUMPERC END,
                  --
                  CODARTBLREF       = CASE VL_DES_T060('CODARTBLREF.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T060.CODARTBLREF ELSE CODARTBLREF END,
                  EST_QTY           = CASE VL_DES_T060('EST_QTY.ALL').FLG_SM1     WHEN C_UPDATED_BY_HOST THEN REC_T060.EST_QTY     ELSE EST_QTY END,
                  FLGDISPLAY        = CASE VL_DES_T060('FLGDISPLAY.ALL').FLG_SM1  WHEN C_UPDATED_BY_HOST THEN REC_T060.FLGDISPLAY  ELSE FLGDISPLAY END,
                  VALBLCONV         = CASE VL_DES_T060('VALBLCONV.ALL').FLG_SM1   WHEN C_UPDATED_BY_HOST THEN REC_T060.VALBLCONV   ELSE VALBLCONV END,

                  UMWHS             = CASE VL_DES_T060('UMWHS.ALL').FLG_SM1   WHEN C_UPDATED_BY_HOST THEN REC_T060.UMWHS   ELSE UMWHS END,
                  CODPERISH         = CASE VL_DES_T060('CODPERISH.ALL').FLG_SM1   WHEN C_UPDATED_BY_HOST THEN REC_T060.CODPERISH   ELSE CODPERISH END,
               */
                --- Technical fields
                CODUSRMOD = REC_T060.CODUSRMOD,
                DTEMOD    = REC_T060.DTEMOD,
                -- lock fields
                CODUSRLCK    = REC_T060.CODUSRLCK,
                IDSESSIONLCK = REC_T060.IDSESSIONLCK,
                DTELCK       = REC_T060.DTELCK

         WHERE CODART = REC_T060.CODART AND UMORD1 IS NULL
           AND CODDIV = REC_T060.CODDIV
           and not exists ( select null from T035LOGGEDUSERS T035 where T035.IDSESSION = NVL(IDSESSIONLCK, '@') AND T035.LASTCHECK > TRUNC(XSYSDATE)-1 );

        -- no data found, it could be
        --   a. record does not exists
        --   b. record is locked by another sm1 user

        IF SQL%ROWCOUNT = 0  THEN

          VL_COUNT := 0;
          SELECT COUNT(*) INTO VL_COUNT FROM T060ARTICLE
           WHERE CODART = REC_T060.CODART
           AND CODDIV   = REC_T060.CODDIV;

          IF ( VL_COUNT = 0 ) THEN
              VL_MESSAGE_D := 'Insert T060article ';
              -- Record does not exists, we insert it
              INSERT INTO T060ARTICLE VALUES REC_T060;

              -- insert first step on workflow
             -- VL_MESSAGE_D := 'insert first step on workflow ';
             -- P_INS_WF_FIRST_STEP(PI_PROGR_H,VL_PROGR_D_T060, C_WORKFLOWID_T060,REC_T060.DOCUMENTKEY, vl_wf_stateid, vl_status );

           ELSE
            VL_STATUS := -1;
            VL_RECORD_LOCKED := -1;
            PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                           VL_PROGR_D_T060,
                                           SQLCODE,
                                           'Record is locked; import has failed :'||VL_MESSAGE_H);

          END IF; -- Record has been inserted

         END IF; -- Record has been updated




          -- ----------------------------------------------------------------------------
          -- if all records have been stored with success then it makes the commit
          -- ----------------------------------------------------------------------------
          IF VL_STATUS = 0 THEN
              VL_INS_T060 := VL_INS_T060 + 1;
              COMMIT;

          ELSE
            ROLLBACK;
          END IF;


        END IF; -- VL_STATUS = 0

        EXCEPTION WHEN OTHERS THEN
             ROLLBACK;
             VL_STATUS := -1;
             VL_MESSAGE_H := SUBSTR(VL_MESSAGE_H||' '||VL_MESSAGE_D||' '||dbms_utility.format_error_backtrace() || ' ' || SQLERRM,1,4000);

             PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                           VL_PROGR_D_T060,
                                           SQLCODE,
                                           VL_MESSAGE_H);
        END; -- HEAD T060


        IF ( VL_STATUS = 0  ) THEN
              -- Unit Measure data
              VL_STATUS_D := 0;
              DELETE T062UMCONV WHERE CODART =REC_T060.CODART AND CODDIV = REC_T060.CODDIV;

              FOR RL_XIN_T062 IN CL_XIN_T062(RL_XIN_T060.CODART, RL_XIN_T060.CODDIV, RL_XIN_T060.SM1_DTECRE) LOOP
              IF ( VL_STATUS_D = 0 ) THEN
                  BEGIN -- UNIT MEASURE T062

                   VL_MESSAGE_H := 'Measure Unit: '|| RL_XIN_T062.CODART || '/' ||
                                      RL_XIN_T062.CODDIV || '/' ||
                                      RL_XIN_T062.UMFROM || '/' ||
                                      RL_XIN_T062.UMTO;
                   VL_MESSAGE_D := 'Format Conversion ';

                     REC_T062 := REC_T062_INIT;
                     VL_CODDIV:= RL_XIN_T062.CODDIV;
                     REC_T062.CODART         := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T062.CODART,'CODART', VL_DES_T062,VL_STATUS_D, VL_MESSAGE_D);
                     REC_T062.CODDIV         := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T062.CODDIV,'CODDIV', VL_DES_T062,VL_STATUS_D, VL_MESSAGE_D);
                     REC_T062.UMFROM         := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T062.UMFROM,'UMFROM', VL_DES_T062,VL_STATUS_D, VL_MESSAGE_D);
                     REC_T062.UMTO           := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T062.UMTO,'UMTO', VL_DES_T062,VL_STATUS_D, VL_MESSAGE_D);
                     ---
                     REC_T062.VALCONVFACT    := NVL(F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T062.VALCONVFACT,'VALCONVFACT', VL_DES_T062,VL_STATUS_D, VL_MESSAGE_D), 1);
                     REC_T062.VALCONVFACTREV := CASE WHEN RL_XIN_T062.VALCONVFACTREV IS NULL
                                                     THEN CASE WHEN NVL(REC_T062.VALCONVFACT,0)<>0
                                                               THEN 1/REC_T062.VALCONVFACT
                                                               ELSE 1
                                                           END
                                                     ELSE F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T062.VALCONVFACTREV,'VALCONVFACTREV', VL_DES_T062,VL_STATUS_D, VL_MESSAGE_D)
                                                 END;

                     IF ( REC_T062.VALCONVFACT = 0 OR  REC_T062.VALCONVFACTREV = 0 ) THEN
                        VL_MESSAGE_D := ' Conversion Factor is 0. Record will be discarded ';
                        VL_STATUS_D := -1;
                     END IF;


                    IF ( VL_STATUS_D = 0 ) THEN
                       -- we insert it
                        BEGIN
                          VL_MESSAGE_D := 'Insert T062 ';
                          INSERT INTO T062UMCONV VALUES REC_T062;
                        EXCEPTION WHEN DUP_VAL_ON_INDEX THEN
                           --- case where the same conversion is present twice ( e.g. records come from sap package )
                           UPDATE T062UMCONV t
                           SET T.UMTO           = REC_T062.UMTO,
                               T.VALCONVFACT    = REC_T062.VALCONVFACT,
                               T.VALCONVFACTREV = REC_T062.VALCONVFACTREV
                           WHERE T.CODART = REC_T062.CODART
                             AND T.CODDIV = REC_T062.CODDIV
                             AND T.UMFROM = REC_T062.UMFROM
                             ;
                        END;
                        VL_INS_T062 := VL_INS_T062 + 1;
                    --
                    ELSE
                       VL_MESSAGE_H := SUBSTR(VL_MESSAGE_H||' '||VL_MESSAGE_D||' '||dbms_utility.format_error_backtrace() || ' ' || SQLERRM,1,4000);
                       PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                               VL_PROGR_D_T062,
                                               SQLCODE,
                                               VL_MESSAGE_H);
                    END IF;

                     --
                    EXCEPTION
                      WHEN OTHERS THEN
                         VL_STATUS_D := -1;
                         VL_MESSAGE_H := SUBSTR(VL_MESSAGE_H||' '||VL_MESSAGE_D||' '||dbms_utility.format_error_backtrace() || ' ' || SQLERRM,1,4000);

                         PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                                         VL_PROGR_D_T062,
                                                         SQLCODE,
                                                         VL_MESSAGE_H);

                    END; --- unit measure T062
              END IF; --VL_STATUS_D = 0
              END LOOP;

              IF VL_STATUS_D = 0 THEN
                 COMMIT;


              ELSE
                 ROLLBACK;

                 -- set the status to err to the single record in order to go ahead to another detail
                 UPDATE XIN_T062UMCONV
                             SET SM1_STATUS = C_XINSTATUS_ERR
                             WHERE CODART = RL_XIN_T060.CODART
                              AND  CODDIV = RL_XIN_T060.CODDIV
                              AND  SM1_CODPROCESS = PI_PROGR_H
                              AND  SM1_STATUS  = C_XINSTATUS_OK
                              AND  SM1_CODPROCESS  = PI_PROGR_H;
                  COMMIT;

              END IF;

      END IF; --( VL_STATUS = 0)

     IF  VL_STATUS <> 0 OR VL_RECORD_LOCKED <> 0 THEN

                UPDATE XIN_T060ARTICLE
                SET   SM1_STATUS = CASE
                                          WHEN VL_RECORD_LOCKED <> 0  THEN C_XINSTATUS_LOCK
                                          ELSE C_XINSTATUS_ERR END
                WHERE CODART = RL_XIN_T060.CODART
                 AND  CODDIV = RL_XIN_T060.CODDIV
                 AND  SM1_CODPROCESS = PI_PROGR_H
                 AND  SM1_DTECRE     = RL_XIN_T060.SM1_DTECRE
                 AND  SM1_STATUS     = C_XINSTATUS_OK;

                UPDATE XIN_T062UMCONV
                SET  SM1_STATUS = CASE
                                          WHEN VL_RECORD_LOCKED <> 0  THEN C_XINSTATUS_LOCK
                                          ELSE C_XINSTATUS_ERR END
                WHERE CODART = RL_XIN_T060.CODART
                 AND  CODDIV = RL_XIN_T060.CODDIV
                 AND  SM1_CODPROCESS = PI_PROGR_H
                 AND  SM1_DTECRE     <= RL_XIN_T060.SM1_DTECRE
                 AND  SM1_STATUS     = C_XINSTATUS_OK;

                COMMIT;
        ELSE

                COMMIT;

        END IF;


        -- Release updated records
        UPDATE T060ARTICLE
        SET       DTELCK          = NULL,
                  IDSESSIONLCK    = NULL,
                  CODUSRLCK       = NULL
        WHERE CODART = REC_T060.CODART
          AND CODDIV = REC_T060.CODDIV
          AND CODUSRLCK = C_SYSUSR AND IDSESSIONLCK = PI_SESSION_ID;
        COMMIT;


    END LOOP;


    --- Insert Dummy article for survey if it does not exist yet
     --- to check if it is still used
     BEGIN
     INSERT INTO T060ARTICLE
     (CODART,CODDIV,CODART2,CODART3,DESART,DESART2,CODEAN13,CODCATMER,CODSAL1,CODLINMER,CODSAL2,CODFAMMER,CODSAL3,CODBRAND,CODSAL4,CODFRMT,CODSAL5,CODPRODMGR,CODPUR1,CODPUR2,CODPUR3,CODPUR4,CODPUR5,VALHEIGHT,VALWIDTH,VALDEPTH,UMDIMENSION,VALNETWEIGHT,VALGROSSWEIGHT,UMWEIGHT,VALVOLUME,UMVOLUME,UMINV1,UMINV2,UMDEL,UMORDMIN,UMORD1,FLGCHKAVAIL,UMORD2,FLGARTCOMP,UMORD4,UMORD5,UMORD3,FLGARTKIT,PRCIVA,CODSTATUS,DTEORDFROM,CODBLCCAUSE,FLGGIFT,DTEORDTO,CODUSRLCK,FLGORDERABLE,DTELCK,FLGANN,CODUSRMOD,PGMMODCL,PGMMODDB,DTECRE,DTEMOD,IDSESSIONLCK,QTYORDMIN,FLGRETURNABLE,FLGBUDGET,CODCAUSEKIT,FLG_TRA_PERIF,CODSTATUSCUST,FLGPROMO,CODCATEGORY,CODSEGM,FLGARTFITTIZIO,CODARTSOURCE,FLGCOMPETITOR,FLGTOP,DOCUMENTKEY,DTETOSERVER,CODUSRMODREAL,CODUSRCREREAL,CODSAL6,CODSAL7,CODSAL8,CODSAL9,CODSAL10,
      IDWFSTATE, IDWFMODEL, CODWFSTATEHARD)
     select 'N/A',CDIV.CODTABROW,'','','Mission dummy article','','','','','','','','','','','','','','','','','','',0,0,0,'',0,0,'',0,'','','','','','',0,'',0,'','','',0,'','0','','',0,'','',0,'',0,'','','',SYSDATE, SYSDATE,'',0,0,0,'',0,'',0,'','',0,'',0,0,'','','','','','','','','',4,60,'CON'
      from T902TABROWS CDIV
      where CDIV.CODTAB = 'CDIV'
       and  CDIV.CODSYS = 'ALL'
       and not exists ( select null from T060ARTICLE WHERE CODART = 'N/A' and CODDIV = CDIV.CODTABROW) ;
     COMMIT;
     EXCEPTION WHEN OTHERS THEN
       VL_MESSAGE_H := 'Product N/A ' ||dbms_utility.format_error_backtrace() || ' ' || SQLERRM;
       PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                      VL_PROGR_D_T060,
                                      SQLCODE,
                                      VL_MESSAGE_H);
     END ;


      -- --------------------------------------------------------------------------
      -- Fulfills unit conversion in T062UMCONV for the updated articles and its division
      -- --------------------------------------------------------------------------
     -- P_T062_UPD_UMCONV (PI_PROGR_H, NULL ,NULL, NULL );
      -- --------------------------------------------------------------------------


    BEGIN

       -- Moves records from staging area to log staging area
       P_XIN_MOVE_TO_LOG(PI_PROGR_H,VL_PROGR_D_T062,'T062UMCONV');
       P_XIN_MOVE_TO_LOG(PI_PROGR_H,VL_PROGR_D_T060,'T060ARTICLE');
       --
    END;

    -- Closes logs
     PKG_UTILS.LOG_END_DETAIL(PI_PROGR_H,
                                      VL_PROGR_D_T062,
                                      0,
                                      VL_COUNT_XIN_T062,
                                      VL_INS_T062,
                                      VL_COUNT_XIN_T062 - VL_INS_T062);
    --
    PKG_UTILS.LOG_END_DETAIL(PI_PROGR_H,
                                      VL_PROGR_D_T060,
                                      0,
                                      VL_COUNT_XIN_T060,
                                      VL_INS_T060,
                                      VL_COUNT_XIN_T060 - VL_INS_T060);


    PO_MSG := VL_INS_T060||' products loaded';
    PO_STATUS :=VL_INS_T060;


  EXCEPTION WHEN EX_EXIT THEN

          ROLLBACK;
          VL_MESSAGE_H       := VL_MESSAGE_H || TRIM(SUBSTR(dbms_utility.format_error_backtrace() || ' ' || SQLERRM, 1, 255));
          PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                                  VL_PROGR_D_T060,
                                                  SQLCODE,
                                                  VL_MESSAGE_H);

          PO_MSG := VL_MESSAGE_H;
          PO_STATUS := -1;

   WHEN OTHERS THEN

          ROLLBACK;

          BEGIN
              -- Release updated records
              UPDATE T060ARTICLE
              SET       DTELCK          = NULL,
                        IDSESSIONLCK    = NULL,
                        CODUSRLCK       = NULL
              WHERE CODUSRLCK = C_SYSUSR AND IDSESSIONLCK = PI_SESSION_ID;
              COMMIT;

             -- Moves records from staging area to log staging area
             P_XIN_MOVE_TO_LOG(PI_PROGR_H,VL_PROGR_D_T062,'T062UMCONV');
             P_XIN_MOVE_TO_LOG(PI_PROGR_H,VL_PROGR_D_T060,'T060ARTICLE');

          END;

          VL_MESSAGE_H       := VL_MESSAGE_H || TRIM(SUBSTR(dbms_utility.format_error_backtrace() || ' ' || SQLERRM, 1, 255));
          PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                                  VL_PROGR_D_T060,
                                                  SQLCODE,
                                                  VL_MESSAGE_H);

          PO_MSG := VL_MESSAGE_H;
          PO_STATUS := VL_STATUS;

  END LOAD_T06X_PRODUCTS;
  --

 --

 /*============================================================================*\
  /* Name: LOAD_T064_PARTLIST  KIT

       Loads SM1 tables

     •  T064PARTLIST - Kit - product components list

      Staging Area (SSA) tables (Chronological Order expected in SSA  for each product):
      1. XIN_T064PARTLIST

      Loading logic:
      T064 DELETE + INSERT. For each CODART/CODDIV group of records , it deletes all T064PARTLIST and insert then new.
      Validity Checks:
      •  Records found on  XIN_T064.CODARTSON should be in T060ARTICLE ( it logs an error if it does not, but it is not a mandatory check as it could be loaded afterwards

      Error handling:
      • All Errors will be logged in T852/T854 SM1 log tables and all staging area records will be stored into staging area log with sm1_status = 9.
      • Error on one record: record is discarded with all records belonging to same set Codart/coddiv

      How to delete records on SM1
      • You cannot delete a kit by ERP data integration



     Input parameters :     PI_PROGR_H - unique sm1 job number ( T800SYSTEMACTIVITYLOG )
                            PI_SESSION_ID    - unique login session (T035LOGGEDUSERS)
     Outputparameters :     PO_MSG           - message of error if procedure exit with error
                            PO_STATUS        - 0 OK; -1 Error
     Author : Mariangela Bandiera

     Creation Date :  2014 07 14; 020: Mbandiera; WI 32087
     Updates :

     Mbandiera 9 Aug 2014 splitted kit from t060loading



    ============================================================================ */

  PROCEDURE LOAD_T064_PARTLIST(PI_PROGR_H  IN NUMBER,
                               PI_SESSION_ID    IN NUMBER,
                               PO_MSG           OUT NOCOPY VARCHAR2,
                               PO_STATUS        OUT NOCOPY NUMBER ) IS
    --
    -- KIT
    --
    CURSOR CL_XIN_T064 IS
      SELECT  *
        FROM XIN_T064PARTLIST
       WHERE SM1_CODPROCESS = PI_PROGR_H
         AND SM1_STATUS = C_XINSTATUS_OK -- Only those that have not processed yet (in case of double record in xin)
          ORDER BY CODART, CODDIV, SM1_DTECRE;

    --
    VL_MESSAGE_H   VARCHAR2(4000) := 'Error while loading KIT T064';
    VL_MESSAGE_D   VARCHAR2(4000) := NULL;
    --
    VL_PROGR_D_T064         NUMBER := 0;
    VL_COUNT_XIN_T064       NUMBER := 0;
    VL_INS_T064             NUMBER := 0;
    --

    REC_T064 T064PARTLIST%ROWTYPE         := NULL;
    REC_T064_INIT T064PARTLIST%ROWTYPE    := NULL;

    REC_T064_PREV T064PARTLIST%ROWTYPE  := NULL;
    RL_XIN_T064_PREV CL_XIN_T064%ROWTYPE  := NULL;
    --
    VL_DES_T064     X_FIELD_INFO_ARRAY;-- Array with fields db info
    --
    VL_STATUS   NUMBER:= 0;
    VL_COUNT    NUMBER:= 0;
    VL_STEP     NUMBER:= 0; -- Used to ping t035
    --
    EX_EXIT  EXCEPTION;
    --
    VL_CODDIV VARCHAR2(30) := NULL;


  BEGIN

    -- Rebuild indexes and compute statistics
    P_XIN_INIT_INDEXES (PI_PROGR_H, 'T064PARTLIST');
    -- Clean up older log
    P_XIN_CLEANUP_LOG (PI_PROGR_H, 'T064PARTLIST');
    --
    VL_PROGR_D_T064 := PKG_UTILS.LOG_NEW_DETAIL(PI_PROGR_H,
                                                     'WHS',
                                                     'IMPORT --> T064PARTLIST',
                                                      0,
                                                      NULL);
     VL_MESSAGE_H := GL_INIT_REC;
     BEGIN
      -- ----------------------------------------------------------
      -- Init arrays with FIELD_NAME=LENGTH and FIELDNAME=SM1_DEFAULT for all fields of table
      -- ----------------------------------------------------------
      VL_DES_T064.DELETE;
      P_INIT_SM1_FIELD_ARRAY ('T064PARTLIST',VL_DES_T064,VL_STATUS, VL_MESSAGE_H);
      execute immediate ( GL_INIT_REC)  INTO REC_T064_INIT;

      IF (VL_STATUS <> 0 ) THEN
          VL_MESSAGE_D := GL_INIT_REC;
          RAISE EX_EXIT;
      END IF;
      EXCEPTION WHEN OTHERS THEN
          VL_MESSAGE_D := GL_INIT_REC;
          RAISE EX_EXIT;
      END;
      -- --------------------------------------------------------------
      -- Identifies Xin records to be loaded
      -- --------------------------------------------------------------
      BEGIN

          VL_MESSAGE_D := 'XIN_T064PARTLIST';
          UPDATE XIN_T064PARTLIST D
          SET D.SM1_CODPROCESS = PI_PROGR_H,
              D.SM1_STATUS = 0,
              D.SM1_DTEPROCESS = XSYSDATE
          WHERE  SM1_CODPROCESS = C_SM1_NULL_CODPROCESS;
          VL_COUNT_XIN_T064 := SQL%ROWCOUNT;

      COMMIT;
      EXCEPTION WHEN OTHERS THEN
        ROLLBACK;
        VL_MESSAGE_H := 'Error while Reading Staging area: '||VL_MESSAGE_D;
        RAISE EX_EXIT;
      END;

    -- --------------------------------------------------------------
    -- loop in XIN_T064
    -- --------------------------------------------------------------
    FOR RL_XIN_T064 IN CL_XIN_T064 LOOP
    BEGIN -- WHS T064

     IF
        ( nvl(RL_XIN_T064_PREV.CODART, '@') <> RL_XIN_T064.CODART OR
          nvl(RL_XIN_T064_PREV.CODDIV, '@') <> RL_XIN_T064.CODDIV) THEN
          BEGIN
          IF  vl_status = 0 THEN
            VL_MESSAGE_D := 'Commit '||VL_MESSAGE_H;
            COMMIT;
          ELSE
             VL_MESSAGE_D := 'Rollback '||VL_MESSAGE_H;
            ROLLBACK;
             VL_MESSAGE_D := 'Rollback + update Xin status to error '||VL_MESSAGE_H;
            UPDATE XIN_T064PARTLIST
                       SET SM1_STATUS = C_XINSTATUS_ERR
                       WHERE CODART = RL_XIN_T064_PREV.CODART
                        AND  CODDIV = RL_XIN_T064_PREV.CODDIV
                        AND  SM1_CODPROCESS = PI_PROGR_H
                        AND  SM1_STATUS  = C_XINSTATUS_OK
                        AND  SM1_CODPROCESS  = PI_PROGR_H;
            COMMIT;

          END IF;
          VL_STATUS := 0;

          EXCEPTION WHEN OTHERS THEN


                 VL_MESSAGE_H := SUBSTR(VL_MESSAGE_H||' '||VL_MESSAGE_D||' '||dbms_utility.format_error_backtrace() || ' ' || SQLERRM,1,4000);
                 PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                   VL_PROGR_D_T064,
                                    SQLCODE,
                                    VL_MESSAGE_H);
          END;
      END IF;

     IF ( VL_STATUS = 0 ) THEN
      -- pings to t035 every 1000 cicles--
      VL_STEP := VL_STEP + 1;
      IF ( MOD(VL_STEP, 1000) = 0 ) THEN
         PKG_UTILS.user_ping(PI_SESSION_ID);
      END IF;

      VL_MESSAGE_H :=   'CODART: '   ||RL_XIN_T064.CODART || '/' ||
                        'CODARTSON: '||RL_XIN_T064.CODARTSON || '/' ||
                        'CODDIV: '   ||RL_XIN_T064.CODDIV ;

      VL_MESSAGE_D := 'field conversion ';
      VL_CODDIV:= RL_XIN_T064.CODDIV;
      REC_T064 := REC_T064_INIT;
       REC_T064.CODART      := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T064.CODART,'CODART', VL_DES_T064,VL_STATUS, VL_MESSAGE_D);
       REC_T064.CODDIV      := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T064.CODDIV,'CODDIV', VL_DES_T064,VL_STATUS, VL_MESSAGE_D);
       REC_T064.CODARTSON   := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T064.CODARTSON,'CODARTSON', VL_DES_T064,VL_STATUS, VL_MESSAGE_D);
       REC_T064.UMSON       := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T064.UMSON,'UMSON', VL_DES_T064,VL_STATUS, VL_MESSAGE_D);
       REC_T064.QTY         := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T064.QTY,'QTY', VL_DES_T064,VL_STATUS, VL_MESSAGE_D);
       REC_T064.PRCAMOUNT   := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T064.PRCAMOUNT,'PRCAMOUNT', VL_DES_T064,VL_STATUS, VL_MESSAGE_D);

       REC_T064.DISCOUNT1    := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T064.DISCOUNT1,'DISCOUNT1', VL_DES_T064,VL_STATUS, VL_MESSAGE_D);
       REC_T064.TARGETPRICE  := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T064.TARGETPRICE,'TARGETPRICE', VL_DES_T064,VL_STATUS, VL_MESSAGE_D);
       REC_T064.TARGETDISC   := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T064.TARGETDISC,'TARGETDISC', VL_DES_T064,VL_STATUS, VL_MESSAGE_D);
       REC_T064.MINPROMODISC := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T064.MINPROMODISC,'MINPROMODISC', VL_DES_T064,VL_STATUS, VL_MESSAGE_D);
       REC_T064.MAXPROMODISC := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T064.MAXPROMODISC,'MAXPROMODISC', VL_DES_T064,VL_STATUS, VL_MESSAGE_D);
       REC_T064.REFILLRATE   := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T064.REFILLRATE,'REFILLRATE', VL_DES_T064,VL_STATUS, VL_MESSAGE_D);


      IF (VL_STATUS <> 0 ) THEN

         VL_MESSAGE_H := SUBSTR(VL_MESSAGE_H||' '||VL_MESSAGE_D||' '||dbms_utility.format_error_backtrace() || ' ' || SQLERRM,1,4000);
         PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                 VL_PROGR_D_T064,
                                 SQLCODE,
                                 VL_MESSAGE_H);


       END IF;


        -- CHECKS
        --1-- ARTICLES EXISTS

       VL_MESSAGE_D := 'T064 article check ';
        VL_COUNT := 0;
        SELECT COUNT(*) INTO VL_COUNT FROM T060ARTICLE
        WHERE CODART IN ( REC_T064.CODART, REC_T064.CODARTSON )
        AND   CODDIV = REC_T064.CODDIV;


       IF (VL_COUNT < 2  ) THEN
         VL_STATUS := -1;
         VL_MESSAGE_D := 'Article: '|| REC_T064.CODART||' or its PART: '|| REC_T064.CODARTSON||' not found in T060ARTICLE for division '|| REC_T064.CODDIV;
         VL_MESSAGE_H := SUBSTR(VL_MESSAGE_H||' '||VL_MESSAGE_D||' '||dbms_utility.format_error_backtrace() || ' ' || SQLERRM,1,4000);
         PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                 VL_PROGR_D_T064,
                                 SQLCODE,
                                 VL_MESSAGE_H);
        END IF;

      -- DELETE
      if ( nvl(REC_T064_PREV.CODART, '@') <> REC_T064.CODART OR
           nvl(REC_T064_PREV.CODDIV, '@') <> REC_T064.CODDIV) AND
           VL_STATUS = 0 THEN

         -- FIRST WE DELETE
       VL_MESSAGE_D := 'Delete T064PARTLIST ';
       DELETE T064PARTLIST T064
                WHERE T064.CODDIV = REC_T064.CODDIV
                  AND T064.CODART = REC_T064.CODART;


      END IF;


      IF (VL_STATUS = 0 ) THEN
         VL_MESSAGE_D := 'Insert T064 ';
         INSERT INTO T064PARTLIST VALUES REC_T064;

         VL_INS_T064 := VL_INS_T064 + 1;

      END IF;

      END IF;

      EXCEPTION
          WHEN OTHERS THEN
             VL_STATUS := -1;

             VL_MESSAGE_H := SUBSTR(VL_MESSAGE_H||' '||VL_MESSAGE_D||' '||dbms_utility.format_error_backtrace() || ' ' || SQLERRM,1,2000);

             PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                             VL_PROGR_D_T064,
                                             SQLCODE,
                                             VL_MESSAGE_H);

     END; --- KIT T064

     REC_T064_PREV    := REC_T064;      -- used to delete group of CODART/CODDIV set of warehouses
     RL_XIN_T064_PREV := RL_XIN_T064;   -- used to commit previous set of CODART/CODDIV set of warehouses

  END LOOP;


    IF VL_STATUS = 0 THEN
       COMMIT;
    ELSE
       ROLLBACK;

           -- set the status to err to the single record in order to go ahead to another detail
            UPDATE XIN_T064PARTLIST
                       SET SM1_STATUS = C_XINSTATUS_ERR
                       WHERE CODART = RL_XIN_T064_PREV.CODART
                        AND  CODDIV = RL_XIN_T064_PREV.CODDIV
                        AND  SM1_CODPROCESS = PI_PROGR_H
                        AND  SM1_STATUS  = C_XINSTATUS_OK
                        AND  SM1_CODPROCESS  = PI_PROGR_H;
            COMMIT;

    END IF;


    -- Moves records from staging area to log staging area
    P_XIN_MOVE_TO_LOG(PI_PROGR_H,VL_PROGR_D_T064,'T064PARTLIST');
    --
    -- Close Logs
    PKG_UTILS.LOG_END_DETAIL(PI_PROGR_H,
                                      VL_PROGR_D_T064,
                                      0,
                                      VL_COUNT_XIN_T064,
                                      VL_INS_T064,
                                      VL_COUNT_XIN_T064 - VL_INS_T064);


    PO_MSG := VL_INS_T064||' KIT loaded';
    PO_STATUS :=VL_INS_T064;


  EXCEPTION WHEN EX_EXIT THEN

          ROLLBACK;
          VL_MESSAGE_H       := VL_MESSAGE_H || TRIM(SUBSTR(dbms_utility.format_error_backtrace() || ' ' || SQLERRM, 1, 255));
          PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                                  VL_PROGR_D_T064,
                                                  SQLCODE,
                                                  VL_MESSAGE_H);

          PO_MSG := VL_MESSAGE_H;
          PO_STATUS := -1;

   WHEN OTHERS THEN

          ROLLBACK;

          -- Moves records from staging area to log staging area
          P_XIN_MOVE_TO_LOG(PI_PROGR_H,VL_PROGR_D_T064,'T064PARTLIST');

          VL_MESSAGE_H       := VL_MESSAGE_H || TRIM(SUBSTR(dbms_utility.format_error_backtrace() || ' ' || SQLERRM, 1, 255));
          PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                                  VL_PROGR_D_T064,
                                                  SQLCODE,
                                                  VL_MESSAGE_H);

          PO_MSG := VL_MESSAGE_H;
          PO_STATUS := VL_STATUS;

  END LOAD_T064_PARTLIST;

 /*============================================================================*\
  /* Name: T078_WHS_BALANCE  only PHISICAL WAREHOUSES

       Loads SM1 tables

      • T078WHSBALANCE -  Warehouse products stock

      Staging Area (SSA) tables (Chronological Order expected in SSA  for each product):
      1.  XIN_T078WHSBALANCE

      Loading logic:
      T078 DELETE + INSERT. For each CODART/CODDIV group of records , it deletes all T078 WHAREHOUSES
                            of type "phisical" --> T902[WHS].opdinfo = 0 and insert then new.
      Validity Checks:
      • WHS must be a phisical warehouse  --> T902[WHS].opdinfo = 0

      Error handling:
      • All Errors will be logged in T852/T854 SM1 log tables and all staging area records will be stored into staging area log with sm1_status = 9.
      • Error on one record: record is discarded with all records belonging to same set Codart/coddiv

      How to delete
      • If you need to maintain the history you can set FLGANN=-1 field where available, otherwise you can simply not write the detail on SSA anymore.



     Input parameters :     PI_PROGR_H - unique sm1 job number ( T800SYSTEMACTIVITYLOG )
                            PI_SESSION_ID    - unique login session (T035LOGGEDUSERS)
     Outputparameters :     PO_MSG           - message of error if procedure exit with error
                            PO_STATUS        - 0 OK; -1 Error
     Author : Mariangela Bandiera

     Creation Date :  2014 07 14; 020: Mbandiera; WI 32087
     Updates :

     Mbandiera 32 July 2014 added  management on new fields

       T078.QTYINV  NUMBER(12,2)  Y 0 Stock quantity in invoicing unit of measure


    ============================================================================ */


  PROCEDURE LOAD_T078_WHSBALANCE(PI_PROGR_H  IN NUMBER,
                          PI_SESSION_ID    IN NUMBER,
                          PO_MSG           OUT NOCOPY VARCHAR2,
                          PO_STATUS        OUT NOCOPY NUMBER ) IS
    --
    -- Warehouse
    --

    CURSOR CL_XIN_T078 IS
      SELECT  *
        FROM XIN_T078WHSBALANCE
       WHERE SM1_CODPROCESS = PI_PROGR_H
         AND SM1_STATUS = C_XINSTATUS_OK      -- Only those that have not processed yet (in case of double record in xin)
          ORDER BY CODART, CODDIV, SM1_DTECRE;

    --
    VL_MESSAGE_H   VARCHAR2(4000) := 'Error while loading WAREHOUSES T078';
    VL_MESSAGE_D   VARCHAR2(4000) := NULL;
    --
    VL_PROGR_D_T078         NUMBER := 0;
    VL_COUNT_XIN_T078       NUMBER := 0;
    VL_INS_T078             NUMBER := 0;
    --
    REC_T078      T078WHSBALANCE%ROWTYPE  := NULL;
    REC_T078_INIT T078WHSBALANCE%ROWTYPE  := NULL;
    REC_T078_PREV T078WHSBALANCE%ROWTYPE  := NULL;
    RL_XIN_T078_PREV CL_XIN_T078%ROWTYPE  := NULL;
    --
    VL_DES_T078     X_FIELD_INFO_ARRAY;-- Array with fields db info
    --
    VL_STATUS   NUMBER:= 0;
    VL_CHECK    NUMBER:= 0;
    VL_STEP     NUMBER:= 0; -- Used to ping t035
    --
    EX_EXIT  EXCEPTION;
    --
    VL_CODDIV VARCHAR2(30) := NULL;


  BEGIN

    -- Rebuild indexes and compute statistics
    P_XIN_INIT_INDEXES (PI_PROGR_H, 'T078WHSBALANCE');
    -- Clean up older log
    P_XIN_CLEANUP_LOG (PI_PROGR_H, 'T078WHSBALANCE');
    --
    VL_PROGR_D_T078 := PKG_UTILS.LOG_NEW_DETAIL(PI_PROGR_H,
                                                     'WHS',
                                                     'IMPORT --> T078WHSBALANCE',
                                                      0,
                                                      NULL);
     VL_MESSAGE_H := GL_INIT_REC;
     BEGIN
      -- ----------------------------------------------------------
      -- Init arrays with FIELD_NAME=LENGTH and FIELDNAME=SM1_DEFAULT for all fields of table
      -- ----------------------------------------------------------
      VL_DES_T078.DELETE;
      P_INIT_SM1_FIELD_ARRAY ('T078WHSBALANCE',VL_DES_T078,VL_STATUS, VL_MESSAGE_H);
      execute immediate ( GL_INIT_REC)  INTO REC_T078_INIT;

      IF (VL_STATUS <> 0 ) THEN
          VL_MESSAGE_D := GL_INIT_REC;
          RAISE EX_EXIT;
      END IF;
      EXCEPTION WHEN OTHERS THEN
          VL_MESSAGE_D := GL_INIT_REC;
          RAISE EX_EXIT;
      END;
      -- --------------------------------------------------------------
      -- Identifies Xin records to be loaded
      -- --------------------------------------------------------------
      BEGIN

          VL_MESSAGE_D := 'XIN_T078WHSBALANCE';
          UPDATE XIN_T078WHSBALANCE D
          SET D.SM1_CODPROCESS = PI_PROGR_H,
              D.SM1_STATUS = 0,
              D.SM1_DTEPROCESS = XSYSDATE
          WHERE
      nvl(SM1_CODPROCESS,1) = 1
    OR SM1_CODPROCESS = C_SM1_NULL_CODPROCESS;
          VL_COUNT_XIN_T078 := SQL%ROWCOUNT;

      COMMIT;
      EXCEPTION WHEN OTHERS THEN
        ROLLBACK;
        VL_MESSAGE_H := 'Error while Reading Staging area: '||VL_MESSAGE_D;
        RAISE EX_EXIT;
      END;

    -- --------------------------------------------------------------
    -- loop in XIN_T078
    -- --------------------------------------------------------------
    FOR RL_XIN_T078 IN CL_XIN_T078 LOOP
    BEGIN -- WHS T078

     IF (NVL(RL_XIN_T078_PREV.CODWHS, '@') <>'@' and
        ( nvl(RL_XIN_T078_PREV.CODART, '@') <> RL_XIN_T078.CODART OR
          nvl(RL_XIN_T078_PREV.CODDIV, '@') <> RL_XIN_T078.CODDIV)) THEN
          BEGIN
          IF  vl_status = 0 THEN
            VL_MESSAGE_D := 'Commit '||VL_MESSAGE_H;
            COMMIT;
          ELSE
             VL_MESSAGE_D := 'Rollback '||VL_MESSAGE_H;
            ROLLBACK;
             VL_MESSAGE_D := 'Rollback + update cin status to error '||VL_MESSAGE_H;
            UPDATE XIN_T078WHSBALANCE
                       SET SM1_STATUS = C_XINSTATUS_ERR
                       WHERE CODART = RL_XIN_T078_PREV.CODART
                        AND  CODDIV = RL_XIN_T078_PREV.CODDIV
                        AND  SM1_CODPROCESS = PI_PROGR_H
                        AND  SM1_STATUS  = C_XINSTATUS_OK
                        AND  SM1_CODPROCESS  = PI_PROGR_H;
            COMMIT;

          END IF;

          EXCEPTION WHEN OTHERS THEN


                 VL_MESSAGE_H := SUBSTR(VL_MESSAGE_H||' '||VL_MESSAGE_D||' '||dbms_utility.format_error_backtrace() || ' ' || SQLERRM,1,4000);
                 PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                   VL_PROGR_D_T078,
                                    SQLCODE,
                                    VL_MESSAGE_H);
          END;
      END IF;
      -- pings to t035 every 1000 cicles--
      VL_STEP := VL_STEP + 1;
      IF ( MOD(VL_STEP, 1000) = 0 ) THEN
         PKG_UTILS.user_ping(PI_SESSION_ID);
      END IF;

      --
      VL_STATUS := 0;
      vl_check  := 0;
      --
      VL_MESSAGE_H :=   'WHS: '   ||RL_XIN_T078.CODWHS || '/' ||
                        'CODART: '||RL_XIN_T078.CODART || '/' ||
                        'CODDIV: '||RL_XIN_T078.CODDIV ;

      VL_MESSAGE_D := 'field conversion ';
      VL_CODDIV:= RL_XIN_T078.CODDIV;
      REC_T078 := REC_T078_INIT;
      REC_T078.CODART      := F_CHECK_FORMAT_S(VL_CODDIV, RL_XIN_T078.CODART,'CODART', VL_DES_T078,VL_STATUS, VL_MESSAGE_D);
      REC_T078.CODWHS      := F_CHECK_FORMAT_S(VL_CODDIV, RL_XIN_T078.CODWHS,'CODWHS', VL_DES_T078,VL_STATUS, VL_MESSAGE_D);
      REC_T078.CODDIV      := F_CHECK_FORMAT_S(VL_CODDIV, RL_XIN_T078.CODDIV,'CODDIV', VL_DES_T078,VL_STATUS, VL_MESSAGE_D);
      REC_T078.QTYSTOCK    := F_CHECK_FORMAT_N( VL_CODDIV,RL_XIN_T078.QTYSTOCK,'QTYSTOCK', VL_DES_T078,VL_STATUS, VL_MESSAGE_D);
      REC_T078.UMSTOCK     := F_CHECK_FORMAT_S(VL_CODDIV, RL_XIN_T078.UMSTOCK,'UMSTOCK', VL_DES_T078,VL_STATUS, VL_MESSAGE_D);
      REC_T078.DTESTOCK    := F_CHECK_FORMAT_D( VL_CODDIV,RL_XIN_T078.DTESTOCK,'DTESTOCK', VL_DES_T078,VL_STATUS, VL_MESSAGE_D);
      REC_T078.QTYSTOCKMIN := F_CHECK_FORMAT_N( VL_CODDIV,RL_XIN_T078.QTYSTOCKMIN,'QTYSTOCKMIN', VL_DES_T078,VL_STATUS, VL_MESSAGE_D);
      REC_T078.TYPSTOCK    := F_CHECK_FORMAT_S(VL_CODDIV, RL_XIN_T078.TYPSTOCK,'TYPSTOCK', VL_DES_T078,VL_STATUS, VL_MESSAGE_D);
      REC_T078.FLGANN      := F_CHECK_FORMAT_N( VL_CODDIV,RL_XIN_T078.FLGANN,'FLGANN', VL_DES_T078,VL_STATUS, VL_MESSAGE_D);
      REC_T078.QTYINV      := F_CHECK_FORMAT_N( VL_CODDIV,RL_XIN_T078.QTYINV,'QTYINV', VL_DES_T078, VL_STATUS, VL_MESSAGE_D);


      IF (VL_STATUS <> 0 ) THEN
         VL_MESSAGE_H := SUBSTR(VL_MESSAGE_H||' '||VL_MESSAGE_D||' '||dbms_utility.format_error_backtrace() || ' ' || SQLERRM,1,4000);
         PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                 VL_PROGR_D_T078,
                                 SQLCODE,
                                 VL_MESSAGE_H);


       END IF;


        -- CHECKS
        --1-- WHS is a PHSICAL ONE
        IF ( nvl(REC_T078_PREV.CODWHS, '@') <> REC_T078.CODWHS OR
             nvl(REC_T078_PREV.CODDIV, '@') <> REC_T078.CODDIV) AND
             VL_STATUS = 0 THEN

             VL_MESSAGE_D := 'Looking for Warehouse code in T902 WHS ';
             SELECT sum(T902.OPTINFO) INTO vl_check
              FROM  T902TABROWS T902
              WHERE T902.CODSYS = REC_T078.CODDIV
               AND  T902.CODTAB = 'WHS'
               AND  T902.CODTABROW = REC_T078.CODWHS
               AND  T902.FLGANN    = 0
    AND  (TRIM(T902.OPTINFO) = '0' OR TRIM(T902.OPTINFO) = '1');  ---  NVL(LENGTH(TRIM(TRANSLATE(T902.OPTINFO, ' +-.0123456789',' '))),0) = 0 ;   -- BY SHERRY  OPTINFO HAS NON NUMERIC VALUE AND HENCE MAY THROW EXCEPTION


              if nvl(vl_check, 0)  <> 0 then

                VL_MESSAGE_D := 'Warning.Van sales Warehouse see T902[WHS].optinfo ';
                VL_MESSAGE_H := SUBSTR(VL_MESSAGE_H||' '||VL_MESSAGE_D||' '||dbms_utility.format_error_backtrace() || ' ' || SQLERRM,1,4000);
                PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                 VL_PROGR_D_T078,
                                  SQLCODE,
                                  VL_MESSAGE_H);
              end if;

         END IF;

          -- DELETE
          if ( nvl(REC_T078_PREV.CODART, '@') <> REC_T078.CODART OR
               nvl(REC_T078_PREV.CODDIV, '@') <> REC_T078.CODDIV) AND
               VL_STATUS = 0 THEN

             -- FIRST WE DELETE
           VL_MESSAGE_D := 'Delete T078WHSBALANCE_BATCH ';
           DELETE T078WHSBALANCE_BATCH T078
                    WHERE T078.CODDIV = REC_T078.CODDIV
                      AND T078.CODART = REC_T078.CODART
                      AND T078.CODWHS NOT IN ( SELECT T902.CODTABROW
                                           FROM  T902TABROWS T902
                                            WHERE T902.CODSYS = T078.CODDIV
                                             AND  T902.CODTAB = 'WHS'
              AND  trim(T902.OPTINFO)   = '1'
                                            ---AND  trim(T902.OPTINFO)   <> '0'
          );

            VL_MESSAGE_D := 'Delete T078WHSBALANCE ';
            DELETE T078WHSBALANCE T078
                    WHERE T078.CODDIV = REC_T078.CODDIV
                      AND T078.CODART = REC_T078.CODART
                      AND T078.CODWHS NOT IN ( SELECT T902.CODTABROW
                                           FROM  T902TABROWS T902
                                            WHERE T902.CODSYS = T078.CODDIV
                                             AND  T902.CODTAB = 'WHS'
                                             AND  T902.FLGANN    = 0
                   AND  trim(T902.OPTINFO)   = '1'
                                            --AND  trim(T902.OPTINFO)   <> '0'
          );



          END IF;


          IF (VL_STATUS = 0 AND  nvl(vl_check, 0)  = 0 ) THEN
             VL_MESSAGE_D := 'Insert T078 ';
             INSERT INTO T078WHSBALANCE VALUES REC_T078;

             VL_INS_T078 := VL_INS_T078 + 1;

          END IF;

      EXCEPTION
          WHEN OTHERS THEN
             VL_STATUS := -1;

             VL_MESSAGE_H := SUBSTR(VL_MESSAGE_H||' '||VL_MESSAGE_D||' '||dbms_utility.format_error_backtrace() || ' ' || SQLERRM,1,2000);

             PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                             VL_PROGR_D_T078,
                                             SQLCODE,
                                             VL_MESSAGE_H);

       END; --- WHS T078

     REC_T078_PREV    := REC_T078;      -- used to delete group of CODART/CODDIV set of warehouses
     RL_XIN_T078_PREV := RL_XIN_T078;   -- used to commit previous set of CODART/CODDIV set of warehouses
    END LOOP;

    IF VL_STATUS = 0 THEN
       COMMIT;
    ELSE
       ROLLBACK;

           -- set the status to err to the single record in order to go ahead to another detail
            UPDATE XIN_T078WHSBALANCE
                       SET SM1_STATUS = C_XINSTATUS_ERR
                       WHERE CODART = RL_XIN_T078_PREV.CODART
                        AND  CODDIV = RL_XIN_T078_PREV.CODDIV
                        AND  SM1_CODPROCESS = PI_PROGR_H
                        AND  SM1_STATUS  = C_XINSTATUS_OK
                        AND  SM1_CODPROCESS  = PI_PROGR_H;
            COMMIT;

    END IF;
    -- Moves records from staging area to log staging area
    P_XIN_MOVE_TO_LOG(PI_PROGR_H,VL_PROGR_D_T078,'T078WHSBALANCE');
    --
    -- Close Logs
    PKG_UTILS.LOG_END_DETAIL(PI_PROGR_H,
                                      VL_PROGR_D_T078,
                                      0,
                                      VL_COUNT_XIN_T078,
                                      VL_INS_T078,
                                      VL_COUNT_XIN_T078 - VL_INS_T078);


    PO_MSG := VL_INS_T078||' WHS loaded';
    PO_STATUS :=VL_INS_T078;


  EXCEPTION WHEN EX_EXIT THEN

          ROLLBACK;
          VL_MESSAGE_H       := VL_MESSAGE_H || TRIM(SUBSTR(dbms_utility.format_error_backtrace() || ' ' || SQLERRM, 1, 255));
          PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                                  VL_PROGR_D_T078,
                                                  SQLCODE,
                                                  VL_MESSAGE_H);

          PO_MSG := VL_MESSAGE_H;
          PO_STATUS := -1;

   WHEN OTHERS THEN

          ROLLBACK;

          BEGIN

             -- Moves records from staging area to log staging area
             P_XIN_MOVE_TO_LOG(PI_PROGR_H,VL_PROGR_D_T078,'T078WHSBALANCE');

          END;

          VL_MESSAGE_H       := VL_MESSAGE_H || TRIM(SUBSTR(dbms_utility.format_error_backtrace() || ' ' || SQLERRM, 1, 255));
          PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                                  VL_PROGR_D_T078,
                                                  SQLCODE,
                                                  VL_MESSAGE_H);

          PO_MSG := VL_MESSAGE_H;
          PO_STATUS := VL_STATUS;

  END LOAD_T078_WHSBALANCE;
 --
   /*============================================================================*\
  /* Name: T07X_PRICELIST
        Loads SM1 tables
        • T070LIST            Price lists header
        • T074LISTDETT  Price list article detail
        • T073CUSTOMERSTOAPPLY Customer attributes the customer needs for the price list to be applied
        Staging Area (SSA) tables (Chronological Order expected in SSA  for each pricelist):
        1.  XIN_T074LISTDETT
        2.  XIN_T073CUSTOMERSTOAPPLY
        3.  XIN_T070LIST

        Loading logic:

        In SSA we expected to be present all three XIN (t070/t074/t073) for all price list to be loaded/Updated.
        If you need to add or to modify a price list we expect in SSA all its History since the beginning of current Year.
        Loading procedure will match the prices found on SSA with the prices already present on SM1 in order to:
           update the existing ones,
           disable the no more valid ones,
           insert the new ones.

        Price lists not present on SSA tables will not be touched by the loading procedure and their status will be preserved on SM1.
        The match between the price on SSA and the price on SM1 will be done with fields of T074LISTDETT:

        CODART  Product code
        CODDIV  Division code [CONF:QTABS=CDIV.COD]
        CODLIST Price list code
        PRZVAL  Sales price
        DTEFROMDETAIL Price start date
        UMPRZ Product invoice unit of measure.  (UMINV1 field fromT060ARTICLE table)  [CONF:QTABS=UMART.COD]
        PRGLIST Price list version

        When all fields matches the other fields of price list will be updated.

        FLGANN  NUMBER(1) N Y Record logically deleted
        PRZVALPVP NUMBER(14,4)  N N End user price
        FLGPRINTDET NUMBER(1) N Y Sales price should be printed
        FLGPRINTPVP NUMBER(1) N Y End user price should be printed
        MINSALESPRICE NUMBER(14,4)  N Y Min Sales Price
        MAXSALESPRICE NUMBER(14,4)  N Y Max Sales Price
        DTETODETAIL Price end date


        When the record loaded from SSA is not found on SM1 it will be inserted new.
        Existing records on SM1 and no more present on SSA will be closed in the following mode:
        • Price list already closed T074.DTETODETAIL < today ? no action done, price list is already closed
        • Price list active at current day? price list will be closed setting T074.DTETODETAIL = today.
        • Price list no active yet ( T074.DTEFROMDETAIL is in the future ) ? record will be physically deleted from db.


        Field T074.PRGROW will be managed directly by SM1, you have not to send this information to SSA.

        Validity Checks:
        • Price lists found on staging area are loaded to SM1 main tables only if they are not already opened for update by a SM1 user. In that case records remain in staging area ready to be loaded on next import run.
        • Detail Records found on  XIN_T074LISTDETT  are loaded only if there is the head record in XIN_T070LIST.
        • Validity check on time range validity on T070LIST, no overlaps accepted
        • Records found XIN_T074LISTDETT   will be loaded only if the article is present on T060ARTICLE table.
        • Records found in XIN_T074LISTDETT will be loaded only if there are no time range overlap for the same price list code and version , division and article.

        Error handling:
        • All Errors will be logged in T852/T854 SM1 log tables and all staging area records will be stored into staging area log with sm1_status = 9.
        • Error on head record T070,  it is discarded with all its details.
        • Error on detail record T074, all price details of the same article/division/pricelist/pricelist version will be discarded in order to keep last version of it.

        How to delete:
        • a whole price list (T070) : you cannot delete a price list head by integration host procedure
        • a Price List Detail (T074): You can set field T074.DTETODETAIL to close the price list detail

        How to change price list date range validity: send to SSA the new price list date validity.


     Input parameters :     PI_PROGR_H - unique sm1 job number ( T800SYSTEMACTIVITYLOG )
                            PI_SESSION_ID    - unique login session (T035LOGGEDUSERS)
     Outputparameters :     PO_MSG           - message of error if procedure exit with error
                            PO_STATUS        - 0 OK; -1 Error
     Author :  ---
     Creation Date : ---
     ----
     Updates :
      -- 2012 12 19; 001; Mbandiera; Added T073CUSTOMERSTOAPPLY maintainance
      -- 2013 03 11; 002; Mbandiera; Added validity check on time range validity on T070LIST
      -- 2013 11 15; 012; Mbandiera; WI 28211 Changed the closure of details that are no more loaded from ERP ( it closes the dtetodetail and set no more flgann=-1)

    ============================================================================  */

  PROCEDURE LOAD_T07X_PRICELIST(PI_PROGR_H       IN NUMBER,
                           PI_SESSION_ID    IN NUMBER,
                           PO_MSG           OUT NOCOPY VARCHAR2,
                           PO_STATUS        OUT NOCOPY NUMBER ) IS

    --
    -- Cursor on main Product table T070LIST
    --
    CURSOR CL_XIN_T070 IS
      SELECT
       *

        FROM  XIN_T070LIST
        WHERE SM1_CODPROCESS = PI_PROGR_H
        ORDER BY CODLIST, PRGLIST, SM1_DTECRE;

    --
    -- Cursor on Customer to Apply table T073CUSTOMERSTOAPPLY PRIMARY KEY(DOCTYPE,CODDOC,PRGDOCROW,CODDIV,PRGROW)

    --
    CURSOR CL_XIN_T073(CI_CODLIST VARCHAR2, CI_PRGLIST NUMBER, CI_SM1_DTECRE DATE) IS
      SELECT
        *

        FROM  XIN_T073CUSTOMERSTOAPP
        WHERE DOCTYPE   = C_PRICELIST_DOCTYPE -- 'P' Price List
        AND   CODDOC    = CI_CODLIST
        AND   PRGDOCROW = CI_PRGLIST
        AND   SM1_CODPROCESS = PI_PROGR_H
        AND   SM1_DTECRE <= CI_SM1_DTECRE
        AND   SM1_STATUS = C_XINSTATUS_OK -- Only those that have not processed yet (in case of double record in xin)
        ORDER BY DOCTYPE, CODDOC, SM1_DTECRE;


    --
    -- Cursor on list details T074LISTDETT
    --
    CURSOR CL_XIN_T074(CI_CODLIST VARCHAR2, CI_PRGLIST NUMBER, CI_SM1_DTECRE DATE) IS
      SELECT
         *
        FROM XIN_T074LISTDETT
       WHERE CODLIST = CI_CODLIST
         AND PRGLIST = CI_PRGLIST
         AND SM1_CODPROCESS = PI_PROGR_H
         AND SM1_DTECRE <= CI_SM1_DTECRE
         AND SM1_STATUS = C_XINSTATUS_OK -- Only those that have not processed yet (in case of double record in xin)
          ORDER BY CODART, CODDIV, SM1_DTECRE;


    --
    VL_MESSAGE_H   VARCHAR2(4000) := 'Error while loading PRICE LIST T07X';
    VL_MESSAGE_D   VARCHAR2(4000) := NULL;
    --
    VL_PROGR_D_T070    NUMBER := 0;
    VL_COUNT_XIN_T070  NUMBER := 0;
    VL_INS_T070        NUMBER := 0;
    --
    VL_PROGR_D_T073    NUMBER := 0;
    VL_COUNT_XIN_T073  NUMBER := 0;
    VL_INS_T073        NUMBER := 0;
    --
    VL_PROGR_D_T074    NUMBER := 0;
    VL_COUNT_XIN_T074  NUMBER := 0;
    VL_INS_T074        NUMBER := 0;
    VL_INS             NUMBER := 0;
    --
    VL_FIRST_DAY_OF_YEAR  DATE;
    ---
    REC_T070 T070LIST%ROWTYPE             := NULL;
    REC_T073 T073CUSTOMERSTOAPPLY%ROWTYPE  := NULL;
    REC_T074 T074LISTDETT%ROWTYPE         := NULL;
    --
    REC_T070_INIT T070LIST%ROWTYPE             := NULL;
    REC_T073_INIT T073CUSTOMERSTOAPPLY%ROWTYPE  := NULL;
    REC_T074_INIT T074LISTDETT%ROWTYPE         := NULL;
    --
    RL_XIN_T074_PREV  CL_XIN_T074%ROWTYPE:=NULL;
    --
    VL_DES_T070     X_FIELD_INFO_ARRAY;-- Array with fields db info
    --
    VL_DES_T073     X_FIELD_INFO_ARRAY;-- Array with fields db info
    --
    VL_DES_T074     X_FIELD_INFO_ARRAY;-- Array with fields db info
    --
    VL_RECORD_LOCKED NUMBER := 0;
    VL_FLG_NEW_SET   NUMBER := -1;
    --
    VL_STATUS NUMBER:= 0;
    VL_COUNT  NUMBER:= 0;
    VL_STEP   NUMBER:= 0; -- Used to ping t035
    --
    VL_PRGROW NUMBER:= 0; -- T074-PRGROW is maintained here
    --
    EX_EXIT  EXCEPTION;
    --
    VL_CODDIV VARCHAR2(30) := NULL;

  BEGIN

    -- SET FIRST DAY OF YEAR
    select to_date('0101'||to_char(trunc(xsysdate),'yyyy'), 'ddmmyyyy') into VL_FIRST_DAY_OF_YEAR from dual;
    --
    -- init indexes and rebuild statistics
    P_XIN_INIT_INDEXES (PI_PROGR_H, 'T070LIST');
    P_XIN_INIT_INDEXES (PI_PROGR_H, 'T073CUSTOMERSTOAPP');
    P_XIN_INIT_INDEXES (PI_PROGR_H, 'T074LISTDETT');
    -- clean log
    P_XIN_CLEANUP_LOG (PI_PROGR_H, 'T070LIST');
    P_XIN_CLEANUP_LOG (PI_PROGR_H, 'T073CUSTOMERSTOAPP');
    P_XIN_CLEANUP_LOG (PI_PROGR_H, 'T074LISTDETT');
    --
    VL_PROGR_D_T070 := PKG_UTILS.LOG_NEW_DETAIL(PI_PROGR_H,
                                                'LIST HEAD',
                                                'IMPORT --> T070LIST',
                                                 0,
                                                 NULL);
    --
    VL_PROGR_D_T073 := PKG_UTILS.LOG_NEW_DETAIL(PI_PROGR_H,
                                                'LIST CUST',
                                                'IMPORT --> T073CUSTOMERSTOAPPLY',
                                                 0,
                                                 NULL);
    --
    VL_PROGR_D_T074 := PKG_UTILS.LOG_NEW_DETAIL(PI_PROGR_H,
                                                'LIST DETAIL',
                                                'IMPORT --> T074LISTDETT',
                                                 0,
                                                 NULL);



    ------ We need to set temporarirly the flagann = 9 to recognize those that are no more sent by ERP
    BEGIN

    VL_COUNT_XIN_T074 := 0;
    select COUNT(*) into  VL_COUNT_XIN_T074  from user_constraints where owner = SYS_CONTEXT('USERENV','CURRENT_USER')  -- CURRENT USER
    AND CONSTRAINT_NAME = 'CHECK_T074_FLGANN'
    and TABLE_NAME = 'T074LISTDETT';

    if  VL_COUNT_XIN_T074 > 0 then

        EXECUTE IMMEDIATE ('ALTER TABLE T074LISTDETT DROP CONSTRAINT CHECK_T074_FLGANN');

    end if;
    EXCEPTION WHEN OTHERS THEN
     ROLLBACK;
      VL_MESSAGE_H := 'Error while dropping check on CHECK_T074_FLGANN';
      RAISE EX_EXIT;
    END;

    VL_COUNT_XIN_T074 := 0;


    BEGIN
        --
        -- ----------------------------------------------------------
        -- Init arrays with FIELD_NAME=LENGTH and FIELDNAME=SM1_DEFAULT for all fields of table
        -- ----------------------------------------------------------
        VL_DES_T070.DELETE;
        P_INIT_SM1_FIELD_ARRAY ('T070LIST',VL_DES_T070, VL_STATUS, VL_MESSAGE_H);
        execute immediate ( GL_INIT_REC) INTO REC_T070_INIT;

        VL_DES_T073.DELETE;
        P_INIT_SM1_FIELD_ARRAY ('T073CUSTOMERSTOAPPLY',VL_DES_T073, VL_STATUS, VL_MESSAGE_H);
        execute immediate ( GL_INIT_REC) INTO REC_T073_INIT;

        VL_DES_T074.DELETE;
        P_INIT_SM1_FIELD_ARRAY ('T074LISTDETT',VL_DES_T074,VL_STATUS, VL_MESSAGE_H);
        execute immediate ( GL_INIT_REC) INTO REC_T074_INIT;

        IF (VL_STATUS <> 0 ) THEN
            VL_MESSAGE_D := GL_INIT_REC;
            RAISE EX_EXIT;
        END IF;
    EXCEPTION WHEN OTHERS THEN
        VL_MESSAGE_D := GL_INIT_REC;
        RAISE EX_EXIT;
    END;


    -- --------------------------------------------------------------
    -- Identifies Xin records to be loaded
    -- --------------------------------------------------------------
    BEGIN
        VL_MESSAGE_D := 'XIN_T070LIST';
        UPDATE XIN_T070LIST
        SET SM1_CODPROCESS = PI_PROGR_H,
            SM1_STATUS = 0,
            SM1_DTEPROCESS = XSYSDATE
            WHERE SM1_CODPROCESS = C_SM1_NULL_CODPROCESS;
        VL_COUNT_XIN_T070 := SQL%ROWCOUNT;

        VL_MESSAGE_D := 'XIN_T073CUSTOMERSTOAPP';
        UPDATE XIN_T073CUSTOMERSTOAPP D
        SET D.SM1_CODPROCESS = PI_PROGR_H,
            D.SM1_STATUS = 0,
            D.SM1_DTEPROCESS = XSYSDATE
        WHERE (D.CODDOC, D.PRGDOCROW) IN (SELECT H.CODLIST, H.PRGLIST FROM XIN_T070LIST H WHERE H.SM1_CODPROCESS = PI_PROGR_H AND H.SM1_DTECRE >= D.SM1_DTECRE )
        AND SM1_CODPROCESS = C_SM1_NULL_CODPROCESS;
        VL_COUNT_XIN_T073 := SQL%ROWCOUNT;

        VL_MESSAGE_D := 'XIN_T074LISTDETT';
        UPDATE XIN_T074LISTDETT D
        SET D.SM1_CODPROCESS = PI_PROGR_H,
            D.SM1_STATUS = 0,
            D.SM1_DTEPROCESS = XSYSDATE
        WHERE (D.CODLIST, D.PRGLIST) IN (SELECT H.CODLIST, H.PRGLIST FROM XIN_T070LIST H WHERE H.SM1_CODPROCESS = PI_PROGR_H AND H.SM1_DTECRE >= D.SM1_DTECRE )
        AND SM1_CODPROCESS = C_SM1_NULL_CODPROCESS;
        VL_COUNT_XIN_T074 := SQL%ROWCOUNT;

    COMMIT;
    EXCEPTION WHEN OTHERS THEN
      ROLLBACK;
      VL_MESSAGE_H := 'Error while Reading Staging area: '||VL_MESSAGE_D;
      RAISE EX_EXIT;
    END;

    ------
    -- --------------------------------------------------------------
    -- loop in main table T070PRICELIST
    -- --------------------------------------------------------------
    FOR RL_XIN_T070 IN CL_XIN_T070 LOOP


      VL_MESSAGE_H :=   'Price List: '||RL_XIN_T070.CODLIST || '/' ||
                        'Version: '   ||RL_XIN_T070.PRGLIST;
      --
      BEGIN --- HEAD T070


       -- Data Format Check
        VL_MESSAGE_D := 'Format Conversion ';
        VL_CODDIV:= RL_XIN_T070.CODDIV;
        REC_T070.CODLIST := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T070.CODLIST,'CODLIST', VL_DES_T070,VL_STATUS, VL_MESSAGE_D);
        REC_T070.DESLIST := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T070.DESLIST,'DESLIST', VL_DES_T070,VL_STATUS, VL_MESSAGE_D);
        REC_T070.DTEFROMMASTER := F_CHECK_FORMAT_D( VL_CODDIV,   RL_XIN_T070.DTEFROMMASTER,'DTEFROMMASTER', VL_DES_T070,VL_STATUS, VL_MESSAGE_D);
        REC_T070.FLGCALCBENSUCC := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T070.FLGCALCBENSUCC,'FLGCALCBENSUCC', VL_DES_T070,VL_STATUS, VL_MESSAGE_D);
        REC_T070.DTETOMASTER := F_CHECK_FORMAT_D( VL_CODDIV,   RL_XIN_T070.DTETOMASTER,'DTETOMASTER', VL_DES_T070,VL_STATUS, VL_MESSAGE_D);
        REC_T070.FLGBENSUCC := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T070.FLGBENSUCC,'FLGBENSUCC', VL_DES_T070,VL_STATUS, VL_MESSAGE_D);
        REC_T070.CODCUR := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T070.CODCUR,'CODCUR', VL_DES_T070,VL_STATUS, VL_MESSAGE_D);
        REC_T070.FLGANN := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T070.FLGANN,'FLGANN', VL_DES_T070,VL_STATUS, VL_MESSAGE_D);
        REC_T070.FLGPRICINGLIST := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T070.FLGPRICINGLIST,'FLGPRICINGLIST', VL_DES_T070,VL_STATUS, VL_MESSAGE_D);
        REC_T070.PRGLIST := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T070.PRGLIST,'PRGLIST', VL_DES_T070,VL_STATUS, VL_MESSAGE_D);
        REC_T070.CODDIV := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T070.CODDIV,'CODDIV', VL_DES_T070,VL_STATUS, VL_MESSAGE_D);
        REC_T070.CODNODELIST := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T070.CODNODELIST,'CODNODELIST', VL_DES_T070,VL_STATUS, VL_MESSAGE_D);
        REC_T070.LEVNODELIST := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T070.LEVNODELIST,'LEVNODELIST', VL_DES_T070,VL_STATUS, VL_MESSAGE_D);
        REC_T070.CODHIER := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T070.CODHIER,'CODHIER', VL_DES_T070,VL_STATUS, VL_MESSAGE_D);
        REC_T070.FLGTAXES := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T070.FLGTAXES,'FLGTAXES', VL_DES_T070,VL_STATUS, VL_MESSAGE_D);


        --- Technical fields
        REC_T070.CODUSRMOD  := C_SYSUSR;
        REC_T070.DTEMOD     := XSYSDATE;
        REC_T070.CODUSRCREREAL := C_SYSUSR;
        REC_T070.CODUSRMODREAL := C_SYSUSR;

        -- lock fields
        REC_T070.CODUSRLCK     := C_SYSUSR;
        REC_T070.IDSESSIONLCK  := PI_SESSION_ID;
        REC_T070.DTELCK        := XSYSDATE;
        -- DocumentKey
        REC_T070.DOCUMENTKEY   := PKG_UTILS.documentkey_for_t070(REC_T070.CODLIST,REC_T070.PRGLIST);

        IF (VL_STATUS <> 0 ) THEN

         VL_MESSAGE_H := SUBSTR(VL_MESSAGE_H||' '||VL_MESSAGE_D||' - Whole price list will be descarded -'||dbms_utility.format_error_backtrace() || ' ' || SQLERRM,1,4000);

             PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                           VL_PROGR_D_T070,
                                           SQLCODE,
                                           VL_MESSAGE_H);
        END IF;

        IF (VL_STATUS = 0 ) THEN

        begin
          -- Verifies time range validity. If there is at least 1 price list with same code and different version with time validity overlap
          vl_count:=0;
          select prglist  into vl_count
            from T070List
            where T070List.CodList =  REC_T070.CODLIST and
                -- it is necessary to check pricelist of different version
                  T070List.PrgList <>  REC_T070.PRGLIST and
                  T070List.DteToMaster >= REC_T070.DTEFROMMASTER and
                  T070List.DteFromMaster <= REC_T070.DTETOMASTER and
                  rownum = 1;


            VL_STATUS := -1;
            PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                           VL_PROGR_D_T070,
                                           SQLCODE,
                                           'Cannot accept Pricelist '||VL_MESSAGE_H||' because of time overlap with existing version :'||vl_count);
          exception when others then
              null;
          end;
        END IF;

        IF (VL_STATUS = 0 ) THEN
          -- when status <> 0 some fields have incorrect format. Log t800 has been already wrote by F_CHECK function
          -- Update article if already exists


           VL_MESSAGE_D := 'Update T070List ';
           UPDATE T070LIST
           SET
               -- when the field si set to updated by host it means that the value should be read from XIN
               -- otherwise it means that the field is managed by sm1 and it maintains its original value
                DESLIST = CASE VL_DES_T070('DESLIST.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T070.DESLIST ELSE DESLIST END,
                FLGCALCBENSUCC = CASE VL_DES_T070('FLGCALCBENSUCC.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T070.FLGCALCBENSUCC ELSE FLGCALCBENSUCC END,
                DTEFROMMASTER = CASE VL_DES_T070('DTEFROMMASTER.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T070.DTEFROMMASTER ELSE DTEFROMMASTER END,
                DTETOMASTER = CASE VL_DES_T070('DTETOMASTER.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T070.DTETOMASTER ELSE DTETOMASTER END,
                FLGBENSUCC = CASE VL_DES_T070('FLGBENSUCC.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T070.FLGBENSUCC ELSE FLGBENSUCC END,
                CODCUR = CASE VL_DES_T070('CODCUR.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T070.CODCUR ELSE CODCUR END,
                FLGANN = CASE VL_DES_T070('FLGANN.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T070.FLGANN ELSE FLGANN END,
                FLGPRICINGLIST = CASE VL_DES_T070('FLGPRICINGLIST.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T070.FLGPRICINGLIST ELSE FLGPRICINGLIST END,
                CODDIV = CASE VL_DES_T070('CODDIV.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T070.CODDIV ELSE CODDIV END,
                CODNODELIST = CASE VL_DES_T070('CODNODELIST.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T070.CODNODELIST ELSE CODNODELIST END,
                LEVNODELIST = CASE VL_DES_T070('LEVNODELIST.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T070.LEVNODELIST ELSE LEVNODELIST END,
                CODHIER = CASE VL_DES_T070('CODHIER.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T070.CODHIER ELSE CODHIER END,
                FLGTAXES = CASE VL_DES_T070('FLGTAXES.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T070.FLGTAXES ELSE FLGTAXES END,
                --- Technical fields
                CODUSRMOD = CASE WHEN
                                DESLIST = CASE VL_DES_T070('DESLIST.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T070.DESLIST ELSE DESLIST END  AND
                                FLGCALCBENSUCC = CASE VL_DES_T070('FLGCALCBENSUCC.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T070.FLGCALCBENSUCC ELSE FLGCALCBENSUCC END  AND
                                DTEFROMMASTER = CASE VL_DES_T070('DTEFROMMASTER.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T070.DTEFROMMASTER ELSE DTEFROMMASTER END  AND
                                DTETOMASTER = CASE VL_DES_T070('DTETOMASTER.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T070.DTETOMASTER ELSE DTETOMASTER END  AND
                                FLGBENSUCC = CASE VL_DES_T070('FLGBENSUCC.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T070.FLGBENSUCC ELSE FLGBENSUCC END  AND
                                CODCUR = CASE VL_DES_T070('CODCUR.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T070.CODCUR ELSE CODCUR END  AND
                                FLGANN = CASE VL_DES_T070('FLGANN.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T070.FLGANN ELSE FLGANN END  AND
                                FLGPRICINGLIST = CASE VL_DES_T070('FLGPRICINGLIST.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T070.FLGPRICINGLIST ELSE FLGPRICINGLIST END  AND
                                CODDIV = CASE VL_DES_T070('CODDIV.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T070.CODDIV ELSE CODDIV END  AND
                                CODNODELIST = CASE VL_DES_T070('CODNODELIST.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T070.CODNODELIST ELSE CODNODELIST END  AND
                                LEVNODELIST = CASE VL_DES_T070('LEVNODELIST.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T070.LEVNODELIST ELSE LEVNODELIST END  AND
                                CODHIER = CASE VL_DES_T070('CODHIER.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T070.CODHIER ELSE CODHIER END  AND
                                FLGTAXES = CASE VL_DES_T070('FLGTAXES.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T070.FLGTAXES ELSE FLGTAXES END
                            THEN CODUSRMOD
                            ELSE REC_T070.CODUSRMOD
                            END,
                DTEMOD = CASE WHEN
                          DESLIST = CASE VL_DES_T070('DESLIST.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T070.DESLIST ELSE DESLIST END AND
                          FLGCALCBENSUCC = CASE VL_DES_T070('FLGCALCBENSUCC.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T070.FLGCALCBENSUCC ELSE FLGCALCBENSUCC END AND
                          DTEFROMMASTER = CASE VL_DES_T070('DTEFROMMASTER.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T070.DTEFROMMASTER ELSE DTEFROMMASTER END  AND
                          DTETOMASTER = CASE VL_DES_T070('DTETOMASTER.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T070.DTETOMASTER ELSE DTETOMASTER END AND
                          FLGBENSUCC = CASE VL_DES_T070('FLGBENSUCC.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T070.FLGBENSUCC ELSE FLGBENSUCC END AND
                          CODCUR = CASE VL_DES_T070('CODCUR.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T070.CODCUR ELSE CODCUR END AND
                          FLGANN = CASE VL_DES_T070('FLGANN.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T070.FLGANN ELSE FLGANN END AND
                          FLGPRICINGLIST = CASE VL_DES_T070('FLGPRICINGLIST.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T070.FLGPRICINGLIST ELSE FLGPRICINGLIST END AND
                          CODDIV = CASE VL_DES_T070('CODDIV.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T070.CODDIV ELSE CODDIV END AND
                          CODNODELIST = CASE VL_DES_T070('CODNODELIST.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T070.CODNODELIST ELSE CODNODELIST END AND
                          LEVNODELIST = CASE VL_DES_T070('LEVNODELIST.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T070.LEVNODELIST ELSE LEVNODELIST END AND
                          CODHIER = CASE VL_DES_T070('CODHIER.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T070.CODHIER ELSE CODHIER END AND
                          FLGTAXES = CASE VL_DES_T070('FLGTAXES.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T070.FLGTAXES ELSE FLGTAXES END
                      THEN DTEMOD
                      ELSE REC_T070.DTEMOD
                      END,
                -- lock fields
                CODUSRLCK    = REC_T070.CODUSRLCK,
                IDSESSIONLCK = REC_T070.IDSESSIONLCK,
                DTELCK       = REC_T070.DTELCK

         WHERE CODLIST = REC_T070.CODLIST
           AND PRGLIST = REC_T070.PRGLIST
           and not exists ( select null from T035LOGGEDUSERS T035 where T035.IDSESSION = NVL(IDSESSIONLCK, '@') AND T035.LASTCHECK > TRUNC(XSYSDATE)-1 );

        -- no data found, it could be
        --   a. record does not exists
        --   b. record is locked by another sm1 user

        IF SQL%ROWCOUNT = 0 THEN

          VL_COUNT := 0;
          SELECT COUNT(*) INTO VL_COUNT FROM T070LIST
           WHERE CODLIST = REC_T070.CODLIST
           AND   PRGLIST = REC_T070.PRGLIST;

          IF ( VL_COUNT = 0 ) THEN
              VL_MESSAGE_D := 'Insert T070list ';
              -- Record does not exists, we insert it
              INSERT INTO T070LIST VALUES REC_T070;
                 --
                 -- UPDATED ONLY IF ALL DETAILS HAVE BEEN COMMITTED VL_INS_T070 := VL_INS_T070 + 1;

           ELSE
            VL_STATUS := -1;
            VL_RECORD_LOCKED := -1;
            PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                           VL_PROGR_D_T070,
                                           SQLCODE,
                                           'Record is locked; import has failed :'||VL_MESSAGE_H);

        END IF; -- Record has been inserted
        END IF; -- Record has been updated
        END IF; -- VL_STATUS = 0

        EXCEPTION WHEN OTHERS THEN
             VL_STATUS := -1;
             VL_MESSAGE_H := SUBSTR(VL_MESSAGE_H||' '||VL_MESSAGE_D||' -Whole price list will be discarded - '||dbms_utility.format_error_backtrace() || ' ' || SQLERRM,1,4000);

             PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                           VL_PROGR_D_T070,
                                           SQLCODE,
                                           VL_MESSAGE_H);
        END; -- HEAD T070list

        -- ----------------------------------------
        --  CUSTOMER TO APPLY T073CUSTOMERSTOAPPLY
        -- ----------------------------------------

        IF ( VL_STATUS = 0  ) THEN

              FOR RL_XIN_T073 IN CL_XIN_T073(RL_XIN_T070.CODLIST, RL_XIN_T070.PRGLIST, RL_XIN_T070.SM1_DTECRE) LOOP

              BEGIN
              SAVEPOINT S_T073CUSTOMERSTOAPPLY;

              VL_MESSAGE_H := 'Cod List: '|| RL_XIN_T073.CODDOC || '-' || RL_XIN_T073.PRGDOCROW || '/' ||
                              'Division: '|| RL_XIN_T073.CODDIV || '/' ||
                              'Attribute1: ' || RL_XIN_T073.ATTRVAL1;

                VL_MESSAGE_D := 'Format Conversion ';
                -- Data Format Check
                VL_CODDIV:= RL_XIN_T073.CODDIV;
                REC_T073.DOCTYPE := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T073.DOCTYPE,'DOCTYPE', VL_DES_T073,VL_STATUS, VL_MESSAGE_D);
                REC_T073.CODDOC := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T073.CODDOC,'CODDOC', VL_DES_T073,VL_STATUS, VL_MESSAGE_D);
                REC_T073.PRGDOCROW := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T073.PRGDOCROW,'PRGDOCROW', VL_DES_T073,VL_STATUS, VL_MESSAGE_D);
                REC_T073.CODDIV := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T073.CODDIV,'CODDIV', VL_DES_T073,VL_STATUS, VL_MESSAGE_D);
                REC_T073.PRGROW := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T073.PRGROW,'PRGROW', VL_DES_T073,VL_STATUS, VL_MESSAGE_D);
                REC_T073.FLGEXCLUDE := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T073.FLGEXCLUDE,'FLGEXCLUDE', VL_DES_T073,VL_STATUS, VL_MESSAGE_D);
                REC_T073.ATTRVAL1 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T073.ATTRVAL1,'ATTRVAL1', VL_DES_T073,VL_STATUS, VL_MESSAGE_D);
                REC_T073.ATTRVAL2 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T073.ATTRVAL2,'ATTRVAL2', VL_DES_T073,VL_STATUS, VL_MESSAGE_D);
                REC_T073.ATTRVAL3 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T073.ATTRVAL3,'ATTRVAL3', VL_DES_T073,VL_STATUS, VL_MESSAGE_D);
                REC_T073.ATTRVAL4 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T073.ATTRVAL4,'ATTRVAL4', VL_DES_T073,VL_STATUS, VL_MESSAGE_D);
                REC_T073.ATTRVAL5 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T073.ATTRVAL5,'ATTRVAL5', VL_DES_T073,VL_STATUS, VL_MESSAGE_D);
                REC_T073.ATTRVAL6 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T073.ATTRVAL6,'ATTRVAL6', VL_DES_T073,VL_STATUS, VL_MESSAGE_D);
                REC_T073.ATTRVAL7 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T073.ATTRVAL7,'ATTRVAL7', VL_DES_T073,VL_STATUS, VL_MESSAGE_D);
                REC_T073.ATTRVAL8 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T073.ATTRVAL8,'ATTRVAL8', VL_DES_T073,VL_STATUS, VL_MESSAGE_D);
                REC_T073.ATTRVAL9 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T073.ATTRVAL9,'ATTRVAL9', VL_DES_T073,VL_STATUS, VL_MESSAGE_D);
                REC_T073.ATTRVAL10 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T073.ATTRVAL10,'ATTRVAL10', VL_DES_T073,VL_STATUS, VL_MESSAGE_D);
                REC_T073.ATTRVAL11 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T073.ATTRVAL11,'ATTRVAL11', VL_DES_T073,VL_STATUS, VL_MESSAGE_D);
                REC_T073.ATTRVAL12 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T073.ATTRVAL12,'ATTRVAL12', VL_DES_T073,VL_STATUS, VL_MESSAGE_D);
                REC_T073.ATTRVAL13 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T073.ATTRVAL13,'ATTRVAL13', VL_DES_T073,VL_STATUS, VL_MESSAGE_D);
                REC_T073.ATTRVAL14 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T073.ATTRVAL14,'ATTRVAL14', VL_DES_T073,VL_STATUS, VL_MESSAGE_D);
                REC_T073.ATTRVAL15 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T073.ATTRVAL15,'ATTRVAL15', VL_DES_T073,VL_STATUS, VL_MESSAGE_D);
                REC_T073.ATTRVAL16 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T073.ATTRVAL16,'ATTRVAL16', VL_DES_T073,VL_STATUS, VL_MESSAGE_D);
                REC_T073.ATTRVAL17 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T073.ATTRVAL17,'ATTRVAL17', VL_DES_T073,VL_STATUS, VL_MESSAGE_D);
                REC_T073.ATTRVAL18 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T073.ATTRVAL18,'ATTRVAL18', VL_DES_T073,VL_STATUS, VL_MESSAGE_D);
                REC_T073.ATTRVAL19 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T073.ATTRVAL19,'ATTRVAL19', VL_DES_T073,VL_STATUS, VL_MESSAGE_D);
                REC_T073.ATTRVAL20 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T073.ATTRVAL20,'ATTRVAL20', VL_DES_T073,VL_STATUS, VL_MESSAGE_D);

                IF (VL_STATUS = 0 ) THEN

                  VL_MESSAGE_D := 'Update T073 ';
                  UPDATE T073CUSTOMERSTOAPPLY
                         SET
                            FLGEXCLUDE = REC_T073.FLGEXCLUDE,
                            ATTRVAL1 = REC_T073.ATTRVAL1,
                            ATTRVAL2 = REC_T073.ATTRVAL2,
                            ATTRVAL3 = REC_T073.ATTRVAL3,
                            ATTRVAL4 = REC_T073.ATTRVAL4,
                            ATTRVAL5 = REC_T073.ATTRVAL5,
                            ATTRVAL6 = REC_T073.ATTRVAL6,
                            ATTRVAL7 = REC_T073.ATTRVAL7,
                            ATTRVAL8 = REC_T073.ATTRVAL8,
                            ATTRVAL9 = REC_T073.ATTRVAL9,
                            ATTRVAL10 = REC_T073.ATTRVAL10,
                            ATTRVAL11 = REC_T073.ATTRVAL11,
                            ATTRVAL12 = REC_T073.ATTRVAL12,
                            ATTRVAL13 = REC_T073.ATTRVAL13,
                            ATTRVAL14 = REC_T073.ATTRVAL14,
                            ATTRVAL15 = REC_T073.ATTRVAL15,
                            ATTRVAL16 = REC_T073.ATTRVAL16,
                            ATTRVAL17 = REC_T073.ATTRVAL17,
                            ATTRVAL18 = REC_T073.ATTRVAL18,
                            ATTRVAL19 = REC_T073.ATTRVAL19,
                            ATTRVAL20 = REC_T073.ATTRVAL20
                     WHERE DOCTYPE       = C_PRICELIST_DOCTYPE
                         AND CODDOC      = REC_T073.CODDOC
                         AND PRGDOCROW   = REC_T073.PRGDOCROW
                         AND CODDIV      = REC_T073.CODDIV
                         AND PRGROW      = REC_T073.PRGROW;

                 --
                      IF SQL%ROWCOUNT = 0 THEN
                        -- record does not exists , we insert it new
                       --
                        VL_MESSAGE_D := 'Insert T073 ';

                        INSERT INTO T073CUSTOMERSTOAPPLY VALUES REC_T073;

                      END IF; -- record has been inserted
                      VL_INS_T073 := VL_INS_T073 + 1;
                      --
                   END IF; -- record has been updated


                  -- IF a detail has an error, it flags the staging area and set the vl_status = 0 to continue loading the next detail
                      IF (VL_STATUS <> 0 ) THEN
                          ROLLBACK TO S_T073CUSTOMERSTOAPPLY;

                          UPDATE XIN_T073CUSTOMERSTOAPP
                            SET SM1_STATUS = C_XINSTATUS_ERR
                            WHERE DOCTYPE       = C_PRICELIST_DOCTYPE
                             AND CODDOC      = RL_XIN_T073.CODDOC
                             AND PRGDOCROW   = RL_XIN_T073.PRGDOCROW
                             AND CODDIV      = RL_XIN_T073.CODDIV
                             AND PRGROW      = RL_XIN_T073.PRGROW
                            AND  SM1_CODPROCESS = PI_PROGR_H
                            AND  SM1_DTECRE     = RL_XIN_T073.SM1_DTECRE
                            AND  SM1_STATUS     = C_XINSTATUS_OK;

                      END IF;


                      EXCEPTION
                      WHEN OTHERS THEN

                         VL_STATUS := -1;
                         VL_MESSAGE_H := SUBSTR(VL_MESSAGE_H||' '||VL_MESSAGE_D||' '||dbms_utility.format_error_backtrace() || ' ' || SQLERRM,1,4000);

                         PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                                         VL_PROGR_D_T073,
                                                         SQLCODE,
                                                         VL_MESSAGE_H);

                     END; ---T073  CUSTOMER TO APPLY

              END LOOP;
      END IF; --( VL_STATUS = 0 AND VL_RECORD_LOCKED = 0 )
        --
        -- -------------------------
        -- -- DETAIL T074LISTDETT
        -- -------------------------

        IF ( VL_STATUS = 0  ) THEN

              VL_PRGROW := 0;
              -- we need the last prgrow in order to increment it in case of insert
              SELECT MAX(PRGROW) INTO VL_PRGROW
               FROM  T074LISTDETT
               WHERE CODLIST = REC_T070.CODLIST
                 AND PRGLIST = REC_T070.PRGLIST;

              IF ( VL_PRGROW IS NULL ) THEN
                 VL_PRGROW := 0;
              END IF;

              FOR RL_XIN_T074 IN CL_XIN_T074(RL_XIN_T070.CODLIST, RL_XIN_T070.PRGLIST, RL_XIN_T070.SM1_DTECRE) LOOP
                        -- pings to t035 every 1000 cicles--
              VL_STEP := VL_STEP + 1;
              IF ( MOD(VL_STEP, 1000) = 0 ) THEN
                 PKG_UTILS.user_ping(PI_SESSION_ID);
              END IF;

              BEGIN
              -- Identify new set of record  ; set totals
              IF (NVL(RL_XIN_T074_PREV.CODART, '@') <> RL_XIN_T074.CODART  OR
                      RL_XIN_T074_PREV.CODDIV       <> RL_XIN_T074.CODDIV  )

              THEN
                  VL_FLG_NEW_SET := -1;
                  IF ( VL_STATUS = 0 ) THEN
                     VL_INS_T074 := VL_INS_T074 + VL_INS;
                     COMMIT;
                  END IF;
                  VL_INS := 0;
                  VL_STATUS := 0;
              ELSE
                  VL_FLG_NEW_SET := 0;
              END IF;


                VL_MESSAGE_H := 'Cod List: '|| RL_XIN_T074.CODLIST || '-' || RL_XIN_T074.PRGLIST || '/' ||
                                'Division: '|| RL_XIN_T074.CODDIV || '/' ||
                                'Product: ' || RL_XIN_T074.CODART;

                VL_MESSAGE_D := 'Format Conversion ';
                -- Data Format Check
                VL_CODDIV:= RL_XIN_T074.CODDIV;
                REC_T074.CODART := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T074.CODART,'CODART', VL_DES_T074,VL_STATUS, VL_MESSAGE_D);
                REC_T074.CODDIV := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T074.CODDIV,'CODDIV', VL_DES_T074,VL_STATUS, VL_MESSAGE_D);
                REC_T074.CODLIST := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T074.CODLIST,'CODLIST', VL_DES_T074,VL_STATUS, VL_MESSAGE_D);
                --REC_T074.DTEFROMMASTER := F_CHECK_FORMAT_D( VL_CODDIV,   RL_XIN_T074.DTEFROMMASTER,'DTEFROMMASTER',VL_STATUS, VL_MESSAGE_D);
                REC_T074.PRZVAL := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T074.PRZVAL,'PRZVAL', VL_DES_T074,VL_STATUS, VL_MESSAGE_D);
                REC_T074.DTEFROMDETAIL := F_CHECK_FORMAT_D( VL_CODDIV,   RL_XIN_T074.DTEFROMDETAIL,'DTEFROMDETAIL', VL_DES_T074,VL_STATUS, VL_MESSAGE_D);
                REC_T074.UMPRZ := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T074.UMPRZ,'UMPRZ', VL_DES_T074,VL_STATUS, VL_MESSAGE_D);
                REC_T074.DTETODETAIL := F_CHECK_FORMAT_D( VL_CODDIV,   RL_XIN_T074.DTETODETAIL,'DTETODETAIL', VL_DES_T074,VL_STATUS, VL_MESSAGE_D);
                REC_T074.FLGANN := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T074.FLGANN,'FLGANN', VL_DES_T074,VL_STATUS, VL_MESSAGE_D);
                REC_T074.PRZVALPVP := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T074.PRZVALPVP,'PRZVALPVP', VL_DES_T074,VL_STATUS, VL_MESSAGE_D);
                REC_T074.FLGPRINTDET := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T074.FLGPRINTDET,'FLGPRINTDET', VL_DES_T074,VL_STATUS, VL_MESSAGE_D);
                REC_T074.FLGPRINTPVP := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T074.FLGPRINTPVP,'FLGPRINTPVP', VL_DES_T074,VL_STATUS, VL_MESSAGE_D);
                REC_T074.PRGLIST := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T074.PRGLIST,'PRGLIST', VL_DES_T074,VL_STATUS, VL_MESSAGE_D);
                REC_T074.MINSALESPRICE := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T074.MINSALESPRICE,'MINSALESPRICE', VL_DES_T074,VL_STATUS, VL_MESSAGE_D);
                REC_T074.MAXSALESPRICE := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T074.MAXSALESPRICE,'MAXSALESPRICE', VL_DES_T074,VL_STATUS, VL_MESSAGE_D);
                REC_T074.FLGTOPSELLING := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T074.FLGTOPSELLING,'FLGTOPSELLING', VL_DES_T074,VL_STATUS, VL_MESSAGE_D);


                -- Technical Fields
                REC_T074.DTEMOD := XSYSDATE;
                REC_T074.CODUSRMOD := C_SYSUSR;
                --

                IF ( VL_FLG_NEW_SET <> 0 AND VL_STATUS = 0) THEN
                    -- flags  ACTIVE records of current year, before reload them
                    -- it has to be left here because it has to be rollbacked to savepoint S_T074LISTDETT in case of error
                    UPDATE T074LISTDETT SET FLGANN = 9
                       WHERE CODLIST = REC_T074.CODLIST
                         AND PRGLIST = REC_T074.PRGLIST
                         AND CODART  = REC_T074.CODART
                         AND CODDIV  = REC_T074.CODDIV
                         AND FLGANN  = 0
                         AND DTETODETAIL  >= VL_FIRST_DAY_OF_YEAR;
                         VL_FLG_NEW_SET := 0;
                END IF;

                -- PROCESSES the record only if it belongs to current year
                IF ( REC_T074.DTETODETAIL >= VL_FIRST_DAY_OF_YEAR ) THEN

                      -- Check if product exists
                      VL_COUNT := 0;
                      select count(*) into VL_COUNT from T060ARTICLE WHERE CODART = RL_XIN_T074.CODART AND CODDIV = RL_XIN_T074.CODDIV ;

                      IF VL_COUNT = 0 THEN
                         VL_MESSAGE_D := 'Article does not exist  ';
                         VL_STATUS := -1;
                      END IF;


                      IF (VL_STATUS <> 0 ) THEN
                         VL_MESSAGE_H := SUBSTR(VL_MESSAGE_H||' '||VL_MESSAGE_D||' '||dbms_utility.format_error_backtrace() || ' ' || SQLERRM,1,4000);
                         PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                                 VL_PROGR_D_T074,
                                                 SQLCODE,
                                                 VL_MESSAGE_H);
                      END IF;

                      IF (VL_STATUS = 0 ) THEN

                      VL_MESSAGE_D := 'Update T074 ';
                      UPDATE T074LISTDETT
                         SET
                            FLGANN        = REC_T074.FLGANN,
                            PRZVALPVP     = CASE VL_DES_T074('PRZVALPVP.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T074.PRZVALPVP ELSE PRZVALPVP END,
                            FLGPRINTDET   = CASE VL_DES_T074('FLGPRINTDET.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T074.FLGPRINTDET ELSE FLGPRINTDET END,
                            FLGPRINTPVP   = CASE VL_DES_T074('FLGPRINTPVP.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T074.FLGPRINTPVP ELSE FLGPRINTPVP END,
                            MINSALESPRICE = CASE VL_DES_T074('MINSALESPRICE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T074.MINSALESPRICE ELSE MINSALESPRICE END,
                            MAXSALESPRICE = CASE VL_DES_T074('MAXSALESPRICE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T074.MAXSALESPRICE ELSE MAXSALESPRICE END,
                            FLGTOPSELLING = CASE VL_DES_T074('FLGTOPSELLING.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T074.FLGTOPSELLING ELSE FLGTOPSELLING END,
                            DTETODETAIL   = CASE VL_DES_T074('DTETODETAIL.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T074.DTETODETAIL ELSE DTETODETAIL END,
                            -- technical fields
                            -- As all price list from first day of year have been imported , we modify the dtemod only if there is something really changed
                            DTEMOD    =    CASE WHEN (( (FLGANN IN (0, 9) AND REC_T074.FLGANN = 0) OR (FLGANN = -1 AND REC_T074.FLGANN = -1)) AND
                                                        PRZVALPVP    =  CASE VL_DES_T074('PRZVALPVP.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T074.PRZVALPVP ELSE PRZVALPVP END  AND
                                                        FLGPRINTDET  =  CASE VL_DES_T074('FLGPRINTDET.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T074.FLGPRINTDET ELSE FLGPRINTDET END  AND
                                                        FLGPRINTPVP  =  CASE VL_DES_T074('FLGPRINTPVP.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T074.FLGPRINTPVP ELSE FLGPRINTPVP END  AND
                                                        FLGTOPSELLING=  CASE VL_DES_T074('FLGTOPSELLING.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T074.FLGTOPSELLING ELSE FLGTOPSELLING END  AND
                                                        MINSALESPRICE=  CASE VL_DES_T074('MINSALESPRICE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T074.MINSALESPRICE ELSE MINSALESPRICE END  AND
                                                        MAXSALESPRICE=  CASE VL_DES_T074('MAXSALESPRICE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T074.MAXSALESPRICE ELSE MAXSALESPRICE END )
                                             THEN DTEMOD ELSE REC_T074.DTEMOD END,

                            CODUSRMOD =    CASE WHEN ( ( (FLGANN IN (0, 9) AND REC_T074.FLGANN = 0) OR (FLGANN = -1 AND REC_T074.FLGANN = -1)) AND
                                                        PRZVALPVP     = CASE VL_DES_T074('PRZVALPVP.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T074.PRZVALPVP ELSE PRZVALPVP END  AND
                                                        FLGPRINTDET   = CASE VL_DES_T074('FLGPRINTDET.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T074.FLGPRINTDET ELSE FLGPRINTDET END  AND
                                                        FLGPRINTPVP   = CASE VL_DES_T074('FLGPRINTPVP.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T074.FLGPRINTPVP ELSE FLGPRINTPVP END  AND
                                                        FLGTOPSELLING = CASE VL_DES_T074('FLGTOPSELLING.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T074.FLGTOPSELLING ELSE FLGTOPSELLING END  AND
                                                        MINSALESPRICE = CASE VL_DES_T074('MINSALESPRICE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T074.MINSALESPRICE ELSE MINSALESPRICE END  AND
                                                        MAXSALESPRICE = CASE VL_DES_T074('MAXSALESPRICE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T074.MAXSALESPRICE ELSE MAXSALESPRICE END )
                                             THEN CODUSRMOD ELSE REC_T074.CODUSRMOD END


                       WHERE CODLIST        = REC_T074.CODLIST
                         AND PRGLIST        = REC_T074.PRGLIST
                         AND CODART         = REC_T074.CODART
                         AND CODDIV         = REC_T074.CODDIV
                         AND DTEFROMDETAIL  = REC_T074.DTEFROMDETAIL
                         AND PRZVAL         = REC_T074.PRZVAL
                         AND UMPRZ          = REC_T074.UMPRZ;

                 --
                      IF SQL%ROWCOUNT = 0 THEN
                        -- record does not exists , we insert it new
                       --
                        VL_MESSAGE_D := 'Insert T074 ';
                        VL_PRGROW := VL_PRGROW + 1;
                        REC_T074.PRGROW := VL_PRGROW;
                        INSERT INTO T074LISTDETT VALUES REC_T074;

                      END IF; -- record has been inserted
                      VL_INS := VL_INS + 1;
                      --
                      END IF; -- record has been updated
                      END IF; -- CURRENT YEAR CHECK

                  -- IF a detail has an error, it flags the staging area and set the vl_status = 0 to continue loading the next detail
                      IF (VL_STATUS <> 0 ) THEN
                          ROLLBACK;

                          UPDATE XIN_T074LISTDETT
                            SET SM1_STATUS = C_XINSTATUS_ERR
                            WHERE CODLIST = RL_XIN_T074.CODLIST
                              AND PRGLIST = RL_XIN_T074.PRGLIST
                              AND CODART  = RL_XIN_T074.CODART
                              AND CODDIV  = RL_XIN_T074.CODDIV
                            AND  SM1_CODPROCESS = PI_PROGR_H
                            AND  SM1_DTECRE     = RL_XIN_T074.SM1_DTECRE
                            AND  SM1_STATUS     = C_XINSTATUS_OK;

                      END IF;


                      EXCEPTION
                      WHEN OTHERS THEN

                         VL_STATUS := -1;
                         VL_MESSAGE_H := SUBSTR(VL_MESSAGE_H||' '||VL_MESSAGE_D||' '||dbms_utility.format_error_backtrace() || ' ' || SQLERRM,1,4000);

                         PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                                         VL_PROGR_D_T074,
                                                         SQLCODE,
                                                         VL_MESSAGE_H);

                     END; --- LIST DETAIL T074


              -- Keeps prev record
              RL_XIN_T074_PREV  := RL_XIN_T074;

              END LOOP;
      END IF; --( VL_STATUS = 0 AND VL_RECORD_LOCKED = 0 )
        --


      -- if all records have been stored with success then it makes the commit
      IF ( VL_STATUS = 0  ) THEN
        VL_INS_T074 := VL_INS_T074 + VL_INS;
        VL_INS      := 0;
        VL_INS_T070 := VL_INS_T070 + 1;
        COMMIT;
      ELSE
        ROLLBACK;
      END IF;

      UPDATE XIN_T070LIST
      SET SM1_STATUS =  CASE WHEN VL_STATUS = 0          THEN C_XINSTATUS_OK
                          WHEN VL_RECORD_LOCKED <> 0  THEN C_XINSTATUS_LOCK
                          ELSE C_XINSTATUS_ERR END
      WHERE CODLIST = RL_XIN_T070.CODLIST
      AND   PRGLIST = RL_XIN_T070.PRGLIST
      AND   SM1_CODPROCESS = PI_PROGR_H
      AND   SM1_DTECRE  = RL_XIN_T070.SM1_DTECRE
      AND   SM1_STATUS  = C_XINSTATUS_OK;

      UPDATE XIN_T073CUSTOMERSTOAPP
      SET SM1_STATUS =  CASE WHEN VL_STATUS = 0          THEN C_XINSTATUS_OK
                          WHEN VL_RECORD_LOCKED <> 0  THEN C_XINSTATUS_LOCK
                          ELSE C_XINSTATUS_ERR END
      WHERE CODDOC = RL_XIN_T070.CODLIST
      AND   PRGDOCROW = RL_XIN_T070.PRGLIST
      AND   SM1_CODPROCESS = PI_PROGR_H
      AND   SM1_DTECRE  <= RL_XIN_T070.SM1_DTECRE
      AND   SM1_STATUS  = C_XINSTATUS_OK;

      UPDATE XIN_T074LISTDETT
      SET SM1_STATUS =  CASE WHEN VL_STATUS = 0          THEN C_XINSTATUS_OK
                          WHEN VL_RECORD_LOCKED <> 0  THEN C_XINSTATUS_LOCK
                          ELSE C_XINSTATUS_ERR END
      WHERE CODLIST = RL_XIN_T070.CODLIST
      AND   PRGLIST = RL_XIN_T070.PRGLIST
      AND   SM1_CODPROCESS = PI_PROGR_H
      AND   SM1_DTECRE  <= RL_XIN_T070.SM1_DTECRE
      AND   SM1_STATUS  = C_XINSTATUS_OK;

      VL_STATUS := 0;
      VL_RECORD_LOCKED := 0;


     -- Updates the no more present records in the xin
     -- CLOSED THE ACTIVE ONES
        UPDATE T074LISTDETT SET FLGANN    = 0,
                                DTEMOD    = XSYSDATE,
                                CODUSRMOD = REC_T070.CODUSRMOD,
                                DTETODETAIL = TRUNC(XSYSDATE)
                       WHERE CODLIST = REC_T070.CODLIST
                         AND PRGLIST = REC_T070.PRGLIST
                         AND XSYSDATE BETWEEN DTEFROMDETAIL AND DTETODETAIL
                         AND FLGANN  = 9;
         -- DELETE THE FUTURE ONES
        DELETE T074LISTDETT
                       WHERE CODLIST = REC_T070.CODLIST
                         AND PRGLIST = REC_T070.PRGLIST
                         AND TRUNC(XSYSDATE) < DTEFROMDETAIL
                         AND FLGANN  = 9;

         -- LEAVES AS IT IS THE ALREADY CLOSED ONES
         UPDATE T074LISTDETT SET FLGANN    = 0,
                                DTEMOD    = XSYSDATE,
                                CODUSRMOD = REC_T070.CODUSRMOD
                       WHERE CODLIST = REC_T070.CODLIST
                         AND PRGLIST = REC_T070.PRGLIST
                         AND TRUNC(XSYSDATE) > DTETODETAIL
                         AND FLGANN  = 9;


        -- Release updated records
        UPDATE T070LIST H
        SET       H.DTELCK          = NULL,
                  H.IDSESSIONLCK    = NULL,
                  H.CODUSRLCK       = NULL,
                  --Aligns the dtemod of the detail and the head
                  H.DTEMOD          = ( SELECT MAX(D.DTEMOD) FROM T074LISTDETT D WHERE D.CODLIST = H.CODLIST AND D.PRGLIST = H.PRGLIST )
        WHERE CODLIST = REC_T070.CODLIST
          AND PRGLIST = REC_T070.PRGLIST
          AND CODUSRLCK = C_SYSUSR AND IDSESSIONLCK = PI_SESSION_ID;
        COMMIT;


    END LOOP;

    -- Moves records from staging area to log staging area

   P_XIN_MOVE_TO_LOG(PI_PROGR_H, VL_PROGR_D_T074,'T074LISTDETT');
   P_XIN_MOVE_TO_LOG(PI_PROGR_H, VL_PROGR_D_T073,'T073CUSTOMERSTOAPP');
   P_XIN_MOVE_TO_LOG(PI_PROGR_H, VL_PROGR_D_T070,'T070LIST');
   --


   -- Close Logs
    PKG_UTILS.LOG_END_DETAIL(PI_PROGR_H,
                                      VL_PROGR_D_T074,
                                      0,
                                      VL_COUNT_XIN_T074,
                                      VL_INS_T074,
                                      VL_COUNT_XIN_T074 - VL_INS_T074);
    --
    PKG_UTILS.LOG_END_DETAIL(PI_PROGR_H,
                                      VL_PROGR_D_T073,
                                      0,
                                      VL_COUNT_XIN_T073,
                                      VL_INS_T073,
                                      VL_COUNT_XIN_T073 - VL_INS_T073);
   --
    PKG_UTILS.LOG_END_DETAIL(PI_PROGR_H,
                                      VL_PROGR_D_T070,
                                      0,
                                      VL_COUNT_XIN_T070,
                                      VL_INS_T070,
                                      VL_COUNT_XIN_T070 - VL_INS_T070);



    PO_MSG := VL_INS_T070||' List loaded';
    PO_STATUS :=VL_INS_T070;

    ------ RE SET THE CHECK ON T074
    EXECUTE IMMEDIATE ('ALTER TABLE T074LISTDETT add CONSTRAINT CHECK_T074_FLGANN CHECK (FLGANN = 0 OR FLGANN = -1)');
    ------

    --
  EXCEPTION WHEN EX_EXIT THEN

          ROLLBACK;
          VL_MESSAGE_H       := VL_MESSAGE_H || TRIM(SUBSTR(dbms_utility.format_error_backtrace() || ' ' || SQLERRM, 1, 255));
          PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                                  VL_PROGR_D_T070,
                                                  SQLCODE,
                                                  VL_MESSAGE_H);

          PO_MSG := VL_MESSAGE_H;
          PO_STATUS := -1;
          ------ RE SET THE CHECK ON T074
           EXECUTE IMMEDIATE ('ALTER TABLE T074LISTDETT add CONSTRAINT CHECK_T074_FLGANN CHECK (FLGANN = 0 OR FLGANN = -1)');
           ------

   WHEN OTHERS THEN

          ROLLBACK;

          BEGIN
              -- Release updated records
               UPDATE T070LIST
                SET       DTELCK          = NULL,
                          IDSESSIONLCK    = NULL,
                          CODUSRLCK       = NULL
                WHERE CODUSRLCK = C_SYSUSR AND IDSESSIONLCK = PI_SESSION_ID;
                COMMIT;

             -- Moves records from staging area to log staging area
               P_XIN_MOVE_TO_LOG(PI_PROGR_H, VL_PROGR_D_T074,'T074LISTDETT');
               P_XIN_MOVE_TO_LOG(PI_PROGR_H, VL_PROGR_D_T073,'T073CUSTOMERSTOAPP');
               P_XIN_MOVE_TO_LOG(PI_PROGR_H, VL_PROGR_D_T070,'T070LIST');
            --

          END;

          VL_MESSAGE_H       := VL_MESSAGE_H || TRIM(SUBSTR(dbms_utility.format_error_backtrace() || ' ' || SQLERRM, 1, 255));
          PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                                  VL_PROGR_D_T070,
                                                  SQLCODE,
                                                  VL_MESSAGE_H);

          PO_MSG := VL_MESSAGE_H;
          PO_STATUS := VL_STATUS;

           ------ RE SET THE CHECK ON T074
           EXECUTE IMMEDIATE ('ALTER TABLE T074LISTDETT add CONSTRAINT CHECK_T074_FLGANN CHECK (FLGANN = 0 OR FLGANN = -1)');
           ------


  END LOAD_T07X_PRICELIST;
   /*============================================================================*\
  /* Name: T096_OPEN_INVOICES
      Loads SM1 tables
      • T096PARTYBALANCE      Customer open items
      Staging Area (SSA) tables:
      • XIN_ T096PARTYBALANCE

      Loading logic:
      Massive. TRUNCATE + INSERT. Each import loads all the records. Table is truncated and reloaded

      Validity Checks:
      • Records found  on XIN_ T096PARTYBALANCE are loaded only if the customer is present on T040PARTY table.

      Error handling:
      • All Errors will be logged in T852/T854 SM1 log tables and all staging area records will be stored into staging area log with sm1_status = 9.
      • Error on record,  it is discarded and import procedure skip to load next record.

      How to delete an Open Invoice. You should not have the need as each import truncate and reloads all records.

     Input parameters :     PI_PROGR_H - unique sm1 job number ( T800SYSTEMACTIVITYLOG )
                            PI_SESSION_ID    - unique login session (T035LOGGEDUSERS)
     Outputparameters :     PO_MSG           - message of error if procedure exit with error
                            PO_STATUS        - 0 OK; -1 Error
     Author : Mariangela Bandiera
     Creation Date : 14 September 2012
     ----
     Updates :


    ============================================================================ */

   PROCEDURE LOAD_T096_OPEN_INVOICES(PI_PROGR_H       IN NUMBER,
                         PI_SESSION_ID    IN NUMBER,
                         PO_MSG           OUT NOCOPY VARCHAR2,
                         PO_STATUS        OUT NOCOPY NUMBER ) IS

    -- -----------------------------------------
    -- Cursor on Customer Credit table T096PARTYBALANCE
    -- -----------------------------------------
    CURSOR CL_XIN_T096 IS
      SELECT
       DISTINCT *
        FROM  XIN_T096PARTYBALANCE
        WHERE SM1_CODPROCESS = PI_PROGR_H
        ORDER BY SM1_DTECRE;

    --
    VL_MESSAGE_H   VARCHAR2(4000) := 'Error while loading open invoices T096';
    VL_MESSAGE_D   VARCHAR2(4000) := NULL;
    --
    VL_PROGR_D_T096    NUMBER := 0;
    VL_COUNT_XIN_T096  NUMBER := 0;
    VL_INS_T096        NUMBER := 0;
    --
    REC_T096 T096PARTYBALANCE%ROWTYPE    := NULL;
      --
    REC_T096_INIT T096PARTYBALANCE%ROWTYPE    := NULL;
    --
    VL_DES_T096     X_FIELD_INFO_ARRAY;-- Array with fields lengths
    --
    VL_STATUS NUMBER:= 0;
    VL_COUNT  NUMBER:= 0;
    VL_STEP   NUMBER:= 0; -- Used to ping t035
    --
    EX_EXIT  EXCEPTION;
    --
    VL_CODDIV VARCHAR2(30) := NULL;

  BEGIN

    -- init indexes and rebuild statistics
    P_XIN_INIT_INDEXES (PI_PROGR_H, 'T096PARTYBALANCE');
    -- clean log
    P_XIN_CLEANUP_LOG (PI_PROGR_H, 'T096PARTYBALANCE');
    --

    VL_PROGR_D_T096 := PKG_UTILS.LOG_NEW_DETAIL(PI_PROGR_H,
                                                'OPEN INVOICES',
                                                'IMPORT --> T096PARTYBALANCE',
                                                 0,
                                                 NULL);




    BEGIN
        --
        -- ----------------------------------------------------------
        -- Init arrays with FIELD_NAME=LENGTH and FIELDNAME=SM1_DEFAULT for all fields of table
        -- ----------------------------------------------------------
        VL_DES_T096.DELETE;
        P_INIT_SM1_FIELD_ARRAY ('T096PARTYBALANCE',VL_DES_T096,VL_STATUS, VL_MESSAGE_H);
        execute immediate ( GL_INIT_REC) INTO REC_T096_INIT;

        IF (VL_STATUS <> 0 ) THEN
            VL_MESSAGE_D := GL_INIT_REC;
            RAISE EX_EXIT;
        END IF;
    EXCEPTION WHEN OTHERS THEN
        VL_MESSAGE_D := GL_INIT_REC;
        RAISE EX_EXIT;
    END;

    -- --------------------------------------------------------------
    -- Identifies Xin records to be loaded
    -- --------------------------------------------------------------
    BEGIN
        VL_MESSAGE_D := 'XIN_T096PARTYBALANCE';
        UPDATE XIN_T096PARTYBALANCE
        SET SM1_CODPROCESS = PI_PROGR_H,
            SM1_STATUS = 0,
            SM1_DTEPROCESS = XSYSDATE
            WHERE SM1_CODPROCESS = C_SM1_NULL_CODPROCESS;

        VL_COUNT_XIN_T096 := SQL%ROWCOUNT;

    COMMIT;
    EXCEPTION WHEN OTHERS THEN
      ROLLBACK;
      VL_MESSAGE_H := 'Error while Reading Staging area: '||VL_MESSAGE_D;
      RAISE EX_EXIT;

    END;

  IF (VL_COUNT_XIN_T096 > 0) THEN   -- vikas , truncate only if new records are present
    VL_MESSAGE_D := 'truncate T096PARTYBALANCE ';
    EXECUTE IMMEDIATE('TRUNCATE TABLE T096PARTYBALANCE');
  END IF;

    -- --------------------------------------------------------------
    -- loop in main table T096PARTYBALANCE
    -- --------------------------------------------------------------
    FOR RL_XIN_T096 IN CL_XIN_T096 LOOP
        -- pings to t035 every 1000 cicles--
      VL_STEP := VL_STEP + 1;
      IF ( MOD(VL_STEP, 1000) = 0 ) THEN
         PKG_UTILS.user_ping(PI_SESSION_ID);
      END IF;

      VL_MESSAGE_H :=   'Customer : '||RL_XIN_T096.CODPARTY||' '||
                        'Division : '||RL_XIN_T096.CODDIV||' '||
                        'Document number : '||RL_XIN_T096.NUMDOC||' '||
                        'Document type : '||RL_XIN_T096.CODTYPDOC;
      --
      VL_STATUS := 0;
      BEGIN --- HEAD T096
       -- Data Format Check
        VL_MESSAGE_D := 'Format Conversion ';
        VL_CODDIV:= RL_XIN_T096.CODDIV;
        REC_T096.CODTYPDOC := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T096.CODTYPDOC,'CODTYPDOC', VL_DES_T096,VL_STATUS, VL_MESSAGE_D);
        REC_T096.NUMDOC := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T096.NUMDOC,'NUMDOC', VL_DES_T096,VL_STATUS, VL_MESSAGE_D);
        REC_T096.DTEDOC :=F_CHECK_FORMAT_D( VL_CODDIV,   RL_XIN_T096.DTEDOC,'DTEDOC', VL_DES_T096,VL_STATUS, VL_MESSAGE_D);
        REC_T096.NUMROWBAL := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T096.NUMROWBAL,'NUMROWBAL', VL_DES_T096,VL_STATUS, VL_MESSAGE_D);
        REC_T096.CODUSR := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T096.CODUSR,'CODUSR', VL_DES_T096,VL_STATUS, VL_MESSAGE_D);
        REC_T096.CODPARTY := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T096.CODPARTY,'CODPARTY', VL_DES_T096,VL_STATUS, VL_MESSAGE_D);
        REC_T096.CODDIV := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T096.CODDIV,'CODDIV', VL_DES_T096,VL_STATUS, VL_MESSAGE_D);
        REC_T096.DTEEXPIRE := F_CHECK_FORMAT_D( VL_CODDIV,   RL_XIN_T096.DTEEXPIRE,'DTEEXPIRE', VL_DES_T096,VL_STATUS, VL_MESSAGE_D);
        REC_T096.VALDOCNAT := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T096.VALDOCNAT,'VALDOCNAT', VL_DES_T096,VL_STATUS, VL_MESSAGE_D);
        REC_T096.VALRATENAT := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T096.VALRATENAT,'VALRATENAT', VL_DES_T096,VL_STATUS, VL_MESSAGE_D);
        REC_T096.VALDOCEUR := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T096.VALDOCEUR,'VALDOCEUR', VL_DES_T096,VL_STATUS, VL_MESSAGE_D);
        REC_T096.CODCURORIG := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T096.CODCURORIG,'CODCURORIG', VL_DES_T096,VL_STATUS, VL_MESSAGE_D);
        REC_T096.CODPAYMOD := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T096.CODPAYMOD,'CODPAYMOD', VL_DES_T096,VL_STATUS, VL_MESSAGE_D);
        REC_T096.VALRATEEUR := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T096.VALRATEEUR,'VALRATEEUR', VL_DES_T096,VL_STATUS, VL_MESSAGE_D);
        REC_T096.CODPAYTRM := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T096.CODPAYTRM,'CODPAYTRM', VL_DES_T096,VL_STATUS, VL_MESSAGE_D);
        REC_T096.DTEPROMPT := F_CHECK_FORMAT_D( VL_CODDIV,   RL_XIN_T096.DTEPROMPT,'DTEPROMPT', VL_DES_T096,VL_STATUS, VL_MESSAGE_D);
        REC_T096.DESPROMPT := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T096.DESPROMPT,'DESPROMPT', VL_DES_T096,VL_STATUS, VL_MESSAGE_D);
        REC_T096.CODTYPBAL := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T096.CODTYPBAL,'CODTYPBAL', VL_DES_T096,VL_STATUS, VL_MESSAGE_D);
        REC_T096.NUMDOC2 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T096.NUMDOC2,'NUMDOC2', VL_DES_T096,VL_STATUS, VL_MESSAGE_D);
        REC_T096.SALDO := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T096.SALDO,'SALDO', VL_DES_T096,VL_STATUS, VL_MESSAGE_D);
        REC_T096.Flginfullpay := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T096.Flginfullpay,'FLGINFULLPAY', VL_DES_T096,VL_STATUS, VL_MESSAGE_D);


        --- Technical fields
        REC_T096.DTEMOD     := XSYSDATE;
      -- Check Customer Existence
        VL_COUNT := 0;

        select count(*) into VL_COUNT from T041PARTYDIV WHERE TRIM(CODCATDIV1) = REC_T096.CODPARTY AND CODDIV = REC_T096.CODDIV ;

        IF VL_COUNT = 0 THEN
           VL_MESSAGE_D := 'Customer does not exist  ';
           VL_STATUS := -1;
       ELSE
           select CODPARTY into REC_T096.CODPARTY from T041PARTYDIV WHERE TRIM(CODCATDIV1) = REC_T096.CODPARTY AND CODDIV = REC_T096.CODDIV ;

        END IF;

        IF (VL_STATUS <> 0 ) THEN

             VL_MESSAGE_H := SUBSTR(VL_MESSAGE_H||' '||VL_MESSAGE_D||' '||dbms_utility.format_error_backtrace() || ' ' || SQLERRM,1,4000);

             PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                           VL_PROGR_D_T096,
                                           SQLCODE,
                                           VL_MESSAGE_H);
        END IF;



        IF (VL_STATUS = 0 ) THEN


              VL_MESSAGE_D := 'Insert T096PARTYBALANCE ';
              -- Record does not exists, we insert it
              INSERT INTO T096PARTYBALANCE VALUES REC_T096;

                 VL_INS_T096 := VL_INS_T096 + 1;

        END IF; -- Record has been inserted

        EXCEPTION WHEN DUP_VAL_ON_INDEX THEN
           -- it could happen to have double records on staging area
           NULL;
        WHEN OTHERS THEN
             VL_STATUS := -1;
             VL_MESSAGE_H := SUBSTR(VL_MESSAGE_H||' '||VL_MESSAGE_D||' '||dbms_utility.format_error_backtrace() || ' ' || SQLERRM,1,4000);

             PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                           VL_PROGR_D_T096,
                                           SQLCODE,
                                           VL_MESSAGE_H);

        END; -- HEAD T096

      -- if  record have been stored with success it makes the commit
      IF VL_STATUS = 0 THEN
         COMMIT;
      ELSE
        ROLLBACK;

      UPDATE XIN_T096PARTYBALANCE
      SET  SM1_STATUS =  C_XINSTATUS_ERR
      WHERE NUMDOC    = RL_XIN_T096.NUMDOC
       AND  CODTYPDOC = RL_XIN_T096.CODTYPDOC
       AND  DTEDOC    = RL_XIN_T096.DTEDOC
       AND  NUMROWBAL = RL_XIN_T096.NUMROWBAL
       AND  SM1_CODPROCESS = PI_PROGR_H
       AND  SM1_DTECRE = RL_XIN_T096.SM1_DTECRE
       AND  SM1_STATUS = C_XINSTATUS_OK;

       VL_STATUS := 0;
       COMMIT;
       END IF;



    END LOOP;  -- T096PARTYBALANCE


    -- Moves records from staging area to log staging area
    P_XIN_MOVE_TO_LOG(PI_PROGR_H, VL_PROGR_D_T096,'T096PARTYBALANCE');

   -- Close Logs
    PKG_UTILS.LOG_END_DETAIL(PI_PROGR_H,
                             VL_PROGR_D_T096,
                             0,
                             VL_COUNT_XIN_T096,
                             VL_INS_T096,
                             VL_COUNT_XIN_T096 - VL_INS_T096);


    PO_MSG    := VL_INS_T096||'/'||VL_COUNT_XIN_T096||' Open invoices loaded';
    PO_STATUS := VL_INS_T096;


    --
  EXCEPTION WHEN EX_EXIT THEN

          ROLLBACK;
          VL_MESSAGE_H       := VL_MESSAGE_H || TRIM(SUBSTR(dbms_utility.format_error_backtrace() || ' ' || SQLERRM, 1, 255));
          PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                         VL_PROGR_D_T096,
                                         SQLCODE,
                                         VL_MESSAGE_H);

          PO_MSG := VL_MESSAGE_H;
          PO_STATUS := -1;

   WHEN OTHERS THEN

          ROLLBACK;
          -- Moves records from staging area to log staging area
          P_XIN_MOVE_TO_LOG(PI_PROGR_H, VL_PROGR_D_T096,'T096PARTYBALANCE');

          VL_MESSAGE_H       := VL_MESSAGE_H || TRIM(SUBSTR(dbms_utility.format_error_backtrace() || ' ' || SQLERRM, 1, 255));
          PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                         VL_PROGR_D_T096,
                                         SQLCODE,
                                         VL_MESSAGE_H);

          PO_MSG := VL_MESSAGE_H;
          PO_STATUS := VL_STATUS;

  END LOAD_T096_OPEN_INVOICES;

 -- ------------------------------------------------------------------------------------------
 -- LOAD_T10X_CONF_STEP0
 -- ------------------------------------------------------------------------------------------
 --    Fills global array gl_st_T100 with configuration on How the Order Head status shall be determined
 --    by order rows status
 --    The configuration is in table T906TABROWSX_INT[T100_CODSTATUS]
 --    T906.CODSYS = order division (t100.coddiv)
 --    T906.CODTAB = 'T100_CODSTATUS'
 --    T906.CODTABROW = Order Head Status ( values from T906TABROWSX[ORDST]
 --    T906.FLGANN = 0 (valid)
 --    T906.OPTINFO = <Rows status composition> to determine the Head status
 --                   in format 110X01
 --                   where each position refers to a row status ( select  T906TABROWSX[ROWST] ordered by code ascending  )
 --                   first position is the first ROW code retrieved by

 --          <ROW SELECT >
 --                     select codtabrow
 --                       from t906tabrowx
 --                       where codsys = <division>
 --                         and codtab = 'ROWST'
 --                         and flgann = 0
 --                      order by codtabrow asc;
 --         <END ROW SELECT>

 --                   and the values (1,0,X) means:
 --                   1 = at least one rows with this status should be in the order to determine order head status
 --                   0 = no rows of this status shall be in the order to determine order head status
 --                   X = this row status is not relevant to determine the order head status
 --
 -- The Final Array is and array like the following :
 --     [E001-1] = "1000X"
 --     [E001-9] = "00001"
 --     [I001-1] = "10000"
 --     [I001-9] = "0000X"

 -- where frist row  [E001-1] = "1000X" means that the order Head status 1(valid) in the division 'E001'
 --     is determined by the rows status in the following way:
 --                        at least 1 row shall be in status  ( first row status in the <ROW SELECT>
 --                        no rows allowed to have status ( second/third/fourth status in the <ROW SELECT> )
 --                        no matter if there are rows in status ( fifth status in the <ROW SELECT> )
  -- where third row  [I001-1] = "10000" means that the order Head status 1(valid) in the division 'I001'
 --     is determined by the rows status in the following way:
 --                        at least 1 row shall be in status  ( first row status in the <ROW SELECT>
 --                        no rows allowed to have status ( second/third/fourth/fifth status in the <ROW SELECT> )
 -- ------------------------------------------------------------------------------------------
  PROCEDURE LOAD_T10X_CONF_STEP0( PO_MSG           OUT NOCOPY VARCHAR2,
                                  PO_STATUS        OUT NOCOPY NUMBER ) IS


   cursor cl_T100_status is
   select codtabrow as t100_status, codsys
   from t906tabrowsx_int
   where
   codtab= 'T100_CODSTATUS' and
   flgann= 0
   order by codsys, codtabrow;

   cursor cl_T106_status(CI_CODSYS varchar2) is
   select codtabrow as t106_status
   from t906tabrowsx
   where
   codtab = 'REFDAT|T100_CODSTATUS' and
   codsys = CI_CODSYS and
   flgann= 0
   order by codtabrow;

   vl_str_t106 varchar2(50);
   vl_ins number;
   BEGIN
     PO_STATUS :=0;

    --
    -- Load all parameters ??????FROM WHERE???????????????
    --
   ---- Order Status
  GL_STORD_ANN_BY_ERP      := '9'; -- Order Head Cancelled by ERP
  GL_STORD_SENT_TO_ERP     := '2'; -- Order Head sent from  SM1 to ERP
  GL_STORD_RECEIVED_BY_ERP := '3'; -- Order Head received by ERP
  GL_STORD_NOT_UPDATABLE   := '6'; -- Order Head no more updatable by ERP
  GL_STROW_NOT_UPDATABLE   := '6'; -- Order Row no more updatable by ERP
  GL_STROW_ANN             := '4'; -- Order Row Cancelled by SM1
  GL_STROW_CANC            := '3'; -- Order Row Cancelled by SM1
  --
  GL_ERP_USERS  := pkg_utils.get_optinfo_ext_as_string('ALL',
                                                       'T100_CODUSR_ERP',
                                                       'USERS',
                                                       'USERS');
                                                        -- Order recognized ERP users T100_CODUSR_ERP
  --
   ---- --------------------------------------
   ---- retrieve t100  configuration
   ----- -------------------------------------



   -- -------------------------------------------------------------------------------
   -- T100_CODSTATUS --> how Order Head Status is determided by Order Detail Status
   -- -------------------------------------------------------------------------------
   gl_st_T100.delete;
   vl_ins := 0;

   -- create Order Head Status from Order Details status
   for rl_t100 in cl_t100_status loop
      vl_str_t106 := NULL;
      VLMSGERRORDATA := NULL;
      VLMSGERRORDATA_0 :=0;
      for rl_t106 in cl_t106_status ( rl_t100.codsys ) loop


       VLMSGERRORDATA := '/'  ||  rl_t100.codsys ||   rl_t100.t100_status || rl_t106.t106_status ;
    VLMSGERRORDATA_0:=VLMSGERRORDATA_0+1;
         vl_str_t106 := vl_str_t106||
         PKG_UTILS.get_optinfo_ext_as_string(vl_coddiv    => rl_t100.codsys,
                                             vl_codtab    => 'T100_CODSTATUS' ,
                                             vl_codtabrow => rl_t100.t100_status,
                                             vl_colname   => rl_t106.t106_status);

       end loop;


      if vl_Str_T106 is not null then
         gl_st_T100(rl_t100.codsys||'-'||rl_t100.t100_status):= vl_str_t106;
         vl_ins := vl_ins + 1;
       end if;
   end loop;
   -- end T100_CODSTATUS
   -- -------------------------------------------------------------------------------




   if vl_ins = 0 then
       po_msg :=  ' x_No Configuration found T100_CODSTATUS ' ;
       po_status := -1;
   end if;

   EXCEPTION WHEN OTHERS THEN
       po_msg :=DBMS_UTILITY.FORMAT_ERROR_BACKTRACE() || '--' || VLMSGERRORDATA || ' ' ||TO_CHAR(VLMSGERRORDATA_0) || 'x_Error while retrieveing Configuration T100_CODSTATUS '||sqlerrm;
       po_status := -1;
   END;

 -- -----------------------------------------------------------------------
 -- LOAD_T10X_HEAD_STEP1_KD  --mady create new procedure  change numordcust --> numordref 27/02/2019 
  -- -----------------------------------------------------------------------
 -- Recognizes SM1 Order starting with ERP number
 -- Inserts New orders
 -- Some Checks beteween the order on XIN table and the order on SM1 some data cannot
 -- be updated by ERP:
 --   division
 --   delivery point
 --   order date
 --   Only already sent to ERP orders can be updated by ERP
 --   Totally invoiced orders cannot be updated by ERP anymore
 -- -----------------------------------------------------------------------
 PROCEDURE LOAD_T10X_HEAD_STEP1_KD(PI_PROGR_H       IN NUMBER,
                                PI_PROGR_D       IN NUMBER,
                                PI_REC_T100      IN OUT T100ORDHEAD%ROWTYPE,
                                PO_STATUS        OUT NOCOPY NUMBER ) IS

   vl_numord       t100ordhead.numord%type;
   vl_coddiv       t100ordhead.coddiv%type;
   vl_codstatus    t100ordhead.codstatus%type;
   vl_dtetohost    t100ordhead.dtetohost%type;
   vl_codcustdeliv t100ordhead.codcustdeliv%type;
   vl_dteord       t100ordhead.dteord%type;
   --
   vl_msg       varchar2(4000);
   vl_ins_upd varchar2(3);
   --
   EX_EXIT EXCEPTION;
   BEGIN
   PO_STATUS :=0;
      -- checks if there are enough information to recognize the order
      if  ( nvl(PI_REC_T100.NUMORDHOST, '0') <> '0' AND nvl(PI_REC_T100.CODUSR, '0') <> '0' )

      then
          --
          -- 1. Looks for Order with NUMORDHOST -- we should find it when this is not the
          --    first time the order comes back from ERP.
          BEGIN
            select t100.numord, t100.coddiv, t100.codstatus, t100.dtetohost, t100.codcustdeliv, t100.dteord
            into   vl_numord, vl_coddiv, vl_codstatus, vl_dtetohost, vl_codcustdeliv, vl_dteord
            from T100ORDHEAD t100
            where t100.numordhost = nvl(PI_REC_T100.numordhost, '0')
            --AND t100.numord = PI_REC_T100.Numord --add by mady to take just the numord selected..
            AND NVL(t100.numordhost,'0')<>'0' -- Added by Fowza
              and t100.codusr     = PI_REC_T100.codusr;

              INSERT INTO TB_TEST VALUES (vl_numord ,vl_dtetohost , PI_REC_T100.Numord );
              INSERT INTO TB_TEST VALUES (vl_numord||'MADY' ,vl_codstatus , PI_REC_T100.CODSTATUS );
              COMMIT;
            vl_ins_upd := 'UPD';
          EXCEPTION WHEN NO_DATA_FOUND THEN
            BEGIN
               -- 2. Looks for Order with NUMORDREF -- we should find it when this is
               --    the first time we load it
              select t100.numord, t100.codusr, t100.coddiv, t100.codstatus, t100.dtetohost, t100.codcustdeliv, t100.dteord
              into   vl_numord, PI_REC_T100.CODUSR, vl_coddiv, vl_codstatus, vl_dtetohost, vl_codcustdeliv, vl_dteord
             from T100ORDHEAD t100
                --WHERE T100.NUMORD = PI_REC_T100.NUMORD --add by mady to take just the numord selected..
                WHERE  ( t100.numordref = nvl(PI_REC_T100.numordref, 0)
			                  	or t100.numordcust = nvl(PI_REC_T100.numordcust, 0) );
               --t100.numordref = nvl(PI_REC_T100.numordref, 0); -- modify by MADY 03/04/2019
              -- where  t100.numordcust = nvl(PI_REC_T100.numordcust, 0);  -- commected by MADY 27/02/2019
               INSERT INTO TB_TEST VALUES (vl_numord ,vl_codstatus , PI_REC_T100.CODSTATUS );
              COMMIT;
              
               vl_ins_upd := 'UPD';
            EXCEPTION WHEN NO_DATA_FOUND THEN

               --3. Order not found, we need to insert it new
               --  we mark it as new, but we do not retrieve the NUMORD here
               --  because we will increment the progressive number only at the very end
               --  of the process where we we'll sure to save it.
               PI_REC_T100.DTETOHOST := xsysdate; --COMMENT BY MADY 27/02/2019
			   --PI_REC_T100.DTETOHOST := vl_dtetohost; ADDED BY MADY 27/02/2019
               begin
                   vl_ins_upd := 'INS';
           
          
                   -- Retrieves Order number
                   select t.numprg + 1 into vl_numord
                   from t011prg t
                   where t.codprg ='NUMORD_ERP';

                   update t011prg t set t.numprg = t.numprg + 1
                   where t.codprg ='NUMORD_ERP';

                   PI_REC_T100.CODUSR := UPPER(PI_REC_T100.CODUSR);
                   -- set order number as YY0000### where YY last 2 year digits
                   --                                     0000### number zero left padded to 7 digits
                   PI_REC_T100.NUMORD := to_number(to_char(sysdate, 'YY')||lpad(vl_numord,7,'0'));
                   PI_REC_T100.DOCUMENTKEY := PKG_UTILS.documentkey_for_t100(PI_REC_T100.NUMORD ,PI_REC_T100.CODUSR);

                     -- Checks if USER is ERP user
                    if ( instr(GL_ERP_USERS,'|'||PI_REC_T100.codusr||'|' ) <= 0 ) then
                       vl_msg := 'Order '||vl_numord||'. '||PI_REC_T100.codusr||' is not a recognized ERP user. Check Config T100_ERP_USER';
                       raise EX_EXIT;
                    end if;

                   -- Retrieves Delivery Point info: codEusr, ...
                   begin

                      select T041.codusr1 into PI_REC_T100.codEusr
                      from   T041partydiv T041
                      where  T041.codparty = PI_REC_T100.codcustDeliv
                        and  T041.coddiv   = PI_REC_T100.codDiv;

                   exception when others
                     then
                       -- logs the anomaly, but does not stop loading the order
                        vl_msg := 'Unknown CodCustDeliv '||PI_REC_T100.codcustDeliv||', Division: '||PI_REC_T100.codDiv;
                        vl_msg := 'Order '||PI_REC_T100.numordhost||'/'||PI_REC_T100.numord||'/'||PI_REC_T100.codusr||' '||vl_msg;


                        PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                      PI_PROGR_D,
                                      SQLCODE,
                                      vl_msg);
                   end;

                   begin
                     --ADD BY MADY 20200311
                       PI_REC_T100.FLGPROCESSEDASSET := 0;   
                                  
                     INSERT INTO T100ORDHEAD VALUES PI_REC_T100;
                   exception when others then
                        vl_msg := 'Error on New Order inserting '||vl_numord||'. '||PI_REC_T100.codusr||' '||SQLERRM;
            
             dbms_output.put_line('INSERT __   ' || SQLERRM);
            
                        raise EX_EXIT;
                   end;

               exception when others then
          dbms_output.put_line('VL_MSG='  || vl_msg);
                  vl_msg := 'Error while retrieving T011 NUMORD_ERP. '||SQLERRM;
          dbms_output.put_line('1'  || SQLERRM);
                  po_status := -1;
               end;


            END;


         WHEN OTHERS THEN
             vl_msg    := sqlerrm;
        dbms_output.put_line('2'  || vl_msg);
             po_status := -1;
          END;
     else
        vl_msg := 'Not enough information to find the order';
        Raise ex_exit;

     end if;

     -- checks if the order can be updated
     if  vl_ins_upd = 'UPD' then

        -- order has been exported to ERP
        if nvl(vl_dtetohost, C_SM1_NULL_DATE ) = C_SM1_NULL_DATE then
           vl_msg := 'Order '||vl_numord||'/'||PI_REC_T100.codusr||' has not been sent to ERP';
           raise EX_EXIT;
        end if;

        -- order has not the same division
        if vl_coddiv <> nvl(PI_REC_T100.coddiv, '@') then
           vl_msg := 'Order '||vl_numord||'/'||PI_REC_T100.codusr||' division mismatch, T100: '||vl_coddiv||'- XIN_T100: '|| nvl(PI_REC_T100.coddiv, '@');
           raise EX_EXIT;
        end if;
        /*
        -- order has not the same order date
        if trunc(vl_dteord) <> trunc(nvl(PI_REC_T100.dteord, C_SM1_NULL_DATE)) then
          insert into tb_test VALUES(PI_REC_T100.Numord , vl_dteord , PI_REC_T100.dteord);
          COMMIT;
           vl_msg := 'Order '||vl_numord||'/'||PI_REC_T100.codusr||' Order Date mismatch';
           
           raise EX_EXIT;
        end if;
        */
        /*
          if vl_dteord <> nvl(PI_REC_T100.dteord, C_SM1_NULL_DATE) then
           vl_msg := 'Order '||vl_numord||'/'||PI_REC_T100.codusr||' Order Date mismatch';
           raise EX_EXIT;
        end if; */

         -- order has not the same deliverypoint
        if vl_codcustdeliv <> nvl(PI_REC_T100.codcustdeliv, '@') then
           vl_msg := 'Order '||vl_numord||'/'||PI_REC_T100.codusr||' Delivery Point mismatch, T100: '||vl_codcustdeliv||'- XIN_T100: '|| nvl(PI_REC_T100.codcustdeliv, '@');
           raise EX_EXIT;
        end if;



        -- order has a "Not Updatable" status
        if vl_codstatus = GL_STORD_NOT_UPDATABLE  then
           vl_msg := 'Order '||vl_numord||'/'||PI_REC_T100.codusr||' cannot be updated-status: '||vl_codstatus;
           raise EX_EXIT;
        end if;


     end if;



   EXCEPTION WHEN
     EX_EXIT THEN
       po_status := -1;
       vl_msg := 'Order '||PI_REC_T100.numordhost||'/'||PI_REC_T100.numord||'/'||PI_REC_T100.codusr||' '||vl_msg;
       vl_msg := SUBSTR(vl_msg||' '||dbms_utility.format_error_backtrace() || ' ' || SQLERRM,1,4000);
       dbms_output.put_line('3' || vl_msg);

       PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                      PI_PROGR_D,
                                      SQLCODE,
                                      vl_msg);
   WHEN OTHERS THEN
       vl_msg := 'Order '||PI_REC_T100.numordhost||'/'||PI_REC_T100.numord||'/'||PI_REC_T100.codusr||' Unhandled exception '||sqlerrm;
      dbms_output.put_line('4'  || vl_msg);
       po_status := -1;
      PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                    PI_PROGR_D,
                                    SQLCODE,
                                    vl_msg);
   END;

 -- -----------------------------------------------------------------------
 -- LOAD_T10X_HEAD_STEP1
  -- -----------------------------------------------------------------------
 -- Recognizes SM1 Order starting with ERP number
 -- Inserts New orders
 -- Some Checks beteween the order on XIN table and the order on SM1 some data cannot
 -- be updated by ERP:
 --   division
 --   delivery point
 --   order date
 --   Only already sent to ERP orders can be updated by ERP
 --   Totally invoiced orders cannot be updated by ERP anymore
 -- -----------------------------------------------------------------------
  
 PROCEDURE LOAD_T10X_HEAD_STEP1(PI_PROGR_H       IN NUMBER,
                                PI_PROGR_D       IN NUMBER,
                                PI_REC_T100      IN OUT T100ORDHEAD%ROWTYPE,
                                PO_STATUS        OUT NOCOPY NUMBER ) IS

   vl_numord       t100ordhead.numord%type;
   vl_coddiv       t100ordhead.coddiv%type;
   vl_codstatus    t100ordhead.codstatus%type;
   vl_dtetohost    t100ordhead.dtetohost%type;
   vl_codcustdeliv t100ordhead.codcustdeliv%type;
   vl_dteord       t100ordhead.dteord%type;
   --
   vl_msg       varchar2(4000);
   vl_ins_upd varchar2(3);
   --
   EX_EXIT EXCEPTION;
   BEGIN
   PO_STATUS :=0;
      -- checks if there are enough information to recognize the order
      if  ( nvl(PI_REC_T100.NUMORDHOST, '0') <> '0' AND nvl(PI_REC_T100.CODUSR, '0') <> '0' )

      then
          --
          -- 1. Looks for Order with NUMORDHOST -- we should find it when this is not the
          --    first time the order comes back from ERP.
          BEGIN
       dbms_output.put_line('LINE 27  ' || SQLERRM);
            select t100.numord, t100.coddiv, t100.codstatus, t100.dtetohost, t100.codcustdeliv, t100.dteord
            into   vl_numord, vl_coddiv, vl_codstatus, vl_dtetohost, vl_codcustdeliv, vl_dteord
            from T100ORDHEAD t100
            where t100.numordhost = nvl(PI_REC_T100.numordhost, '0')
            AND NVL(t100.numordhost,'0')<>'0' -- Added by Fowza
              and t100.codusr     = PI_REC_T100.codusr;
       dbms_output.put_line('LINE 34  ' || SQLERRM);
            vl_ins_upd := 'UPD';
          EXCEPTION WHEN NO_DATA_FOUND THEN
            BEGIN
       dbms_output.put_line('LINE 38  ' || SQLERRM);      
               -- 2. Looks for Order with NUMORDREF -- we should find it when this is
               --    the first time we load it
              select t100.numord, t100.codusr, t100.coddiv, t100.codstatus, t100.dtetohost, t100.codcustdeliv, t100.dteord
              into   vl_numord, PI_REC_T100.CODUSR, vl_coddiv, vl_codstatus, vl_dtetohost, vl_codcustdeliv, vl_dteord
             from T100ORDHEAD t100
              -- where  t100.numordref = nvl(PI_REC_T100.numordref, 0);
               where  t100.numordcust = nvl(PI_REC_T100.numordcust, 0); -- added by Fowza
               --where  t100.numord = nvl(PI_REC_T100.numord, 0);
       --dbms_output.put_line('LINE 46  ' || SQLERRM);         
               vl_ins_upd := 'UPD';
            EXCEPTION WHEN NO_DATA_FOUND THEN

               --3. Order not found, we need to insert it new
               --  we mark it as new, but we do not retrieve the NUMORD here
               --  because we will increment the progressive number only at the very end
               --  of the process where we we'll sure to save it.
               PI_REC_T100.DTETOHOST := xsysdate;
               begin
                   vl_ins_upd := 'INS';
           
          
                   -- Retrieves Order number
                   select t.numprg + 1 into vl_numord
                   from t011prg t
                   where t.codprg ='NUMORD_ERP';

                   update t011prg t set t.numprg = t.numprg + 1
                   where t.codprg ='NUMORD_ERP';

                   PI_REC_T100.CODUSR := UPPER(PI_REC_T100.CODUSR);
                   -- set order number as YY0000### where YY last 2 year digits
                   --                                     0000### number zero left padded to 7 digits
                   PI_REC_T100.NUMORD := to_number(to_char(sysdate, 'YY')||lpad(vl_numord,7,'0'));
                   PI_REC_T100.DOCUMENTKEY := PKG_UTILS.documentkey_for_t100(PI_REC_T100.NUMORD ,PI_REC_T100.CODUSR);

                     -- Checks if USER is ERP user
                    if ( instr(GL_ERP_USERS,'|'||PI_REC_T100.codusr||'|' ) <= 0 ) then
                       vl_msg := 'Order '||vl_numord||'. '||PI_REC_T100.codusr||' is not a recognized ERP user. Check Config T100_ERP_USER';
                       raise EX_EXIT;
                    end if;

                   -- Retrieves Delivery Point info: codEusr, ...
                   begin

                      select T041.codusr1 into PI_REC_T100.codEusr
                      from   T041partydiv T041
                      where  T041.codparty = PI_REC_T100.codcustDeliv
                        and  T041.coddiv   = PI_REC_T100.codDiv;

                   exception when others
                     then
                       -- logs the anomaly, but does not stop loading the order
                        vl_msg := 'Unknown CodCustDeliv '||PI_REC_T100.codcustDeliv||', Division: '||PI_REC_T100.codDiv;
                        vl_msg := 'Order '||PI_REC_T100.numordhost||'/'||PI_REC_T100.numord||'/'||PI_REC_T100.codusr||' '||vl_msg;


                        PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                      PI_PROGR_D,
                                      SQLCODE,
                                      vl_msg);
                   end;

                   begin
                     --ADD Y MADY 20200311
                      PI_REC_T100.FLGPROCESSEDASSET := 0;  
                                                                                                                     
                     INSERT INTO T100ORDHEAD VALUES PI_REC_T100;
                   exception when others then
                        vl_msg := 'Error on New Order inserting '||vl_numord||'. '||PI_REC_T100.codusr||' '||SQLERRM;
            
             dbms_output.put_line('INSERT __   ' || SQLERRM);
            
                        raise EX_EXIT;
                   end;

               exception when others then
          dbms_output.put_line('VL_MSG='  || vl_msg);
                  vl_msg := 'Error while retrieving T011 NUMORD_ERP. '||SQLERRM;
          dbms_output.put_line('1'  || SQLERRM);
                  po_status := -1;
               end;


            END;


         WHEN OTHERS THEN
             vl_msg    := sqlerrm;
        dbms_output.put_line('2'  || vl_msg);
             po_status := -1;
          END;
     else
        vl_msg := 'Not enough information to find the order';
        Raise ex_exit;

     end if;

     -- checks if the order can be updated
     if  vl_ins_upd = 'UPD' then

        -- order has been exported to ERP
     --   if nvl(vl_dtetohost, C_SM1_NULL_DATE ) = C_SM1_NULL_DATE then
     --      vl_msg := 'Order '||vl_numord||'/'||PI_REC_T100.codusr||' has not been sent to ERP';
     --      raise EX_EXIT;
     --   end if;  commented by vikas , DDF uploader will not have dtetohost set in SM1 order

        -- order has not the same division
        if vl_coddiv <> nvl(PI_REC_T100.coddiv, '@') then
           vl_msg := 'Order '||vl_numord||'/'||PI_REC_T100.codusr||' division mismatch, T100: '||vl_coddiv||'- XIN_T100: '|| nvl(PI_REC_T100.coddiv, '@');
           raise EX_EXIT;
        end if;

        -- order has not the same order date
        if trunc(vl_dteord) <> trunc(nvl(PI_REC_T100.dteord, C_SM1_NULL_DATE)) then
           vl_msg := 'Order '||vl_numord||'/'||PI_REC_T100.codusr||' Order Date mismatch';
           raise EX_EXIT;
        end if;
        /*
          if vl_dteord <> nvl(PI_REC_T100.dteord, C_SM1_NULL_DATE) then
           vl_msg := 'Order '||vl_numord||'/'||PI_REC_T100.codusr||' Order Date mismatch';
           raise EX_EXIT;
        end if; */

         -- order has not the same deliverypoint
        if vl_codcustdeliv <> nvl(PI_REC_T100.codcustdeliv, '@') then
           vl_msg := 'Order '||vl_numord||'/'||PI_REC_T100.codusr||' Delivery Point mismatch, T100: '||vl_codcustdeliv||'- XIN_T100: '|| nvl(PI_REC_T100.codcustdeliv, '@');
           raise EX_EXIT;
        end if;



        -- order has a "Not Updatable" status
        if vl_codstatus = GL_STORD_NOT_UPDATABLE  then
           vl_msg := 'Order '||vl_numord||'/'||PI_REC_T100.codusr||' cannot be updated-status: '||vl_codstatus;
           raise EX_EXIT;
        end if;


     end if;



   EXCEPTION WHEN
     EX_EXIT THEN
       po_status := -1;
       vl_msg := 'Order '||PI_REC_T100.numordhost||'/'||PI_REC_T100.numord||'/'||PI_REC_T100.codusr||' '||vl_msg;
       vl_msg := SUBSTR(vl_msg||' '||dbms_utility.format_error_backtrace() || ' ' || SQLERRM,1,4000);
       dbms_output.put_line('3rd' || vl_msg);

       PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                      PI_PROGR_D,
                                      SQLCODE,
                                      vl_msg);
   WHEN OTHERS THEN
       vl_msg := 'Order '||PI_REC_T100.numordhost||'/'||PI_REC_T100.numord||'/'||PI_REC_T100.codusr||' Unhandled exception '||sqlerrm;
      dbms_output.put_line('4th'  || vl_msg);
       po_status := -1;
      PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                    PI_PROGR_D,
                                    SQLCODE,
                                    vl_msg);
   END;


 -- -----------------------------------------------------------------------
 -- LOAD_T10X_ROW_STEP2
  -- -----------------------------------------------------------------------
 -- Recognizes SM1 Order Line starting with ERP line number
 -- Inserts New orders details (added by ERP ) -- create new order line number
 -- Some Checks beteween the order LINE on XIN table and the order line on SM1 some data cannot

 -- be updated by ERP:
 --   article cannot be updated
 --   Totally invoiced orders line cannot be updated by ERP anymore
 -- -----------------------------------------------------------------------
  PROCEDURE LOAD_T10X_ROW_STEP2(PI_PROGR_H       IN NUMBER,
                                PI_PROGR_D       IN NUMBER,
                                PI_REC_T106      IN OUT T106ORDROW%ROWTYPE ,
                                PO_INS_UPD       OUT NOCOPY VARCHAR2,
                                PO_STATUS        OUT NOCOPY NUMBER ) IS

   vl_numrow     t106ordrow.numrow%type;
   vl_codstatus  t106ordrow.codstatus%type;
   vl_codart     t106ordrow.codart%type;
   vl_msg        varchar2(4000);
   ex_exit       exception;

   BEGIN
     PO_STATUS :=0;
     PO_INS_UPD := 'UPD';
      -- checks if there are enough information to recognize the order
      if ( nvl(PI_REC_T106.NUMROWHOST, '0') <> '0' or nvl(PI_REC_T106.NUMROW, 0)  <> 0 )
      then

          BEGIN

              -- 2. Looks for Order row with NUMrow -- we should find it when this is
               --    the first time we load it

                select t106.numrow, t106.codart, t106.codstatus
                into   vl_numrow, vl_codart, vl_codstatus
                from T106ORDROW t106
                where
                      t106.numord     = PI_REC_T106.numord
                  and t106.codusr     = PI_REC_T106.codusr
                  and t106.numrow     = nvl(PI_REC_T106.numrow, 0);

          EXCEPTION WHEN NO_DATA_FOUND THEN
            BEGIN

                    --
          -- 1. Looks for Order Row with NUMROWHOST -- we should find it when this is not the
          --    first time the order row comes back from ERP.

                  select t106.numrow, t106.codart, t106.codstatus
            into   vl_numrow, vl_codart, vl_codstatus
            from T106ORDROW t106
            where
                  t106.numord     = PI_REC_T106.numord
              and t106.codusr     = PI_REC_T106.codusr
              and t106.numrowhost = nvl(PI_REC_T106.numrowhost, '0');

             PI_REC_T106.numrow := vl_numrow;
            EXCEPTION WHEN NO_DATA_FOUND THEN

               -- Retrieves Product's info: desArt, ...
                 begin

                    select T060.desart into PI_REC_T106.desArt
                    from   T060article T060
                    where  T060.codart = PI_REC_T106.codArt
                      and  T060.coddiv = PI_REC_T106.codDiv;

                 exception when others
                   then
                     -- logs the anomaly, but does not stop loading the order row
                      vl_msg := 'Unknown Article '||PI_REC_T106.codArt||', Division: '||PI_REC_T106.codDiv;
                      vl_msg := 'Order '||PI_REC_T106.numord||'/'||PI_REC_T106.codusr||' '||vl_msg;


                      PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                    PI_PROGR_D,
                                    SQLCODE,
                                    vl_msg);
                 end;



               PI_REC_T106.numrow := to_number('9'||lpad(TRIM(PI_REC_T106.numrowHOST),8,'0'));
               PO_INS_UPD := 'INS';
        dbms_output.put_line('PO_INS_UPD set as ' || PO_INS_UPD || 'AND PO_STATUS = ' || PO_STATUS );
            END;

         WHEN OTHERS THEN
             vl_msg    := sqlerrm;
             raise ex_exit;
          END;
     else
        vl_msg := 'Not enough information to find the order row NUMORD/CODUSR/NUMROWHOST/NUMROW'||
                   PI_REC_T106.NUMORD||'/'||PI_REC_T106.CODUSR||'/'||PI_REC_T106.NUMROWHOST||'/'||PI_REC_T106.NUMROW;
        raise ex_exit;

     end if;

     -- checks if the order can be updated
     if  po_status = 0 and  PO_INS_UPD = 'UPD' then

        -- order has not the same article
        if vl_codart <> nvl(PI_REC_T106.codart, '@') then
           vl_msg := 'OrderRow '||PI_REC_T106.NUMORD||'/'||PI_REC_T106.codusr||'/'||PI_REC_T106.numord||'/'||PI_REC_T106.codart||' article mismatch';
            raise ex_exit;
        end if;

        if vl_codstatus = GL_STROW_NOT_UPDATABLE   then
           vl_msg := 'Order '||PI_REC_T106.NUMORD||'/'||PI_REC_T106.codusr||' cannot be updated-status: '||vl_codstatus;
           raise ex_exit;
        end if;

     end if;

   EXCEPTION WHEN ex_exit THEN
        po_status := -1;
        vl_msg := 'Order '||PI_REC_T106.numordhost||'/'||PI_REC_T106.numord||'/'||PI_REC_T106.codusr||' '||vl_msg;

        PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                      PI_PROGR_D,
                                      SQLCODE,
                                      vl_msg);
   WHEN  OTHERS THEN
       vl_msg := 'Order '||PI_REC_T106.numordhost||'/'||PI_REC_T106.numord||'/'||PI_REC_T106.codusr||' Unhandled exception '||sqlerrm;
       po_status := -1;
       PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                      PI_PROGR_D,
                                      SQLCODE,
                                      vl_msg);
   END;
 -- -----------------------------------------------------------------------
 --    PROCEDURE LOAD_T10X_HEAD_STEP3
 -- -----------------------------------------------------------------------

 -- 1  Set to GL_STROW_ANN_BY_ERP to rows no more sent by ERP
 -- ------------------------------------------------------------------------

 -- 2  Determines the Order Head Status from the existing Order Row status
 --
 -- in global array GL_ST_T100 we already loaded the configuration (see comment of LOAD_T10X_CONF_STEP0)
 -- Here for each order head it counts the numbers or row with each possible row status and compare the counts
 -- and fills local variable vl_str_t106 with the row count for each status e.g "1000"
 -- with the GL_ST_T100 to determine the order Head status allowed with these rows.
 -- ------------------------------------------------------------------------
 --
 -- 3 Calucaltes the Order Head Totals with the sum of order Lines totals
 -- -----------------------------------------------------------------------
   PROCEDURE LOAD_T10X_HEAD_STEP3(PI_PROGR_H       IN NUMBER,
                                  PI_PROGR_D       IN NUMBER,
                                  PI_REC_T100      IN OUT T100ORDHEAD%ROWTYPE ,
                                  PO_STATUS        OUT NOCOPY NUMBER ) IS


   -- for each possible row status 'ROWST' it counts for the current order Head PI_REC_T100
   -- how many rows there are for each status.
   -- it set 0 if no t106.rows with status T.codtabrow has been found
   -- it set 1 if at least one t106.row with status T.codtabrow has been found

   cursor cl_t106_status is
   select t.codtabrow as t106_Status ,

   case when count(t106.numrow) = 0 then '0' else '1' end as ispresent
   from t906tabrowsx t
   left join t106ordrow t106 ON t106.codstatus = t.codtabrow and
                                t106.coddiv    = t.codsys and
                                t106.numord    = PI_REC_T100.NUMORD and
                                t106.codusr    = PI_REC_T100.codusr
   where
   t.codsys = PI_REC_T100.CODDIV and
   t.codtab = 'ROWST' and
   t.flgann = 0
   group by t.codtabrow;

   -- list of possible order status
   cursor cl_t100_status is
   select codtabrow as t100_status
   from t906tabrowsx
   where
      codsys = PI_REC_T100.CODDIV and
      codtab = 'ORDST' and
      flgann = 0
   order by codtabrow ;

   vl_str_t106 varchar2(50);
   vl_str_t100 varchar2(50);
   vl_msg       varchar2(4000);
   --
   vl_check       number:= 1;
   vl_or_count    number:= 0;
   vl_or_flag     number:= 0;

   vl_idx   number:= 1;
   --
   ex_exit exception;
   BEGIN
    PO_STATUS :=0;
   -- 1 set to GL_STROW_ANN_BY_ERP to rows no more sent by ERP
   update t106ordrow t
   set t.codstatus = GL_STROW_ANN_BY_ERP
   where t.numord = PI_REC_T100.NUMORD
     and t.codusr = PI_REC_T100.CODUSR
     and substr(t.codstatus, 1, C_T106_STATUS_PREFIX_LEN) = C_T106_STATUS_PREFIX;

   -- 2 fill enum record vl_st_t106 with  CODSTATUS=<number of rows with this status>
   vl_str_t106 := null;
   for rl_t106 in cl_t106_status loop
       vl_str_t106 := vl_str_t106||rl_t106.ispresent;
   end loop;

   PI_REC_T100.CODSTATUS := NULL;

   -- create Order Head Status from Order Details status
   -- it compares the configuration loaded on gl_st_T100 with vl_str_t106 (the current state of T106 rows
   -- for current order)
   -- e.g if in gl_st_T100 we have "DIV-1"="100X"
   --        in vl_str_t106 we have  "1000"  then the order will be in status 1 (valid)

   for rl_t100 in cl_t100_status loop
       if PI_REC_T100.CODSTATUS is null then
          begin -- it could be not configured
           vl_str_t100 := gl_st_T100(PI_REC_T100.CODDIV||'-'||rl_t100.t100_status);

           vl_check := 1;
          exception when others then
           vl_check := 0;
          end;

           vl_idx   := 1;
           vl_or_count := 0;
           vl_or_flag  := 0;
           -- compare each bit and exit when it founds the first mismatch
           while vl_idx <= length(vl_str_t100) and vl_check = 1 loop

               case substr(vl_str_t100, vl_idx, 1)

                 when 'X' then  null; -- all values allowed
                 when '1' then  -- at least one value; it must match exactly the T106

                    if substr(vl_str_t100, vl_idx, 1) = substr(vl_str_t106, vl_idx, 1)
                      then null;
                      else vl_check := 0;
                    end if;

                when '0' then  -- no rows with this status allowed; it must match exactly the T106

                    if substr(vl_str_t100, vl_idx, 1) = substr(vl_str_t106, vl_idx, 1)
                      then null;
                      else vl_check := 0;
                    end if;


                 when 'R' then  -- 'OR' clause it at least one row should be present on the statuses marked R
                    vl_or_flag  := 1;
                    -- we keep in VL_OR it there is at least one row of one of the statuses marked with R
                    if substr(vl_str_t106, vl_idx, 1) = '1'
                      then vl_or_count := vl_or_count  + 1;
                    end if;

                 else -- not recognized match
                     vl_check := 0;
                 end case;


             vl_idx := vl_idx + 1;
           end loop;
           -- vl_or clause failed
           if  vl_check = 1 and  -- no clauses failed
               (vl_or_flag = 0  or  -- there was not OR clause
               (vl_or_flag = 1 and vl_or_count > 0) -- there was one or clause and it succeed
               )
                 then
               vl_check :=  1; --found
           else
               vl_check :=  0;
           end if;

           if vl_check = 1 then
               -- found
               PI_REC_T100.CODSTATUS := rl_t100.t100_status;
           end if;
       end if;
   end loop;

   -- 3  calculate al Totals from Order Details Status
   --
         select sum(T106.GROSSAMOUNT),
                sum(T106.NETAMOUNT),
                sum(T106.VATAMOUNT),
                sum(T106.TAXAMOUNT)
         into PI_REC_T100.GROSSAMOUNT,
              PI_REC_T100.NETAMOUNT,
              PI_REC_T100.VATAMOUNT,
              PI_REC_T100.TAXAMOUNT
         from T106ORDROW T106
        where T106.NUMORD = PI_REC_T100.NUMORD
          and T106.CODUSR = PI_REC_T100.CODUSR
          and T106.codstatus not in (GL_STROW_CANC,GL_STROW_ANN,GL_STROW_ANN_BY_ERP);


EXCEPTION WHEN
     EX_EXIT THEN
       po_status := -1;
       vl_msg := 'Order '||PI_REC_T100.numordhost||'/'||PI_REC_T100.numord||'/'||PI_REC_T100.codusr||' '||vl_msg;

       vl_msg := SUBSTR(vl_msg||' '||dbms_utility.format_error_backtrace() || ' ' || SQLERRM,1,4000);

       PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                      PI_PROGR_D,
                                      SQLCODE,
                                      vl_msg);
   WHEN OTHERS THEN
       vl_msg := 'Order '||PI_REC_T100.numordhost||'/'||PI_REC_T100.numord||'/'||PI_REC_T100.codusr||' Unhandled exception '||sqlerrm;
       po_status := -1;
      PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                    PI_PROGR_D,
                                    SQLCODE,
                                    vl_msg);
   END;

 /*
  Name: LOAD_T100_ORDERS
     Loads SM1 tables:
        • T100ORDHEAD- Order Head
        • T106ORDROW  - Order Row
        Staging Area (SSA) tables, Chronological Order expected in SSA (for each decode set):
        1.  XIN_T100ORDHEAD
        2.  XIN_T106ORDROW

        Loading logic:
         UPDATE+INSERT
         Steps:
           1- Recognize SM1 order from external order SAP/JDE/Others
               XIN_T100.NUMORDREF not null : it is a SM1 Order
               XIN_T100.NUMORDREF is null : it is an external Order
              then it must be populated:
                   XIN_T100.NUMORDHOST : order unique code from erp
                   XIN_T100.CODUSR : erp dummy user "SAP"; "JDE"; others


           2- assign new NUMORD to  external order SAP/JDE/Others ( da contatore T011 ORDPRGNUM o ORDPRGNUM_<ERP>)
           3- row matching (logically cancel the no more present  - add new rows -- determine new numrow)
           4- determine row status from quantities (backorder-delivered-cancelled)----
           5- detrmine head status from row status
           6- calculate header quantities
           7- set head final status ( no more updates allowed --e.g. totally invoiced )
           8- set all fields that can be updated and which one cannot
           9- we do not import  T101bebefit yet.
           10. we do not import NOTES yet


        Validity Checks:
        • Orders found on staging area are loaded to SM1 main tables only if they are not already opened for update by a SM1 user. In that case records remain in staging area ready to be loaded on next import run.
        • Detail Records found on XIN_T106ORDROW are loaded only if there is the head record in XIN_T100ORDHEAD.

        Error handling:
        • All Errors will be logged in T852/T854 SM1 log tables and all staging area records will be stored into staging area log with sm1_status = 9.
        • Error on head record,  it is discarded with all its details.
        • Error on detail record, it is discarded and import procedure skips to next detail.

        How to delete
        • You cannot delete an order by  ERP interface, you can set it to CANCELLED status

     Input parameters :     PI_PROGR_H - unique sm1 job number ( T800SYSTEMACTIVITYLOG )
                            PI_SESSION_ID    - unique login session (T035LOGGEDUSERS)

     Outputparameters :     PO_MSG           - message of error if procedure exit with error
                            PO_STATUS        - 0 OK; -1 Error
     Author : Mariangela Bandiera
     Creation Date : 23 September 2014
     ----
     Updates :
*/

     PROCEDURE LOAD_T100_ORDERS (PI_PROGR_H       IN NUMBER,
                              PI_SESSION_ID    IN NUMBER,
                              PO_MSG           OUT NOCOPY VARCHAR2,
                              PO_STATUS        OUT NOCOPY NUMBER ) IS



    -- -----------------------------------------
    -- Cursor on Orde Heads xin_t100ordhead
    -- -----------------------------------------
    CURSOR CL_XIN_T100 IS
      SELECT
        *
        FROM  XIN_T100ORDHEAD
        WHERE SM1_CODPROCESS = PI_PROGR_H
      --  and numord='160013692' -- added by VIKAS for testing
        ORDER BY NUMORDHOST, SM1_DTECRE;
    -- -----------------------------------------
    -- Cursor on Order Rows xin_t106_ordrow
    -- -----------------------------------------
    CURSOR CL_XIN_T106(CI_NUMORDHOST VARCHAR2, CI_SM1_DTECRE DATE) IS
      SELECT
        ORDROW.*
  ,T.Codwhs AS VANWHS
        FROM  XIN_T106ORDROW  ORDROW
  INNER JOIN
      T100ORDHEAD T ON ORDROW.NUMORD = T.NUMORD
        WHERE ORDROW.NUMORDHOST = CI_NUMORDHOST
        AND   ORDROW.SM1_CODPROCESS = PI_PROGR_H
    -- AND   ORDROW.SM1_DTECRE <= CI_SM1_DTECRE   -- vikas , no need to compare creation time of header and row
        AND ORDROW.SM1_STATUS = C_XINSTATUS_OK -- Only those that have not processed yet (in case of double record in xin)
        ORDER BY ORDROW.SM1_DTECRE;


    --

    VL_MESSAGE_H   VARCHAR2(4000) := 'Error while loading Orders T100/T106';
    VL_MESSAGE_D   VARCHAR2(4000) := NULL;
    --
    VL_PROGR_D_T100    NUMBER := 0;
    VL_COUNT_XIN_T100  NUMBER := 0;
    VL_INS_T100        NUMBER := 0;
    --
    VL_PROGR_D_T106    NUMBER := 0;
    VL_COUNT_XIN_T106  NUMBER := 0;
    VL_INS_T106        NUMBER := 0;
    --
    REC_T100      T100ORDHEAD%ROWTYPE    := NULL;
    REC_T100_INIT T100ORDHEAD%ROWTYPE    := NULL;
    REC_T106      T106ORDROW%ROWTYPE := NULL;
    REC_T106_INIT T106ORDROW%ROWTYPE := NULL;
    --
    VL_DES_T100     X_FIELD_INFO_ARRAY;-- Array with fields db info
    VL_DES_T106     X_FIELD_INFO_ARRAY;-- Array with fields db info
    --
    VL_RECORD_LOCKED NUMBER := 0;

    VL_STATUS NUMBER:= 0;
    VL_STEP   NUMBER:= 0; -- Used to ping t035
    --
    EX_EXIT  EXCEPTION;
    --
    VL_CODDIV VARCHAR2(30) := NULL;
    vl_ins_upd VARCHAR2(3) := NULL;

  BEGIN
   --ADD BY MADY 20200311
  REC_T100.FLGPROCESSEDASSET := 0;
  REC_T100_INIT.FLGPROCESSEDASSET := 0;

    -- init indexes and rebuild statistics
    P_XIN_INIT_INDEXES (PI_PROGR_H, 'T100ORDHEAD');
    P_XIN_INIT_INDEXES (PI_PROGR_H, 'T106ORDROW');
    -- clean log
    P_XIN_CLEANUP_LOG (PI_PROGR_H, 'T100ORDHEAD');
    P_XIN_CLEANUP_LOG (PI_PROGR_H, 'T106ORDROW');


    VL_PROGR_D_T100 := PKG_UTILS.LOG_NEW_DETAIL(PI_PROGR_H,
                                       'ORDER HEAD',
                                       'IMPORT --> T100ORDHEAD',
                                        0,
                                        NULL);
    VL_PROGR_D_T106 := PKG_UTILS.LOG_NEW_DETAIL(PI_PROGR_H,
                                       'ORDER ROWS',
                                       'IMPORT --> T106ORDROW',
                                        0,
                                        NULL);

    -- retrieves configuration parameters
    LOAD_T10X_CONF_STEP0(
                          VL_MESSAGE_H,
                          VL_STATUS   );

    if (vl_status <> 0 ) then
         PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                        VL_PROGR_D_T100,
                                        SQLCODE,
                                        VL_MESSAGE_H);

          raise EX_EXIT;
    end if;
    BEGIN


        --
        -- ----------------------------------------------------------
        -- Init arrays with FIELD_NAME=LENGTH and FIELDNAME=SM1_DEFAULT for all fields of table
        -- ----------------------------------------------------------
        VL_DES_T100.DELETE;
        P_INIT_SM1_FIELD_ARRAY ('T100ORDHEAD', VL_DES_T100, VL_STATUS, VL_MESSAGE_H);
        execute immediate ( GL_INIT_REC) INTO REC_T100_INIT;


        VL_DES_T106.DELETE;
        P_INIT_SM1_FIELD_ARRAY ('T106ORDROW', VL_DES_T106, VL_STATUS, VL_MESSAGE_H);
        execute immediate ( GL_INIT_REC) INTO REC_T106_INIT;

        IF (VL_STATUS <> 0 ) THEN
            VL_MESSAGE_D := GL_INIT_REC;
            RAISE EX_EXIT;
        END IF;
    EXCEPTION WHEN OTHERS THEN
        VL_MESSAGE_D := GL_INIT_REC;
        RAISE EX_EXIT;
    END;


    -- --------------------------------------------------------------
    -- Identifies Xin records to be loaded
    -- --------------------------------------------------------------
  dbms_output.put_line('10161 LINE '); 
   BEGIN
        VL_MESSAGE_D := 'XIN_T100ORDHEAD';
        UPDATE XIN_T100ORDHEAD
        SET SM1_CODPROCESS = PI_PROGR_H,
            SM1_STATUS = 0,
            SM1_DTEPROCESS = XSYSDATE
            WHERE NVL(SM1_CODPROCESS, 0) = C_SM1_NULL_CODPROCESS;

        VL_COUNT_XIN_T100 := SQL%ROWCOUNT;
        --dbms_output.put_line('t100 pROCESS cOUNT  :-  '||VL_COUNT_XIN_T100 );
        VL_MESSAGE_D := 'XIN_T106ORDROW';
        UPDATE XIN_T106ORDROW D
        SET D.SM1_CODPROCESS = PI_PROGR_H,
            D.SM1_STATUS = 0,
            D.SM1_DTEPROCESS = XSYSDATE
            WHERE 
              NVL(D.SM1_CODPROCESS,0) = C_SM1_NULL_CODPROCESS
            AND D.NUMORDHOST IN ( SELECT H.NUMORDHOST FROM XIN_T100ORDHEAD H WHERE H.SM1_CODPROCESS = PI_PROGR_H 
      --AND H.SM1_DTECRE >= D.SM1_DTECRE 
      );

        VL_COUNT_XIN_T106 := SQL%ROWCOUNT;

         --dbms_output.put_line('C_SM1_NULL_CODPROCESS  :-  '||C_SM1_NULL_CODPROCESS );
        --dbms_output.put_line('SM1_CODPROCESS  :-  '||PI_PROGR_H );

        --dbms_output.put_line('t106 pROCESS cOUNT  :-  '||VL_COUNT_XIN_T106 );

    COMMIT;
    EXCEPTION WHEN OTHERS THEN
      ROLLBACK;
      VL_MESSAGE_H := 'Error while Reading Staging area: '||VL_MESSAGE_D;
      RAISE EX_EXIT;

    END;

    -- --------------------------------------------------------------
    -- loop in main table T100ORDHEAD
    -- --------------------------------------------------------------
    FOR RL_XIN_T100 IN CL_XIN_T100 LOOP
     -- pings to t035 every 100 cicles--
      VL_STEP := VL_STEP + 1;

      IF ( MOD(VL_STEP, 100) = 0 ) THEN
         PKG_UTILS.user_ping(PI_SESSION_ID);
      END IF;

      --
      VL_STATUS := 0;
      --
      VL_MESSAGE_H :=   'Order NumordHost : '   ||RL_XIN_T100.NUMORDHOST;
      --
      BEGIN --- HEAD T100
dbms_output.put_line('10215 LINE '); 
        -- Data Format Check
        VL_MESSAGE_D := 'Format Conversion ';
        VL_CODDIV := 'ALL';
        REC_T100 := REC_T100_INIT;
        --
        REC_T100.CODUSR := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODUSR,'CODUSR', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.NUMORD := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.NUMORD,'NUMORD', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        --
        REC_T100.CODEUSR   := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODEUSR,'CODEUSR', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODTYPORD := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODTYPORD,'CODTYPORD', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODSTATUS := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODSTATUS,'CODSTATUS', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODDIV    := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODDIV,'CODDIV', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODBLCCAUSE := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODBLCCAUSE,'CODBLCCAUSE', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.DTEORD      := F_CHECK_FORMAT_D( VL_CODDIV, RL_XIN_T100.DTEORD,'DTEORD', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.DTEDELIV    := F_CHECK_FORMAT_D( VL_CODDIV, RL_XIN_T100.DTEDELIV,'DTEDELIV', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODTYPDELIV := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODTYPDELIV,'CODTYPDELIV', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.DTEEVA      := F_CHECK_FORMAT_D( VL_CODDIV, RL_XIN_T100.DTEEVA,'DTEEVA', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODPAYTRM   := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODPAYTRM,'CODPAYTRM', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODPAYMOD   := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODPAYMOD,'CODPAYMOD', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODCUSTDELIV := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODCUSTDELIV,'CODCUSTDELIV', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODVATMGMT   := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODVATMGMT,'CODVATMGMT', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODCUSTINV   := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODCUSTINV,'CODCUSTINV', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODLIST      := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODLIST,'CODLIST', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODCUR       := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODCUR,'CODCUR', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.NUMORDREF    := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.NUMORDREF,'NUMORDREF', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.NUMORDHOST   := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.NUMORDHOST,'NUMORDHOST', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        --dbms_output.put_line('NUMORDHOST  :-  '||RL_XIN_T100.NUMORDHOST );
        REC_T100.NUMORDCUST   := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.NUMORDCUST,'NUMORDCUST', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.DTEORDCUST   := F_CHECK_FORMAT_D( VL_CODDIV, RL_XIN_T100.DTEORDCUST,'DTEORDCUST', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODASSORTMENT := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODASSORTMENT,'CODASSORTMENT', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODCANVASS    := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODCANVASS,'CODCANVASS', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODMODSHIP    := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODMODSHIP,'CODMODSHIP', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODMODDELIV   := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODMODDELIV,'CODMODDELIV', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODAGREEMENT  := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.CODAGREEMENT,'CODAGREEMENT', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.DESAGREEMENT  := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.DESAGREEMENT,'DESAGREEMENT', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODUSRAUT     := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODUSRAUT,'CODUSRAUT', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODAGREECLASS := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODAGREECLASS,'CODAGREECLASS', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.DTEAUT        := F_CHECK_FORMAT_D( VL_CODDIV, RL_XIN_T100.DTEAUT,'DTEAUT', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODTYPAUT     := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODTYPAUT,'CODTYPAUT', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.DESAUT        := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.DESAUT,'DESAUT', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.GROSSAMOUNT   := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.GROSSAMOUNT,'GROSSAMOUNT', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.NETAMOUNT     := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.NETAMOUNT,'NETAMOUNT', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.TAXAMOUNT     := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.TAXAMOUNT,'TAXAMOUNT', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.VATAMOUNT     := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.VATAMOUNT,'VATAMOUNT', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.INCREASEAMOUNT := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.INCREASEAMOUNT,'INCREASEAMOUNT', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.DISCOUNTAMOUNT := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.DISCOUNTAMOUNT,'DISCOUNTAMOUNT', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.GIFTAMOUNT     := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.GIFTAMOUNT,'GIFTAMOUNT', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.FLGANN         := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.FLGANN,'FLGANN', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODABI         := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODABI,'CODABI', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODCAB         := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODCAB,'CODCAB', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.DESBAN         := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.DESBAN,'DESBAN', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.DESBRA         := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.DESBRA,'DESBRA', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.DESADDR        := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.DESADDR,'DESADDR', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.DESLOC         := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.DESLOC,'DESLOC', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.DESPRV         := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.DESPRV,'DESPRV', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.QTYTOT         := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.QTYTOT,'QTYTOT', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODPRV         := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODPRV,'CODPRV', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.UMQTYTOT       := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.UMQTYTOT,'UMQTYTOT', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODACCOUNT     := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODACCOUNT,'CODACCOUNT', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.FLGRETURN      := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.FLGRETURN,'FLGRETURN', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.FLGHOSTED      := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.FLGHOSTED,'FLGHOSTED', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.FLGCONFIRMED   := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.FLGCONFIRMED,'FLGCONFIRMED', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        --REC_T100.CODWHS         := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODWHS,'CODWHS', VL_DES_T100,VL_STATUS, VL_MESSAGE_D); --commented because while sending to sage it send as main ware house
        REC_T100.CODSHIPPER     := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODSHIPPER,'CODSHIPPER', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODAZCAPP      := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODAZCAPP,'CODAZCAPP', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODAZCBEN      := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODAZCBEN,'CODAZCBEN', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.DTEPRICE       := F_CHECK_FORMAT_D( VL_CODDIV, RL_XIN_T100.DTEPRICE,'DTEPRICE', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODTYPSALE     := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODTYPSALE,'CODTYPSALE', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.FLGCHECKPROMO  := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.FLGCHECKPROMO,'FLGCHECKPROMO', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODAGREETYPE   := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODAGREETYPE,'CODAGREETYPE', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODSTATUSMAN   := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODSTATUSMAN,'CODSTATUSMAN', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.DISCOUNTAMOUNTOUTINV := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.DISCOUNTAMOUNTOUTINV,'DISCOUNTAMOUNTOUTINV', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODTYPORDCUST        := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODTYPORDCUST,'CODTYPORDCUST', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODUSR3              := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODUSR3,'CODUSR3', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.DTEDELIVTO           := F_CHECK_FORMAT_D( VL_CODDIV, RL_XIN_T100.DTEDELIVTO,'DTEDELIVTO', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODCIN               := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODCIN,'CODCIN', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.FLGUMORD2            := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.FLGUMORD2,'FLGUMORD2', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.NETAMOUNTTEO         := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.NETAMOUNTTEO,'NETAMOUNTTEO', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.NETAMOUNTMIN         := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.NETAMOUNTMIN,'NETAMOUNTMIN', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.NETAMOUNTMAX         := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.NETAMOUNTMAX,'NETAMOUNTMAX', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODUSR4              := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODUSR4,'CODUSR4', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODUSR2              := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODUSR2,'CODUSR2', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODBUYEREDI          := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODBUYEREDI,'CODBUYEREDI', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODCUSTINVEDI        := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODCUSTINVEDI,'CODCUSTINVEDI', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODCUSTDELIVEDI      := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODCUSTDELIVEDI,'CODCUSTDELIVEDI', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODSELLEREDI         := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODSELLEREDI,'CODSELLEREDI', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODUSR6              := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODUSR6,'CODUSR6', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODPDV               := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODPDV,'CODPDV', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODCUSTCONC          := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODCUSTCONC,'CODCUSTCONC', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODIBAN              := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODIBAN,'CODIBAN', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.BACKAMOUNT           := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.BACKAMOUNT,'BACKAMOUNT', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.TOTPALLETS           := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.TOTPALLETS,'TOTPALLETS', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.GROSSWEIGHT          := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.GROSSWEIGHT,'GROSSWEIGHT', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.TOTMC                := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.TOTMC,'TOTMC', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.DTEPROPDELIV         := F_CHECK_FORMAT_D( VL_CODDIV, RL_XIN_T100.DTEPROPDELIV,'DTEPROPDELIV', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODUSR5              := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODUSR5,'CODUSR5', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.IDSURVEY             := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.IDSURVEY,'IDSURVEY', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODCUSTSALE          := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODCUSTSALE,'CODCUSTSALE', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.FLGPROCESSEDEDI      := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.FLGPROCESSEDEDI,'FLGPROCESSEDEDI', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.FLGEDI               := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.FLGEDI,'FLGEDI', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.NUMESENZIONE         := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.NUMESENZIONE,'NUMESENZIONE', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.DTEDELIV2            := F_CHECK_FORMAT_D( VL_CODDIV, RL_XIN_T100.DTEDELIV2,'DTEDELIV2', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.DTEDELIV3            := F_CHECK_FORMAT_D( VL_CODDIV, RL_XIN_T100.DTEDELIV3,'DTEDELIV3', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.DTEDELIV4            := F_CHECK_FORMAT_D( VL_CODDIV, RL_XIN_T100.DTEDELIV4,'DTEDELIV4', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.DTEDELIV5            := F_CHECK_FORMAT_D( VL_CODDIV, RL_XIN_T100.DTEDELIV5,'DTEDELIV5', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.IDROUTE              := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.IDROUTE,'IDROUTE', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.NUMDOC               := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.NUMDOC,'NUMDOC', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
         -- DTECLOSE
         IF( LENGTH(TRIM(TO_CHAR(RL_XIN_T100.DTECLOSE))) <> 0 AND RL_XIN_T100.DTECLOSE IS NOT NULL ) THEN
         REC_T100.DTECLOSE   := RL_XIN_T100.DTECLOSE;
         ELSE
         REC_T100.DTECLOSE             := F_CHECK_FORMAT_D( VL_CODDIV, RL_XIN_T100.DTECLOSE,'DTECLOSE', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
         END IF;
    REC_T100.RETURNAMOUNT         := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.RETURNAMOUNT,'RETURNAMOUNT', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);

        --- Technical fields
        REC_T100.DTECRE     := XSYSDATE;
        REC_T100.CODUSRMOD  := C_SYSUSR;
        REC_T100.DTEMOD     := XSYSDATE;
        REC_T100.CODUSRMODREAL := C_SYSUSR;
        REC_T100.CODUSRCREREAL := C_SYSUSR;
        -- lock fields
        REC_T100.CODUSRLCK     := C_SYSUSR;
        REC_T100.IDSESSIONLCK  := PI_SESSION_ID;
        REC_T100.DTELCK        := XSYSDATE;

 dbms_output.put_line('LINE 312 - VL_MESSAGE_H = ' || VL_MESSAGE_H || 'AND ' || dbms_utility.format_error_backtrace()); 
        IF (VL_STATUS <> 0 ) THEN

             VL_MESSAGE_H := SUBSTR('LINE 315 - ' || VL_MESSAGE_H||' '||VL_MESSAGE_D||' '||dbms_utility.format_error_backtrace() || ' ' || SQLERRM,1,4000);

             PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                           VL_PROGR_D_T100,
                                           SQLCODE,
                                           VL_MESSAGE_H);
 dbms_output.put_line('LINE 321 - VL_MESSAGE_H = ' || VL_MESSAGE_H || 'AND ' || dbms_utility.format_error_backtrace());                    
        ELSE

            -- Recocgnize SM1 Orders and fit in REC_T100 record updated values
            -- inserts new orders coming from ERP
            LOAD_T10X_HEAD_STEP1( PI_PROGR_H,
                                  VL_PROGR_D_T100,
                                  REC_T100,
                                  VL_STATUS);
 dbms_output.put_line('LINE 330 - VL_MESSAGE_H = ' || VL_MESSAGE_H || 'AND ' || dbms_utility.format_error_backtrace());             

        END IF;
        -- -----------------------------------
        -- T106ORDERROW
        -- -----------------------------------
        BEGIN
        --
     dbms_output.put_line('LINE 338 - VL_MESSAGE_H = ' || VL_MESSAGE_H || 'AND ' || dbms_utility.format_error_backtrace()); 
         dbms_output.put_line('10339 VLSTATUS = '|| VL_STATUS );
        IF ( VL_STATUS = 0  ) THEN
          dbms_output.put_line('10368 VLSTATUS = '|| VL_STATUS );

            -- Before updating all rows, we mark them all to recognize those no more sent by ERP
            -- we use a prefix on CODSTATUS
      
              UPDATE T106ORDROW T
              set T.codstatus =C_T106_STATUS_PREFIX||t.codstatus,

              t.qtyord = '0',t.qtyinv = '0' -- added by vikas , not returned rows from SAGE should be set as zero qty in SM1

              where t.numord = REC_T100.NUMORD;

              FOR RL_XIN_T106 IN CL_XIN_T106(RL_XIN_T100.NUMORDHOST, RL_XIN_T100.SM1_DTECRE)
                 LOOP

                VL_MESSAGE_H := 'Row info: '|| REC_T100.NUMORD|| '/' ||
                                               REC_T100.CODUSR|| '/' ||
                                               RL_XIN_T106.CODDIV || '/' ||
                                               RL_XIN_T106.NUMROWHOST;
                         
               
         dbms_output.put_line(VL_MESSAGE_H || 'CODSTATUS=' || RL_XIN_T106.CODSTATUS);
         
                  --dbms_output.put_line('CODSTSTUS  '|| F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.CODSTATUS,'CODSTATUS', VL_DES_T106,VL_STATUS, VL_MESSAGE_D) );

                  VL_MESSAGE_D := 'Format Conversion ';
          dbms_output.put_line('Starting format conversion ,VL_MESSAGE_D = ' || VL_MESSAGE_D);
                  VL_CODDIV := RL_XIN_T106.CODDIV;
                  REC_T106  := REC_T106_INIT;
                  ---
                  REC_T106.NUMORD := REC_T100.NUMORD;
                  REC_T106.CODUSR := REC_T100.CODUSR;
                  --
                  REC_T106.NUMROW := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.NUMROW,'NUMROW', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.CODART := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.CODART,'CODART', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.CODDIV := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.CODDIV,'CODDIV', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.UMORD  := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.UMORD,'UMORD', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.DESART := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.DESART,'DESART', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.QTYORD := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.QTYORD,'QTYORD', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.QTYBCKORD := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.QTYBCKORD,'QTYBCKORD', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.QTYANN    := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.QTYANN,'QTYANN', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.QTYDEL    := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.QTYDEL,'QTYDEL', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.UMINV     := REC_T106.UMORD;-- F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.UMINV,'UMINV', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.QTYINV    := REC_T106.QTYORD;-- F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.QTYINV,'QTYINV', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);-- qtyord and qtyinv will be equal in sales responce 
                  REC_T106.CODTYPROW := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.CODTYPROW,'CODTYPROW', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.CODLIST   := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.CODLIST,'CODLIST', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.DTEDELIV  := F_CHECK_FORMAT_D( VL_CODDIV,  RL_XIN_T106.DTEDELIV,'DTEDELIV', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.DTEPROPDELIV := F_CHECK_FORMAT_D( VL_CODDIV,  RL_XIN_T106.DTEPROPDELIV,'DTEPROPDELIV', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.CODSTATUS := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.CODSTATUS,'CODSTATUS', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.CODSHIPPER := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.CODSHIPPER,'CODSHIPPER', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.NUMDOCREF := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.NUMDOCREF,'NUMDOCREF', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.DTEDOCREF := F_CHECK_FORMAT_D( VL_CODDIV,  RL_XIN_T106.DTEDOCREF,'DTEDOCREF', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.GROSSAMOUNT := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.GROSSAMOUNT,'GROSSAMOUNT', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.NUMINV      := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.NUMINV,'NUMINV', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.NETAMOUNT   := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.NETAMOUNT,'NETAMOUNT', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.DTEINV      := F_CHECK_FORMAT_D( VL_CODDIV,  RL_XIN_T106.DTEINV,'DTEINV', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.TAXAMOUNT   := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.TAXAMOUNT,'TAXAMOUNT', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.VATAMOUNT   := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.VATAMOUNT,'VATAMOUNT', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.INCREASEAMOUNT := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.INCREASEAMOUNT,'INCREASEAMOUNT', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.DISCOUNTAMOUNT := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.DISCOUNTAMOUNT,'DISCOUNTAMOUNT', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.GIFTAMOUNT     := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.GIFTAMOUNT,'GIFTAMOUNT', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.ENDUSERPRICE   := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.ENDUSERPRICE,'ENDUSERPRICE', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.CODAZCAPP      := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.CODAZCAPP,'CODAZCAPP', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.FLGEFFBCKORD   := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.FLGEFFBCKORD,'FLGEFFBCKORD', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.CODBCKORDCAUSE := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.CODBCKORDCAUSE,'CODBCKORDCAUSE', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.GROSSARTAMOUNT := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.GROSSARTAMOUNT,'GROSSARTAMOUNT', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.NETARTAMOUNT   := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.NETARTAMOUNT,'NETARTAMOUNT', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.CODSRC         := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.CODSRC,'CODSRC', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.CODSRCREF      := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.CODSRCREF,'CODSRCREF', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.CODBENCAUSE    := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.CODBENCAUSE,'CODBENCAUSE', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.CODBENSUBCAUSE := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.CODBENSUBCAUSE,'CODBENSUBCAUSE', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.BENNOTE        := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.BENNOTE,'BENNOTE', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.AZCTOAPPLY     := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.AZCTOAPPLY,'AZCTOAPPLY', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.CODOPERATION   := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.CODOPERATION,'CODOPERATION', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.DISCOUNTAMOUNTOUTINV := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.DISCOUNTAMOUNTOUTINV,'DISCOUNTAMOUNTOUTINV', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.CODACCAPP            := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.CODACCAPP,'CODACCAPP', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.CODTYPROWCAUSE       := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.CODTYPROWCAUSE,'CODTYPROWCAUSE', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.CODARTCUST           := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.CODARTCUST,'CODARTCUST', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.QTYRESO              := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.QTYRESO,'QTYRESO', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.NUMORDRESO           := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.NUMORDRESO,'NUMORDRESO', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.CODBLCCAUSE          := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.CODBLCCAUSE,'CODBLCCAUSE', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.CODARTKITREF         := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.CODARTKITREF,'CODARTKITREF', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.NUMROWKITREF         := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.NUMROWKITREF,'NUMROWKITREF', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.CODCAUSEKIT          := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.CODCAUSEKIT,'CODCAUSEKIT', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.NETARTAMOUNTTEO      := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.NETARTAMOUNTTEO,'NETARTAMOUNTTEO', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.NETAMOUNTTEO         := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.NETAMOUNTTEO,'NETAMOUNTTEO', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.NETAMOUNTMIN         := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.NETAMOUNTMIN,'NETAMOUNTMIN', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.NETAMOUNTMAX         := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.NETAMOUNTMAX,'NETAMOUNTMAX', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.NETDIFF              := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.NETDIFF,'NETDIFF', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.COD_ABBINAMENTO_KIT  := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.COD_ABBINAMENTO_KIT,'COD_ABBINAMENTO_KIT', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.NUMROWORIG           := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.NUMROWORIG,'NUMROWORIG', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.FLGFIRSTSON          := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.FLGFIRSTSON,'FLGFIRSTSON', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.NETARTAMOUNTCUST     := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.NETARTAMOUNTCUST,'NETARTAMOUNTCUST', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.NETARTAMOUNTCUST2    := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.NETARTAMOUNTCUST2,'NETARTAMOUNTCUST2', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.GROSSARTAMOUNTCUST   := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.GROSSARTAMOUNTCUST,'GROSSARTAMOUNTCUST', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.NETAMOUNTCUST        := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.NETAMOUNTCUST,'NETAMOUNTCUST', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.QTYORDEDI            := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.QTYORDEDI,'QTYORDEDI', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.CODEAN               := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.CODEAN,'CODEAN', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.UMORDEDI             := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.UMORDEDI,'UMORDEDI', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.NUMROWREF            := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.NUMROWREF,'NUMROWREF', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.FLGOMGPROMO          := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.FLGOMGPROMO,'FLGOMGPROMO', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.GROSSARTAMOUNTORD    := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.GROSSARTAMOUNTORD,'GROSSARTAMOUNTORD', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.GROSSARTAMOUNTDELTA  := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.GROSSARTAMOUNTDELTA,'GROSSARTAMOUNTDELTA', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.FLGOMGDISCLIST       := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.FLGOMGDISCLIST,'FLGOMGDISCLIST', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.CODCNVPDA            := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.CODCNVPDA,'CODCNVPDA', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.DTEEVA               := F_CHECK_FORMAT_D( VL_CODDIV,  RL_XIN_T106.DTEEVA,'DTEEVA', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.CODPAYTRM            := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.CODPAYTRM,'CODPAYTRM', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.CODPAYMOD            := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.CODPAYMOD,'CODPAYMOD', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.NUMORDHOST           := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.NUMORDHOST,'NUMORDHOST', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.NUMROWHOST           := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.NUMROWHOST,'NUMROWHOST', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.CODMODSHIP           := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.CODMODSHIP,'CODMODSHIP', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.CODMODDELIV          := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.CODMODDELIV,'CODMODDELIV', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.CODWHS               := RL_XIN_T106.VANWHS ; --F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.VANWHS,'CODWHS', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.DTEPRICE             := F_CHECK_FORMAT_D( VL_CODDIV,  RL_XIN_T106.DTEPRICE,'DTEPRICE', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.DTEDELIVTO           := F_CHECK_FORMAT_D( VL_CODDIV,  RL_XIN_T106.DTEDELIVTO,'DTEDELIVTO', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.CODROWGROUP          := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.CODROWGROUP,'CODROWGROUP', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.NETAMOUNTGIFT        := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.NETAMOUNTGIFT,'NETAMOUNTGIFT', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.NETARTAMOUNTEDI      := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.NETARTAMOUNTEDI,'NETARTAMOUNTEDI', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.GROSSARTAMOUNTEDI    := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.GROSSARTAMOUNTEDI,'GROSSARTAMOUNTEDI', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.QTYORDORIG           := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.QTYORDORIG,'QTYORDORIG', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.QTYALLOCATED         := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.QTYALLOCATED,'QTYALLOCATED', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.RETURNAMOUNT         := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.RETURNAMOUNT,'RETURNAMOUNT', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);

                  -- Technical fields
                  --
          dbms_output.put_line('ending format conversion ,VL_MESSAGE_D = ' || VL_MESSAGE_D);
          VL_MESSAGE_H := SUBSTR(VL_MESSAGE_H||' '||VL_MESSAGE_D||' '||dbms_utility.format_error_backtrace() || ' ' || SQLERRM,1,4000);
        
        dbms_output.put_line('line 10496, VL_STATUS = ' || VL_STATUS || 'and  VL_MESSAGE_H = ' || VL_MESSAGE_H);
                 IF (VL_STATUS <> 0 ) THEN


                   VL_MESSAGE_H := SUBSTR(VL_MESSAGE_H||' '||VL_MESSAGE_D||' '||dbms_utility.format_error_backtrace() || ' ' || SQLERRM,1,4000);
                   PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                           VL_PROGR_D_T106,
                                           SQLCODE,
                                           VL_MESSAGE_H);
                    dbms_output.put_line('LINE 10502='|| sqlerrm(0) );
                    dbms_output.put_line('LINE 10503='|| sqlerrm(-1041) );              
                       
                ELSE
                 dbms_output.put_line('line 10509 ,vl_ins_upd = ' || vl_ins_upd);
                 vl_ins_upd := NULL;
                  -- Recognize order lines; inserts new rows ; check the row
                 LOAD_T10X_ROW_STEP2( PI_PROGR_H,
                                      VL_PROGR_D_T106,
                                      REC_T106,
                                      vl_ins_upd,
                                      VL_STATUS);
        VL_MESSAGE_H := SUBSTR(VL_MESSAGE_H||' '||VL_MESSAGE_D||' '||dbms_utility.format_error_backtrace() || ' ' || SQLERRM,1,4000);
         dbms_output.put_line('line 10518 ,vl_ins_upd = ' || vl_ins_upd || 'and VL_STATUS = ' || VL_STATUS);    
         dbms_output.put_line('line 10519, VL_MESSAGE_H = ' || VL_MESSAGE_H || 'and SQLERM  = ' || sqlerrm );        

                END IF;
                --
              IF (VL_STATUS = 0 ) then
        dbms_output.put_line('line 10524, vl_ins_upd = '|| vl_ins_upd );
                if (vl_ins_upd = 'UPD') THEN
                VL_MESSAGE_D := 'Update T106 ';
                 dbms_output.put_line('line 10527, VL_MESSAGE_D = ' || VL_MESSAGE_D);
                  dbms_output.put_line('LINE 10528, starting update query ' );
                  dbms_output.put_line('line 10529, sqlerm  = ' || sqlerrm );
                UPDATE T106ORDROW
                   SET

                  --  CODUSR = CASE VL_DES_T106('CODUSR').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODUSR ELSE CODUSR END,
                  --  NUMORD = CASE VL_DES_T106('NUMORD').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.NUMORD ELSE NUMORD END,
                  --  NUMROW = rec_t106.numrow,
                  --  CODART = CASE VL_DES_T106('CODART').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODART ELSE CODART END,
                  --  CODDIV = CASE VL_DES_T106('CODDIV').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODDIV ELSE CODDIV END,
                    UMORD = CASE VL_DES_T106('UMORD.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.UMORD ELSE UMORD END,
                  --  DESART = CASE VL_DES_T106('DESART.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.DESART ELSE DESART END,
                    QTYORD = CASE VL_DES_T106('QTYORD.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.QTYORD ELSE QTYORD END,
                    --QTYBCKORD = CASE VL_DES_T106('QTYBCKORD.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.QTYBCKORD ELSE QTYBCKORD END,
                    --QTYANN = CASE VL_DES_T106('QTYANN.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.QTYANN ELSE QTYANN END,
                    --QTYDEL = CASE VL_DES_T106('QTYDEL.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.QTYDEL ELSE QTYDEL END,
                   -- UMINV = CASE VL_DES_T106('UMINV.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.UMINV ELSE UMINV END,
                    QTYINV = CASE VL_DES_T106('QTYINV.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.QTYINV ELSE QTYINV END,                  
                    --CODTYPROW = CASE VL_DES_T106('CODTYPROW.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODTYPROW ELSE CODTYPROW END,
                    --CODLIST = CASE VL_DES_T106('CODLIST.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODLIST ELSE CODLIST END,
                    --DTEDELIV = CASE VL_DES_T106('DTEDELIV.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.DTEDELIV ELSE DTEDELIV END,
                    --DTEPROPDELIV = CASE VL_DES_T106('DTEPROPDELIV.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.DTEPROPDELIV ELSE DTEPROPDELIV END,
                    CODSTATUS = CASE VL_DES_T106('CODSTATUS.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODSTATUS ELSE CODSTATUS END,
                    --CODSHIPPER = CASE VL_DES_T106('CODSHIPPER.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODSHIPPER ELSE CODSHIPPER END,
                    --NUMDOCREF = CASE VL_DES_T106('NUMDOCREF.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.NUMDOCREF ELSE NUMDOCREF END,
                    --DTEDOCREF = CASE VL_DES_T106('DTEDOCREF.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.DTEDOCREF ELSE DTEDOCREF END,
                    --GROSSAMOUNT = CASE VL_DES_T106('GROSSAMOUNT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.GROSSAMOUNT ELSE GROSSAMOUNT END,
                    --NUMINV = CASE VL_DES_T106('NUMINV.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.NUMINV ELSE NUMINV END,
                    --NETAMOUNT = CASE VL_DES_T106('NETAMOUNT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.NETAMOUNT ELSE NETAMOUNT END,
                    --DTEINV = CASE VL_DES_T106('DTEINV.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.DTEINV ELSE DTEINV END,
                    --TAXAMOUNT = CASE VL_DES_T106('TAXAMOUNT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.TAXAMOUNT ELSE TAXAMOUNT END,
                    --VATAMOUNT = CASE VL_DES_T106('VATAMOUNT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.VATAMOUNT ELSE VATAMOUNT END,
                    --INCREASEAMOUNT = CASE VL_DES_T106('INCREASEAMOUNT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.INCREASEAMOUNT ELSE INCREASEAMOUNT END,
                    --DISCOUNTAMOUNT = CASE VL_DES_T106('DISCOUNTAMOUNT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.DISCOUNTAMOUNT ELSE DISCOUNTAMOUNT END,
                    --GIFTAMOUNT = CASE VL_DES_T106('GIFTAMOUNT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.GIFTAMOUNT ELSE GIFTAMOUNT END,
                    --ENDUSERPRICE = CASE VL_DES_T106('ENDUSERPRICE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.ENDUSERPRICE ELSE ENDUSERPRICE END,
                    --CODAZCAPP = CASE VL_DES_T106('CODAZCAPP.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODAZCAPP ELSE CODAZCAPP END,
                    --FLGEFFBCKORD = CASE VL_DES_T106('FLGEFFBCKORD.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.FLGEFFBCKORD ELSE FLGEFFBCKORD END,
                    --CODBCKORDCAUSE = CASE VL_DES_T106('CODBCKORDCAUSE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODBCKORDCAUSE ELSE CODBCKORDCAUSE END,
                    --GROSSARTAMOUNT = CASE VL_DES_T106('GROSSARTAMOUNT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.GROSSARTAMOUNT ELSE GROSSARTAMOUNT END,
                    --NETARTAMOUNT = CASE VL_DES_T106('NETARTAMOUNT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.NETARTAMOUNT ELSE NETARTAMOUNT END,
                    --CODSRC = CASE VL_DES_T106('CODSRC.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODSRC ELSE CODSRC END,
                    --CODSRCREF = CASE VL_DES_T106('CODSRCREF.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODSRCREF ELSE CODSRCREF END,
                    --CODBENCAUSE = CASE VL_DES_T106('CODBENCAUSE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODBENCAUSE ELSE CODBENCAUSE END,
                    --CODBENSUBCAUSE = CASE VL_DES_T106('CODBENSUBCAUSE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODBENSUBCAUSE ELSE CODBENSUBCAUSE END,
                    --BENNOTE = CASE VL_DES_T106('BENNOTE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.BENNOTE ELSE BENNOTE END,
                    --AZCTOAPPLY = CASE VL_DES_T106('AZCTOAPPLY.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.AZCTOAPPLY ELSE AZCTOAPPLY END,
                   -- CODOPERATION = CASE VL_DES_T106('CODOPERATION.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODOPERATION ELSE CODOPERATION END,
                   -- DISCOUNTAMOUNTOUTINV = CASE VL_DES_T106('DISCOUNTAMOUNTOUTINV.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.DISCOUNTAMOUNTOUTINV ELSE DISCOUNTAMOUNTOUTINV END,
                    --CODACCAPP = CASE VL_DES_T106('CODACCAPP.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODACCAPP ELSE CODACCAPP END,
                    --CODTYPROWCAUSE = CASE VL_DES_T106('CODTYPROWCAUSE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODTYPROWCAUSE ELSE CODTYPROWCAUSE END,
                    --CODARTCUST = CASE VL_DES_T106('CODARTCUST.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODARTCUST ELSE CODARTCUST END,
                    --QTYRESO = CASE VL_DES_T106('QTYRESO.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.QTYRESO ELSE QTYRESO END,
                    --NUMORDRESO = CASE VL_DES_T106('NUMORDRESO.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.NUMORDRESO ELSE NUMORDRESO END,
                    --CODBLCCAUSE = CASE VL_DES_T106('CODBLCCAUSE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODBLCCAUSE ELSE CODBLCCAUSE END,
                    --CODARTKITREF = CASE VL_DES_T106('CODARTKITREF.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODARTKITREF ELSE CODARTKITREF END,
                    --NUMROWKITREF = CASE VL_DES_T106('NUMROWKITREF.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.NUMROWKITREF ELSE NUMROWKITREF END,
                    --CODCAUSEKIT = CASE VL_DES_T106('CODCAUSEKIT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODCAUSEKIT ELSE CODCAUSEKIT END,
                    --NETARTAMOUNTTEO = CASE VL_DES_T106('NETARTAMOUNTTEO.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.NETARTAMOUNTTEO ELSE NETARTAMOUNTTEO END,
                    --NETAMOUNTTEO = CASE VL_DES_T106('NETAMOUNTTEO.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.NETAMOUNTTEO ELSE NETAMOUNTTEO END,
                    --NETAMOUNTMIN = CASE VL_DES_T106('NETAMOUNTMIN.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.NETAMOUNTMIN ELSE NETAMOUNTMIN END,
                    --NETAMOUNTMAX = CASE VL_DES_T106('NETAMOUNTMAX.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.NETAMOUNTMAX ELSE NETAMOUNTMAX END,
                    --NETDIFF = CASE VL_DES_T106('NETDIFF.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.NETDIFF ELSE NETDIFF END,
                    --COD_ABBINAMENTO_KIT = CASE VL_DES_T106('COD_ABBINAMENTO_KIT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.COD_ABBINAMENTO_KIT ELSE COD_ABBINAMENTO_KIT END,
                    --NUMROWORIG = CASE VL_DES_T106('NUMROWORIG.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.NUMROWORIG ELSE NUMROWORIG END,
                    --FLGFIRSTSON = CASE VL_DES_T106('FLGFIRSTSON.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.FLGFIRSTSON ELSE FLGFIRSTSON END,
                    --NETARTAMOUNTCUST = CASE VL_DES_T106('NETARTAMOUNTCUST.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.NETARTAMOUNTCUST ELSE NETARTAMOUNTCUST END,
                    --NETARTAMOUNTCUST2 = CASE VL_DES_T106('NETARTAMOUNTCUST2.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.NETARTAMOUNTCUST2 ELSE NETARTAMOUNTCUST2 END,
                    --GROSSARTAMOUNTCUST = CASE VL_DES_T106('GROSSARTAMOUNTCUST.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.GROSSARTAMOUNTCUST ELSE GROSSARTAMOUNTCUST END,
                    --NETAMOUNTCUST = CASE VL_DES_T106('NETAMOUNTCUST.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.NETAMOUNTCUST ELSE NETAMOUNTCUST END,
                    --QTYORDEDI = CASE VL_DES_T106('QTYORDEDI.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.QTYORDEDI ELSE QTYORDEDI END,
                    --CODEAN = CASE VL_DES_T106('CODEAN.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODEAN ELSE CODEAN END,
                    --UMORDEDI = CASE VL_DES_T106('UMORDEDI.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.UMORDEDI ELSE UMORDEDI END,
                    --NUMROWREF = CASE VL_DES_T106('NUMROWREF.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.NUMROWREF ELSE NUMROWREF END,
                    --FLGOMGPROMO = CASE VL_DES_T106('FLGOMGPROMO.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.FLGOMGPROMO ELSE FLGOMGPROMO END,
                    --GROSSARTAMOUNTORD = CASE VL_DES_T106('GROSSARTAMOUNTORD.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.GROSSARTAMOUNTORD ELSE GROSSARTAMOUNTORD END,
                    --GROSSARTAMOUNTDELTA = CASE VL_DES_T106('GROSSARTAMOUNTDELTA.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.GROSSARTAMOUNTDELTA ELSE GROSSARTAMOUNTDELTA END,
                    --FLGOMGDISCLIST = CASE VL_DES_T106('FLGOMGDISCLIST.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.FLGOMGDISCLIST ELSE FLGOMGDISCLIST END,
                    --CODCNVPDA = CASE VL_DES_T106('CODCNVPDA.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODCNVPDA ELSE CODCNVPDA END,
                    --DTEEVA = CASE VL_DES_T106('DTEEVA.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.DTEEVA ELSE DTEEVA END,
                    --CODPAYTRM = CASE VL_DES_T106('CODPAYTRM.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODPAYTRM ELSE CODPAYTRM END,
                    --CODPAYMOD = CASE VL_DES_T106('CODPAYMOD.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODPAYMOD ELSE CODPAYMOD END,
                    NUMORDHOST = CASE VL_DES_T106('NUMORDHOST.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.NUMORDHOST ELSE NUMORDHOST END,
                    NUMROWHOST = CASE VL_DES_T106('NUMROWHOST.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.NUMROWHOST ELSE NUMROWHOST END  --,
                    --CODMODSHIP = CASE VL_DES_T106('CODMODSHIP.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODMODSHIP ELSE CODMODSHIP END,
                    --CODMODDELIV = CASE VL_DES_T106('CODMODDELIV.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODMODDELIV ELSE CODMODDELIV END,
                    --CODWHS = CASE VL_DES_T106('CODWHS.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODWHS ELSE CODWHS END,
                    --DTEPRICE = CASE VL_DES_T106('DTEPRICE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.DTEPRICE ELSE DTEPRICE END,
                    --DTEDELIVTO = CASE VL_DES_T106('DTEDELIVTO.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.DTEDELIVTO ELSE DTEDELIVTO END,
                    --CODROWGROUP = CASE VL_DES_T106('CODROWGROUP.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODROWGROUP ELSE CODROWGROUP END,
                    --NETAMOUNTGIFT = CASE VL_DES_T106('NETAMOUNTGIFT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.NETAMOUNTGIFT ELSE NETAMOUNTGIFT END,
                    --NETARTAMOUNTEDI = CASE VL_DES_T106('NETARTAMOUNTEDI.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.NETARTAMOUNTEDI ELSE NETARTAMOUNTEDI END,
                    --GROSSARTAMOUNTEDI = CASE VL_DES_T106('GROSSARTAMOUNTEDI.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.GROSSARTAMOUNTEDI ELSE GROSSARTAMOUNTEDI END,
                    --QTYORDORIG = CASE VL_DES_T106('QTYORDORIG.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.QTYORDORIG ELSE QTYORDORIG END,
                    --QTYALLOCATED = CASE VL_DES_T106('QTYALLOCATED.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.QTYALLOCATED ELSE QTYALLOCATED END,
                    --RETURNAMOUNT = CASE VL_DES_T106('RETURNAMOUNT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.RETURNAMOUNT ELSE RETURNAMOUNT END

                 WHERE NUMORD = REC_T106.NUMORD
                   --AND CODUSR = REC_T106.CODUSR
                   AND NUMROW = REC_T106.NUMROW ;
          dbms_output.put_line('line 10634, update query end amd SQLERM = ' || sqlerrm );
               else
       dbms_output.put_line('line 10636, else loop , means insert loop and VL_MESSAGE_D = ' || VL_MESSAGE_D || 'and SQLERM ='   || sqlerrm );
                  -- record does not exists , we insert it
                   VL_MESSAGE_D := 'Insert T106 ';
               dbms_output.put_line('line 10629 , VL_MESSAGE_D = '|| VL_MESSAGE_D );
                  
                  INSERT INTO T106ORDROW VALUES REC_T106;
               end if;
         dbms_output.put_line('line 10644 , VL_INS_T106 = '|| VL_INS_T106 );
         dbms_output.put_line('line 10645, SQLERM = ' || sqlerrm );
              VL_INS_T106 := VL_INS_T106 + 1;
        
             end if;

       END LOOP;   --T106ORDROW
       END IF;
       EXCEPTION WHEN OTHERS THEN
             VL_STATUS := -1;
             VL_MESSAGE_H := SUBSTR(VL_MESSAGE_H||' '||VL_MESSAGE_D||' '||dbms_utility.format_error_backtrace() || ' ' || SQLERRM,1,4000);

             PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                           VL_PROGR_D_T106,
                                           SQLCODE,
                                           VL_MESSAGE_H);

      END; -- DIVISION T106

      -- Commented by Fowza, Status will be coming from ERP. Date : 14-Apr-2015
      --if vl_status = 0 then
      -- Calculate Head Totals and Head Status
      --LOAD_T10X_HEAD_STEP3( PI_PROGR_H,
       --                     VL_PROGR_D_T100,
       --                     REC_T100,
       --                     VL_STATUS);

      --end if;
      IF (VL_STATUS = 0 ) THEN
          -- when status <> 0 some fields have incorrect format. Log t800 has been already wrote by F_CHECK function
          -- Update article if already exists

           VL_MESSAGE_D := 'Update T100ORDHEAD ';
           UPDATE T100ORDHEAD
           SET
            -- when the field si set to updated by host it means that the value should be read from XIN
               -- otherwise it means that the field is managed by sm1 and it maintains its original value
              CODEUSR = CASE VL_DES_T100('CODEUSR.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODEUSR ELSE CODEUSR END,
              CODTYPORD = CASE VL_DES_T100('CODTYPORD.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODTYPORD ELSE CODTYPORD END,
              CODSTATUS = CASE VL_DES_T100('CODSTATUS.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODSTATUS ELSE CODSTATUS END,
              CODDIV = CASE VL_DES_T100('CODDIV.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODDIV ELSE CODDIV END,
              CODBLCCAUSE = CASE VL_DES_T100('CODBLCCAUSE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODBLCCAUSE ELSE CODBLCCAUSE END,
              DTEORD = CASE VL_DES_T100('DTEORD.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.DTEORD ELSE DTEORD END,
              DTEDELIV = CASE VL_DES_T100('DTEDELIV.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.DTEDELIV ELSE DTEDELIV END,
              CODTYPDELIV = CASE VL_DES_T100('CODTYPDELIV.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODTYPDELIV ELSE CODTYPDELIV END,
              DTEEVA = CASE VL_DES_T100('DTEEVA.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.DTEEVA ELSE DTEEVA END,
              CODPAYTRM = CASE VL_DES_T100('CODPAYTRM.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODPAYTRM ELSE CODPAYTRM END,
              CODPAYMOD = CASE VL_DES_T100('CODPAYMOD.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODPAYMOD ELSE CODPAYMOD END,
              --CODCUSTDELIV = CASE VL_DES_T100('CODCUSTDELIV.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODCUSTDELIV ELSE CODCUSTDELIV END,
              CODVATMGMT = CASE VL_DES_T100('CODVATMGMT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODVATMGMT ELSE CODVATMGMT END,
              --CODCUSTINV = CASE VL_DES_T100('CODCUSTINV.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODCUSTINV ELSE CODCUSTINV END,
              CODLIST = CASE VL_DES_T100('CODLIST.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODLIST ELSE CODLIST END,
              CODCUR = CASE VL_DES_T100('CODCUR.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODCUR ELSE CODCUR END,
              NUMORDREF = CASE VL_DES_T100('NUMORDREF.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.NUMORDREF ELSE NUMORDREF END,
              NUMORDHOST = CASE VL_DES_T100('NUMORDHOST.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.NUMORDHOST ELSE NUMORDHOST END,
              NUMORDCUST = CASE VL_DES_T100('NUMORDCUST.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.NUMORDCUST ELSE NUMORDCUST END,
              DTEORDCUST = CASE VL_DES_T100('DTEORDCUST.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.DTEORDCUST ELSE DTEORDCUST END,
              CODASSORTMENT = CASE VL_DES_T100('CODASSORTMENT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODASSORTMENT ELSE CODASSORTMENT END,
              CODCANVASS = CASE VL_DES_T100('CODCANVASS.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODCANVASS ELSE CODCANVASS END,
              CODMODSHIP = CASE VL_DES_T100('CODMODSHIP.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODMODSHIP ELSE CODMODSHIP END,
              CODMODDELIV = CASE VL_DES_T100('CODMODDELIV.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODMODDELIV ELSE CODMODDELIV END,
              CODAGREEMENT = CASE VL_DES_T100('CODAGREEMENT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODAGREEMENT ELSE CODAGREEMENT END,
              DESAGREEMENT = CASE VL_DES_T100('DESAGREEMENT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.DESAGREEMENT ELSE DESAGREEMENT END,
              CODUSRAUT = CASE VL_DES_T100('CODUSRAUT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODUSRAUT ELSE CODUSRAUT END,
              CODAGREECLASS = CASE VL_DES_T100('CODAGREECLASS.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODAGREECLASS ELSE CODAGREECLASS END,
              DTEAUT = CASE VL_DES_T100('DTEAUT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.DTEAUT ELSE DTEAUT END,
              CODTYPAUT = CASE VL_DES_T100('CODTYPAUT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODTYPAUT ELSE CODTYPAUT END,
              DESAUT = CASE VL_DES_T100('DESAUT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.DESAUT ELSE DESAUT END,

              GROSSAMOUNT = CASE VL_DES_T100('GROSSAMOUNT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.GROSSAMOUNT ELSE GROSSAMOUNT END,
              NETAMOUNT = CASE VL_DES_T100('NETAMOUNT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.NETAMOUNT ELSE NETAMOUNT END,
              TAXAMOUNT = CASE VL_DES_T100('TAXAMOUNT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.TAXAMOUNT ELSE TAXAMOUNT END,
              VATAMOUNT = CASE VL_DES_T100('VATAMOUNT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.VATAMOUNT ELSE VATAMOUNT END,
              INCREASEAMOUNT = CASE VL_DES_T100('INCREASEAMOUNT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.INCREASEAMOUNT ELSE INCREASEAMOUNT END,
              DISCOUNTAMOUNT = CASE VL_DES_T100('DISCOUNTAMOUNT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.DISCOUNTAMOUNT ELSE DISCOUNTAMOUNT END,
              GIFTAMOUNT = CASE VL_DES_T100('GIFTAMOUNT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.GIFTAMOUNT ELSE GIFTAMOUNT END,
              FLGANN = CASE VL_DES_T100('FLGANN.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.FLGANN ELSE FLGANN END,
              CODABI = CASE VL_DES_T100('CODABI.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODABI ELSE CODABI END,
              CODCAB = CASE VL_DES_T100('CODCAB.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODCAB ELSE CODCAB END,
              DESBAN = CASE VL_DES_T100('DESBAN.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.DESBAN ELSE DESBAN END,
              DESBRA = CASE VL_DES_T100('DESBRA.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.DESBRA ELSE DESBRA END,
              DESADDR = CASE VL_DES_T100('DESADDR.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.DESADDR ELSE DESADDR END,
              DESLOC = CASE VL_DES_T100('DESLOC.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.DESLOC ELSE DESLOC END,
              DESPRV = CASE VL_DES_T100('DESPRV.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.DESPRV ELSE DESPRV END,
              QTYTOT = CASE VL_DES_T100('QTYTOT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.QTYTOT ELSE QTYTOT END,
              CODPRV = CASE VL_DES_T100('CODPRV.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODPRV ELSE CODPRV END,
              UMQTYTOT = CASE VL_DES_T100('UMQTYTOT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.UMQTYTOT ELSE UMQTYTOT END,
              CODACCOUNT = CASE VL_DES_T100('CODACCOUNT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODACCOUNT ELSE CODACCOUNT END,
              FLGRETURN = CASE VL_DES_T100('FLGRETURN.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.FLGRETURN ELSE FLGRETURN END,
              FLGHOSTED = CASE VL_DES_T100('FLGHOSTED.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.FLGHOSTED ELSE FLGHOSTED END,
              FLGCONFIRMED = CASE VL_DES_T100('FLGCONFIRMED.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.FLGCONFIRMED ELSE FLGCONFIRMED END,
              --CODWHS = CASE VL_DES_T100('CODWHS.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODWHS ELSE CODWHS END,   ---
              CODSHIPPER = CASE VL_DES_T100('CODSHIPPER.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODSHIPPER ELSE CODSHIPPER END,
              CODAZCAPP = CASE VL_DES_T100('CODAZCAPP.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODAZCAPP ELSE CODAZCAPP END,
              CODAZCBEN = CASE VL_DES_T100('CODAZCBEN.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODAZCBEN ELSE CODAZCBEN END,
              DTEPRICE = CASE VL_DES_T100('DTEPRICE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.DTEPRICE ELSE DTEPRICE END,
              CODTYPSALE = CASE VL_DES_T100('CODTYPSALE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODTYPSALE ELSE CODTYPSALE END,
              FLGCHECKPROMO = CASE VL_DES_T100('FLGCHECKPROMO.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.FLGCHECKPROMO ELSE FLGCHECKPROMO END,
              CODAGREETYPE = CASE VL_DES_T100('CODAGREETYPE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODAGREETYPE ELSE CODAGREETYPE END,
              CODSTATUSMAN = CASE VL_DES_T100('CODSTATUSMAN.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODSTATUSMAN ELSE CODSTATUSMAN END,
              DISCOUNTAMOUNTOUTINV = CASE VL_DES_T100('DISCOUNTAMOUNTOUTINV.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.DISCOUNTAMOUNTOUTINV ELSE DISCOUNTAMOUNTOUTINV END,
              CODTYPORDCUST = CASE VL_DES_T100('CODTYPORDCUST.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODTYPORDCUST ELSE CODTYPORDCUST END,
              CODUSR3 = CASE VL_DES_T100('CODUSR3.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODUSR3 ELSE CODUSR3 END,
              DTEDELIVTO = CASE VL_DES_T100('DTEDELIVTO.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.DTEDELIVTO ELSE DTEDELIVTO END,
              CODCIN = CASE VL_DES_T100('CODCIN.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODCIN ELSE CODCIN END,
              FLGUMORD2 = CASE VL_DES_T100('FLGUMORD2.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.FLGUMORD2 ELSE FLGUMORD2 END,
              NETAMOUNTTEO = CASE VL_DES_T100('NETAMOUNTTEO.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.NETAMOUNTTEO ELSE NETAMOUNTTEO END,
              NETAMOUNTMIN = CASE VL_DES_T100('NETAMOUNTMIN.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.NETAMOUNTMIN ELSE NETAMOUNTMIN END,
              NETAMOUNTMAX = CASE VL_DES_T100('NETAMOUNTMAX.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.NETAMOUNTMAX ELSE NETAMOUNTMAX END,
              CODUSR4 = CASE VL_DES_T100('CODUSR4.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODUSR4 ELSE CODUSR4 END,
              CODUSR2 = CASE VL_DES_T100('CODUSR2.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODUSR2 ELSE CODUSR2 END,
              CODBUYEREDI = CASE VL_DES_T100('CODBUYEREDI.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODBUYEREDI ELSE CODBUYEREDI END,
              --CODCUSTINVEDI = CASE VL_DES_T100('CODCUSTINVEDI.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODCUSTINVEDI ELSE CODCUSTINVEDI END,
              --CODCUSTDELIVEDI = CASE VL_DES_T100('CODCUSTDELIVEDI.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODCUSTDELIVEDI ELSE CODCUSTDELIVEDI END,
              CODSELLEREDI = CASE VL_DES_T100('CODSELLEREDI.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODSELLEREDI ELSE CODSELLEREDI END,

              CODUSR6 = CASE VL_DES_T100('CODUSR6.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODUSR6 ELSE CODUSR6 END,
              CODPDV = CASE VL_DES_T100('CODPDV.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODPDV ELSE CODPDV END,
              CODCUSTCONC = CASE VL_DES_T100('CODCUSTCONC.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODCUSTCONC ELSE CODCUSTCONC END,
              CODIBAN = CASE VL_DES_T100('CODIBAN.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODIBAN ELSE CODIBAN END,
              BACKAMOUNT = CASE VL_DES_T100('BACKAMOUNT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.BACKAMOUNT ELSE BACKAMOUNT END,
              TOTPALLETS = CASE VL_DES_T100('TOTPALLETS.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.TOTPALLETS ELSE TOTPALLETS END,
              GROSSWEIGHT = CASE VL_DES_T100('GROSSWEIGHT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.GROSSWEIGHT ELSE GROSSWEIGHT END,
              TOTMC = CASE VL_DES_T100('TOTMC.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.TOTMC ELSE TOTMC END,
              DTEPROPDELIV = CASE VL_DES_T100('DTEPROPDELIV.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.DTEPROPDELIV ELSE DTEPROPDELIV END,
              CODUSR5 = CASE VL_DES_T100('CODUSR5.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODUSR5 ELSE CODUSR5 END,
              --IDSURVEY = CASE VL_DES_T100('IDSURVEY.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.IDSURVEY ELSE IDSURVEY END,
              --CODCUSTSALE = CASE VL_DES_T100('CODCUSTSALE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODCUSTSALE ELSE CODCUSTSALE END,
              FLGPROCESSEDEDI = CASE VL_DES_T100('FLGPROCESSEDEDI.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.FLGPROCESSEDEDI ELSE FLGPROCESSEDEDI END,
              FLGEDI = CASE VL_DES_T100('FLGEDI.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.FLGEDI ELSE FLGEDI END,
              NUMESENZIONE = CASE VL_DES_T100('NUMESENZIONE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.NUMESENZIONE ELSE NUMESENZIONE END,
              DTEDELIV2 = CASE VL_DES_T100('DTEDELIV2.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.DTEDELIV2 ELSE DTEDELIV2 END,
              DTEDELIV3 = CASE VL_DES_T100('DTEDELIV3.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.DTEDELIV3 ELSE DTEDELIV3 END,
              DTEDELIV4 = CASE VL_DES_T100('DTEDELIV4.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.DTEDELIV4 ELSE DTEDELIV4 END,
              DTEDELIV5 = CASE VL_DES_T100('DTEDELIV5.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.DTEDELIV5 ELSE DTEDELIV5 END,
              IDROUTE = CASE VL_DES_T100('IDROUTE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.IDROUTE ELSE IDROUTE END,
              NUMDOC = CASE VL_DES_T100('NUMDOC.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.NUMDOC ELSE NUMDOC END,
              DTECLOSE = CASE VL_DES_T100('DTECLOSE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.DTECLOSE ELSE DTECLOSE END,
              RETURNAMOUNT = CASE VL_DES_T100('RETURNAMOUNT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.RETURNAMOUNT ELSE RETURNAMOUNT END,

               --- Technical fields
               CODUSRMOD = REC_T100.CODUSRMOD,
               DTEMOD    = REC_T100.DTEMOD,
               -- lock fields
               CODUSRLCK    = REC_T100.CODUSRLCK,
               IDSESSIONLCK = REC_T100.IDSESSIONLCK,
               DTELCK       = REC_T100.DTELCK

         WHERE NUMORD = REC_T100.NUMORD
          AND  CODUSR = REC_T100.CODUSR
          AND (idsessionlck = REC_T100.IDSESSIONLCK
               or not exists
                     ( select null from T035LOGGEDUSERS T035
                      where T035.IDSESSION = NVL(IDSESSIONLCK, '@') AND T035.LASTCHECK > TRUNC(XSYSDATE)-1 )
               );


        END IF; -- VL_STATUS = 0


        EXCEPTION WHEN OTHERS THEN
             VL_STATUS := -1;
             VL_MESSAGE_H := SUBSTR(VL_MESSAGE_H||' '||VL_MESSAGE_D||' '||dbms_utility.format_error_backtrace() || ' ' || SQLERRM,1,4000);

             PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                           VL_PROGR_D_T100,
                                           SQLCODE,
                                           VL_MESSAGE_H);

        END; -- HEAD T100


     -- if all records have been stored with success then it makes the final commit
      IF VL_STATUS = 0 THEN
         VL_INS_T100 := VL_INS_T100 + 1;
         COMMIT;
      ELSE
        ROLLBACK;
      END IF;

      IF (VL_STATUS <> 0 OR VL_RECORD_LOCKED <> 0) THEN
          UPDATE XIN_T106ORDROW
          SET  SM1_STATUS= CASE
                                WHEN VL_RECORD_LOCKED <> 0  THEN C_XINSTATUS_LOCK
                                ELSE C_XINSTATUS_ERR END
          WHERE CODUSR = RL_XIN_T100.CODUSR
           AND  SM1_CODPROCESS = PI_PROGR_H
           AND  SM1_DTECRE     = RL_XIN_T100.SM1_DTECRE
           AND  SM1_STATUS     = C_XINSTATUS_OK;

          -- TO CHECK this update is  not correct in case of double record .
          UPDATE XIN_T100ORDHEAD
          SET  SM1_STATUS= CASE
                                WHEN VL_RECORD_LOCKED <> 0  THEN C_XINSTATUS_LOCK
                                ELSE C_XINSTATUS_ERR END
          WHERE CODUSR = RL_XIN_T100.CODUSR
           AND  SM1_CODPROCESS = PI_PROGR_H
           AND  SM1_DTECRE     <= RL_XIN_T100.SM1_DTECRE
           AND  SM1_STATUS     = C_XINSTATUS_OK;

          COMMIT;
      END IF;

        -- Release updated records
          UPDATE T100ORDHEAD
          SET       DTELCK          = NULL,
                    IDSESSIONLCK    = NULL,
                    CODUSRLCK       = NULL
          WHERE CODUSR = REC_T100.CODUSR AND CODUSRLCK = C_SYSUSR AND IDSESSIONLCK = PI_SESSION_ID;
          COMMIT;
    END LOOP;  -- T100ORDHEAD


    -- Moves records from staging area to log staging area
    P_XIN_MOVE_TO_LOG(PI_PROGR_H, VL_PROGR_D_T100,'T106ORDROW');
    P_XIN_MOVE_TO_LOG(PI_PROGR_H, VL_PROGR_D_T100,'T100ORDHEAD');

   -- Close Logs
    PKG_UTILS.LOG_END_DETAIL(PI_PROGR_H,
                             VL_PROGR_D_T106,
                             0,
                             VL_COUNT_XIN_T106,
                             VL_INS_T106,
                             VL_COUNT_XIN_T106 - VL_INS_T106);

    PKG_UTILS.LOG_END_DETAIL(PI_PROGR_H,
                             VL_PROGR_D_T100,
                             0,
                             VL_COUNT_XIN_T100,
                             VL_INS_T100,
                             VL_COUNT_XIN_T100 - VL_INS_T100);


    PO_MSG    := VL_INS_T100||'/'||VL_COUNT_XIN_T100||' Orders loaded';
    PO_STATUS := VL_INS_T100;


    --
  EXCEPTION WHEN EX_EXIT THEN

          ROLLBACK;
          VL_MESSAGE_H       := VL_MESSAGE_H || TRIM(SUBSTR(dbms_utility.format_error_backtrace() || ' ' || SQLERRM, 1, 255));
          PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                         VL_PROGR_D_T100,
                                         SQLCODE,
                                         VL_MESSAGE_H);

          PO_MSG := VL_MESSAGE_H;
          PO_STATUS := -1;

   WHEN OTHERS THEN

          ROLLBACK;
         -- Release updated records
            UPDATE T100ORDHEAD
            SET       DTELCK          = NULL,
                      IDSESSIONLCK    = NULL,
                      CODUSRLCK       = NULL
            WHERE CODUSRLCK = C_SYSUSR AND IDSESSIONLCK = PI_SESSION_ID;
            COMMIT;
          -- Moves records from staging area to log staging area
          P_XIN_MOVE_TO_LOG(PI_PROGR_H, VL_PROGR_D_T100,'T106ORDROW');
          P_XIN_MOVE_TO_LOG(PI_PROGR_H, VL_PROGR_D_T100,'T100ORDHEAD');

          VL_MESSAGE_H       := VL_MESSAGE_H || TRIM(SUBSTR(dbms_utility.format_error_backtrace() || ' ' || SQLERRM, 1, 255));

          PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                         VL_PROGR_D_T100,
                                         SQLCODE,
                                         VL_MESSAGE_H);

          PO_MSG := VL_MESSAGE_H;
          PO_STATUS := VL_STATUS;

    END;


PROCEDURE LOAD_T100_ORDERS_KD (PI_PROGR_H       IN NUMBER,
                              PI_SESSION_ID    IN NUMBER,
                              PO_MSG           OUT NOCOPY VARCHAR2,
                              PO_STATUS        OUT NOCOPY NUMBER ) IS



    -- -----------------------------------------
    -- Cursor on Orde Heads xin_t100ordhead
    -- -----------------------------------------
    CURSOR CL_XIN_T100 IS
      SELECT
        *
        FROM  XIN_T100ORDHEAD
        WHERE SM1_CODPROCESS = PI_PROGR_H
      AND CODTYPORD IN ('0')
      AND CODSTATUS IN ('15')
        ORDER BY NUMORDHOST, SM1_DTECRE;
    -- -----------------------------------------
    -- Cursor on Order Rows xin_t106_ordrow
    -- -----------------------------------------
    CURSOR CL_XIN_T106(CI_NUMORDHOST VARCHAR2, CI_SM1_DTECRE DATE) IS
      SELECT
        ORDROW.*
  ,T.Codwhs AS VANWHS
        FROM  XIN_T106ORDROW  ORDROW
  INNER JOIN
      T100ORDHEAD T ON ORDROW.NUMORD = T.NUMORD
        WHERE ORDROW.NUMORDHOST = CI_NUMORDHOST
        AND   ORDROW.SM1_CODPROCESS = PI_PROGR_H
        AND ORDROW.SM1_STATUS = C_XINSTATUS_OK -- Only those that have not processed yet (in case of double record in xin)
        ORDER BY ORDROW.SM1_DTECRE;


    --

    VL_MESSAGE_H   VARCHAR2(4000) := 'Error while loading Orders T100/T106';
    VL_MESSAGE_D   VARCHAR2(4000) := NULL;
    --
    VL_PROGR_D_T100    NUMBER := 0;
    VL_COUNT_XIN_T100  NUMBER := 0;
    VL_INS_T100        NUMBER := 0;
    VL_FLG_BCKORD      NUMBER := 0;
    --
    VL_PROGR_D_T106    NUMBER := 0;
    VL_COUNT_XIN_T106  NUMBER := 0;
    VL_INS_T106        NUMBER := 0;
    --
    REC_T100      T100ORDHEAD%ROWTYPE    := NULL;
    REC_T100_INIT T100ORDHEAD%ROWTYPE    := NULL;
    REC_T106      T106ORDROW%ROWTYPE := NULL;
    REC_T106_INIT T106ORDROW%ROWTYPE := NULL;
    --
    VL_DES_T100     X_FIELD_INFO_ARRAY;-- Array with fields db info
    VL_DES_T106     X_FIELD_INFO_ARRAY;-- Array with fields db info
    --
    VL_RECORD_LOCKED NUMBER := 0;

    VL_STATUS NUMBER:= 0;
    VL_STEP   NUMBER:= 0; -- Used to ping t035
    --
    EX_EXIT  EXCEPTION;
    --
    VL_CODDIV VARCHAR2(30) := NULL;
    vl_ins_upd VARCHAR2(3) := NULL;

  BEGIN




    -- init indexes and rebuild statistics
    P_XIN_INIT_INDEXES (PI_PROGR_H, 'T100ORDHEAD');
    P_XIN_INIT_INDEXES (PI_PROGR_H, 'T106ORDROW');
    -- clean log
    P_XIN_CLEANUP_LOG (PI_PROGR_H, 'T100ORDHEAD');
    P_XIN_CLEANUP_LOG (PI_PROGR_H, 'T106ORDROW');


    VL_PROGR_D_T100 := PKG_UTILS.LOG_NEW_DETAIL(PI_PROGR_H,
                                       'ORDER HEAD',
                                       'IMPORT --> T100ORDHEAD 0',
                                        0,
                                        NULL);
    VL_PROGR_D_T106 := PKG_UTILS.LOG_NEW_DETAIL(PI_PROGR_H,
                                       'ORDER ROWS',
                                       'IMPORT --> T106ORDROW 0',
                                        0,
                                        NULL);

    -- retrieves configuration parameters
    LOAD_T10X_CONF_STEP0(
                          VL_MESSAGE_H,
                          VL_STATUS   );

    if (vl_status <> 0 ) then
         PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                        VL_PROGR_D_T100,
                                        SQLCODE,
                                        VL_MESSAGE_H);

          raise EX_EXIT;
    end if;
    BEGIN


        --
        -- ----------------------------------------------------------
        -- Init arrays with FIELD_NAME=LENGTH and FIELDNAME=SM1_DEFAULT for all fields of table
        -- ----------------------------------------------------------
        VL_DES_T100.DELETE;
        P_INIT_SM1_FIELD_ARRAY ('T100ORDHEAD', VL_DES_T100, VL_STATUS, VL_MESSAGE_H);
        execute immediate ( GL_INIT_REC) INTO REC_T100_INIT;


        VL_DES_T106.DELETE;
        P_INIT_SM1_FIELD_ARRAY ('T106ORDROW', VL_DES_T106, VL_STATUS, VL_MESSAGE_H);
        execute immediate ( GL_INIT_REC) INTO REC_T106_INIT;

        IF (VL_STATUS <> 0 ) THEN
            VL_MESSAGE_D := GL_INIT_REC;
            RAISE EX_EXIT;
        END IF;
    EXCEPTION WHEN OTHERS THEN
        VL_MESSAGE_D := GL_INIT_REC;
        RAISE EX_EXIT;
    END;


    -- --------------------------------------------------------------
    -- Identifies Xin records to be loaded
    -- --------------------------------------------------------------
    BEGIN
        VL_MESSAGE_D := 'XIN_T100ORDHEAD';
        UPDATE XIN_T100ORDHEAD
        SET SM1_CODPROCESS = PI_PROGR_H,
            SM1_STATUS = 0,
            SM1_DTEPROCESS = XSYSDATE
            WHERE NVL(SM1_CODPROCESS, 0) = C_SM1_NULL_CODPROCESS;

        VL_COUNT_XIN_T100 := SQL%ROWCOUNT;
        --dbms_output.put_line('t100 pROCESS cOUNT  :-  '||VL_COUNT_XIN_T100 );
        VL_MESSAGE_D := 'XIN_T106ORDROW';
        UPDATE XIN_T106ORDROW D
        SET D.SM1_CODPROCESS = PI_PROGR_H,
            D.SM1_STATUS = 0,
            D.SM1_DTEPROCESS = XSYSDATE
            WHERE 
              NVL(D.SM1_CODPROCESS,0) = C_SM1_NULL_CODPROCESS
            AND D.NUMORDHOST IN ( SELECT H.NUMORDHOST FROM XIN_T100ORDHEAD H WHERE H.SM1_CODPROCESS = PI_PROGR_H 
      );

        VL_COUNT_XIN_T106 := SQL%ROWCOUNT;

    COMMIT;
    EXCEPTION WHEN OTHERS THEN
      ROLLBACK;
      VL_MESSAGE_H := 'Error while Reading Staging area: '||VL_MESSAGE_D;
      RAISE EX_EXIT;

    END;

    -- --------------------------------------------------------------
    -- loop in main table T100ORDHEAD
    -- --------------------------------------------------------------
    FOR RL_XIN_T100 IN CL_XIN_T100 LOOP
     -- pings to t035 every 100 cicles--
      VL_STEP := VL_STEP + 1;

      IF ( MOD(VL_STEP, 100) = 0 ) THEN
         PKG_UTILS.user_ping(PI_SESSION_ID);
      END IF;

      --
      VL_STATUS := 0;
      --
      VL_MESSAGE_H :=   'Order NumordHost : '   ||RL_XIN_T100.NUMORDHOST;
      --
      BEGIN --- HEAD T100

        -- Data Format Check
        VL_MESSAGE_D := 'Format Conversion ';
        VL_CODDIV := 'ALL';
        REC_T100 := REC_T100_INIT;
        --
        REC_T100.CODUSR := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODUSR,'CODUSR', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.NUMORD := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.NUMORD,'NUMORD', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        --
        REC_T100.CODEUSR   := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODEUSR,'CODEUSR', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODTYPORD := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODTYPORD,'CODTYPORD', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODSTATUS := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODSTATUS,'CODSTATUS', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODDIV    := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODDIV,'CODDIV', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODBLCCAUSE := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODBLCCAUSE,'CODBLCCAUSE', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        --REC_T100.DTEORD      := F_CHECK_FORMAT_D( VL_CODDIV, RL_XIN_T100.DTEORD,'DTEORD', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
       -- REC_T100.DTEDELIV    := F_CHECK_FORMAT_D( VL_CODDIV, RL_XIN_T100.DTEDELIV,'DTEDELIV', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODTYPDELIV := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODTYPDELIV,'CODTYPDELIV', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
       -- REC_T100.DTEEVA      := F_CHECK_FORMAT_D( VL_CODDIV, RL_XIN_T100.DTEEVA,'DTEEVA', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODPAYTRM   := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODPAYTRM,'CODPAYTRM', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODPAYMOD   := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODPAYMOD,'CODPAYMOD', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODCUSTDELIV := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODCUSTDELIV,'CODCUSTDELIV', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODVATMGMT   := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODVATMGMT,'CODVATMGMT', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODCUSTINV   := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODCUSTINV,'CODCUSTINV', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODLIST      := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODLIST,'CODLIST', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODCUR       := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODCUR,'CODCUR', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.NUMORDREF    := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.NUMORDREF,'NUMORDREF', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.NUMORDHOST   := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.NUMORDHOST,'NUMORDHOST', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.NUMORDCUST   := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.NUMORDCUST,'NUMORDCUST', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
       -- REC_T100.DTEORDCUST   := F_CHECK_FORMAT_D( VL_CODDIV, RL_XIN_T100.DTEORDCUST,'DTEORDCUST', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODASSORTMENT := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODASSORTMENT,'CODASSORTMENT', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODCANVASS    := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODCANVASS,'CODCANVASS', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODMODSHIP    := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODMODSHIP,'CODMODSHIP', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODMODDELIV   := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODMODDELIV,'CODMODDELIV', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODAGREEMENT  := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.CODAGREEMENT,'CODAGREEMENT', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.DESAGREEMENT  := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.DESAGREEMENT,'DESAGREEMENT', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODUSRAUT     := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODUSRAUT,'CODUSRAUT', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODAGREECLASS := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODAGREECLASS,'CODAGREECLASS', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
       -- REC_T100.DTEAUT        := F_CHECK_FORMAT_D( VL_CODDIV, RL_XIN_T100.DTEAUT,'DTEAUT', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODTYPAUT     := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODTYPAUT,'CODTYPAUT', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.DESAUT        := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.DESAUT,'DESAUT', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.GROSSAMOUNT   := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.GROSSAMOUNT,'GROSSAMOUNT', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.NETAMOUNT     := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.NETAMOUNT,'NETAMOUNT', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.TAXAMOUNT     := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.TAXAMOUNT,'TAXAMOUNT', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.VATAMOUNT     := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.VATAMOUNT,'VATAMOUNT', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.INCREASEAMOUNT := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.INCREASEAMOUNT,'INCREASEAMOUNT', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.DISCOUNTAMOUNT := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.DISCOUNTAMOUNT,'DISCOUNTAMOUNT', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.GIFTAMOUNT     := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.GIFTAMOUNT,'GIFTAMOUNT', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.FLGANN         := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.FLGANN,'FLGANN', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODABI         := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODABI,'CODABI', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODCAB         := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODCAB,'CODCAB', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.DESBAN         := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.DESBAN,'DESBAN', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.DESBRA         := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.DESBRA,'DESBRA', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.DESADDR        := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.DESADDR,'DESADDR', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.DESLOC         := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.DESLOC,'DESLOC', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.DESPRV         := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.DESPRV,'DESPRV', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.QTYTOT         := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.QTYTOT,'QTYTOT', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODPRV         := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODPRV,'CODPRV', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.UMQTYTOT       := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.UMQTYTOT,'UMQTYTOT', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODACCOUNT     := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODACCOUNT,'CODACCOUNT', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.FLGRETURN      := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.FLGRETURN,'FLGRETURN', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.FLGHOSTED      := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.FLGHOSTED,'FLGHOSTED', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.FLGCONFIRMED   := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.FLGCONFIRMED,'FLGCONFIRMED', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        --REC_T100.CODWHS         := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODWHS,'CODWHS', VL_DES_T100,VL_STATUS, VL_MESSAGE_D); --commented because while sending to sage it send as main ware house
        REC_T100.CODSHIPPER     := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODSHIPPER,'CODSHIPPER', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODAZCAPP      := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODAZCAPP,'CODAZCAPP', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODAZCBEN      := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODAZCBEN,'CODAZCBEN', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
       -- REC_T100.DTEPRICE       := F_CHECK_FORMAT_D( VL_CODDIV, RL_XIN_T100.DTEPRICE,'DTEPRICE', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODTYPSALE     := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODTYPSALE,'CODTYPSALE', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.FLGCHECKPROMO  := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.FLGCHECKPROMO,'FLGCHECKPROMO', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODAGREETYPE   := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODAGREETYPE,'CODAGREETYPE', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODSTATUSMAN   := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODSTATUSMAN,'CODSTATUSMAN', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.DISCOUNTAMOUNTOUTINV := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.DISCOUNTAMOUNTOUTINV,'DISCOUNTAMOUNTOUTINV', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODTYPORDCUST        := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODTYPORDCUST,'CODTYPORDCUST', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODUSR3              := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODUSR3,'CODUSR3', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
      --  REC_T100.DTEDELIVTO           := F_CHECK_FORMAT_D( VL_CODDIV, RL_XIN_T100.DTEDELIVTO,'DTEDELIVTO', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODCIN               := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODCIN,'CODCIN', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.FLGUMORD2            := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.FLGUMORD2,'FLGUMORD2', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.NETAMOUNTTEO         := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.NETAMOUNTTEO,'NETAMOUNTTEO', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.NETAMOUNTMIN         := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.NETAMOUNTMIN,'NETAMOUNTMIN', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.NETAMOUNTMAX         := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.NETAMOUNTMAX,'NETAMOUNTMAX', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODUSR4              := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODUSR4,'CODUSR4', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODUSR2              := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODUSR2,'CODUSR2', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODBUYEREDI          := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODBUYEREDI,'CODBUYEREDI', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODCUSTINVEDI        := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODCUSTINVEDI,'CODCUSTINVEDI', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODCUSTDELIVEDI      := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODCUSTDELIVEDI,'CODCUSTDELIVEDI', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODSELLEREDI         := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODSELLEREDI,'CODSELLEREDI', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODUSR6              := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODUSR6,'CODUSR6', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODPDV               := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODPDV,'CODPDV', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODCUSTCONC          := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODCUSTCONC,'CODCUSTCONC', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODIBAN              := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODIBAN,'CODIBAN', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.BACKAMOUNT           := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.BACKAMOUNT,'BACKAMOUNT', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.TOTPALLETS           := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.TOTPALLETS,'TOTPALLETS', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.GROSSWEIGHT          := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.GROSSWEIGHT,'GROSSWEIGHT', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.TOTMC                := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.TOTMC,'TOTMC', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
       -- REC_T100.DTEPROPDELIV         := F_CHECK_FORMAT_D( VL_CODDIV, RL_XIN_T100.DTEPROPDELIV,'DTEPROPDELIV', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODUSR5              := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODUSR5,'CODUSR5', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.IDSURVEY             := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.IDSURVEY,'IDSURVEY', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODCUSTSALE          := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODCUSTSALE,'CODCUSTSALE', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.FLGPROCESSEDEDI      := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.FLGPROCESSEDEDI,'FLGPROCESSEDEDI', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.FLGEDI               := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.FLGEDI,'FLGEDI', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.NUMESENZIONE         := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.NUMESENZIONE,'NUMESENZIONE', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
       -- REC_T100.DTEDELIV2            := F_CHECK_FORMAT_D( VL_CODDIV, RL_XIN_T100.DTEDELIV2,'DTEDELIV2', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
       -- REC_T100.DTEDELIV3            := F_CHECK_FORMAT_D( VL_CODDIV, RL_XIN_T100.DTEDELIV3,'DTEDELIV3', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
       -- REC_T100.DTEDELIV4            := F_CHECK_FORMAT_D( VL_CODDIV, RL_XIN_T100.DTEDELIV4,'DTEDELIV4', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
       -- REC_T100.DTEDELIV5            := F_CHECK_FORMAT_D( VL_CODDIV, RL_XIN_T100.DTEDELIV5,'DTEDELIV5', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
       -- REC_T100.IDROUTE              := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.IDROUTE,'IDROUTE', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
       -- REC_T100.NUMDOC               := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.NUMDOC,'NUMDOC', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
         -- DTECLOSE
         IF( LENGTH(TRIM(TO_CHAR(RL_XIN_T100.DTECLOSE))) <> 0 AND RL_XIN_T100.DTECLOSE IS NOT NULL ) THEN
         REC_T100.DTECLOSE   := RL_XIN_T100.DTECLOSE;
         ELSE
         REC_T100.DTECLOSE             := F_CHECK_FORMAT_D( VL_CODDIV, RL_XIN_T100.DTECLOSE,'DTECLOSE', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
         END IF;
    REC_T100.RETURNAMOUNT         := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.RETURNAMOUNT,'RETURNAMOUNT', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);

        --- Technical fields
        REC_T100.DTECRE     := XSYSDATE;
        REC_T100.CODUSRMOD  := C_SYSUSR;
        REC_T100.DTEMOD     := XSYSDATE;
        REC_T100.CODUSRMODREAL := C_SYSUSR;
        REC_T100.CODUSRCREREAL := C_SYSUSR;
        -- lock fields
        REC_T100.CODUSRLCK     := C_SYSUSR;
        REC_T100.IDSESSIONLCK  := PI_SESSION_ID;
        REC_T100.DTELCK        := XSYSDATE;


        IF (VL_STATUS <> 0 ) THEN

             VL_MESSAGE_H := SUBSTR(VL_MESSAGE_H||' '||VL_MESSAGE_D||' '||dbms_utility.format_error_backtrace() || ' ' || SQLERRM,1,4000);

             PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                           VL_PROGR_D_T100,
                                           SQLCODE,
                                           VL_MESSAGE_H);
        ELSE

            -- Recocgnize SM1 Orders and fit in REC_T100 record updated values
            -- inserts new orders coming from ERP
            LOAD_T10X_HEAD_STEP1_KD( PI_PROGR_H,
                                  VL_PROGR_D_T100,
                                  REC_T100,
                                  VL_STATUS);

        END IF;
        -- -----------------------------------
        -- T106ORDERROW
        -- -----------------------------------
        BEGIN
        --
         dbms_output.put_line('8656 VLSTATUS  '|| VL_STATUS );
        IF ( VL_STATUS = 0  ) THEN
            -- Before updating all rows, we mark them all to recognize those no more sent by ERP
            -- we use a prefix on CODSTATUS
              UPDATE T106ORDROW T
              set T.codstatus =C_T106_STATUS_PREFIX||t.codstatus,

              t.qtyord = '0',t.qtyinv = '0' -- added by vikas , not returned rows from SAGE should be set as zero qty in SM1

              where t.numord = REC_T100.NUMORD
                ;

                VL_FLG_BCKORD := 0;

              FOR RL_XIN_T106 IN CL_XIN_T106(RL_XIN_T100.NUMORDHOST, RL_XIN_T100.SM1_DTECRE)
                 LOOP

                VL_MESSAGE_H := 'Row info: '|| REC_T100.NUMORD|| '/' ||
                                               REC_T100.CODUSR|| '/' ||
                                               RL_XIN_T106.CODDIV || '/' ||
                                               RL_XIN_T106.NUMROWHOST;

                  VL_MESSAGE_D := 'Format Conversion ';
                  VL_CODDIV := RL_XIN_T106.CODDIV;
                  REC_T106  := REC_T106_INIT;
                  ---
                  REC_T106.NUMORD := REC_T100.NUMORD;
                  REC_T106.CODUSR := REC_T100.CODUSR;
                  --
                  REC_T106.NUMROW := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.NUMROW,'NUMROW', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.CODART := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.CODART,'CODART', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.CODDIV := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.CODDIV,'CODDIV', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.UMORD  := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.UMORD,'UMORD', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.DESART := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.DESART,'DESART', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.QTYORD := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.QTYORD,'QTYORD', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.QTYBCKORD := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.QTYBCKORD,'QTYBCKORD', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.QTYANN    := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.QTYANN,'QTYANN', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.QTYDEL    := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.QTYDEL,'QTYDEL', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.UMINV     := REC_T106.UMORD;-- F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.UMINV,'UMINV', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.QTYINV    := REC_T106.QTYORD;-- F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.QTYINV,'QTYINV', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);-- qtyord and qtyinv will be equal in sales responce 
                  REC_T106.CODTYPROW := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.CODTYPROW,'CODTYPROW', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.CODLIST   := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.CODLIST,'CODLIST', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.DTEDELIV  := F_CHECK_FORMAT_D( VL_CODDIV,  RL_XIN_T106.DTEDELIV,'DTEDELIV', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.DTEPROPDELIV := F_CHECK_FORMAT_D( VL_CODDIV,  RL_XIN_T106.DTEPROPDELIV,'DTEPROPDELIV', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.CODSTATUS := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.CODSTATUS,'CODSTATUS', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.CODSHIPPER := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.CODSHIPPER,'CODSHIPPER', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.NUMDOCREF := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.NUMDOCREF,'NUMDOCREF', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.DTEDOCREF := F_CHECK_FORMAT_D( VL_CODDIV,  RL_XIN_T106.DTEDOCREF,'DTEDOCREF', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.GROSSAMOUNT := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.GROSSAMOUNT,'GROSSAMOUNT', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.NUMINV      := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.NUMINV,'NUMINV', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.NETAMOUNT   := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.NETAMOUNT,'NETAMOUNT', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.DTEINV      := F_CHECK_FORMAT_D( VL_CODDIV,  RL_XIN_T106.DTEINV,'DTEINV', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.TAXAMOUNT   := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.TAXAMOUNT,'TAXAMOUNT', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.VATAMOUNT   := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.VATAMOUNT,'VATAMOUNT', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.INCREASEAMOUNT := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.INCREASEAMOUNT,'INCREASEAMOUNT', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.DISCOUNTAMOUNT := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.DISCOUNTAMOUNT,'DISCOUNTAMOUNT', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.GIFTAMOUNT     := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.GIFTAMOUNT,'GIFTAMOUNT', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.ENDUSERPRICE   := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.ENDUSERPRICE,'ENDUSERPRICE', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.CODAZCAPP      := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.CODAZCAPP,'CODAZCAPP', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.FLGEFFBCKORD   := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.FLGEFFBCKORD,'FLGEFFBCKORD', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.CODBCKORDCAUSE := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.CODBCKORDCAUSE,'CODBCKORDCAUSE', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.GROSSARTAMOUNT := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.GROSSARTAMOUNT,'GROSSARTAMOUNT', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.NETARTAMOUNT   := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.NETARTAMOUNT,'NETARTAMOUNT', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.CODSRC         := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.CODSRC,'CODSRC', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.CODSRCREF      := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.CODSRCREF,'CODSRCREF', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.CODBENCAUSE    := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.CODBENCAUSE,'CODBENCAUSE', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.CODBENSUBCAUSE := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.CODBENSUBCAUSE,'CODBENSUBCAUSE', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.BENNOTE        := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.BENNOTE,'BENNOTE', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.AZCTOAPPLY     := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.AZCTOAPPLY,'AZCTOAPPLY', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.CODOPERATION   := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.CODOPERATION,'CODOPERATION', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.DISCOUNTAMOUNTOUTINV := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.DISCOUNTAMOUNTOUTINV,'DISCOUNTAMOUNTOUTINV', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.CODACCAPP            := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.CODACCAPP,'CODACCAPP', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.CODTYPROWCAUSE       := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.CODTYPROWCAUSE,'CODTYPROWCAUSE', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.CODARTCUST           := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.CODARTCUST,'CODARTCUST', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.QTYRESO              := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.QTYRESO,'QTYRESO', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.NUMORDRESO           := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.NUMORDRESO,'NUMORDRESO', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.CODBLCCAUSE          := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.CODBLCCAUSE,'CODBLCCAUSE', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.CODARTKITREF         := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.CODARTKITREF,'CODARTKITREF', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.NUMROWKITREF         := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.NUMROWKITREF,'NUMROWKITREF', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.CODCAUSEKIT          := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.CODCAUSEKIT,'CODCAUSEKIT', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.NETARTAMOUNTTEO      := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.NETARTAMOUNTTEO,'NETARTAMOUNTTEO', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.NETAMOUNTTEO         := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.NETAMOUNTTEO,'NETAMOUNTTEO', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.NETAMOUNTMIN         := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.NETAMOUNTMIN,'NETAMOUNTMIN', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.NETAMOUNTMAX         := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.NETAMOUNTMAX,'NETAMOUNTMAX', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.NETDIFF              := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.NETDIFF,'NETDIFF', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.COD_ABBINAMENTO_KIT  := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.COD_ABBINAMENTO_KIT,'COD_ABBINAMENTO_KIT', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
               --   REC_T106.NUMROWORIG           := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.NUMROWORIG,'NUMROWORIG', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.FLGFIRSTSON          := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.FLGFIRSTSON,'FLGFIRSTSON', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.NETARTAMOUNTCUST     := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.NETARTAMOUNTCUST,'NETARTAMOUNTCUST', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.NETARTAMOUNTCUST2    := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.NETARTAMOUNTCUST2,'NETARTAMOUNTCUST2', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.GROSSARTAMOUNTCUST   := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.GROSSARTAMOUNTCUST,'GROSSARTAMOUNTCUST', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.NETAMOUNTCUST        := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.NETAMOUNTCUST,'NETAMOUNTCUST', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.QTYORDEDI            := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.QTYORDEDI,'QTYORDEDI', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.CODEAN               := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.CODEAN,'CODEAN', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.UMORDEDI             := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.UMORDEDI,'UMORDEDI', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.NUMROWREF            := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.NUMROWREF,'NUMROWREF', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.FLGOMGPROMO          := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.FLGOMGPROMO,'FLGOMGPROMO', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.GROSSARTAMOUNTORD    := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.GROSSARTAMOUNTORD,'GROSSARTAMOUNTORD', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.GROSSARTAMOUNTDELTA  := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.GROSSARTAMOUNTDELTA,'GROSSARTAMOUNTDELTA', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.FLGOMGDISCLIST       := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.FLGOMGDISCLIST,'FLGOMGDISCLIST', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.CODCNVPDA            := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.CODCNVPDA,'CODCNVPDA', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.DTEEVA               := F_CHECK_FORMAT_D( VL_CODDIV,  RL_XIN_T106.DTEEVA,'DTEEVA', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.CODPAYTRM            := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.CODPAYTRM,'CODPAYTRM', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.CODPAYMOD            := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.CODPAYMOD,'CODPAYMOD', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.NUMORDHOST           := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.NUMORDHOST,'NUMORDHOST', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.NUMROWHOST           := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.NUMROWHOST,'NUMROWHOST', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.CODMODSHIP           := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.CODMODSHIP,'CODMODSHIP', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.CODMODDELIV          := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.CODMODDELIV,'CODMODDELIV', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.CODWHS               := RL_XIN_T106.VANWHS ; --F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.VANWHS,'CODWHS', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.DTEPRICE             := F_CHECK_FORMAT_D( VL_CODDIV,  RL_XIN_T106.DTEPRICE,'DTEPRICE', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.DTEDELIVTO           := F_CHECK_FORMAT_D( VL_CODDIV,  RL_XIN_T106.DTEDELIVTO,'DTEDELIVTO', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.CODROWGROUP          := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.CODROWGROUP,'CODROWGROUP', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.NETAMOUNTGIFT        := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.NETAMOUNTGIFT,'NETAMOUNTGIFT', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.NETARTAMOUNTEDI      := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.NETARTAMOUNTEDI,'NETARTAMOUNTEDI', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.GROSSARTAMOUNTEDI    := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.GROSSARTAMOUNTEDI,'GROSSARTAMOUNTEDI', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.QTYORDORIG           := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.QTYORDORIG,'QTYORDORIG', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.QTYALLOCATED         := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.QTYALLOCATED,'QTYALLOCATED', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.RETURNAMOUNT         := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.RETURNAMOUNT,'RETURNAMOUNT', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);

                  -- Technical fields
                  --VL_FLG_BCKORD  QTYORD  QTYORDORIG

                 IF((REC_T106.QTYORDORIG) - (REC_T106.QTYORD) > 0 ) THEN
                   VL_FLG_BCKORD := -1;
                 END IF;

                  dbms_output.put_line(' -- Technical fields VLSTATUS 8778  '|| VL_STATUS );
                 IF (VL_STATUS <> 0 ) THEN


                   VL_MESSAGE_H := SUBSTR(VL_MESSAGE_H||' '||VL_MESSAGE_D||' '||dbms_utility.format_error_backtrace() || ' ' || SQLERRM,1,4000);
                   PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                           VL_PROGR_D_T106,
                                           SQLCODE,
                                           VL_MESSAGE_H);
                ELSE

                 vl_ins_upd := NULL;
                  -- Recognize order lines; inserts new rows ; check the row
                 LOAD_T10X_ROW_STEP2( PI_PROGR_H,
                                      VL_PROGR_D_T106,
                                      REC_T106,
                                      vl_ins_upd,
                                      VL_STATUS);

                END IF;
                --
    --dbms_output.put_line(' -- Technical fields VLSTATUS 8799  '|| VL_STATUS );
              IF (VL_STATUS = 0 ) then
                if (vl_ins_upd = 'UPD') THEN
                VL_MESSAGE_D := 'Update T106 ';
                UPDATE T106ORDROW
                   SET

                  --  CODUSR = CASE VL_DES_T106('CODUSR').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODUSR ELSE CODUSR END,
                  --  NUMORD = CASE VL_DES_T106('NUMORD').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.NUMORD ELSE NUMORD END,
                  --  NUMROW = rec_t106.numrow,
                  --  CODART = CASE VL_DES_T106('CODART').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODART ELSE CODART END,
                  --  CODDIV = CASE VL_DES_T106('CODDIV').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODDIV ELSE CODDIV END,
                    UMORD = CASE VL_DES_T106('UMORD.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.UMORD ELSE UMORD END,
                  --  DESART = CASE VL_DES_T106('DESART.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.DESART ELSE DESART END,
                    QTYORD = CASE VL_DES_T106('QTYORD.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.QTYORD ELSE QTYORD END,
                    --QTYBCKORD = CASE VL_DES_T106('QTYBCKORD.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.QTYBCKORD ELSE QTYBCKORD END,
                      QTYANN = CASE VL_DES_T106('QTYANN.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.QTYANN ELSE QTYANN END,
                    --QTYDEL = CASE VL_DES_T106('QTYDEL.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.QTYDEL ELSE QTYDEL END,
                   -- UMINV = CASE VL_DES_T106('UMINV.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.UMINV ELSE UMINV END,
                    QTYINV = CASE VL_DES_T106('QTYINV.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.QTYINV ELSE QTYINV END,                  
                    --CODTYPROW = CASE VL_DES_T106('CODTYPROW.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODTYPROW ELSE CODTYPROW END,
                    --CODLIST = CASE VL_DES_T106('CODLIST.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODLIST ELSE CODLIST END,
                    --DTEDELIV = CASE VL_DES_T106('DTEDELIV.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.DTEDELIV ELSE DTEDELIV END,
                    --DTEPROPDELIV = CASE VL_DES_T106('DTEPROPDELIV.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.DTEPROPDELIV ELSE DTEPROPDELIV END,
                    CODSTATUS = CASE VL_DES_T106('CODSTATUS.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODSTATUS ELSE CODSTATUS END,
                    --CODSHIPPER = CASE VL_DES_T106('CODSHIPPER.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODSHIPPER ELSE CODSHIPPER END,
                    --NUMDOCREF = CASE VL_DES_T106('NUMDOCREF.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.NUMDOCREF ELSE NUMDOCREF END,
                    --DTEDOCREF = CASE VL_DES_T106('DTEDOCREF.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.DTEDOCREF ELSE DTEDOCREF END,
                    --GROSSAMOUNT = CASE VL_DES_T106('GROSSAMOUNT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.GROSSAMOUNT ELSE GROSSAMOUNT END,
                    --NUMINV = CASE VL_DES_T106('NUMINV.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.NUMINV ELSE NUMINV END,
                    --NETAMOUNT = CASE VL_DES_T106('NETAMOUNT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.NETAMOUNT ELSE NETAMOUNT END,
                    --DTEINV = CASE VL_DES_T106('DTEINV.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.DTEINV ELSE DTEINV END,
                    --TAXAMOUNT = CASE VL_DES_T106('TAXAMOUNT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.TAXAMOUNT ELSE TAXAMOUNT END,
                    --VATAMOUNT = CASE VL_DES_T106('VATAMOUNT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.VATAMOUNT ELSE VATAMOUNT END,
                    --INCREASEAMOUNT = CASE VL_DES_T106('INCREASEAMOUNT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.INCREASEAMOUNT ELSE INCREASEAMOUNT END,
                    --DISCOUNTAMOUNT = CASE VL_DES_T106('DISCOUNTAMOUNT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.DISCOUNTAMOUNT ELSE DISCOUNTAMOUNT END,
                    --GIFTAMOUNT = CASE VL_DES_T106('GIFTAMOUNT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.GIFTAMOUNT ELSE GIFTAMOUNT END,
                    --ENDUSERPRICE = CASE VL_DES_T106('ENDUSERPRICE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.ENDUSERPRICE ELSE ENDUSERPRICE END,
                    --CODAZCAPP = CASE VL_DES_T106('CODAZCAPP.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODAZCAPP ELSE CODAZCAPP END,
                    --FLGEFFBCKORD = CASE VL_DES_T106('FLGEFFBCKORD.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.FLGEFFBCKORD ELSE FLGEFFBCKORD END,
                    --CODBCKORDCAUSE = CASE VL_DES_T106('CODBCKORDCAUSE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODBCKORDCAUSE ELSE CODBCKORDCAUSE END,
                    --GROSSARTAMOUNT = CASE VL_DES_T106('GROSSARTAMOUNT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.GROSSARTAMOUNT ELSE GROSSARTAMOUNT END,
                    --NETARTAMOUNT = CASE VL_DES_T106('NETARTAMOUNT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.NETARTAMOUNT ELSE NETARTAMOUNT END,
                    --CODSRC = CASE VL_DES_T106('CODSRC.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODSRC ELSE CODSRC END,
                    --CODSRCREF = CASE VL_DES_T106('CODSRCREF.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODSRCREF ELSE CODSRCREF END,
                    --CODBENCAUSE = CASE VL_DES_T106('CODBENCAUSE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODBENCAUSE ELSE CODBENCAUSE END,
                    --CODBENSUBCAUSE = CASE VL_DES_T106('CODBENSUBCAUSE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODBENSUBCAUSE ELSE CODBENSUBCAUSE END,
                    --BENNOTE = CASE VL_DES_T106('BENNOTE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.BENNOTE ELSE BENNOTE END,
                    --AZCTOAPPLY = CASE VL_DES_T106('AZCTOAPPLY.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.AZCTOAPPLY ELSE AZCTOAPPLY END,
                   -- CODOPERATION = CASE VL_DES_T106('CODOPERATION.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODOPERATION ELSE CODOPERATION END,
                   -- DISCOUNTAMOUNTOUTINV = CASE VL_DES_T106('DISCOUNTAMOUNTOUTINV.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.DISCOUNTAMOUNTOUTINV ELSE DISCOUNTAMOUNTOUTINV END,
                    --CODACCAPP = CASE VL_DES_T106('CODACCAPP.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODACCAPP ELSE CODACCAPP END,
                    --CODTYPROWCAUSE = CASE VL_DES_T106('CODTYPROWCAUSE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODTYPROWCAUSE ELSE CODTYPROWCAUSE END,
                    --CODARTCUST = CASE VL_DES_T106('CODARTCUST.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODARTCUST ELSE CODARTCUST END,
                    --QTYRESO = CASE VL_DES_T106('QTYRESO.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.QTYRESO ELSE QTYRESO END,
                    --NUMORDRESO = CASE VL_DES_T106('NUMORDRESO.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.NUMORDRESO ELSE NUMORDRESO END,
                    --CODBLCCAUSE = CASE VL_DES_T106('CODBLCCAUSE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODBLCCAUSE ELSE CODBLCCAUSE END,
                    --CODARTKITREF = CASE VL_DES_T106('CODARTKITREF.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODARTKITREF ELSE CODARTKITREF END,
                    --NUMROWKITREF = CASE VL_DES_T106('NUMROWKITREF.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.NUMROWKITREF ELSE NUMROWKITREF END,
                    --CODCAUSEKIT = CASE VL_DES_T106('CODCAUSEKIT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODCAUSEKIT ELSE CODCAUSEKIT END,
                    --NETARTAMOUNTTEO = CASE VL_DES_T106('NETARTAMOUNTTEO.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.NETARTAMOUNTTEO ELSE NETARTAMOUNTTEO END,
                    --NETAMOUNTTEO = CASE VL_DES_T106('NETAMOUNTTEO.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.NETAMOUNTTEO ELSE NETAMOUNTTEO END,
                    --NETAMOUNTMIN = CASE VL_DES_T106('NETAMOUNTMIN.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.NETAMOUNTMIN ELSE NETAMOUNTMIN END,
                    --NETAMOUNTMAX = CASE VL_DES_T106('NETAMOUNTMAX.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.NETAMOUNTMAX ELSE NETAMOUNTMAX END,
                    --NETDIFF = CASE VL_DES_T106('NETDIFF.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.NETDIFF ELSE NETDIFF END,
                    --COD_ABBINAMENTO_KIT = CASE VL_DES_T106('COD_ABBINAMENTO_KIT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.COD_ABBINAMENTO_KIT ELSE COD_ABBINAMENTO_KIT END,
                    --NUMROWORIG = CASE VL_DES_T106('NUMROWORIG.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.NUMROWORIG ELSE NUMROWORIG END,
                    --FLGFIRSTSON = CASE VL_DES_T106('FLGFIRSTSON.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.FLGFIRSTSON ELSE FLGFIRSTSON END,
                    --NETARTAMOUNTCUST = CASE VL_DES_T106('NETARTAMOUNTCUST.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.NETARTAMOUNTCUST ELSE NETARTAMOUNTCUST END,
                    --NETARTAMOUNTCUST2 = CASE VL_DES_T106('NETARTAMOUNTCUST2.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.NETARTAMOUNTCUST2 ELSE NETARTAMOUNTCUST2 END,
                    --GROSSARTAMOUNTCUST = CASE VL_DES_T106('GROSSARTAMOUNTCUST.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.GROSSARTAMOUNTCUST ELSE GROSSARTAMOUNTCUST END,
                    --NETAMOUNTCUST = CASE VL_DES_T106('NETAMOUNTCUST.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.NETAMOUNTCUST ELSE NETAMOUNTCUST END,
                    --QTYORDEDI = CASE VL_DES_T106('QTYORDEDI.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.QTYORDEDI ELSE QTYORDEDI END,
                    --CODEAN = CASE VL_DES_T106('CODEAN.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODEAN ELSE CODEAN END,
                    --UMORDEDI = CASE VL_DES_T106('UMORDEDI.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.UMORDEDI ELSE UMORDEDI END,
                    --NUMROWREF = CASE VL_DES_T106('NUMROWREF.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.NUMROWREF ELSE NUMROWREF END,
                    --FLGOMGPROMO = CASE VL_DES_T106('FLGOMGPROMO.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.FLGOMGPROMO ELSE FLGOMGPROMO END,
                    --GROSSARTAMOUNTORD = CASE VL_DES_T106('GROSSARTAMOUNTORD.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.GROSSARTAMOUNTORD ELSE GROSSARTAMOUNTORD END,
                    --GROSSARTAMOUNTDELTA = CASE VL_DES_T106('GROSSARTAMOUNTDELTA.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.GROSSARTAMOUNTDELTA ELSE GROSSARTAMOUNTDELTA END,
                    --FLGOMGDISCLIST = CASE VL_DES_T106('FLGOMGDISCLIST.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.FLGOMGDISCLIST ELSE FLGOMGDISCLIST END,
                    --CODCNVPDA = CASE VL_DES_T106('CODCNVPDA.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODCNVPDA ELSE CODCNVPDA END,
                    --DTEEVA = CASE VL_DES_T106('DTEEVA.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.DTEEVA ELSE DTEEVA END,
                    --CODPAYTRM = CASE VL_DES_T106('CODPAYTRM.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODPAYTRM ELSE CODPAYTRM END,
                    --CODPAYMOD = CASE VL_DES_T106('CODPAYMOD.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODPAYMOD ELSE CODPAYMOD END,
                    NUMORDHOST = CASE VL_DES_T106('NUMORDHOST.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.NUMORDHOST ELSE NUMORDHOST END,
                    NUMROWHOST = CASE VL_DES_T106('NUMROWHOST.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.NUMROWHOST ELSE NUMROWHOST END  --,
                    --CODMODSHIP = CASE VL_DES_T106('CODMODSHIP.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODMODSHIP ELSE CODMODSHIP END,
                    --CODMODDELIV = CASE VL_DES_T106('CODMODDELIV.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODMODDELIV ELSE CODMODDELIV END,
                    --CODWHS = CASE VL_DES_T106('CODWHS.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODWHS ELSE CODWHS END,
                    --DTEPRICE = CASE VL_DES_T106('DTEPRICE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.DTEPRICE ELSE DTEPRICE END,
                    --DTEDELIVTO = CASE VL_DES_T106('DTEDELIVTO.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.DTEDELIVTO ELSE DTEDELIVTO END,
                    --CODROWGROUP = CASE VL_DES_T106('CODROWGROUP.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODROWGROUP ELSE CODROWGROUP END,
                    --NETAMOUNTGIFT = CASE VL_DES_T106('NETAMOUNTGIFT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.NETAMOUNTGIFT ELSE NETAMOUNTGIFT END,
                    --NETARTAMOUNTEDI = CASE VL_DES_T106('NETARTAMOUNTEDI.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.NETARTAMOUNTEDI ELSE NETARTAMOUNTEDI END,
                    --GROSSARTAMOUNTEDI = CASE VL_DES_T106('GROSSARTAMOUNTEDI.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.GROSSARTAMOUNTEDI ELSE GROSSARTAMOUNTEDI END,
                    --QTYORDORIG = CASE VL_DES_T106('QTYORDORIG.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.QTYORDORIG ELSE QTYORDORIG END,
                    --QTYALLOCATED = CASE VL_DES_T106('QTYALLOCATED.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.QTYALLOCATED ELSE QTYALLOCATED END,
                    --RETURNAMOUNT = CASE VL_DES_T106('RETURNAMOUNT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.RETURNAMOUNT ELSE RETURNAMOUNT END

                 WHERE NUMORD = REC_T106.NUMORD
                   AND NUMROW = REC_T106.NUMROW ;

               else
                  -- record does not exists , we insert it
                  VL_MESSAGE_D := 'Insert T106 ';
                  
                  INSERT INTO T106ORDROW VALUES REC_T106;
               end if;
              VL_INS_T106 := VL_INS_T106 + 1;
             end if;

       END LOOP;   --T106ORDROW
       END IF;
       EXCEPTION WHEN OTHERS THEN
             VL_STATUS := -1;
             VL_MESSAGE_H := SUBSTR(VL_MESSAGE_H||' '||VL_MESSAGE_D||' '||dbms_utility.format_error_backtrace() || ' ' || SQLERRM,1,4000);

             PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                           VL_PROGR_D_T106,
                                           SQLCODE,
                                           VL_MESSAGE_H);

      END; -- DIVISION T106

      -- Commented by Fowza, Status will be coming from ERP. Date : 14-Apr-2015
      --if vl_status = 0 then
      -- Calculate Head Totals and Head Status
      --LOAD_T10X_HEAD_STEP3( PI_PROGR_H,
       --                     VL_PROGR_D_T100,
       --                     REC_T100,
       --                     VL_STATUS);

      --end if;
      IF (VL_STATUS = 0 ) THEN
          -- when status <> 0 some fields have incorrect format. Log t800 has been already wrote by F_CHECK function
          -- Update article if already exists
             INSERT INTO TB_TEST VALUES (REC_T100.NUMORD || 'T100' ,'CODSTATUS' , REC_T100.CODSTATUS );
             COMMIT;
             
           VL_MESSAGE_D := 'Update T100ORDHEAD ';
           UPDATE T100ORDHEAD
           SET
            -- when the field si set to updated by host it means that the value should be read from XIN
               -- otherwise it means that the field is managed by sm1 and it maintains its original value
              CODEUSR = CASE VL_DES_T100('CODEUSR.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODEUSR ELSE CODEUSR END,
              CODTYPORD = CASE VL_DES_T100('CODTYPORD.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODTYPORD ELSE CODTYPORD END,
              CODSTATUS = CASE VL_DES_T100('CODSTATUS.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODSTATUS ELSE CODSTATUS END,
              CODDIV = CASE VL_DES_T100('CODDIV.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODDIV ELSE CODDIV END,
              CODBLCCAUSE = CASE VL_DES_T100('CODBLCCAUSE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODBLCCAUSE ELSE CODBLCCAUSE END,
              DTEORD = CASE VL_DES_T100('DTEORD.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.DTEORD ELSE DTEORD END,
              DTEDELIV = CASE VL_DES_T100('DTEDELIV.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.DTEDELIV ELSE DTEDELIV END,
              CODTYPDELIV = CASE VL_DES_T100('CODTYPDELIV.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODTYPDELIV ELSE CODTYPDELIV END,
              DTEEVA = CASE VL_DES_T100('DTEEVA.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.DTEEVA ELSE DTEEVA END,
              CODPAYTRM = CASE VL_DES_T100('CODPAYTRM.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODPAYTRM ELSE CODPAYTRM END,
              CODPAYMOD = CASE VL_DES_T100('CODPAYMOD.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODPAYMOD ELSE CODPAYMOD END,
              --CODCUSTDELIV = CASE VL_DES_T100('CODCUSTDELIV.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODCUSTDELIV ELSE CODCUSTDELIV END,
              CODVATMGMT = CASE VL_DES_T100('CODVATMGMT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODVATMGMT ELSE CODVATMGMT END,
              --CODCUSTINV = CASE VL_DES_T100('CODCUSTINV.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODCUSTINV ELSE CODCUSTINV END,
              CODLIST = CASE VL_DES_T100('CODLIST.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODLIST ELSE CODLIST END,
              CODCUR = CASE VL_DES_T100('CODCUR.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODCUR ELSE CODCUR END,
              NUMORDREF = CASE VL_DES_T100('NUMORDREF.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.NUMORDREF ELSE NUMORDREF END,
              NUMORDHOST = CASE VL_DES_T100('NUMORDHOST.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.NUMORDHOST ELSE NUMORDHOST END,
              NUMORDCUST = CASE VL_DES_T100('NUMORDCUST.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.NUMORDCUST ELSE NUMORDCUST END,
              DTEORDCUST = CASE VL_DES_T100('DTEORDCUST.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.DTEORDCUST ELSE DTEORDCUST END,
              CODASSORTMENT = CASE VL_DES_T100('CODASSORTMENT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODASSORTMENT ELSE CODASSORTMENT END,
              CODCANVASS = CASE VL_DES_T100('CODCANVASS.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODCANVASS ELSE CODCANVASS END,
              CODMODSHIP = CASE VL_DES_T100('CODMODSHIP.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODMODSHIP ELSE CODMODSHIP END,
              CODMODDELIV = CASE VL_DES_T100('CODMODDELIV.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODMODDELIV ELSE CODMODDELIV END,
              CODAGREEMENT = CASE VL_DES_T100('CODAGREEMENT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODAGREEMENT ELSE CODAGREEMENT END,
              DESAGREEMENT = CASE VL_DES_T100('DESAGREEMENT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.DESAGREEMENT ELSE DESAGREEMENT END,
              CODUSRAUT = CASE VL_DES_T100('CODUSRAUT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODUSRAUT ELSE CODUSRAUT END,
              CODAGREECLASS = CASE VL_DES_T100('CODAGREECLASS.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODAGREECLASS ELSE CODAGREECLASS END,
              DTEAUT = CASE VL_DES_T100('DTEAUT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.DTEAUT ELSE DTEAUT END,
              CODTYPAUT = CASE VL_DES_T100('CODTYPAUT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODTYPAUT ELSE CODTYPAUT END,
              DESAUT = CASE VL_DES_T100('DESAUT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.DESAUT ELSE DESAUT END,

              GROSSAMOUNT = CASE VL_DES_T100('GROSSAMOUNT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.GROSSAMOUNT ELSE GROSSAMOUNT END,
              NETAMOUNT = CASE VL_DES_T100('NETAMOUNT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.NETAMOUNT ELSE NETAMOUNT END,
              TAXAMOUNT = CASE VL_DES_T100('TAXAMOUNT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.TAXAMOUNT ELSE TAXAMOUNT END,
              VATAMOUNT = CASE VL_DES_T100('VATAMOUNT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.VATAMOUNT ELSE VATAMOUNT END,
              INCREASEAMOUNT = CASE VL_DES_T100('INCREASEAMOUNT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.INCREASEAMOUNT ELSE INCREASEAMOUNT END,
              DISCOUNTAMOUNT = CASE VL_DES_T100('DISCOUNTAMOUNT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.DISCOUNTAMOUNT ELSE DISCOUNTAMOUNT END,
              GIFTAMOUNT = CASE VL_DES_T100('GIFTAMOUNT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.GIFTAMOUNT ELSE GIFTAMOUNT END,
              FLGANN = CASE VL_DES_T100('FLGANN.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.FLGANN ELSE FLGANN END,
              CODABI = CASE VL_DES_T100('CODABI.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODABI ELSE CODABI END,
              CODCAB = CASE VL_DES_T100('CODCAB.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODCAB ELSE CODCAB END,
              DESBAN = CASE VL_DES_T100('DESBAN.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.DESBAN ELSE DESBAN END,
              DESBRA = CASE VL_DES_T100('DESBRA.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.DESBRA ELSE DESBRA END,
              DESADDR = CASE VL_DES_T100('DESADDR.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.DESADDR ELSE DESADDR END,
              DESLOC = CASE VL_DES_T100('DESLOC.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.DESLOC ELSE DESLOC END,
              DESPRV = CASE VL_DES_T100('DESPRV.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.DESPRV ELSE DESPRV END,
              QTYTOT = CASE VL_DES_T100('QTYTOT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.QTYTOT ELSE QTYTOT END,
              CODPRV = CASE VL_DES_T100('CODPRV.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODPRV ELSE CODPRV END,
              UMQTYTOT = CASE VL_DES_T100('UMQTYTOT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.UMQTYTOT ELSE UMQTYTOT END,
              CODACCOUNT = CASE VL_DES_T100('CODACCOUNT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODACCOUNT ELSE CODACCOUNT END,
              FLGRETURN = CASE VL_DES_T100('FLGRETURN.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.FLGRETURN ELSE FLGRETURN END,
              FLGHOSTED = CASE VL_DES_T100('FLGHOSTED.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.FLGHOSTED ELSE FLGHOSTED END,
              FLGCONFIRMED = CASE VL_DES_T100('FLGCONFIRMED.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.FLGCONFIRMED ELSE FLGCONFIRMED END,
              --CODWHS = CASE VL_DES_T100('CODWHS.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODWHS ELSE CODWHS END,   ---
              CODSHIPPER = CASE VL_DES_T100('CODSHIPPER.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODSHIPPER ELSE CODSHIPPER END,
              CODAZCAPP = CASE VL_DES_T100('CODAZCAPP.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODAZCAPP ELSE CODAZCAPP END,
              CODAZCBEN = CASE VL_DES_T100('CODAZCBEN.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODAZCBEN ELSE CODAZCBEN END,
              DTEPRICE = CASE VL_DES_T100('DTEPRICE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.DTEPRICE ELSE DTEPRICE END,
              CODTYPSALE = CASE VL_DES_T100('CODTYPSALE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODTYPSALE ELSE CODTYPSALE END,
              FLGCHECKPROMO = CASE VL_DES_T100('FLGCHECKPROMO.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.FLGCHECKPROMO ELSE FLGCHECKPROMO END,
              CODAGREETYPE = CASE VL_DES_T100('CODAGREETYPE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODAGREETYPE ELSE CODAGREETYPE END,
              CODSTATUSMAN = CASE VL_DES_T100('CODSTATUSMAN.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODSTATUSMAN ELSE CODSTATUSMAN END,
              DISCOUNTAMOUNTOUTINV = CASE VL_DES_T100('DISCOUNTAMOUNTOUTINV.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.DISCOUNTAMOUNTOUTINV ELSE DISCOUNTAMOUNTOUTINV END,
              CODTYPORDCUST = CASE VL_DES_T100('CODTYPORDCUST.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODTYPORDCUST ELSE CODTYPORDCUST END,
              CODUSR3 = CASE VL_DES_T100('CODUSR3.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODUSR3 ELSE CODUSR3 END,
              DTEDELIVTO = CASE VL_DES_T100('DTEDELIVTO.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.DTEDELIVTO ELSE DTEDELIVTO END,
              CODCIN = CASE VL_DES_T100('CODCIN.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODCIN ELSE CODCIN END,
              FLGUMORD2 = CASE VL_DES_T100('FLGUMORD2.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.FLGUMORD2 ELSE FLGUMORD2 END,
              NETAMOUNTTEO = CASE VL_DES_T100('NETAMOUNTTEO.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.NETAMOUNTTEO ELSE NETAMOUNTTEO END,
              NETAMOUNTMIN = CASE VL_DES_T100('NETAMOUNTMIN.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.NETAMOUNTMIN ELSE NETAMOUNTMIN END,
              NETAMOUNTMAX = CASE VL_DES_T100('NETAMOUNTMAX.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.NETAMOUNTMAX ELSE NETAMOUNTMAX END,
              CODUSR4 = CASE VL_DES_T100('CODUSR4.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODUSR4 ELSE CODUSR4 END,
              CODUSR2 = CASE VL_DES_T100('CODUSR2.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODUSR2 ELSE CODUSR2 END,
              CODBUYEREDI = CASE VL_DES_T100('CODBUYEREDI.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODBUYEREDI ELSE CODBUYEREDI END,
              --CODCUSTINVEDI = CASE VL_DES_T100('CODCUSTINVEDI.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODCUSTINVEDI ELSE CODCUSTINVEDI END,
              --CODCUSTDELIVEDI = CASE VL_DES_T100('CODCUSTDELIVEDI.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODCUSTDELIVEDI ELSE CODCUSTDELIVEDI END,
              CODSELLEREDI = CASE VL_DES_T100('CODSELLEREDI.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODSELLEREDI ELSE CODSELLEREDI END,

              CODUSR6 = CASE VL_DES_T100('CODUSR6.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODUSR6 ELSE CODUSR6 END,
              CODPDV = CASE VL_DES_T100('CODPDV.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODPDV ELSE CODPDV END,
              CODCUSTCONC = CASE VL_DES_T100('CODCUSTCONC.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODCUSTCONC ELSE CODCUSTCONC END,
              CODIBAN = CASE VL_DES_T100('CODIBAN.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODIBAN ELSE CODIBAN END,
              BACKAMOUNT = CASE VL_DES_T100('BACKAMOUNT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.BACKAMOUNT ELSE BACKAMOUNT END,
              TOTPALLETS = CASE VL_DES_T100('TOTPALLETS.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.TOTPALLETS ELSE TOTPALLETS END,
              GROSSWEIGHT = CASE VL_DES_T100('GROSSWEIGHT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.GROSSWEIGHT ELSE GROSSWEIGHT END,
              TOTMC = CASE VL_DES_T100('TOTMC.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.TOTMC ELSE TOTMC END,
              DTEPROPDELIV = CASE VL_DES_T100('DTEPROPDELIV.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.DTEPROPDELIV ELSE DTEPROPDELIV END,
              CODUSR5 = CASE VL_DES_T100('CODUSR5.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODUSR5 ELSE CODUSR5 END,
              --IDSURVEY = CASE VL_DES_T100('IDSURVEY.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.IDSURVEY ELSE IDSURVEY END,
              --CODCUSTSALE = CASE VL_DES_T100('CODCUSTSALE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODCUSTSALE ELSE CODCUSTSALE END,
              FLGPROCESSEDEDI = CASE VL_DES_T100('FLGPROCESSEDEDI.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.FLGPROCESSEDEDI ELSE FLGPROCESSEDEDI END,
              FLGEDI = CASE VL_DES_T100('FLGEDI.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.FLGEDI ELSE FLGEDI END,
              NUMESENZIONE = CASE VL_DES_T100('NUMESENZIONE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.NUMESENZIONE ELSE NUMESENZIONE END,
              DTEDELIV2 = CASE VL_DES_T100('DTEDELIV2.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.DTEDELIV2 ELSE DTEDELIV2 END,
              DTEDELIV3 = CASE VL_DES_T100('DTEDELIV3.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.DTEDELIV3 ELSE DTEDELIV3 END,
              DTEDELIV4 = CASE VL_DES_T100('DTEDELIV4.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.DTEDELIV4 ELSE DTEDELIV4 END,
              DTEDELIV5 = CASE VL_DES_T100('DTEDELIV5.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.DTEDELIV5 ELSE DTEDELIV5 END,
              IDROUTE = CASE VL_DES_T100('IDROUTE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.IDROUTE ELSE IDROUTE END,
              NUMDOC = CASE VL_DES_T100('NUMDOC.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.NUMDOC ELSE NUMDOC END,
              DTECLOSE = CASE VL_DES_T100('DTECLOSE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.DTECLOSE ELSE DTECLOSE END,
              RETURNAMOUNT = CASE VL_DES_T100('RETURNAMOUNT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.RETURNAMOUNT ELSE RETURNAMOUNT END,
              Z_FLGCREATEBACKORDER= VL_FLG_BCKORD,
               --- Technical fields
               CODUSRMOD = REC_T100.CODUSRMOD,
               DTEMOD    = REC_T100.DTEMOD,
               -- lock fields
               CODUSRLCK    = REC_T100.CODUSRLCK,
               IDSESSIONLCK = REC_T100.IDSESSIONLCK,
               DTELCK       = REC_T100.DTELCK,
               
               -- SET DTETOHOST = MINDATE REQUEST FROM DAL IN THIS CASE THEY CAN EDIT THE ORDER.. MADY
               DTETOHOST = TO_DATE('12/30/1899','MM/DD/YYYY')

         WHERE NUMORD = REC_T100.NUMORD
          AND  CODUSR = REC_T100.CODUSR
          AND REC_T100.CODSTATUS IN ('15') --ADD BY MADY TO UPDATE JUST PREALLOCATED ORDER COME FROM ERP 
          AND (idsessionlck = REC_T100.IDSESSIONLCK
               or not exists
                     ( select null from T035LOGGEDUSERS T035
                      where T035.IDSESSION = NVL(IDSESSIONLCK, '@') AND T035.LASTCHECK > TRUNC(XSYSDATE)-1 )
               );

                  

        END IF; -- VL_STATUS = 0
      

        EXCEPTION WHEN OTHERS THEN
             VL_STATUS := -1;
             VL_MESSAGE_H := SUBSTR(VL_MESSAGE_H||' '||VL_MESSAGE_D||' '||dbms_utility.format_error_backtrace() || ' ' || SQLERRM,1,4000);

             PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                           VL_PROGR_D_T100,
                                           SQLCODE,
                                           VL_MESSAGE_H);

        END; -- HEAD T100


     -- if all records have been stored with success then it makes the final commit
      IF VL_STATUS = 0 THEN
         VL_INS_T100 := VL_INS_T100 + 1;
         COMMIT;
      ELSE
        ROLLBACK;
      END IF;

      IF (VL_STATUS <> 0 OR VL_RECORD_LOCKED <> 0) THEN
          UPDATE XIN_T106ORDROW
          SET  SM1_STATUS= CASE
                                WHEN VL_RECORD_LOCKED <> 0  THEN C_XINSTATUS_LOCK
                                ELSE C_XINSTATUS_ERR END
          WHERE CODUSR = RL_XIN_T100.CODUSR
           AND  SM1_CODPROCESS = PI_PROGR_H
           AND  SM1_DTECRE     = RL_XIN_T100.SM1_DTECRE
           AND  SM1_STATUS     = C_XINSTATUS_OK;

          -- TO CHECK this update is  not correct in case of double record .
          UPDATE XIN_T100ORDHEAD
          SET  SM1_STATUS= CASE
                                WHEN VL_RECORD_LOCKED <> 0  THEN C_XINSTATUS_LOCK
                                ELSE C_XINSTATUS_ERR END
          WHERE CODUSR = RL_XIN_T100.CODUSR
           AND  SM1_CODPROCESS = PI_PROGR_H
           AND  SM1_DTECRE     <= RL_XIN_T100.SM1_DTECRE
           AND  SM1_STATUS     = C_XINSTATUS_OK;

          COMMIT;
      END IF;

        -- Release updated records
          UPDATE T100ORDHEAD
          SET       DTELCK          = NULL,
                    IDSESSIONLCK    = NULL,
                    CODUSRLCK       = NULL
          WHERE CODUSR = REC_T100.CODUSR AND CODUSRLCK = C_SYSUSR AND IDSESSIONLCK = PI_SESSION_ID;
          COMMIT;
    END LOOP;  -- T100ORDHEAD


    -- Moves records from staging area to log staging area
    P_XIN_MOVE_TO_LOG(PI_PROGR_H, VL_PROGR_D_T100,'T106ORDROW');
    P_XIN_MOVE_TO_LOG(PI_PROGR_H, VL_PROGR_D_T100,'T100ORDHEAD');

   -- Close Logs
    PKG_UTILS.LOG_END_DETAIL(PI_PROGR_H,
                             VL_PROGR_D_T106,
                             0,
                             VL_COUNT_XIN_T106,
                             VL_INS_T106,
                             VL_COUNT_XIN_T106 - VL_INS_T106);

    PKG_UTILS.LOG_END_DETAIL(PI_PROGR_H,
                             VL_PROGR_D_T100,
                             0,
                             VL_COUNT_XIN_T100,
                             VL_INS_T100,
                             VL_COUNT_XIN_T100 - VL_INS_T100);


    PO_MSG    := VL_INS_T100||'/'||VL_COUNT_XIN_T100||' Orders loaded';
    PO_STATUS := VL_INS_T100;


    --
  EXCEPTION WHEN EX_EXIT THEN

          ROLLBACK;
          VL_MESSAGE_H       := VL_MESSAGE_H || TRIM(SUBSTR(dbms_utility.format_error_backtrace() || ' ' || SQLERRM, 1, 255));
          PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                         VL_PROGR_D_T100,
                                         SQLCODE,
                                         VL_MESSAGE_H);

          PO_MSG := VL_MESSAGE_H;
          PO_STATUS := -1;

   WHEN OTHERS THEN

          ROLLBACK;
         -- Release updated records
            UPDATE T100ORDHEAD
            SET       DTELCK          = NULL,
                      IDSESSIONLCK    = NULL,
                      CODUSRLCK       = NULL
            WHERE CODUSRLCK = C_SYSUSR AND IDSESSIONLCK = PI_SESSION_ID;
            COMMIT;
          -- Moves records from staging area to log staging area
          P_XIN_MOVE_TO_LOG(PI_PROGR_H, VL_PROGR_D_T100,'T106ORDROW');
          P_XIN_MOVE_TO_LOG(PI_PROGR_H, VL_PROGR_D_T100,'T100ORDHEAD');

          VL_MESSAGE_H       := VL_MESSAGE_H || TRIM(SUBSTR(dbms_utility.format_error_backtrace() || ' ' || SQLERRM, 1, 255));

          PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                         VL_PROGR_D_T100,
                                         SQLCODE,
                                         VL_MESSAGE_H);

          PO_MSG := VL_MESSAGE_H;
          PO_STATUS := VL_STATUS;


    END;


PROCEDURE LOAD_T100_ORDERS_50 (PI_PROGR_H       IN NUMBER,
                              PI_SESSION_ID    IN NUMBER,
                              PO_MSG           OUT NOCOPY VARCHAR2,
                              PO_STATUS        OUT NOCOPY NUMBER ) IS



    -- -----------------------------------------
    -- Cursor on Orde Heads xin_t100ordhead
    -- -----------------------------------------
    CURSOR CL_XIN_T100 IS
      SELECT
        *
        FROM  XIN_T100ORDHEAD
        WHERE SM1_CODPROCESS = PI_PROGR_H
    AND CODTYPORD IN ('50')
        ORDER BY NUMORDHOST, SM1_DTECRE;
    -- -----------------------------------------
    -- Cursor on Order Rows xin_t106_ordrow
    -- -----------------------------------------
    CURSOR CL_XIN_T106(CI_NUMORDHOST VARCHAR2, CI_SM1_DTECRE DATE) IS
      SELECT
        ORDROW.*
  ,T.Codwhs AS VANWHS
        FROM  XIN_T106ORDROW  ORDROW
  INNER JOIN
      T100ORDHEAD T ON ORDROW.NUMORD = T.NUMORD
        WHERE ORDROW.NUMORDHOST = CI_NUMORDHOST
        AND   ORDROW.SM1_CODPROCESS = PI_PROGR_H
    -- AND   ORDROW.SM1_DTECRE <= CI_SM1_DTECRE   -- vikas , no need to compare creation time of header and row
        AND ORDROW.SM1_STATUS = C_XINSTATUS_OK -- Only those that have not processed yet (in case of double record in xin)
        ORDER BY ORDROW.SM1_DTECRE;


    --

    VL_MESSAGE_H   VARCHAR2(4000) := 'Error while loading Orders T100/T106';
    VL_MESSAGE_D   VARCHAR2(4000) := NULL;
    --
    VL_PROGR_D_T100    NUMBER := 0;
    VL_COUNT_XIN_T100  NUMBER := 0;
    VL_INS_T100        NUMBER := 0;
    --
    VL_PROGR_D_T106    NUMBER := 0;
    VL_COUNT_XIN_T106  NUMBER := 0;
    VL_INS_T106        NUMBER := 0;
    --
    REC_T100      T100ORDHEAD%ROWTYPE    := NULL;
    REC_T100_INIT T100ORDHEAD%ROWTYPE    := NULL;
    REC_T106      T106ORDROW%ROWTYPE := NULL;
    REC_T106_INIT T106ORDROW%ROWTYPE := NULL;
    --
    VL_DES_T100     X_FIELD_INFO_ARRAY;-- Array with fields db info
    VL_DES_T106     X_FIELD_INFO_ARRAY;-- Array with fields db info
    --
    VL_RECORD_LOCKED NUMBER := 0;

    VL_STATUS NUMBER:= 0;
    VL_STEP   NUMBER:= 0; -- Used to ping t035
    --
    EX_EXIT  EXCEPTION;
    --
    VL_CODDIV VARCHAR2(30) := NULL;
    vl_ins_upd VARCHAR2(3) := NULL;

  BEGIN




    -- init indexes and rebuild statistics
    P_XIN_INIT_INDEXES (PI_PROGR_H, 'T100ORDHEAD');
    P_XIN_INIT_INDEXES (PI_PROGR_H, 'T106ORDROW');
    -- clean log
    P_XIN_CLEANUP_LOG (PI_PROGR_H, 'T100ORDHEAD');
    P_XIN_CLEANUP_LOG (PI_PROGR_H, 'T106ORDROW');


    VL_PROGR_D_T100 := PKG_UTILS.LOG_NEW_DETAIL(PI_PROGR_H,
                                       'ORDER HEAD',
                                       'IMPORT --> T100ORDHEAD 50',
                                        0,
                                        NULL);
    VL_PROGR_D_T106 := PKG_UTILS.LOG_NEW_DETAIL(PI_PROGR_H,
                                       'ORDER ROWS',

                                       'IMPORT --> T106ORDROW 50',
                                        0,
                                        NULL);

    -- retrieves configuration parameters
    LOAD_T10X_CONF_STEP0(
                          VL_MESSAGE_H,
                          VL_STATUS   );

    if (vl_status <> 0 ) then
         PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                        VL_PROGR_D_T100,
                                        SQLCODE,
                                        VL_MESSAGE_H);

          raise EX_EXIT;
    end if;
    BEGIN


        --
        -- ----------------------------------------------------------
        -- Init arrays with FIELD_NAME=LENGTH and FIELDNAME=SM1_DEFAULT for all fields of table
        -- ----------------------------------------------------------
        VL_DES_T100.DELETE;
        P_INIT_SM1_FIELD_ARRAY ('T100ORDHEAD', VL_DES_T100, VL_STATUS, VL_MESSAGE_H);
        execute immediate ( GL_INIT_REC) INTO REC_T100_INIT;


        VL_DES_T106.DELETE;
        P_INIT_SM1_FIELD_ARRAY ('T106ORDROW', VL_DES_T106, VL_STATUS, VL_MESSAGE_H);
        execute immediate ( GL_INIT_REC) INTO REC_T106_INIT;

        IF (VL_STATUS <> 0 ) THEN
            VL_MESSAGE_D := GL_INIT_REC;
            RAISE EX_EXIT;
        END IF;
    EXCEPTION WHEN OTHERS THEN
        VL_MESSAGE_D := GL_INIT_REC;
        RAISE EX_EXIT;
    END;


    -- --------------------------------------------------------------
    -- Identifies Xin records to be loaded
    -- --------------------------------------------------------------
    BEGIN
        VL_MESSAGE_D := 'XIN_T100ORDHEAD';
        UPDATE XIN_T100ORDHEAD
        SET SM1_CODPROCESS = PI_PROGR_H,
            SM1_STATUS = 0,
            SM1_DTEPROCESS = XSYSDATE
            WHERE NVL(SM1_CODPROCESS, 0) = C_SM1_NULL_CODPROCESS
      AND CODDIV IN ('DFI','DDF')
      AND CODTYPORD IN ('50') ;
      dbms_output.put_line('no of header rows updated = ' || SQL%ROWCOUNT);
    dbms_output.put_line('xin_t100 - SM1_CODPROCESS = ' || PI_PROGR_H );
  

        VL_MESSAGE_D := 'XIN_T106ORDROW';
    
        UPDATE XIN_T106ORDROW D
        SET D.SM1_CODPROCESS = PI_PROGR_H,
            D.SM1_STATUS = 0,
            D.SM1_DTEPROCESS = XSYSDATE
            WHERE 
              NVL(D.SM1_CODPROCESS,0) = C_SM1_NULL_CODPROCESS
            AND D.NUMORDHOST IN ( SELECT H.NUMORDHOST FROM XIN_T100ORDHEAD H WHERE H.SM1_CODPROCESS = PI_PROGR_H 
      AND CODDIV IN ('DFI','DDF')
      AND CODTYPORD IN ('50')) ;
           
       dbms_output.put_line('no of t106 rows updated = ' || SQL%ROWCOUNT );
        dbms_output.put_line('xin_t106 - SM1_CODPROCESS = ' || PI_PROGR_H );
    
    COMMIT;
  
    EXCEPTION WHEN OTHERS THEN
      ROLLBACK;
      VL_MESSAGE_H := 'Error while Reading Staging area: '||VL_MESSAGE_D;
      RAISE EX_EXIT;

    END;

    -- --------------------------------------------------------------
    -- loop in main table T100ORDHEAD
    -- --------------------------------------------------------------
    FOR RL_XIN_T100 IN CL_XIN_T100 LOOP
     -- pings to t035 every 100 cicles--
      VL_STEP := VL_STEP + 1;

      IF ( MOD(VL_STEP, 100) = 0 ) THEN
         PKG_UTILS.user_ping(PI_SESSION_ID);
      END IF;

      --
      VL_STATUS := 0;
      --
      VL_MESSAGE_H :=   'Order NumordHost : '   ||RL_XIN_T100.NUMORDHOST;
      --
      BEGIN --- HEAD T100

        -- Data Format Check
        VL_MESSAGE_D := 'Format Conversion ';
        VL_CODDIV := 'ALL';
        REC_T100 := REC_T100_INIT;
        --
        REC_T100.CODUSR := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODUSR,'CODUSR', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.NUMORD := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.NUMORD,'NUMORD', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        --
        REC_T100.CODEUSR   := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODEUSR,'CODEUSR', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODTYPORD := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODTYPORD,'CODTYPORD', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODSTATUS := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODSTATUS,'CODSTATUS', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODDIV    := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODDIV,'CODDIV', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODBLCCAUSE := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODBLCCAUSE,'CODBLCCAUSE', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.DTEORD      := F_CHECK_FORMAT_D( VL_CODDIV, RL_XIN_T100.DTEORD,'DTEORD', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.DTEDELIV    := F_CHECK_FORMAT_D( VL_CODDIV, RL_XIN_T100.DTEDELIV,'DTEDELIV', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODTYPDELIV := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODTYPDELIV,'CODTYPDELIV', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.DTEEVA      := F_CHECK_FORMAT_D( VL_CODDIV, RL_XIN_T100.DTEEVA,'DTEEVA', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODPAYTRM   := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODPAYTRM,'CODPAYTRM', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODPAYMOD   := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODPAYMOD,'CODPAYMOD', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODCUSTDELIV := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODCUSTDELIV,'CODCUSTDELIV', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODVATMGMT   := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODVATMGMT,'CODVATMGMT', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODCUSTINV   := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODCUSTINV,'CODCUSTINV', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODLIST      := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODLIST,'CODLIST', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODCUR       := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODCUR,'CODCUR', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.NUMORDREF    := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.NUMORDREF,'NUMORDREF', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.NUMORDHOST   := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.NUMORDHOST,'NUMORDHOST', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.NUMORDCUST   := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.NUMORDCUST,'NUMORDCUST', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.DTEORDCUST   := F_CHECK_FORMAT_D( VL_CODDIV, RL_XIN_T100.DTEORDCUST,'DTEORDCUST', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODASSORTMENT := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODASSORTMENT,'CODASSORTMENT', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODCANVASS    := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODCANVASS,'CODCANVASS', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODMODSHIP    := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODMODSHIP,'CODMODSHIP', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODMODDELIV   := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODMODDELIV,'CODMODDELIV', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODAGREEMENT  := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.CODAGREEMENT,'CODAGREEMENT', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.DESAGREEMENT  := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.DESAGREEMENT,'DESAGREEMENT', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODUSRAUT     := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODUSRAUT,'CODUSRAUT', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODAGREECLASS := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODAGREECLASS,'CODAGREECLASS', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.DTEAUT        := F_CHECK_FORMAT_D( VL_CODDIV, RL_XIN_T100.DTEAUT,'DTEAUT', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODTYPAUT     := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODTYPAUT,'CODTYPAUT', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.DESAUT        := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.DESAUT,'DESAUT', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.GROSSAMOUNT   := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.GROSSAMOUNT,'GROSSAMOUNT', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.NETAMOUNT     := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.NETAMOUNT,'NETAMOUNT', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.TAXAMOUNT     := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.TAXAMOUNT,'TAXAMOUNT', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.VATAMOUNT     := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.VATAMOUNT,'VATAMOUNT', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.INCREASEAMOUNT := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.INCREASEAMOUNT,'INCREASEAMOUNT', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.DISCOUNTAMOUNT := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.DISCOUNTAMOUNT,'DISCOUNTAMOUNT', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.GIFTAMOUNT     := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.GIFTAMOUNT,'GIFTAMOUNT', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.FLGANN         := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.FLGANN,'FLGANN', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODABI         := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODABI,'CODABI', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODCAB         := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODCAB,'CODCAB', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.DESBAN         := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.DESBAN,'DESBAN', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.DESBRA         := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.DESBRA,'DESBRA', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.DESADDR        := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.DESADDR,'DESADDR', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.DESLOC         := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.DESLOC,'DESLOC', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.DESPRV         := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.DESPRV,'DESPRV', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.QTYTOT         := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.QTYTOT,'QTYTOT', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODPRV         := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODPRV,'CODPRV', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.UMQTYTOT       := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.UMQTYTOT,'UMQTYTOT', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODACCOUNT     := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODACCOUNT,'CODACCOUNT', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.FLGRETURN      := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.FLGRETURN,'FLGRETURN', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.FLGHOSTED      := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.FLGHOSTED,'FLGHOSTED', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.FLGCONFIRMED   := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.FLGCONFIRMED,'FLGCONFIRMED', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        --REC_T100.CODWHS         := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODWHS,'CODWHS', VL_DES_T100,VL_STATUS, VL_MESSAGE_D); --commented because while sending to sage it send as main ware house
        REC_T100.CODSHIPPER     := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODSHIPPER,'CODSHIPPER', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODAZCAPP      := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODAZCAPP,'CODAZCAPP', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODAZCBEN      := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODAZCBEN,'CODAZCBEN', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.DTEPRICE       := F_CHECK_FORMAT_D( VL_CODDIV, RL_XIN_T100.DTEPRICE,'DTEPRICE', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODTYPSALE     := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODTYPSALE,'CODTYPSALE', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.FLGCHECKPROMO  := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.FLGCHECKPROMO,'FLGCHECKPROMO', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODAGREETYPE   := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODAGREETYPE,'CODAGREETYPE', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODSTATUSMAN   := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODSTATUSMAN,'CODSTATUSMAN', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.DISCOUNTAMOUNTOUTINV := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.DISCOUNTAMOUNTOUTINV,'DISCOUNTAMOUNTOUTINV', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODTYPORDCUST        := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODTYPORDCUST,'CODTYPORDCUST', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODUSR3              := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODUSR3,'CODUSR3', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.DTEDELIVTO           := F_CHECK_FORMAT_D( VL_CODDIV, RL_XIN_T100.DTEDELIVTO,'DTEDELIVTO', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODCIN               := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODCIN,'CODCIN', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.FLGUMORD2            := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.FLGUMORD2,'FLGUMORD2', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.NETAMOUNTTEO         := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.NETAMOUNTTEO,'NETAMOUNTTEO', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.NETAMOUNTMIN         := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.NETAMOUNTMIN,'NETAMOUNTMIN', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.NETAMOUNTMAX         := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.NETAMOUNTMAX,'NETAMOUNTMAX', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODUSR4              := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODUSR4,'CODUSR4', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODUSR2              := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODUSR2,'CODUSR2', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODBUYEREDI          := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODBUYEREDI,'CODBUYEREDI', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODCUSTINVEDI        := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODCUSTINVEDI,'CODCUSTINVEDI', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODCUSTDELIVEDI      := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODCUSTDELIVEDI,'CODCUSTDELIVEDI', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODSELLEREDI         := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODSELLEREDI,'CODSELLEREDI', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODUSR6              := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODUSR6,'CODUSR6', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODPDV               := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODPDV,'CODPDV', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODCUSTCONC          := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODCUSTCONC,'CODCUSTCONC', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODIBAN              := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODIBAN,'CODIBAN', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.BACKAMOUNT           := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.BACKAMOUNT,'BACKAMOUNT', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.TOTPALLETS           := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.TOTPALLETS,'TOTPALLETS', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.GROSSWEIGHT          := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.GROSSWEIGHT,'GROSSWEIGHT', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.TOTMC                := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.TOTMC,'TOTMC', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.DTEPROPDELIV         := F_CHECK_FORMAT_D( VL_CODDIV, RL_XIN_T100.DTEPROPDELIV,'DTEPROPDELIV', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODUSR5              := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODUSR5,'CODUSR5', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.IDSURVEY             := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.IDSURVEY,'IDSURVEY', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODCUSTSALE          := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODCUSTSALE,'CODCUSTSALE', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.FLGPROCESSEDEDI      := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.FLGPROCESSEDEDI,'FLGPROCESSEDEDI', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.FLGEDI               := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.FLGEDI,'FLGEDI', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.NUMESENZIONE         := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.NUMESENZIONE,'NUMESENZIONE', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.DTEDELIV2            := F_CHECK_FORMAT_D( VL_CODDIV, RL_XIN_T100.DTEDELIV2,'DTEDELIV2', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.DTEDELIV3            := F_CHECK_FORMAT_D( VL_CODDIV, RL_XIN_T100.DTEDELIV3,'DTEDELIV3', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.DTEDELIV4            := F_CHECK_FORMAT_D( VL_CODDIV, RL_XIN_T100.DTEDELIV4,'DTEDELIV4', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.DTEDELIV5            := F_CHECK_FORMAT_D( VL_CODDIV, RL_XIN_T100.DTEDELIV5,'DTEDELIV5', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.IDROUTE              := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.IDROUTE,'IDROUTE', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.NUMDOC               := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.NUMDOC,'NUMDOC', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
         -- DTECLOSE
         IF( LENGTH(TRIM(TO_CHAR(RL_XIN_T100.DTECLOSE))) <> 0 AND RL_XIN_T100.DTECLOSE IS NOT NULL ) THEN
         REC_T100.DTECLOSE   := RL_XIN_T100.DTECLOSE;
         ELSE
         REC_T100.DTECLOSE             := F_CHECK_FORMAT_D( VL_CODDIV, RL_XIN_T100.DTECLOSE,'DTECLOSE', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
         END IF;
    REC_T100.RETURNAMOUNT         := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.RETURNAMOUNT,'RETURNAMOUNT', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);

        --- Technical fields
        REC_T100.DTECRE     := XSYSDATE;
        REC_T100.CODUSRMOD  := C_SYSUSR;
        REC_T100.DTEMOD     := XSYSDATE;
        REC_T100.CODUSRMODREAL := C_SYSUSR;
        REC_T100.CODUSRCREREAL := C_SYSUSR;
        -- lock fields
        REC_T100.CODUSRLCK     := C_SYSUSR;
        REC_T100.IDSESSIONLCK  := PI_SESSION_ID;
        REC_T100.DTELCK        := XSYSDATE;
    
    dbms_output.put_line(' VLSTATUS after asigning t100 values  '|| VL_STATUS );


        IF (VL_STATUS <> 0 ) THEN

             VL_MESSAGE_H := SUBSTR(VL_MESSAGE_H||' '||VL_MESSAGE_D||' '||dbms_utility.format_error_backtrace() || ' ' || SQLERRM,1,4000);

             PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                           VL_PROGR_D_T100,
                                           SQLCODE,
                                           VL_MESSAGE_H);
        /* ELSE    
             Recocgnize SM1 Orders and fit in REC_T100 record updated values
            inserts new orders coming from ERP
            LOAD_T10X_HEAD_STEP1( PI_PROGR_H,
                                VL_PROGR_D_T100,
                                 REC_T100,
                                 VL_STATUS); */ --- COMMENTED BY VIKAS

        END IF;
        -- -----------------------------------
        -- T106ORDERROW
        -- -----------------------------------
        BEGIN
        --
         dbms_output.put_line(' VLSTATUS before updating row qty is  '|| VL_STATUS );
        IF ( VL_STATUS = 0  ) THEN
            -- Before updating all rows, we mark them all to recognize those no more sent by ERP
            -- we use a prefix on CODSTATUS
            
           
            
        UPDATE T106ORDROW T
              set T.codstatus =C_T106_STATUS_PREFIX||t.codstatus,

              t.qtyord = '0',t.qtyinv = '0' -- added by vikas , not returned rows from SAGE should be set as zero qty in SM1

              where t.numord = REC_T100.NUMORD
                --and t.codusr = REC_T100.CODUSR
                ;
        
         
         dbms_output.put_line('starting t106 loop ' );
     VL_MESSAGE_H := RL_XIN_T100.NUMORDHOST || '&' || RL_XIN_T100.SM1_DTECRE;
     dbms_output.put_line(VL_MESSAGE_H );
              FOR RL_XIN_T106 IN CL_XIN_T106(RL_XIN_T100.NUMORDHOST, RL_XIN_T100.SM1_DTECRE)
                 LOOP
         dbms_output.put_line('starting VL_MESSAGE ' );
                VL_MESSAGE_H := 'Row info: '|| REC_T100.NUMORD|| '/' ||
                                               REC_T100.CODUSR|| '/' ||
                                               RL_XIN_T106.CODDIV || '/' ||
                                               RL_XIN_T106.NUMROWHOST;
      dbms_output.put_line('VL_MESSAGE finished' );                  

                  VL_MESSAGE_D := 'Format Conversion ';
                  VL_CODDIV := RL_XIN_T106.CODDIV;
                  REC_T106  := REC_T106_INIT;
                  ---
                  REC_T106.NUMORD := REC_T100.NUMORD;
                  REC_T106.CODUSR := REC_T100.CODUSR;
                  --
                  REC_T106.NUMROW := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.NUMROW,'NUMROW', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.CODART := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.CODART,'CODART', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.CODDIV := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.CODDIV,'CODDIV', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.UMORD  := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.UMORD,'UMORD', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.DESART := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.DESART,'DESART', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.QTYORD := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.QTYORD,'QTYORD', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.QTYBCKORD := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.QTYBCKORD,'QTYBCKORD', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.QTYANN    := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.QTYANN,'QTYANN', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.QTYDEL    := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.QTYDEL,'QTYDEL', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.UMINV     := REC_T106.UMORD;-- F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.UMINV,'UMINV', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.QTYINV    := REC_T106.QTYORD;-- F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.QTYINV,'QTYINV', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);-- qtyord and qtyinv will be equal in sales responce 
                  REC_T106.CODTYPROW := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.CODTYPROW,'CODTYPROW', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.CODLIST   := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.CODLIST,'CODLIST', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.DTEDELIV  := F_CHECK_FORMAT_D( VL_CODDIV,  RL_XIN_T106.DTEDELIV,'DTEDELIV', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.DTEPROPDELIV := F_CHECK_FORMAT_D( VL_CODDIV,  RL_XIN_T106.DTEPROPDELIV,'DTEPROPDELIV', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.CODSTATUS := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.CODSTATUS,'CODSTATUS', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.CODSHIPPER := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.CODSHIPPER,'CODSHIPPER', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.NUMDOCREF := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.NUMDOCREF,'NUMDOCREF', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.DTEDOCREF := F_CHECK_FORMAT_D( VL_CODDIV,  RL_XIN_T106.DTEDOCREF,'DTEDOCREF', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.GROSSAMOUNT := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.GROSSAMOUNT,'GROSSAMOUNT', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.NUMINV      := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.NUMINV,'NUMINV', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.NETAMOUNT   := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.NETAMOUNT,'NETAMOUNT', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.DTEINV      := F_CHECK_FORMAT_D( VL_CODDIV,  RL_XIN_T106.DTEINV,'DTEINV', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.TAXAMOUNT   := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.TAXAMOUNT,'TAXAMOUNT', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.VATAMOUNT   := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.VATAMOUNT,'VATAMOUNT', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.INCREASEAMOUNT := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.INCREASEAMOUNT,'INCREASEAMOUNT', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.DISCOUNTAMOUNT := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.DISCOUNTAMOUNT,'DISCOUNTAMOUNT', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.GIFTAMOUNT     := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.GIFTAMOUNT,'GIFTAMOUNT', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.ENDUSERPRICE   := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.ENDUSERPRICE,'ENDUSERPRICE', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.CODAZCAPP      := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.CODAZCAPP,'CODAZCAPP', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.FLGEFFBCKORD   := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.FLGEFFBCKORD,'FLGEFFBCKORD', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.CODBCKORDCAUSE := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.CODBCKORDCAUSE,'CODBCKORDCAUSE', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.GROSSARTAMOUNT := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.GROSSARTAMOUNT,'GROSSARTAMOUNT', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.NETARTAMOUNT   := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.NETARTAMOUNT,'NETARTAMOUNT', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.CODSRC         := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.CODSRC,'CODSRC', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.CODSRCREF      := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.CODSRCREF,'CODSRCREF', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.CODBENCAUSE    := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.CODBENCAUSE,'CODBENCAUSE', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.CODBENSUBCAUSE := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.CODBENSUBCAUSE,'CODBENSUBCAUSE', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.BENNOTE        := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.BENNOTE,'BENNOTE', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.AZCTOAPPLY     := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.AZCTOAPPLY,'AZCTOAPPLY', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.CODOPERATION   := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.CODOPERATION,'CODOPERATION', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.DISCOUNTAMOUNTOUTINV := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.DISCOUNTAMOUNTOUTINV,'DISCOUNTAMOUNTOUTINV', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.CODACCAPP            := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.CODACCAPP,'CODACCAPP', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.CODTYPROWCAUSE       := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.CODTYPROWCAUSE,'CODTYPROWCAUSE', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.CODARTCUST           := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.CODARTCUST,'CODARTCUST', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.QTYRESO              := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.QTYRESO,'QTYRESO', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.NUMORDRESO           := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.NUMORDRESO,'NUMORDRESO', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.CODBLCCAUSE          := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.CODBLCCAUSE,'CODBLCCAUSE', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.CODARTKITREF         := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.CODARTKITREF,'CODARTKITREF', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.NUMROWKITREF         := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.NUMROWKITREF,'NUMROWKITREF', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.CODCAUSEKIT          := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.CODCAUSEKIT,'CODCAUSEKIT', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.NETARTAMOUNTTEO      := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.NETARTAMOUNTTEO,'NETARTAMOUNTTEO', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.NETAMOUNTTEO         := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.NETAMOUNTTEO,'NETAMOUNTTEO', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.NETAMOUNTMIN         := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.NETAMOUNTMIN,'NETAMOUNTMIN', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.NETAMOUNTMAX         := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.NETAMOUNTMAX,'NETAMOUNTMAX', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.NETDIFF              := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.NETDIFF,'NETDIFF', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.COD_ABBINAMENTO_KIT  := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.COD_ABBINAMENTO_KIT,'COD_ABBINAMENTO_KIT', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.NUMROWORIG           := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.NUMROWORIG,'NUMROWORIG', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.FLGFIRSTSON          := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.FLGFIRSTSON,'FLGFIRSTSON', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.NETARTAMOUNTCUST     := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.NETARTAMOUNTCUST,'NETARTAMOUNTCUST', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.NETARTAMOUNTCUST2    := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.NETARTAMOUNTCUST2,'NETARTAMOUNTCUST2', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.GROSSARTAMOUNTCUST   := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.GROSSARTAMOUNTCUST,'GROSSARTAMOUNTCUST', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.NETAMOUNTCUST        := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.NETAMOUNTCUST,'NETAMOUNTCUST', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.QTYORDEDI            := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.QTYORDEDI,'QTYORDEDI', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.CODEAN               := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.CODEAN,'CODEAN', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.UMORDEDI             := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.UMORDEDI,'UMORDEDI', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.NUMROWREF            := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.NUMROWREF,'NUMROWREF', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.FLGOMGPROMO          := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.FLGOMGPROMO,'FLGOMGPROMO', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.GROSSARTAMOUNTORD    := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.GROSSARTAMOUNTORD,'GROSSARTAMOUNTORD', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.GROSSARTAMOUNTDELTA  := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.GROSSARTAMOUNTDELTA,'GROSSARTAMOUNTDELTA', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.FLGOMGDISCLIST       := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.FLGOMGDISCLIST,'FLGOMGDISCLIST', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.CODCNVPDA            := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.CODCNVPDA,'CODCNVPDA', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.DTEEVA               := F_CHECK_FORMAT_D( VL_CODDIV,  RL_XIN_T106.DTEEVA,'DTEEVA', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.CODPAYTRM            := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.CODPAYTRM,'CODPAYTRM', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.CODPAYMOD            := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.CODPAYMOD,'CODPAYMOD', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.NUMORDHOST           := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.NUMORDHOST,'NUMORDHOST', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.NUMROWHOST           := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.NUMROWHOST,'NUMROWHOST', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.CODMODSHIP           := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.CODMODSHIP,'CODMODSHIP', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.CODMODDELIV          := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.CODMODDELIV,'CODMODDELIV', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.CODWHS               := RL_XIN_T106.VANWHS ; --F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.VANWHS,'CODWHS', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.DTEPRICE             := F_CHECK_FORMAT_D( VL_CODDIV,  RL_XIN_T106.DTEPRICE,'DTEPRICE', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.DTEDELIVTO           := F_CHECK_FORMAT_D( VL_CODDIV,  RL_XIN_T106.DTEDELIVTO,'DTEDELIVTO', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.CODROWGROUP          := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.CODROWGROUP,'CODROWGROUP', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.NETAMOUNTGIFT        := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.NETAMOUNTGIFT,'NETAMOUNTGIFT', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.NETARTAMOUNTEDI      := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.NETARTAMOUNTEDI,'NETARTAMOUNTEDI', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.GROSSARTAMOUNTEDI    := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.GROSSARTAMOUNTEDI,'GROSSARTAMOUNTEDI', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.QTYORDORIG           := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.QTYORDORIG,'QTYORDORIG', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.QTYALLOCATED         := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.QTYALLOCATED,'QTYALLOCATED', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.RETURNAMOUNT         := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.RETURNAMOUNT,'RETURNAMOUNT', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);

                  -- Technical fields
                  --

                  dbms_output.put_line(' -- Technical fields VLSTATUS 8778  '|| VL_STATUS );
                 IF (VL_STATUS <> 0 ) THEN


                   VL_MESSAGE_H := SUBSTR(VL_MESSAGE_H||' '||VL_MESSAGE_D||' '||dbms_utility.format_error_backtrace() || ' ' || SQLERRM,1,4000);
                   PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                           VL_PROGR_D_T106,
                                           SQLCODE,
                                           VL_MESSAGE_H);
                ELSE

                 vl_ins_upd := NULL;
          dbms_output.put_line(' STARTING LOAD_T10X_ROW_STEP2' );
                  -- Recognize order lines; inserts new rows ; check the row
                 LOAD_T10X_ROW_STEP2( PI_PROGR_H,
                                      VL_PROGR_D_T106,
                                      REC_T106,
                                      vl_ins_upd,
                                      VL_STATUS);
        dbms_output.put_line(' FINISHED  LOAD_T10X_ROW_STEP2' );            

                END IF;
                --
    dbms_output.put_line('line 12270 VL_STATUS = '|| VL_STATUS || 'vl_ins_upd = ' || vl_ins_upd );
              IF (VL_STATUS = 0 ) then
               if (vl_ins_upd = 'UPD') THEN
                VL_MESSAGE_D := 'Update T106 ';
                UPDATE T106ORDROW
                   SET

                  --  CODUSR = CASE VL_DES_T106('CODUSR').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODUSR ELSE CODUSR END,
                  --  NUMORD = CASE VL_DES_T106('NUMORD').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.NUMORD ELSE NUMORD END,
                  --  NUMROW = rec_t106.numrow,
                  --  CODART = CASE VL_DES_T106('CODART').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODART ELSE CODART END,
                  --  CODDIV = CASE VL_DES_T106('CODDIV').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODDIV ELSE CODDIV END,
                    UMORD = CASE VL_DES_T106('UMORD.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.UMORD ELSE UMORD END,
                  --  DESART = CASE VL_DES_T106('DESART.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.DESART ELSE DESART END,
                    QTYORD = CASE VL_DES_T106('QTYORD.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.QTYORD ELSE QTYORD END,
                    --QTYBCKORD = CASE VL_DES_T106('QTYBCKORD.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.QTYBCKORD ELSE QTYBCKORD END,
                    --QTYANN = CASE VL_DES_T106('QTYANN.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.QTYANN ELSE QTYANN END,
                    --QTYDEL = CASE VL_DES_T106('QTYDEL.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.QTYDEL ELSE QTYDEL END,
                   -- UMINV = CASE VL_DES_T106('UMINV.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.UMINV ELSE UMINV END,
                    QTYINV = CASE VL_DES_T106('QTYINV.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.QTYINV ELSE QTYINV END,                  
                    --CODTYPROW = CASE VL_DES_T106('CODTYPROW.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODTYPROW ELSE CODTYPROW END,
                    --CODLIST = CASE VL_DES_T106('CODLIST.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODLIST ELSE CODLIST END,
                    --DTEDELIV = CASE VL_DES_T106('DTEDELIV.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.DTEDELIV ELSE DTEDELIV END,
                    --DTEPROPDELIV = CASE VL_DES_T106('DTEPROPDELIV.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.DTEPROPDELIV ELSE DTEPROPDELIV END,
                    CODSTATUS = CASE VL_DES_T106('CODSTATUS.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODSTATUS ELSE CODSTATUS END,
                    --CODSHIPPER = CASE VL_DES_T106('CODSHIPPER.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODSHIPPER ELSE CODSHIPPER END,
                    --NUMDOCREF = CASE VL_DES_T106('NUMDOCREF.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.NUMDOCREF ELSE NUMDOCREF END,
                    --DTEDOCREF = CASE VL_DES_T106('DTEDOCREF.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.DTEDOCREF ELSE DTEDOCREF END,
                    --GROSSAMOUNT = CASE VL_DES_T106('GROSSAMOUNT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.GROSSAMOUNT ELSE GROSSAMOUNT END,
                    --NUMINV = CASE VL_DES_T106('NUMINV.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.NUMINV ELSE NUMINV END,
                    --NETAMOUNT = CASE VL_DES_T106('NETAMOUNT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.NETAMOUNT ELSE NETAMOUNT END,
                    --DTEINV = CASE VL_DES_T106('DTEINV.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.DTEINV ELSE DTEINV END,
                    --TAXAMOUNT = CASE VL_DES_T106('TAXAMOUNT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.TAXAMOUNT ELSE TAXAMOUNT END,
                    --VATAMOUNT = CASE VL_DES_T106('VATAMOUNT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.VATAMOUNT ELSE VATAMOUNT END,
                    --INCREASEAMOUNT = CASE VL_DES_T106('INCREASEAMOUNT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.INCREASEAMOUNT ELSE INCREASEAMOUNT END,
                    --DISCOUNTAMOUNT = CASE VL_DES_T106('DISCOUNTAMOUNT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.DISCOUNTAMOUNT ELSE DISCOUNTAMOUNT END,
                    --GIFTAMOUNT = CASE VL_DES_T106('GIFTAMOUNT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.GIFTAMOUNT ELSE GIFTAMOUNT END,
                    --ENDUSERPRICE = CASE VL_DES_T106('ENDUSERPRICE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.ENDUSERPRICE ELSE ENDUSERPRICE END,
                    --CODAZCAPP = CASE VL_DES_T106('CODAZCAPP.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODAZCAPP ELSE CODAZCAPP END,
                    --FLGEFFBCKORD = CASE VL_DES_T106('FLGEFFBCKORD.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.FLGEFFBCKORD ELSE FLGEFFBCKORD END,
                    --CODBCKORDCAUSE = CASE VL_DES_T106('CODBCKORDCAUSE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODBCKORDCAUSE ELSE CODBCKORDCAUSE END,
                    --GROSSARTAMOUNT = CASE VL_DES_T106('GROSSARTAMOUNT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.GROSSARTAMOUNT ELSE GROSSARTAMOUNT END,
                    --NETARTAMOUNT = CASE VL_DES_T106('NETARTAMOUNT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.NETARTAMOUNT ELSE NETARTAMOUNT END,
                    --CODSRC = CASE VL_DES_T106('CODSRC.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODSRC ELSE CODSRC END,
                    --CODSRCREF = CASE VL_DES_T106('CODSRCREF.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODSRCREF ELSE CODSRCREF END,
                    --CODBENCAUSE = CASE VL_DES_T106('CODBENCAUSE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODBENCAUSE ELSE CODBENCAUSE END,
                    --CODBENSUBCAUSE = CASE VL_DES_T106('CODBENSUBCAUSE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODBENSUBCAUSE ELSE CODBENSUBCAUSE END,
                    --BENNOTE = CASE VL_DES_T106('BENNOTE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.BENNOTE ELSE BENNOTE END,
                    --AZCTOAPPLY = CASE VL_DES_T106('AZCTOAPPLY.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.AZCTOAPPLY ELSE AZCTOAPPLY END,
                   -- CODOPERATION = CASE VL_DES_T106('CODOPERATION.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODOPERATION ELSE CODOPERATION END,
                   -- DISCOUNTAMOUNTOUTINV = CASE VL_DES_T106('DISCOUNTAMOUNTOUTINV.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.DISCOUNTAMOUNTOUTINV ELSE DISCOUNTAMOUNTOUTINV END,
                    --CODACCAPP = CASE VL_DES_T106('CODACCAPP.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODACCAPP ELSE CODACCAPP END,
                    --CODTYPROWCAUSE = CASE VL_DES_T106('CODTYPROWCAUSE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODTYPROWCAUSE ELSE CODTYPROWCAUSE END,
                    --CODARTCUST = CASE VL_DES_T106('CODARTCUST.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODARTCUST ELSE CODARTCUST END,
                    --QTYRESO = CASE VL_DES_T106('QTYRESO.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.QTYRESO ELSE QTYRESO END,
                    --NUMORDRESO = CASE VL_DES_T106('NUMORDRESO.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.NUMORDRESO ELSE NUMORDRESO END,
                    --CODBLCCAUSE = CASE VL_DES_T106('CODBLCCAUSE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODBLCCAUSE ELSE CODBLCCAUSE END,
                    --CODARTKITREF = CASE VL_DES_T106('CODARTKITREF.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODARTKITREF ELSE CODARTKITREF END,
                    --NUMROWKITREF = CASE VL_DES_T106('NUMROWKITREF.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.NUMROWKITREF ELSE NUMROWKITREF END,
                    --CODCAUSEKIT = CASE VL_DES_T106('CODCAUSEKIT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODCAUSEKIT ELSE CODCAUSEKIT END,
                    --NETARTAMOUNTTEO = CASE VL_DES_T106('NETARTAMOUNTTEO.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.NETARTAMOUNTTEO ELSE NETARTAMOUNTTEO END,
                    --NETAMOUNTTEO = CASE VL_DES_T106('NETAMOUNTTEO.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.NETAMOUNTTEO ELSE NETAMOUNTTEO END,
                    --NETAMOUNTMIN = CASE VL_DES_T106('NETAMOUNTMIN.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.NETAMOUNTMIN ELSE NETAMOUNTMIN END,
                    --NETAMOUNTMAX = CASE VL_DES_T106('NETAMOUNTMAX.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.NETAMOUNTMAX ELSE NETAMOUNTMAX END,
                    --NETDIFF = CASE VL_DES_T106('NETDIFF.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.NETDIFF ELSE NETDIFF END,
                    --COD_ABBINAMENTO_KIT = CASE VL_DES_T106('COD_ABBINAMENTO_KIT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.COD_ABBINAMENTO_KIT ELSE COD_ABBINAMENTO_KIT END,
                    --NUMROWORIG = CASE VL_DES_T106('NUMROWORIG.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.NUMROWORIG ELSE NUMROWORIG END,
                    --FLGFIRSTSON = CASE VL_DES_T106('FLGFIRSTSON.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.FLGFIRSTSON ELSE FLGFIRSTSON END,
                    --NETARTAMOUNTCUST = CASE VL_DES_T106('NETARTAMOUNTCUST.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.NETARTAMOUNTCUST ELSE NETARTAMOUNTCUST END,
                    --NETARTAMOUNTCUST2 = CASE VL_DES_T106('NETARTAMOUNTCUST2.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.NETARTAMOUNTCUST2 ELSE NETARTAMOUNTCUST2 END,
                    --GROSSARTAMOUNTCUST = CASE VL_DES_T106('GROSSARTAMOUNTCUST.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.GROSSARTAMOUNTCUST ELSE GROSSARTAMOUNTCUST END,
                    --NETAMOUNTCUST = CASE VL_DES_T106('NETAMOUNTCUST.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.NETAMOUNTCUST ELSE NETAMOUNTCUST END,
                    --QTYORDEDI = CASE VL_DES_T106('QTYORDEDI.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.QTYORDEDI ELSE QTYORDEDI END,
                    --CODEAN = CASE VL_DES_T106('CODEAN.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODEAN ELSE CODEAN END,
                    --UMORDEDI = CASE VL_DES_T106('UMORDEDI.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.UMORDEDI ELSE UMORDEDI END,
                    --NUMROWREF = CASE VL_DES_T106('NUMROWREF.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.NUMROWREF ELSE NUMROWREF END,
                    --FLGOMGPROMO = CASE VL_DES_T106('FLGOMGPROMO.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.FLGOMGPROMO ELSE FLGOMGPROMO END,
                    --GROSSARTAMOUNTORD = CASE VL_DES_T106('GROSSARTAMOUNTORD.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.GROSSARTAMOUNTORD ELSE GROSSARTAMOUNTORD END,
                    --GROSSARTAMOUNTDELTA = CASE VL_DES_T106('GROSSARTAMOUNTDELTA.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.GROSSARTAMOUNTDELTA ELSE GROSSARTAMOUNTDELTA END,
                    --FLGOMGDISCLIST = CASE VL_DES_T106('FLGOMGDISCLIST.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.FLGOMGDISCLIST ELSE FLGOMGDISCLIST END,
                    --CODCNVPDA = CASE VL_DES_T106('CODCNVPDA.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODCNVPDA ELSE CODCNVPDA END,
                    --DTEEVA = CASE VL_DES_T106('DTEEVA.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.DTEEVA ELSE DTEEVA END,
                    --CODPAYTRM = CASE VL_DES_T106('CODPAYTRM.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODPAYTRM ELSE CODPAYTRM END,
                    --CODPAYMOD = CASE VL_DES_T106('CODPAYMOD.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODPAYMOD ELSE CODPAYMOD END,
                    NUMORDHOST = CASE VL_DES_T106('NUMORDHOST.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.NUMORDHOST ELSE NUMORDHOST END,
                    NUMROWHOST = CASE VL_DES_T106('NUMROWHOST.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.NUMROWHOST ELSE NUMROWHOST END  --,
                    --CODMODSHIP = CASE VL_DES_T106('CODMODSHIP.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODMODSHIP ELSE CODMODSHIP END,
                    --CODMODDELIV = CASE VL_DES_T106('CODMODDELIV.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODMODDELIV ELSE CODMODDELIV END,
                    --CODWHS = CASE VL_DES_T106('CODWHS.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODWHS ELSE CODWHS END,
                    --DTEPRICE = CASE VL_DES_T106('DTEPRICE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.DTEPRICE ELSE DTEPRICE END,
                    --DTEDELIVTO = CASE VL_DES_T106('DTEDELIVTO.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.DTEDELIVTO ELSE DTEDELIVTO END,
                    --CODROWGROUP = CASE VL_DES_T106('CODROWGROUP.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODROWGROUP ELSE CODROWGROUP END,
                    --NETAMOUNTGIFT = CASE VL_DES_T106('NETAMOUNTGIFT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.NETAMOUNTGIFT ELSE NETAMOUNTGIFT END,
                    --NETARTAMOUNTEDI = CASE VL_DES_T106('NETARTAMOUNTEDI.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.NETARTAMOUNTEDI ELSE NETARTAMOUNTEDI END,
                    --GROSSARTAMOUNTEDI = CASE VL_DES_T106('GROSSARTAMOUNTEDI.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.GROSSARTAMOUNTEDI ELSE GROSSARTAMOUNTEDI END,
                    --QTYORDORIG = CASE VL_DES_T106('QTYORDORIG.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.QTYORDORIG ELSE QTYORDORIG END,
                    --QTYALLOCATED = CASE VL_DES_T106('QTYALLOCATED.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.QTYALLOCATED ELSE QTYALLOCATED END,
                    --RETURNAMOUNT = CASE VL_DES_T106('RETURNAMOUNT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.RETURNAMOUNT ELSE RETURNAMOUNT END

                 WHERE NUMORD = REC_T106.NUMORD
                   --AND CODUSR = REC_T106.CODUSR
                   AND NUMROW = REC_T106.NUMROW ;

               else
                  -- record does not exists , we insert it
                  VL_MESSAGE_D := 'Insert T106 ';
                  
                  INSERT INTO T106ORDROW VALUES REC_T106;
               end if;
              VL_INS_T106 := VL_INS_T106 + 1;
             end if;

       END LOOP;   --T106ORDROW
       END IF;
       EXCEPTION WHEN OTHERS THEN
             VL_STATUS := -1;
             VL_MESSAGE_H := SUBSTR(VL_MESSAGE_H||' '||VL_MESSAGE_D||' '||dbms_utility.format_error_backtrace() || ' ' || SQLERRM,1,4000);

             PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                           VL_PROGR_D_T106,
                                           SQLCODE,
                                           VL_MESSAGE_H);

      END; -- DIVISION T106

      -- Commented by Fowza, Status will be coming from ERP. Date : 14-Apr-2015
      --if vl_status = 0 then
      -- Calculate Head Totals and Head Status
      --LOAD_T10X_HEAD_STEP3( PI_PROGR_H,
       --                     VL_PROGR_D_T100,
       --                     REC_T100,
       --                     VL_STATUS);

      --end if;
      IF (VL_STATUS = 0 ) THEN
          -- when status <> 0 some fields have incorrect format. Log t800 has been already wrote by F_CHECK function
          -- Update article if already exists

           VL_MESSAGE_D := 'Update T100ORDHEAD ';
           UPDATE T100ORDHEAD
           SET
            -- when the field si set to updated by host it means that the value should be read from XIN
               -- otherwise it means that the field is managed by sm1 and it maintains its original value
              CODEUSR = CASE VL_DES_T100('CODEUSR.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODEUSR ELSE CODEUSR END,
              CODTYPORD = CASE VL_DES_T100('CODTYPORD.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODTYPORD ELSE CODTYPORD END,
              CODSTATUS = CASE VL_DES_T100('CODSTATUS.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODSTATUS ELSE CODSTATUS END,
              CODDIV = CASE VL_DES_T100('CODDIV.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODDIV ELSE CODDIV END,
              CODBLCCAUSE = CASE VL_DES_T100('CODBLCCAUSE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODBLCCAUSE ELSE CODBLCCAUSE END,
              DTEORD = CASE VL_DES_T100('DTEORD.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.DTEORD ELSE DTEORD END,
              DTEDELIV = CASE VL_DES_T100('DTEDELIV.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.DTEDELIV ELSE DTEDELIV END,
              CODTYPDELIV = CASE VL_DES_T100('CODTYPDELIV.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODTYPDELIV ELSE CODTYPDELIV END,
              DTEEVA = CASE VL_DES_T100('DTEEVA.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.DTEEVA ELSE DTEEVA END,
              CODPAYTRM = CASE VL_DES_T100('CODPAYTRM.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODPAYTRM ELSE CODPAYTRM END,
              CODPAYMOD = CASE VL_DES_T100('CODPAYMOD.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODPAYMOD ELSE CODPAYMOD END,
              --CODCUSTDELIV = CASE VL_DES_T100('CODCUSTDELIV.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODCUSTDELIV ELSE CODCUSTDELIV END,
              CODVATMGMT = CASE VL_DES_T100('CODVATMGMT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODVATMGMT ELSE CODVATMGMT END,
              --CODCUSTINV = CASE VL_DES_T100('CODCUSTINV.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODCUSTINV ELSE CODCUSTINV END,
              CODLIST = CASE VL_DES_T100('CODLIST.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODLIST ELSE CODLIST END,
              CODCUR = CASE VL_DES_T100('CODCUR.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODCUR ELSE CODCUR END,
              NUMORDREF = CASE VL_DES_T100('NUMORDREF.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.NUMORDREF ELSE NUMORDREF END,
              NUMORDHOST = CASE VL_DES_T100('NUMORDHOST.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.NUMORDHOST ELSE NUMORDHOST END,
              NUMORDCUST = CASE VL_DES_T100('NUMORDCUST.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.NUMORDCUST ELSE NUMORDCUST END,
              DTEORDCUST = CASE VL_DES_T100('DTEORDCUST.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.DTEORDCUST ELSE DTEORDCUST END,
              CODASSORTMENT = CASE VL_DES_T100('CODASSORTMENT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODASSORTMENT ELSE CODASSORTMENT END,
              CODCANVASS = CASE VL_DES_T100('CODCANVASS.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODCANVASS ELSE CODCANVASS END,
              CODMODSHIP = CASE VL_DES_T100('CODMODSHIP.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODMODSHIP ELSE CODMODSHIP END,
              CODMODDELIV = CASE VL_DES_T100('CODMODDELIV.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODMODDELIV ELSE CODMODDELIV END,
              CODAGREEMENT = CASE VL_DES_T100('CODAGREEMENT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODAGREEMENT ELSE CODAGREEMENT END,
              DESAGREEMENT = CASE VL_DES_T100('DESAGREEMENT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.DESAGREEMENT ELSE DESAGREEMENT END,
              CODUSRAUT = CASE VL_DES_T100('CODUSRAUT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODUSRAUT ELSE CODUSRAUT END,
              CODAGREECLASS = CASE VL_DES_T100('CODAGREECLASS.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODAGREECLASS ELSE CODAGREECLASS END,
              DTEAUT = CASE VL_DES_T100('DTEAUT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.DTEAUT ELSE DTEAUT END,
              CODTYPAUT = CASE VL_DES_T100('CODTYPAUT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODTYPAUT ELSE CODTYPAUT END,
              DESAUT = CASE VL_DES_T100('DESAUT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.DESAUT ELSE DESAUT END,

              GROSSAMOUNT = CASE VL_DES_T100('GROSSAMOUNT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.GROSSAMOUNT ELSE GROSSAMOUNT END,
              NETAMOUNT = CASE VL_DES_T100('NETAMOUNT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.NETAMOUNT ELSE NETAMOUNT END,
              TAXAMOUNT = CASE VL_DES_T100('TAXAMOUNT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.TAXAMOUNT ELSE TAXAMOUNT END,
              VATAMOUNT = CASE VL_DES_T100('VATAMOUNT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.VATAMOUNT ELSE VATAMOUNT END,
              INCREASEAMOUNT = CASE VL_DES_T100('INCREASEAMOUNT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.INCREASEAMOUNT ELSE INCREASEAMOUNT END,
              DISCOUNTAMOUNT = CASE VL_DES_T100('DISCOUNTAMOUNT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.DISCOUNTAMOUNT ELSE DISCOUNTAMOUNT END,
              GIFTAMOUNT = CASE VL_DES_T100('GIFTAMOUNT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.GIFTAMOUNT ELSE GIFTAMOUNT END,
              FLGANN = CASE VL_DES_T100('FLGANN.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.FLGANN ELSE FLGANN END,
              CODABI = CASE VL_DES_T100('CODABI.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODABI ELSE CODABI END,
              CODCAB = CASE VL_DES_T100('CODCAB.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODCAB ELSE CODCAB END,
              DESBAN = CASE VL_DES_T100('DESBAN.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.DESBAN ELSE DESBAN END,
              DESBRA = CASE VL_DES_T100('DESBRA.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.DESBRA ELSE DESBRA END,
              DESADDR = CASE VL_DES_T100('DESADDR.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.DESADDR ELSE DESADDR END,
              DESLOC = CASE VL_DES_T100('DESLOC.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.DESLOC ELSE DESLOC END,
              DESPRV = CASE VL_DES_T100('DESPRV.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.DESPRV ELSE DESPRV END,
              QTYTOT = CASE VL_DES_T100('QTYTOT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.QTYTOT ELSE QTYTOT END,
              CODPRV = CASE VL_DES_T100('CODPRV.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODPRV ELSE CODPRV END,
              UMQTYTOT = CASE VL_DES_T100('UMQTYTOT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.UMQTYTOT ELSE UMQTYTOT END,
              CODACCOUNT = CASE VL_DES_T100('CODACCOUNT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODACCOUNT ELSE CODACCOUNT END,
              FLGRETURN = CASE VL_DES_T100('FLGRETURN.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.FLGRETURN ELSE FLGRETURN END,
              FLGHOSTED = CASE VL_DES_T100('FLGHOSTED.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.FLGHOSTED ELSE FLGHOSTED END,
              FLGCONFIRMED = CASE VL_DES_T100('FLGCONFIRMED.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.FLGCONFIRMED ELSE FLGCONFIRMED END,
              --CODWHS = CASE VL_DES_T100('CODWHS.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODWHS ELSE CODWHS END,   ---
              CODSHIPPER = CASE VL_DES_T100('CODSHIPPER.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODSHIPPER ELSE CODSHIPPER END,
              CODAZCAPP = CASE VL_DES_T100('CODAZCAPP.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODAZCAPP ELSE CODAZCAPP END,
              CODAZCBEN = CASE VL_DES_T100('CODAZCBEN.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODAZCBEN ELSE CODAZCBEN END,
              DTEPRICE = CASE VL_DES_T100('DTEPRICE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.DTEPRICE ELSE DTEPRICE END,
              CODTYPSALE = CASE VL_DES_T100('CODTYPSALE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODTYPSALE ELSE CODTYPSALE END,
              FLGCHECKPROMO = CASE VL_DES_T100('FLGCHECKPROMO.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.FLGCHECKPROMO ELSE FLGCHECKPROMO END,
              CODAGREETYPE = CASE VL_DES_T100('CODAGREETYPE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODAGREETYPE ELSE CODAGREETYPE END,
              CODSTATUSMAN = CASE VL_DES_T100('CODSTATUSMAN.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODSTATUSMAN ELSE CODSTATUSMAN END,
              DISCOUNTAMOUNTOUTINV = CASE VL_DES_T100('DISCOUNTAMOUNTOUTINV.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.DISCOUNTAMOUNTOUTINV ELSE DISCOUNTAMOUNTOUTINV END,
              CODTYPORDCUST = CASE VL_DES_T100('CODTYPORDCUST.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODTYPORDCUST ELSE CODTYPORDCUST END,
              CODUSR3 = CASE VL_DES_T100('CODUSR3.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODUSR3 ELSE CODUSR3 END,
              DTEDELIVTO = CASE VL_DES_T100('DTEDELIVTO.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.DTEDELIVTO ELSE DTEDELIVTO END,
              CODCIN = CASE VL_DES_T100('CODCIN.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODCIN ELSE CODCIN END,
              FLGUMORD2 = CASE VL_DES_T100('FLGUMORD2.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.FLGUMORD2 ELSE FLGUMORD2 END,
              NETAMOUNTTEO = CASE VL_DES_T100('NETAMOUNTTEO.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.NETAMOUNTTEO ELSE NETAMOUNTTEO END,
              NETAMOUNTMIN = CASE VL_DES_T100('NETAMOUNTMIN.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.NETAMOUNTMIN ELSE NETAMOUNTMIN END,
              NETAMOUNTMAX = CASE VL_DES_T100('NETAMOUNTMAX.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.NETAMOUNTMAX ELSE NETAMOUNTMAX END,
              CODUSR4 = CASE VL_DES_T100('CODUSR4.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODUSR4 ELSE CODUSR4 END,
              CODUSR2 = CASE VL_DES_T100('CODUSR2.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODUSR2 ELSE CODUSR2 END,
              CODBUYEREDI = CASE VL_DES_T100('CODBUYEREDI.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODBUYEREDI ELSE CODBUYEREDI END,
              --CODCUSTINVEDI = CASE VL_DES_T100('CODCUSTINVEDI.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODCUSTINVEDI ELSE CODCUSTINVEDI END,
              --CODCUSTDELIVEDI = CASE VL_DES_T100('CODCUSTDELIVEDI.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODCUSTDELIVEDI ELSE CODCUSTDELIVEDI END,
              CODSELLEREDI = CASE VL_DES_T100('CODSELLEREDI.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODSELLEREDI ELSE CODSELLEREDI END,

              CODUSR6 = CASE VL_DES_T100('CODUSR6.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODUSR6 ELSE CODUSR6 END,
              CODPDV = CASE VL_DES_T100('CODPDV.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODPDV ELSE CODPDV END,
              CODCUSTCONC = CASE VL_DES_T100('CODCUSTCONC.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODCUSTCONC ELSE CODCUSTCONC END,
              CODIBAN = CASE VL_DES_T100('CODIBAN.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODIBAN ELSE CODIBAN END,
              BACKAMOUNT = CASE VL_DES_T100('BACKAMOUNT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.BACKAMOUNT ELSE BACKAMOUNT END,
              TOTPALLETS = CASE VL_DES_T100('TOTPALLETS.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.TOTPALLETS ELSE TOTPALLETS END,
              GROSSWEIGHT = CASE VL_DES_T100('GROSSWEIGHT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.GROSSWEIGHT ELSE GROSSWEIGHT END,
              TOTMC = CASE VL_DES_T100('TOTMC.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.TOTMC ELSE TOTMC END,
              DTEPROPDELIV = CASE VL_DES_T100('DTEPROPDELIV.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.DTEPROPDELIV ELSE DTEPROPDELIV END,
              CODUSR5 = CASE VL_DES_T100('CODUSR5.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODUSR5 ELSE CODUSR5 END,
              --IDSURVEY = CASE VL_DES_T100('IDSURVEY.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.IDSURVEY ELSE IDSURVEY END,
              --CODCUSTSALE = CASE VL_DES_T100('CODCUSTSALE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODCUSTSALE ELSE CODCUSTSALE END,
              FLGPROCESSEDEDI = CASE VL_DES_T100('FLGPROCESSEDEDI.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.FLGPROCESSEDEDI ELSE FLGPROCESSEDEDI END,
              FLGEDI = CASE VL_DES_T100('FLGEDI.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.FLGEDI ELSE FLGEDI END,
              NUMESENZIONE = CASE VL_DES_T100('NUMESENZIONE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.NUMESENZIONE ELSE NUMESENZIONE END,
              DTEDELIV2 = CASE VL_DES_T100('DTEDELIV2.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.DTEDELIV2 ELSE DTEDELIV2 END,
              DTEDELIV3 = CASE VL_DES_T100('DTEDELIV3.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.DTEDELIV3 ELSE DTEDELIV3 END,
              DTEDELIV4 = CASE VL_DES_T100('DTEDELIV4.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.DTEDELIV4 ELSE DTEDELIV4 END,
              DTEDELIV5 = CASE VL_DES_T100('DTEDELIV5.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.DTEDELIV5 ELSE DTEDELIV5 END,
              IDROUTE = CASE VL_DES_T100('IDROUTE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.IDROUTE ELSE IDROUTE END,
              NUMDOC = CASE VL_DES_T100('NUMDOC.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.NUMDOC ELSE NUMDOC END,
              DTECLOSE = CASE VL_DES_T100('DTECLOSE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.DTECLOSE ELSE DTECLOSE END,
              RETURNAMOUNT = CASE VL_DES_T100('RETURNAMOUNT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.RETURNAMOUNT ELSE RETURNAMOUNT END,

               --- Technical fields
               CODUSRMOD = REC_T100.CODUSRMOD,
               DTEMOD    = REC_T100.DTEMOD,
               -- lock fields
               CODUSRLCK    = REC_T100.CODUSRLCK,
               IDSESSIONLCK = REC_T100.IDSESSIONLCK,
               DTELCK       = REC_T100.DTELCK

         WHERE NUMORD = REC_T100.NUMORD
          AND  CODUSR = REC_T100.CODUSR
          AND (idsessionlck = REC_T100.IDSESSIONLCK
               or not exists
                     ( select null from T035LOGGEDUSERS T035
                      where T035.IDSESSION = NVL(IDSESSIONLCK, '@') AND T035.LASTCHECK > TRUNC(XSYSDATE)-1 )
               );


        END IF; -- VL_STATUS = 0


        EXCEPTION WHEN OTHERS THEN
             VL_STATUS := -1;
             VL_MESSAGE_H := SUBSTR(VL_MESSAGE_H||' '||VL_MESSAGE_D||' '||dbms_utility.format_error_backtrace() || ' ' || SQLERRM,1,4000);

             PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                           VL_PROGR_D_T100,
                                           SQLCODE,
                                           VL_MESSAGE_H);

        END; -- HEAD T100


     -- if all records have been stored with success then it makes the final commit
      IF VL_STATUS = 0 THEN
         VL_INS_T100 := VL_INS_T100 + 1;
         COMMIT;
      ELSE
        ROLLBACK;
      END IF;

      IF (VL_STATUS <> 0 OR VL_RECORD_LOCKED <> 0) THEN
          UPDATE XIN_T106ORDROW
          SET  SM1_STATUS= CASE
                                WHEN VL_RECORD_LOCKED <> 0  THEN C_XINSTATUS_LOCK
                                ELSE C_XINSTATUS_ERR END
          WHERE CODUSR = RL_XIN_T100.CODUSR
           AND  SM1_CODPROCESS = PI_PROGR_H
           AND  SM1_DTECRE     = RL_XIN_T100.SM1_DTECRE
           AND  SM1_STATUS     = C_XINSTATUS_OK;

          -- TO CHECK this update is  not correct in case of double record .
          UPDATE XIN_T100ORDHEAD
          SET  SM1_STATUS= CASE
                                WHEN VL_RECORD_LOCKED <> 0  THEN C_XINSTATUS_LOCK
                                ELSE C_XINSTATUS_ERR END
          WHERE CODUSR = RL_XIN_T100.CODUSR
           AND  SM1_CODPROCESS = PI_PROGR_H
           AND  SM1_DTECRE     <= RL_XIN_T100.SM1_DTECRE
           AND  SM1_STATUS     = C_XINSTATUS_OK;

          COMMIT;
      END IF;

        -- Release updated records
          UPDATE T100ORDHEAD
          SET       DTELCK          = NULL,
                    IDSESSIONLCK    = NULL,
                    CODUSRLCK       = NULL
          WHERE CODUSR = REC_T100.CODUSR AND CODUSRLCK = C_SYSUSR AND IDSESSIONLCK = PI_SESSION_ID;
          COMMIT;
    END LOOP;  -- T100ORDHEAD


    -- Moves records from staging area to log staging area
    P_XIN_MOVE_TO_LOG(PI_PROGR_H, VL_PROGR_D_T100,'T106ORDROW');
    P_XIN_MOVE_TO_LOG(PI_PROGR_H, VL_PROGR_D_T100,'T100ORDHEAD');

   -- Close Logs
    PKG_UTILS.LOG_END_DETAIL(PI_PROGR_H,
                             VL_PROGR_D_T106,
                             0,
                             VL_COUNT_XIN_T106,
                             VL_INS_T106,
                             VL_COUNT_XIN_T106 - VL_INS_T106);

    PKG_UTILS.LOG_END_DETAIL(PI_PROGR_H,
                             VL_PROGR_D_T100,
                             0,
                             VL_COUNT_XIN_T100,
                             VL_INS_T100,
                             VL_COUNT_XIN_T100 - VL_INS_T100);


    PO_MSG    := VL_INS_T100||'/'||VL_COUNT_XIN_T100||' Orders loaded';
    PO_STATUS := VL_INS_T100;


    --
  EXCEPTION WHEN EX_EXIT THEN

          ROLLBACK;
          VL_MESSAGE_H       := VL_MESSAGE_H || TRIM(SUBSTR(dbms_utility.format_error_backtrace() || ' ' || SQLERRM, 1, 255));
          PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                         VL_PROGR_D_T100,
                                         SQLCODE,
                                         VL_MESSAGE_H);

          PO_MSG := VL_MESSAGE_H;
          PO_STATUS := -1;

   WHEN OTHERS THEN

          ROLLBACK;
         -- Release updated records
            UPDATE T100ORDHEAD
            SET       DTELCK          = NULL,
                      IDSESSIONLCK    = NULL,
                      CODUSRLCK       = NULL
            WHERE CODUSRLCK = C_SYSUSR AND IDSESSIONLCK = PI_SESSION_ID;
            COMMIT;
          -- Moves records from staging area to log staging area
          P_XIN_MOVE_TO_LOG(PI_PROGR_H, VL_PROGR_D_T100,'T106ORDROW');
          P_XIN_MOVE_TO_LOG(PI_PROGR_H, VL_PROGR_D_T100,'T100ORDHEAD');

          VL_MESSAGE_H       := VL_MESSAGE_H || TRIM(SUBSTR(dbms_utility.format_error_backtrace() || ' ' || SQLERRM, 1, 255));

          PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                         VL_PROGR_D_T100,
                                         SQLCODE,
                                         VL_MESSAGE_H);

          PO_MSG := VL_MESSAGE_H;
          PO_STATUS := VL_STATUS;

    END;
    


PROCEDURE LOAD_T100_ORDERS_51 (PI_PROGR_H       IN NUMBER,
                              PI_SESSION_ID    IN NUMBER,
                              PO_MSG           OUT NOCOPY VARCHAR2,
                              PO_STATUS        OUT NOCOPY NUMBER ) IS



    -- -----------------------------------------
    -- Cursor on Orde Heads xin_t100ordhead
    -- -----------------------------------------
    CURSOR CL_XIN_T100 IS
      SELECT
        *
        FROM  XIN_T100ORDHEAD
        WHERE SM1_CODPROCESS = PI_PROGR_H
    AND CODTYPORD IN ('51')
        ORDER BY NUMORDHOST, SM1_DTECRE;
    -- -----------------------------------------
    -- Cursor on Order Rows xin_t106_ordrow
    -- -----------------------------------------
    CURSOR CL_XIN_T106(CI_NUMORDHOST VARCHAR2, CI_SM1_DTECRE DATE) IS
      SELECT
        ORDROW.*
  ,T.Codwhs AS VANWHS
        FROM  XIN_T106ORDROW  ORDROW
  INNER JOIN
      T100ORDHEAD T ON ORDROW.NUMORD = T.NUMORD
        WHERE ORDROW.NUMORDHOST = CI_NUMORDHOST
        AND   ORDROW.SM1_CODPROCESS = PI_PROGR_H
    -- AND   ORDROW.SM1_DTECRE <= CI_SM1_DTECRE   -- vikas , no need to compare creation time of header and row
        AND ORDROW.SM1_STATUS = C_XINSTATUS_OK -- Only those that have not processed yet (in case of double record in xin)
        ORDER BY ORDROW.SM1_DTECRE;


    --

    VL_MESSAGE_H   VARCHAR2(4000) := 'Error while loading Orders T100/T106';
    VL_MESSAGE_D   VARCHAR2(4000) := NULL;
    --
    VL_PROGR_D_T100    NUMBER := 0;
    VL_COUNT_XIN_T100  NUMBER := 0;
    VL_INS_T100        NUMBER := 0;
    --
    VL_PROGR_D_T106    NUMBER := 0;
    VL_COUNT_XIN_T106  NUMBER := 0;
    VL_INS_T106        NUMBER := 0;
    --
    REC_T100      T100ORDHEAD%ROWTYPE    := NULL;
    REC_T100_INIT T100ORDHEAD%ROWTYPE    := NULL;
    REC_T106      T106ORDROW%ROWTYPE := NULL;
    REC_T106_INIT T106ORDROW%ROWTYPE := NULL;
    --
    VL_DES_T100     X_FIELD_INFO_ARRAY;-- Array with fields db info
    VL_DES_T106     X_FIELD_INFO_ARRAY;-- Array with fields db info
    --
    VL_RECORD_LOCKED NUMBER := 0;

    VL_STATUS NUMBER:= 0;
    VL_STEP   NUMBER:= 0; -- Used to ping t035
    --
    EX_EXIT  EXCEPTION;
    --
    VL_CODDIV VARCHAR2(30) := NULL;
    vl_ins_upd VARCHAR2(3) := NULL;

  BEGIN




    -- init indexes and rebuild statistics
    P_XIN_INIT_INDEXES (PI_PROGR_H, 'T100ORDHEAD');
    P_XIN_INIT_INDEXES (PI_PROGR_H, 'T106ORDROW');
    -- clean log
    P_XIN_CLEANUP_LOG (PI_PROGR_H, 'T100ORDHEAD');
    P_XIN_CLEANUP_LOG (PI_PROGR_H, 'T106ORDROW');


    VL_PROGR_D_T100 := PKG_UTILS.LOG_NEW_DETAIL(PI_PROGR_H,
                                       'ORDER HEAD',
                                       'IMPORT --> T100ORDHEAD 51',
                                        0,
                                        NULL);
    VL_PROGR_D_T106 := PKG_UTILS.LOG_NEW_DETAIL(PI_PROGR_H,
                                       'ORDER ROWS',

                                       'IMPORT --> T106ORDROW 51',
                                        0,
                                        NULL);

    -- retrieves configuration parameters
    LOAD_T10X_CONF_STEP0(
                          VL_MESSAGE_H,
                          VL_STATUS   );

    if (vl_status <> 0 ) then
         PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                        VL_PROGR_D_T100,
                                        SQLCODE,
                                        VL_MESSAGE_H);

          raise EX_EXIT;
    end if;
    BEGIN


        --
        -- ----------------------------------------------------------
        -- Init arrays with FIELD_NAME=LENGTH and FIELDNAME=SM1_DEFAULT for all fields of table
        -- ----------------------------------------------------------
        VL_DES_T100.DELETE;
        P_INIT_SM1_FIELD_ARRAY ('T100ORDHEAD', VL_DES_T100, VL_STATUS, VL_MESSAGE_H);
        execute immediate ( GL_INIT_REC) INTO REC_T100_INIT;


        VL_DES_T106.DELETE;
        P_INIT_SM1_FIELD_ARRAY ('T106ORDROW', VL_DES_T106, VL_STATUS, VL_MESSAGE_H);
        execute immediate ( GL_INIT_REC) INTO REC_T106_INIT;

        IF (VL_STATUS <> 0 ) THEN
            VL_MESSAGE_D := GL_INIT_REC;
            RAISE EX_EXIT;
        END IF;
    EXCEPTION WHEN OTHERS THEN
        VL_MESSAGE_D := GL_INIT_REC;
        RAISE EX_EXIT;
    END;


    -- --------------------------------------------------------------
    -- Identifies Xin records to be loaded
    -- --------------------------------------------------------------
    BEGIN
        VL_MESSAGE_D := 'XIN_T100ORDHEAD';
        UPDATE XIN_T100ORDHEAD
        SET SM1_CODPROCESS = PI_PROGR_H,
            SM1_STATUS = 0,
            SM1_DTEPROCESS = XSYSDATE
            WHERE NVL(SM1_CODPROCESS, 0) = C_SM1_NULL_CODPROCESS
      AND CODDIV IN ('DFI')     
      AND CODTYPORD IN ('51');

        VL_MESSAGE_D := 'XIN_T106ORDROW';
    
        UPDATE XIN_T106ORDROW D
        SET D.SM1_CODPROCESS = PI_PROGR_H,
            D.SM1_STATUS = 0,
            D.SM1_DTEPROCESS = XSYSDATE
            WHERE 
              NVL(D.SM1_CODPROCESS,0) = C_SM1_NULL_CODPROCESS
            AND D.NUMORDHOST IN ( SELECT H.NUMORDHOST FROM XIN_T100ORDHEAD H WHERE H.SM1_CODPROCESS = PI_PROGR_H 
      AND CODDIV IN ('DFI')     
      AND CODTYPORD IN ('51'));

    COMMIT;
  
    EXCEPTION WHEN OTHERS THEN
      ROLLBACK;
      VL_MESSAGE_H := 'Error while Reading Staging area: '||VL_MESSAGE_D;
      RAISE EX_EXIT;

    END;

    -- --------------------------------------------------------------
    -- loop in main table T100ORDHEAD
    -- --------------------------------------------------------------
    FOR RL_XIN_T100 IN CL_XIN_T100 LOOP
     -- pings to t035 every 100 cicles--
      VL_STEP := VL_STEP + 1;

      IF ( MOD(VL_STEP, 100) = 0 ) THEN
         PKG_UTILS.user_ping(PI_SESSION_ID);
      END IF;

      --
      VL_STATUS := 0;
      --
      VL_MESSAGE_H :=   'Order NumordHost : '   ||RL_XIN_T100.NUMORDHOST;
      --
      BEGIN --- HEAD T100

        -- Data Format Check
        VL_MESSAGE_D := 'Format Conversion ';
        VL_CODDIV := 'ALL';
        REC_T100 := REC_T100_INIT;
        --
        REC_T100.CODUSR := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODUSR,'CODUSR', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.NUMORD := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.NUMORD,'NUMORD', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        --
        REC_T100.CODEUSR   := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODEUSR,'CODEUSR', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODTYPORD := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODTYPORD,'CODTYPORD', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODSTATUS := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODSTATUS,'CODSTATUS', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODDIV    := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODDIV,'CODDIV', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODBLCCAUSE := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODBLCCAUSE,'CODBLCCAUSE', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.DTEORD      := F_CHECK_FORMAT_D( VL_CODDIV, RL_XIN_T100.DTEORD,'DTEORD', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.DTEDELIV    := F_CHECK_FORMAT_D( VL_CODDIV, RL_XIN_T100.DTEDELIV,'DTEDELIV', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODTYPDELIV := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODTYPDELIV,'CODTYPDELIV', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.DTEEVA      := F_CHECK_FORMAT_D( VL_CODDIV, RL_XIN_T100.DTEEVA,'DTEEVA', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODPAYTRM   := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODPAYTRM,'CODPAYTRM', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODPAYMOD   := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODPAYMOD,'CODPAYMOD', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODCUSTDELIV := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODCUSTDELIV,'CODCUSTDELIV', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODVATMGMT   := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODVATMGMT,'CODVATMGMT', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODCUSTINV   := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODCUSTINV,'CODCUSTINV', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODLIST      := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODLIST,'CODLIST', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODCUR       := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODCUR,'CODCUR', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.NUMORDREF    := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.NUMORDREF,'NUMORDREF', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.NUMORDHOST   := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.NUMORDHOST,'NUMORDHOST', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.NUMORDCUST   := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.NUMORDCUST,'NUMORDCUST', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.DTEORDCUST   := F_CHECK_FORMAT_D( VL_CODDIV, RL_XIN_T100.DTEORDCUST,'DTEORDCUST', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODASSORTMENT := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODASSORTMENT,'CODASSORTMENT', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODCANVASS    := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODCANVASS,'CODCANVASS', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODMODSHIP    := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODMODSHIP,'CODMODSHIP', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODMODDELIV   := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODMODDELIV,'CODMODDELIV', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODAGREEMENT  := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.CODAGREEMENT,'CODAGREEMENT', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.DESAGREEMENT  := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.DESAGREEMENT,'DESAGREEMENT', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODUSRAUT     := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODUSRAUT,'CODUSRAUT', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODAGREECLASS := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODAGREECLASS,'CODAGREECLASS', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.DTEAUT        := F_CHECK_FORMAT_D( VL_CODDIV, RL_XIN_T100.DTEAUT,'DTEAUT', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODTYPAUT     := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODTYPAUT,'CODTYPAUT', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.DESAUT        := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.DESAUT,'DESAUT', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.GROSSAMOUNT   := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.GROSSAMOUNT,'GROSSAMOUNT', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.NETAMOUNT     := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.NETAMOUNT,'NETAMOUNT', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.TAXAMOUNT     := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.TAXAMOUNT,'TAXAMOUNT', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.VATAMOUNT     := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.VATAMOUNT,'VATAMOUNT', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.INCREASEAMOUNT := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.INCREASEAMOUNT,'INCREASEAMOUNT', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.DISCOUNTAMOUNT := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.DISCOUNTAMOUNT,'DISCOUNTAMOUNT', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.GIFTAMOUNT     := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.GIFTAMOUNT,'GIFTAMOUNT', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.FLGANN         := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.FLGANN,'FLGANN', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODABI         := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODABI,'CODABI', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODCAB         := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODCAB,'CODCAB', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.DESBAN         := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.DESBAN,'DESBAN', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.DESBRA         := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.DESBRA,'DESBRA', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.DESADDR        := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.DESADDR,'DESADDR', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.DESLOC         := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.DESLOC,'DESLOC', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.DESPRV         := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.DESPRV,'DESPRV', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.QTYTOT         := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.QTYTOT,'QTYTOT', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODPRV         := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODPRV,'CODPRV', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.UMQTYTOT       := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.UMQTYTOT,'UMQTYTOT', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODACCOUNT     := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODACCOUNT,'CODACCOUNT', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.FLGRETURN      := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.FLGRETURN,'FLGRETURN', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.FLGHOSTED      := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.FLGHOSTED,'FLGHOSTED', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.FLGCONFIRMED   := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.FLGCONFIRMED,'FLGCONFIRMED', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        --REC_T100.CODWHS         := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODWHS,'CODWHS', VL_DES_T100,VL_STATUS, VL_MESSAGE_D); --commented because while sending to sage it send as main ware house
        REC_T100.CODSHIPPER     := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODSHIPPER,'CODSHIPPER', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODAZCAPP      := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODAZCAPP,'CODAZCAPP', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODAZCBEN      := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODAZCBEN,'CODAZCBEN', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.DTEPRICE       := F_CHECK_FORMAT_D( VL_CODDIV, RL_XIN_T100.DTEPRICE,'DTEPRICE', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODTYPSALE     := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODTYPSALE,'CODTYPSALE', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.FLGCHECKPROMO  := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.FLGCHECKPROMO,'FLGCHECKPROMO', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODAGREETYPE   := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODAGREETYPE,'CODAGREETYPE', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODSTATUSMAN   := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODSTATUSMAN,'CODSTATUSMAN', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.DISCOUNTAMOUNTOUTINV := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.DISCOUNTAMOUNTOUTINV,'DISCOUNTAMOUNTOUTINV', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODTYPORDCUST        := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODTYPORDCUST,'CODTYPORDCUST', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODUSR3              := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODUSR3,'CODUSR3', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.DTEDELIVTO           := F_CHECK_FORMAT_D( VL_CODDIV, RL_XIN_T100.DTEDELIVTO,'DTEDELIVTO', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODCIN               := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODCIN,'CODCIN', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.FLGUMORD2            := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.FLGUMORD2,'FLGUMORD2', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.NETAMOUNTTEO         := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.NETAMOUNTTEO,'NETAMOUNTTEO', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.NETAMOUNTMIN         := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.NETAMOUNTMIN,'NETAMOUNTMIN', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.NETAMOUNTMAX         := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.NETAMOUNTMAX,'NETAMOUNTMAX', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODUSR4              := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODUSR4,'CODUSR4', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODUSR2              := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODUSR2,'CODUSR2', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODBUYEREDI          := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODBUYEREDI,'CODBUYEREDI', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODCUSTINVEDI        := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODCUSTINVEDI,'CODCUSTINVEDI', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODCUSTDELIVEDI      := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODCUSTDELIVEDI,'CODCUSTDELIVEDI', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODSELLEREDI         := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODSELLEREDI,'CODSELLEREDI', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODUSR6              := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODUSR6,'CODUSR6', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODPDV               := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODPDV,'CODPDV', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODCUSTCONC          := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODCUSTCONC,'CODCUSTCONC', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODIBAN              := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODIBAN,'CODIBAN', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.BACKAMOUNT           := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.BACKAMOUNT,'BACKAMOUNT', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.TOTPALLETS           := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.TOTPALLETS,'TOTPALLETS', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.GROSSWEIGHT          := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.GROSSWEIGHT,'GROSSWEIGHT', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.TOTMC                := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.TOTMC,'TOTMC', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.DTEPROPDELIV         := F_CHECK_FORMAT_D( VL_CODDIV, RL_XIN_T100.DTEPROPDELIV,'DTEPROPDELIV', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODUSR5              := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODUSR5,'CODUSR5', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.IDSURVEY             := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.IDSURVEY,'IDSURVEY', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODCUSTSALE          := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODCUSTSALE,'CODCUSTSALE', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.FLGPROCESSEDEDI      := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.FLGPROCESSEDEDI,'FLGPROCESSEDEDI', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.FLGEDI               := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.FLGEDI,'FLGEDI', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.NUMESENZIONE         := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.NUMESENZIONE,'NUMESENZIONE', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.DTEDELIV2            := F_CHECK_FORMAT_D( VL_CODDIV, RL_XIN_T100.DTEDELIV2,'DTEDELIV2', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.DTEDELIV3            := F_CHECK_FORMAT_D( VL_CODDIV, RL_XIN_T100.DTEDELIV3,'DTEDELIV3', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.DTEDELIV4            := F_CHECK_FORMAT_D( VL_CODDIV, RL_XIN_T100.DTEDELIV4,'DTEDELIV4', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.DTEDELIV5            := F_CHECK_FORMAT_D( VL_CODDIV, RL_XIN_T100.DTEDELIV5,'DTEDELIV5', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.IDROUTE              := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.IDROUTE,'IDROUTE', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.NUMDOC               := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.NUMDOC,'NUMDOC', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
         -- DTECLOSE
         IF( LENGTH(TRIM(TO_CHAR(RL_XIN_T100.DTECLOSE))) <> 0 AND RL_XIN_T100.DTECLOSE IS NOT NULL ) THEN
         REC_T100.DTECLOSE   := RL_XIN_T100.DTECLOSE;
         ELSE
         REC_T100.DTECLOSE             := F_CHECK_FORMAT_D( VL_CODDIV, RL_XIN_T100.DTECLOSE,'DTECLOSE', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
         END IF;
    REC_T100.RETURNAMOUNT         := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.RETURNAMOUNT,'RETURNAMOUNT', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);

        --- Technical fields
        REC_T100.DTECRE     := XSYSDATE;
        REC_T100.CODUSRMOD  := C_SYSUSR;
        REC_T100.DTEMOD     := XSYSDATE;
        REC_T100.CODUSRMODREAL := C_SYSUSR;
        REC_T100.CODUSRCREREAL := C_SYSUSR;
        -- lock fields
        REC_T100.CODUSRLCK     := C_SYSUSR;
        REC_T100.IDSESSIONLCK  := PI_SESSION_ID;
        REC_T100.DTELCK        := XSYSDATE;
    
    dbms_output.put_line(' VLSTATUS after asigning t100 values  '|| VL_STATUS );


        IF (VL_STATUS <> 0 ) THEN

             VL_MESSAGE_H := SUBSTR(VL_MESSAGE_H||' '||VL_MESSAGE_D||' '||dbms_utility.format_error_backtrace() || ' ' || SQLERRM,1,4000);

             PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                           VL_PROGR_D_T100,
                                           SQLCODE,
                                           VL_MESSAGE_H);
        /* ELSE    
             Recocgnize SM1 Orders and fit in REC_T100 record updated values
            inserts new orders coming from ERP
            LOAD_T10X_HEAD_STEP1( PI_PROGR_H,
                                VL_PROGR_D_T100,
                                 REC_T100,
                                 VL_STATUS); */ --- COMMENTED BY VIKAS

        END IF;
        -- -----------------------------------
        -- T106ORDERROW
        -- -----------------------------------
        BEGIN
        --
         dbms_output.put_line(' VLSTATUS before updating row qty is  '|| VL_STATUS );
        IF ( VL_STATUS = 0  ) THEN
            -- Before updating all rows, we mark them all to recognize those no more sent by ERP
            -- we use a prefix on CODSTATUS
        UPDATE T106ORDROW T
              set T.codstatus =C_T106_STATUS_PREFIX||t.codstatus,

              t.qtyord = '0',t.qtyinv = '0' -- added by vikas , not returned rows from SAGE should be set as zero qty in SM1

              where t.numord = REC_T100.NUMORD
                --and t.codusr = REC_T100.CODUSR
                ;
        
              FOR RL_XIN_T106 IN CL_XIN_T106(RL_XIN_T100.NUMORDHOST, RL_XIN_T100.SM1_DTECRE)
                 LOOP

                VL_MESSAGE_H := 'Row info: '|| REC_T100.NUMORD|| '/' ||
                                               REC_T100.CODUSR|| '/' ||
                                               RL_XIN_T106.CODDIV || '/' ||
                                               RL_XIN_T106.NUMROWHOST;

                  VL_MESSAGE_D := 'Format Conversion ';
                  VL_CODDIV := RL_XIN_T106.CODDIV;
                  REC_T106  := REC_T106_INIT;
                  ---
                  REC_T106.NUMORD := REC_T100.NUMORD;
                  REC_T106.CODUSR := REC_T100.CODUSR;
                  --
                  REC_T106.NUMROW := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.NUMROW,'NUMROW', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.CODART := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.CODART,'CODART', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.CODDIV := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.CODDIV,'CODDIV', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.UMORD  := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.UMORD,'UMORD', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.DESART := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.DESART,'DESART', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.QTYORD := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.QTYORD,'QTYORD', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.QTYBCKORD := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.QTYBCKORD,'QTYBCKORD', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.QTYANN    := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.QTYANN,'QTYANN', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.QTYDEL    := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.QTYDEL,'QTYDEL', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.UMINV     := REC_T106.UMORD;-- F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.UMINV,'UMINV', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.QTYINV    := REC_T106.QTYORD;-- F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.QTYINV,'QTYINV', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);-- qtyord and qtyinv will be equal in sales responce 
                  REC_T106.CODTYPROW := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.CODTYPROW,'CODTYPROW', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.CODLIST   := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.CODLIST,'CODLIST', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.DTEDELIV  := F_CHECK_FORMAT_D( VL_CODDIV,  RL_XIN_T106.DTEDELIV,'DTEDELIV', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.DTEPROPDELIV := F_CHECK_FORMAT_D( VL_CODDIV,  RL_XIN_T106.DTEPROPDELIV,'DTEPROPDELIV', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.CODSTATUS := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.CODSTATUS,'CODSTATUS', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.CODSHIPPER := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.CODSHIPPER,'CODSHIPPER', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.NUMDOCREF := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.NUMDOCREF,'NUMDOCREF', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.DTEDOCREF := F_CHECK_FORMAT_D( VL_CODDIV,  RL_XIN_T106.DTEDOCREF,'DTEDOCREF', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.GROSSAMOUNT := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.GROSSAMOUNT,'GROSSAMOUNT', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.NUMINV      := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.NUMINV,'NUMINV', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.NETAMOUNT   := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.NETAMOUNT,'NETAMOUNT', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.DTEINV      := F_CHECK_FORMAT_D( VL_CODDIV,  RL_XIN_T106.DTEINV,'DTEINV', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.TAXAMOUNT   := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.TAXAMOUNT,'TAXAMOUNT', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.VATAMOUNT   := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.VATAMOUNT,'VATAMOUNT', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.INCREASEAMOUNT := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.INCREASEAMOUNT,'INCREASEAMOUNT', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.DISCOUNTAMOUNT := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.DISCOUNTAMOUNT,'DISCOUNTAMOUNT', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.GIFTAMOUNT     := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.GIFTAMOUNT,'GIFTAMOUNT', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.ENDUSERPRICE   := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.ENDUSERPRICE,'ENDUSERPRICE', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.CODAZCAPP      := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.CODAZCAPP,'CODAZCAPP', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.FLGEFFBCKORD   := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.FLGEFFBCKORD,'FLGEFFBCKORD', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.CODBCKORDCAUSE := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.CODBCKORDCAUSE,'CODBCKORDCAUSE', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.GROSSARTAMOUNT := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.GROSSARTAMOUNT,'GROSSARTAMOUNT', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.NETARTAMOUNT   := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.NETARTAMOUNT,'NETARTAMOUNT', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.CODSRC         := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.CODSRC,'CODSRC', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.CODSRCREF      := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.CODSRCREF,'CODSRCREF', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.CODBENCAUSE    := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.CODBENCAUSE,'CODBENCAUSE', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.CODBENSUBCAUSE := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.CODBENSUBCAUSE,'CODBENSUBCAUSE', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.BENNOTE        := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.BENNOTE,'BENNOTE', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.AZCTOAPPLY     := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.AZCTOAPPLY,'AZCTOAPPLY', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.CODOPERATION   := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.CODOPERATION,'CODOPERATION', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.DISCOUNTAMOUNTOUTINV := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.DISCOUNTAMOUNTOUTINV,'DISCOUNTAMOUNTOUTINV', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.CODACCAPP            := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.CODACCAPP,'CODACCAPP', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.CODTYPROWCAUSE       := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.CODTYPROWCAUSE,'CODTYPROWCAUSE', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.CODARTCUST           := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.CODARTCUST,'CODARTCUST', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.QTYRESO              := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.QTYRESO,'QTYRESO', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.NUMORDRESO           := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.NUMORDRESO,'NUMORDRESO', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.CODBLCCAUSE          := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.CODBLCCAUSE,'CODBLCCAUSE', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.CODARTKITREF         := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.CODARTKITREF,'CODARTKITREF', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.NUMROWKITREF         := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.NUMROWKITREF,'NUMROWKITREF', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.CODCAUSEKIT          := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.CODCAUSEKIT,'CODCAUSEKIT', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.NETARTAMOUNTTEO      := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.NETARTAMOUNTTEO,'NETARTAMOUNTTEO', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.NETAMOUNTTEO         := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.NETAMOUNTTEO,'NETAMOUNTTEO', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.NETAMOUNTMIN         := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.NETAMOUNTMIN,'NETAMOUNTMIN', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.NETAMOUNTMAX         := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.NETAMOUNTMAX,'NETAMOUNTMAX', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.NETDIFF              := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.NETDIFF,'NETDIFF', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.COD_ABBINAMENTO_KIT  := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.COD_ABBINAMENTO_KIT,'COD_ABBINAMENTO_KIT', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.NUMROWORIG           := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.NUMROWORIG,'NUMROWORIG', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.FLGFIRSTSON          := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.FLGFIRSTSON,'FLGFIRSTSON', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.NETARTAMOUNTCUST     := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.NETARTAMOUNTCUST,'NETARTAMOUNTCUST', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.NETARTAMOUNTCUST2    := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.NETARTAMOUNTCUST2,'NETARTAMOUNTCUST2', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.GROSSARTAMOUNTCUST   := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.GROSSARTAMOUNTCUST,'GROSSARTAMOUNTCUST', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.NETAMOUNTCUST        := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.NETAMOUNTCUST,'NETAMOUNTCUST', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.QTYORDEDI            := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.QTYORDEDI,'QTYORDEDI', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.CODEAN               := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.CODEAN,'CODEAN', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.UMORDEDI             := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.UMORDEDI,'UMORDEDI', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.NUMROWREF            := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.NUMROWREF,'NUMROWREF', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.FLGOMGPROMO          := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.FLGOMGPROMO,'FLGOMGPROMO', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.GROSSARTAMOUNTORD    := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.GROSSARTAMOUNTORD,'GROSSARTAMOUNTORD', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.GROSSARTAMOUNTDELTA  := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.GROSSARTAMOUNTDELTA,'GROSSARTAMOUNTDELTA', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.FLGOMGDISCLIST       := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.FLGOMGDISCLIST,'FLGOMGDISCLIST', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.CODCNVPDA            := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.CODCNVPDA,'CODCNVPDA', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.DTEEVA               := F_CHECK_FORMAT_D( VL_CODDIV,  RL_XIN_T106.DTEEVA,'DTEEVA', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.CODPAYTRM            := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.CODPAYTRM,'CODPAYTRM', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.CODPAYMOD            := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.CODPAYMOD,'CODPAYMOD', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.NUMORDHOST           := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.NUMORDHOST,'NUMORDHOST', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.NUMROWHOST           := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.NUMROWHOST,'NUMROWHOST', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.CODMODSHIP           := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.CODMODSHIP,'CODMODSHIP', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.CODMODDELIV          := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.CODMODDELIV,'CODMODDELIV', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.CODWHS               := RL_XIN_T106.VANWHS ; --F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.VANWHS,'CODWHS', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.DTEPRICE             := F_CHECK_FORMAT_D( VL_CODDIV,  RL_XIN_T106.DTEPRICE,'DTEPRICE', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.DTEDELIVTO           := F_CHECK_FORMAT_D( VL_CODDIV,  RL_XIN_T106.DTEDELIVTO,'DTEDELIVTO', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.CODROWGROUP          := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.CODROWGROUP,'CODROWGROUP', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.NETAMOUNTGIFT        := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.NETAMOUNTGIFT,'NETAMOUNTGIFT', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.NETARTAMOUNTEDI      := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.NETARTAMOUNTEDI,'NETARTAMOUNTEDI', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.GROSSARTAMOUNTEDI    := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.GROSSARTAMOUNTEDI,'GROSSARTAMOUNTEDI', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.QTYORDORIG           := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.QTYORDORIG,'QTYORDORIG', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.QTYALLOCATED         := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.QTYALLOCATED,'QTYALLOCATED', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.RETURNAMOUNT         := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.RETURNAMOUNT,'RETURNAMOUNT', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);

                  -- Technical fields
                  --

                  dbms_output.put_line(' -- Technical fields VLSTATUS 8778  '|| VL_STATUS );
                 IF (VL_STATUS <> 0 ) THEN


                   VL_MESSAGE_H := SUBSTR(VL_MESSAGE_H||' '||VL_MESSAGE_D||' '||dbms_utility.format_error_backtrace() || ' ' || SQLERRM,1,4000);
                   PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                           VL_PROGR_D_T106,
                                           SQLCODE,
                                           VL_MESSAGE_H);
                ELSE

                 vl_ins_upd := NULL;
                  -- Recognize order lines; inserts new rows ; check the row
                 LOAD_T10X_ROW_STEP2( PI_PROGR_H,
                                      VL_PROGR_D_T106,
                                      REC_T106,
                                      vl_ins_upd,
                                      VL_STATUS);

                END IF;
                --
    --dbms_output.put_line(' -- Technical fields VLSTATUS 8799  '|| VL_STATUS );
              IF (VL_STATUS = 0 ) then
               if (vl_ins_upd = 'UPD') THEN
                VL_MESSAGE_D := 'Update T106 ';
                UPDATE T106ORDROW
                   SET

                  --  CODUSR = CASE VL_DES_T106('CODUSR').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODUSR ELSE CODUSR END,
                  --  NUMORD = CASE VL_DES_T106('NUMORD').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.NUMORD ELSE NUMORD END,
                  --  NUMROW = rec_t106.numrow,
                  --  CODART = CASE VL_DES_T106('CODART').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODART ELSE CODART END,
                  --  CODDIV = CASE VL_DES_T106('CODDIV').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODDIV ELSE CODDIV END,
                    UMORD = CASE VL_DES_T106('UMORD.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.UMORD ELSE UMORD END,
                  --  DESART = CASE VL_DES_T106('DESART.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.DESART ELSE DESART END,
                    QTYORD = CASE VL_DES_T106('QTYORD.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.QTYORD ELSE QTYORD END,
                    --QTYBCKORD = CASE VL_DES_T106('QTYBCKORD.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.QTYBCKORD ELSE QTYBCKORD END,
                    --QTYANN = CASE VL_DES_T106('QTYANN.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.QTYANN ELSE QTYANN END,
                    --QTYDEL = CASE VL_DES_T106('QTYDEL.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.QTYDEL ELSE QTYDEL END,
                   -- UMINV = CASE VL_DES_T106('UMINV.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.UMINV ELSE UMINV END,
                    QTYINV = CASE VL_DES_T106('QTYINV.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.QTYINV ELSE QTYINV END,                  
                    --CODTYPROW = CASE VL_DES_T106('CODTYPROW.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODTYPROW ELSE CODTYPROW END,
                    --CODLIST = CASE VL_DES_T106('CODLIST.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODLIST ELSE CODLIST END,
                    --DTEDELIV = CASE VL_DES_T106('DTEDELIV.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.DTEDELIV ELSE DTEDELIV END,
                    --DTEPROPDELIV = CASE VL_DES_T106('DTEPROPDELIV.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.DTEPROPDELIV ELSE DTEPROPDELIV END,
                    CODSTATUS = CASE VL_DES_T106('CODSTATUS.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODSTATUS ELSE CODSTATUS END,
                    --CODSHIPPER = CASE VL_DES_T106('CODSHIPPER.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODSHIPPER ELSE CODSHIPPER END,
                    --NUMDOCREF = CASE VL_DES_T106('NUMDOCREF.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.NUMDOCREF ELSE NUMDOCREF END,
                    --DTEDOCREF = CASE VL_DES_T106('DTEDOCREF.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.DTEDOCREF ELSE DTEDOCREF END,
                    --GROSSAMOUNT = CASE VL_DES_T106('GROSSAMOUNT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.GROSSAMOUNT ELSE GROSSAMOUNT END,
                    --NUMINV = CASE VL_DES_T106('NUMINV.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.NUMINV ELSE NUMINV END,
                    --NETAMOUNT = CASE VL_DES_T106('NETAMOUNT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.NETAMOUNT ELSE NETAMOUNT END,
                    --DTEINV = CASE VL_DES_T106('DTEINV.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.DTEINV ELSE DTEINV END,
                    --TAXAMOUNT = CASE VL_DES_T106('TAXAMOUNT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.TAXAMOUNT ELSE TAXAMOUNT END,
                    --VATAMOUNT = CASE VL_DES_T106('VATAMOUNT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.VATAMOUNT ELSE VATAMOUNT END,
                    --INCREASEAMOUNT = CASE VL_DES_T106('INCREASEAMOUNT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.INCREASEAMOUNT ELSE INCREASEAMOUNT END,
                    --DISCOUNTAMOUNT = CASE VL_DES_T106('DISCOUNTAMOUNT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.DISCOUNTAMOUNT ELSE DISCOUNTAMOUNT END,
                    --GIFTAMOUNT = CASE VL_DES_T106('GIFTAMOUNT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.GIFTAMOUNT ELSE GIFTAMOUNT END,
                    --ENDUSERPRICE = CASE VL_DES_T106('ENDUSERPRICE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.ENDUSERPRICE ELSE ENDUSERPRICE END,
                    --CODAZCAPP = CASE VL_DES_T106('CODAZCAPP.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODAZCAPP ELSE CODAZCAPP END,
                    --FLGEFFBCKORD = CASE VL_DES_T106('FLGEFFBCKORD.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.FLGEFFBCKORD ELSE FLGEFFBCKORD END,
                    --CODBCKORDCAUSE = CASE VL_DES_T106('CODBCKORDCAUSE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODBCKORDCAUSE ELSE CODBCKORDCAUSE END,
                    --GROSSARTAMOUNT = CASE VL_DES_T106('GROSSARTAMOUNT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.GROSSARTAMOUNT ELSE GROSSARTAMOUNT END,
                    --NETARTAMOUNT = CASE VL_DES_T106('NETARTAMOUNT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.NETARTAMOUNT ELSE NETARTAMOUNT END,
                    --CODSRC = CASE VL_DES_T106('CODSRC.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODSRC ELSE CODSRC END,
                    --CODSRCREF = CASE VL_DES_T106('CODSRCREF.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODSRCREF ELSE CODSRCREF END,
                    --CODBENCAUSE = CASE VL_DES_T106('CODBENCAUSE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODBENCAUSE ELSE CODBENCAUSE END,
                    --CODBENSUBCAUSE = CASE VL_DES_T106('CODBENSUBCAUSE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODBENSUBCAUSE ELSE CODBENSUBCAUSE END,
                    --BENNOTE = CASE VL_DES_T106('BENNOTE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.BENNOTE ELSE BENNOTE END,
                    --AZCTOAPPLY = CASE VL_DES_T106('AZCTOAPPLY.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.AZCTOAPPLY ELSE AZCTOAPPLY END,
                   -- CODOPERATION = CASE VL_DES_T106('CODOPERATION.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODOPERATION ELSE CODOPERATION END,
                   -- DISCOUNTAMOUNTOUTINV = CASE VL_DES_T106('DISCOUNTAMOUNTOUTINV.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.DISCOUNTAMOUNTOUTINV ELSE DISCOUNTAMOUNTOUTINV END,
                    --CODACCAPP = CASE VL_DES_T106('CODACCAPP.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODACCAPP ELSE CODACCAPP END,
                    --CODTYPROWCAUSE = CASE VL_DES_T106('CODTYPROWCAUSE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODTYPROWCAUSE ELSE CODTYPROWCAUSE END,
                    --CODARTCUST = CASE VL_DES_T106('CODARTCUST.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODARTCUST ELSE CODARTCUST END,
                    --QTYRESO = CASE VL_DES_T106('QTYRESO.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.QTYRESO ELSE QTYRESO END,
                    --NUMORDRESO = CASE VL_DES_T106('NUMORDRESO.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.NUMORDRESO ELSE NUMORDRESO END,
                    --CODBLCCAUSE = CASE VL_DES_T106('CODBLCCAUSE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODBLCCAUSE ELSE CODBLCCAUSE END,
                    --CODARTKITREF = CASE VL_DES_T106('CODARTKITREF.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODARTKITREF ELSE CODARTKITREF END,
                    --NUMROWKITREF = CASE VL_DES_T106('NUMROWKITREF.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.NUMROWKITREF ELSE NUMROWKITREF END,
                    --CODCAUSEKIT = CASE VL_DES_T106('CODCAUSEKIT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODCAUSEKIT ELSE CODCAUSEKIT END,
                    --NETARTAMOUNTTEO = CASE VL_DES_T106('NETARTAMOUNTTEO.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.NETARTAMOUNTTEO ELSE NETARTAMOUNTTEO END,
                    --NETAMOUNTTEO = CASE VL_DES_T106('NETAMOUNTTEO.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.NETAMOUNTTEO ELSE NETAMOUNTTEO END,
                    --NETAMOUNTMIN = CASE VL_DES_T106('NETAMOUNTMIN.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.NETAMOUNTMIN ELSE NETAMOUNTMIN END,
                    --NETAMOUNTMAX = CASE VL_DES_T106('NETAMOUNTMAX.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.NETAMOUNTMAX ELSE NETAMOUNTMAX END,
                    --NETDIFF = CASE VL_DES_T106('NETDIFF.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.NETDIFF ELSE NETDIFF END,
                    --COD_ABBINAMENTO_KIT = CASE VL_DES_T106('COD_ABBINAMENTO_KIT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.COD_ABBINAMENTO_KIT ELSE COD_ABBINAMENTO_KIT END,
                    --NUMROWORIG = CASE VL_DES_T106('NUMROWORIG.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.NUMROWORIG ELSE NUMROWORIG END,
                    --FLGFIRSTSON = CASE VL_DES_T106('FLGFIRSTSON.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.FLGFIRSTSON ELSE FLGFIRSTSON END,
                    --NETARTAMOUNTCUST = CASE VL_DES_T106('NETARTAMOUNTCUST.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.NETARTAMOUNTCUST ELSE NETARTAMOUNTCUST END,
                    --NETARTAMOUNTCUST2 = CASE VL_DES_T106('NETARTAMOUNTCUST2.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.NETARTAMOUNTCUST2 ELSE NETARTAMOUNTCUST2 END,
                    --GROSSARTAMOUNTCUST = CASE VL_DES_T106('GROSSARTAMOUNTCUST.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.GROSSARTAMOUNTCUST ELSE GROSSARTAMOUNTCUST END,
                    --NETAMOUNTCUST = CASE VL_DES_T106('NETAMOUNTCUST.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.NETAMOUNTCUST ELSE NETAMOUNTCUST END,
                    --QTYORDEDI = CASE VL_DES_T106('QTYORDEDI.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.QTYORDEDI ELSE QTYORDEDI END,
                    --CODEAN = CASE VL_DES_T106('CODEAN.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODEAN ELSE CODEAN END,
                    --UMORDEDI = CASE VL_DES_T106('UMORDEDI.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.UMORDEDI ELSE UMORDEDI END,
                    --NUMROWREF = CASE VL_DES_T106('NUMROWREF.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.NUMROWREF ELSE NUMROWREF END,
                    --FLGOMGPROMO = CASE VL_DES_T106('FLGOMGPROMO.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.FLGOMGPROMO ELSE FLGOMGPROMO END,
                    --GROSSARTAMOUNTORD = CASE VL_DES_T106('GROSSARTAMOUNTORD.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.GROSSARTAMOUNTORD ELSE GROSSARTAMOUNTORD END,
                    --GROSSARTAMOUNTDELTA = CASE VL_DES_T106('GROSSARTAMOUNTDELTA.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.GROSSARTAMOUNTDELTA ELSE GROSSARTAMOUNTDELTA END,
                    --FLGOMGDISCLIST = CASE VL_DES_T106('FLGOMGDISCLIST.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.FLGOMGDISCLIST ELSE FLGOMGDISCLIST END,
                    --CODCNVPDA = CASE VL_DES_T106('CODCNVPDA.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODCNVPDA ELSE CODCNVPDA END,
                    --DTEEVA = CASE VL_DES_T106('DTEEVA.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.DTEEVA ELSE DTEEVA END,
                    --CODPAYTRM = CASE VL_DES_T106('CODPAYTRM.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODPAYTRM ELSE CODPAYTRM END,
                    --CODPAYMOD = CASE VL_DES_T106('CODPAYMOD.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODPAYMOD ELSE CODPAYMOD END,
                    NUMORDHOST = CASE VL_DES_T106('NUMORDHOST.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.NUMORDHOST ELSE NUMORDHOST END,
                    NUMROWHOST = CASE VL_DES_T106('NUMROWHOST.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.NUMROWHOST ELSE NUMROWHOST END  --,
                    --CODMODSHIP = CASE VL_DES_T106('CODMODSHIP.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODMODSHIP ELSE CODMODSHIP END,
                    --CODMODDELIV = CASE VL_DES_T106('CODMODDELIV.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODMODDELIV ELSE CODMODDELIV END,
                    --CODWHS = CASE VL_DES_T106('CODWHS.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODWHS ELSE CODWHS END,
                    --DTEPRICE = CASE VL_DES_T106('DTEPRICE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.DTEPRICE ELSE DTEPRICE END,
                    --DTEDELIVTO = CASE VL_DES_T106('DTEDELIVTO.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.DTEDELIVTO ELSE DTEDELIVTO END,
                    --CODROWGROUP = CASE VL_DES_T106('CODROWGROUP.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODROWGROUP ELSE CODROWGROUP END,
                    --NETAMOUNTGIFT = CASE VL_DES_T106('NETAMOUNTGIFT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.NETAMOUNTGIFT ELSE NETAMOUNTGIFT END,
                    --NETARTAMOUNTEDI = CASE VL_DES_T106('NETARTAMOUNTEDI.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.NETARTAMOUNTEDI ELSE NETARTAMOUNTEDI END,
                    --GROSSARTAMOUNTEDI = CASE VL_DES_T106('GROSSARTAMOUNTEDI.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.GROSSARTAMOUNTEDI ELSE GROSSARTAMOUNTEDI END,
                    --QTYORDORIG = CASE VL_DES_T106('QTYORDORIG.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.QTYORDORIG ELSE QTYORDORIG END,
                    --QTYALLOCATED = CASE VL_DES_T106('QTYALLOCATED.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.QTYALLOCATED ELSE QTYALLOCATED END,
                    --RETURNAMOUNT = CASE VL_DES_T106('RETURNAMOUNT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.RETURNAMOUNT ELSE RETURNAMOUNT END

                 WHERE NUMORD = REC_T106.NUMORD
                   --AND CODUSR = REC_T106.CODUSR
                   AND NUMROW = REC_T106.NUMROW ;

               else
                  -- record does not exists , we insert it
                  VL_MESSAGE_D := 'Insert T106 ';
                  
                  INSERT INTO T106ORDROW VALUES REC_T106;
               end if;
              VL_INS_T106 := VL_INS_T106 + 1;
             end if;

       END LOOP;   --T106ORDROW
       END IF;
       EXCEPTION WHEN OTHERS THEN
             VL_STATUS := -1;
             VL_MESSAGE_H := SUBSTR(VL_MESSAGE_H||' '||VL_MESSAGE_D||' '||dbms_utility.format_error_backtrace() || ' ' || SQLERRM,1,4000);

             PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                           VL_PROGR_D_T106,
                                           SQLCODE,
                                           VL_MESSAGE_H);

      END; -- DIVISION T106

      -- Commented by Fowza, Status will be coming from ERP. Date : 14-Apr-2015
      --if vl_status = 0 then
      -- Calculate Head Totals and Head Status
      --LOAD_T10X_HEAD_STEP3( PI_PROGR_H,
       --                     VL_PROGR_D_T100,
       --                     REC_T100,
       --                     VL_STATUS);

      --end if;
      IF (VL_STATUS = 0 ) THEN
          -- when status <> 0 some fields have incorrect format. Log t800 has been already wrote by F_CHECK function
          -- Update article if already exists

           VL_MESSAGE_D := 'Update T100ORDHEAD ';
           UPDATE T100ORDHEAD
           SET
            -- when the field si set to updated by host it means that the value should be read from XIN
               -- otherwise it means that the field is managed by sm1 and it maintains its original value
              CODEUSR = CASE VL_DES_T100('CODEUSR.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODEUSR ELSE CODEUSR END,
              CODTYPORD = CASE VL_DES_T100('CODTYPORD.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODTYPORD ELSE CODTYPORD END,
              CODSTATUS = CASE VL_DES_T100('CODSTATUS.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODSTATUS ELSE CODSTATUS END,
              CODDIV = CASE VL_DES_T100('CODDIV.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODDIV ELSE CODDIV END,
              CODBLCCAUSE = CASE VL_DES_T100('CODBLCCAUSE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODBLCCAUSE ELSE CODBLCCAUSE END,
              DTEORD = CASE VL_DES_T100('DTEORD.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.DTEORD ELSE DTEORD END,
              DTEDELIV = CASE VL_DES_T100('DTEDELIV.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.DTEDELIV ELSE DTEDELIV END,
              CODTYPDELIV = CASE VL_DES_T100('CODTYPDELIV.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODTYPDELIV ELSE CODTYPDELIV END,
              DTEEVA = CASE VL_DES_T100('DTEEVA.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.DTEEVA ELSE DTEEVA END,
              CODPAYTRM = CASE VL_DES_T100('CODPAYTRM.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODPAYTRM ELSE CODPAYTRM END,
              CODPAYMOD = CASE VL_DES_T100('CODPAYMOD.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODPAYMOD ELSE CODPAYMOD END,
              --CODCUSTDELIV = CASE VL_DES_T100('CODCUSTDELIV.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODCUSTDELIV ELSE CODCUSTDELIV END,
              CODVATMGMT = CASE VL_DES_T100('CODVATMGMT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODVATMGMT ELSE CODVATMGMT END,
              --CODCUSTINV = CASE VL_DES_T100('CODCUSTINV.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODCUSTINV ELSE CODCUSTINV END,
              CODLIST = CASE VL_DES_T100('CODLIST.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODLIST ELSE CODLIST END,
              CODCUR = CASE VL_DES_T100('CODCUR.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODCUR ELSE CODCUR END,
              NUMORDREF = CASE VL_DES_T100('NUMORDREF.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.NUMORDREF ELSE NUMORDREF END,
              NUMORDHOST = CASE VL_DES_T100('NUMORDHOST.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.NUMORDHOST ELSE NUMORDHOST END,
              NUMORDCUST = CASE VL_DES_T100('NUMORDCUST.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.NUMORDCUST ELSE NUMORDCUST END,
              DTEORDCUST = CASE VL_DES_T100('DTEORDCUST.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.DTEORDCUST ELSE DTEORDCUST END,
              CODASSORTMENT = CASE VL_DES_T100('CODASSORTMENT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODASSORTMENT ELSE CODASSORTMENT END,
              CODCANVASS = CASE VL_DES_T100('CODCANVASS.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODCANVASS ELSE CODCANVASS END,
              CODMODSHIP = CASE VL_DES_T100('CODMODSHIP.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODMODSHIP ELSE CODMODSHIP END,
              CODMODDELIV = CASE VL_DES_T100('CODMODDELIV.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODMODDELIV ELSE CODMODDELIV END,
              CODAGREEMENT = CASE VL_DES_T100('CODAGREEMENT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODAGREEMENT ELSE CODAGREEMENT END,
              DESAGREEMENT = CASE VL_DES_T100('DESAGREEMENT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.DESAGREEMENT ELSE DESAGREEMENT END,
              CODUSRAUT = CASE VL_DES_T100('CODUSRAUT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODUSRAUT ELSE CODUSRAUT END,
              CODAGREECLASS = CASE VL_DES_T100('CODAGREECLASS.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODAGREECLASS ELSE CODAGREECLASS END,
              DTEAUT = CASE VL_DES_T100('DTEAUT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.DTEAUT ELSE DTEAUT END,
              CODTYPAUT = CASE VL_DES_T100('CODTYPAUT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODTYPAUT ELSE CODTYPAUT END,
              DESAUT = CASE VL_DES_T100('DESAUT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.DESAUT ELSE DESAUT END,

              GROSSAMOUNT = CASE VL_DES_T100('GROSSAMOUNT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.GROSSAMOUNT ELSE GROSSAMOUNT END,
              NETAMOUNT = CASE VL_DES_T100('NETAMOUNT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.NETAMOUNT ELSE NETAMOUNT END,
              TAXAMOUNT = CASE VL_DES_T100('TAXAMOUNT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.TAXAMOUNT ELSE TAXAMOUNT END,
              VATAMOUNT = CASE VL_DES_T100('VATAMOUNT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.VATAMOUNT ELSE VATAMOUNT END,
              INCREASEAMOUNT = CASE VL_DES_T100('INCREASEAMOUNT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.INCREASEAMOUNT ELSE INCREASEAMOUNT END,
              DISCOUNTAMOUNT = CASE VL_DES_T100('DISCOUNTAMOUNT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.DISCOUNTAMOUNT ELSE DISCOUNTAMOUNT END,
              GIFTAMOUNT = CASE VL_DES_T100('GIFTAMOUNT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.GIFTAMOUNT ELSE GIFTAMOUNT END,
              FLGANN = CASE VL_DES_T100('FLGANN.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.FLGANN ELSE FLGANN END,
              CODABI = CASE VL_DES_T100('CODABI.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODABI ELSE CODABI END,
              CODCAB = CASE VL_DES_T100('CODCAB.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODCAB ELSE CODCAB END,
              DESBAN = CASE VL_DES_T100('DESBAN.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.DESBAN ELSE DESBAN END,
              DESBRA = CASE VL_DES_T100('DESBRA.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.DESBRA ELSE DESBRA END,
              DESADDR = CASE VL_DES_T100('DESADDR.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.DESADDR ELSE DESADDR END,
              DESLOC = CASE VL_DES_T100('DESLOC.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.DESLOC ELSE DESLOC END,
              DESPRV = CASE VL_DES_T100('DESPRV.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.DESPRV ELSE DESPRV END,
              QTYTOT = CASE VL_DES_T100('QTYTOT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.QTYTOT ELSE QTYTOT END,
              CODPRV = CASE VL_DES_T100('CODPRV.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODPRV ELSE CODPRV END,
              UMQTYTOT = CASE VL_DES_T100('UMQTYTOT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.UMQTYTOT ELSE UMQTYTOT END,
              CODACCOUNT = CASE VL_DES_T100('CODACCOUNT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODACCOUNT ELSE CODACCOUNT END,
              FLGRETURN = CASE VL_DES_T100('FLGRETURN.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.FLGRETURN ELSE FLGRETURN END,
              FLGHOSTED = CASE VL_DES_T100('FLGHOSTED.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.FLGHOSTED ELSE FLGHOSTED END,
              FLGCONFIRMED = CASE VL_DES_T100('FLGCONFIRMED.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.FLGCONFIRMED ELSE FLGCONFIRMED END,
              --CODWHS = CASE VL_DES_T100('CODWHS.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODWHS ELSE CODWHS END,   ---
              CODSHIPPER = CASE VL_DES_T100('CODSHIPPER.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODSHIPPER ELSE CODSHIPPER END,
              CODAZCAPP = CASE VL_DES_T100('CODAZCAPP.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODAZCAPP ELSE CODAZCAPP END,
              CODAZCBEN = CASE VL_DES_T100('CODAZCBEN.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODAZCBEN ELSE CODAZCBEN END,
              DTEPRICE = CASE VL_DES_T100('DTEPRICE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.DTEPRICE ELSE DTEPRICE END,
              CODTYPSALE = CASE VL_DES_T100('CODTYPSALE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODTYPSALE ELSE CODTYPSALE END,
              FLGCHECKPROMO = CASE VL_DES_T100('FLGCHECKPROMO.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.FLGCHECKPROMO ELSE FLGCHECKPROMO END,
              CODAGREETYPE = CASE VL_DES_T100('CODAGREETYPE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODAGREETYPE ELSE CODAGREETYPE END,
              CODSTATUSMAN = CASE VL_DES_T100('CODSTATUSMAN.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODSTATUSMAN ELSE CODSTATUSMAN END,
              DISCOUNTAMOUNTOUTINV = CASE VL_DES_T100('DISCOUNTAMOUNTOUTINV.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.DISCOUNTAMOUNTOUTINV ELSE DISCOUNTAMOUNTOUTINV END,
              CODTYPORDCUST = CASE VL_DES_T100('CODTYPORDCUST.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODTYPORDCUST ELSE CODTYPORDCUST END,
              CODUSR3 = CASE VL_DES_T100('CODUSR3.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODUSR3 ELSE CODUSR3 END,
              DTEDELIVTO = CASE VL_DES_T100('DTEDELIVTO.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.DTEDELIVTO ELSE DTEDELIVTO END,
              CODCIN = CASE VL_DES_T100('CODCIN.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODCIN ELSE CODCIN END,
              FLGUMORD2 = CASE VL_DES_T100('FLGUMORD2.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.FLGUMORD2 ELSE FLGUMORD2 END,
              NETAMOUNTTEO = CASE VL_DES_T100('NETAMOUNTTEO.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.NETAMOUNTTEO ELSE NETAMOUNTTEO END,
              NETAMOUNTMIN = CASE VL_DES_T100('NETAMOUNTMIN.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.NETAMOUNTMIN ELSE NETAMOUNTMIN END,
              NETAMOUNTMAX = CASE VL_DES_T100('NETAMOUNTMAX.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.NETAMOUNTMAX ELSE NETAMOUNTMAX END,
              CODUSR4 = CASE VL_DES_T100('CODUSR4.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODUSR4 ELSE CODUSR4 END,
              CODUSR2 = CASE VL_DES_T100('CODUSR2.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODUSR2 ELSE CODUSR2 END,
              CODBUYEREDI = CASE VL_DES_T100('CODBUYEREDI.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODBUYEREDI ELSE CODBUYEREDI END,
              --CODCUSTINVEDI = CASE VL_DES_T100('CODCUSTINVEDI.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODCUSTINVEDI ELSE CODCUSTINVEDI END,
              --CODCUSTDELIVEDI = CASE VL_DES_T100('CODCUSTDELIVEDI.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODCUSTDELIVEDI ELSE CODCUSTDELIVEDI END,
              CODSELLEREDI = CASE VL_DES_T100('CODSELLEREDI.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODSELLEREDI ELSE CODSELLEREDI END,

              CODUSR6 = CASE VL_DES_T100('CODUSR6.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODUSR6 ELSE CODUSR6 END,
              CODPDV = CASE VL_DES_T100('CODPDV.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODPDV ELSE CODPDV END,
              CODCUSTCONC = CASE VL_DES_T100('CODCUSTCONC.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODCUSTCONC ELSE CODCUSTCONC END,
              CODIBAN = CASE VL_DES_T100('CODIBAN.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODIBAN ELSE CODIBAN END,
              BACKAMOUNT = CASE VL_DES_T100('BACKAMOUNT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.BACKAMOUNT ELSE BACKAMOUNT END,
              TOTPALLETS = CASE VL_DES_T100('TOTPALLETS.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.TOTPALLETS ELSE TOTPALLETS END,
              GROSSWEIGHT = CASE VL_DES_T100('GROSSWEIGHT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.GROSSWEIGHT ELSE GROSSWEIGHT END,
              TOTMC = CASE VL_DES_T100('TOTMC.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.TOTMC ELSE TOTMC END,
              DTEPROPDELIV = CASE VL_DES_T100('DTEPROPDELIV.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.DTEPROPDELIV ELSE DTEPROPDELIV END,
              CODUSR5 = CASE VL_DES_T100('CODUSR5.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODUSR5 ELSE CODUSR5 END,
              --IDSURVEY = CASE VL_DES_T100('IDSURVEY.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.IDSURVEY ELSE IDSURVEY END,
              --CODCUSTSALE = CASE VL_DES_T100('CODCUSTSALE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODCUSTSALE ELSE CODCUSTSALE END,
              FLGPROCESSEDEDI = CASE VL_DES_T100('FLGPROCESSEDEDI.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.FLGPROCESSEDEDI ELSE FLGPROCESSEDEDI END,
              FLGEDI = CASE VL_DES_T100('FLGEDI.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.FLGEDI ELSE FLGEDI END,
              NUMESENZIONE = CASE VL_DES_T100('NUMESENZIONE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.NUMESENZIONE ELSE NUMESENZIONE END,
              DTEDELIV2 = CASE VL_DES_T100('DTEDELIV2.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.DTEDELIV2 ELSE DTEDELIV2 END,
              DTEDELIV3 = CASE VL_DES_T100('DTEDELIV3.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.DTEDELIV3 ELSE DTEDELIV3 END,
              DTEDELIV4 = CASE VL_DES_T100('DTEDELIV4.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.DTEDELIV4 ELSE DTEDELIV4 END,
              DTEDELIV5 = CASE VL_DES_T100('DTEDELIV5.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.DTEDELIV5 ELSE DTEDELIV5 END,
              IDROUTE = CASE VL_DES_T100('IDROUTE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.IDROUTE ELSE IDROUTE END,
              NUMDOC = CASE VL_DES_T100('NUMDOC.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.NUMDOC ELSE NUMDOC END,
              DTECLOSE = CASE VL_DES_T100('DTECLOSE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.DTECLOSE ELSE DTECLOSE END,
              RETURNAMOUNT = CASE VL_DES_T100('RETURNAMOUNT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.RETURNAMOUNT ELSE RETURNAMOUNT END,

               --- Technical fields
               CODUSRMOD = REC_T100.CODUSRMOD,
               DTEMOD    = REC_T100.DTEMOD,
               -- lock fields
               CODUSRLCK    = REC_T100.CODUSRLCK,
               IDSESSIONLCK = REC_T100.IDSESSIONLCK,
               DTELCK       = REC_T100.DTELCK

         WHERE NUMORD = REC_T100.NUMORD
          AND  CODUSR = REC_T100.CODUSR
          AND (idsessionlck = REC_T100.IDSESSIONLCK
               or not exists
                     ( select null from T035LOGGEDUSERS T035
                      where T035.IDSESSION = NVL(IDSESSIONLCK, '@') AND T035.LASTCHECK > TRUNC(XSYSDATE)-1 )
               );


        END IF; -- VL_STATUS = 0


        EXCEPTION WHEN OTHERS THEN
             VL_STATUS := -1;
             VL_MESSAGE_H := SUBSTR(VL_MESSAGE_H||' '||VL_MESSAGE_D||' '||dbms_utility.format_error_backtrace() || ' ' || SQLERRM,1,4000);

             PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                           VL_PROGR_D_T100,
                                           SQLCODE,
                                           VL_MESSAGE_H);

        END; -- HEAD T100


     -- if all records have been stored with success then it makes the final commit
      IF VL_STATUS = 0 THEN
         VL_INS_T100 := VL_INS_T100 + 1;
         COMMIT;
      ELSE
        ROLLBACK;
      END IF;

      IF (VL_STATUS <> 0 OR VL_RECORD_LOCKED <> 0) THEN
          UPDATE XIN_T106ORDROW
          SET  SM1_STATUS= CASE
                                WHEN VL_RECORD_LOCKED <> 0  THEN C_XINSTATUS_LOCK
                                ELSE C_XINSTATUS_ERR END
          WHERE CODUSR = RL_XIN_T100.CODUSR
           AND  SM1_CODPROCESS = PI_PROGR_H
           AND  SM1_DTECRE     = RL_XIN_T100.SM1_DTECRE
           AND  SM1_STATUS     = C_XINSTATUS_OK;

          -- TO CHECK this update is  not correct in case of double record .
          UPDATE XIN_T100ORDHEAD
          SET  SM1_STATUS= CASE
                                WHEN VL_RECORD_LOCKED <> 0  THEN C_XINSTATUS_LOCK
                                ELSE C_XINSTATUS_ERR END
          WHERE CODUSR = RL_XIN_T100.CODUSR
           AND  SM1_CODPROCESS = PI_PROGR_H
           AND  SM1_DTECRE     <= RL_XIN_T100.SM1_DTECRE
           AND  SM1_STATUS     = C_XINSTATUS_OK;

          COMMIT;
      END IF;

        -- Release updated records
          UPDATE T100ORDHEAD
          SET       DTELCK          = NULL,
                    IDSESSIONLCK    = NULL,
                    CODUSRLCK       = NULL
          WHERE CODUSR = REC_T100.CODUSR AND CODUSRLCK = C_SYSUSR AND IDSESSIONLCK = PI_SESSION_ID;
          COMMIT;
    END LOOP;  -- T100ORDHEAD


    -- Moves records from staging area to log staging area
    P_XIN_MOVE_TO_LOG(PI_PROGR_H, VL_PROGR_D_T100,'T106ORDROW');
    P_XIN_MOVE_TO_LOG(PI_PROGR_H, VL_PROGR_D_T100,'T100ORDHEAD');

   -- Close Logs
    PKG_UTILS.LOG_END_DETAIL(PI_PROGR_H,
                             VL_PROGR_D_T106,
                             0,
                             VL_COUNT_XIN_T106,
                             VL_INS_T106,
                             VL_COUNT_XIN_T106 - VL_INS_T106);

    PKG_UTILS.LOG_END_DETAIL(PI_PROGR_H,
                             VL_PROGR_D_T100,
                             0,
                             VL_COUNT_XIN_T100,
                             VL_INS_T100,
                             VL_COUNT_XIN_T100 - VL_INS_T100);


    PO_MSG    := VL_INS_T100||'/'||VL_COUNT_XIN_T100||' Orders loaded';
    PO_STATUS := VL_INS_T100;


    --
  EXCEPTION WHEN EX_EXIT THEN

          ROLLBACK;
          VL_MESSAGE_H       := VL_MESSAGE_H || TRIM(SUBSTR(dbms_utility.format_error_backtrace() || ' ' || SQLERRM, 1, 255));
          PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                         VL_PROGR_D_T100,
                                         SQLCODE,
                                         VL_MESSAGE_H);

          PO_MSG := VL_MESSAGE_H;
          PO_STATUS := -1;

   WHEN OTHERS THEN

          ROLLBACK;
         -- Release updated records
            UPDATE T100ORDHEAD
            SET       DTELCK          = NULL,
                      IDSESSIONLCK    = NULL,
                      CODUSRLCK       = NULL
            WHERE CODUSRLCK = C_SYSUSR AND IDSESSIONLCK = PI_SESSION_ID;
            COMMIT;
          -- Moves records from staging area to log staging area
          P_XIN_MOVE_TO_LOG(PI_PROGR_H, VL_PROGR_D_T100,'T106ORDROW');
          P_XIN_MOVE_TO_LOG(PI_PROGR_H, VL_PROGR_D_T100,'T100ORDHEAD');

          VL_MESSAGE_H       := VL_MESSAGE_H || TRIM(SUBSTR(dbms_utility.format_error_backtrace() || ' ' || SQLERRM, 1, 255));

          PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                         VL_PROGR_D_T100,
                                         SQLCODE,
                                         VL_MESSAGE_H);

          PO_MSG := VL_MESSAGE_H;
          PO_STATUS := VL_STATUS;

    END;
    
    
    
    PROCEDURE LOAD_T100_ORDERS_SYG (PI_PROGR_H       IN NUMBER,
                              PI_SESSION_ID    IN NUMBER,
                              PO_MSG           OUT NOCOPY VARCHAR2,
                              PO_STATUS        OUT NOCOPY NUMBER ) IS

    -- -----------------------------------------
    -- Cursor on Orde Heads xin_t100ordhead
    -- -----------------------------------------
    CURSOR CL_XIN_T100 IS
      SELECT * FROM  XIN_T100ORDHEAD
        WHERE SM1_CODPROCESS = PI_PROGR_H
        ORDER BY NUMORDHOST, SM1_DTECRE;
    -- -----------------------------------------
    -- Cursor on Order Rows xin_t106_ordrow
    -- -----------------------------------------
    CURSOR CL_XIN_T106(CI_NUMORDHOST VARCHAR2, CI_SM1_DTECRE DATE) IS
      SELECT
        ORDROW.*,T.Codwhs AS VANWHS
        FROM  XIN_T106ORDROW  ORDROW INNER JOIN
        T100ORDHEAD T ON ORDROW.NUMORD = T.NUMORD
        WHERE ORDROW.NUMORDHOST = CI_NUMORDHOST
        AND   ORDROW.SM1_CODPROCESS = PI_PROGR_H
        AND ORDROW.SM1_STATUS = C_XINSTATUS_OK -- Only those that have not processed yet (in case of double record in xin)
        ORDER BY ORDROW.SM1_DTECRE;

      VL_MESSAGE_H   VARCHAR2(4000) := 'Error while loading Orders T100/T106';
      VL_MESSAGE_D   VARCHAR2(4000) := NULL;
      VL_PROGR_D_T100    NUMBER := 0;
      VL_COUNT_XIN_T100  NUMBER := 0;
      VL_INS_T100        NUMBER := 0;
      VL_PROGR_D_T106    NUMBER := 0;
      VL_COUNT_XIN_T106  NUMBER := 0;
      VL_INS_T106        NUMBER := 0;
      REC_T100      T100ORDHEAD%ROWTYPE    := NULL;
      REC_T100_INIT T100ORDHEAD%ROWTYPE    := NULL;
      REC_T106      T106ORDROW%ROWTYPE := NULL;
      REC_T106_INIT T106ORDROW%ROWTYPE := NULL;
      VL_DES_T100     X_FIELD_INFO_ARRAY;-- Array with fields db info
      VL_DES_T106     X_FIELD_INFO_ARRAY;-- Array with fields db info
      VL_RECORD_LOCKED NUMBER := 0;
      VL_STATUS NUMBER:= 0;
      VL_STEP   NUMBER:= 0; -- Used to ping t035
      EX_EXIT  EXCEPTION;
      VL_CODDIV VARCHAR2(30) := NULL;
      VL_CODWHS VARCHAR2(30) := NULL;
      vl_ins_upd VARCHAR2(3) := NULL;
      
      
  BEGIN
  --ADD BY MADY 20200311
  REC_T100.FLGPROCESSEDASSET := 0;
  REC_T100_INIT.FLGPROCESSEDASSET := 0;
    
    -- init indexes and rebuild statistics
    P_XIN_INIT_INDEXES (PI_PROGR_H, 'T100ORDHEAD');
    P_XIN_INIT_INDEXES (PI_PROGR_H, 'T106ORDROW');
    -- clean log
    P_XIN_CLEANUP_LOG (PI_PROGR_H, 'T100ORDHEAD');
    P_XIN_CLEANUP_LOG (PI_PROGR_H, 'T106ORDROW');

    VL_PROGR_D_T100 := PKG_UTILS.LOG_NEW_DETAIL(PI_PROGR_H,
                                       'ORDER HEAD',
                                       'IMPORT --> T100ORDHEAD SYG',
                                        0,
                                        NULL);
    VL_PROGR_D_T106 := PKG_UTILS.LOG_NEW_DETAIL(PI_PROGR_H,
                                       'ORDER ROWS',
                                       'IMPORT --> T106ORDROW SYG',
                                        0,
                                        NULL);

    -- retrieves configuration parameters
    LOAD_T10X_CONF_STEP0(
                          VL_MESSAGE_H,
                          VL_STATUS   );

    if (vl_status <> 0 ) then
         PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                        VL_PROGR_D_T100,
                                        SQLCODE,
                                        VL_MESSAGE_H);

         raise EX_EXIT;
    end if;
  
  
    BEGIN
      -- ----------------------------------------------------------
      -- Init arrays with FIELD_NAME=LENGTH and FIELDNAME=SM1_DEFAULT for all fields of table
      -- ----------------------------------------------------------
      VL_DES_T100.DELETE;
      P_INIT_SM1_FIELD_ARRAY ('T100ORDHEAD', VL_DES_T100, VL_STATUS, VL_MESSAGE_H);
      execute immediate ( GL_INIT_REC) INTO REC_T100_INIT;

      VL_DES_T106.DELETE;
      P_INIT_SM1_FIELD_ARRAY ('T106ORDROW', VL_DES_T106, VL_STATUS, VL_MESSAGE_H);
      execute immediate ( GL_INIT_REC) INTO REC_T106_INIT;

      IF (VL_STATUS <> 0 ) THEN
            VL_MESSAGE_D := GL_INIT_REC;
            RAISE EX_EXIT;
      END IF;               
      
        EXCEPTION WHEN OTHERS THEN
          VL_MESSAGE_D := GL_INIT_REC;
        RAISE EX_EXIT;
    END;  

    -- --------------------------------------------------------------
    -- Identifies Xin records to be loaded
    -- --------------------------------------------------------------
    BEGIN
    
      VL_MESSAGE_D := 'XIN_T100ORDHEAD';
      UPDATE XIN_T100ORDHEAD
      SET SM1_CODPROCESS = PI_PROGR_H,
            SM1_STATUS = 0,
            SM1_DTEPROCESS = XSYSDATE
            WHERE 
        CODDIV IN ('SYG')
        AND CODTYPORD IN ('50') --   for 51 do we have another integration ?.
        AND NVL(SM1_CODPROCESS, 0) = C_SM1_NULL_CODPROCESS
        -- and numord='160034581'-- added for testing 
           ; 
      VL_COUNT_XIN_T100 := SQL%ROWCOUNT; -- not using, added for debugging. 
      
      
      VL_MESSAGE_D := 'XIN_T106ORDROW';
      UPDATE XIN_T106ORDROW D
      SET D.SM1_CODPROCESS = PI_PROGR_H,
            D.SM1_STATUS = 0,
            D.SM1_DTEPROCESS = XSYSDATE
            WHERE NVL(D.SM1_CODPROCESS,0) = C_SM1_NULL_CODPROCESS
            AND D.NUMORDHOST IN ( SELECT H.NUMORDHOST FROM XIN_T100ORDHEAD H WHERE H.SM1_CODPROCESS = PI_PROGR_H);
            VL_COUNT_XIN_T106 := SQL%ROWCOUNT; -- not using, added for debugging.
    
     
            PKG_SALES_FORCE_DAL_CUST.calc_van_stock_balance( PI_PROGR_H, PI_SESSION_ID) ; -- calculate current stock for all whs used in xin_t100 
                                                    -- in this session 
                                                    
        dbms_output.put_line('successfully returned back from stock calculation procedure');

      COMMIT;
        EXCEPTION WHEN OTHERS THEN
          ROLLBACK;
          VL_MESSAGE_H := 'Error while Reading Staging area: '||VL_MESSAGE_D;
      dbms_output.put_line('updating t106 or calculating stock balance failed' );
          RAISE EX_EXIT;  --- this exeception should be here ?.

    END;

  
  
    -- --------------------------------------------------------------
    -- loop in main table T100ORDHEAD
    -- --------------------------------------------------------------
    FOR RL_XIN_T100 IN CL_XIN_T100 LOOP
    -- pings to t035 every 100 cicles--
    VL_STEP := VL_STEP + 1;

    IF ( MOD(VL_STEP, 100) = 0 ) THEN
         PKG_UTILS.user_ping(PI_SESSION_ID);
    END IF;

    VL_STATUS := 0;
    VL_MESSAGE_H :=   'Order NumordHost : '   ||RL_XIN_T100.NUMORDHOST;
 
      BEGIN --- HEAD T100

        dbms_output.put_line(' Deleting inventory from t078');
    -- --------------------------------------------------------------
    -- DELETE INVENTORY 
    -- --------------------------------------------------------------     
      SELECT CODWHS INTO VL_CODWHS FROM T100ORDHEAD WHERE NUMORD = RL_XIN_T100.NUMORD;
      
      DELETE FROM T078WHSBALANCE WHERE CODDIV = RL_XIN_T100.CODDIV AND 
      CODWHS = VL_CODWHS;
    -------------------------------------------------------------------
            dbms_output.put_line(' Deleted inventory from t078');
      
      -- Data Format Check
      VL_MESSAGE_D := 'Format Conversion ';
      VL_CODDIV := 'ALL';
      REC_T100 := REC_T100_INIT;
      --
      REC_T100.CODUSR := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODUSR,'CODUSR', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
      REC_T100.NUMORD := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.NUMORD,'NUMORD', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
      --
      REC_T100.CODEUSR   := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODEUSR,'CODEUSR', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
      REC_T100.CODTYPORD := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODTYPORD,'CODTYPORD', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
      REC_T100.CODSTATUS := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODSTATUS,'CODSTATUS', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
      REC_T100.CODDIV    := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODDIV,'CODDIV', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
      REC_T100.CODBLCCAUSE := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODBLCCAUSE,'CODBLCCAUSE', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
      REC_T100.DTEORD      := F_CHECK_FORMAT_D( VL_CODDIV, RL_XIN_T100.DTEORD,'DTEORD', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
      REC_T100.DTEDELIV    := F_CHECK_FORMAT_D( VL_CODDIV, RL_XIN_T100.DTEDELIV,'DTEDELIV', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
      REC_T100.CODTYPDELIV := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODTYPDELIV,'CODTYPDELIV', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
      REC_T100.DTEEVA      := F_CHECK_FORMAT_D( VL_CODDIV, RL_XIN_T100.DTEEVA,'DTEEVA', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
      REC_T100.CODPAYTRM   := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODPAYTRM,'CODPAYTRM', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
      REC_T100.CODPAYMOD   := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODPAYMOD,'CODPAYMOD', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
      REC_T100.CODCUSTDELIV := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODCUSTDELIV,'CODCUSTDELIV', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
      REC_T100.CODVATMGMT   := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODVATMGMT,'CODVATMGMT', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
      REC_T100.CODCUSTINV   := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODCUSTINV,'CODCUSTINV', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
      REC_T100.CODLIST      := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODLIST,'CODLIST', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
      REC_T100.CODCUR       := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODCUR,'CODCUR', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
      REC_T100.NUMORDREF    := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.NUMORDREF,'NUMORDREF', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
      REC_T100.NUMORDHOST   := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.NUMORDHOST,'NUMORDHOST', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
      REC_T100.NUMORDCUST   := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.NUMORDCUST,'NUMORDCUST', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
      REC_T100.DTEORDCUST   := F_CHECK_FORMAT_D( VL_CODDIV, RL_XIN_T100.DTEORDCUST,'DTEORDCUST', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
      REC_T100.CODASSORTMENT := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODASSORTMENT,'CODASSORTMENT', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
      REC_T100.CODCANVASS    := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODCANVASS,'CODCANVASS', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
      REC_T100.CODMODSHIP    := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODMODSHIP,'CODMODSHIP', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
      REC_T100.CODMODDELIV   := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODMODDELIV,'CODMODDELIV', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
      REC_T100.CODAGREEMENT  := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.CODAGREEMENT,'CODAGREEMENT', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
      REC_T100.DESAGREEMENT  := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.DESAGREEMENT,'DESAGREEMENT', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
      REC_T100.CODUSRAUT     := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODUSRAUT,'CODUSRAUT', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
      REC_T100.CODAGREECLASS := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODAGREECLASS,'CODAGREECLASS', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
      REC_T100.DTEAUT        := F_CHECK_FORMAT_D( VL_CODDIV, RL_XIN_T100.DTEAUT,'DTEAUT', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
      REC_T100.CODTYPAUT     := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODTYPAUT,'CODTYPAUT', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
      REC_T100.DESAUT        := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.DESAUT,'DESAUT', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
      REC_T100.GROSSAMOUNT   := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.GROSSAMOUNT,'GROSSAMOUNT', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
      REC_T100.NETAMOUNT     := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.NETAMOUNT,'NETAMOUNT', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
      REC_T100.TAXAMOUNT     := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.TAXAMOUNT,'TAXAMOUNT', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
      REC_T100.VATAMOUNT     := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.VATAMOUNT,'VATAMOUNT', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
      REC_T100.INCREASEAMOUNT := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.INCREASEAMOUNT,'INCREASEAMOUNT', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
      REC_T100.DISCOUNTAMOUNT := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.DISCOUNTAMOUNT,'DISCOUNTAMOUNT', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
      REC_T100.GIFTAMOUNT     := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.GIFTAMOUNT,'GIFTAMOUNT', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
      REC_T100.FLGANN         := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.FLGANN,'FLGANN', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);       
      REC_T100.CODABI         := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODABI,'CODABI', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
      REC_T100.CODCAB         := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODCAB,'CODCAB', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
      REC_T100.DESBAN         := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.DESBAN,'DESBAN', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
      REC_T100.DESBRA         := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.DESBRA,'DESBRA', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
      REC_T100.DESADDR        := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.DESADDR,'DESADDR', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
      REC_T100.DESLOC         := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.DESLOC,'DESLOC', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
      REC_T100.DESPRV         := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.DESPRV,'DESPRV', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
      REC_T100.QTYTOT         := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.QTYTOT,'QTYTOT', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
      REC_T100.CODPRV         := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODPRV,'CODPRV', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
      REC_T100.UMQTYTOT       := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.UMQTYTOT,'UMQTYTOT', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
      REC_T100.CODACCOUNT     := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODACCOUNT,'CODACCOUNT', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
      REC_T100.FLGRETURN      := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.FLGRETURN,'FLGRETURN', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
      REC_T100.FLGHOSTED      := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.FLGHOSTED,'FLGHOSTED', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
      REC_T100.FLGCONFIRMED   := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.FLGCONFIRMED,'FLGCONFIRMED', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
      --REC_T100.CODWHS         := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODWHS,'CODWHS', VL_DES_T100,VL_STATUS, VL_MESSAGE_D); --commented because while sending to sage it send as main ware house
      REC_T100.CODSHIPPER     := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODSHIPPER,'CODSHIPPER', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
      REC_T100.CODAZCAPP      := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODAZCAPP,'CODAZCAPP', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
      REC_T100.CODAZCBEN      := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODAZCBEN,'CODAZCBEN', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
      REC_T100.DTEPRICE       := F_CHECK_FORMAT_D( VL_CODDIV, RL_XIN_T100.DTEPRICE,'DTEPRICE', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
      REC_T100.CODTYPSALE     := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODTYPSALE,'CODTYPSALE', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
      REC_T100.FLGCHECKPROMO  := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.FLGCHECKPROMO,'FLGCHECKPROMO', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
      REC_T100.CODAGREETYPE   := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODAGREETYPE,'CODAGREETYPE', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
      REC_T100.CODSTATUSMAN   := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODSTATUSMAN,'CODSTATUSMAN', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
      REC_T100.DISCOUNTAMOUNTOUTINV := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.DISCOUNTAMOUNTOUTINV,'DISCOUNTAMOUNTOUTINV', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
      REC_T100.CODTYPORDCUST        := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODTYPORDCUST,'CODTYPORDCUST', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
      REC_T100.CODUSR3              := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODUSR3,'CODUSR3', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
      REC_T100.DTEDELIVTO           := F_CHECK_FORMAT_D( VL_CODDIV, RL_XIN_T100.DTEDELIVTO,'DTEDELIVTO', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
      REC_T100.CODCIN               := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODCIN,'CODCIN', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
      REC_T100.FLGUMORD2            := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.FLGUMORD2,'FLGUMORD2', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
      REC_T100.NETAMOUNTTEO         := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.NETAMOUNTTEO,'NETAMOUNTTEO', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
      REC_T100.NETAMOUNTMIN         := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.NETAMOUNTMIN,'NETAMOUNTMIN', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
      REC_T100.NETAMOUNTMAX         := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.NETAMOUNTMAX,'NETAMOUNTMAX', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
      REC_T100.CODUSR4              := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODUSR4,'CODUSR4', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
      REC_T100.CODUSR2              := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODUSR2,'CODUSR2', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
      REC_T100.CODBUYEREDI          := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODBUYEREDI,'CODBUYEREDI', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
      REC_T100.CODCUSTINVEDI        := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODCUSTINVEDI,'CODCUSTINVEDI', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
      REC_T100.CODCUSTDELIVEDI      := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODCUSTDELIVEDI,'CODCUSTDELIVEDI', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
      REC_T100.CODSELLEREDI         := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODSELLEREDI,'CODSELLEREDI', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
      REC_T100.CODUSR6              := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODUSR6,'CODUSR6', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
      REC_T100.CODPDV               := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODPDV,'CODPDV', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
      REC_T100.CODCUSTCONC          := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODCUSTCONC,'CODCUSTCONC', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
      REC_T100.CODIBAN              := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODIBAN,'CODIBAN', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
      REC_T100.BACKAMOUNT           := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.BACKAMOUNT,'BACKAMOUNT', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
      REC_T100.TOTPALLETS           := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.TOTPALLETS,'TOTPALLETS', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
      REC_T100.GROSSWEIGHT          := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.GROSSWEIGHT,'GROSSWEIGHT', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
      REC_T100.TOTMC                := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.TOTMC,'TOTMC', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
      REC_T100.DTEPROPDELIV         := F_CHECK_FORMAT_D( VL_CODDIV, RL_XIN_T100.DTEPROPDELIV,'DTEPROPDELIV', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
      REC_T100.CODUSR5              := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODUSR5,'CODUSR5', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
      REC_T100.IDSURVEY             := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.IDSURVEY,'IDSURVEY', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
      REC_T100.CODCUSTSALE          := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODCUSTSALE,'CODCUSTSALE', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
      REC_T100.FLGPROCESSEDEDI      := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.FLGPROCESSEDEDI,'FLGPROCESSEDEDI', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
      REC_T100.FLGEDI               := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.FLGEDI,'FLGEDI', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
      REC_T100.NUMESENZIONE         := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.NUMESENZIONE,'NUMESENZIONE', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
      REC_T100.DTEDELIV2            := F_CHECK_FORMAT_D( VL_CODDIV, RL_XIN_T100.DTEDELIV2,'DTEDELIV2', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
      REC_T100.DTEDELIV3            := F_CHECK_FORMAT_D( VL_CODDIV, RL_XIN_T100.DTEDELIV3,'DTEDELIV3', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
      REC_T100.DTEDELIV4            := F_CHECK_FORMAT_D( VL_CODDIV, RL_XIN_T100.DTEDELIV4,'DTEDELIV4', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
      REC_T100.DTEDELIV5            := F_CHECK_FORMAT_D( VL_CODDIV, RL_XIN_T100.DTEDELIV5,'DTEDELIV5', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
      REC_T100.IDROUTE              := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.IDROUTE,'IDROUTE', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
      REC_T100.NUMDOC               := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.NUMDOC,'NUMDOC', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
      --ADD BY MADY 20200311
      --REC_T100.FLGPROCESSEDASSET    := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.NUMDOC,'FLGPROCESSEDASSET', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
      -- DTECLOSE
      
      IF( LENGTH(TRIM(TO_CHAR(RL_XIN_T100.DTECLOSE))) <> 0 AND RL_XIN_T100.DTECLOSE IS NOT NULL ) THEN
        REC_T100.DTECLOSE   := RL_XIN_T100.DTECLOSE;
      ELSE
        REC_T100.DTECLOSE             := F_CHECK_FORMAT_D( VL_CODDIV, RL_XIN_T100.DTECLOSE,'DTECLOSE', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
      END IF;
      
      REC_T100.RETURNAMOUNT         := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.RETURNAMOUNT,'RETURNAMOUNT', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);

      --- Technical fields
      REC_T100.DTECRE     := XSYSDATE;
      REC_T100.CODUSRMOD  := C_SYSUSR;
      REC_T100.DTEMOD     := XSYSDATE;
      REC_T100.CODUSRMODREAL := C_SYSUSR;
      REC_T100.CODUSRCREREAL := C_SYSUSR;
      -- lock fields
      REC_T100.CODUSRLCK     := C_SYSUSR;
      REC_T100.IDSESSIONLCK  := PI_SESSION_ID;
      REC_T100.DTELCK        := XSYSDATE;
     -- add by mady 20200311
      REC_T100.FLGPROCESSEDASSET := 0;

        IF (VL_STATUS <> 0 ) THEN

            VL_MESSAGE_H := SUBSTR(VL_MESSAGE_H||' '||VL_MESSAGE_D||' '||dbms_utility.format_error_backtrace() || ' ' || SQLERRM,1,4000);
            PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                           VL_PROGR_D_T100,
                                           SQLCODE,
                                           VL_MESSAGE_H);
        ELSE

            -- Recocgnize SM1 Orders and fit in REC_T100 record updated values
            -- inserts new orders coming from ERP
            LOAD_T10X_HEAD_STEP1( PI_PROGR_H,
                                  VL_PROGR_D_T100,
                                  REC_T100,
                                  VL_STATUS);
        END IF;
    
    
    
    
    -- --------------------------------------------------------------
    -- loop in child table T106ORDERROW
    -- --------------------------------------------------------------

    BEGIN
      dbms_output.put_line('8656 VLSTATUS  '|| VL_STATUS );
      IF ( VL_STATUS = 0  ) THEN
      -- Before updating all rows, we mark them all to recognize those no more sent by ERP
      -- we use a prefix on CODSTATUS     
      UPDATE T106ORDROW T set T.codstatus =C_T106_STATUS_PREFIX||t.codstatus,
      t.qtyord = '0',t.qtyinv = '0' -- added by vikas , not returned rows from SAGE should be set as zero qty in SM1
            where t.numord = REC_T100.NUMORD;
        
            
      FOR RL_XIN_T106 IN CL_XIN_T106(RL_XIN_T100.NUMORDHOST, RL_XIN_T100.SM1_DTECRE)
                LOOP

                VL_MESSAGE_H := 'Row info: '|| REC_T100.NUMORD|| '/' ||
                                               REC_T100.CODUSR|| '/' ||
                                               RL_XIN_T106.CODDIV || '/' ||
                                               RL_XIN_T106.NUMROWHOST;

                  VL_MESSAGE_D := 'Format Conversion ';
                  VL_CODDIV := RL_XIN_T106.CODDIV;
                  REC_T106  := REC_T106_INIT;
                  REC_T106.NUMORD := REC_T100.NUMORD;
                  REC_T106.CODUSR := REC_T100.CODUSR;
                  REC_T106.NUMROW := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.NUMROW,'NUMROW', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.CODART := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.CODART,'CODART', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.CODDIV := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.CODDIV,'CODDIV', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.UMORD  := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.UMORD,'UMORD', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.DESART := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.DESART,'DESART', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.QTYORD := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.QTYORD,'QTYORD', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.QTYBCKORD := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.QTYBCKORD,'QTYBCKORD', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.QTYANN    := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.QTYANN,'QTYANN', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.QTYDEL    := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.QTYDEL,'QTYDEL', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.UMINV     := REC_T106.UMORD;-- F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.UMINV,'UMINV', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.QTYINV    := REC_T106.QTYORD;-- F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.QTYINV,'QTYINV', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);-- qtyord and qtyinv will be equal in sales responce 
                  REC_T106.CODTYPROW := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.CODTYPROW,'CODTYPROW', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.CODLIST   := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.CODLIST,'CODLIST', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.DTEDELIV  := F_CHECK_FORMAT_D( VL_CODDIV,  RL_XIN_T106.DTEDELIV,'DTEDELIV', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.DTEPROPDELIV := F_CHECK_FORMAT_D( VL_CODDIV,  RL_XIN_T106.DTEPROPDELIV,'DTEPROPDELIV', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.CODSTATUS := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.CODSTATUS,'CODSTATUS', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.CODSHIPPER := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.CODSHIPPER,'CODSHIPPER', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.NUMDOCREF := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.NUMDOCREF,'NUMDOCREF', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.DTEDOCREF := F_CHECK_FORMAT_D( VL_CODDIV,  RL_XIN_T106.DTEDOCREF,'DTEDOCREF', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.GROSSAMOUNT := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.GROSSAMOUNT,'GROSSAMOUNT', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.NUMINV      := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.NUMINV,'NUMINV', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.NETAMOUNT   := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.NETAMOUNT,'NETAMOUNT', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.DTEINV      := F_CHECK_FORMAT_D( VL_CODDIV,  RL_XIN_T106.DTEINV,'DTEINV', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.TAXAMOUNT   := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.TAXAMOUNT,'TAXAMOUNT', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.VATAMOUNT   := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.VATAMOUNT,'VATAMOUNT', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.INCREASEAMOUNT := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.INCREASEAMOUNT,'INCREASEAMOUNT', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.DISCOUNTAMOUNT := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.DISCOUNTAMOUNT,'DISCOUNTAMOUNT', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.GIFTAMOUNT     := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.GIFTAMOUNT,'GIFTAMOUNT', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.ENDUSERPRICE   := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.ENDUSERPRICE,'ENDUSERPRICE', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.CODAZCAPP      := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.CODAZCAPP,'CODAZCAPP', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.FLGEFFBCKORD   := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.FLGEFFBCKORD,'FLGEFFBCKORD', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.CODBCKORDCAUSE := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.CODBCKORDCAUSE,'CODBCKORDCAUSE', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.GROSSARTAMOUNT := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.GROSSARTAMOUNT,'GROSSARTAMOUNT', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.NETARTAMOUNT   := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.NETARTAMOUNT,'NETARTAMOUNT', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.CODSRC         := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.CODSRC,'CODSRC', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.CODSRCREF      := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.CODSRCREF,'CODSRCREF', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.CODBENCAUSE    := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.CODBENCAUSE,'CODBENCAUSE', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.CODBENSUBCAUSE := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.CODBENSUBCAUSE,'CODBENSUBCAUSE', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.BENNOTE        := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.BENNOTE,'BENNOTE', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.AZCTOAPPLY     := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.AZCTOAPPLY,'AZCTOAPPLY', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.CODOPERATION   := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.CODOPERATION,'CODOPERATION', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.DISCOUNTAMOUNTOUTINV := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.DISCOUNTAMOUNTOUTINV,'DISCOUNTAMOUNTOUTINV', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.CODACCAPP            := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.CODACCAPP,'CODACCAPP', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.CODTYPROWCAUSE       := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.CODTYPROWCAUSE,'CODTYPROWCAUSE', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.CODARTCUST           := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.CODARTCUST,'CODARTCUST', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.QTYRESO              := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.QTYRESO,'QTYRESO', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.NUMORDRESO           := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.NUMORDRESO,'NUMORDRESO', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.CODBLCCAUSE          := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.CODBLCCAUSE,'CODBLCCAUSE', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.CODARTKITREF         := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.CODARTKITREF,'CODARTKITREF', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.NUMROWKITREF         := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.NUMROWKITREF,'NUMROWKITREF', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.CODCAUSEKIT          := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.CODCAUSEKIT,'CODCAUSEKIT', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.NETARTAMOUNTTEO      := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.NETARTAMOUNTTEO,'NETARTAMOUNTTEO', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.NETAMOUNTTEO         := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.NETAMOUNTTEO,'NETAMOUNTTEO', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.NETAMOUNTMIN         := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.NETAMOUNTMIN,'NETAMOUNTMIN', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.NETAMOUNTMAX         := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.NETAMOUNTMAX,'NETAMOUNTMAX', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.NETDIFF              := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.NETDIFF,'NETDIFF', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.COD_ABBINAMENTO_KIT  := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.COD_ABBINAMENTO_KIT,'COD_ABBINAMENTO_KIT', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.NUMROWORIG           := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.NUMROWORIG,'NUMROWORIG', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.FLGFIRSTSON          := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.FLGFIRSTSON,'FLGFIRSTSON', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.NETARTAMOUNTCUST     := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.NETARTAMOUNTCUST,'NETARTAMOUNTCUST', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.NETARTAMOUNTCUST2    := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.NETARTAMOUNTCUST2,'NETARTAMOUNTCUST2', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.GROSSARTAMOUNTCUST   := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.GROSSARTAMOUNTCUST,'GROSSARTAMOUNTCUST', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.NETAMOUNTCUST        := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.NETAMOUNTCUST,'NETAMOUNTCUST', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.QTYORDEDI            := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.QTYORDEDI,'QTYORDEDI', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.CODEAN               := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.CODEAN,'CODEAN', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.UMORDEDI             := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.UMORDEDI,'UMORDEDI', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.NUMROWREF            := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.NUMROWREF,'NUMROWREF', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.FLGOMGPROMO          := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.FLGOMGPROMO,'FLGOMGPROMO', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.GROSSARTAMOUNTORD    := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.GROSSARTAMOUNTORD,'GROSSARTAMOUNTORD', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.GROSSARTAMOUNTDELTA  := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.GROSSARTAMOUNTDELTA,'GROSSARTAMOUNTDELTA', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.FLGOMGDISCLIST       := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.FLGOMGDISCLIST,'FLGOMGDISCLIST', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.CODCNVPDA            := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.CODCNVPDA,'CODCNVPDA', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.DTEEVA               := F_CHECK_FORMAT_D( VL_CODDIV,  RL_XIN_T106.DTEEVA,'DTEEVA', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.CODPAYTRM            := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.CODPAYTRM,'CODPAYTRM', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.CODPAYMOD            := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.CODPAYMOD,'CODPAYMOD', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.NUMORDHOST           := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.NUMORDHOST,'NUMORDHOST', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.NUMROWHOST           := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.NUMROWHOST,'NUMROWHOST', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.CODMODSHIP           := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.CODMODSHIP,'CODMODSHIP', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.CODMODDELIV          := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.CODMODDELIV,'CODMODDELIV', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.CODWHS               := RL_XIN_T106.VANWHS ; --F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.VANWHS,'CODWHS', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.DTEPRICE             := F_CHECK_FORMAT_D( VL_CODDIV,  RL_XIN_T106.DTEPRICE,'DTEPRICE', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.DTEDELIVTO           := F_CHECK_FORMAT_D( VL_CODDIV,  RL_XIN_T106.DTEDELIVTO,'DTEDELIVTO', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.CODROWGROUP          := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.CODROWGROUP,'CODROWGROUP', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.NETAMOUNTGIFT        := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.NETAMOUNTGIFT,'NETAMOUNTGIFT', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.NETARTAMOUNTEDI      := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.NETARTAMOUNTEDI,'NETARTAMOUNTEDI', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.GROSSARTAMOUNTEDI    := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.GROSSARTAMOUNTEDI,'GROSSARTAMOUNTEDI', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.QTYORDORIG           := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.QTYORDORIG,'QTYORDORIG', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.QTYALLOCATED         := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.QTYALLOCATED,'QTYALLOCATED', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.RETURNAMOUNT         := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.RETURNAMOUNT,'RETURNAMOUNT', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);


                dbms_output.put_line(' -- Technical fields VLSTATUS 8778  '|| VL_STATUS );
                IF (VL_STATUS <> 0 ) THEN
          VL_MESSAGE_H := SUBSTR(VL_MESSAGE_H||' '||VL_MESSAGE_D||' '||dbms_utility.format_error_backtrace() || ' ' || SQLERRM,1,4000);
          PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                           VL_PROGR_D_T106,
                                           SQLCODE,
                                           VL_MESSAGE_H);
                ELSE

          vl_ins_upd := NULL;
          -- Recognize order lines; inserts new rows ; check the row
          LOAD_T10X_ROW_STEP2( PI_PROGR_H,
                                      VL_PROGR_D_T106,
                                      REC_T106,
                                      vl_ins_upd,
                                      VL_STATUS);
                END IF;
        

        --dbms_output.put_line(' -- Technical fields VLSTATUS 8799  '|| VL_STATUS );
        IF (VL_STATUS = 0 ) then
        if (vl_ins_upd = 'UPD') THEN
                VL_MESSAGE_D := 'Update T106 ';
        
                UPDATE T106ORDROW
                   SET

                  --  CODUSR = CASE VL_DES_T106('CODUSR').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODUSR ELSE CODUSR END,
                  --  NUMORD = CASE VL_DES_T106('NUMORD').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.NUMORD ELSE NUMORD END,
                  --  NUMROW = rec_t106.numrow,
                  --  CODART = CASE VL_DES_T106('CODART').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODART ELSE CODART END,
                  --  CODDIV = CASE VL_DES_T106('CODDIV').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODDIV ELSE CODDIV END,
                  UMORD = CASE VL_DES_T106('UMORD.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.UMORD ELSE UMORD END,
                  --DESART = CASE VL_DES_T106('DESART.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.DESART ELSE DESART END,
                  QTYORD = CASE VL_DES_T106('QTYORD.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.QTYORD ELSE QTYORD END,
                  --QTYBCKORD = CASE VL_DES_T106('QTYBCKORD.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.QTYBCKORD ELSE QTYBCKORD END,
                  --QTYANN = CASE VL_DES_T106('QTYANN.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.QTYANN ELSE QTYANN END,
                  --QTYDEL = CASE VL_DES_T106('QTYDEL.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.QTYDEL ELSE QTYDEL END,
                  -- UMINV = CASE VL_DES_T106('UMINV.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.UMINV ELSE UMINV END,
                  QTYINV = CASE VL_DES_T106('QTYINV.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.QTYINV ELSE QTYINV END,                  
                  --CODTYPROW = CASE VL_DES_T106('CODTYPROW.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODTYPROW ELSE CODTYPROW END,
                  --CODLIST = CASE VL_DES_T106('CODLIST.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODLIST ELSE CODLIST END,
                  --DTEDELIV = CASE VL_DES_T106('DTEDELIV.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.DTEDELIV ELSE DTEDELIV END,
                  --DTEPROPDELIV = CASE VL_DES_T106('DTEPROPDELIV.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.DTEPROPDELIV ELSE DTEPROPDELIV END,
                  CODSTATUS = CASE VL_DES_T106('CODSTATUS.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODSTATUS ELSE CODSTATUS END,
                  --CODSHIPPER = CASE VL_DES_T106('CODSHIPPER.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODSHIPPER ELSE CODSHIPPER END,
                  --NUMDOCREF = CASE VL_DES_T106('NUMDOCREF.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.NUMDOCREF ELSE NUMDOCREF END,
                  --DTEDOCREF = CASE VL_DES_T106('DTEDOCREF.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.DTEDOCREF ELSE DTEDOCREF END,
                  --GROSSAMOUNT = CASE VL_DES_T106('GROSSAMOUNT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.GROSSAMOUNT ELSE GROSSAMOUNT END,
                  --NUMINV = CASE VL_DES_T106('NUMINV.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.NUMINV ELSE NUMINV END,
                  --NETAMOUNT = CASE VL_DES_T106('NETAMOUNT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.NETAMOUNT ELSE NETAMOUNT END                    --DTEINV = CASE VL_DES_T106('DTEINV.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.DTEINV ELSE DTEINV END,
                  --TAXAMOUNT = CASE VL_DES_T106('TAXAMOUNT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.TAXAMOUNT ELSE TAXAMOTND,
                  --VATAMOUNT = CASE VL_DES_T106('VATAMOUNT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.VATAMOUNT ELSE VATAMOUN END,
                  --INCREASEAMOUNT = CASE VL_DES_T106('INCREASEAMOUNT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.INCREASEAMOUNT ELSE INCREASEAMOUNT END,
                  --DISCOUNTAMOUNT = CASE VL_DES_T106('DISCOUNTAMOUNT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.DISCOUNTAMOUNT ELSE DISCOUNTAMOUNT END,
                  --GIFTAMOUNT = CASE VL_DES_T106('GIFTAMOUNT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.GIFTAMOUNT ELSE GIFTAMOUNT END,
                  --ENDUSERPRICE = CASE VL_DES_T106('ENDUSERPRICE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.ENDUSERPRICE ELSE ENDUSERPRICE END,
                  --CODAZCAPP = CASE VL_DES_T106('CODAZCAPP.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODAZCAPP ELSE CODAZCAPP END                    --FLGEFFBCKORD = CASE VL_DES_T106('FLGEFFBCKORD.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.FLGEFFBCKORD ELSE FLGEFFBCKORD END,
                    --CODBCKORDCAUSE = CASE VL_DES_T106('CODBCKORDCAUSE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODBCKORDCAUSE LSE CODBCKORDCAUSE END,
                    --GROSSARTAMOUNT = CASE VL_DES_T106('GROSSARTAMOUNT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.GROSSARTAMOUNT ELSE GROSSARTAMOUNT END,
                    --NETARTAMOUNT = CASE VL_DES_T106('NETARTAMOUNT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.NETARTAMOUNT ELSE NETARTAMOUNT END,
                    --CODSRC = CASE VL_DES_T106('CODSRC.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODSRC ELSE CODSRC END,
                    --CODSRCREF = CASE VL_DES_T106('CODSRCREF.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODSRCREF ELSE CODSRCREF END,
                    --CODBENCAUSE = CASE VL_DES_T106('CODBENCAUSE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODBENCAUSE ELSE CODBENCAUSE END,
                    --CODBENSUBCAUSE = CASE VL_DES_T106('CODBENSUBCAUSE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODBENSUBCAUSE ELSE CODBENSUBCAUSE END,
                    --BENNOTE = CASE VL_DES_T106('BENNOTE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.BENNOTE ELSE BENNOTE END,
                    --AZCTOAPPLY = CASE VL_DES_T106('AZCTOAPPLY.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.AZCTOAPPLY ELSE AZCTOAPPLY END,
                   -- CODOPERATION = CASE VL_DES_T106('CODOPERATION.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODOPERATION ELSE CODOPERATION END,
                   -- DISCOUNTAMOUNTOUTINV = CASE VL_DES_T106('DISCOUNTAMOUNTOUTINV.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.DISCOUNTAMOUNTOUTINV ELSE DISCOUNTAMOUNTOUTINV END,
                    --CODACCAPP = CASE VL_DES_T106('CODACCAPP.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODACCAPP ELSE CODACCAPP END,
                    --CODTYPROWCAUSE = CASE VL_DES_T106('CODTYPROWCAUSE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODTYPROWCAUSE ELSE CODTYPROWCAUSE END,
                    --CODARTCUST = CASE VL_DES_T106('CODARTCUST.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODARTCUST ELSE CODARTCUST END,
                    --QTYRESO = CASE VL_DES_T106('QTYRESO.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.QTYRESO ELSE QTYRESO END,
                    --NUMORDRESO = CASE VL_DES_T106('NUMORDRESO.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.NUMORDRESO ELSE NUMORDRESO END,
                    --CODBLCCAUSE = CASE VL_DES_T106('CODBLCCAUSE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODBLCCAUSE ELSE CODBLCCAUSE END,
                    --CODARTKITREF = CASE VL_DES_T106('CODARTKITREF.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODARTKITREF ELSE CODARTKITREF END,
                    --NUMROWKITREF = CASE VL_DES_T106('NUMROWKITREF.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.NUMROWKITREF ELSE NUMROWKITREF END,
                    --CODCAUSEKIT = CASE VL_DES_T106('CODCAUSEKIT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODCAUSEKIT ELSE CODCAUSEKIT END,
                    --NETARTAMOUNTTEO = CASE VL_DES_T106('NETARTAMOUNTTEO.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.NETARTAMOUNTTEO ELSE NETARTAMOUNTTEO END,
                    --NETAMOUNTTEO = CASE VL_DES_T106('NETAMOUNTTEO.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.NETAMOUNTTEO ELSE NETAMOUNTTEO END,
                    --NETAMOUNTMIN = CASE VL_DES_T106('NETAMOUNTMIN.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.NETAMOUNTMIN ELSE NETAMOUNTMIN END,
                    --NETAMOUNTMAX = CASE VL_DES_T106('NETAMOUNTMAX.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.NETAMOUNTMAX ELSE NETAMOUNTMAX END,
                    --NETDIFF = CASE VL_DES_T106('NETDIFF.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.NETDIFF ELSE NETDIFF END,
                    --COD_ABBINAMENTO_KIT = CASE VL_DES_T106('COD_ABBINAMENTO_KIT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.COD_ABBINAMENTO_KIT ELSE COD_ABBINAMENTO_KIT END,
                    --NUMROWORIG = CASE VL_DES_T106('NUMROWORIG.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.NUMROWORIG ELSE NUMROWORIG END,
                    --FLGFIRSTSON = CASE VL_DES_T106('FLGFIRSTSON.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.FLGFIRSTSON ELSE FLGFIRSTSON END,
                    --NETARTAMOUNTCUST = CASE VL_DES_T106('NETARTAMOUNTCUST.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.NETARTAMOUNTCUST ELSE NETARTAMOUNTCUST END,
                    --NETARTAMOUNTCUST2 = CASE VL_DES_T106('NETARTAMOUNTCUST2.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.NETARTAMOUNTCUST2 ELSE NETARTAMOUNTCUST2 END,
                    --GROSSARTAMOUNTCUST = CASE VL_DES_T106('GROSSARTAMOUNTCUST.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.GROSSARTAMOUNTCUST ELSE GROSSARTAMOUNTCUST END,
                    --NETAMOUNTCUST = CASE VL_DES_T106('NETAMOUNTCUST.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.NETAMOUNTCUST ELSE NETAMOUNTCUST END,
                    --QTYORDEDI = CASE VL_DES_T106('QTYORDEDI.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.QTYORDEDI ELSE QTYORDEDI END,
                    --CODEAN = CASE VL_DES_T106('CODEAN.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODEAN ELSE CODEAN END,
                    --UMORDEDI = CASE VL_DES_T106('UMORDEDI.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.UMORDEDI ELSE UMORDEDI END,
                    --NUMROWREF = CASE VL_DES_T106('NUMROWREF.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.NUMROWREF ELSE NUMROWREF END,
                    --FLGOMGPROMO = CASE VL_DES_T106('FLGOMGPROMO.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.FLGOMGPROMO ELSE FLGOMGPROMO END,
                    --GROSSARTAMOUNTORD = CASE VL_DES_T106('GROSSARTAMOUNTORD.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.GROSSARTAMOUNTORD ELSE GROSSARTAMOUNTORD END,
                    --GROSSARTAMOUNTDELTA = CASE VL_DES_T106('GROSSARTAMOUNTDELTA.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.GROSSARTAMOUNTDELTA ELSE GROSSARTAMOUNTDELTA END,
                    --FLGOMGDISCLIST = CASE VL_DES_T106('FLGOMGDISCLIST.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.FLGOMGDISCLIST ELSE FLGOMGDISCLIST END,
                    --CODCNVPDA = CASE VL_DES_T106('CODCNVPDA.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODCNVPDA ELSE CODCNVPDA END,
                    --DTEEVA = CASE VL_DES_T106('DTEEVA.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.DTEEVA ELSE DTEEVA END,
                    --CODPAYTRM = CASE VL_DES_T106('CODPAYTRM.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODPAYTRM ELSE CODPAYTRM END,
                    --CODPAYMOD = CASE VL_DES_T106('CODPAYMOD.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODPAYMOD ELSE CODPAYMOD END,
                    NUMORDHOST = CASE VL_DES_T106('NUMORDHOST.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.NUMORDHOST ELSE NUMORDHOST END,
                    NUMROWHOST = CASE VL_DES_T106('NUMROWHOST.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.NUMROWHOST ELSE NUMROWHOST END  --,
                    --CODMODSHIP = CASE VL_DES_T106('CODMODSHIP.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODMODSHIP ELSE CODMODSHIP END,
                    --CODMODDELIV = CASE VL_DES_T106('CODMODDELIV.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODMODDELIV ELSE CODMODDELIV END,
                    --CODWHS = CASE VL_DES_T106('CODWHS.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODWHS ELSE CODWHS END,
                    --DTEPRICE = CASE VL_DES_T106('DTEPRICE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.DTEPRICE ELSE DTEPRICE END,
                    --DTEDELIVTO = CASE VL_DES_T106('DTEDELIVTO.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.DTEDELIVTO ELSE DTEDELIVTO END,
                    --CODROWGROUP = CASE VL_DES_T106('CODROWGROUP.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODROWGROUP ELSE CODROWGROUP END,
                    --NETAMOUNTGIFT = CASE VL_DES_T106('NETAMOUNTGIFT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.NETAMOUNTGIFT ELSE NETAMOUNTGIFT END,
                    --NETARTAMOUNTEDI = CASE VL_DES_T106('NETARTAMOUNTEDI.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.NETARTAMOUNTEDI ELSE NETARTAMOUNTEDI END,
                    --GROSSARTAMOUNTEDI = CASE VL_DES_T106('GROSSARTAMOUNTEDI.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.GROSSARTAMOUNTEDI ELSE GROSSARTAMOUNTEDI END,
                    --QTYORDORIG = CASE VL_DES_T106('QTYORDORIG.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.QTYORDORIG ELSE QTYORDORIG END,
                    --QTYALLOCATED = CASE VL_DES_T106('QTYALLOCATED.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.QTYALLOCATED ELSE QTYALLOCATED END,
                    --RETURNAMOUNT = CASE VL_DES_T106('RETURNAMOUNT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.RETURNAMOUNT ELSE RETURNAMOUNT END

                WHERE NUMORD = REC_T106.NUMORD AND NUMROW = REC_T106.NUMROW ;
         
         
      --------- ADD STOCK INTO THE INVENTORY TABLE ------        
        
      INSERT INTO T078WHSBALANCE (CODART,CODWHS,CODDIV,QTYSTOCK,UMSTOCK,DTESTOCK,DTEMOD,FLGANN,QTYINV)
      VALUES (RL_XIN_T106.CODART,VL_CODWHS,RL_XIN_T106.CODDIV,REC_T106.QTYINV,REC_T106.UMORD,XSYSDATE,XSYSDATE,0,REC_T106.QTYINV);
         
         

          else
            -- record does not exists , we insert it
            VL_MESSAGE_D := 'Insert T106 ';
                  
            INSERT INTO T106ORDROW VALUES REC_T106;
    
      --------- ADD STOCK INTO THE INVENTORY TABLE ------ 
      
      INSERT INTO T078WHSBALANCE (CODART,CODWHS,CODDIV,QTYSTOCK,UMSTOCK,DTESTOCK,DTEMOD,FLGANN,QTYINV)
      VALUES (REC_T106.CODART,RL_XIN_T106.VANWHS,REC_T106.CODDIV,REC_T106.QTYINV,REC_T106.UMINV,XSYSDATE,XSYSDATE,0,REC_T106.QTYINV);
    
           end if;
                 VL_INS_T106 := VL_INS_T106 + 1;
            end if;
    
      END LOOP;   --T106ORDROW
      END IF;
     
     
      EXCEPTION WHEN OTHERS THEN
        VL_STATUS := -1;
        VL_MESSAGE_H := SUBSTR(VL_MESSAGE_H||' '||VL_MESSAGE_D||' '||dbms_utility.format_error_backtrace() || ' ' || SQLERRM,1,4000);

        PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                           VL_PROGR_D_T106,
                                           SQLCODE,
                                           VL_MESSAGE_H);

    END; ---- DIVISION T106
    
    
    
    IF (VL_STATUS = 0 ) THEN
          -- when status <> 0 some fields have incorrect format. Log t800 has been already wrote by F_CHECK function
          -- Update article if already exists

           VL_MESSAGE_D := 'Update T100ORDHEAD ';
           UPDATE T100ORDHEAD
           SET
            -- when the field si set to updated by host it means that the value should be read from XIN
            -- otherwise it means that the field is managed by sm1 and it maintains its original value
              CODEUSR = CASE VL_DES_T100('CODEUSR.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODEUSR ELSE CODEUSR END,
              CODTYPORD = CASE VL_DES_T100('CODTYPORD.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODTYPORD ELSE CODTYPORD END,
              CODSTATUS = CASE VL_DES_T100('CODSTATUS.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODSTATUS ELSE CODSTATUS END,
              CODDIV = CASE VL_DES_T100('CODDIV.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODDIV ELSE CODDIV END,
              CODBLCCAUSE = CASE VL_DES_T100('CODBLCCAUSE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODBLCCAUSE ELSE CODBLCCAUSE END,
              DTEORD = CASE VL_DES_T100('DTEORD.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.DTEORD ELSE DTEORD END,
              DTEDELIV = CASE VL_DES_T100('DTEDELIV.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.DTEDELIV ELSE DTEDELIV END,
              CODTYPDELIV = CASE VL_DES_T100('CODTYPDELIV.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODTYPDELIV ELSE CODTYPDELIV END,
              DTEEVA = CASE VL_DES_T100('DTEEVA.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.DTEEVA ELSE DTEEVA END,
              CODPAYTRM = CASE VL_DES_T100('CODPAYTRM.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODPAYTRM ELSE CODPAYTRM END,
              CODPAYMOD = CASE VL_DES_T100('CODPAYMOD.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODPAYMOD ELSE CODPAYMOD END,
              --CODCUSTDELIV = CASE VL_DES_T100('CODCUSTDELIV.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODCUSTDELIV ELSE CODCUSTDELIV END,
              CODVATMGMT = CASE VL_DES_T100('CODVATMGMT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODVATMGMT ELSE CODVATMGMT END,
              --CODCUSTINV = CASE VL_DES_T100('CODCUSTINV.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODCUSTINV ELSE CODCUSTINV END,
              CODLIST = CASE VL_DES_T100('CODLIST.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODLIST ELSE CODLIST END,
              CODCUR = CASE VL_DES_T100('CODCUR.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODCUR ELSE CODCUR END,
              NUMORDREF = CASE VL_DES_T100('NUMORDREF.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.NUMORDREF ELSE NUMORDREF END,
              NUMORDHOST = CASE VL_DES_T100('NUMORDHOST.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.NUMORDHOST ELSE NUMORDHOST END,
              NUMORDCUST = CASE VL_DES_T100('NUMORDCUST.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.NUMORDCUST ELSE NUMORDCUST END,
              DTEORDCUST = CASE VL_DES_T100('DTEORDCUST.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.DTEORDCUST ELSE DTEORDCUST END,
              CODASSORTMENT = CASE VL_DES_T100('CODASSORTMENT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODASSORTMENT ELSE CODASSORTMENT END,
              CODCANVASS = CASE VL_DES_T100('CODCANVASS.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODCANVASS ELSE CODCANVASS END,
              CODMODSHIP = CASE VL_DES_T100('CODMODSHIP.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODMODSHIP ELSE CODMODSHIP END,
              CODMODDELIV = CASE VL_DES_T100('CODMODDELIV.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODMODDELIV ELSE CODMODDELIV END,
              CODAGREEMENT = CASE VL_DES_T100('CODAGREEMENT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODAGREEMENT ELSE CODAGREEMENT END,
              DESAGREEMENT = CASE VL_DES_T100('DESAGREEMENT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.DESAGREEMENT ELSE DESAGREEMENT END,
              CODUSRAUT = CASE VL_DES_T100('CODUSRAUT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODUSRAUT ELSE CODUSRAUT END,
              CODAGREECLASS = CASE VL_DES_T100('CODAGREECLASS.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODAGREECLASS ELSE CODAGREECLASS END,
              DTEAUT = CASE VL_DES_T100('DTEAUT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.DTEAUT ELSE DTEAUT END,
              CODTYPAUT = CASE VL_DES_T100('CODTYPAUT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODTYPAUT ELSE CODTYPAUT END,
              DESAUT = CASE VL_DES_T100('DESAUT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.DESAUT ELSE DESAUT END,
              GROSSAMOUNT = CASE VL_DES_T100('GROSSAMOUNT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.GROSSAMOUNT ELSE GROSSAMOUNT END,
              NETAMOUNT = CASE VL_DES_T100('NETAMOUNT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.NETAMOUNT ELSE NETAMOUNT END,
              TAXAMOUNT = CASE VL_DES_T100('TAXAMOUNT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.TAXAMOUNT ELSE TAXAMOUNT END,
              VATAMOUNT = CASE VL_DES_T100('VATAMOUNT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.VATAMOUNT ELSE VATAMOUNT END,
              INCREASEAMOUNT = CASE VL_DES_T100('INCREASEAMOUNT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.INCREASEAMOUNT ELSE INCREASEAMOUNT END,
              DISCOUNTAMOUNT = CASE VL_DES_T100('DISCOUNTAMOUNT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.DISCOUNTAMOUNT ELSE DISCOUNTAMOUNT END,
              GIFTAMOUNT = CASE VL_DES_T100('GIFTAMOUNT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.GIFTAMOUNT ELSE GIFTAMOUNT END,
              FLGANN = CASE VL_DES_T100('FLGANN.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.FLGANN ELSE FLGANN END,
              CODABI = CASE VL_DES_T100('CODABI.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODABI ELSE CODABI END,
              CODCAB = CASE VL_DES_T100('CODCAB.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODCAB ELSE CODCAB END,
              DESBAN = CASE VL_DES_T100('DESBAN.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.DESBAN ELSE DESBAN END,
              DESBRA = CASE VL_DES_T100('DESBRA.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.DESBRA ELSE DESBRA END,
              DESADDR = CASE VL_DES_T100('DESADDR.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.DESADDR ELSE DESADDR END,
              DESLOC = CASE VL_DES_T100('DESLOC.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.DESLOC ELSE DESLOC END,
              DESPRV = CASE VL_DES_T100('DESPRV.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.DESPRV ELSE DESPRV END,
              QTYTOT = CASE VL_DES_T100('QTYTOT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.QTYTOT ELSE QTYTOT END,
              CODPRV = CASE VL_DES_T100('CODPRV.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODPRV ELSE CODPRV END,
              UMQTYTOT = CASE VL_DES_T100('UMQTYTOT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.UMQTYTOT ELSE UMQTYTOT END,
              CODACCOUNT = CASE VL_DES_T100('CODACCOUNT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODACCOUNT ELSE CODACCOUNT END,
              FLGRETURN = CASE VL_DES_T100('FLGRETURN.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.FLGRETURN ELSE FLGRETURN END,
              FLGHOSTED = CASE VL_DES_T100('FLGHOSTED.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.FLGHOSTED ELSE FLGHOSTED END,
              FLGCONFIRMED = CASE VL_DES_T100('FLGCONFIRMED.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.FLGCONFIRMED ELSE FLGCONFIRMED END,
              --CODWHS = CASE VL_DES_T100('CODWHS.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODWHS ELSE CODWHS END,   ---
              CODSHIPPER = CASE VL_DES_T100('CODSHIPPER.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODSHIPPER ELSE CODSHIPPER END,
              CODAZCAPP = CASE VL_DES_T100('CODAZCAPP.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODAZCAPP ELSE CODAZCAPP END,
              CODAZCBEN = CASE VL_DES_T100('CODAZCBEN.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODAZCBEN ELSE CODAZCBEN END,
              DTEPRICE = CASE VL_DES_T100('DTEPRICE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.DTEPRICE ELSE DTEPRICE END,
              CODTYPSALE = CASE VL_DES_T100('CODTYPSALE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODTYPSALE ELSE CODTYPSALE END,
              FLGCHECKPROMO = CASE VL_DES_T100('FLGCHECKPROMO.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.FLGCHECKPROMO ELSE FLGCHECKPROMO END,
              CODAGREETYPE = CASE VL_DES_T100('CODAGREETYPE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODAGREETYPE ELSE CODAGREETYPE END,
              CODSTATUSMAN = CASE VL_DES_T100('CODSTATUSMAN.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODSTATUSMAN ELSE CODSTATUSMAN END,
              DISCOUNTAMOUNTOUTINV = CASE VL_DES_T100('DISCOUNTAMOUNTOUTINV.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.DISCOUNTAMOUNTOUTINV ELSE DISCOUNTAMOUNTOUTINV END,
              CODTYPORDCUST = CASE VL_DES_T100('CODTYPORDCUST.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODTYPORDCUST ELSE CODTYPORDCUST END,
              CODUSR3 = CASE VL_DES_T100('CODUSR3.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODUSR3 ELSE CODUSR3 END,
              DTEDELIVTO = CASE VL_DES_T100('DTEDELIVTO.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.DTEDELIVTO ELSE DTEDELIVTO END,
              CODCIN = CASE VL_DES_T100('CODCIN.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODCIN ELSE CODCIN END,
              FLGUMORD2 = CASE VL_DES_T100('FLGUMORD2.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.FLGUMORD2 ELSE FLGUMORD2 END,
              NETAMOUNTTEO = CASE VL_DES_T100('NETAMOUNTTEO.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.NETAMOUNTTEO ELSE NETAMOUNTTEO END,
              NETAMOUNTMIN = CASE VL_DES_T100('NETAMOUNTMIN.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.NETAMOUNTMIN ELSE NETAMOUNTMIN END,
              NETAMOUNTMAX = CASE VL_DES_T100('NETAMOUNTMAX.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.NETAMOUNTMAX ELSE NETAMOUNTMAX END,
              CODUSR4 = CASE VL_DES_T100('CODUSR4.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODUSR4 ELSE CODUSR4 END,
              CODUSR2 = CASE VL_DES_T100('CODUSR2.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODUSR2 ELSE CODUSR2 END,
              CODBUYEREDI = CASE VL_DES_T100('CODBUYEREDI.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODBUYEREDI ELSE CODBUYEREDI END,
              --CODCUSTINVEDI = CASE VL_DES_T100('CODCUSTINVEDI.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODCUSTINVEDI ELSE CODCUSTINVEDI END,
              --CODCUSTDELIVEDI = CASE VL_DES_T100('CODCUSTDELIVEDI.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODCUSTDELIVEDI ELSE CODCUSTDELIVEDI END,
              CODSELLEREDI = CASE VL_DES_T100('CODSELLEREDI.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODSELLEREDI ELSE CODSELLEREDI END,
              CODUSR6 = CASE VL_DES_T100('CODUSR6.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODUSR6 ELSE CODUSR6 END,
              CODPDV = CASE VL_DES_T100('CODPDV.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODPDV ELSE CODPDV END,
              CODCUSTCONC = CASE VL_DES_T100('CODCUSTCONC.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODCUSTCONC ELSE CODCUSTCONC END,
              CODIBAN = CASE VL_DES_T100('CODIBAN.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODIBAN ELSE CODIBAN END,
              BACKAMOUNT = CASE VL_DES_T100('BACKAMOUNT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.BACKAMOUNT ELSE BACKAMOUNT END,
              TOTPALLETS = CASE VL_DES_T100('TOTPALLETS.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.TOTPALLETS ELSE TOTPALLETS END,
              GROSSWEIGHT = CASE VL_DES_T100('GROSSWEIGHT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.GROSSWEIGHT ELSE GROSSWEIGHT END,
              TOTMC = CASE VL_DES_T100('TOTMC.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.TOTMC ELSE TOTMC END,
              DTEPROPDELIV = CASE VL_DES_T100('DTEPROPDELIV.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.DTEPROPDELIV ELSE DTEPROPDELIV END,
              CODUSR5 = CASE VL_DES_T100('CODUSR5.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODUSR5 ELSE CODUSR5 END,
              --IDSURVEY = CASE VL_DES_T100('IDSURVEY.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.IDSURVEY ELSE IDSURVEY END,
              --CODCUSTSALE = CASE VL_DES_T100('CODCUSTSALE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODCUSTSALE ELSE CODCUSTSALE END,
              FLGPROCESSEDEDI = CASE VL_DES_T100('FLGPROCESSEDEDI.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.FLGPROCESSEDEDI ELSE FLGPROCESSEDEDI END,
              FLGEDI = CASE VL_DES_T100('FLGEDI.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.FLGEDI ELSE FLGEDI END,
              NUMESENZIONE = CASE VL_DES_T100('NUMESENZIONE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.NUMESENZIONE ELSE NUMESENZIONE END,
              DTEDELIV2 = CASE VL_DES_T100('DTEDELIV2.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.DTEDELIV2 ELSE DTEDELIV2 END,
              DTEDELIV3 = CASE VL_DES_T100('DTEDELIV3.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.DTEDELIV3 ELSE DTEDELIV3 END,
              DTEDELIV4 = CASE VL_DES_T100('DTEDELIV4.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.DTEDELIV4 ELSE DTEDELIV4 END,
              DTEDELIV5 = CASE VL_DES_T100('DTEDELIV5.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.DTEDELIV5 ELSE DTEDELIV5 END,
              IDROUTE = CASE VL_DES_T100('IDROUTE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.IDROUTE ELSE IDROUTE END,
              NUMDOC = CASE VL_DES_T100('NUMDOC.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.NUMDOC ELSE NUMDOC END,
              DTECLOSE = CASE VL_DES_T100('DTECLOSE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.DTECLOSE ELSE DTECLOSE END,
              RETURNAMOUNT = CASE VL_DES_T100('RETURNAMOUNT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.RETURNAMOUNT ELSE RETURNAMOUNT END,

               --- Technical fields
               CODUSRMOD = REC_T100.CODUSRMOD,
               DTEMOD    = REC_T100.DTEMOD,
               -- lock fields
               CODUSRLCK    = REC_T100.CODUSRLCK,
               IDSESSIONLCK = REC_T100.IDSESSIONLCK,
               DTELCK       = REC_T100.DTELCK,
               --add by mady 20200311
               flgprocessedasset = 0

         
        WHERE NUMORD = REC_T100.NUMORD AND  CODUSR = REC_T100.CODUSR
        AND (idsessionlck = REC_T100.IDSESSIONLCK
                or not exists
                     ( select null from T035LOGGEDUSERS T035
                      where T035.IDSESSION = NVL(IDSESSIONLCK, '@') AND T035.LASTCHECK > TRUNC(XSYSDATE)-1 )
          );          
         
        END IF; -- VL_STATUS = 0


      EXCEPTION WHEN OTHERS THEN
        VL_STATUS := -1;
        VL_MESSAGE_H := SUBSTR(VL_MESSAGE_H||' '||VL_MESSAGE_D||' '||dbms_utility.format_error_backtrace() || ' ' || SQLERRM,1,4000);

        PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                           VL_PROGR_D_T100,
                                           SQLCODE,
                                           VL_MESSAGE_H);

        END; -- HEAD T100
    
    

    
    -- --------------------------------------------------------------
    -- if all records have been stored with success then it makes the final commit
    -- --------------------------------------------------------------
   
      IF VL_STATUS = 0 THEN
        VL_INS_T100 := VL_INS_T100 + 1;
        
        PKG_SALES_FORCE_DAL_CUST.create_stock_correction_syg(PI_PROGR_H,RL_XIN_T100.NUMORD,VL_CODWHS );

        PKG_SALES_FORCE_DAL_CUST.create_stock_inventory_syg(PI_PROGR_H  ,RL_XIN_T100.NUMORD) ;
        
        COMMIT;
      ELSE
        ROLLBACK;
      END IF;
    
    

    IF (VL_STATUS <> 0 OR VL_RECORD_LOCKED <> 0) THEN
      UPDATE XIN_T106ORDROW
      SET  SM1_STATUS= CASE
                                WHEN VL_RECORD_LOCKED <> 0  THEN C_XINSTATUS_LOCK
                                ELSE C_XINSTATUS_ERR END
      WHERE CODUSR = RL_XIN_T100.CODUSR
      AND  SM1_CODPROCESS = PI_PROGR_H
      AND  SM1_DTECRE     = RL_XIN_T100.SM1_DTECRE
      AND  SM1_STATUS     = C_XINSTATUS_OK;

      -- TO CHECK this update is  not correct in case of double record .
      UPDATE XIN_T100ORDHEAD
      SET  SM1_STATUS= CASE
                                WHEN VL_RECORD_LOCKED <> 0  THEN C_XINSTATUS_LOCK
                                ELSE C_XINSTATUS_ERR END
      WHERE CODUSR = RL_XIN_T100.CODUSR
      AND  SM1_CODPROCESS = PI_PROGR_H
      AND  SM1_DTECRE     <= RL_XIN_T100.SM1_DTECRE
      AND  SM1_STATUS     = C_XINSTATUS_OK;

      COMMIT;
    END IF;

        -- Release updated records
      UPDATE T100ORDHEAD
      SET       DTELCK          = NULL,
                    IDSESSIONLCK    = NULL,
                    CODUSRLCK       = NULL
      WHERE CODUSR = REC_T100.CODUSR AND CODUSRLCK = C_SYSUSR AND IDSESSIONLCK = PI_SESSION_ID;
      COMMIT;
      
      
  END LOOP;  -- T100ORDHEAD


  
  
  
    -- Moves records from staging area to log staging area
    P_XIN_MOVE_TO_LOG(PI_PROGR_H, VL_PROGR_D_T100,'T106ORDROW');
    P_XIN_MOVE_TO_LOG(PI_PROGR_H, VL_PROGR_D_T100,'T100ORDHEAD');

   -- Close Logs
    PKG_UTILS.LOG_END_DETAIL(PI_PROGR_H,
                             VL_PROGR_D_T106,
                             0,
                             VL_COUNT_XIN_T106,
                             VL_INS_T106,
                             VL_COUNT_XIN_T106 - VL_INS_T106);

    PKG_UTILS.LOG_END_DETAIL(PI_PROGR_H,
                             VL_PROGR_D_T100,
                             0,
                             VL_COUNT_XIN_T100,
                             VL_INS_T100,
                             VL_COUNT_XIN_T100 - VL_INS_T100);

    PO_MSG    := VL_INS_T100||'/'||VL_COUNT_XIN_T100||' Orders loaded';
    PO_STATUS := VL_INS_T100;
  
    --
    EXCEPTION WHEN EX_EXIT THEN

      ROLLBACK;
      VL_MESSAGE_H       := VL_MESSAGE_H || TRIM(SUBSTR(dbms_utility.format_error_backtrace() || ' ' || SQLERRM, 1, 255));
      PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                         VL_PROGR_D_T100,
                                         SQLCODE,
                                         VL_MESSAGE_H);

      PO_MSG := VL_MESSAGE_H;
      PO_STATUS := -1;

      
    WHEN OTHERS THEN
      ROLLBACK;
      -- Release updated records
            UPDATE T100ORDHEAD
            SET       DTELCK          = NULL,
                      IDSESSIONLCK    = NULL,
                      CODUSRLCK       = NULL
            WHERE CODUSRLCK = C_SYSUSR AND IDSESSIONLCK = PI_SESSION_ID;
            COMMIT;
      
      -- Moves records from staging area to log staging area
      P_XIN_MOVE_TO_LOG(PI_PROGR_H, VL_PROGR_D_T100,'T106ORDROW');
      P_XIN_MOVE_TO_LOG(PI_PROGR_H, VL_PROGR_D_T100,'T100ORDHEAD');

      VL_MESSAGE_H       := VL_MESSAGE_H || TRIM(SUBSTR(dbms_utility.format_error_backtrace() || ' ' || SQLERRM, 1, 255));

      PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                         VL_PROGR_D_T100,
                                         SQLCODE,
                                         VL_MESSAGE_H);

      PO_MSG := VL_MESSAGE_H;
      PO_STATUS := VL_STATUS;
      
     
 END;
    
    
    
    
    PROCEDURE LOAD_T100_ORDERS_SYG_51 (PI_PROGR_H       IN NUMBER,
                              PI_SESSION_ID    IN NUMBER,
                              PO_MSG           OUT NOCOPY VARCHAR2,
                              PO_STATUS        OUT NOCOPY NUMBER ) IS



    -- -----------------------------------------
    -- Cursor on Orde Heads xin_t100ordhead
    -- -----------------------------------------
    CURSOR CL_XIN_T100 IS
      SELECT
        *
        FROM  XIN_T100ORDHEAD
        WHERE SM1_CODPROCESS = PI_PROGR_H
    AND CODTYPORD IN ('51')
        ORDER BY NUMORDHOST, SM1_DTECRE;
    -- -----------------------------------------
    -- Cursor on Order Rows xin_t106_ordrow
    -- -----------------------------------------
    CURSOR CL_XIN_T106(CI_NUMORDHOST VARCHAR2, CI_SM1_DTECRE DATE) IS
      SELECT
        ORDROW.*
  ,T.Codwhs AS VANWHS
        FROM  XIN_T106ORDROW  ORDROW
  INNER JOIN
      T100ORDHEAD T ON ORDROW.NUMORD = T.NUMORD
        WHERE ORDROW.NUMORDHOST = CI_NUMORDHOST
        AND   ORDROW.SM1_CODPROCESS = PI_PROGR_H
    -- AND   ORDROW.SM1_DTECRE <= CI_SM1_DTECRE   -- vikas , no need to compare creation time of header and row
        AND ORDROW.SM1_STATUS = C_XINSTATUS_OK -- Only those that have not processed yet (in case of double record in xin)
        ORDER BY ORDROW.SM1_DTECRE;


    --

    VL_MESSAGE_H   VARCHAR2(4000) := 'Error while loading Orders T100/T106';
    VL_MESSAGE_D   VARCHAR2(4000) := NULL;
    --
    VL_PROGR_D_T100    NUMBER := 0;
    VL_COUNT_XIN_T100  NUMBER := 0;
    VL_INS_T100        NUMBER := 0;
    --
    VL_PROGR_D_T106    NUMBER := 0;
    VL_COUNT_XIN_T106  NUMBER := 0;
    VL_INS_T106        NUMBER := 0;
    --
    REC_T100      T100ORDHEAD%ROWTYPE    := NULL;
    REC_T100_INIT T100ORDHEAD%ROWTYPE    := NULL;
    REC_T106      T106ORDROW%ROWTYPE := NULL;
    REC_T106_INIT T106ORDROW%ROWTYPE := NULL;
    --
    VL_DES_T100     X_FIELD_INFO_ARRAY;-- Array with fields db info
    VL_DES_T106     X_FIELD_INFO_ARRAY;-- Array with fields db info
    --
    VL_RECORD_LOCKED NUMBER := 0;

    VL_STATUS NUMBER:= 0;
    VL_STEP   NUMBER:= 0; -- Used to ping t035
    --
    EX_EXIT  EXCEPTION;
    --
    VL_CODDIV VARCHAR2(30) := NULL;
    vl_ins_upd VARCHAR2(3) := NULL;

  BEGIN


  --add by mady 20200311
    REC_T100.FLGPROCESSEDASSET := 0;  
    REC_T100_INIT.FLGPROCESSEDASSET := 0;
    
    -- init indexes and rebuild statistics
    P_XIN_INIT_INDEXES (PI_PROGR_H, 'T100ORDHEAD');
    P_XIN_INIT_INDEXES (PI_PROGR_H, 'T106ORDROW');
    -- clean log
    P_XIN_CLEANUP_LOG (PI_PROGR_H, 'T100ORDHEAD');
    P_XIN_CLEANUP_LOG (PI_PROGR_H, 'T106ORDROW');


    VL_PROGR_D_T100 := PKG_UTILS.LOG_NEW_DETAIL(PI_PROGR_H,
                                       'ORDER HEAD',
                                       'IMPORT --> T100ORDHEAD 51',
                                        0,
                                        NULL);
    VL_PROGR_D_T106 := PKG_UTILS.LOG_NEW_DETAIL(PI_PROGR_H,
                                       'ORDER ROWS',

                                       'IMPORT --> T106ORDROW 51',
                                        0,
                                        NULL);

    -- retrieves configuration parameters
    LOAD_T10X_CONF_STEP0(
                          VL_MESSAGE_H,
                          VL_STATUS   );

    if (vl_status <> 0 ) then
         PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                        VL_PROGR_D_T100,
                                        SQLCODE,
                                        VL_MESSAGE_H);

          raise EX_EXIT;
    end if;
    BEGIN


        --
        -- ----------------------------------------------------------
        -- Init arrays with FIELD_NAME=LENGTH and FIELDNAME=SM1_DEFAULT for all fields of table
        -- ----------------------------------------------------------
        VL_DES_T100.DELETE;
        P_INIT_SM1_FIELD_ARRAY ('T100ORDHEAD', VL_DES_T100, VL_STATUS, VL_MESSAGE_H);
        execute immediate ( GL_INIT_REC) INTO REC_T100_INIT;


        VL_DES_T106.DELETE;
        P_INIT_SM1_FIELD_ARRAY ('T106ORDROW', VL_DES_T106, VL_STATUS, VL_MESSAGE_H);
        execute immediate ( GL_INIT_REC) INTO REC_T106_INIT;

        IF (VL_STATUS <> 0 ) THEN
            VL_MESSAGE_D := GL_INIT_REC;
            RAISE EX_EXIT;
        END IF;
    EXCEPTION WHEN OTHERS THEN
        VL_MESSAGE_D := GL_INIT_REC;
        RAISE EX_EXIT;
    END;


    -- --------------------------------------------------------------
    -- Identifies Xin records to be loaded
    -- --------------------------------------------------------------
    BEGIN
        VL_MESSAGE_D := 'XIN_T100ORDHEAD';
        UPDATE XIN_T100ORDHEAD
        SET SM1_CODPROCESS = PI_PROGR_H,
            SM1_STATUS = 0,
            SM1_DTEPROCESS = XSYSDATE
            WHERE NVL(SM1_CODPROCESS, 0) = C_SM1_NULL_CODPROCESS
      AND CODDIV IN ('SYG')     
      AND CODTYPORD IN ('51');

        VL_MESSAGE_D := 'XIN_T106ORDROW';
    
        UPDATE XIN_T106ORDROW D
        SET D.SM1_CODPROCESS = PI_PROGR_H,
            D.SM1_STATUS = 0,
            D.SM1_DTEPROCESS = XSYSDATE
            WHERE 
              NVL(D.SM1_CODPROCESS,0) = C_SM1_NULL_CODPROCESS
            AND D.NUMORDHOST IN ( SELECT H.NUMORDHOST FROM XIN_T100ORDHEAD H WHERE H.SM1_CODPROCESS = PI_PROGR_H 
      AND CODDIV IN ('SYG')     
      AND CODTYPORD IN ('51'));

    COMMIT;
  
    EXCEPTION WHEN OTHERS THEN
      ROLLBACK;
      VL_MESSAGE_H := 'Error while Reading Staging area: '||VL_MESSAGE_D;
      RAISE EX_EXIT;

    END;

    -- --------------------------------------------------------------
    -- loop in main table T100ORDHEAD
    -- --------------------------------------------------------------
    FOR RL_XIN_T100 IN CL_XIN_T100 LOOP
     -- pings to t035 every 100 cicles--
      VL_STEP := VL_STEP + 1;

      IF ( MOD(VL_STEP, 100) = 0 ) THEN
         PKG_UTILS.user_ping(PI_SESSION_ID);
      END IF;

      --
      VL_STATUS := 0;
      --
      VL_MESSAGE_H :=   'Order NumordHost : '   ||RL_XIN_T100.NUMORDHOST;
      --
      BEGIN --- HEAD T100

        -- Data Format Check
        VL_MESSAGE_D := 'Format Conversion ';
        VL_CODDIV := 'ALL';
        REC_T100 := REC_T100_INIT;
        --
        REC_T100.CODUSR := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODUSR,'CODUSR', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.NUMORD := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.NUMORD,'NUMORD', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        --
        REC_T100.CODEUSR   := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODEUSR,'CODEUSR', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODTYPORD := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODTYPORD,'CODTYPORD', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODSTATUS := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODSTATUS,'CODSTATUS', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODDIV    := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODDIV,'CODDIV', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODBLCCAUSE := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODBLCCAUSE,'CODBLCCAUSE', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.DTEORD      := F_CHECK_FORMAT_D( VL_CODDIV, RL_XIN_T100.DTEORD,'DTEORD', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.DTEDELIV    := F_CHECK_FORMAT_D( VL_CODDIV, RL_XIN_T100.DTEDELIV,'DTEDELIV', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODTYPDELIV := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODTYPDELIV,'CODTYPDELIV', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.DTEEVA      := F_CHECK_FORMAT_D( VL_CODDIV, RL_XIN_T100.DTEEVA,'DTEEVA', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODPAYTRM   := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODPAYTRM,'CODPAYTRM', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODPAYMOD   := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODPAYMOD,'CODPAYMOD', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODCUSTDELIV := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODCUSTDELIV,'CODCUSTDELIV', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODVATMGMT   := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODVATMGMT,'CODVATMGMT', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODCUSTINV   := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODCUSTINV,'CODCUSTINV', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODLIST      := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODLIST,'CODLIST', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODCUR       := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODCUR,'CODCUR', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.NUMORDREF    := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.NUMORDREF,'NUMORDREF', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.NUMORDHOST   := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.NUMORDHOST,'NUMORDHOST', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.NUMORDCUST   := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.NUMORDCUST,'NUMORDCUST', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.DTEORDCUST   := F_CHECK_FORMAT_D( VL_CODDIV, RL_XIN_T100.DTEORDCUST,'DTEORDCUST', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODASSORTMENT := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODASSORTMENT,'CODASSORTMENT', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODCANVASS    := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODCANVASS,'CODCANVASS', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODMODSHIP    := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODMODSHIP,'CODMODSHIP', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODMODDELIV   := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODMODDELIV,'CODMODDELIV', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODAGREEMENT  := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.CODAGREEMENT,'CODAGREEMENT', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.DESAGREEMENT  := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.DESAGREEMENT,'DESAGREEMENT', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODUSRAUT     := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODUSRAUT,'CODUSRAUT', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODAGREECLASS := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODAGREECLASS,'CODAGREECLASS', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.DTEAUT        := F_CHECK_FORMAT_D( VL_CODDIV, RL_XIN_T100.DTEAUT,'DTEAUT', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODTYPAUT     := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODTYPAUT,'CODTYPAUT', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.DESAUT        := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.DESAUT,'DESAUT', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.GROSSAMOUNT   := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.GROSSAMOUNT,'GROSSAMOUNT', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.NETAMOUNT     := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.NETAMOUNT,'NETAMOUNT', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.TAXAMOUNT     := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.TAXAMOUNT,'TAXAMOUNT', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.VATAMOUNT     := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.VATAMOUNT,'VATAMOUNT', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.INCREASEAMOUNT := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.INCREASEAMOUNT,'INCREASEAMOUNT', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.DISCOUNTAMOUNT := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.DISCOUNTAMOUNT,'DISCOUNTAMOUNT', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.GIFTAMOUNT     := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.GIFTAMOUNT,'GIFTAMOUNT', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.FLGANN         := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.FLGANN,'FLGANN', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODABI         := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODABI,'CODABI', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODCAB         := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODCAB,'CODCAB', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.DESBAN         := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.DESBAN,'DESBAN', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.DESBRA         := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.DESBRA,'DESBRA', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.DESADDR        := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.DESADDR,'DESADDR', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.DESLOC         := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.DESLOC,'DESLOC', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.DESPRV         := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.DESPRV,'DESPRV', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.QTYTOT         := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.QTYTOT,'QTYTOT', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODPRV         := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODPRV,'CODPRV', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.UMQTYTOT       := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.UMQTYTOT,'UMQTYTOT', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODACCOUNT     := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODACCOUNT,'CODACCOUNT', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.FLGRETURN      := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.FLGRETURN,'FLGRETURN', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.FLGHOSTED      := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.FLGHOSTED,'FLGHOSTED', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.FLGCONFIRMED   := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.FLGCONFIRMED,'FLGCONFIRMED', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        --REC_T100.CODWHS         := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODWHS,'CODWHS', VL_DES_T100,VL_STATUS, VL_MESSAGE_D); --commented because while sending to sage it send as main ware house
        REC_T100.CODSHIPPER     := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODSHIPPER,'CODSHIPPER', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODAZCAPP      := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODAZCAPP,'CODAZCAPP', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODAZCBEN      := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODAZCBEN,'CODAZCBEN', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.DTEPRICE       := F_CHECK_FORMAT_D( VL_CODDIV, RL_XIN_T100.DTEPRICE,'DTEPRICE', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODTYPSALE     := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODTYPSALE,'CODTYPSALE', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.FLGCHECKPROMO  := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.FLGCHECKPROMO,'FLGCHECKPROMO', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODAGREETYPE   := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODAGREETYPE,'CODAGREETYPE', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODSTATUSMAN   := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODSTATUSMAN,'CODSTATUSMAN', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.DISCOUNTAMOUNTOUTINV := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.DISCOUNTAMOUNTOUTINV,'DISCOUNTAMOUNTOUTINV', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODTYPORDCUST        := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODTYPORDCUST,'CODTYPORDCUST', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODUSR3              := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODUSR3,'CODUSR3', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.DTEDELIVTO           := F_CHECK_FORMAT_D( VL_CODDIV, RL_XIN_T100.DTEDELIVTO,'DTEDELIVTO', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODCIN               := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODCIN,'CODCIN', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.FLGUMORD2            := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.FLGUMORD2,'FLGUMORD2', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.NETAMOUNTTEO         := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.NETAMOUNTTEO,'NETAMOUNTTEO', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.NETAMOUNTMIN         := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.NETAMOUNTMIN,'NETAMOUNTMIN', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.NETAMOUNTMAX         := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.NETAMOUNTMAX,'NETAMOUNTMAX', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODUSR4              := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODUSR4,'CODUSR4', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODUSR2              := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODUSR2,'CODUSR2', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODBUYEREDI          := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODBUYEREDI,'CODBUYEREDI', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODCUSTINVEDI        := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODCUSTINVEDI,'CODCUSTINVEDI', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODCUSTDELIVEDI      := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODCUSTDELIVEDI,'CODCUSTDELIVEDI', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODSELLEREDI         := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODSELLEREDI,'CODSELLEREDI', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODUSR6              := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODUSR6,'CODUSR6', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODPDV               := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODPDV,'CODPDV', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODCUSTCONC          := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODCUSTCONC,'CODCUSTCONC', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODIBAN              := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODIBAN,'CODIBAN', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.BACKAMOUNT           := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.BACKAMOUNT,'BACKAMOUNT', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.TOTPALLETS           := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.TOTPALLETS,'TOTPALLETS', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.GROSSWEIGHT          := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.GROSSWEIGHT,'GROSSWEIGHT', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.TOTMC                := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.TOTMC,'TOTMC', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.DTEPROPDELIV         := F_CHECK_FORMAT_D( VL_CODDIV, RL_XIN_T100.DTEPROPDELIV,'DTEPROPDELIV', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODUSR5              := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODUSR5,'CODUSR5', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.IDSURVEY             := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.IDSURVEY,'IDSURVEY', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.CODCUSTSALE          := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.CODCUSTSALE,'CODCUSTSALE', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.FLGPROCESSEDEDI      := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.FLGPROCESSEDEDI,'FLGPROCESSEDEDI', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.FLGEDI               := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.FLGEDI,'FLGEDI', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.NUMESENZIONE         := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.NUMESENZIONE,'NUMESENZIONE', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.DTEDELIV2            := F_CHECK_FORMAT_D( VL_CODDIV, RL_XIN_T100.DTEDELIV2,'DTEDELIV2', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.DTEDELIV3            := F_CHECK_FORMAT_D( VL_CODDIV, RL_XIN_T100.DTEDELIV3,'DTEDELIV3', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.DTEDELIV4            := F_CHECK_FORMAT_D( VL_CODDIV, RL_XIN_T100.DTEDELIV4,'DTEDELIV4', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.DTEDELIV5            := F_CHECK_FORMAT_D( VL_CODDIV, RL_XIN_T100.DTEDELIV5,'DTEDELIV5', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.IDROUTE              := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.IDROUTE,'IDROUTE', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
        REC_T100.NUMDOC               := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T100.NUMDOC,'NUMDOC', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
         -- DTECLOSE
         IF( LENGTH(TRIM(TO_CHAR(RL_XIN_T100.DTECLOSE))) <> 0 AND RL_XIN_T100.DTECLOSE IS NOT NULL ) THEN
         REC_T100.DTECLOSE   := RL_XIN_T100.DTECLOSE;
         ELSE
         REC_T100.DTECLOSE             := F_CHECK_FORMAT_D( VL_CODDIV, RL_XIN_T100.DTECLOSE,'DTECLOSE', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
         END IF;
    REC_T100.RETURNAMOUNT         := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T100.RETURNAMOUNT,'RETURNAMOUNT', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);

              
        --- Technical fields
        REC_T100.DTECRE     := XSYSDATE;
        REC_T100.CODUSRMOD  := C_SYSUSR;
        REC_T100.DTEMOD     := XSYSDATE;
        REC_T100.CODUSRMODREAL := C_SYSUSR;
        REC_T100.CODUSRCREREAL := C_SYSUSR;
        -- lock fields
        REC_T100.CODUSRLCK     := C_SYSUSR;
        REC_T100.IDSESSIONLCK  := PI_SESSION_ID;
        REC_T100.DTELCK        := XSYSDATE;
       -- ADD BY MADY 20200311
        REC_T100.FLGPROCESSEDASSET := 0;
    dbms_output.put_line(' VLSTATUS after asigning t100 values  '|| VL_STATUS );


        IF (VL_STATUS <> 0 ) THEN

             VL_MESSAGE_H := SUBSTR(VL_MESSAGE_H||' '||VL_MESSAGE_D||' '||dbms_utility.format_error_backtrace() || ' ' || SQLERRM,1,4000);

             PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                           VL_PROGR_D_T100,
                                           SQLCODE,
                                           VL_MESSAGE_H);
        /* ELSE    
             Recocgnize SM1 Orders and fit in REC_T100 record updated values
            inserts new orders coming from ERP
            LOAD_T10X_HEAD_STEP1( PI_PROGR_H,
                                VL_PROGR_D_T100,
                                 REC_T100,
                                 VL_STATUS); */ --- COMMENTED BY VIKAS

        END IF;
        -- -----------------------------------
        -- T106ORDERROW
        -- -----------------------------------
        BEGIN
        --
         dbms_output.put_line(' VLSTATUS before updating row qty is  '|| VL_STATUS );
        IF ( VL_STATUS = 0  ) THEN
            -- Before updating all rows, we mark them all to recognize those no more sent by ERP
            -- we use a prefix on CODSTATUS
        UPDATE T106ORDROW T
              set T.codstatus =C_T106_STATUS_PREFIX||t.codstatus,

              t.qtyord = '0',t.qtyinv = '0' -- added by vikas , not returned rows from SAGE should be set as zero qty in SM1

              where t.numord = REC_T100.NUMORD
                --and t.codusr = REC_T100.CODUSR
                ;
        
              FOR RL_XIN_T106 IN CL_XIN_T106(RL_XIN_T100.NUMORDHOST, RL_XIN_T100.SM1_DTECRE)
                 LOOP

                VL_MESSAGE_H := 'Row info: '|| REC_T100.NUMORD|| '/' ||
                                               REC_T100.CODUSR|| '/' ||
                                               RL_XIN_T106.CODDIV || '/' ||
                                               RL_XIN_T106.NUMROWHOST;

                  VL_MESSAGE_D := 'Format Conversion ';
                  VL_CODDIV := RL_XIN_T106.CODDIV;
                  REC_T106  := REC_T106_INIT;
                  ---
                  REC_T106.NUMORD := REC_T100.NUMORD;
                  REC_T106.CODUSR := REC_T100.CODUSR;
                  --
                  REC_T106.NUMROW := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.NUMROW,'NUMROW', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.CODART := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.CODART,'CODART', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.CODDIV := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.CODDIV,'CODDIV', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.UMORD  := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.UMORD,'UMORD', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.DESART := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.DESART,'DESART', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.QTYORD := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.QTYORD,'QTYORD', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.QTYBCKORD := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.QTYBCKORD,'QTYBCKORD', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.QTYANN    := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.QTYANN,'QTYANN', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.QTYDEL    := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.QTYDEL,'QTYDEL', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.UMINV     := REC_T106.UMORD;-- F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.UMINV,'UMINV', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.QTYINV    := REC_T106.QTYORD;-- F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.QTYINV,'QTYINV', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);-- qtyord and qtyinv will be equal in sales responce 
                  REC_T106.CODTYPROW := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.CODTYPROW,'CODTYPROW', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.CODLIST   := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.CODLIST,'CODLIST', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.DTEDELIV  := F_CHECK_FORMAT_D( VL_CODDIV,  RL_XIN_T106.DTEDELIV,'DTEDELIV', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.DTEPROPDELIV := F_CHECK_FORMAT_D( VL_CODDIV,  RL_XIN_T106.DTEPROPDELIV,'DTEPROPDELIV', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.CODSTATUS := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.CODSTATUS,'CODSTATUS', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.CODSHIPPER := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.CODSHIPPER,'CODSHIPPER', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.NUMDOCREF := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.NUMDOCREF,'NUMDOCREF', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.DTEDOCREF := F_CHECK_FORMAT_D( VL_CODDIV,  RL_XIN_T106.DTEDOCREF,'DTEDOCREF', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.GROSSAMOUNT := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.GROSSAMOUNT,'GROSSAMOUNT', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.NUMINV      := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.NUMINV,'NUMINV', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.NETAMOUNT   := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.NETAMOUNT,'NETAMOUNT', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.DTEINV      := F_CHECK_FORMAT_D( VL_CODDIV,  RL_XIN_T106.DTEINV,'DTEINV', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.TAXAMOUNT   := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.TAXAMOUNT,'TAXAMOUNT', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.VATAMOUNT   := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.VATAMOUNT,'VATAMOUNT', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.INCREASEAMOUNT := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.INCREASEAMOUNT,'INCREASEAMOUNT', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.DISCOUNTAMOUNT := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.DISCOUNTAMOUNT,'DISCOUNTAMOUNT', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.GIFTAMOUNT     := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.GIFTAMOUNT,'GIFTAMOUNT', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.ENDUSERPRICE   := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.ENDUSERPRICE,'ENDUSERPRICE', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.CODAZCAPP      := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.CODAZCAPP,'CODAZCAPP', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.FLGEFFBCKORD   := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.FLGEFFBCKORD,'FLGEFFBCKORD', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.CODBCKORDCAUSE := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.CODBCKORDCAUSE,'CODBCKORDCAUSE', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.GROSSARTAMOUNT := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.GROSSARTAMOUNT,'GROSSARTAMOUNT', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.NETARTAMOUNT   := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.NETARTAMOUNT,'NETARTAMOUNT', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.CODSRC         := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.CODSRC,'CODSRC', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.CODSRCREF      := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.CODSRCREF,'CODSRCREF', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.CODBENCAUSE    := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.CODBENCAUSE,'CODBENCAUSE', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.CODBENSUBCAUSE := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.CODBENSUBCAUSE,'CODBENSUBCAUSE', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.BENNOTE        := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.BENNOTE,'BENNOTE', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.AZCTOAPPLY     := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.AZCTOAPPLY,'AZCTOAPPLY', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.CODOPERATION   := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.CODOPERATION,'CODOPERATION', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.DISCOUNTAMOUNTOUTINV := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.DISCOUNTAMOUNTOUTINV,'DISCOUNTAMOUNTOUTINV', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.CODACCAPP            := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.CODACCAPP,'CODACCAPP', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.CODTYPROWCAUSE       := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.CODTYPROWCAUSE,'CODTYPROWCAUSE', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.CODARTCUST           := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.CODARTCUST,'CODARTCUST', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.QTYRESO              := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.QTYRESO,'QTYRESO', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.NUMORDRESO           := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.NUMORDRESO,'NUMORDRESO', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.CODBLCCAUSE          := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.CODBLCCAUSE,'CODBLCCAUSE', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.CODARTKITREF         := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.CODARTKITREF,'CODARTKITREF', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.NUMROWKITREF         := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.NUMROWKITREF,'NUMROWKITREF', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.CODCAUSEKIT          := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.CODCAUSEKIT,'CODCAUSEKIT', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.NETARTAMOUNTTEO      := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.NETARTAMOUNTTEO,'NETARTAMOUNTTEO', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.NETAMOUNTTEO         := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.NETAMOUNTTEO,'NETAMOUNTTEO', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.NETAMOUNTMIN         := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.NETAMOUNTMIN,'NETAMOUNTMIN', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.NETAMOUNTMAX         := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.NETAMOUNTMAX,'NETAMOUNTMAX', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.NETDIFF              := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.NETDIFF,'NETDIFF', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.COD_ABBINAMENTO_KIT  := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.COD_ABBINAMENTO_KIT,'COD_ABBINAMENTO_KIT', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.NUMROWORIG           := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.NUMROWORIG,'NUMROWORIG', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.FLGFIRSTSON          := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.FLGFIRSTSON,'FLGFIRSTSON', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.NETARTAMOUNTCUST     := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.NETARTAMOUNTCUST,'NETARTAMOUNTCUST', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.NETARTAMOUNTCUST2    := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.NETARTAMOUNTCUST2,'NETARTAMOUNTCUST2', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.GROSSARTAMOUNTCUST   := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.GROSSARTAMOUNTCUST,'GROSSARTAMOUNTCUST', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.NETAMOUNTCUST        := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.NETAMOUNTCUST,'NETAMOUNTCUST', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.QTYORDEDI            := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.QTYORDEDI,'QTYORDEDI', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.CODEAN               := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.CODEAN,'CODEAN', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.UMORDEDI             := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.UMORDEDI,'UMORDEDI', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.NUMROWREF            := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.NUMROWREF,'NUMROWREF', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.FLGOMGPROMO          := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.FLGOMGPROMO,'FLGOMGPROMO', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.GROSSARTAMOUNTORD    := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.GROSSARTAMOUNTORD,'GROSSARTAMOUNTORD', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.GROSSARTAMOUNTDELTA  := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.GROSSARTAMOUNTDELTA,'GROSSARTAMOUNTDELTA', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.FLGOMGDISCLIST       := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.FLGOMGDISCLIST,'FLGOMGDISCLIST', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.CODCNVPDA            := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.CODCNVPDA,'CODCNVPDA', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.DTEEVA               := F_CHECK_FORMAT_D( VL_CODDIV,  RL_XIN_T106.DTEEVA,'DTEEVA', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.CODPAYTRM            := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.CODPAYTRM,'CODPAYTRM', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.CODPAYMOD            := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.CODPAYMOD,'CODPAYMOD', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.NUMORDHOST           := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.NUMORDHOST,'NUMORDHOST', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.NUMROWHOST           := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.NUMROWHOST,'NUMROWHOST', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.CODMODSHIP           := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.CODMODSHIP,'CODMODSHIP', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.CODMODDELIV          := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.CODMODDELIV,'CODMODDELIV', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.CODWHS               := RL_XIN_T106.VANWHS ; --F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.VANWHS,'CODWHS', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.DTEPRICE             := F_CHECK_FORMAT_D( VL_CODDIV,  RL_XIN_T106.DTEPRICE,'DTEPRICE', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.DTEDELIVTO           := F_CHECK_FORMAT_D( VL_CODDIV,  RL_XIN_T106.DTEDELIVTO,'DTEDELIVTO', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.CODROWGROUP          := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T106.CODROWGROUP,'CODROWGROUP', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.NETAMOUNTGIFT        := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.NETAMOUNTGIFT,'NETAMOUNTGIFT', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.NETARTAMOUNTEDI      := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.NETARTAMOUNTEDI,'NETARTAMOUNTEDI', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.GROSSARTAMOUNTEDI    := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.GROSSARTAMOUNTEDI,'GROSSARTAMOUNTEDI', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.QTYORDORIG           := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.QTYORDORIG,'QTYORDORIG', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.QTYALLOCATED         := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.QTYALLOCATED,'QTYALLOCATED', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);
                  REC_T106.RETURNAMOUNT         := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T106.RETURNAMOUNT,'RETURNAMOUNT', VL_DES_T106,VL_STATUS, VL_MESSAGE_D);

                  -- Technical fields
                  --

                  dbms_output.put_line(' -- Technical fields VLSTATUS 8778  '|| VL_STATUS );
                 IF (VL_STATUS <> 0 ) THEN


                   VL_MESSAGE_H := SUBSTR(VL_MESSAGE_H||' '||VL_MESSAGE_D||' '||dbms_utility.format_error_backtrace() || ' ' || SQLERRM,1,4000);
                   PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                           VL_PROGR_D_T106,
                                           SQLCODE,
                                           VL_MESSAGE_H);
                ELSE

                 vl_ins_upd := NULL;
                  -- Recognize order lines; inserts new rows ; check the row
                 LOAD_T10X_ROW_STEP2( PI_PROGR_H,
                                      VL_PROGR_D_T106,
                                      REC_T106,
                                      vl_ins_upd,
                                      VL_STATUS);

                END IF;
                --
    --dbms_output.put_line(' -- Technical fields VLSTATUS 8799  '|| VL_STATUS );
              IF (VL_STATUS = 0 ) then
          dbms_output.put_line('checking  vl_ins_upd');
               if (vl_ins_upd = 'UPD') THEN
                VL_MESSAGE_D := 'Update T106 ';
        dbms_output.put_line('start updating rows');
                UPDATE T106ORDROW
                   SET

                  --  CODUSR = CASE VL_DES_T106('CODUSR').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODUSR ELSE CODUSR END,
                  --  NUMORD = CASE VL_DES_T106('NUMORD').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.NUMORD ELSE NUMORD END,
                  --  NUMROW = rec_t106.numrow,
                  --  CODART = CASE VL_DES_T106('CODART').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODART ELSE CODART END,
                  --  CODDIV = CASE VL_DES_T106('CODDIV').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODDIV ELSE CODDIV END,
                    UMORD = CASE VL_DES_T106('UMORD.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.UMORD ELSE UMORD END,
                  --  DESART = CASE VL_DES_T106('DESART.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.DESART ELSE DESART END,
                    QTYORD = CASE VL_DES_T106('QTYORD.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.QTYORD ELSE QTYORD END,
                    --QTYBCKORD = CASE VL_DES_T106('QTYBCKORD.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.QTYBCKORD ELSE QTYBCKORD END,
                    --QTYANN = CASE VL_DES_T106('QTYANN.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.QTYANN ELSE QTYANN END,
                    --QTYDEL = CASE VL_DES_T106('QTYDEL.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.QTYDEL ELSE QTYDEL END,
                   -- UMINV = CASE VL_DES_T106('UMINV.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.UMINV ELSE UMINV END,
                    QTYINV = CASE VL_DES_T106('QTYINV.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.QTYINV ELSE QTYINV END,                  
                    --CODTYPROW = CASE VL_DES_T106('CODTYPROW.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODTYPROW ELSE CODTYPROW END,
                    --CODLIST = CASE VL_DES_T106('CODLIST.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODLIST ELSE CODLIST END,
                    --DTEDELIV = CASE VL_DES_T106('DTEDELIV.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.DTEDELIV ELSE DTEDELIV END,
                    --DTEPROPDELIV = CASE VL_DES_T106('DTEPROPDELIV.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.DTEPROPDELIV ELSE DTEPROPDELIV END,
                    CODSTATUS = CASE VL_DES_T106('CODSTATUS.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODSTATUS ELSE CODSTATUS END,
                    --CODSHIPPER = CASE VL_DES_T106('CODSHIPPER.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODSHIPPER ELSE CODSHIPPER END,
                    --NUMDOCREF = CASE VL_DES_T106('NUMDOCREF.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.NUMDOCREF ELSE NUMDOCREF END,
                    --DTEDOCREF = CASE VL_DES_T106('DTEDOCREF.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.DTEDOCREF ELSE DTEDOCREF END,
                    --GROSSAMOUNT = CASE VL_DES_T106('GROSSAMOUNT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.GROSSAMOUNT ELSE GROSSAMOUNT END,
                    --NUMINV = CASE VL_DES_T106('NUMINV.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.NUMINV ELSE NUMINV END,
                    --NETAMOUNT = CASE VL_DES_T106('NETAMOUNT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.NETAMOUNT ELSE NETAMOUNT END,
                    --DTEINV = CASE VL_DES_T106('DTEINV.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.DTEINV ELSE DTEINV END,
                    --TAXAMOUNT = CASE VL_DES_T106('TAXAMOUNT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.TAXAMOUNT ELSE TAXAMOUNT END,
                    --VATAMOUNT = CASE VL_DES_T106('VATAMOUNT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.VATAMOUNT ELSE VATAMOUNT END,
                    --INCREASEAMOUNT = CASE VL_DES_T106('INCREASEAMOUNT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.INCREASEAMOUNT ELSE INCREASEAMOUNT END,
                    --DISCOUNTAMOUNT = CASE VL_DES_T106('DISCOUNTAMOUNT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.DISCOUNTAMOUNT ELSE DISCOUNTAMOUNT END,
                    --GIFTAMOUNT = CASE VL_DES_T106('GIFTAMOUNT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.GIFTAMOUNT ELSE GIFTAMOUNT END,
                    --ENDUSERPRICE = CASE VL_DES_T106('ENDUSERPRICE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.ENDUSERPRICE ELSE ENDUSERPRICE END,
                    --CODAZCAPP = CASE VL_DES_T106('CODAZCAPP.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODAZCAPP ELSE CODAZCAPP END,
                    --FLGEFFBCKORD = CASE VL_DES_T106('FLGEFFBCKORD.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.FLGEFFBCKORD ELSE FLGEFFBCKORD END,
                    --CODBCKORDCAUSE = CASE VL_DES_T106('CODBCKORDCAUSE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODBCKORDCAUSE ELSE CODBCKORDCAUSE END,
                    --GROSSARTAMOUNT = CASE VL_DES_T106('GROSSARTAMOUNT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.GROSSARTAMOUNT ELSE GROSSARTAMOUNT END,
                    --NETARTAMOUNT = CASE VL_DES_T106('NETARTAMOUNT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.NETARTAMOUNT ELSE NETARTAMOUNT END,
                    --CODSRC = CASE VL_DES_T106('CODSRC.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODSRC ELSE CODSRC END,
                    --CODSRCREF = CASE VL_DES_T106('CODSRCREF.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODSRCREF ELSE CODSRCREF END,
                    --CODBENCAUSE = CASE VL_DES_T106('CODBENCAUSE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODBENCAUSE ELSE CODBENCAUSE END,
                    --CODBENSUBCAUSE = CASE VL_DES_T106('CODBENSUBCAUSE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODBENSUBCAUSE ELSE CODBENSUBCAUSE END,
                    --BENNOTE = CASE VL_DES_T106('BENNOTE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.BENNOTE ELSE BENNOTE END,
                    --AZCTOAPPLY = CASE VL_DES_T106('AZCTOAPPLY.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.AZCTOAPPLY ELSE AZCTOAPPLY END,
                   -- CODOPERATION = CASE VL_DES_T106('CODOPERATION.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODOPERATION ELSE CODOPERATION END,
                   -- DISCOUNTAMOUNTOUTINV = CASE VL_DES_T106('DISCOUNTAMOUNTOUTINV.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.DISCOUNTAMOUNTOUTINV ELSE DISCOUNTAMOUNTOUTINV END,
                    --CODACCAPP = CASE VL_DES_T106('CODACCAPP.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODACCAPP ELSE CODACCAPP END,
                    --CODTYPROWCAUSE = CASE VL_DES_T106('CODTYPROWCAUSE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODTYPROWCAUSE ELSE CODTYPROWCAUSE END,
                    --CODARTCUST = CASE VL_DES_T106('CODARTCUST.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODARTCUST ELSE CODARTCUST END,
                    --QTYRESO = CASE VL_DES_T106('QTYRESO.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.QTYRESO ELSE QTYRESO END,
                    --NUMORDRESO = CASE VL_DES_T106('NUMORDRESO.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.NUMORDRESO ELSE NUMORDRESO END,
                    --CODBLCCAUSE = CASE VL_DES_T106('CODBLCCAUSE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODBLCCAUSE ELSE CODBLCCAUSE END,
                    --CODARTKITREF = CASE VL_DES_T106('CODARTKITREF.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODARTKITREF ELSE CODARTKITREF END,
                    --NUMROWKITREF = CASE VL_DES_T106('NUMROWKITREF.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.NUMROWKITREF ELSE NUMROWKITREF END,
                    --CODCAUSEKIT = CASE VL_DES_T106('CODCAUSEKIT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODCAUSEKIT ELSE CODCAUSEKIT END,
                    --NETARTAMOUNTTEO = CASE VL_DES_T106('NETARTAMOUNTTEO.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.NETARTAMOUNTTEO ELSE NETARTAMOUNTTEO END,
                    --NETAMOUNTTEO = CASE VL_DES_T106('NETAMOUNTTEO.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.NETAMOUNTTEO ELSE NETAMOUNTTEO END,
                    --NETAMOUNTMIN = CASE VL_DES_T106('NETAMOUNTMIN.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.NETAMOUNTMIN ELSE NETAMOUNTMIN END,
                    --NETAMOUNTMAX = CASE VL_DES_T106('NETAMOUNTMAX.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.NETAMOUNTMAX ELSE NETAMOUNTMAX END,
                    --NETDIFF = CASE VL_DES_T106('NETDIFF.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.NETDIFF ELSE NETDIFF END,
                    --COD_ABBINAMENTO_KIT = CASE VL_DES_T106('COD_ABBINAMENTO_KIT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.COD_ABBINAMENTO_KIT ELSE COD_ABBINAMENTO_KIT END,
                    --NUMROWORIG = CASE VL_DES_T106('NUMROWORIG.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.NUMROWORIG ELSE NUMROWORIG END,
                    --FLGFIRSTSON = CASE VL_DES_T106('FLGFIRSTSON.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.FLGFIRSTSON ELSE FLGFIRSTSON END,
                    --NETARTAMOUNTCUST = CASE VL_DES_T106('NETARTAMOUNTCUST.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.NETARTAMOUNTCUST ELSE NETARTAMOUNTCUST END,
                    --NETARTAMOUNTCUST2 = CASE VL_DES_T106('NETARTAMOUNTCUST2.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.NETARTAMOUNTCUST2 ELSE NETARTAMOUNTCUST2 END,
                    --GROSSARTAMOUNTCUST = CASE VL_DES_T106('GROSSARTAMOUNTCUST.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.GROSSARTAMOUNTCUST ELSE GROSSARTAMOUNTCUST END,
                    --NETAMOUNTCUST = CASE VL_DES_T106('NETAMOUNTCUST.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.NETAMOUNTCUST ELSE NETAMOUNTCUST END,
                    --QTYORDEDI = CASE VL_DES_T106('QTYORDEDI.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.QTYORDEDI ELSE QTYORDEDI END,
                    --CODEAN = CASE VL_DES_T106('CODEAN.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODEAN ELSE CODEAN END,
                    --UMORDEDI = CASE VL_DES_T106('UMORDEDI.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.UMORDEDI ELSE UMORDEDI END,
                    --NUMROWREF = CASE VL_DES_T106('NUMROWREF.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.NUMROWREF ELSE NUMROWREF END,
                    --FLGOMGPROMO = CASE VL_DES_T106('FLGOMGPROMO.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.FLGOMGPROMO ELSE FLGOMGPROMO END,
                    --GROSSARTAMOUNTORD = CASE VL_DES_T106('GROSSARTAMOUNTORD.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.GROSSARTAMOUNTORD ELSE GROSSARTAMOUNTORD END,
                    --GROSSARTAMOUNTDELTA = CASE VL_DES_T106('GROSSARTAMOUNTDELTA.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.GROSSARTAMOUNTDELTA ELSE GROSSARTAMOUNTDELTA END,
                    --FLGOMGDISCLIST = CASE VL_DES_T106('FLGOMGDISCLIST.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.FLGOMGDISCLIST ELSE FLGOMGDISCLIST END,
                    --CODCNVPDA = CASE VL_DES_T106('CODCNVPDA.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODCNVPDA ELSE CODCNVPDA END,
                    --DTEEVA = CASE VL_DES_T106('DTEEVA.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.DTEEVA ELSE DTEEVA END,
                    --CODPAYTRM = CASE VL_DES_T106('CODPAYTRM.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODPAYTRM ELSE CODPAYTRM END,
                    --CODPAYMOD = CASE VL_DES_T106('CODPAYMOD.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODPAYMOD ELSE CODPAYMOD END,
                    NUMORDHOST = CASE VL_DES_T106('NUMORDHOST.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.NUMORDHOST ELSE NUMORDHOST END,
                    NUMROWHOST = CASE VL_DES_T106('NUMROWHOST.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.NUMROWHOST ELSE NUMROWHOST END  --,
                    --CODMODSHIP = CASE VL_DES_T106('CODMODSHIP.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODMODSHIP ELSE CODMODSHIP END,
                    --CODMODDELIV = CASE VL_DES_T106('CODMODDELIV.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODMODDELIV ELSE CODMODDELIV END,
                    --CODWHS = CASE VL_DES_T106('CODWHS.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODWHS ELSE CODWHS END,
                    --DTEPRICE = CASE VL_DES_T106('DTEPRICE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.DTEPRICE ELSE DTEPRICE END,
                    --DTEDELIVTO = CASE VL_DES_T106('DTEDELIVTO.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.DTEDELIVTO ELSE DTEDELIVTO END,
                    --CODROWGROUP = CASE VL_DES_T106('CODROWGROUP.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.CODROWGROUP ELSE CODROWGROUP END,
                    --NETAMOUNTGIFT = CASE VL_DES_T106('NETAMOUNTGIFT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.NETAMOUNTGIFT ELSE NETAMOUNTGIFT END,
                    --NETARTAMOUNTEDI = CASE VL_DES_T106('NETARTAMOUNTEDI.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.NETARTAMOUNTEDI ELSE NETARTAMOUNTEDI END,
                    --GROSSARTAMOUNTEDI = CASE VL_DES_T106('GROSSARTAMOUNTEDI.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.GROSSARTAMOUNTEDI ELSE GROSSARTAMOUNTEDI END,
                    --QTYORDORIG = CASE VL_DES_T106('QTYORDORIG.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.QTYORDORIG ELSE QTYORDORIG END,
                    --QTYALLOCATED = CASE VL_DES_T106('QTYALLOCATED.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.QTYALLOCATED ELSE QTYALLOCATED END,
                    --RETURNAMOUNT = CASE VL_DES_T106('RETURNAMOUNT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T106.RETURNAMOUNT ELSE RETURNAMOUNT END

                 WHERE NUMORD = REC_T106.NUMORD
                   --AND CODUSR = REC_T106.CODUSR
                   AND NUMROW = REC_T106.NUMROW ;

               else
                  -- record does not exists , we insert it
                  VL_MESSAGE_D := 'Insert T106 ';
                  
                  INSERT INTO T106ORDROW VALUES REC_T106;
               end if;
              VL_INS_T106 := VL_INS_T106 + 1;
             end if;

       END LOOP;   --T106ORDROW
       END IF;
       EXCEPTION WHEN OTHERS THEN
             VL_STATUS := -1;
             VL_MESSAGE_H := SUBSTR(VL_MESSAGE_H||' '||VL_MESSAGE_D||' '||dbms_utility.format_error_backtrace() || ' ' || SQLERRM,1,4000);

             PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                           VL_PROGR_D_T106,
                                           SQLCODE,
                                           VL_MESSAGE_H);

      END; -- DIVISION T106

      -- Commented by Fowza, Status will be coming from ERP. Date : 14-Apr-2015
      --if vl_status = 0 then
      -- Calculate Head Totals and Head Status
      --LOAD_T10X_HEAD_STEP3( PI_PROGR_H,
       --                     VL_PROGR_D_T100,
       --                     REC_T100,
       --                     VL_STATUS);

      --end if;
      IF (VL_STATUS = 0 ) THEN
          -- when status <> 0 some fields have incorrect format. Log t800 has been already wrote by F_CHECK function
          -- Update article if already exists

           VL_MESSAGE_D := 'Update T100ORDHEAD ';
           UPDATE T100ORDHEAD
           SET
            -- when the field si set to updated by host it means that the value should be read from XIN
               -- otherwise it means that the field is managed by sm1 and it maintains its original value
              CODEUSR = CASE VL_DES_T100('CODEUSR.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODEUSR ELSE CODEUSR END,
              CODTYPORD = CASE VL_DES_T100('CODTYPORD.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODTYPORD ELSE CODTYPORD END,
              CODSTATUS = CASE VL_DES_T100('CODSTATUS.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODSTATUS ELSE CODSTATUS END,
              CODDIV = CASE VL_DES_T100('CODDIV.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODDIV ELSE CODDIV END,
              CODBLCCAUSE = CASE VL_DES_T100('CODBLCCAUSE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODBLCCAUSE ELSE CODBLCCAUSE END,
              DTEORD = CASE VL_DES_T100('DTEORD.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.DTEORD ELSE DTEORD END,
              DTEDELIV = CASE VL_DES_T100('DTEDELIV.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.DTEDELIV ELSE DTEDELIV END,
              CODTYPDELIV = CASE VL_DES_T100('CODTYPDELIV.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODTYPDELIV ELSE CODTYPDELIV END,
              DTEEVA = CASE VL_DES_T100('DTEEVA.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.DTEEVA ELSE DTEEVA END,
              CODPAYTRM = CASE VL_DES_T100('CODPAYTRM.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODPAYTRM ELSE CODPAYTRM END,
              CODPAYMOD = CASE VL_DES_T100('CODPAYMOD.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODPAYMOD ELSE CODPAYMOD END,
              --CODCUSTDELIV = CASE VL_DES_T100('CODCUSTDELIV.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODCUSTDELIV ELSE CODCUSTDELIV END,
              CODVATMGMT = CASE VL_DES_T100('CODVATMGMT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODVATMGMT ELSE CODVATMGMT END,
              --CODCUSTINV = CASE VL_DES_T100('CODCUSTINV.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODCUSTINV ELSE CODCUSTINV END,
              CODLIST = CASE VL_DES_T100('CODLIST.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODLIST ELSE CODLIST END,
              CODCUR = CASE VL_DES_T100('CODCUR.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODCUR ELSE CODCUR END,
              NUMORDREF = CASE VL_DES_T100('NUMORDREF.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.NUMORDREF ELSE NUMORDREF END,
              NUMORDHOST = CASE VL_DES_T100('NUMORDHOST.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.NUMORDHOST ELSE NUMORDHOST END,
              NUMORDCUST = CASE VL_DES_T100('NUMORDCUST.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.NUMORDCUST ELSE NUMORDCUST END,
              DTEORDCUST = CASE VL_DES_T100('DTEORDCUST.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.DTEORDCUST ELSE DTEORDCUST END,
              CODASSORTMENT = CASE VL_DES_T100('CODASSORTMENT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODASSORTMENT ELSE CODASSORTMENT END,
              CODCANVASS = CASE VL_DES_T100('CODCANVASS.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODCANVASS ELSE CODCANVASS END,
              CODMODSHIP = CASE VL_DES_T100('CODMODSHIP.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODMODSHIP ELSE CODMODSHIP END,
              CODMODDELIV = CASE VL_DES_T100('CODMODDELIV.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODMODDELIV ELSE CODMODDELIV END,
              CODAGREEMENT = CASE VL_DES_T100('CODAGREEMENT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODAGREEMENT ELSE CODAGREEMENT END,
              DESAGREEMENT = CASE VL_DES_T100('DESAGREEMENT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.DESAGREEMENT ELSE DESAGREEMENT END,
              CODUSRAUT = CASE VL_DES_T100('CODUSRAUT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODUSRAUT ELSE CODUSRAUT END,
              CODAGREECLASS = CASE VL_DES_T100('CODAGREECLASS.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODAGREECLASS ELSE CODAGREECLASS END,
              DTEAUT = CASE VL_DES_T100('DTEAUT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.DTEAUT ELSE DTEAUT END,
              CODTYPAUT = CASE VL_DES_T100('CODTYPAUT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODTYPAUT ELSE CODTYPAUT END,
              DESAUT = CASE VL_DES_T100('DESAUT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.DESAUT ELSE DESAUT END,

              GROSSAMOUNT = CASE VL_DES_T100('GROSSAMOUNT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.GROSSAMOUNT ELSE GROSSAMOUNT END,
              NETAMOUNT = CASE VL_DES_T100('NETAMOUNT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.NETAMOUNT ELSE NETAMOUNT END,
              TAXAMOUNT = CASE VL_DES_T100('TAXAMOUNT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.TAXAMOUNT ELSE TAXAMOUNT END,
              VATAMOUNT = CASE VL_DES_T100('VATAMOUNT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.VATAMOUNT ELSE VATAMOUNT END,
              INCREASEAMOUNT = CASE VL_DES_T100('INCREASEAMOUNT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.INCREASEAMOUNT ELSE INCREASEAMOUNT END,
              DISCOUNTAMOUNT = CASE VL_DES_T100('DISCOUNTAMOUNT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.DISCOUNTAMOUNT ELSE DISCOUNTAMOUNT END,
              GIFTAMOUNT = CASE VL_DES_T100('GIFTAMOUNT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.GIFTAMOUNT ELSE GIFTAMOUNT END,
              FLGANN = CASE VL_DES_T100('FLGANN.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.FLGANN ELSE FLGANN END,
              CODABI = CASE VL_DES_T100('CODABI.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODABI ELSE CODABI END,
              CODCAB = CASE VL_DES_T100('CODCAB.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODCAB ELSE CODCAB END,
              DESBAN = CASE VL_DES_T100('DESBAN.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.DESBAN ELSE DESBAN END,
              DESBRA = CASE VL_DES_T100('DESBRA.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.DESBRA ELSE DESBRA END,
              DESADDR = CASE VL_DES_T100('DESADDR.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.DESADDR ELSE DESADDR END,
              DESLOC = CASE VL_DES_T100('DESLOC.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.DESLOC ELSE DESLOC END,
              DESPRV = CASE VL_DES_T100('DESPRV.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.DESPRV ELSE DESPRV END,
              QTYTOT = CASE VL_DES_T100('QTYTOT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.QTYTOT ELSE QTYTOT END,
              CODPRV = CASE VL_DES_T100('CODPRV.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODPRV ELSE CODPRV END,
              UMQTYTOT = CASE VL_DES_T100('UMQTYTOT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.UMQTYTOT ELSE UMQTYTOT END,
              CODACCOUNT = CASE VL_DES_T100('CODACCOUNT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODACCOUNT ELSE CODACCOUNT END,
              FLGRETURN = CASE VL_DES_T100('FLGRETURN.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.FLGRETURN ELSE FLGRETURN END,
              FLGHOSTED = CASE VL_DES_T100('FLGHOSTED.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.FLGHOSTED ELSE FLGHOSTED END,
              FLGCONFIRMED = CASE VL_DES_T100('FLGCONFIRMED.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.FLGCONFIRMED ELSE FLGCONFIRMED END,
              --CODWHS = CASE VL_DES_T100('CODWHS.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODWHS ELSE CODWHS END,   ---
              CODSHIPPER = CASE VL_DES_T100('CODSHIPPER.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODSHIPPER ELSE CODSHIPPER END,
              CODAZCAPP = CASE VL_DES_T100('CODAZCAPP.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODAZCAPP ELSE CODAZCAPP END,
              CODAZCBEN = CASE VL_DES_T100('CODAZCBEN.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODAZCBEN ELSE CODAZCBEN END,
              DTEPRICE = CASE VL_DES_T100('DTEPRICE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.DTEPRICE ELSE DTEPRICE END,
              CODTYPSALE = CASE VL_DES_T100('CODTYPSALE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODTYPSALE ELSE CODTYPSALE END,
              FLGCHECKPROMO = CASE VL_DES_T100('FLGCHECKPROMO.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.FLGCHECKPROMO ELSE FLGCHECKPROMO END,
              CODAGREETYPE = CASE VL_DES_T100('CODAGREETYPE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODAGREETYPE ELSE CODAGREETYPE END,
              CODSTATUSMAN = CASE VL_DES_T100('CODSTATUSMAN.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODSTATUSMAN ELSE CODSTATUSMAN END,
              DISCOUNTAMOUNTOUTINV = CASE VL_DES_T100('DISCOUNTAMOUNTOUTINV.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.DISCOUNTAMOUNTOUTINV ELSE DISCOUNTAMOUNTOUTINV END,
              CODTYPORDCUST = CASE VL_DES_T100('CODTYPORDCUST.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODTYPORDCUST ELSE CODTYPORDCUST END,
              CODUSR3 = CASE VL_DES_T100('CODUSR3.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODUSR3 ELSE CODUSR3 END,
              DTEDELIVTO = CASE VL_DES_T100('DTEDELIVTO.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.DTEDELIVTO ELSE DTEDELIVTO END,
              CODCIN = CASE VL_DES_T100('CODCIN.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODCIN ELSE CODCIN END,
              FLGUMORD2 = CASE VL_DES_T100('FLGUMORD2.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.FLGUMORD2 ELSE FLGUMORD2 END,
              NETAMOUNTTEO = CASE VL_DES_T100('NETAMOUNTTEO.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.NETAMOUNTTEO ELSE NETAMOUNTTEO END,
              NETAMOUNTMIN = CASE VL_DES_T100('NETAMOUNTMIN.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.NETAMOUNTMIN ELSE NETAMOUNTMIN END,
              NETAMOUNTMAX = CASE VL_DES_T100('NETAMOUNTMAX.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.NETAMOUNTMAX ELSE NETAMOUNTMAX END,
              CODUSR4 = CASE VL_DES_T100('CODUSR4.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODUSR4 ELSE CODUSR4 END,
              CODUSR2 = CASE VL_DES_T100('CODUSR2.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODUSR2 ELSE CODUSR2 END,
              CODBUYEREDI = CASE VL_DES_T100('CODBUYEREDI.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODBUYEREDI ELSE CODBUYEREDI END,
              --CODCUSTINVEDI = CASE VL_DES_T100('CODCUSTINVEDI.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODCUSTINVEDI ELSE CODCUSTINVEDI END,
              --CODCUSTDELIVEDI = CASE VL_DES_T100('CODCUSTDELIVEDI.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODCUSTDELIVEDI ELSE CODCUSTDELIVEDI END,
              CODSELLEREDI = CASE VL_DES_T100('CODSELLEREDI.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODSELLEREDI ELSE CODSELLEREDI END,

              CODUSR6 = CASE VL_DES_T100('CODUSR6.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODUSR6 ELSE CODUSR6 END,
              CODPDV = CASE VL_DES_T100('CODPDV.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODPDV ELSE CODPDV END,
              CODCUSTCONC = CASE VL_DES_T100('CODCUSTCONC.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODCUSTCONC ELSE CODCUSTCONC END,
              CODIBAN = CASE VL_DES_T100('CODIBAN.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODIBAN ELSE CODIBAN END,
              BACKAMOUNT = CASE VL_DES_T100('BACKAMOUNT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.BACKAMOUNT ELSE BACKAMOUNT END,
              TOTPALLETS = CASE VL_DES_T100('TOTPALLETS.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.TOTPALLETS ELSE TOTPALLETS END,
              GROSSWEIGHT = CASE VL_DES_T100('GROSSWEIGHT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.GROSSWEIGHT ELSE GROSSWEIGHT END,
              TOTMC = CASE VL_DES_T100('TOTMC.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.TOTMC ELSE TOTMC END,
              DTEPROPDELIV = CASE VL_DES_T100('DTEPROPDELIV.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.DTEPROPDELIV ELSE DTEPROPDELIV END,
              CODUSR5 = CASE VL_DES_T100('CODUSR5.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODUSR5 ELSE CODUSR5 END,
              --IDSURVEY = CASE VL_DES_T100('IDSURVEY.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.IDSURVEY ELSE IDSURVEY END,
              --CODCUSTSALE = CASE VL_DES_T100('CODCUSTSALE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.CODCUSTSALE ELSE CODCUSTSALE END,
              FLGPROCESSEDEDI = CASE VL_DES_T100('FLGPROCESSEDEDI.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.FLGPROCESSEDEDI ELSE FLGPROCESSEDEDI END,
              FLGEDI = CASE VL_DES_T100('FLGEDI.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.FLGEDI ELSE FLGEDI END,
              NUMESENZIONE = CASE VL_DES_T100('NUMESENZIONE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.NUMESENZIONE ELSE NUMESENZIONE END,
              DTEDELIV2 = CASE VL_DES_T100('DTEDELIV2.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.DTEDELIV2 ELSE DTEDELIV2 END,
              DTEDELIV3 = CASE VL_DES_T100('DTEDELIV3.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.DTEDELIV3 ELSE DTEDELIV3 END,
              DTEDELIV4 = CASE VL_DES_T100('DTEDELIV4.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.DTEDELIV4 ELSE DTEDELIV4 END,
              DTEDELIV5 = CASE VL_DES_T100('DTEDELIV5.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.DTEDELIV5 ELSE DTEDELIV5 END,
              IDROUTE = CASE VL_DES_T100('IDROUTE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.IDROUTE ELSE IDROUTE END,
              NUMDOC = CASE VL_DES_T100('NUMDOC.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.NUMDOC ELSE NUMDOC END,
              DTECLOSE = CASE VL_DES_T100('DTECLOSE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.DTECLOSE ELSE DTECLOSE END,
              RETURNAMOUNT = CASE VL_DES_T100('RETURNAMOUNT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T100.RETURNAMOUNT ELSE RETURNAMOUNT END,

               --- Technical fields
               CODUSRMOD = REC_T100.CODUSRMOD,
               DTEMOD    = REC_T100.DTEMOD,
               -- lock fields
               CODUSRLCK    = REC_T100.CODUSRLCK,
               IDSESSIONLCK = REC_T100.IDSESSIONLCK,
               DTELCK       = REC_T100.DTELCK

         WHERE NUMORD = REC_T100.NUMORD
          AND  CODUSR = REC_T100.CODUSR
          AND (idsessionlck = REC_T100.IDSESSIONLCK
               or not exists
                     ( select null from T035LOGGEDUSERS T035
                      where T035.IDSESSION = NVL(IDSESSIONLCK, '@') AND T035.LASTCHECK > TRUNC(XSYSDATE)-1 )
               );


        END IF; -- VL_STATUS = 0


        EXCEPTION WHEN OTHERS THEN
             VL_STATUS := -1;
             VL_MESSAGE_H := SUBSTR(VL_MESSAGE_H||' '||VL_MESSAGE_D||' '||dbms_utility.format_error_backtrace() || ' ' || SQLERRM,1,4000);

             PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                           VL_PROGR_D_T100,
                                           SQLCODE,
                                           VL_MESSAGE_H);

        END; -- HEAD T100


     -- if all records have been stored with success then it makes the final commit
      IF VL_STATUS = 0 THEN
         VL_INS_T100 := VL_INS_T100 + 1;
         COMMIT;
      ELSE
        ROLLBACK;
      END IF;

      IF (VL_STATUS <> 0 OR VL_RECORD_LOCKED <> 0) THEN
          UPDATE XIN_T106ORDROW
          SET  SM1_STATUS= CASE
                                WHEN VL_RECORD_LOCKED <> 0  THEN C_XINSTATUS_LOCK
                                ELSE C_XINSTATUS_ERR END
          WHERE CODUSR = RL_XIN_T100.CODUSR
           AND  SM1_CODPROCESS = PI_PROGR_H
           AND  SM1_DTECRE     = RL_XIN_T100.SM1_DTECRE
           AND  SM1_STATUS     = C_XINSTATUS_OK;

          -- TO CHECK this update is  not correct in case of double record .
          UPDATE XIN_T100ORDHEAD
          SET  SM1_STATUS= CASE
                                WHEN VL_RECORD_LOCKED <> 0  THEN C_XINSTATUS_LOCK
                                ELSE C_XINSTATUS_ERR END
          WHERE CODUSR = RL_XIN_T100.CODUSR
           AND  SM1_CODPROCESS = PI_PROGR_H
           AND  SM1_DTECRE     <= RL_XIN_T100.SM1_DTECRE
           AND  SM1_STATUS     = C_XINSTATUS_OK;

          COMMIT;
      END IF;

        -- Release updated records
          UPDATE T100ORDHEAD
          SET       DTELCK          = NULL,
                    IDSESSIONLCK    = NULL,
                    CODUSRLCK       = NULL
          WHERE CODUSR = REC_T100.CODUSR AND CODUSRLCK = C_SYSUSR AND IDSESSIONLCK = PI_SESSION_ID;
          COMMIT;
    END LOOP;  -- T100ORDHEAD


    -- Moves records from staging area to log staging area
    P_XIN_MOVE_TO_LOG(PI_PROGR_H, VL_PROGR_D_T100,'T106ORDROW');
    P_XIN_MOVE_TO_LOG(PI_PROGR_H, VL_PROGR_D_T100,'T100ORDHEAD');

   -- Close Logs
    PKG_UTILS.LOG_END_DETAIL(PI_PROGR_H,
                             VL_PROGR_D_T106,
                             0,
                             VL_COUNT_XIN_T106,
                             VL_INS_T106,
                             VL_COUNT_XIN_T106 - VL_INS_T106);

    PKG_UTILS.LOG_END_DETAIL(PI_PROGR_H,
                             VL_PROGR_D_T100,
                             0,
                             VL_COUNT_XIN_T100,
                             VL_INS_T100,
                             VL_COUNT_XIN_T100 - VL_INS_T100);


    PO_MSG    := VL_INS_T100||'/'||VL_COUNT_XIN_T100||' Orders loaded';
    PO_STATUS := VL_INS_T100;


    --
  EXCEPTION WHEN EX_EXIT THEN

          ROLLBACK;
          VL_MESSAGE_H       := VL_MESSAGE_H || TRIM(SUBSTR(dbms_utility.format_error_backtrace() || ' ' || SQLERRM, 1, 255));
          PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                         VL_PROGR_D_T100,
                                         SQLCODE,
                                         VL_MESSAGE_H);

          PO_MSG := VL_MESSAGE_H;
          PO_STATUS := -1;

   WHEN OTHERS THEN

          ROLLBACK;
         -- Release updated records
            UPDATE T100ORDHEAD
            SET       DTELCK          = NULL,
                      IDSESSIONLCK    = NULL,
                      CODUSRLCK       = NULL
            WHERE CODUSRLCK = C_SYSUSR AND IDSESSIONLCK = PI_SESSION_ID;
            COMMIT;
          -- Moves records from staging area to log staging area
          P_XIN_MOVE_TO_LOG(PI_PROGR_H, VL_PROGR_D_T100,'T106ORDROW');
          P_XIN_MOVE_TO_LOG(PI_PROGR_H, VL_PROGR_D_T100,'T100ORDHEAD');

          VL_MESSAGE_H       := VL_MESSAGE_H || TRIM(SUBSTR(dbms_utility.format_error_backtrace() || ' ' || SQLERRM, 1, 255));

          PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                         VL_PROGR_D_T100,
                                         SQLCODE,
                                         VL_MESSAGE_H);

          PO_MSG := VL_MESSAGE_H;
          PO_STATUS := VL_STATUS;

    END;


  /*============================================================================*\
  /* Name: LOAD_T660_INVOICES
    Loads SM1 tables
      • T660CONT_ATT Active invoice detail
      Staging Area (SSA) tables
      • XIN_ T660CONT_ATT

      Loading logic:
      UPDATE + INSERT record is updated if already exists (checking by primary key) and it is not already locked, record is inserted if it does not exist yet.

      Validity Checks:
      • No checks while loading. The existence of Invoice Customer, Delivery customer and article will be checked after the loading as a warning.

      Error handling:
      • All Errors will be logged in T852/T854 SM1 log tables and all staging area records will be stored into staging area log with sm1_status = 9.
      • Error on record,  it is discarded and import skip to next record to be loaded

      How to delete a record : you cannot delete records in T660CONT_ATT by integration host.


     Input parameters :     PI_PROGR_H - unique sm1 job number ( T800SYSTEMACTIVITYLOG )
                            PI_SESSION_ID    - unique login session (T035LOGGEDUSERS)
     Outputparameters :     PO_MSG           - message of error if procedure exit with error
                            PO_STATUS        - 0 OK; -1 Error
     Author : Mariangela Bandiera
     Creation Date : 2 October 2012
     ----
     Updates :
     30 August 2014 MBandiera -- due to Invoices loading nature ( each month Customers extract new invoices for SM1 )
                                 we change the sequence of loading from UPDATE+INSERT to INSERT+UPDATE as for the 99%
                                 invoices should be new invoices

    ============================================================================ */

   PROCEDURE LOAD_T660_INVOICES( PI_PROGR_H       IN NUMBER,
                                 PI_SESSION_ID    IN NUMBER,
                                 PO_MSG           OUT NOCOPY VARCHAR2,
                                 PO_STATUS        OUT NOCOPY NUMBER ) IS

    -- -----------------------------------------
    -- Cursor on Active Invoices table T660CONT_ATT
    -- -----------------------------------------
    CURSOR CL_XIN_T660 IS
      SELECT
        *
        FROM  XIN_T660CONT_ATT
        WHERE SM1_CODPROCESS = PI_PROGR_H
        ORDER BY SM1_DTECRE;

    --
    VL_MESSAGE_H   VARCHAR2(4000) := 'Error while loading Active Invoices T660';
    VL_MESSAGE_D   VARCHAR2(4000) := NULL;
    --
    VL_PROGR_D_T660    NUMBER := 0;
    VL_COUNT_XIN_T660  NUMBER := 0;
    VL_INS_T660        NUMBER := 0;
    --
    REC_T660 T660CONT_ATT%ROWTYPE    := NULL;
    REC_T660_INIT T660CONT_ATT%ROWTYPE    := NULL;
    --
    VL_DES_T660     X_FIELD_INFO_ARRAY;-- Array with fields db info
    --
    VL_STATUS NUMBER:= 0;
    --VL_COUNT  NUMBER:= 0;
    --
    EX_EXIT  EXCEPTION;
    --
    VL_STEP   NUMBER:= 0; -- Used to ping t035
    VL_CODDIV VARCHAR2(30) := NULL;

  BEGIN
      -- init indexes and rebuild statistics
    P_XIN_INIT_INDEXES (PI_PROGR_H, 'T660CONT_ATT');
    -- clean loG
    P_XIN_CLEANUP_LOG (PI_PROGR_H, 'T660CONT_ATT');
    --
    VL_PROGR_D_T660 := PKG_UTILS.LOG_NEW_DETAIL(PI_PROGR_H,
                                                'ACTIVE INVOICES',
                                                'IMPORT --> T660CONT_ATT',
                                                 0,
                                                 NULL);



   BEGIN
        --
        -- ----------------------------------------------------------
        -- Init arrays with FIELD_NAME=LENGTH and FIELDNAME=SM1_DEFAULT for all fields of table
        -- ----------------------------------------------------------
        VL_DES_T660.DELETE;
        P_INIT_SM1_FIELD_ARRAY ('T660CONT_ATT',VL_DES_T660,VL_STATUS, VL_MESSAGE_H);
        execute immediate ( GL_INIT_REC) INTO REC_T660_INIT;

        IF (VL_STATUS <> 0 ) THEN
            VL_MESSAGE_D := GL_INIT_REC;
            RAISE EX_EXIT;
        END IF;
    EXCEPTION WHEN OTHERS THEN
        VL_MESSAGE_D := GL_INIT_REC;
        RAISE EX_EXIT;
    END;


    -- --------------------------------------------------------------
    -- Identifies Xin records to be loaded
    -- --------------------------------------------------------------
    BEGIN
        VL_MESSAGE_D := 'XIN_T660CONT_ATT';
        UPDATE XIN_T660CONT_ATT
        SET SM1_CODPROCESS = PI_PROGR_H,
            SM1_STATUS = 0,
            SM1_DTEPROCESS = XSYSDATE
            WHERE SM1_CODPROCESS = C_SM1_NULL_CODPROCESS;

        VL_COUNT_XIN_T660 := SQL%ROWCOUNT;

    COMMIT;
    EXCEPTION WHEN OTHERS THEN
      ROLLBACK;
      VL_MESSAGE_H := 'Error while Reading Staging area: '||VL_MESSAGE_D;
      RAISE EX_EXIT;

    END;
    -- --------------------------------------------------------------
    -- loop in main table T660CONT_ATT
    -- --------------------------------------------------------------
    FOR RL_XIN_T660 IN CL_XIN_T660 LOOP
      -- pings to t035 every 1000 cicles--
      VL_STEP := VL_STEP + 1;
      IF ( MOD(VL_STEP, 1000) = 0 ) THEN
         PKG_UTILS.user_ping(PI_SESSION_ID);
      END IF;

      --
      VL_STATUS := 0;
      --
      VL_MESSAGE_H :=   'Doc Number : '||RL_XIN_T660.NUMORD||' '||
                        'Doc Type : '  ||RL_XIN_T660.CODTYPORD||' '||
                        'Row Number : '||RL_XIN_T660.NUMROW||' '||
                        'Division : '  ||RL_XIN_T660.CODDIV;
      --
      BEGIN --- HEAD T660

       -- Data Format Check
        VL_MESSAGE_D := 'Format Conversion ';
        VL_CODDIV:= RL_XIN_T660.CODDIV;
        REC_T660.CODDIV := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T660.CODDIV,'CODDIV', VL_DES_T660,VL_STATUS, VL_MESSAGE_D);
        REC_T660.NUMORD := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T660.NUMORD,'NUMORD', VL_DES_T660,VL_STATUS, VL_MESSAGE_D);
        REC_T660.CODTYPORD := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T660.CODTYPORD,'CODTYPORD', VL_DES_T660,VL_STATUS, VL_MESSAGE_D);
        REC_T660.NUMROW := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T660.NUMROW,'NUMROW', VL_DES_T660,VL_STATUS, VL_MESSAGE_D);
        REC_T660.CODTYPROW := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T660.CODTYPROW,'CODTYPROW', VL_DES_T660,VL_STATUS, VL_MESSAGE_D);
        REC_T660.CODAGREEMENT := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T660.CODAGREEMENT,'CODAGREEMENT', VL_DES_T660,VL_STATUS, VL_MESSAGE_D);
        REC_T660.CODCUSTINV := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T660.CODCUSTINV,'CODCUSTINV', VL_DES_T660,VL_STATUS, VL_MESSAGE_D);
        REC_T660.CODCUSTDELIV := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T660.CODCUSTDELIV,'CODCUSTDELIV', VL_DES_T660,VL_STATUS, VL_MESSAGE_D);
        REC_T660.DTEINV := F_CHECK_FORMAT_D( VL_CODDIV,   RL_XIN_T660.DTEINV,'DTEINV', VL_DES_T660,VL_STATUS, VL_MESSAGE_D);
        REC_T660.CODUSR := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T660.CODUSR,'CODUSR', VL_DES_T660,VL_STATUS, VL_MESSAGE_D);
        REC_T660.CODART := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T660.CODART,'CODART', VL_DES_T660,VL_STATUS, VL_MESSAGE_D);
        REC_T660.UMINV := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T660.UMINV,'UMINV', VL_DES_T660,VL_STATUS, VL_MESSAGE_D);
        REC_T660.QTYINV := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T660.QTYINV,'QTYINV', VL_DES_T660,VL_STATUS, VL_MESSAGE_D);
        REC_T660.QTYSTAT := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T660.QTYSTAT,'QTYSTAT', VL_DES_T660,VL_STATUS, VL_MESSAGE_D);
        REC_T660.NETAMOUNT := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T660.NETAMOUNT,'NETAMOUNT', VL_DES_T660,VL_STATUS, VL_MESSAGE_D);
        REC_T660.UMSTAT := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T660.UMSTAT,'UMSTAT', VL_DES_T660,VL_STATUS, VL_MESSAGE_D);
        REC_T660.CODCUR := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T660.CODCUR,'CODCUR', VL_DES_T660,VL_STATUS, VL_MESSAGE_D);
        REC_T660.UMDELIV := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T660.UMDELIV,'UMDELIV', VL_DES_T660,VL_STATUS, VL_MESSAGE_D);
        REC_T660.GROSSAMOUNT := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T660.GROSSAMOUNT,'GROSSAMOUNT', VL_DES_T660,VL_STATUS, VL_MESSAGE_D);
        REC_T660.CHANGERATE := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T660.CHANGERATE,'CHANGERATE', VL_DES_T660,VL_STATUS, VL_MESSAGE_D);
        REC_T660.QTYDELIV := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T660.QTYDELIV,'QTYDELIV', VL_DES_T660,VL_STATUS, VL_MESSAGE_D);
        REC_T660.DTECOMP := F_CHECK_FORMAT_D( VL_CODDIV,   RL_XIN_T660.DTECOMP,'DTECOMP', VL_DES_T660,VL_STATUS, VL_MESSAGE_D);
        REC_T660.AMOUNT1 := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T660.AMOUNT1,'AMOUNT1', VL_DES_T660,VL_STATUS, VL_MESSAGE_D);
        REC_T660.AMOUNT2 := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T660.AMOUNT2,'AMOUNT2', VL_DES_T660,VL_STATUS, VL_MESSAGE_D);
        REC_T660.AMOUNT3 := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T660.AMOUNT3,'AMOUNT3', VL_DES_T660,VL_STATUS, VL_MESSAGE_D);
        REC_T660.NETARTAMOUNT := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T660.NETARTAMOUNT,'NETARTAMOUNT', VL_DES_T660,VL_STATUS, VL_MESSAGE_D);
        REC_T660.AMOUNT4 := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T660.AMOUNT4,'AMOUNT4', VL_DES_T660,VL_STATUS, VL_MESSAGE_D);
        REC_T660.GROSSARTAMOUNT := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T660.GROSSARTAMOUNT,'GROSSARTAMOUNT', VL_DES_T660,VL_STATUS, VL_MESSAGE_D);
        REC_T660.AMOUNT5 := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T660.AMOUNT5,'AMOUNT5', VL_DES_T660,VL_STATUS, VL_MESSAGE_D);
        REC_T660.AMOUNT6 := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T660.AMOUNT6,'AMOUNT6', VL_DES_T660,VL_STATUS, VL_MESSAGE_D);
        REC_T660.AMOUNT7 := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T660.AMOUNT7,'AMOUNT7', VL_DES_T660,VL_STATUS, VL_MESSAGE_D);
        REC_T660.FLGANN := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T660.FLGANN,'FLGANN', VL_DES_T660,VL_STATUS, VL_MESSAGE_D);
        REC_T660.AMOUNT8 := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T660.AMOUNT8,'AMOUNT8', VL_DES_T660,VL_STATUS, VL_MESSAGE_D);
        REC_T660.AMOUNT9 := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T660.AMOUNT9,'AMOUNT9', VL_DES_T660,VL_STATUS, VL_MESSAGE_D);
        REC_T660.AMOUNT10 := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T660.AMOUNT10,'AMOUNT10', VL_DES_T660,VL_STATUS, VL_MESSAGE_D);
        REC_T660.IDBATCH := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T660.IDBATCH,'IDBATCH', VL_DES_T660,VL_STATUS, VL_MESSAGE_D);
        REC_T660.QTYUM1 := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T660.QTYUM1,'QTYUM1', VL_DES_T660,VL_STATUS, VL_MESSAGE_D);
        REC_T660.QTYUM2 := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T660.QTYUM2,'QTYUM2', VL_DES_T660,VL_STATUS, VL_MESSAGE_D);
        REC_T660.QTYUM3 := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T660.QTYUM3,'QTYUM3', VL_DES_T660,VL_STATUS, VL_MESSAGE_D);
        REC_T660.AMOUNT11 := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T660.AMOUNT11,'AMOUNT11', VL_DES_T660,VL_STATUS, VL_MESSAGE_D);
        REC_T660.AMOUNT12 := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T660.AMOUNT12,'AMOUNT12', VL_DES_T660,VL_STATUS, VL_MESSAGE_D);
        REC_T660.COD_AGENTE := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T660.COD_AGENTE,'COD_AGENTE', VL_DES_T660,VL_STATUS, VL_MESSAGE_D);
        REC_T660.COD_AREA_MANAGER := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T660.COD_AREA_MANAGER,'COD_AREA_MANAGER', VL_DES_T660,VL_STATUS, VL_MESSAGE_D);
        REC_T660.CODDIVQUID := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T660.CODDIVQUID,'CODDIVQUID', VL_DES_T660,VL_STATUS, VL_MESSAGE_D);
        REC_T660.CODUSRORIG := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T660.CODUSRORIG,'CODUSRORIG', VL_DES_T660,VL_STATUS, VL_MESSAGE_D);
        REC_T660.NUMORDORIG := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T660.NUMORDORIG,'NUMORDORIG', VL_DES_T660,VL_STATUS, VL_MESSAGE_D);
        REC_T660.NUMROWORIG := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T660.NUMROWORIG,'NUMROWORIG', VL_DES_T660,VL_STATUS, VL_MESSAGE_D);
        REC_T660.CODCAT1 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T660.CODCAT1,'CODCAT1', VL_DES_T660,VL_STATUS, VL_MESSAGE_D);
        REC_T660.CODCAT2 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T660.CODCAT2,'CODCAT2', VL_DES_T660,VL_STATUS, VL_MESSAGE_D);
        REC_T660.CODCAT3 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T660.CODCAT3,'CODCAT3', VL_DES_T660,VL_STATUS, VL_MESSAGE_D);
        REC_T660.CODCAT4 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T660.CODCAT4,'CODCAT4', VL_DES_T660,VL_STATUS, VL_MESSAGE_D);
        REC_T660.CODCAT5 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T660.CODCAT5,'CODCAT5', VL_DES_T660,VL_STATUS, VL_MESSAGE_D);
        REC_T660.NUMORD1 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T660.NUMORD1,'NUMORD1', VL_DES_T660,VL_STATUS, VL_MESSAGE_D);
        REC_T660.NUMORD2 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T660.NUMORD2,'NUMORD2', VL_DES_T660,VL_STATUS, VL_MESSAGE_D);
        REC_T660.NUMORD3 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T660.NUMORD3,'NUMORD3', VL_DES_T660,VL_STATUS, VL_MESSAGE_D);
        REC_T660.NUMORD4 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T660.NUMORD4,'NUMORD4', VL_DES_T660,VL_STATUS, VL_MESSAGE_D);
        REC_T660.NUMORD5 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T660.NUMORD5,'NUMORD5', VL_DES_T660,VL_STATUS, VL_MESSAGE_D);

        --- Technical fields
        REC_T660.DTEMOD     := XSYSDATE;
        -- Document Key
        REC_T660.DOCUMENTKEY   := PKG_UTILS.documentkey_for_t660(REC_T660.NUMORD, REC_T660.CODTYPORD, REC_T660.NUMROW, REC_T660.CODDIV);

        -- It does not control the existence of customer and articles because it is better to have all invoices loaded an after check the existence as a warning


        IF (VL_STATUS <> 0 ) THEN

             VL_MESSAGE_H := SUBSTR(VL_MESSAGE_H||' '||VL_MESSAGE_D||' '||dbms_utility.format_error_backtrace() || ' ' || SQLERRM,1,4000);

             PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                           VL_PROGR_D_T660,
                                           SQLCODE,
                                           VL_MESSAGE_H);
        END IF;


        IF (VL_STATUS = 0 ) THEN
          -- when status <> 0 some fields have incorrect format. Log t800 has been already wrote by F_CHECK function
          -- Update article if already exists
          BEGIN
            VL_MESSAGE_D := 'Insert T660CONT_ATT ';
            -- Record does not exists, we insert it
            INSERT INTO T660CONT_ATT VALUES REC_T660;

          EXCEPTION WHEN DUP_VAL_ON_INDEX THEN       --
             VL_MESSAGE_D := 'Update T660CONT_ATT ';
             UPDATE T660CONT_ATT
             SET
                 -- when the field si set to updated by host it means that the value should be read from XIN
                 -- otherwise it means that the field is managed by sm1 and it maintains its original value
                CODTYPROW = CASE VL_DES_T660('CODTYPROW.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T660.CODTYPROW ELSE CODTYPROW END,
                CODAGREEMENT = CASE VL_DES_T660('CODAGREEMENT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T660.CODAGREEMENT ELSE CODAGREEMENT END,
                CODCUSTINV = CASE VL_DES_T660('CODCUSTINV.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T660.CODCUSTINV ELSE CODCUSTINV END,
                CODCUSTDELIV = CASE VL_DES_T660('CODCUSTDELIV.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T660.CODCUSTDELIV ELSE CODCUSTDELIV END,
                DTEINV = CASE VL_DES_T660('DTEINV.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T660.DTEINV ELSE DTEINV END,
                CODUSR = CASE VL_DES_T660('CODUSR.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T660.CODUSR ELSE CODUSR END,
                CODART = CASE VL_DES_T660('CODART.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T660.CODART ELSE CODART END,
                UMINV = CASE VL_DES_T660('UMINV.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T660.UMINV ELSE UMINV END,
                QTYINV = CASE VL_DES_T660('QTYINV.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T660.QTYINV ELSE QTYINV END,
                QTYSTAT = CASE VL_DES_T660('QTYSTAT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T660.QTYSTAT ELSE QTYSTAT END,
                NETAMOUNT = CASE VL_DES_T660('NETAMOUNT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T660.NETAMOUNT ELSE NETAMOUNT END,
                UMSTAT = CASE VL_DES_T660('UMSTAT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T660.UMSTAT ELSE UMSTAT END,
                CODCUR = CASE VL_DES_T660('CODCUR.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T660.CODCUR ELSE CODCUR END,
                UMDELIV = CASE VL_DES_T660('UMDELIV.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T660.UMDELIV ELSE UMDELIV END,
                GROSSAMOUNT = CASE VL_DES_T660('GROSSAMOUNT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T660.GROSSAMOUNT ELSE GROSSAMOUNT END,
                CHANGERATE = CASE VL_DES_T660('CHANGERATE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T660.CHANGERATE ELSE CHANGERATE END,
                QTYDELIV = CASE VL_DES_T660('QTYDELIV.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T660.QTYDELIV ELSE QTYDELIV END,
                DTECOMP = CASE VL_DES_T660('DTECOMP.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T660.DTECOMP ELSE DTECOMP END,
                AMOUNT1 = CASE VL_DES_T660('AMOUNT1.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T660.AMOUNT1 ELSE AMOUNT1 END,
                AMOUNT2 = CASE VL_DES_T660('AMOUNT2.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T660.AMOUNT2 ELSE AMOUNT2 END,
                AMOUNT3 = CASE VL_DES_T660('AMOUNT3.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T660.AMOUNT3 ELSE AMOUNT3 END,
                NETARTAMOUNT = CASE VL_DES_T660('NETARTAMOUNT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T660.NETARTAMOUNT ELSE NETARTAMOUNT END,
                AMOUNT4 = CASE VL_DES_T660('AMOUNT4.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T660.AMOUNT4 ELSE AMOUNT4 END,
                GROSSARTAMOUNT = CASE VL_DES_T660('GROSSARTAMOUNT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T660.GROSSARTAMOUNT ELSE GROSSARTAMOUNT END,
                AMOUNT5 = CASE VL_DES_T660('AMOUNT5.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T660.AMOUNT5 ELSE AMOUNT5 END,
                AMOUNT6 = CASE VL_DES_T660('AMOUNT6.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T660.AMOUNT6 ELSE AMOUNT6 END,
                AMOUNT7 = CASE VL_DES_T660('AMOUNT7.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T660.AMOUNT7 ELSE AMOUNT7 END,
                FLGANN = CASE VL_DES_T660('FLGANN.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T660.FLGANN ELSE FLGANN END,
                AMOUNT8 = CASE VL_DES_T660('AMOUNT8.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T660.AMOUNT8 ELSE AMOUNT8 END,
                AMOUNT9 = CASE VL_DES_T660('AMOUNT9.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T660.AMOUNT9 ELSE AMOUNT9 END,
                AMOUNT10 = CASE VL_DES_T660('AMOUNT10.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T660.AMOUNT10 ELSE AMOUNT10 END,
                IDBATCH = CASE VL_DES_T660('IDBATCH.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T660.IDBATCH ELSE IDBATCH END,
                QTYUM1 = CASE VL_DES_T660('QTYUM1.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T660.QTYUM1 ELSE QTYUM1 END,
                QTYUM2 = CASE VL_DES_T660('QTYUM2.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T660.QTYUM2 ELSE QTYUM2 END,
                QTYUM3 = CASE VL_DES_T660('QTYUM3.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T660.QTYUM3 ELSE QTYUM3 END,
                AMOUNT11 = CASE VL_DES_T660('AMOUNT11.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T660.AMOUNT11 ELSE AMOUNT11 END,
                AMOUNT12 = CASE VL_DES_T660('AMOUNT12.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T660.AMOUNT12 ELSE AMOUNT12 END,
                COD_AGENTE = CASE VL_DES_T660('COD_AGENTE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T660.COD_AGENTE ELSE COD_AGENTE END,
                COD_AREA_MANAGER = CASE VL_DES_T660('COD_AREA_MANAGER.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T660.COD_AREA_MANAGER ELSE COD_AREA_MANAGER END,
                CODDIVQUID = CASE VL_DES_T660('CODDIVQUID.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T660.CODDIVQUID ELSE CODDIVQUID END,
                CODUSRORIG = CASE VL_DES_T660('CODUSRORIG.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T660.CODUSRORIG ELSE CODUSRORIG END,
                NUMORDORIG = CASE VL_DES_T660('NUMORDORIG.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T660.NUMORDORIG ELSE NUMORDORIG END,
                NUMROWORIG = CASE VL_DES_T660('NUMROWORIG.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T660.NUMROWORIG ELSE NUMROWORIG END,
                CODCAT1 = CASE VL_DES_T660('CODCAT1.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T660.CODCAT1 ELSE CODCAT1 END,
                CODCAT2 = CASE VL_DES_T660('CODCAT2.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T660.CODCAT2 ELSE CODCAT2 END,
                CODCAT3 = CASE VL_DES_T660('CODCAT3.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T660.CODCAT3 ELSE CODCAT3 END,
                CODCAT4 = CASE VL_DES_T660('CODCAT4.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T660.CODCAT4 ELSE CODCAT4 END,
                CODCAT5 = CASE VL_DES_T660('CODCAT5.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T660.CODCAT5 ELSE CODCAT5 END,
                NUMORD1 = CASE VL_DES_T660('NUMORD1.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T660.NUMORD1 ELSE NUMORD1 END,
                NUMORD2 = CASE VL_DES_T660('NUMORD2.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T660.NUMORD2 ELSE NUMORD2 END,
                NUMORD3 = CASE VL_DES_T660('NUMORD3.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T660.NUMORD3 ELSE NUMORD3 END,
                NUMORD4 = CASE VL_DES_T660('NUMORD4.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T660.NUMORD4 ELSE NUMORD4 END,
                NUMORD5 = CASE VL_DES_T660('NUMORD5.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T660.NUMORD5 ELSE NUMORD5 END,
                --- Technical fields
                DTEMOD      = REC_T660.DTEMOD ,
                DOCUMENTKEY = REC_T660.DOCUMENTKEY

           WHERE NUMORD    = REC_T660.NUMORD
             AND CODDIV    = REC_T660.CODDIV
             AND CODTYPORD = REC_T660.CODTYPORD
             AND NUMROW    = REC_T660.NUMROW;

        END;

        VL_INS_T660 := VL_INS_T660 + 1;
        END IF; -- vl_status

        EXCEPTION WHEN OTHERS THEN
             VL_STATUS := -1;
             VL_MESSAGE_H := SUBSTR(VL_MESSAGE_H||' '||VL_MESSAGE_D||' '||dbms_utility.format_error_backtrace() || ' ' || SQLERRM,1,4000);

             PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                           VL_PROGR_D_T660,
                                           SQLCODE,
                                           VL_MESSAGE_H);

        END; -- HEAD T660

      -- if all records have been stored with success then it makes the commit
      IF VL_STATUS = 0 THEN
         COMMIT;
      ELSE
        ROLLBACK;

      UPDATE XIN_T660CONT_ATT
      SET  SM1_STATUS =  C_XINSTATUS_ERR
         WHERE NUMORD    = RL_XIN_T660.NUMORD
           AND CODDIV    = RL_XIN_T660.CODDIV
           AND CODTYPORD = RL_XIN_T660.CODTYPORD
           AND NUMROW    = RL_XIN_T660.NUMROW
           AND SM1_CODPROCESS = PI_PROGR_H
           AND SM1_DTECRE = RL_XIN_T660.SM1_DTECRE
           AND SM1_STATUS     = C_XINSTATUS_OK;
       VL_STATUS := 0;

       COMMIT;
      END IF;
    END LOOP;  -- T660CONT_ATT



    -- Moves records from staging area to log staging area
    P_XIN_MOVE_TO_LOG(PI_PROGR_H, VL_PROGR_D_T660,'T660CONT_ATT');

   -- Close Logs
    PKG_UTILS.LOG_END_DETAIL(PI_PROGR_H,
                             VL_PROGR_D_T660,
                             0,
                             VL_COUNT_XIN_T660,
                             VL_INS_T660,
                             VL_COUNT_XIN_T660 - VL_INS_T660);


    PO_MSG    := VL_INS_T660||'/'||VL_COUNT_XIN_T660||' Active Invoices loaded';
    PO_STATUS := VL_INS_T660;


    --
  EXCEPTION WHEN EX_EXIT THEN

          ROLLBACK;

          VL_MESSAGE_H       := VL_MESSAGE_H || TRIM(SUBSTR(dbms_utility.format_error_backtrace() || ' ' || SQLERRM, 1, 255));
          PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                         VL_PROGR_D_T660,
                                         SQLCODE,
                                         VL_MESSAGE_H);

          PO_MSG := VL_MESSAGE_H;
          PO_STATUS := -1;

   WHEN OTHERS THEN

          ROLLBACK;
          -- Moves records from staging area to log staging area
          P_XIN_MOVE_TO_LOG(PI_PROGR_H, VL_PROGR_D_T660,'T660CONT_ATT');

          VL_MESSAGE_H       := VL_MESSAGE_H || TRIM(SUBSTR(dbms_utility.format_error_backtrace() || ' ' || SQLERRM, 1, 255));
          PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                         VL_PROGR_D_T660,
                                         SQLCODE,
                                         VL_MESSAGE_H);

          PO_MSG := VL_MESSAGE_H;
          PO_STATUS := VL_STATUS;

  END LOAD_T660_INVOICES;



  /*============================================================================*\
  /* Name: LOAD_T661_REAL
    Loads SM1 tables
      • T661REAL Projected / Real invoices
      Staging Area (SSA) tables
      • XIN_ T661REAL

      Loading logic:
      UPDATE + INSERT record is deleted and reinserted

      Validity Checks:
      • No checks while loading. The existence of Invoice Customer, Delivery customer and article will be checked after the loading as a warning.

      Error handling:
      • All Errors will be logged in T852/T854 SM1 log tables and all staging area records will be stored into staging area log with sm1_status = 9.
      • Error on record,  it is discarded and import skip to next record to be loaded

      How to delete a record : you cannot delete records in T660CONT_ATT by integration host.
      set T661.FLGANN to -1

     Input parameters :     PI_PROGR_H - unique sm1 job number ( T800SYSTEMACTIVITYLOG )
                            PI_SESSION_ID    - unique login session (T035LOGGEDUSERS)
     Outputparameters :     PO_MSG           - message of error if procedure exit with error
                            PO_STATUS        - 0 OK; -1 Error
     Author : Mariangela Bandiera
     Creation Date : 4 April 2014
     ----
     Updates :


    ============================================================================ */

   PROCEDURE LOAD_T661_REAL( PI_PROGR_H       IN NUMBER,
                             PI_SESSION_ID    IN NUMBER,
                             PO_MSG           OUT NOCOPY VARCHAR2,
                             PO_STATUS        OUT NOCOPY NUMBER ) IS

    -- -----------------------------------------
    -- Cursor on Projected Invoices table T661REAL
    -- -----------------------------------------
    CURSOR CL_XIN_T661 IS
      SELECT
        *
        FROM  XIN_T661REAL
        WHERE SM1_CODPROCESS = PI_PROGR_H
        ORDER BY SM1_DTECRE;

    --
    VL_MESSAGE_H   VARCHAR2(4000) := 'Error while loading Projected Invoices T661';
    VL_MESSAGE_D   VARCHAR2(4000) := NULL;
    --
    VL_PROGR_D_T661    NUMBER := 0;
    VL_COUNT_XIN_T661  NUMBER := 0;
    VL_INS_T661        NUMBER := 0;
    --
    REC_T661 T661REAL%ROWTYPE    := NULL;
    REC_T661_INIT T661REAL%ROWTYPE    := NULL;
    --
    VL_DES_T661     X_FIELD_INFO_ARRAY;-- Array with fields db info
    --
    VL_STATUS NUMBER:= 0;
    --VL_COUNT  NUMBER:= 0;
    --
    EX_EXIT  EXCEPTION;
    --
    VL_STEP   NUMBER:= 0; -- Used to ping t035
    VL_CODDIV VARCHAR2(30) := NULL;

  BEGIN
      -- init indexes and rebuild statistics
    P_XIN_INIT_INDEXES (PI_PROGR_H, 'T661REAL');
    -- clean loG
    P_XIN_CLEANUP_LOG (PI_PROGR_H, 'T661REAL');
    --
    VL_PROGR_D_T661 := PKG_UTILS.LOG_NEW_DETAIL(PI_PROGR_H,
                                                'PROJ INVOICES',
                                                'IMPORT --> T661REAL',
                                                 0,
                                                 NULL);



    BEGIN
        --
        -- ----------------------------------------------------------
        -- Init arrays with FIELD_NAME=LENGTH and FIELDNAME=SM1_DEFAULT for all fields of table
        -- ----------------------------------------------------------
      VL_DES_T661.DELETE;
      P_INIT_SM1_FIELD_ARRAY ('T661REAL',VL_DES_T661,VL_STATUS, VL_MESSAGE_H);
      execute immediate ( GL_INIT_REC) INTO REC_T661_INIT;

        IF (VL_STATUS <> 0 ) THEN
            VL_MESSAGE_D := GL_INIT_REC;
            RAISE EX_EXIT;
        END IF;
    EXCEPTION WHEN OTHERS THEN
        VL_MESSAGE_D := GL_INIT_REC;
        RAISE EX_EXIT;
    END;


    -- --------------------------------------------------------------
    -- Identifies Xin records to be loaded
    -- --------------------------------------------------------------
    BEGIN
        VL_MESSAGE_D := 'XIN_T661REAL';
        UPDATE XIN_T661REAL
        SET SM1_CODPROCESS = PI_PROGR_H,
            SM1_STATUS = 0,
            SM1_DTEPROCESS = XSYSDATE
            WHERE SM1_CODPROCESS = C_SM1_NULL_CODPROCESS;

        VL_COUNT_XIN_T661 := SQL%ROWCOUNT;

    COMMIT;
    EXCEPTION WHEN OTHERS THEN
      ROLLBACK;
      VL_MESSAGE_H := 'Error while Reading Staging area: '||VL_MESSAGE_D;
      RAISE EX_EXIT;

    END;
    -- --------------------------------------------------------------
    -- loop in main table T661REAL
    -- --------------------------------------------------------------
    FOR RL_XIN_T661 IN CL_XIN_T661 LOOP
      -- pings to t035 every 1000 cicles--
      VL_STEP := VL_STEP + 1;
      IF ( MOD(VL_STEP, 1000) = 0 ) THEN
         PKG_UTILS.user_ping(PI_SESSION_ID);
      END IF;

      --
      VL_STATUS := 0;

      VL_MESSAGE_H :=   'Customer : '||RL_XIN_T661.CODCUST||' '||
                        'Article : ' ||RL_XIN_T661.CODART||' '||
                        'Typrow : '  ||RL_XIN_T661.TYPROW||' '||
                        'DteComp : ' ||RL_XIN_T661.DTECOMP||' '||
                        'Division : '||RL_XIN_T661.CODDIV;
      --
      BEGIN --- HEAD T661

       -- Data Format Check
        VL_MESSAGE_D := 'Format Conversion ';
        VL_CODDIV:= RL_XIN_T661.CODDIV;
        REC_T661.CODDIV := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T661.CODDIV,'CODDIV', VL_DES_T661,VL_STATUS, VL_MESSAGE_D);
        REC_T661.PROJTYPE := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T661.PROJTYPE,'PROJTYPE', VL_DES_T661,VL_STATUS, VL_MESSAGE_D);
        REC_T661.CODCUST := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T661.CODCUST,'CODCUST', VL_DES_T661,VL_STATUS, VL_MESSAGE_D);
        REC_T661.LEVCUST := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_T661.LEVCUST,'LEVCUST', VL_DES_T661,VL_STATUS, VL_MESSAGE_D);
        REC_T661.CODART := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T661.CODART,'CODART', VL_DES_T661,VL_STATUS, VL_MESSAGE_D);
        REC_T661.ARTLEV := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T661.ARTLEV,'ARTLEV', VL_DES_T661,VL_STATUS, VL_MESSAGE_D);
        REC_T661.DTECOMP := F_CHECK_FORMAT_D( VL_CODDIV,   RL_XIN_T661.DTECOMP,'DTECOMP', VL_DES_T661,VL_STATUS, VL_MESSAGE_D);
        REC_T661.TYPROW := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_T661.TYPROW,'TYPROW', VL_DES_T661,VL_STATUS, VL_MESSAGE_D);
        REC_T661.QTYINV := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T661.QTYINV,'QTYINV', VL_DES_T661,VL_STATUS, VL_MESSAGE_D);
        REC_T661.QTYDELIV := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T661.QTYDELIV,'QTYDELIV', VL_DES_T661,VL_STATUS, VL_MESSAGE_D);
        REC_T661.QTYSTAT := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T661.QTYSTAT,'QTYSTAT', VL_DES_T661,VL_STATUS, VL_MESSAGE_D);
        REC_T661.QTYUM1 := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T661.QTYUM1,'QTYUM1', VL_DES_T661,VL_STATUS, VL_MESSAGE_D);
        REC_T661.QTYUM2 := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T661.QTYUM2,'QTYUM2', VL_DES_T661,VL_STATUS, VL_MESSAGE_D);
        REC_T661.QTYUM3 := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T661.QTYUM3,'QTYUM3', VL_DES_T661,VL_STATUS, VL_MESSAGE_D);
        REC_T661.NETAMOUNT := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T661.NETAMOUNT,'NETAMOUNT', VL_DES_T661,VL_STATUS, VL_MESSAGE_D);
        REC_T661.GROSSAMOUNT := F_CHECK_FORMAT_N(  VL_CODDIV, RL_XIN_T661.GROSSAMOUNT,'GROSSAMOUNT', VL_DES_T661,VL_STATUS, VL_MESSAGE_D);
        REC_T661.AMOUNT1 := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T661.AMOUNT1,'AMOUNT1', VL_DES_T661,VL_STATUS, VL_MESSAGE_D);
        REC_T661.AMOUNT2 := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T661.AMOUNT2,'AMOUNT2', VL_DES_T661,VL_STATUS, VL_MESSAGE_D);
        REC_T661.AMOUNT3 := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T661.AMOUNT3,'AMOUNT3', VL_DES_T661,VL_STATUS, VL_MESSAGE_D);
        REC_T661.AMOUNT4 := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T661.AMOUNT4,'AMOUNT4', VL_DES_T661,VL_STATUS, VL_MESSAGE_D);
        REC_T661.AMOUNT5 := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T661.AMOUNT5,'AMOUNT5', VL_DES_T661,VL_STATUS, VL_MESSAGE_D);
        REC_T661.AMOUNT6 := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T661.AMOUNT6,'AMOUNT6', VL_DES_T661,VL_STATUS, VL_MESSAGE_D);
        REC_T661.AMOUNT7 := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T661.AMOUNT7,'AMOUNT7', VL_DES_T661,VL_STATUS, VL_MESSAGE_D);
        REC_T661.AMOUNT8 := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T661.AMOUNT8,'AMOUNT8', VL_DES_T661,VL_STATUS, VL_MESSAGE_D);
        REC_T661.AMOUNT9 := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T661.AMOUNT9,'AMOUNT9', VL_DES_T661,VL_STATUS, VL_MESSAGE_D);
        REC_T661.AMOUNT10 := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T661.AMOUNT10,'AMOUNT10', VL_DES_T661,VL_STATUS, VL_MESSAGE_D);
        REC_T661.FLGANN := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_T661.FLGANN,'FLGANN', VL_DES_T661,VL_STATUS, VL_MESSAGE_D);
        --
        REC_T661.FLGMAT := 0;
        REC_T661.FLGPMAT :=0;
        REC_T661.FLG_VIRTUAL_INVOICE := 0;
        REC_T661.ALGO_GENERATE :=0;

        --- Technical fields
        REC_T661.DTEMOD     := XSYSDATE;
        REC_T661.DTECRE     := XSYSDATE;

        -- It does not control the existence of customer and articles because it is better to have all invoices loaded an after check the existence as a warning

        IF (VL_STATUS <> 0 ) THEN

             VL_MESSAGE_H := SUBSTR(VL_MESSAGE_H||' '||VL_MESSAGE_D||' '||dbms_utility.format_error_backtrace() || ' ' || SQLERRM,1,4000);

             PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                           VL_PROGR_D_T661,
                                           SQLCODE,
                                           VL_MESSAGE_H);
        END IF;


        IF (VL_STATUS = 0 ) THEN
          -- when status <> 0 some fields have incorrect format. Log t800 has been already wrote by F_CHECK function
          -- Update article if already exists

           VL_MESSAGE_D := 'Update T661REAL ';
           UPDATE T661REAL
           SET
               -- when the field si set to updated by host it means that the value should be read from XIN
               -- otherwise it means that the field is managed by sm1 and it maintains its original value
              QTYINV = CASE VL_DES_T661('QTYINV.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T661.QTYINV ELSE QTYINV END,
              QTYDELIV = CASE VL_DES_T661('QTYDELIV.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T661.QTYDELIV ELSE QTYDELIV END,
              QTYSTAT = CASE VL_DES_T661('QTYSTAT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T661.QTYSTAT ELSE QTYSTAT END,
              QTYUM1 = CASE VL_DES_T661('QTYUM1.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T661.QTYUM1 ELSE QTYUM1 END,
              QTYUM2 = CASE VL_DES_T661('QTYUM2.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T661.QTYUM2 ELSE QTYUM2 END,
              QTYUM3 = CASE VL_DES_T661('QTYUM3.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T661.QTYUM3 ELSE QTYUM3 END,
              NETAMOUNT = CASE VL_DES_T661('NETAMOUNT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T661.NETAMOUNT ELSE NETAMOUNT END,
              GROSSAMOUNT = CASE VL_DES_T661('GROSSAMOUNT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T661.GROSSAMOUNT ELSE GROSSAMOUNT END,
              AMOUNT1 = CASE VL_DES_T661('AMOUNT1.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T661.AMOUNT1 ELSE AMOUNT1 END,
              AMOUNT2 = CASE VL_DES_T661('AMOUNT2.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T661.AMOUNT2 ELSE AMOUNT2 END,
              AMOUNT3 = CASE VL_DES_T661('AMOUNT3.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T661.AMOUNT3 ELSE AMOUNT3 END,
              AMOUNT4 = CASE VL_DES_T661('AMOUNT4.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T661.AMOUNT4 ELSE AMOUNT4 END,
              AMOUNT5 = CASE VL_DES_T661('AMOUNT5.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T661.AMOUNT5 ELSE AMOUNT5 END,
              AMOUNT6 = CASE VL_DES_T661('AMOUNT6.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T661.AMOUNT6 ELSE AMOUNT6 END,
              AMOUNT7 = CASE VL_DES_T661('AMOUNT7.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T661.AMOUNT7 ELSE AMOUNT7 END,
              AMOUNT8 = CASE VL_DES_T661('AMOUNT8.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T661.AMOUNT8 ELSE AMOUNT8 END,
              AMOUNT9 = CASE VL_DES_T661('AMOUNT9.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T661.AMOUNT9 ELSE AMOUNT9 END,
              AMOUNT10 = CASE VL_DES_T661('AMOUNT10.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T661.AMOUNT10 ELSE AMOUNT10 END,
              FLGANN  = CASE VL_DES_T661('FLGANN.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_T661.FLGANN ELSE FLGANN END,
              --- Technical fields
              DTEMOD      = REC_T661.DTEMOD

         WHERE CODDIV    = REC_T661.CODDIV
           AND PROJTYPE  = REC_T661.PROJTYPE
           AND CODCUST   = REC_T661.CODCUST
           AND LEVCUST   = REC_T661.LEVCUST
           AND CODART    = REC_T661.CODART
           AND ARTLEV    = REC_T661.ARTLEV
           AND DTECOMP   = REC_T661.DTECOMP
           AND TYPROW    = REC_T661.TYPROW;

        -- no data found, it could be
        --   a. record does not exists

        IF SQL%ROWCOUNT = 0 THEN

              VL_MESSAGE_D := 'Insert T661REAL ';
              -- Record does not exists, we insert it
              INSERT INTO T661REAL VALUES REC_T661;
                 --

        END IF; -- Record has been updated
          VL_INS_T661 := VL_INS_T661 + 1;
        END IF; -- vl_status

        EXCEPTION WHEN OTHERS THEN
             VL_STATUS := -1;
             VL_MESSAGE_H := SUBSTR(VL_MESSAGE_H||' '||VL_MESSAGE_D||' '||dbms_utility.format_error_backtrace() || ' ' || SQLERRM,1,4000);

             PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                           VL_PROGR_D_T661,
                                           SQLCODE,
                                           VL_MESSAGE_H);

        END; -- HEAD T661

      -- if all records have been stored with success then it makes the commit
      IF VL_STATUS = 0 THEN
         COMMIT;
      ELSE
        ROLLBACK;

      UPDATE XIN_T661REAL
      SET  SM1_STATUS =  C_XINSTATUS_ERR
         WHERE CODDIV    = RL_XIN_T661.CODDIV
           AND PROJTYPE  = RL_XIN_T661.PROJTYPE
           AND CODCUST   = RL_XIN_T661.CODCUST
           AND LEVCUST   = RL_XIN_T661.LEVCUST
           AND CODART    = RL_XIN_T661.CODART
           AND ARTLEV    = RL_XIN_T661.ARTLEV
           AND DTECOMP   = RL_XIN_T661.DTECOMP
           AND TYPROW    = RL_XIN_T661.TYPROW
           AND SM1_CODPROCESS = PI_PROGR_H
           AND SM1_DTECRE = RL_XIN_T661.SM1_DTECRE
           AND SM1_STATUS     = C_XINSTATUS_OK;
       VL_STATUS := 0;

       COMMIT;
      END IF;
    END LOOP;  -- T661REAL



    -- Moves records from staging area to log staging area
    P_XIN_MOVE_TO_LOG(PI_PROGR_H, VL_PROGR_D_T661,'T661REAL');

   -- Close Logs
    PKG_UTILS.LOG_END_DETAIL(PI_PROGR_H,
                             VL_PROGR_D_T661,
                             0,
                             VL_COUNT_XIN_T661,
                             VL_INS_T661,
                             VL_COUNT_XIN_T661 - VL_INS_T661);


    PO_MSG    := VL_INS_T661||'/'||VL_COUNT_XIN_T661||' Projected Invoices loaded';
    PO_STATUS := VL_INS_T661;


    --
  EXCEPTION WHEN EX_EXIT THEN

          ROLLBACK;

          VL_MESSAGE_H       := VL_MESSAGE_H || TRIM(SUBSTR(dbms_utility.format_error_backtrace() || ' ' || SQLERRM, 1, 255));
          PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                         VL_PROGR_D_T661,
                                         SQLCODE,
                                         VL_MESSAGE_H);

          PO_MSG := VL_MESSAGE_H;
          PO_STATUS := -1;

   WHEN OTHERS THEN

          ROLLBACK;
          -- Moves records from staging area to log staging area
          P_XIN_MOVE_TO_LOG(PI_PROGR_H, VL_PROGR_D_T661,'T661REAL');

          VL_MESSAGE_H       := VL_MESSAGE_H || TRIM(SUBSTR(dbms_utility.format_error_backtrace() || ' ' || SQLERRM, 1, 255));
          PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                         VL_PROGR_D_T661,
                                         SQLCODE,
                                         VL_MESSAGE_H);

          PO_MSG := VL_MESSAGE_H;
          PO_STATUS := VL_STATUS;

  END LOAD_T661_REAL;
 /*============================================================================*\
  /* Name:  TA1110_PDV_PDC
    Loads SM1 tables:
      • TA1110PDV_PDC  Multiple (N-M) PoS - delivery customer association table.
      Staging Area (SSA) tables:
      • XIN_ TA1110PDV_PDC

      Loading logic: all links grouped by CODPARTY, CODDIV are loaded with An UPDATE+INSERT logic. Links present in SM1 and no more loaded from ERP will be set to “no more valid status” (TA1110PDV_PDC.FLGANN=-1).

      Validity Checks:
      • Record found on  XIN_TA1110PDV_PDC  is loaded only if there is the head record in T040PARTY for both sale point and delivery point.

      Error handling:
      • All Errors will be logged in T852/T854 SM1 log tables and all staging area records will be stored into staging area log with sm1_status = 9.
      • Error on record,  it is discarded with all records with same sale point and division (CODPARTY,CODDIV).

      How to delete a record: links can be logically deleted by setting field XIN_TA1110PDV_PDC.FLGANN=-1.

      How to close a link: set field XIN_TA1110PDV_PDC.DTETO.

     Input parameters :     PI_PROGR_H - unique sm1 job number ( T800SYSTEMACTIVITYLOG )
                            PI_SESSION_ID    - unique login session (T035LOGGEDUSERS)
     Outputparameters :     PO_MSG           - message of error if procedure exit with error
                            PO_STATUS        - 0 OK; -1 Error


     Author : Mariangela Bandiera
     Creation Date : 14 September 2012
     ----
     Updates :


    ============================================================================ */

   PROCEDURE LOAD_TA1110_PDV_PDC(PI_PROGR_H   IN NUMBER,
                         PI_SESSION_ID        IN NUMBER,
                         PO_MSG               OUT NOCOPY VARCHAR2,
                         PO_STATUS            OUT NOCOPY NUMBER ) IS

    -- -----------------------------------------
    -- Cursor on Customer Credit table TA1110PARTYAMOUNT
    -- -----------------------------------------
    CURSOR CL_XIN_TA1110 IS
      SELECT
       *
        FROM  XIN_TA1110PDV_PDC
        WHERE SM1_CODPROCESS = PI_PROGR_H
        --IT ASSUMES THAT THE SET CODPARTY, CODDIV HAVE ALWAYS THE SAME SM1_DTECRE
        ORDER BY CODPARTY, CODDIV, SM1_DTECRE;

    --
    VL_MESSAGE_H   VARCHAR2(4000) := 'Error while loading Delivery Point -Sales Point Link TA1110';
    VL_MESSAGE_D   VARCHAR2(4000) := NULL;
    --
    VL_PROGR_D_TA1110    NUMBER := 0;
    VL_COUNT_XIN_TA1110  NUMBER := 0;
    VL_INS_TA1110        NUMBER := 0;
    VL_INS               NUMBER := 0;
    --
    REC_TA1110 TA1110PDV_PDC%ROWTYPE    := NULL;
    REC_TA1110_INIT TA1110PDV_PDC%ROWTYPE    := NULL;
    --
    RL_XIN_TA1110_PREV CL_XIN_TA1110%ROWTYPE;
    --
    VL_DES_TA1110     X_FIELD_INFO_ARRAY;-- Array with fields db info
    --
    VL_RECORD_LOCKED NUMBER := 0;

    VL_STATUS NUMBER:= 0;
    VL_COUNT  NUMBER:= 0;
    VL_FLG_NEW_SET NUMBER:= 0; -- Used to identify se set CODPARTY/CODDIV
    VL_STEP   NUMBER:= 0; -- Used to ping t035
    --
    EX_EXIT  EXCEPTION;
    --
    VL_CODDIV VARCHAR2(30) := NULL;

  BEGIN

    -- init indexes and rebuild statistics
    P_XIN_INIT_INDEXES (PI_PROGR_H, 'TA1110PDV_PDC');
    -- clean loG

    P_XIN_CLEANUP_LOG (PI_PROGR_H, 'TA1110PDV_PDC');
    --

    VL_PROGR_D_TA1110 := PKG_UTILS.LOG_NEW_DETAIL(PI_PROGR_H,
                                       'PDV PDC LINK',
                                       'IMPORT --> TA1110PDV_PDC',
                                        0,
                                        NULL);




    BEGIN
        --
        -- ----------------------------------------------------------
        -- Init arrays with FIELD_NAME=LENGTH and FIELDNAME=SM1_DEFAULT for all fields of table
        -- ----------------------------------------------------------
       VL_DES_TA1110.DELETE;
       P_INIT_SM1_FIELD_ARRAY ('TA1110PDV_PDC',VL_DES_TA1110,VL_STATUS, VL_MESSAGE_H);
       execute immediate ( GL_INIT_REC) INTO REC_TA1110_INIT;

        IF (VL_STATUS <> 0 ) THEN
            VL_MESSAGE_D := GL_INIT_REC;
            RAISE EX_EXIT;
        END IF;
    EXCEPTION WHEN OTHERS THEN
        VL_MESSAGE_D := GL_INIT_REC;
        RAISE EX_EXIT;
    END;


    -- --------------------------------------------------------------
    -- Identifies Xin records to be loaded
    -- --------------------------------------------------------------
    BEGIN
        VL_MESSAGE_D := 'XIN_TA1110PDV_PDC';
        UPDATE XIN_TA1110PDV_PDC
        SET SM1_CODPROCESS = PI_PROGR_H,
            SM1_STATUS = 0,
            SM1_DTEPROCESS = XSYSDATE
            WHERE SM1_CODPROCESS = C_SM1_NULL_CODPROCESS;

        VL_COUNT_XIN_TA1110 := SQL%ROWCOUNT;

    COMMIT;
    EXCEPTION WHEN OTHERS THEN
      ROLLBACK;
      VL_MESSAGE_H := 'Error while Reading Staging area: '||VL_MESSAGE_D;
      RAISE EX_EXIT;

    END;
    -- --------------------------------------------------------------
    -- loop in main table TA1110PDV_PDC
    -- --------------------------------------------------------------
    FOR RL_XIN_TA1110 IN CL_XIN_TA1110 LOOP
        -- pings to t035 every 1000 cicles--
      VL_STEP := VL_STEP + 1;
      IF ( MOD(VL_STEP, 1000) = 0 ) THEN
         PKG_UTILS.user_ping(PI_SESSION_ID);
      END IF;

        --- Commit or Rollback of prev Decode set
        --    IT ASSUMES THAT THE SET CODPARTY, CODDIV HAVE ALWAYS THE SAME SM1_DTECRE
        IF ( NVL( RL_XIN_TA1110_PREV.CODPARTY, '@')     <>  RL_XIN_TA1110.CODPARTY  OR
             NVL( RL_XIN_TA1110_PREV.CODDIV  , '@')     <>  RL_XIN_TA1110.CODDIV  )

        THEN

          VL_FLG_NEW_SET := -1;
          IF ( VL_STATUS = 0 AND NVL(RL_XIN_TA1110_PREV.CODPARTY,'@') <> '@' ) THEN
            VL_INS_TA1110 := VL_INS_TA1110 + VL_INS;
            COMMIT;
          ELSIF VL_STATUS <> 0 THEN
            ROLLBACK;
          END IF;
          VL_INS := 0;

          UPDATE XIN_TA1110PDV_PDC
          SET  SM1_STATUS = CASE WHEN VL_STATUS = 0          THEN C_XINSTATUS_OK
                              WHEN VL_RECORD_LOCKED <> 0  THEN C_XINSTATUS_LOCK
                              ELSE C_XINSTATUS_ERR END
          WHERE CODPARTY = RL_XIN_TA1110_PREV.CODPARTY
           AND  CODDIV = RL_XIN_TA1110_PREV.CODDIV
           AND  SM1_CODPROCESS = PI_PROGR_H
           AND  SM1_DTECRE  = RL_XIN_TA1110_PREV.SM1_DTECRE
           AND  SM1_STATUS  = C_XINSTATUS_OK;


          COMMIT;
          VL_STATUS := 0;


        ELSE
          VL_FLG_NEW_SET := 0;
        END IF;



      --
      VL_MESSAGE_H :=   'Sales Point : '   ||RL_XIN_TA1110.CODPARTY||'/'||
                        'Delivery Point : '||RL_XIN_TA1110.CODCUSTDELIV||'/'||
                        'Division: '       ||RL_XIN_TA1110.CODDIV;
      --
      BEGIN --- HEAD TA1110

       -- Data Format Check
        VL_MESSAGE_D := 'Format Conversion ';
        VL_CODDIV:= RL_XIN_TA1110.CODDIV;
        REC_TA1110.CODPARTY     := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_TA1110.CODPARTY,'CODPARTY', VL_DES_TA1110,VL_STATUS, VL_MESSAGE_D);
        REC_TA1110.CODCUSTDELIV := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_TA1110.CODCUSTDELIV,'CODCUSTDELIV', VL_DES_TA1110,VL_STATUS, VL_MESSAGE_D);
        REC_TA1110.CODDIV       := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_TA1110.CODDIV,'CODDIV', VL_DES_TA1110,VL_STATUS, VL_MESSAGE_D);
        REC_TA1110.DTEFROM      := F_CHECK_FORMAT_D( VL_CODDIV, RL_XIN_TA1110.DTEFROM,'DTEFROM', VL_DES_TA1110,VL_STATUS, VL_MESSAGE_D);
        REC_TA1110.DTETO        := F_CHECK_FORMAT_D( VL_CODDIV, RL_XIN_TA1110.DTETO,'DTETO', VL_DES_TA1110,VL_STATUS, VL_MESSAGE_D);
        REC_TA1110.FLGPRIMARY   := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_TA1110.FLGPRIMARY,'FLGPRIMARY', VL_DES_TA1110,VL_STATUS, VL_MESSAGE_D);
        REC_TA1110.FLGANN       := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_TA1110.FLGANN,'FLGANN', VL_DES_TA1110,VL_STATUS, VL_MESSAGE_D);
        REC_TA1110.DESNOTE      := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_TA1110.DESNOTE,'DESNOTE', VL_DES_TA1110,VL_STATUS, VL_MESSAGE_D);
        --- Technical fields
        REC_TA1110.DTECRE     := XSYSDATE;
        REC_TA1110.CODUSRMOD  := C_SYSUSR;
        REC_TA1110.DTEMOD     := XSYSDATE;
        -- lock fields
        REC_TA1110.CODUSRLCK     := C_SYSUSR;
        REC_TA1110.IDSESSIONLCK  := PI_SESSION_ID;
        REC_TA1110.DTELCK        := XSYSDATE;

        -- SET ALL links to flagann = -1 in order to leave them to flgann=-1 when no more loaded from erp
        IF ( VL_FLG_NEW_SET <> 0 ) THEN
        UPDATE TA1110PDV_PDC SET FLGANN = -1, DTEMOD = REC_TA1110.DTEMOD , CODUSRMOD = REC_TA1110.CODUSRMOD WHERE CODPARTY =REC_TA1110.CODPARTY AND CODDIV =  REC_TA1110.CODDIV;
          VL_FLG_NEW_SET := 0;
        END IF;


        -- Check Sale Point and Delivery Point Existence
        VL_COUNT := 0;
        select count(*) into VL_COUNT from T041PARTYDIV WHERE CODPARTY = REC_TA1110.CODPARTY AND CODDIV = REC_TA1110.CODDIV ;

        IF VL_COUNT = 0 THEN
           VL_MESSAGE_D := 'Sales Point does not exist  ';
           VL_STATUS := -1;
        END IF;
         -- Check Sale Point and Delivery Point Existence
        VL_COUNT := 0;
        select count(*) into VL_COUNT from T041PARTYDIV WHERE CODPARTY = REC_TA1110.CODCUSTDELIV AND CODDIV = REC_TA1110.CODDIV ;

        IF VL_COUNT = 0 THEN
           VL_MESSAGE_D := 'Delivery Point does not exist  ';
           VL_STATUS := -1;
        END IF;

        IF (VL_STATUS <> 0 ) THEN

             VL_MESSAGE_H := SUBSTR(VL_MESSAGE_H||' '||VL_MESSAGE_D||' '||dbms_utility.format_error_backtrace() || ' ' || SQLERRM,1,4000);

             PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                           VL_PROGR_D_TA1110,
                                           SQLCODE,
                                           VL_MESSAGE_H);
        END IF;


        IF (VL_STATUS = 0 ) THEN
          -- when status <> 0 some fields have incorrect format. Log t800 has been already wrote by F_CHECK function
          -- Update article if already exists

           VL_MESSAGE_D := 'Update TA1110PDV_PDC ';
           UPDATE TA1110PDV_PDC
           SET
               -- when the field si set to updated by host it means that the value should be read from XIN
               -- otherwise it means that the field is managed by sm1 and it maintains its original value
               DTETO = CASE VL_DES_TA1110('DTETO.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA1110.DTETO ELSE DTETO END,
               FLGPRIMARY = CASE VL_DES_TA1110('FLGPRIMARY.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA1110.FLGPRIMARY ELSE FLGPRIMARY END,
               FLGANN = CASE VL_DES_TA1110('FLGANN.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA1110.FLGANN ELSE FLGANN END,
               DESNOTE = CASE VL_DES_TA1110('DESNOTE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA1110.DESNOTE ELSE DESNOTE END,
               --- Technical fields
               CODUSRMOD = REC_TA1110.CODUSRMOD,
               DTEMOD    = REC_TA1110.DTEMOD,
               -- lock fields
               CODUSRLCK    = REC_TA1110.CODUSRLCK,
               IDSESSIONLCK = REC_TA1110.IDSESSIONLCK,
               DTELCK       = REC_TA1110.DTELCK

         WHERE CODPARTY     = REC_TA1110.CODPARTY
           AND CODDIV       = REC_TA1110.CODDIV
           AND CODCUSTDELIV = REC_TA1110.CODCUSTDELIV
           AND DTEFROM      = REC_TA1110.DTEFROM
           and not exists ( select null from T035LOGGEDUSERS T035 where T035.IDSESSION = NVL(IDSESSIONLCK, '@') AND T035.LASTCHECK > TRUNC(XSYSDATE)-1 );


        -- no data found, it could be
        --   a. record does not exists
        --   b. record is locked by another sm1 user

        IF SQL%ROWCOUNT = 0 THEN


           VL_COUNT := 0;
          SELECT COUNT(*) INTO VL_COUNT FROM TA1110PDV_PDC
           WHERE CODPARTY     = REC_TA1110.CODPARTY
             AND CODDIV       = REC_TA1110.CODDIV
             AND CODCUSTDELIV = REC_TA1110.CODCUSTDELIV
             AND DTEFROM      = REC_TA1110.DTEFROM;


          IF ( VL_COUNT = 0 ) THEN

              VL_MESSAGE_D := 'Insert TA1110PDV_PDC ';
              -- Record does not exists, we insert it
              INSERT INTO TA1110PDV_PDC VALUES REC_TA1110;

               --
               VL_INS_TA1110 := VL_INS_TA1110 + 1;

           ELSE
            VL_STATUS := -1;
            VL_RECORD_LOCKED := -1;
            PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                           VL_PROGR_D_TA1110,
                                           SQLCODE,
                                           'Record is locked; import has failed :'||VL_MESSAGE_H);

          END IF; -- Record has been inserted
        ELSE
          VL_INS := VL_INS + 1;
        END IF; -- Record has been updated
        END IF; -- VL_STATUS = 0


        EXCEPTION WHEN OTHERS THEN
             VL_STATUS := -1;
             VL_MESSAGE_H := SUBSTR(VL_MESSAGE_H||' '||VL_MESSAGE_D||' '||dbms_utility.format_error_backtrace() || ' ' || SQLERRM,1,4000);

             PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                           VL_PROGR_D_TA1110,
                                           SQLCODE,
                                           VL_MESSAGE_H);

        END; -- HEAD TA1110


        -- Release updated records
        UPDATE TA1110PDV_PDC
        SET       DTELCK          = NULL,
                  IDSESSIONLCK    = NULL,
                  CODUSRLCK       = NULL
        WHERE CODPARTY = REC_TA1110.CODPARTY
         AND  CODDIV   = REC_TA1110.CODDIV
         AND  CODCUSTDELIV = REC_TA1110.CODCUSTDELIV
         AND  DTEFROM      = REC_TA1110.DTEFROM
         AND  CODUSRLCK = C_SYSUSR AND IDSESSIONLCK = PI_SESSION_ID;


       RL_XIN_TA1110_PREV := RL_XIN_TA1110;
    END LOOP;  -- TA1110PDV_PDC
      --- Commit or Rollback of prev Decode set

      IF ( VL_STATUS = 0 AND NVL(RL_XIN_TA1110_PREV.CODPARTY,'@') <> '@' ) THEN
        VL_INS_TA1110 := VL_INS_TA1110 + VL_INS;
        COMMIT;
      ELSIF VL_STATUS <> 0  THEN
        ROLLBACK;
          UPDATE XIN_TA1110PDV_PDC
          SET  SM1_STATUS = CASE
                              WHEN VL_RECORD_LOCKED <> 0  THEN C_XINSTATUS_LOCK
                              ELSE C_XINSTATUS_ERR END
          WHERE CODPARTY = RL_XIN_TA1110_PREV.CODPARTY
           AND  CODDIV = RL_XIN_TA1110_PREV.CODDIV
           AND  SM1_CODPROCESS = PI_PROGR_H
           AND  SM1_DTECRE  = RL_XIN_TA1110_PREV.SM1_DTECRE
           AND  SM1_STATUS  = C_XINSTATUS_OK;


          COMMIT;
      END IF;




    -- Moves records from staging area to log staging area
    P_XIN_MOVE_TO_LOG(PI_PROGR_H, VL_PROGR_D_TA1110,'TA1110PDV_PDC');

   -- Close Logs
    PKG_UTILS.LOG_END_DETAIL(PI_PROGR_H,
                             VL_PROGR_D_TA1110,
                             0,
                             VL_COUNT_XIN_TA1110,
                             VL_INS_TA1110,
                             VL_COUNT_XIN_TA1110 - VL_INS_TA1110);


    PO_MSG    := VL_INS_TA1110||'/'||VL_COUNT_XIN_TA1110||' PDV-PDC links loaded';
    PO_STATUS := VL_INS_TA1110;


    --
  EXCEPTION WHEN EX_EXIT THEN

          ROLLBACK;
          VL_MESSAGE_H       := VL_MESSAGE_H || TRIM(SUBSTR(dbms_utility.format_error_backtrace() || ' ' || SQLERRM, 1, 255));
          PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                         VL_PROGR_D_TA1110,
                                         SQLCODE,
                                         VL_MESSAGE_H);

          PO_MSG := VL_MESSAGE_H;
          PO_STATUS := -1;

   WHEN OTHERS THEN

          ROLLBACK;
         -- Release updated records
            UPDATE TA1110PDV_PDC
            SET       DTELCK          = NULL,
                      IDSESSIONLCK    = NULL,
                      CODUSRLCK       = NULL
            WHERE CODUSRLCK = C_SYSUSR AND IDSESSIONLCK = PI_SESSION_ID;
            COMMIT;
          -- Moves records from staging area to log staging area
          P_XIN_MOVE_TO_LOG(PI_PROGR_H, VL_PROGR_D_TA1110,'TA1110PDV_PDC');

          VL_MESSAGE_H       := VL_MESSAGE_H || TRIM(SUBSTR(dbms_utility.format_error_backtrace() || ' ' || SQLERRM, 1, 255));
          PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                         VL_PROGR_D_TA1110,
                                         SQLCODE,
                                         VL_MESSAGE_H);

          PO_MSG := VL_MESSAGE_H;
          PO_STATUS := VL_STATUS;

  END LOAD_TA1110_PDV_PDC;


   /*============================================================================*\
  /* Name: TB0042_HIERARCHIES
    Loads SM1 tables :
    • TB0042RELATIONS_STATIC   sm1 customer/product/user Hierarchies
    Staging Area (SSA) tables:
    • XIN_ TB0042RELATIONS_STATIC

    Loading logic:
    MASSIVE: DELETE + INSERT. The whole hierarchy is DELETED and INSERTED. A Hierarchy is defined by CODDIV, CODDIM (customer/product/user), CODHIER (commercial/promotional/area…) fields

    Validity Checks:
    • No checks are set in loading procedure as all the checks will be done by the SM1 procedure that builds the hierarchy

    Error handling:
    • All Errors will be logged in T852/T854 SM1 log tables and all staging area records will be stored into staging area log with sm1_status = 9.
    • Error on record,  the whole hierarchy defined by same CODDIV, CODDIM, CODHIER is discarded

    How to delete a link in Hierarchy: on next import load the hierarchy SSA without the link you want to delete.

    This procedure does NOT generate the hierarchy
    --
    -- To Generate the Hierarchy, call the following with dimension and division you need
    -- PKG_SM1V4HIER.generate(vcoddim IN VARCHAR2, vcoddiv IN VARCHAR2) IS
    --

     Input parameters :     PI_PROGR_H - unique sm1 job number ( T800SYSTEMACTIVITYLOG )
                            PI_SESSION_ID    - unique login session (T035LOGGEDUSERS)
     Outputparameters :     PO_MSG           - message of error if procedure exit with error
                            PO_STATUS        - 0 OK; -1 Error
     Author : Mariangela Bandiera
     Creation Date : 14 September 2012
     ----
     Updates :


    ============================================================================ */

   PROCEDURE LOAD_TB0042_HIERARCHIES(PI_PROGR_H       IN NUMBER,
                         PI_SESSION_ID    IN NUMBER,
                         PO_MSG           OUT NOCOPY VARCHAR2,
                         PO_STATUS        OUT NOCOPY NUMBER ) IS

    -- -----------------------------------------
    -- Cursor on Customer Credit table TB0042RELATIONS_STATIC
    -- -----------------------------------------
    CURSOR CL_XIN_TB0042 IS
      SELECT
        *

        FROM  XIN_TB0042RELATIONS_ST
        WHERE SM1_CODPROCESS = PI_PROGR_H
        ORDER BY
        CODDIV,   --Division  code
        CODDIM,   --Dimension code
        CODHIER,  --Hierarchy code
        SM1_DTECRE;

    --
    VL_MESSAGE_H   VARCHAR2(4000) := 'Error while loading Hierarchies TB0042';
    VL_MESSAGE_D   VARCHAR2(4000) := NULL;
    --
    VL_PROGR_D_TB0042    NUMBER := 0;
    VL_COUNT_XIN_TB0042  NUMBER := 0;
    VL_INS_TB0042        NUMBER := 0;
    VL_INS               NUMBER := 0;
    --
    REC_TB0042      TB0042RELATIONS_STATIC%ROWTYPE    := NULL;
    REC_TB0042_INIT TB0042RELATIONS_STATIC%ROWTYPE    := NULL;

    --
    VL_DES_TB0042     X_FIELD_INFO_ARRAY;-- Array with fields LENGTHS
     --
    VL_STATUS NUMBER:= 0;
    --
    RL_XIN_TB0042_PREV CL_XIN_TB0042%ROWTYPE;

    VL_FLG_NEW_SET  NUMBER := 0; -- Used to identify the set CODDIV/CODDIM/CODHIER
    --
    VL_STEP   NUMBER:= 0; -- Used to ping t035
    --
    EX_EXIT  EXCEPTION;
    --
    VL_CODDIV VARCHAR2(30) := NULL;


  BEGIN

    -- init indexes and rebuild statistics
    P_XIN_INIT_INDEXES (PI_PROGR_H, 'TB0042RELATIONS_ST');
    -- clean loG

    P_XIN_CLEANUP_LOG (PI_PROGR_H, 'TB0042RELATIONS_ST');
    --
    VL_PROGR_D_TB0042 := PKG_UTILS.LOG_NEW_DETAIL(PI_PROGR_H,
                                                'HIERARCHIES',
                                                'IMPORT --> TB0042RELATIONS_STATIC',
                                                 0,
                                                 NULL);



    BEGIN
        --
        -- ----------------------------------------------------------
        -- Init arrays with FIELD_NAME=LENGTH and FIELDNAME=SM1_DEFAULT for all fields of table
        -- ----------------------------------------------------------
      VL_DES_TB0042.DELETE;
      P_INIT_SM1_FIELD_ARRAY ('TB0042RELATIONS_STATIC',VL_DES_TB0042,VL_STATUS, VL_MESSAGE_H);
      execute immediate ( GL_INIT_REC) INTO REC_TB0042_INIT;

        IF (VL_STATUS <> 0 ) THEN
            VL_MESSAGE_D := GL_INIT_REC;
            RAISE EX_EXIT;
        END IF;
    EXCEPTION WHEN OTHERS THEN
        VL_MESSAGE_D := GL_INIT_REC;
        RAISE EX_EXIT;
    END;

    -- --------------------------------------------------------------
    -- Identifies Xin records to be loaded
    -- --------------------------------------------------------------
    BEGIN
        VL_MESSAGE_D := 'XIN_TB0042RELATIONS_STATIC';
        UPDATE XIN_TB0042RELATIONS_ST
        SET SM1_CODPROCESS = PI_PROGR_H,
            SM1_STATUS = 0,
            SM1_DTEPROCESS = XSYSDATE
            WHERE SM1_CODPROCESS = C_SM1_NULL_CODPROCESS;

        VL_COUNT_XIN_TB0042 := SQL%ROWCOUNT;

    COMMIT;
    EXCEPTION WHEN OTHERS THEN
      ROLLBACK;
      VL_MESSAGE_H := 'Error while Reading Staging area: '||VL_MESSAGE_D;
      RAISE EX_EXIT;

    END;
    -- --------------------------------------------------------------
    -- loop in main table TB0042RELATIONS_STATIC
    -- --------------------------------------------------------------
    FOR RL_XIN_TB0042 IN CL_XIN_TB0042 LOOP
     -- pings to t035 every 1000 cicles--
      VL_STEP := VL_STEP + 1;
      IF ( MOD(VL_STEP, 1000) = 0 ) THEN
         PKG_UTILS.user_ping(PI_SESSION_ID);
      END IF;

        --- Commit or Rollback of prev Hierarchy set
        IF ( nvl(RL_XIN_TB0042_PREV.CODDIV, '@')     <> RL_XIN_TB0042.CODDIV  OR
             nvl(RL_XIN_TB0042_PREV.CODDIM, '@')     <> RL_XIN_TB0042.CODDIM  OR
             nvl(RL_XIN_TB0042_PREV.CODHIER, '@')    <> RL_XIN_TB0042.CODHIER) THEN

          VL_FLG_NEW_SET := -1;
          VL_INS_TB0042 := VL_INS_TB0042 + VL_INS;
          IF ( VL_STATUS = 0 ) THEN
            COMMIT;
          ELSE
            ROLLBACK;
          END IF;
          VL_INS := 0;

          UPDATE XIN_TB0042RELATIONS_ST
          SET   SM1_STATUS = CASE WHEN VL_STATUS = 0 THEN C_XINSTATUS_OK
                          ELSE C_XINSTATUS_ERR END
          WHERE CODDIV = RL_XIN_TB0042_PREV.CODDIV
          AND   CODDIM = RL_XIN_TB0042_PREV.CODDIM
          AND   CODHIER = RL_XIN_TB0042_PREV.CODHIER
          AND   SM1_CODPROCESS = PI_PROGR_H
          AND   SM1_DTECRE   = RL_XIN_TB0042_PREV.SM1_DTECRE
          AND  SM1_STATUS     = C_XINSTATUS_OK;

          COMMIT;
          VL_STATUS := 0;

        ELSE
          VL_FLG_NEW_SET := 0;
        END IF;

        VL_MESSAGE_H :=   'Division : '    ||RL_XIN_TB0042.CODDIV||' '||
                        'Dimension : '   ||RL_XIN_TB0042.CODDIM||' '||
                        'HierarchyCode: '||RL_XIN_TB0042.CODHIER||' '||
                        'Node : '        ||RL_XIN_TB0042.CODNODE||' '||
                        'Level : '       ||RL_XIN_TB0042.IDLEVEL||' '||
                        'ParentLevel : ' ||RL_XIN_TB0042.IDPARENTLEVEL;
      --
      BEGIN --- HEAD TB0042

       IF ( VL_STATUS = 0 ) THEN
       -- Data Format Check
        VL_MESSAGE_D := 'Format Conversion ';

          VL_CODDIV:= RL_XIN_TB0042.CODDIV;
          REC_TB0042.CODDIV := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_TB0042.CODDIV,'CODDIV', VL_DES_TB0042,VL_STATUS, VL_MESSAGE_D);
          REC_TB0042.CODDIM := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_TB0042.CODDIM,'CODDIM', VL_DES_TB0042,VL_STATUS, VL_MESSAGE_D);
          REC_TB0042.CODHIER := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_TB0042.CODHIER,'CODHIER', VL_DES_TB0042,VL_STATUS, VL_MESSAGE_D);
          REC_TB0042.CODNODE := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_TB0042.CODNODE,'CODNODE', VL_DES_TB0042,VL_STATUS, VL_MESSAGE_D);
          REC_TB0042.IDLEVEL := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_TB0042.IDLEVEL,'IDLEVEL', VL_DES_TB0042,VL_STATUS, VL_MESSAGE_D);
          REC_TB0042.IDPARENTLEVEL := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_TB0042.IDPARENTLEVEL,'IDPARENTLEVEL', VL_DES_TB0042,VL_STATUS, VL_MESSAGE_D);
          REC_TB0042.DTESTART := F_CHECK_FORMAT_D( VL_CODDIV,   RL_XIN_TB0042.DTESTART,'DTESTART', VL_DES_TB0042,VL_STATUS, VL_MESSAGE_D);
          REC_TB0042.DTEEND := F_CHECK_FORMAT_D( VL_CODDIV,   RL_XIN_TB0042.DTEEND,'DTEEND', VL_DES_TB0042,VL_STATUS, VL_MESSAGE_D);
          REC_TB0042.CODPARENTNODE := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_TB0042.CODPARENTNODE,'CODPARENTNODE', VL_DES_TB0042,VL_STATUS, VL_MESSAGE_D);
          REC_TB0042.CODLEVEL := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_TB0042.CODLEVEL,'CODLEVEL', VL_DES_TB0042,VL_STATUS, VL_MESSAGE_D);
          REC_TB0042.CODLEVELPARENT := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_TB0042.CODLEVELPARENT,'CODLEVELPARENT', VL_DES_TB0042,VL_STATUS, VL_MESSAGE_D);
          --- Technical fields
          REC_TB0042.DTEMOD     := XSYSDATE;
          REC_TB0042.DTECRE     := XSYSDATE;
          REC_TB0042.CODUSRMOD  := C_SYSUSR;

        IF (VL_STATUS <> 0 ) THEN

             VL_MESSAGE_H := SUBSTR(VL_MESSAGE_H||' '||VL_MESSAGE_D||' '||dbms_utility.format_error_backtrace() || ' ' || SQLERRM,1,4000);

             PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                           VL_PROGR_D_TB0042,
                                           SQLCODE,
                                           VL_MESSAGE_H);
        END IF;

        IF (VL_STATUS = 0 ) THEN
          -- when status <> 0 some fields have incorrect format. Log t800 has been already wrote by F_CHECK function
          -- Update article if already exists
             IF ( VL_FLG_NEW_SET = -1 ) THEN

                VL_MESSAGE_D := 'Insert TB0042RELATIONS_STATIC ';

                -- Delete the whole hierarchy
                DELETE TB0042RELATIONS_STATIC WHERE
                     CODDIV  = REC_TB0042.CODDIV AND
                     CODDIM  = REC_TB0042.CODDIM AND
                     CODHIER = REC_TB0042.CODHIER;

                VL_FLG_NEW_SET := 0;

             END IF;


              VL_MESSAGE_D := 'Insert TB0042RELATIONS_STATIC ';
              -- Record does not exists, we insert it
              INSERT INTO TB0042RELATIONS_STATIC VALUES REC_TB0042;
                --
                 VL_INS := VL_INS + 1;
        END IF; -- Record has been updated

        END IF; -- vl_status

        EXCEPTION WHEN OTHERS THEN
             VL_STATUS := -1;
             VL_MESSAGE_H := SUBSTR(VL_MESSAGE_H||' '||VL_MESSAGE_D||' '||dbms_utility.format_error_backtrace() || ' ' || SQLERRM,1,4000);

             PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                           VL_PROGR_D_TB0042,
                                           SQLCODE,
                                           VL_MESSAGE_H);

        END; -- HEAD TB0042


    RL_XIN_TB0042_PREV      := RL_XIN_TB0042;

    END LOOP;  -- TB0042RELATIONS_STATIC

    --- Commit or Rollback of prev Hierarchy set
    IF ( VL_STATUS = 0 and REC_TB0042.CODHIER IS NOT NULL) THEN
       VL_INS_TB0042 := VL_INS_TB0042 + VL_INS;
       COMMIT;
    ELSE
      ROLLBACK;


        UPDATE XIN_TB0042RELATIONS_ST
        SET   SM1_STATUS =  C_XINSTATUS_ERR
        WHERE CODDIV  = RL_XIN_TB0042_PREV.CODDIV
        AND   CODDIM  = RL_XIN_TB0042_PREV.CODDIM
        AND   CODHIER = RL_XIN_TB0042_PREV.CODHIER
        AND   SM1_CODPROCESS = PI_PROGR_H
        AND   SM1_DTECRE  = RL_XIN_TB0042_PREV.SM1_DTECRE
        AND  SM1_STATUS     = C_XINSTATUS_OK;

        COMMIT;
    END IF;
    -- Moves records from staging area to log staging area
    P_XIN_MOVE_TO_LOG(PI_PROGR_H, VL_PROGR_D_TB0042,'TB0042RELATIONS_ST');

   -- Close Logs
    PKG_UTILS.LOG_END_DETAIL(PI_PROGR_H,
                             VL_PROGR_D_TB0042,
                             0,
                             VL_COUNT_XIN_TB0042,
                             VL_INS_TB0042,
                             VL_COUNT_XIN_TB0042 - VL_INS_TB0042);


    PO_MSG := VL_INS_TB0042||'/'||VL_COUNT_XIN_TB0042||' Hierarchy links loaded';
    PO_STATUS :=VL_INS_TB0042;


    --
    -- Generate the Hierarchy for all configured hierarchies
    FOR RL_HIER IN ( select CODDIM, CODDIV from TB0000DIM ) LOOP

       PKG_SM1V4HIER.generate(RL_HIER.coddim, RL_HIER.coddiv);

    END LOOP;

  EXCEPTION WHEN EX_EXIT THEN

          ROLLBACK;
          VL_MESSAGE_H       := VL_MESSAGE_H || TRIM(SUBSTR(dbms_utility.format_error_backtrace() || ' ' || SQLERRM, 1, 255));
          PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                         VL_PROGR_D_TB0042,
                                         SQLCODE,
                                         VL_MESSAGE_H);

          PO_MSG := VL_MESSAGE_H;
          PO_STATUS := -1;

   WHEN OTHERS THEN

          ROLLBACK;
          -- Moves records from staging area to log staging area
          P_XIN_MOVE_TO_LOG(PI_PROGR_H, VL_PROGR_D_TB0042,'TB0042RELATIONS_ST');

          VL_MESSAGE_H       := VL_MESSAGE_H || TRIM(SUBSTR(dbms_utility.format_error_backtrace() || ' ' || SQLERRM, 1, 255));
          PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                         VL_PROGR_D_TB0042,
                                         SQLCODE,
                                         VL_MESSAGE_H);

          PO_MSG := VL_MESSAGE_H;
          PO_STATUS := VL_STATUS;

  END LOAD_TB0042_HIERARCHIES;
    /*============================================================================*\
  /* Name: LOAD_TA019X_SURVEY
       Loads SM1 tables:
      • TA0191CUSTOMERSURVEY - Activity header table
      • TA0192CUSTOMERSURVEYDET  - Activity detail table

      Staging Area (SSA) tables (in Chronological Order expected in SSA for each user):
      1.  XIN_TA0191CUSTOMERSURVEY
      2.  XIN_TA0192CUSTOMERSURVEYDET

      When NEW activity In XIN field IDSURVEY we expected a temporary ERP code that will be replaced by the SM1 IDSURVEY CODE
      When already existing activity in In XIN field IDSURVEY we expected the SM1 IDSURVEY code

      Loading logic:
      TA0191/TA0192 UPDATE + INSERT. Each record is updated if already exists (checking by primary key) and it is not already locked, record is inserted if it does not exist yet.

      Validity Checks:
      • The only check made is the existance of the survey type in the TA0184SURVEY table

      Error handling:
      • All Errors will be logged in T852/T854 SM1 log tables and all staging area records will be stored into staging area log with sm1_status = 9.
      • Error on head record,  it is discarded with all its details.
      • Error on detail record,  it is discarded with its head and all other head details

      How to delete an Activity:
      • Activities cannot be deleted by Integration Host

     Input parameters :     PI_PROGR_H - unique sm1 job number ( T800SYSTEMACTIVITYLOG )
                            PI_SESSION_ID    - unique login session (T035LOGGEDUSERS)
     Outputparameters :     PO_MSG           - message of error if procedure exit with error
                            PO_STATUS        - 0 OK; -1 Error
     Author : Mariangela Bandiera
     Creation Date : 03 January 2013
     ----
     Updates :

     Mbandiera 31 July 2014 added new fields management

      TA0191.DTEPREPARATION DATE    Visit preparation date.
      TA0191.DTEEXECUTION DATE    Visit execution date.
      TA0191.DTEVISIT_SUSPENDED DATE    The last visit date this activity was manually supended from. The activity will not be autoincluded in visits with this date (same customer, same contact mode).
      TA0191.PLANORAMA_IMAGES NUMBER(9)   Number of images uploaded for planorama store check analysis
      TA0191.STARTTIME  VARCHAR2(5)   Visit start time in the local time of the user that created the visit formatted HH:MM (24 hour format)
      TA0191.DURATION NUMBER(9)   Visit duration in minutes
      TA0191.TIMEZONE NUMBER(2)   Local timezone of the user that creatd the visit
      TA0191.CODVISITCAUSE  VARCHAR2(30)    Creation cause [CONF:QTABS=VISITCAUSE.COD]
      TA0191.CODSEQBREAKCAUSE VARCHAR2(30)    The reason why the visit hasn't been executed in order [CONF:QTABS=SEQBREAKCAUSE.COD]



    ============================================================================ */

   PROCEDURE LOAD_TA019X_SURVEYS(PI_PROGR_H      IN NUMBER,
                                PI_SESSION_ID    IN NUMBER,
                                PO_MSG           OUT NOCOPY VARCHAR2,
                                PO_STATUS        OUT NOCOPY NUMBER ) IS

    -- -----------------------------------------
    -- Cursor on Activity table TA0191
    -- -----------------------------------------
    CURSOR CL_XIN_TA0191 IS
      SELECT
      *

        FROM  XIN_TA0191CUSTOMERSURV
        WHERE SM1_CODPROCESS = PI_PROGR_H
        ORDER BY SM1_DTECRE;

    -- -----------------------------------------
    -- Cursor on Activity detail Info TA0192
    -- -----------------------------------------
    CURSOR CL_XIN_TA0192(CI_IDSURVEY VARCHAR2, CI_SM1_DTECRE DATE) IS
      SELECT
       *

        FROM  XIN_TA0192CUSTOMERSURV
        WHERE IDSURVEY = CI_IDSURVEY
        AND   SM1_CODPROCESS = PI_PROGR_H
        AND   SM1_DTECRE <= CI_SM1_DTECRE
        AND SM1_STATUS = C_XINSTATUS_OK -- Only those that have not processed yet (in case of double record in xin)
        ORDER BY SM1_DTECRE;
    --
    VL_MESSAGE_H   VARCHAR2(4000) := 'Error while loading Users TA0191';
    VL_MESSAGE_D   VARCHAR2(4000) := NULL;
    --
    VL_PROGR_D_TA0191    NUMBER := 0;
    VL_COUNT_XIN_TA0191  NUMBER := 0;
    VL_INS_TA0191        NUMBER := 0;
    --
    VL_PROGR_D_TA0192    NUMBER := 0;
    VL_COUNT_XIN_TA0192  NUMBER := 0;
    VL_INS_TA0192        NUMBER := 0;
    --
    VL_IDSURVEY     TA0191CUSTOMERSURVEY.IDSURVEY%TYPE:=NULL;
    VL_CODTYPSURVEY TA0184SURVEY.CODTYPSURVEY%TYPE:=NULL;
    --
    REC_TA0191 TA0191CUSTOMERSURVEY%ROWTYPE    := NULL;
    REC_TA0192 TA0192CUSTOMERSURVEYDET%ROWTYPE := NULL;
      --
    REC_TA0191_INIT TA0191CUSTOMERSURVEY%ROWTYPE    := NULL;
    REC_TA0192_INIT TA0192CUSTOMERSURVEYDET%ROWTYPE := NULL;

    --
    VL_DES_TA0191     X_FIELD_INFO_ARRAY;-- Array with fields db info
    --
    VL_DES_TA0192     X_FIELD_INFO_ARRAY;-- Array with fields db info
    --

    VL_RECORD_LOCKED NUMBER := 0;

    VL_STATUS NUMBER:= 0;
    VL_STEP   NUMBER:= 0; -- Used to ping t035
    --
    EX_EXIT  EXCEPTION;
    --
    VL_CODDIV VARCHAR2(30) := NULL;

  BEGIN

    -- init indexes and rebuild statistics
    P_XIN_INIT_INDEXES (PI_PROGR_H, 'TA0191CUSTOMERSURV');
    P_XIN_INIT_INDEXES (PI_PROGR_H, 'TA0192CUSTOMERSURV');
    -- clean loG
    P_XIN_CLEANUP_LOG (PI_PROGR_H, 'TA0191CUSTOMERSURV');
    P_XIN_CLEANUP_LOG (PI_PROGR_H, 'TA0192CUSTOMERSURV');


    VL_PROGR_D_TA0191 := PKG_UTILS.LOG_NEW_DETAIL(PI_PROGR_H,
                                       'ACTIVITIES',
                                       'IMPORT --> TA0191CUSTOMERSURVEY',
                                        0,
                                        NULL);
    VL_PROGR_D_TA0192 := PKG_UTILS.LOG_NEW_DETAIL(PI_PROGR_H,
                                       'ACTIVITY DETAIL',
                                       'IMPORT --> TA0192CUSTOMERSURVEYDET',
                                        0,
                                        NULL);


    BEGIN
        --
        -- ----------------------------------------------------------
        -- Init arrays with FIELD_NAME=LENGTH and FIELDNAME=SM1_DEFAULT for all fields of table
        -- ----------------------------------------------------------
       VL_DES_TA0191.DELETE;
       P_INIT_SM1_FIELD_ARRAY ('TA0191CUSTOMERSURVEY', VL_DES_TA0191, VL_STATUS, VL_MESSAGE_H);
       execute immediate ( GL_INIT_REC) INTO REC_TA0191_INIT;

       VL_DES_TA0192.DELETE;
       P_INIT_SM1_FIELD_ARRAY ('TA0192CUSTOMERSURVEYDET', VL_DES_TA0192, VL_STATUS, VL_MESSAGE_H);
       execute immediate ( GL_INIT_REC) INTO REC_TA0192_INIT;

        IF (VL_STATUS <> 0 ) THEN
            VL_MESSAGE_D := GL_INIT_REC;
            RAISE EX_EXIT;
        END IF;
    EXCEPTION WHEN OTHERS THEN
        VL_MESSAGE_D := GL_INIT_REC;
        RAISE EX_EXIT;
    END;

    -- --------------------------------------------------------------
    -- Identifies Xin records to be loaded
    -- --------------------------------------------------------------
    BEGIN
        VL_MESSAGE_D := 'XIN_TA0191CUSTOMERSURVEY';
        UPDATE XIN_TA0191CUSTOMERSURV
        SET SM1_CODPROCESS = PI_PROGR_H,
            SM1_STATUS = 0,
            SM1_DTEPROCESS = XSYSDATE
            WHERE SM1_CODPROCESS = C_SM1_NULL_CODPROCESS;

        VL_COUNT_XIN_TA0191 := SQL%ROWCOUNT;

        VL_MESSAGE_D := 'XIN_TA0192CUSTOMERSURVEYDET';
        UPDATE XIN_TA0192CUSTOMERSURV D
        SET D.SM1_CODPROCESS = PI_PROGR_H,
            D.SM1_STATUS = 0,
            D.SM1_DTEPROCESS = XSYSDATE
            WHERE D.SM1_CODPROCESS = C_SM1_NULL_CODPROCESS
            AND D.IDSURVEY IN ( SELECT H.IDSURVEY FROM XIN_TA0191CUSTOMERSURV H WHERE H.SM1_CODPROCESS = PI_PROGR_H AND H.SM1_DTECRE >= D.SM1_DTECRE );

        VL_COUNT_XIN_TA0192 := SQL%ROWCOUNT;

    COMMIT;
    EXCEPTION WHEN OTHERS THEN
      ROLLBACK;
      VL_MESSAGE_H := 'Error while Reading Staging area: '||VL_MESSAGE_D;
      RAISE EX_EXIT;

    END;

    -- --------------------------------------------------------------
    -- loop in main table TA0191CUSTOMERSURVEY
    -- --------------------------------------------------------------
    FOR RL_XIN_TA0191 IN CL_XIN_TA0191 LOOP
     -- pings to t035 every 100 cicles--
      VL_STEP := VL_STEP + 1;

      IF ( MOD(VL_STEP, 100) = 0 ) THEN
         PKG_UTILS.user_ping(PI_SESSION_ID);
      END IF;

      --
      VL_STATUS := 0;
      --
      VL_MESSAGE_H :=   'ERP Activity : '   ||RL_XIN_TA0191.IDSURVEY;
      --
      BEGIN --- HEAD TA0191

        -- Data Format Check
        VL_MESSAGE_D := 'Format Conversion ';
        VL_CODDIV:= RL_XIN_TA0191.CODDIV;
        -- REC_TA0191.IDSURVEY := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_TA0191.IDSURVEY,'IDSURVEY', VL_DES_TA0191,VL_STATUS, VL_MESSAGE_D);
        REC_TA0191.CODPARTY := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_TA0191.CODPARTY,'CODPARTY', VL_DES_TA0191,VL_STATUS, VL_MESSAGE_D);
        REC_TA0191.CODUSR := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_TA0191.CODUSR,'CODUSR', VL_DES_TA0191,VL_STATUS, VL_MESSAGE_D);
        REC_TA0191.CODTYPSURVEY := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_TA0191.CODTYPSURVEY,'CODTYPSURVEY', VL_DES_TA0191,VL_STATUS, VL_MESSAGE_D);
        REC_TA0191.DTEVISIT := F_CHECK_FORMAT_D( VL_CODDIV,   RL_XIN_TA0191.DTEVISIT,'DTEVISIT', VL_DES_TA0191,VL_STATUS, VL_MESSAGE_D);
        REC_TA0191.HOURVISIT := F_CHECK_FORMAT_D( VL_CODDIV,   RL_XIN_TA0191.HOURVISIT,'HOURVISIT', VL_DES_TA0191,VL_STATUS, VL_MESSAGE_D);
        REC_TA0191.HOURVISITTO := F_CHECK_FORMAT_D( VL_CODDIV,   RL_XIN_TA0191.HOURVISITTO,'HOURVISITTO', VL_DES_TA0191,VL_STATUS, VL_MESSAGE_D);
        REC_TA0191.DTEFROM := F_CHECK_FORMAT_D( VL_CODDIV,   RL_XIN_TA0191.DTEFROM,'DTEFROM', VL_DES_TA0191,VL_STATUS, VL_MESSAGE_D);
        REC_TA0191.DTETO := F_CHECK_FORMAT_D( VL_CODDIV,   RL_XIN_TA0191.DTETO,'DTETO', VL_DES_TA0191,VL_STATUS, VL_MESSAGE_D);
        REC_TA0191.IDMISSION := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_TA0191.IDMISSION,'IDMISSION', VL_DES_TA0191,VL_STATUS, VL_MESSAGE_D);
        REC_TA0191.CODSTATUS := '8'; -- IMPORTED STATUS -- F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_TA0191.CODSTATUS,'CODSTATUS', VL_DES_TA0191,VL_STATUS, VL_MESSAGE_D);
        REC_TA0191.CODPRIORITY := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_TA0191.CODPRIORITY,'CODPRIORITY', VL_DES_TA0191,VL_STATUS, VL_MESSAGE_D);
        REC_TA0191.DESHQNOTE := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_TA0191.DESHQNOTE,'DESHQNOTE', VL_DES_TA0191,VL_STATUS, VL_MESSAGE_D);
        REC_TA0191.DESNOTE := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_TA0191.DESNOTE,'DESNOTE', VL_DES_TA0191,VL_STATUS, VL_MESSAGE_D);
        REC_TA0191.REFDOCUMENTKEY := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_TA0191.REFDOCUMENTKEY,'REFDOCUMENTKEY', VL_DES_TA0191,VL_STATUS, VL_MESSAGE_D);
        REC_TA0191.CODUSRSUP := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_TA0191.CODUSRSUP,'CODUSRSUP', VL_DES_TA0191,VL_STATUS, VL_MESSAGE_D);
        REC_TA0191.CODDIV := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_TA0191.CODDIV,'CODDIV', VL_DES_TA0191,VL_STATUS, VL_MESSAGE_D);
        REC_TA0191.CODANNCAUSE := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_TA0191.CODANNCAUSE,'CODANNCAUSE', VL_DES_TA0191,VL_STATUS, VL_MESSAGE_D);
        REC_TA0191.CODSTRUCTURE := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_TA0191.CODSTRUCTURE,'CODSTRUCTURE', VL_DES_TA0191,VL_STATUS, VL_MESSAGE_D);
        REC_TA0191.FLGPRIVATE := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_TA0191.FLGPRIVATE,'FLGPRIVATE', VL_DES_TA0191,VL_STATUS, VL_MESSAGE_D);
        REC_TA0191.CODTIMEAVAILABLE := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_TA0191.CODTIMEAVAILABLE,'CODTIMEAVAILABLE', VL_DES_TA0191,VL_STATUS, VL_MESSAGE_D);
        REC_TA0191.FLGANN := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_TA0191.FLGANN,'FLGANN', VL_DES_TA0191,VL_STATUS, VL_MESSAGE_D);
        REC_TA0191.SPENTTIME := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_TA0191.SPENTTIME,'SPENTTIME', VL_DES_TA0191,VL_STATUS, VL_MESSAGE_D);
        REC_TA0191.FLGAUTOCREATED := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_TA0191.FLGAUTOCREATED,'FLGAUTOCREATED', VL_DES_TA0191,VL_STATUS, VL_MESSAGE_D);
        REC_TA0191.MISSION_DTEVISIT := F_CHECK_FORMAT_D( VL_CODDIV,   RL_XIN_TA0191.MISSION_DTEVISIT,'MISSION_DTEVISIT', VL_DES_TA0191,VL_STATUS, VL_MESSAGE_D);
        REC_TA0191.MISSION_HOURVISIT := F_CHECK_FORMAT_D( VL_CODDIV,   RL_XIN_TA0191.MISSION_HOURVISIT,'MISSION_HOURVISIT', VL_DES_TA0191,VL_STATUS, VL_MESSAGE_D);
        REC_TA0191.MISSION_HOURVISITTO := F_CHECK_FORMAT_D( VL_CODDIV,   RL_XIN_TA0191.MISSION_HOURVISITTO,'MISSION_HOURVISITTO', VL_DES_TA0191,VL_STATUS, VL_MESSAGE_D);
        REC_TA0191.IDQUESTIONNAIRE := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_TA0191.IDQUESTIONNAIRE,'IDQUESTIONNAIRE', VL_DES_TA0191,VL_STATUS, VL_MESSAGE_D);
        REC_TA0191.CALCULATEDSPENTTIME := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_TA0191.CALCULATEDSPENTTIME,'CALCULATEDSPENTTIME', VL_DES_TA0191,VL_STATUS, VL_MESSAGE_D);
        REC_TA0191.DRIVETIME := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_TA0191.DRIVETIME,'DRIVETIME', VL_DES_TA0191,VL_STATUS, VL_MESSAGE_D);
        REC_TA0191.NUMKM := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_TA0191.NUMKM,'NUMKM', VL_DES_TA0191,VL_STATUS, VL_MESSAGE_D);
        REC_TA0191.FLGOBJECTIVE := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_TA0191.FLGOBJECTIVE,'FLGOBJECTIVE', VL_DES_TA0191,VL_STATUS, VL_MESSAGE_D);
        REC_TA0191.GPSVALLATITUDE := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_TA0191.GPSVALLATITUDE,'GPSVALLATITUDE', VL_DES_TA0191,VL_STATUS, VL_MESSAGE_D);
        REC_TA0191.GPSVALLONGITUDE := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_TA0191.GPSVALLONGITUDE,'GPSVALLONGITUDE', VL_DES_TA0191,VL_STATUS, VL_MESSAGE_D);
        REC_TA0191.PREPNOTE := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_TA0191.PREPNOTE,'PREPNOTE', VL_DES_TA0191,VL_STATUS, VL_MESSAGE_D);
        REC_TA0191.FLGMODIFY := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_TA0191.FLGMODIFY,'FLGMODIFY', VL_DES_TA0191,VL_STATUS, VL_MESSAGE_D);
        REC_TA0191.IDRECURRENCE := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_TA0191.IDRECURRENCE,'IDRECURRENCE', VL_DES_TA0191,VL_STATUS, VL_MESSAGE_D);
        REC_TA0191.RECURRENCENO := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_TA0191.RECURRENCENO,'RECURRENCENO', VL_DES_TA0191,VL_STATUS, VL_MESSAGE_D);
        REC_TA0191.CONTACTMODE := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_TA0191.CONTACTMODE,'CONTACTMODE', VL_DES_TA0191,VL_STATUS, VL_MESSAGE_D);

        REC_TA0191.DTEPREPARATION := F_CHECK_FORMAT_D( VL_CODDIV, RL_XIN_TA0191.DTEPREPARATION,'DTEPREPARATION', VL_DES_TA0191,VL_STATUS, VL_MESSAGE_D);
        REC_TA0191.DTEEXECUTION := F_CHECK_FORMAT_D( VL_CODDIV, RL_XIN_TA0191.DTEEXECUTION,'DTEEXECUTION', VL_DES_TA0191,VL_STATUS, VL_MESSAGE_D);
        REC_TA0191.DTEVISIT_SUSPENDED := F_CHECK_FORMAT_D( VL_CODDIV, RL_XIN_TA0191.DTEVISIT_SUSPENDED,'DTEVISIT_SUSPENDED', VL_DES_TA0191,VL_STATUS, VL_MESSAGE_D);
        REC_TA0191.PLANORAMA_IMAGES := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_TA0191.PLANORAMA_IMAGES,'PLANORAMA_IMAGES', VL_DES_TA0191,VL_STATUS, VL_MESSAGE_D);
        REC_TA0191.STARTTIME := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_TA0191.STARTTIME,'STARTTIME', VL_DES_TA0191,VL_STATUS, VL_MESSAGE_D);
        REC_TA0191.DURATION := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_TA0191.DURATION,'DURATION', VL_DES_TA0191,VL_STATUS, VL_MESSAGE_D);
        REC_TA0191.TIMEZONE := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_TA0191.TIMEZONE,'TIMEZONE', VL_DES_TA0191,VL_STATUS, VL_MESSAGE_D);
        REC_TA0191.CODVISITCAUSE := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_TA0191.CODVISITCAUSE,'CODVISITCAUSE', VL_DES_TA0191,VL_STATUS, VL_MESSAGE_D);
        REC_TA0191.CODSEQBREAKCAUSE := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_TA0191.CODSEQBREAKCAUSE,'CODSEQBREAKCAUSE', VL_DES_TA0191,VL_STATUS, VL_MESSAGE_D);

        --- Technical fields
        REC_TA0191.DTECRE     := XSYSDATE;
        REC_TA0191.CODUSRMOD  := C_SYSUSR;
        REC_TA0191.CODUSRCRE  := C_SYSUSR;
        REC_TA0191.DTEMOD     := XSYSDATE;
        REC_TA0191.CODUSRMODREAL := C_SYSUSR;
        REC_TA0191.CODUSRCREREAL := C_SYSUSR;
        -- lock fields
        REC_TA0191.CODUSRLCK     := C_SYSUSR;
        REC_TA0191.IDSESSIONLCK  := PI_SESSION_ID;
        REC_TA0191.DTELCK        := XSYSDATE;
       -- Id Visit
        REC_TA0191.IDVISIT := PKG_SALESEXECUTION.GET_ID_VISIT(REC_TA0191.CODPARTY,
                                                              REC_TA0191.CODUSR,
                                                              REC_TA0191.DTEVISIT,
                                                              REC_TA0191.HOURVISIT,
                                                              REC_TA0191.HOURVISITTO,
                                                              REC_TA0191.CODSTATUS,
                                                              REC_TA0191.CONTACTMODE);


        -- checks the existance of codtypsurvey
        BEGIN
        VL_CODTYPSURVEY := NULL;
        SELECT TA0184.CODTYPSURVEY INTO VL_CODTYPSURVEY
        FROM TA0184SURVEY TA0184
        WHERE TA0184.CODTYPSURVEY = REC_TA0191.CODTYPSURVEY;
        EXCEPTION WHEN NO_DATA_FOUND THEN
           VL_MESSAGE_D := 'Codtypsurvey '||REC_TA0191.CODTYPSURVEY||' not defined in TA0184SURVEY';
           VL_STATUS := -1;
        END ;



        IF (VL_STATUS <> 0 ) THEN

             VL_MESSAGE_H := SUBSTR(VL_MESSAGE_H||' '||VL_MESSAGE_D||' '||dbms_utility.format_error_backtrace() || ' ' || SQLERRM,1,4000);

             PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                           VL_PROGR_D_TA0191,
                                           SQLCODE,
                                           VL_MESSAGE_H);

        ELSE


            -- Finds if it already exists
            VL_IDSURVEY := NULL;
            BEGIN

              select idsurvey into vl_idsurvey
              from ta0191customersurvey where
                 CODPARTY = REC_TA0191.CODPARTY
                 AND CODUSR = REC_TA0191.CODUSR
                 AND CODTYPSURVEY = REC_TA0191.CODTYPSURVEY
                 AND DTEVISIT = REC_TA0191.DTEVISIT;


               VL_MESSAGE_D := 'Update TA0191CUSTOMERSURVEY ';
               UPDATE TA0191CUSTOMERSURVEY
               SET
                   -- when the field si set to updated by host it means that the value should be read from XIN
                   -- otherwise it means that the field is managed by sm1 and it maintains its original value
                  CODPARTY = CASE VL_DES_TA0191('CODPARTY.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0191.CODPARTY ELSE CODPARTY END,
                  CODUSR = CASE VL_DES_TA0191('CODUSR.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0191.CODUSR ELSE CODUSR END,
                  CODTYPSURVEY = CASE VL_DES_TA0191('CODTYPSURVEY.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0191.CODTYPSURVEY ELSE CODTYPSURVEY END,
                  DTEVISIT = CASE VL_DES_TA0191('DTEVISIT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0191.DTEVISIT ELSE DTEVISIT END,
                  HOURVISIT = CASE VL_DES_TA0191('HOURVISIT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0191.HOURVISIT ELSE HOURVISIT END,
                  HOURVISITTO = CASE VL_DES_TA0191('HOURVISITTO.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0191.HOURVISITTO ELSE HOURVISITTO END,
                  DTEFROM = CASE VL_DES_TA0191('DTEFROM.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0191.DTEFROM ELSE DTEFROM END,
                  DTETO = CASE VL_DES_TA0191('DTETO.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0191.DTETO ELSE DTETO END,
                  IDMISSION = CASE VL_DES_TA0191('IDMISSION.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0191.IDMISSION ELSE IDMISSION END,
                  CODSTATUS = CASE VL_DES_TA0191('CODSTATUS.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0191.CODSTATUS ELSE CODSTATUS END,
                  CODPRIORITY = CASE VL_DES_TA0191('CODPRIORITY.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0191.CODPRIORITY ELSE CODPRIORITY END,
                  DESHQNOTE = CASE VL_DES_TA0191('DESHQNOTE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0191.DESHQNOTE ELSE DESHQNOTE END,
                  DESNOTE = CASE VL_DES_TA0191('DESNOTE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0191.DESNOTE ELSE DESNOTE END,
                  REFDOCUMENTKEY = CASE VL_DES_TA0191('REFDOCUMENTKEY.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0191.REFDOCUMENTKEY ELSE REFDOCUMENTKEY END,
                  CODUSRSUP = CASE VL_DES_TA0191('CODUSRSUP.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0191.CODUSRSUP ELSE CODUSRSUP END,
                  CODDIV = CASE VL_DES_TA0191('CODDIV.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0191.CODDIV ELSE CODDIV END,
                  CODANNCAUSE = CASE VL_DES_TA0191('CODANNCAUSE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0191.CODANNCAUSE ELSE CODANNCAUSE END,
                  CODSTRUCTURE = CASE VL_DES_TA0191('CODSTRUCTURE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0191.CODSTRUCTURE ELSE CODSTRUCTURE END,
                  FLGPRIVATE = CASE VL_DES_TA0191('FLGPRIVATE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0191.FLGPRIVATE ELSE FLGPRIVATE END,
                  CODTIMEAVAILABLE = CASE VL_DES_TA0191('CODTIMEAVAILABLE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0191.CODTIMEAVAILABLE ELSE CODTIMEAVAILABLE END,
                  FLGANN = CASE VL_DES_TA0191('FLGANN.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0191.FLGANN ELSE FLGANN END,
                  SPENTTIME = CASE VL_DES_TA0191('SPENTTIME.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0191.SPENTTIME ELSE SPENTTIME END,
                  FLGAUTOCREATED = CASE VL_DES_TA0191('FLGAUTOCREATED.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0191.FLGAUTOCREATED ELSE FLGAUTOCREATED END,
                  MISSION_DTEVISIT = CASE VL_DES_TA0191('MISSION_DTEVISIT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0191.MISSION_DTEVISIT ELSE MISSION_DTEVISIT END,
                  MISSION_HOURVISIT = CASE VL_DES_TA0191('MISSION_HOURVISIT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0191.MISSION_HOURVISIT ELSE MISSION_HOURVISIT END,
                  MISSION_HOURVISITTO = CASE VL_DES_TA0191('MISSION_HOURVISITTO.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0191.MISSION_HOURVISITTO ELSE MISSION_HOURVISITTO END,
                  IDQUESTIONNAIRE = CASE VL_DES_TA0191('IDQUESTIONNAIRE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0191.IDQUESTIONNAIRE ELSE IDQUESTIONNAIRE END,
                  CALCULATEDSPENTTIME = CASE VL_DES_TA0191('CALCULATEDSPENTTIME.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0191.CALCULATEDSPENTTIME ELSE CALCULATEDSPENTTIME END,
                  DRIVETIME = CASE VL_DES_TA0191('DRIVETIME.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0191.DRIVETIME ELSE DRIVETIME END,
                  NUMKM = CASE VL_DES_TA0191('NUMKM.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0191.NUMKM ELSE NUMKM END,
                  FLGOBJECTIVE = CASE VL_DES_TA0191('FLGOBJECTIVE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0191.FLGOBJECTIVE ELSE FLGOBJECTIVE END,
                  GPSVALLATITUDE = CASE VL_DES_TA0191('GPSVALLATITUDE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0191.GPSVALLATITUDE ELSE GPSVALLATITUDE END,
                  GPSVALLONGITUDE = CASE VL_DES_TA0191('GPSVALLONGITUDE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0191.GPSVALLONGITUDE ELSE GPSVALLONGITUDE END,
                  IDVISIT = CASE VL_DES_TA0191('IDVISIT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0191.IDVISIT ELSE IDVISIT END,
                  PREPNOTE = CASE VL_DES_TA0191('PREPNOTE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0191.PREPNOTE ELSE PREPNOTE END,
                  FLGMODIFY = CASE VL_DES_TA0191('FLGMODIFY.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0191.FLGMODIFY ELSE FLGMODIFY END,
                  IDRECURRENCE = CASE VL_DES_TA0191('IDRECURRENCE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0191.IDRECURRENCE ELSE IDRECURRENCE END,
                  RECURRENCENO = CASE VL_DES_TA0191('RECURRENCENO.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0191.RECURRENCENO ELSE RECURRENCENO END,
                  CONTACTMODE = CASE VL_DES_TA0191('CONTACTMODE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0191.CONTACTMODE ELSE CONTACTMODE END,

                  DTEPREPARATION = CASE VL_DES_TA0191('DTEPREPARATION.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0191.DTEPREPARATION ELSE DTEPREPARATION END,
                  DTEEXECUTION = CASE VL_DES_TA0191('DTEEXECUTION.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0191.DTEEXECUTION ELSE DTEEXECUTION END,
                  DTEVISIT_SUSPENDED = CASE VL_DES_TA0191('DTEVISIT_SUSPENDED.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0191.DTEVISIT_SUSPENDED ELSE DTEVISIT_SUSPENDED END,
                  PLANORAMA_IMAGES = CASE VL_DES_TA0191('PLANORAMA_IMAGES.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0191.PLANORAMA_IMAGES ELSE PLANORAMA_IMAGES END,
                  STARTTIME = CASE VL_DES_TA0191('STARTTIME.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0191.STARTTIME ELSE STARTTIME END,
                  DURATION = CASE VL_DES_TA0191('DURATION.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0191.DURATION ELSE DURATION END,
                  TIMEZONE = CASE VL_DES_TA0191('TIMEZONE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0191.TIMEZONE ELSE TIMEZONE END,
                  CODVISITCAUSE = CASE VL_DES_TA0191('CODVISITCAUSE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0191.CODVISITCAUSE ELSE CODVISITCAUSE END,
                  CODSEQBREAKCAUSE = CASE VL_DES_TA0191('CODSEQBREAKCAUSE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0191.CODSEQBREAKCAUSE ELSE CODSEQBREAKCAUSE END,

                 --- Technical fields
                  CODUSRMOD = REC_TA0191.CODUSRMOD,
                  DTEMOD    = REC_TA0191.DTEMOD,
                  -- lock fields
                  CODUSRLCK    = REC_TA0191.CODUSRLCK,
                  IDSESSIONLCK = REC_TA0191.IDSESSIONLCK,
                  DTELCK       = REC_TA0191.DTELCK

             WHERE IDSURVEY = VL_IDSURVEY
             and not exists ( select null from T035LOGGEDUSERS T035 where T035.IDSESSION = NVL(IDSESSIONLCK, '@') AND T035.LASTCHECK > TRUNC(XSYSDATE)-1 );


             IF SQL%ROWCOUNT = 0 THEN

                  VL_STATUS := -1;
                  VL_RECORD_LOCKED := -1;
                  PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                                 VL_PROGR_D_TA0191,
                                                 SQLCODE,
                                                 'Record is locked; import has failed :'||VL_MESSAGE_H);

              END IF; -- Record has been inserted

             EXCEPTION WHEN OTHERS THEN

                -- calculate the id survey and inserts it new
                VL_IDSURVEY := LPAD(TO_CHAR(PKG_UTILS.fn_getprogressive('IDSURVEY')), VL_DES_TA0191('IDSURVEY').FIELD_LENGTH , '0');
                REC_TA0191.IDSURVEY    := VL_IDSURVEY ;
                REC_TA0191.DOCUMENTKEY := PKG_UTILS.documentkey_for_ta0191(VL_IDSURVEY);

                VL_MESSAGE_D := 'Insert TA0191CUSTOMERSURVEY ';
                -- Record does not exists, we insert it
                INSERT INTO TA0191CUSTOMERSURVEY VALUES REC_TA0191;

             END ;
        END IF;





        EXCEPTION WHEN OTHERS THEN
             VL_STATUS := -1;
             VL_MESSAGE_H := SUBSTR(VL_MESSAGE_H||' '||VL_MESSAGE_D||' '||dbms_utility.format_error_backtrace() || ' ' || SQLERRM,1,4000);

             PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                           VL_PROGR_D_TA0191,
                                           SQLCODE,
                                           VL_MESSAGE_H);

        END; -- HEAD TA0191


       -- -----------------------------------
        -- TA0192USER DIVISION INFO
        -- -----------------------------------
        BEGIN
        --
        IF ( VL_STATUS = 0  ) THEN
              -- Division info TA0192CUSTOMERSURVEYDET

              FOR RL_XIN_TA0192 IN CL_XIN_TA0192( RL_XIN_TA0191.IDSURVEY, RL_XIN_TA0191.SM1_DTECRE) LOOP

                VL_MESSAGE_H := 'Detail Info: '||VL_IDSURVEY || '/' ||
                                             RL_XIN_TA0192.CODART || '/' ||
                                             RL_XIN_TA0192.CODDIV;

                  VL_MESSAGE_D := 'Format Conversion ';
                  VL_CODDIV:= RL_XIN_TA0192.CODDIV;
                  REC_TA0192.IDSURVEY := REC_TA0191.IDSURVEY;
                  REC_TA0192.CODART := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_TA0192.CODART,'CODART', VL_DES_TA0192,VL_STATUS, VL_MESSAGE_D);
                  REC_TA0192.CODDIV := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_TA0192.CODDIV,'CODDIV', VL_DES_TA0192,VL_STATUS, VL_MESSAGE_D);
                  REC_TA0192.CODLOCATION := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_TA0192.CODLOCATION,'CODLOCATION', VL_DES_TA0192,VL_STATUS, VL_MESSAGE_D);
                  REC_TA0192.CODEAN13 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_TA0192.CODEAN13,'CODEAN13', VL_DES_TA0192,VL_STATUS, VL_MESSAGE_D);
                  REC_TA0192.STRMEASURE1 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_TA0192.STRMEASURE1,'STRMEASURE1', VL_DES_TA0192,VL_STATUS, VL_MESSAGE_D);
                  REC_TA0192.STRMEASURE2 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_TA0192.STRMEASURE2,'STRMEASURE2', VL_DES_TA0192,VL_STATUS, VL_MESSAGE_D);
                  REC_TA0192.STRMEASURE3 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_TA0192.STRMEASURE3,'STRMEASURE3', VL_DES_TA0192,VL_STATUS, VL_MESSAGE_D);
                  REC_TA0192.STRMEASURE4 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_TA0192.STRMEASURE4,'STRMEASURE4', VL_DES_TA0192,VL_STATUS, VL_MESSAGE_D);
                  REC_TA0192.STRMEASURE5 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_TA0192.STRMEASURE5,'STRMEASURE5', VL_DES_TA0192,VL_STATUS, VL_MESSAGE_D);
                  REC_TA0192.STRMEASURE6 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_TA0192.STRMEASURE6,'STRMEASURE6', VL_DES_TA0192,VL_STATUS, VL_MESSAGE_D);
                  REC_TA0192.STRMEASURE7 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_TA0192.STRMEASURE7,'STRMEASURE7', VL_DES_TA0192,VL_STATUS, VL_MESSAGE_D);
                  REC_TA0192.STRMEASURE8 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_TA0192.STRMEASURE8,'STRMEASURE8', VL_DES_TA0192,VL_STATUS, VL_MESSAGE_D);
                  REC_TA0192.STRMEASURE9 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_TA0192.STRMEASURE9,'STRMEASURE9', VL_DES_TA0192,VL_STATUS, VL_MESSAGE_D);
                  REC_TA0192.STRMEASURE10 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_TA0192.STRMEASURE10,'STRMEASURE10', VL_DES_TA0192,VL_STATUS, VL_MESSAGE_D);
                  REC_TA0192.STRMEASURE11 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_TA0192.STRMEASURE11,'STRMEASURE11', VL_DES_TA0192,VL_STATUS, VL_MESSAGE_D);
                  REC_TA0192.STRMEASURE12 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_TA0192.STRMEASURE12,'STRMEASURE12', VL_DES_TA0192,VL_STATUS, VL_MESSAGE_D);
                  REC_TA0192.STRMEASURE13 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_TA0192.STRMEASURE13,'STRMEASURE13', VL_DES_TA0192,VL_STATUS, VL_MESSAGE_D);
                  REC_TA0192.STRMEASURE14 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_TA0192.STRMEASURE14,'STRMEASURE14', VL_DES_TA0192,VL_STATUS, VL_MESSAGE_D);
                  REC_TA0192.STRMEASURE15 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_TA0192.STRMEASURE15,'STRMEASURE15', VL_DES_TA0192,VL_STATUS, VL_MESSAGE_D);
                  REC_TA0192.STRMEASURE16 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_TA0192.STRMEASURE16,'STRMEASURE16', VL_DES_TA0192,VL_STATUS, VL_MESSAGE_D);
                  REC_TA0192.STRMEASURE17 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_TA0192.STRMEASURE17,'STRMEASURE17', VL_DES_TA0192,VL_STATUS, VL_MESSAGE_D);
                  REC_TA0192.STRMEASURE18 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_TA0192.STRMEASURE18,'STRMEASURE18', VL_DES_TA0192,VL_STATUS, VL_MESSAGE_D);
                  REC_TA0192.STRMEASURE19 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_TA0192.STRMEASURE19,'STRMEASURE19', VL_DES_TA0192,VL_STATUS, VL_MESSAGE_D);
                  REC_TA0192.STRMEASURE20 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_TA0192.STRMEASURE20,'STRMEASURE20', VL_DES_TA0192,VL_STATUS, VL_MESSAGE_D);
                  REC_TA0192.STRMEASURE21 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_TA0192.STRMEASURE21,'STRMEASURE21', VL_DES_TA0192,VL_STATUS, VL_MESSAGE_D);
                  REC_TA0192.STRMEASURE22 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_TA0192.STRMEASURE22,'STRMEASURE22', VL_DES_TA0192,VL_STATUS, VL_MESSAGE_D);
                  REC_TA0192.STRMEASURE23 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_TA0192.STRMEASURE23,'STRMEASURE23', VL_DES_TA0192,VL_STATUS, VL_MESSAGE_D);
                  REC_TA0192.STRMEASURE24 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_TA0192.STRMEASURE24,'STRMEASURE24', VL_DES_TA0192,VL_STATUS, VL_MESSAGE_D);
                  REC_TA0192.STRMEASURE25 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_TA0192.STRMEASURE25,'STRMEASURE25', VL_DES_TA0192,VL_STATUS, VL_MESSAGE_D);
                  REC_TA0192.STRMEASURE26 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_TA0192.STRMEASURE26,'STRMEASURE26', VL_DES_TA0192,VL_STATUS, VL_MESSAGE_D);
                  REC_TA0192.STRMEASURE27 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_TA0192.STRMEASURE27,'STRMEASURE27', VL_DES_TA0192,VL_STATUS, VL_MESSAGE_D);
                  REC_TA0192.STRMEASURE28 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_TA0192.STRMEASURE28,'STRMEASURE28', VL_DES_TA0192,VL_STATUS, VL_MESSAGE_D);
                  REC_TA0192.STRMEASURE29 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_TA0192.STRMEASURE29,'STRMEASURE29', VL_DES_TA0192,VL_STATUS, VL_MESSAGE_D);
                  REC_TA0192.STRMEASURE30 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_TA0192.STRMEASURE30,'STRMEASURE30', VL_DES_TA0192,VL_STATUS, VL_MESSAGE_D);
                  REC_TA0192.STRMEASURE31 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_TA0192.STRMEASURE31,'STRMEASURE31', VL_DES_TA0192,VL_STATUS, VL_MESSAGE_D);
                  REC_TA0192.STRMEASURE32 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_TA0192.STRMEASURE32,'STRMEASURE32', VL_DES_TA0192,VL_STATUS, VL_MESSAGE_D);
                  REC_TA0192.STRMEASURE33 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_TA0192.STRMEASURE33,'STRMEASURE33', VL_DES_TA0192,VL_STATUS, VL_MESSAGE_D);
                  REC_TA0192.STRMEASURE34 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_TA0192.STRMEASURE34,'STRMEASURE34', VL_DES_TA0192,VL_STATUS, VL_MESSAGE_D);
                  REC_TA0192.STRMEASURE35 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_TA0192.STRMEASURE35,'STRMEASURE35', VL_DES_TA0192,VL_STATUS, VL_MESSAGE_D);
                  REC_TA0192.STRMEASURE36 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_TA0192.STRMEASURE36,'STRMEASURE36', VL_DES_TA0192,VL_STATUS, VL_MESSAGE_D);
                  REC_TA0192.STRMEASURE37 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_TA0192.STRMEASURE37,'STRMEASURE37', VL_DES_TA0192,VL_STATUS, VL_MESSAGE_D);
                  REC_TA0192.STRMEASURE38 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_TA0192.STRMEASURE38,'STRMEASURE38', VL_DES_TA0192,VL_STATUS, VL_MESSAGE_D);
                  REC_TA0192.STRMEASURE39 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_TA0192.STRMEASURE39,'STRMEASURE39', VL_DES_TA0192,VL_STATUS, VL_MESSAGE_D);
                  REC_TA0192.STRMEASURE40 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_TA0192.STRMEASURE40,'STRMEASURE40', VL_DES_TA0192,VL_STATUS, VL_MESSAGE_D);
                  REC_TA0192.STRMEASURE41 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_TA0192.STRMEASURE41,'STRMEASURE41', VL_DES_TA0192,VL_STATUS, VL_MESSAGE_D);
                  REC_TA0192.STRMEASURE42 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_TA0192.STRMEASURE42,'STRMEASURE42', VL_DES_TA0192,VL_STATUS, VL_MESSAGE_D);
                  REC_TA0192.STRMEASURE43 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_TA0192.STRMEASURE43,'STRMEASURE43', VL_DES_TA0192,VL_STATUS, VL_MESSAGE_D);
                  REC_TA0192.STRMEASURE44 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_TA0192.STRMEASURE44,'STRMEASURE44', VL_DES_TA0192,VL_STATUS, VL_MESSAGE_D);
                  REC_TA0192.STRMEASURE45 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_TA0192.STRMEASURE45,'STRMEASURE45', VL_DES_TA0192,VL_STATUS, VL_MESSAGE_D);
                  REC_TA0192.STRMEASURE46 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_TA0192.STRMEASURE46,'STRMEASURE46', VL_DES_TA0192,VL_STATUS, VL_MESSAGE_D);
                  REC_TA0192.STRMEASURE47 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_TA0192.STRMEASURE47,'STRMEASURE47', VL_DES_TA0192,VL_STATUS, VL_MESSAGE_D);
                  REC_TA0192.STRMEASURE48 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_TA0192.STRMEASURE48,'STRMEASURE48', VL_DES_TA0192,VL_STATUS, VL_MESSAGE_D);
                  REC_TA0192.STRMEASURE49 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_TA0192.STRMEASURE49,'STRMEASURE49', VL_DES_TA0192,VL_STATUS, VL_MESSAGE_D);
                  REC_TA0192.STRMEASURE50 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_TA0192.STRMEASURE50,'STRMEASURE50', VL_DES_TA0192,VL_STATUS, VL_MESSAGE_D);
                  REC_TA0192.STRMEASURE51 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_TA0192.STRMEASURE51,'STRMEASURE51', VL_DES_TA0192,VL_STATUS, VL_MESSAGE_D);
                  REC_TA0192.STRMEASURE52 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_TA0192.STRMEASURE52,'STRMEASURE52', VL_DES_TA0192,VL_STATUS, VL_MESSAGE_D);
                  REC_TA0192.STRMEASURE53 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_TA0192.STRMEASURE53,'STRMEASURE53', VL_DES_TA0192,VL_STATUS, VL_MESSAGE_D);
                  REC_TA0192.STRMEASURE54 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_TA0192.STRMEASURE54,'STRMEASURE54', VL_DES_TA0192,VL_STATUS, VL_MESSAGE_D);
                  REC_TA0192.STRMEASURE55 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_TA0192.STRMEASURE55,'STRMEASURE55', VL_DES_TA0192,VL_STATUS, VL_MESSAGE_D);
                  REC_TA0192.STRMEASURE56 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_TA0192.STRMEASURE56,'STRMEASURE56', VL_DES_TA0192,VL_STATUS, VL_MESSAGE_D);
                  REC_TA0192.STRMEASURE57 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_TA0192.STRMEASURE57,'STRMEASURE57', VL_DES_TA0192,VL_STATUS, VL_MESSAGE_D);
                  REC_TA0192.STRMEASURE58 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_TA0192.STRMEASURE58,'STRMEASURE58', VL_DES_TA0192,VL_STATUS, VL_MESSAGE_D);
                  REC_TA0192.STRMEASURE59 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_TA0192.STRMEASURE59,'STRMEASURE59', VL_DES_TA0192,VL_STATUS, VL_MESSAGE_D);
                  REC_TA0192.STRMEASURE60 := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_TA0192.STRMEASURE60,'STRMEASURE60', VL_DES_TA0192,VL_STATUS, VL_MESSAGE_D);
                  REC_TA0192.LNGMEASURE1 := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_TA0192.LNGMEASURE1,'LNGMEASURE1', VL_DES_TA0192,VL_STATUS, VL_MESSAGE_D);
                  REC_TA0192.LNGMEASURE2 := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_TA0192.LNGMEASURE2,'LNGMEASURE2', VL_DES_TA0192,VL_STATUS, VL_MESSAGE_D);
                  REC_TA0192.LNGMEASURE3 := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_TA0192.LNGMEASURE3,'LNGMEASURE3', VL_DES_TA0192,VL_STATUS, VL_MESSAGE_D);
                  REC_TA0192.LNGMEASURE4 := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_TA0192.LNGMEASURE4,'LNGMEASURE4', VL_DES_TA0192,VL_STATUS, VL_MESSAGE_D);
                  REC_TA0192.LNGMEASURE5 := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_TA0192.LNGMEASURE5,'LNGMEASURE5', VL_DES_TA0192,VL_STATUS, VL_MESSAGE_D);
                  REC_TA0192.LNGMEASURE6 := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_TA0192.LNGMEASURE6,'LNGMEASURE6', VL_DES_TA0192,VL_STATUS, VL_MESSAGE_D);
                  REC_TA0192.LNGMEASURE7 := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_TA0192.LNGMEASURE7,'LNGMEASURE7', VL_DES_TA0192,VL_STATUS, VL_MESSAGE_D);
                  REC_TA0192.LNGMEASURE8 := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_TA0192.LNGMEASURE8,'LNGMEASURE8', VL_DES_TA0192,VL_STATUS, VL_MESSAGE_D);
                  REC_TA0192.LNGMEASURE9 := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_TA0192.LNGMEASURE9,'LNGMEASURE9', VL_DES_TA0192,VL_STATUS, VL_MESSAGE_D);
                  REC_TA0192.LNGMEASURE10 := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_TA0192.LNGMEASURE10,'LNGMEASURE10', VL_DES_TA0192,VL_STATUS, VL_MESSAGE_D);
                  REC_TA0192.DBLMEASURE1 := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_TA0192.DBLMEASURE1,'DBLMEASURE1', VL_DES_TA0192,VL_STATUS, VL_MESSAGE_D);
                  REC_TA0192.DBLMEASURE2 := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_TA0192.DBLMEASURE2,'DBLMEASURE2', VL_DES_TA0192,VL_STATUS, VL_MESSAGE_D);
                  REC_TA0192.DBLMEASURE3 := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_TA0192.DBLMEASURE3,'DBLMEASURE3', VL_DES_TA0192,VL_STATUS, VL_MESSAGE_D);
                  REC_TA0192.DBLMEASURE4 := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_TA0192.DBLMEASURE4,'DBLMEASURE4', VL_DES_TA0192,VL_STATUS, VL_MESSAGE_D);
                  REC_TA0192.DBLMEASURE5 := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_TA0192.DBLMEASURE5,'DBLMEASURE5', VL_DES_TA0192,VL_STATUS, VL_MESSAGE_D);
                  REC_TA0192.DBLMEASURE6 := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_TA0192.DBLMEASURE6,'DBLMEASURE6', VL_DES_TA0192,VL_STATUS, VL_MESSAGE_D);
                  REC_TA0192.DBLMEASURE7 := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_TA0192.DBLMEASURE7,'DBLMEASURE7', VL_DES_TA0192,VL_STATUS, VL_MESSAGE_D);
                  REC_TA0192.DBLMEASURE8 := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_TA0192.DBLMEASURE8,'DBLMEASURE8', VL_DES_TA0192,VL_STATUS, VL_MESSAGE_D);
                  REC_TA0192.DBLMEASURE9 := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_TA0192.DBLMEASURE9,'DBLMEASURE9', VL_DES_TA0192,VL_STATUS, VL_MESSAGE_D);
                  REC_TA0192.DBLMEASURE10 := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_TA0192.DBLMEASURE10,'DBLMEASURE10', VL_DES_TA0192,VL_STATUS, VL_MESSAGE_D);

                  REC_TA0192.DBLMEASURE11 := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_TA0192.DBLMEASURE11,'DBLMEASURE11', VL_DES_TA0192,VL_STATUS, VL_MESSAGE_D);
                  REC_TA0192.DBLMEASURE12 := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_TA0192.DBLMEASURE12,'DBLMEASURE12', VL_DES_TA0192,VL_STATUS, VL_MESSAGE_D);
                  REC_TA0192.DBLMEASURE13 := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_TA0192.DBLMEASURE13,'DBLMEASURE13', VL_DES_TA0192,VL_STATUS, VL_MESSAGE_D);
                  REC_TA0192.DBLMEASURE14 := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_TA0192.DBLMEASURE14,'DBLMEASURE14', VL_DES_TA0192,VL_STATUS, VL_MESSAGE_D);
                  REC_TA0192.DBLMEASURE15 := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_TA0192.DBLMEASURE15,'DBLMEASURE15', VL_DES_TA0192,VL_STATUS, VL_MESSAGE_D);
                  REC_TA0192.DBLMEASURE16 := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_TA0192.DBLMEASURE16,'DBLMEASURE16', VL_DES_TA0192,VL_STATUS, VL_MESSAGE_D);
                  REC_TA0192.DBLMEASURE17 := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_TA0192.DBLMEASURE17,'DBLMEASURE17', VL_DES_TA0192,VL_STATUS, VL_MESSAGE_D);
                  REC_TA0192.DBLMEASURE18 := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_TA0192.DBLMEASURE18,'DBLMEASURE18', VL_DES_TA0192,VL_STATUS, VL_MESSAGE_D);
                  REC_TA0192.DBLMEASURE19 := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_TA0192.DBLMEASURE19,'DBLMEASURE19', VL_DES_TA0192,VL_STATUS, VL_MESSAGE_D);
                  REC_TA0192.DBLMEASURE20 := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_TA0192.DBLMEASURE20,'DBLMEASURE20', VL_DES_TA0192,VL_STATUS, VL_MESSAGE_D);

                  REC_TA0192.DTEMEASURE1 := F_CHECK_FORMAT_D( VL_CODDIV,   RL_XIN_TA0192.DTEMEASURE1,'DTEMEASURE1', VL_DES_TA0192,VL_STATUS, VL_MESSAGE_D);
                  REC_TA0192.DTEMEASURE2 := F_CHECK_FORMAT_D( VL_CODDIV,   RL_XIN_TA0192.DTEMEASURE2,'DTEMEASURE2', VL_DES_TA0192,VL_STATUS, VL_MESSAGE_D);
                  REC_TA0192.DTEMEASURE3 := F_CHECK_FORMAT_D( VL_CODDIV,   RL_XIN_TA0192.DTEMEASURE3,'DTEMEASURE3', VL_DES_TA0192,VL_STATUS, VL_MESSAGE_D);
                  REC_TA0192.DTEMEASURE4 := F_CHECK_FORMAT_D( VL_CODDIV,   RL_XIN_TA0192.DTEMEASURE4,'DTEMEASURE4', VL_DES_TA0192,VL_STATUS, VL_MESSAGE_D);
                  REC_TA0192.DTEMEASURE5 := F_CHECK_FORMAT_D( VL_CODDIV,   RL_XIN_TA0192.DTEMEASURE5,'DTEMEASURE5', VL_DES_TA0192,VL_STATUS, VL_MESSAGE_D);
                  REC_TA0192.DTEMEASURE6 := F_CHECK_FORMAT_D( VL_CODDIV,   RL_XIN_TA0192.DTEMEASURE6,'DTEMEASURE6', VL_DES_TA0192,VL_STATUS, VL_MESSAGE_D);
                  REC_TA0192.DTEMEASURE7 := F_CHECK_FORMAT_D( VL_CODDIV,   RL_XIN_TA0192.DTEMEASURE7,'DTEMEASURE7', VL_DES_TA0192,VL_STATUS, VL_MESSAGE_D);
                  REC_TA0192.DTEMEASURE8 := F_CHECK_FORMAT_D( VL_CODDIV,   RL_XIN_TA0192.DTEMEASURE8,'DTEMEASURE8', VL_DES_TA0192,VL_STATUS, VL_MESSAGE_D);
                  REC_TA0192.DTEMEASURE9 := F_CHECK_FORMAT_D( VL_CODDIV,   RL_XIN_TA0192.DTEMEASURE9,'DTEMEASURE9', VL_DES_TA0192,VL_STATUS, VL_MESSAGE_D);
                  REC_TA0192.DTEMEASURE10 := F_CHECK_FORMAT_D( VL_CODDIV,   RL_XIN_TA0192.DTEMEASURE10,'DTEMEASURE10', VL_DES_TA0192,VL_STATUS, VL_MESSAGE_D);
                  REC_TA0192.LNGMEASURE11 := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_TA0192.LNGMEASURE11,'LNGMEASURE11', VL_DES_TA0192,VL_STATUS, VL_MESSAGE_D);
                  REC_TA0192.LNGMEASURE12 := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_TA0192.LNGMEASURE12,'LNGMEASURE12', VL_DES_TA0192,VL_STATUS, VL_MESSAGE_D);
                  REC_TA0192.LNGMEASURE13 := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_TA0192.LNGMEASURE13,'LNGMEASURE13', VL_DES_TA0192,VL_STATUS, VL_MESSAGE_D);
                  REC_TA0192.LNGMEASURE14 := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_TA0192.LNGMEASURE14,'LNGMEASURE14', VL_DES_TA0192,VL_STATUS, VL_MESSAGE_D);
                  REC_TA0192.LNGMEASURE15 := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_TA0192.LNGMEASURE15,'LNGMEASURE15', VL_DES_TA0192,VL_STATUS, VL_MESSAGE_D);
                  REC_TA0192.LNGMEASURE16 := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_TA0192.LNGMEASURE16,'LNGMEASURE16', VL_DES_TA0192,VL_STATUS, VL_MESSAGE_D);
                  REC_TA0192.LNGMEASURE17 := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_TA0192.LNGMEASURE17,'LNGMEASURE17', VL_DES_TA0192,VL_STATUS, VL_MESSAGE_D);
                  REC_TA0192.LNGMEASURE18 := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_TA0192.LNGMEASURE18,'LNGMEASURE18', VL_DES_TA0192,VL_STATUS, VL_MESSAGE_D);
                  REC_TA0192.LNGMEASURE19 := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_TA0192.LNGMEASURE19,'LNGMEASURE19', VL_DES_TA0192,VL_STATUS, VL_MESSAGE_D);
                  REC_TA0192.LNGMEASURE20 := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_TA0192.LNGMEASURE20,'LNGMEASURE20', VL_DES_TA0192,VL_STATUS, VL_MESSAGE_D);
                  REC_TA0192.LNGMEASURE21 := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_TA0192.LNGMEASURE21,'LNGMEASURE21', VL_DES_TA0192,VL_STATUS, VL_MESSAGE_D);
                  REC_TA0192.LNGMEASURE22 := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_TA0192.LNGMEASURE22,'LNGMEASURE22', VL_DES_TA0192,VL_STATUS, VL_MESSAGE_D);
                  REC_TA0192.LNGMEASURE23 := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_TA0192.LNGMEASURE23,'LNGMEASURE23', VL_DES_TA0192,VL_STATUS, VL_MESSAGE_D);
                  REC_TA0192.LNGMEASURE24 := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_TA0192.LNGMEASURE24,'LNGMEASURE24', VL_DES_TA0192,VL_STATUS, VL_MESSAGE_D);
                  REC_TA0192.LNGMEASURE25 := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_TA0192.LNGMEASURE25,'LNGMEASURE25', VL_DES_TA0192,VL_STATUS, VL_MESSAGE_D);
                  REC_TA0192.LNGMEASURE26 := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_TA0192.LNGMEASURE26,'LNGMEASURE26', VL_DES_TA0192,VL_STATUS, VL_MESSAGE_D);
                  REC_TA0192.LNGMEASURE27 := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_TA0192.LNGMEASURE27,'LNGMEASURE27', VL_DES_TA0192,VL_STATUS, VL_MESSAGE_D);
                  REC_TA0192.LNGMEASURE28 := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_TA0192.LNGMEASURE28,'LNGMEASURE28', VL_DES_TA0192,VL_STATUS, VL_MESSAGE_D);
                  REC_TA0192.LNGMEASURE29 := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_TA0192.LNGMEASURE29,'LNGMEASURE29', VL_DES_TA0192,VL_STATUS, VL_MESSAGE_D);
                  REC_TA0192.LNGMEASURE30 := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_TA0192.LNGMEASURE30,'LNGMEASURE30', VL_DES_TA0192,VL_STATUS, VL_MESSAGE_D);
                  REC_TA0192.FLGMEASURE1 := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_TA0192.FLGMEASURE1,'FLGMEASURE1', VL_DES_TA0192,VL_STATUS, VL_MESSAGE_D);
                  REC_TA0192.FLGMEASURE2 := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_TA0192.FLGMEASURE2,'FLGMEASURE2', VL_DES_TA0192,VL_STATUS, VL_MESSAGE_D);
                  REC_TA0192.FLGMEASURE3 := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_TA0192.FLGMEASURE3,'FLGMEASURE3', VL_DES_TA0192,VL_STATUS, VL_MESSAGE_D);
                  REC_TA0192.FLGMEASURE4 := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_TA0192.FLGMEASURE4,'FLGMEASURE4', VL_DES_TA0192,VL_STATUS, VL_MESSAGE_D);
                  REC_TA0192.FLGMEASURE5 := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_TA0192.FLGMEASURE5,'FLGMEASURE5', VL_DES_TA0192,VL_STATUS, VL_MESSAGE_D);
                  REC_TA0192.FLGMEASURE6 := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_TA0192.FLGMEASURE6,'FLGMEASURE6', VL_DES_TA0192,VL_STATUS, VL_MESSAGE_D);
                  REC_TA0192.FLGMEASURE7 := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_TA0192.FLGMEASURE7,'FLGMEASURE7', VL_DES_TA0192,VL_STATUS, VL_MESSAGE_D);
                  REC_TA0192.FLGMEASURE8 := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_TA0192.FLGMEASURE8,'FLGMEASURE8', VL_DES_TA0192,VL_STATUS, VL_MESSAGE_D);
                  REC_TA0192.FLGMEASURE9 := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_TA0192.FLGMEASURE9,'FLGMEASURE9', VL_DES_TA0192,VL_STATUS, VL_MESSAGE_D);
                  REC_TA0192.FLGMEASURE10 := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_TA0192.FLGMEASURE10,'FLGMEASURE10', VL_DES_TA0192,VL_STATUS, VL_MESSAGE_D);


                 IF (VL_STATUS <> 0 ) THEN
                   VL_MESSAGE_H := SUBSTR(VL_MESSAGE_H||' '||VL_MESSAGE_D||' '||dbms_utility.format_error_backtrace() || ' ' || SQLERRM,1,4000);
                   PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                           VL_PROGR_D_TA0192,
                                           SQLCODE,
                                           VL_MESSAGE_H);
                 END IF;

                --
                IF (VL_STATUS = 0 ) THEN
                VL_MESSAGE_D := 'Update TA0192 ';
                UPDATE TA0192CUSTOMERSURVEYDET
                   SET
                      CODART = CASE VL_DES_TA0192('CODART.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0192.CODART ELSE CODART END,
                      CODDIV = CASE VL_DES_TA0192('CODDIV.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0192.CODDIV ELSE CODDIV END,
                      CODLOCATION = CASE VL_DES_TA0192('CODLOCATION.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0192.CODLOCATION ELSE CODLOCATION END,
                      CODEAN13 = CASE VL_DES_TA0192('CODEAN13.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0192.CODEAN13 ELSE CODEAN13 END,
                      STRMEASURE1 = CASE VL_DES_TA0192('STRMEASURE1.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0192.STRMEASURE1 ELSE STRMEASURE1 END,
                      STRMEASURE2 = CASE VL_DES_TA0192('STRMEASURE2.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0192.STRMEASURE2 ELSE STRMEASURE2 END,
                      STRMEASURE3 = CASE VL_DES_TA0192('STRMEASURE3.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0192.STRMEASURE3 ELSE STRMEASURE3 END,
                      STRMEASURE4 = CASE VL_DES_TA0192('STRMEASURE4.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0192.STRMEASURE4 ELSE STRMEASURE4 END,
                      STRMEASURE5 = CASE VL_DES_TA0192('STRMEASURE5.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0192.STRMEASURE5 ELSE STRMEASURE5 END,
                      STRMEASURE6 = CASE VL_DES_TA0192('STRMEASURE6.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0192.STRMEASURE6 ELSE STRMEASURE6 END,
                      STRMEASURE7 = CASE VL_DES_TA0192('STRMEASURE7.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0192.STRMEASURE7 ELSE STRMEASURE7 END,
                      STRMEASURE8 = CASE VL_DES_TA0192('STRMEASURE8.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0192.STRMEASURE8 ELSE STRMEASURE8 END,
                      STRMEASURE9 = CASE VL_DES_TA0192('STRMEASURE9.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0192.STRMEASURE9 ELSE STRMEASURE9 END,
                      STRMEASURE10 = CASE VL_DES_TA0192('STRMEASURE10.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0192.STRMEASURE10 ELSE STRMEASURE10 END,
                      STRMEASURE11 = CASE VL_DES_TA0192('STRMEASURE11.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0192.STRMEASURE11 ELSE STRMEASURE11 END,
                      STRMEASURE12 = CASE VL_DES_TA0192('STRMEASURE12.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0192.STRMEASURE12 ELSE STRMEASURE12 END,
                      STRMEASURE13 = CASE VL_DES_TA0192('STRMEASURE13.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0192.STRMEASURE13 ELSE STRMEASURE13 END,
                      STRMEASURE14 = CASE VL_DES_TA0192('STRMEASURE14.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0192.STRMEASURE14 ELSE STRMEASURE14 END,
                      STRMEASURE15 = CASE VL_DES_TA0192('STRMEASURE15.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0192.STRMEASURE15 ELSE STRMEASURE15 END,
                      STRMEASURE16 = CASE VL_DES_TA0192('STRMEASURE16.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0192.STRMEASURE16 ELSE STRMEASURE16 END,
                      STRMEASURE17 = CASE VL_DES_TA0192('STRMEASURE17.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0192.STRMEASURE17 ELSE STRMEASURE17 END,
                      STRMEASURE18 = CASE VL_DES_TA0192('STRMEASURE18.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0192.STRMEASURE18 ELSE STRMEASURE18 END,
                      STRMEASURE19 = CASE VL_DES_TA0192('STRMEASURE19.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0192.STRMEASURE19 ELSE STRMEASURE19 END,
                      STRMEASURE20 = CASE VL_DES_TA0192('STRMEASURE20.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0192.STRMEASURE20 ELSE STRMEASURE20 END,
                      STRMEASURE21 = CASE VL_DES_TA0192('STRMEASURE21.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0192.STRMEASURE21 ELSE STRMEASURE21 END,
                      STRMEASURE22 = CASE VL_DES_TA0192('STRMEASURE22.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0192.STRMEASURE22 ELSE STRMEASURE22 END,
                      STRMEASURE23 = CASE VL_DES_TA0192('STRMEASURE23.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0192.STRMEASURE23 ELSE STRMEASURE23 END,
                      STRMEASURE24 = CASE VL_DES_TA0192('STRMEASURE24.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0192.STRMEASURE24 ELSE STRMEASURE24 END,
                      STRMEASURE25 = CASE VL_DES_TA0192('STRMEASURE25.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0192.STRMEASURE25 ELSE STRMEASURE25 END,
                      STRMEASURE26 = CASE VL_DES_TA0192('STRMEASURE26.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0192.STRMEASURE26 ELSE STRMEASURE26 END,
                      STRMEASURE27 = CASE VL_DES_TA0192('STRMEASURE27.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0192.STRMEASURE27 ELSE STRMEASURE27 END,
                      STRMEASURE28 = CASE VL_DES_TA0192('STRMEASURE28.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0192.STRMEASURE28 ELSE STRMEASURE28 END,
                      STRMEASURE29 = CASE VL_DES_TA0192('STRMEASURE29.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0192.STRMEASURE29 ELSE STRMEASURE29 END,
                      STRMEASURE30 = CASE VL_DES_TA0192('STRMEASURE30.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0192.STRMEASURE30 ELSE STRMEASURE30 END,
                      STRMEASURE31 = CASE VL_DES_TA0192('STRMEASURE31.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0192.STRMEASURE31 ELSE STRMEASURE31 END,
                      STRMEASURE32 = CASE VL_DES_TA0192('STRMEASURE32.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0192.STRMEASURE32 ELSE STRMEASURE32 END,
                      STRMEASURE33 = CASE VL_DES_TA0192('STRMEASURE33.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0192.STRMEASURE33 ELSE STRMEASURE33 END,
                      STRMEASURE34 = CASE VL_DES_TA0192('STRMEASURE34.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0192.STRMEASURE34 ELSE STRMEASURE34 END,
                      STRMEASURE35 = CASE VL_DES_TA0192('STRMEASURE35.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0192.STRMEASURE35 ELSE STRMEASURE35 END,
                      STRMEASURE36 = CASE VL_DES_TA0192('STRMEASURE36.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0192.STRMEASURE36 ELSE STRMEASURE36 END,
                      STRMEASURE37 = CASE VL_DES_TA0192('STRMEASURE37.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0192.STRMEASURE37 ELSE STRMEASURE37 END,
                      STRMEASURE38 = CASE VL_DES_TA0192('STRMEASURE38.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0192.STRMEASURE38 ELSE STRMEASURE38 END,
                      STRMEASURE39 = CASE VL_DES_TA0192('STRMEASURE39.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0192.STRMEASURE39 ELSE STRMEASURE39 END,
                      STRMEASURE40 = CASE VL_DES_TA0192('STRMEASURE40.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0192.STRMEASURE40 ELSE STRMEASURE40 END,
                      STRMEASURE41 = CASE VL_DES_TA0192('STRMEASURE41.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0192.STRMEASURE41 ELSE STRMEASURE41 END,
                      STRMEASURE42 = CASE VL_DES_TA0192('STRMEASURE42.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0192.STRMEASURE42 ELSE STRMEASURE42 END,
                      STRMEASURE43 = CASE VL_DES_TA0192('STRMEASURE43.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0192.STRMEASURE43 ELSE STRMEASURE43 END,
                      STRMEASURE44 = CASE VL_DES_TA0192('STRMEASURE44.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0192.STRMEASURE44 ELSE STRMEASURE44 END,
                      STRMEASURE45 = CASE VL_DES_TA0192('STRMEASURE45.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0192.STRMEASURE45 ELSE STRMEASURE45 END,
                      STRMEASURE46 = CASE VL_DES_TA0192('STRMEASURE46.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0192.STRMEASURE46 ELSE STRMEASURE46 END,
                      STRMEASURE47 = CASE VL_DES_TA0192('STRMEASURE47.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0192.STRMEASURE47 ELSE STRMEASURE47 END,
                      STRMEASURE48 = CASE VL_DES_TA0192('STRMEASURE48.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0192.STRMEASURE48 ELSE STRMEASURE48 END,
                      STRMEASURE49 = CASE VL_DES_TA0192('STRMEASURE49.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0192.STRMEASURE49 ELSE STRMEASURE49 END,
                      STRMEASURE50 = CASE VL_DES_TA0192('STRMEASURE50.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0192.STRMEASURE50 ELSE STRMEASURE50 END,
                      STRMEASURE51 = CASE VL_DES_TA0192('STRMEASURE51.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0192.STRMEASURE51 ELSE STRMEASURE51 END,
                      STRMEASURE52 = CASE VL_DES_TA0192('STRMEASURE52.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0192.STRMEASURE52 ELSE STRMEASURE52 END,
                      STRMEASURE53 = CASE VL_DES_TA0192('STRMEASURE53.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0192.STRMEASURE53 ELSE STRMEASURE53 END,
                      STRMEASURE54 = CASE VL_DES_TA0192('STRMEASURE54.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0192.STRMEASURE54 ELSE STRMEASURE54 END,
                      STRMEASURE55 = CASE VL_DES_TA0192('STRMEASURE55.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0192.STRMEASURE55 ELSE STRMEASURE55 END,
                      STRMEASURE56 = CASE VL_DES_TA0192('STRMEASURE56.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0192.STRMEASURE56 ELSE STRMEASURE56 END,
                      STRMEASURE57 = CASE VL_DES_TA0192('STRMEASURE57.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0192.STRMEASURE57 ELSE STRMEASURE57 END,
                      STRMEASURE58 = CASE VL_DES_TA0192('STRMEASURE58.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0192.STRMEASURE58 ELSE STRMEASURE58 END,
                      STRMEASURE59 = CASE VL_DES_TA0192('STRMEASURE59.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0192.STRMEASURE59 ELSE STRMEASURE59 END,
                      STRMEASURE60 = CASE VL_DES_TA0192('STRMEASURE60.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0192.STRMEASURE60 ELSE STRMEASURE60 END,
                      LNGMEASURE1 = CASE VL_DES_TA0192('LNGMEASURE1.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0192.LNGMEASURE1 ELSE LNGMEASURE1 END,
                      LNGMEASURE2 = CASE VL_DES_TA0192('LNGMEASURE2.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0192.LNGMEASURE2 ELSE LNGMEASURE2 END,
                      LNGMEASURE3 = CASE VL_DES_TA0192('LNGMEASURE3.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0192.LNGMEASURE3 ELSE LNGMEASURE3 END,
                      LNGMEASURE4 = CASE VL_DES_TA0192('LNGMEASURE4.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0192.LNGMEASURE4 ELSE LNGMEASURE4 END,
                      LNGMEASURE5 = CASE VL_DES_TA0192('LNGMEASURE5.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0192.LNGMEASURE5 ELSE LNGMEASURE5 END,
                      LNGMEASURE6 = CASE VL_DES_TA0192('LNGMEASURE6.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0192.LNGMEASURE6 ELSE LNGMEASURE6 END,
                      LNGMEASURE7 = CASE VL_DES_TA0192('LNGMEASURE7.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0192.LNGMEASURE7 ELSE LNGMEASURE7 END,
                      LNGMEASURE8 = CASE VL_DES_TA0192('LNGMEASURE8.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0192.LNGMEASURE8 ELSE LNGMEASURE8 END,
                      LNGMEASURE9 = CASE VL_DES_TA0192('LNGMEASURE9.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0192.LNGMEASURE9 ELSE LNGMEASURE9 END,
                      LNGMEASURE10 = CASE VL_DES_TA0192('LNGMEASURE10.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0192.LNGMEASURE10 ELSE LNGMEASURE10 END,
                      DBLMEASURE1 = CASE VL_DES_TA0192('DBLMEASURE1.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0192.DBLMEASURE1 ELSE DBLMEASURE1 END,
                      DBLMEASURE2 = CASE VL_DES_TA0192('DBLMEASURE2.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0192.DBLMEASURE2 ELSE DBLMEASURE2 END,
                      DBLMEASURE3 = CASE VL_DES_TA0192('DBLMEASURE3.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0192.DBLMEASURE3 ELSE DBLMEASURE3 END,
                      DBLMEASURE4 = CASE VL_DES_TA0192('DBLMEASURE4.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0192.DBLMEASURE4 ELSE DBLMEASURE4 END,
                      DBLMEASURE5 = CASE VL_DES_TA0192('DBLMEASURE5.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0192.DBLMEASURE5 ELSE DBLMEASURE5 END,
                      DBLMEASURE6 = CASE VL_DES_TA0192('DBLMEASURE6.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0192.DBLMEASURE6 ELSE DBLMEASURE6 END,
                      DBLMEASURE7 = CASE VL_DES_TA0192('DBLMEASURE7.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0192.DBLMEASURE7 ELSE DBLMEASURE7 END,
                      DBLMEASURE8 = CASE VL_DES_TA0192('DBLMEASURE8.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0192.DBLMEASURE8 ELSE DBLMEASURE8 END,
                      DBLMEASURE9 = CASE VL_DES_TA0192('DBLMEASURE9.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0192.DBLMEASURE9 ELSE DBLMEASURE9 END,
                      DBLMEASURE10 = CASE VL_DES_TA0192('DBLMEASURE10.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0192.DBLMEASURE10 ELSE DBLMEASURE10 END,

                      DBLMEASURE11 = CASE VL_DES_TA0192('DBLMEASURE11.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0192.DBLMEASURE11 ELSE DBLMEASURE11 END,
                      DBLMEASURE12 = CASE VL_DES_TA0192('DBLMEASURE12.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0192.DBLMEASURE12 ELSE DBLMEASURE12 END,
                      DBLMEASURE13 = CASE VL_DES_TA0192('DBLMEASURE13.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0192.DBLMEASURE13 ELSE DBLMEASURE13 END,
                      DBLMEASURE14 = CASE VL_DES_TA0192('DBLMEASURE14.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0192.DBLMEASURE14 ELSE DBLMEASURE14 END,
                      DBLMEASURE15 = CASE VL_DES_TA0192('DBLMEASURE15.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0192.DBLMEASURE15 ELSE DBLMEASURE15 END,
                      DBLMEASURE16 = CASE VL_DES_TA0192('DBLMEASURE16.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0192.DBLMEASURE16 ELSE DBLMEASURE16 END,
                      DBLMEASURE17 = CASE VL_DES_TA0192('DBLMEASURE17.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0192.DBLMEASURE17 ELSE DBLMEASURE17 END,
                      DBLMEASURE18 = CASE VL_DES_TA0192('DBLMEASURE18.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0192.DBLMEASURE18 ELSE DBLMEASURE18 END,
                      DBLMEASURE19 = CASE VL_DES_TA0192('DBLMEASURE19.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0192.DBLMEASURE19 ELSE DBLMEASURE19 END,
                      DBLMEASURE20 = CASE VL_DES_TA0192('DBLMEASURE20.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0192.DBLMEASURE20 ELSE DBLMEASURE20 END,

                      DTEMEASURE1 = CASE VL_DES_TA0192('DTEMEASURE1.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0192.DTEMEASURE1 ELSE DTEMEASURE1 END,
                      DTEMEASURE2 = CASE VL_DES_TA0192('DTEMEASURE2.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0192.DTEMEASURE2 ELSE DTEMEASURE2 END,
                      DTEMEASURE3 = CASE VL_DES_TA0192('DTEMEASURE3.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0192.DTEMEASURE3 ELSE DTEMEASURE3 END,
                      DTEMEASURE4 = CASE VL_DES_TA0192('DTEMEASURE4.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0192.DTEMEASURE4 ELSE DTEMEASURE4 END,
                      DTEMEASURE5 = CASE VL_DES_TA0192('DTEMEASURE5.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0192.DTEMEASURE5 ELSE DTEMEASURE5 END,
                      DTEMEASURE6 = CASE VL_DES_TA0192('DTEMEASURE6.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0192.DTEMEASURE6 ELSE DTEMEASURE6 END,
                      DTEMEASURE7 = CASE VL_DES_TA0192('DTEMEASURE7.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0192.DTEMEASURE7 ELSE DTEMEASURE7 END,
                      DTEMEASURE8 = CASE VL_DES_TA0192('DTEMEASURE8.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0192.DTEMEASURE8 ELSE DTEMEASURE8 END,
                      DTEMEASURE9 = CASE VL_DES_TA0192('DTEMEASURE9.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0192.DTEMEASURE9 ELSE DTEMEASURE9 END,
                      DTEMEASURE10 = CASE VL_DES_TA0192('DTEMEASURE10.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0192.DTEMEASURE10 ELSE DTEMEASURE10 END,
                      LNGMEASURE11 = CASE VL_DES_TA0192('LNGMEASURE11.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0192.LNGMEASURE11 ELSE LNGMEASURE11 END,
                      LNGMEASURE12 = CASE VL_DES_TA0192('LNGMEASURE12.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0192.LNGMEASURE12 ELSE LNGMEASURE12 END,
                      LNGMEASURE13 = CASE VL_DES_TA0192('LNGMEASURE13.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0192.LNGMEASURE13 ELSE LNGMEASURE13 END,
                      LNGMEASURE14 = CASE VL_DES_TA0192('LNGMEASURE14.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0192.LNGMEASURE14 ELSE LNGMEASURE14 END,
                      LNGMEASURE15 = CASE VL_DES_TA0192('LNGMEASURE15.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0192.LNGMEASURE15 ELSE LNGMEASURE15 END,
                      LNGMEASURE16 = CASE VL_DES_TA0192('LNGMEASURE16.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0192.LNGMEASURE16 ELSE LNGMEASURE16 END,
                      LNGMEASURE17 = CASE VL_DES_TA0192('LNGMEASURE17.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0192.LNGMEASURE17 ELSE LNGMEASURE17 END,
                      LNGMEASURE18 = CASE VL_DES_TA0192('LNGMEASURE18.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0192.LNGMEASURE18 ELSE LNGMEASURE18 END,
                      LNGMEASURE19 = CASE VL_DES_TA0192('LNGMEASURE19.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0192.LNGMEASURE19 ELSE LNGMEASURE19 END,
                      LNGMEASURE20 = CASE VL_DES_TA0192('LNGMEASURE20.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0192.LNGMEASURE20 ELSE LNGMEASURE20 END,
                      LNGMEASURE21 = CASE VL_DES_TA0192('LNGMEASURE21.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0192.LNGMEASURE21 ELSE LNGMEASURE21 END,
                      LNGMEASURE22 = CASE VL_DES_TA0192('LNGMEASURE22.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0192.LNGMEASURE22 ELSE LNGMEASURE22 END,
                      LNGMEASURE23 = CASE VL_DES_TA0192('LNGMEASURE23.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0192.LNGMEASURE23 ELSE LNGMEASURE23 END,
                      LNGMEASURE24 = CASE VL_DES_TA0192('LNGMEASURE24.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0192.LNGMEASURE24 ELSE LNGMEASURE24 END,
                      LNGMEASURE25 = CASE VL_DES_TA0192('LNGMEASURE25.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0192.LNGMEASURE25 ELSE LNGMEASURE25 END,
                      LNGMEASURE26 = CASE VL_DES_TA0192('LNGMEASURE26.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0192.LNGMEASURE26 ELSE LNGMEASURE26 END,
                      LNGMEASURE27 = CASE VL_DES_TA0192('LNGMEASURE27.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0192.LNGMEASURE27 ELSE LNGMEASURE27 END,
                      LNGMEASURE28 = CASE VL_DES_TA0192('LNGMEASURE28.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0192.LNGMEASURE28 ELSE LNGMEASURE28 END,
                      LNGMEASURE29 = CASE VL_DES_TA0192('LNGMEASURE29.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0192.LNGMEASURE29 ELSE LNGMEASURE29 END,
                      LNGMEASURE30 = CASE VL_DES_TA0192('LNGMEASURE30.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0192.LNGMEASURE30 ELSE LNGMEASURE30 END,
                      FLGMEASURE1 = CASE VL_DES_TA0192('FLGMEASURE1.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0192.FLGMEASURE1 ELSE FLGMEASURE1 END,
                      FLGMEASURE2 = CASE VL_DES_TA0192('FLGMEASURE2.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0192.FLGMEASURE2 ELSE FLGMEASURE2 END,
                      FLGMEASURE3 = CASE VL_DES_TA0192('FLGMEASURE3.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0192.FLGMEASURE3 ELSE FLGMEASURE3 END,
                      FLGMEASURE4 = CASE VL_DES_TA0192('FLGMEASURE4.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0192.FLGMEASURE4 ELSE FLGMEASURE4 END,
                      FLGMEASURE5 = CASE VL_DES_TA0192('FLGMEASURE5.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0192.FLGMEASURE5 ELSE FLGMEASURE5 END,
                      FLGMEASURE6 = CASE VL_DES_TA0192('FLGMEASURE6.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0192.FLGMEASURE6 ELSE FLGMEASURE6 END,
                      FLGMEASURE7 = CASE VL_DES_TA0192('FLGMEASURE7.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0192.FLGMEASURE7 ELSE FLGMEASURE7 END,
                      FLGMEASURE8 = CASE VL_DES_TA0192('FLGMEASURE8.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0192.FLGMEASURE8 ELSE FLGMEASURE8 END,
                      FLGMEASURE9 = CASE VL_DES_TA0192('FLGMEASURE9.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0192.FLGMEASURE9 ELSE FLGMEASURE9 END,
                      FLGMEASURE10 = CASE VL_DES_TA0192('FLGMEASURE10.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA0192.FLGMEASURE10 ELSE FLGMEASURE10 END
                 WHERE IDSURVEY    = VL_IDSURVEY
                   AND CODART      = REC_TA0192.CODART
                   AND CODLOCATION = REC_TA0192.CODLOCATION
                   AND CODDIV      = REC_TA0192.CODDIV;
                --
                IF SQL%ROWCOUNT = 0 THEN
                  -- record does not exists , we insert it
                  VL_MESSAGE_D := 'Insert TA0192 ';
                  INSERT INTO TA0192CUSTOMERSURVEYDET VALUES REC_TA0192;
                END IF;
                VL_INS_TA0192 := VL_INS_TA0192 + 1;
                --
                END IF;
         END LOOP;   --TA0192CUSTOMERSURVEYDET
       END IF;
       EXCEPTION WHEN OTHERS THEN
             VL_STATUS := -1;
             VL_MESSAGE_H := SUBSTR(VL_MESSAGE_H||' '||VL_MESSAGE_D||' '||dbms_utility.format_error_backtrace() || ' ' || SQLERRM,1,4000);

             PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                           VL_PROGR_D_TA0192,
                                           SQLCODE,
                                           VL_MESSAGE_H);

      END; -- DIVISION TA0192
      -- if all records have been stored with success then it makes the commit
      IF VL_STATUS = 0 THEN
         VL_INS_TA0191 := VL_INS_TA0191 + 1;
         COMMIT;
      ELSE
        ROLLBACK;

          UPDATE XIN_TA0192CUSTOMERSURV
          SET  SM1_STATUS= CASE
                                WHEN VL_RECORD_LOCKED <> 0  THEN C_XINSTATUS_LOCK
                                ELSE C_XINSTATUS_ERR END
          WHERE IDSURVEY = RL_XIN_TA0191.IDSURVEY
           AND  SM1_CODPROCESS = PI_PROGR_H
           AND  SM1_DTECRE     = RL_XIN_TA0191.SM1_DTECRE
           AND  SM1_STATUS     = C_XINSTATUS_OK;

          -- TO CHECK this update is  not correct in case of double record .
          UPDATE XIN_TA0191CUSTOMERSURV
          SET  SM1_STATUS= CASE
                                WHEN VL_RECORD_LOCKED <> 0  THEN C_XINSTATUS_LOCK
                                ELSE C_XINSTATUS_ERR END
          WHERE IDSURVEY = RL_XIN_TA0191.IDSURVEY
           AND  SM1_CODPROCESS = PI_PROGR_H
           AND  SM1_DTECRE     <= RL_XIN_TA0191.SM1_DTECRE
           AND  SM1_STATUS     = C_XINSTATUS_OK;

          COMMIT;

      END IF;

        -- Release updated records
          UPDATE TA0191CUSTOMERSURVEY
          SET       DTELCK          = NULL,
                    IDSESSIONLCK    = NULL,
                    CODUSRLCK       = NULL
          WHERE IDSURVEY = vl_IDSURVEY AND CODUSRLCK = C_SYSUSR AND IDSESSIONLCK = PI_SESSION_ID;
          COMMIT;
    END LOOP;  -- TA0191CUSTOMERSURVEY


    -- Moves records from staging area to log staging area
    P_XIN_MOVE_TO_LOG(PI_PROGR_H, VL_PROGR_D_TA0191,'TA0192CUSTOMERSURV');
    P_XIN_MOVE_TO_LOG(PI_PROGR_H, VL_PROGR_D_TA0191,'TA0191CUSTOMERSURV');

   -- Close Logs
    PKG_UTILS.LOG_END_DETAIL(PI_PROGR_H,
                             VL_PROGR_D_TA0192,
                             0,
                             VL_COUNT_XIN_TA0192,
                             VL_INS_TA0192,
                             VL_COUNT_XIN_TA0192 - VL_INS_TA0192);

    PKG_UTILS.LOG_END_DETAIL(PI_PROGR_H,
                             VL_PROGR_D_TA0191,
                             0,
                             VL_COUNT_XIN_TA0191,
                             VL_INS_TA0191,
                             VL_COUNT_XIN_TA0191 - VL_INS_TA0191);


    PO_MSG    := VL_INS_TA0191||'/'||VL_COUNT_XIN_TA0191||' Activities loaded';
    PO_STATUS := VL_INS_TA0191;


    --
  EXCEPTION WHEN EX_EXIT THEN

          ROLLBACK;
          VL_MESSAGE_H       := VL_MESSAGE_H || TRIM(SUBSTR(dbms_utility.format_error_backtrace() || ' ' || SQLERRM, 1, 255));
          PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                         VL_PROGR_D_TA0191,
                                         SQLCODE,
                                         VL_MESSAGE_H);

          PO_MSG := VL_MESSAGE_H;
          PO_STATUS := -1;

   WHEN OTHERS THEN

          ROLLBACK;
         -- Release updated records
            UPDATE TA0191CUSTOMERSURVEY
            SET       DTELCK          = NULL,
                      IDSESSIONLCK    = NULL,
                      CODUSRLCK       = NULL
            WHERE CODUSRLCK = C_SYSUSR AND IDSESSIONLCK = PI_SESSION_ID;
            COMMIT;
          -- Moves records from staging area to log staging area
          P_XIN_MOVE_TO_LOG(PI_PROGR_H, VL_PROGR_D_TA0191,'TA0192CUSTOMERSURV');
          P_XIN_MOVE_TO_LOG(PI_PROGR_H, VL_PROGR_D_TA0191,'TA0191CUSTOMERSURV');

          VL_MESSAGE_H       := VL_MESSAGE_H || TRIM(SUBSTR(dbms_utility.format_error_backtrace() || ' ' || SQLERRM, 1, 255));

          PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                         VL_PROGR_D_TA0191,
                                         SQLCODE,
                                         VL_MESSAGE_H);

          PO_MSG := VL_MESSAGE_H;
          PO_STATUS := VL_STATUS;

  END LOAD_TA019X_SURVEYS;



 /*============================================================================*\
  /* Name: LOAD_TA515X_PROMO_HIER
       Loads SM1 tables:
      • TA5150PROMOARTICLES - Promo products hierarchy

     From
      1.  T060ARTICLE -  Product master data
      2.  T906TABROWX[CODTAB=SP_PRODHIERLEV] - configuration table


      Loading logic:
      !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
      !!!!!!!!!!YOU NEED TO SET FIRST THE CONFIGURATION IN T906 !!!!!!!!!!!!!!!!!!
      !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

      TA5150PROMOARTICLES is loaded following divisional configuration in T906TABROWX where all levels are configured.

      CONFIGURATION
          . CODSYS      = division
          . CODTAB      = SP_PRODHIERLEV
          . CODTABROW   = T060ARTICLE field
          . NUMOPTIONAL = level in hierarchy
          . OPTINFO     = QTABS for herarchy descrription

      Example
      CODSYS  CODTAB          CODTABROW    DESTABROW  NUMOPTIONAL OPTINFO
        I001  SP_PRODHIERLEV  CODART       Referenza            0
        I001  SP_PRODHIERLEV  CODSAL2      Raggruppamento2      1 SAL2
        I001  SP_PRODHIERLEV  CODPRODMGR   Product Manager      2 PRMGR
        I001  SP_PRODHIERLEV  CODFAMMER    Famiglia             3 FAMME
        I001  SP_PRODHIERLEV  CODCATMER    Categoria            4 CATME
        I001  SP_PRODHIERLEV  CODLINMER    Linea                5 LINME
        I001  SP_PRODHIERLEV  CODBRAND     Marchio              6 BRAND
        I001  SP_PRODHIERLEV  CODSAL3      Raggruppamento 3     7 SAL3

      ------------------------------------
      Commit each HEAD TA5150 CODDIV/CODNODE0
       ----------------------------------
      Validity Checks:
      . Validity chech missing- you have to cusomized them if you need them
      Error handling:
      • All Errors will be logged in T852/T854 SM1 log tables and all staging area records will be stored into staging area log with sm1_status = 9.

     Input parameters :     PI_PROGR_H - unique sm1 job number ( T800SYSTEMACTIVITYLOG )
     Outputparameters :     PO_MSG           - message of error if procedure exit with error
                            PO_STATUS        - 0 OK; -1 Error
     Author : Mariangela Bandiera
     Creation Date : 04 March 2013
     ----
     Updates :
     MBandiera 4 Dec 2013 This procedure will be called in the mainload procedure after Product loading LOAD_T060_ARTICLES
                          Only if Promo Module has been activated in SM1 ( TA5100PROMOCONFIG )
    ============================================================================ */
  PROCEDURE LOAD_TA5150_PROMO_HIER(pi_progr_h  IN NUMBER,
                                   po_msg      OUT NOCOPY VARCHAR2,
                                   po_status   OUT NOCOPY NUMBER) IS
    --
    --
    -- Cursor on CONFIGURATION T906 used to build PRODUCT HIERARCHY HEAD TA5150
   CURSOR CL_SP_PRODHIERLEV IS
   SELECT    T906_0.CODSYS    AS CODDIV,
             T906_0.CODTABROW AS CODNODE0, T906_0.OPTINFO AS QTAB0,
             T906_1.CODTABROW AS CODNODE1, T906_1.OPTINFO AS QTAB1,
             T906_2.CODTABROW AS CODNODE2, T906_2.OPTINFO AS QTAB2,
             T906_3.CODTABROW AS CODNODE3, T906_3.OPTINFO AS QTAB3,
             T906_4.CODTABROW AS CODNODE4, T906_4.OPTINFO AS QTAB4,
             T906_5.CODTABROW AS CODNODE5, T906_5.OPTINFO AS QTAB5,
             T906_6.CODTABROW AS CODNODE6, T906_6.OPTINFO AS QTAB6,
             T906_7.CODTABROW AS CODNODE7, T906_7.OPTINFO AS QTAB7

        FROM T906TABROWSX T906_0
        LEFT JOIN T906TABROWSX T906_1 ON ( T906_1.CODSYS = T906_0.CODSYS AND T906_1.CODTAB = T906_0.CODTAB AND T906_1.FLGANN = T906_0.FLGANN AND T906_1.NUMOPTIONAL = 1)
        LEFT JOIN T906TABROWSX T906_2 ON ( T906_2.CODSYS = T906_0.CODSYS AND T906_2.CODTAB = T906_0.CODTAB AND T906_2.FLGANN = T906_0.FLGANN AND T906_2.NUMOPTIONAL = 2)
        LEFT JOIN T906TABROWSX T906_3 ON ( T906_3.CODSYS = T906_0.CODSYS AND T906_3.CODTAB = T906_0.CODTAB AND T906_3.FLGANN = T906_0.FLGANN AND T906_3.NUMOPTIONAL = 3)
        LEFT JOIN T906TABROWSX T906_4 ON ( T906_4.CODSYS = T906_0.CODSYS AND T906_4.CODTAB = T906_0.CODTAB AND T906_4.FLGANN = T906_0.FLGANN AND T906_4.NUMOPTIONAL = 4)
        LEFT JOIN T906TABROWSX T906_5 ON ( T906_5.CODSYS = T906_0.CODSYS AND T906_5.CODTAB = T906_0.CODTAB AND T906_5.FLGANN = T906_0.FLGANN AND T906_5.NUMOPTIONAL = 5)
        LEFT JOIN T906TABROWSX T906_6 ON ( T906_6.CODSYS = T906_0.CODSYS AND T906_6.CODTAB = T906_0.CODTAB AND T906_6.FLGANN = T906_0.FLGANN AND T906_6.NUMOPTIONAL = 6)
        LEFT JOIN T906TABROWSX T906_7 ON ( T906_7.CODSYS = T906_0.CODSYS AND T906_7.CODTAB = T906_0.CODTAB AND T906_7.FLGANN = T906_0.FLGANN AND T906_7.NUMOPTIONAL = 7)

       WHERE T906_0.CODTAB = 'SP_PRODHIERLEV'
        AND  T906_0.FLGANN = 0
        AND  T906_0.NUMOPTIONAL = 0
       ORDER BY T906_0.CODSYS;


    vl_myCursor VARCHAR2(4000):= NULL;

    TYPE CURTYP IS REF CURSOR;
    cl_ta5150 CURTYP;
    rl_ta5150 TA5150PROMOARTICLES%ROWTYPE:=NULL;
    --
    vl_status     NUMBER := 0;
    vl_message          VARCHAR2(2000) := NULL;
    --
    vl_progr_d_ta51      NUMBER := 0;
    vl_count_ta51        NUMBER := 0;
    vl_ins_ta51          NUMBER := 0;

  BEGIN

    --
    vl_progr_d_ta51   := pkg_utils.log_new_detail(vidsysact   => pi_progr_h,
                                                  vcoddettype => 'PROMO_PROD_HIER',
                                                  vdetnote    => 'TA5150PROMOARTICLES');

   FOR RL IN CL_SP_PRODHIERLEV LOOP
   BEGIN
    -- LOOP ON CONFIGURATION DIVISION T906
    -- dynamic cursor -- it retrieves PRODUCT HERARCHY from T060ARTICLE with the leves defined in T906TABROWX [CODTAB = SP_PRODHIERLEV]
    --                -- and the descriptions found in T902TABROW where T902.CODTAB = T906.OTPINFO
    vl_myCursor := 'SELECT T060.CODDIV AS CODDIV,'||
                   CASE WHEN RL.CODNODE0 IS NOT NULL THEN ' T060.'||RL.CODNODE0 ||' AS CODNODE0' ELSE NULL END ||
                   CASE WHEN RL.CODNODE0 IS NOT NULL AND RL.CODNODE0 <> 'CODART' THEN ', T902_0.DESTABROW AS DESNODE0'
                        WHEN RL.CODNODE0 IS NOT NULL AND RL.CODNODE0 = 'CODART'  THEN ', T060.DESART AS DESNODE0'
                        ELSE NULL
                   END ||

                   CASE WHEN RL.CODNODE1 IS NOT NULL THEN ', T060.'||RL.CODNODE1 ELSE  ', NULL '  END || ' AS CODNODE1 ' ||
                   CASE WHEN RL.CODNODE1 IS NOT NULL THEN ', T902_1.DESTABROW '  ELSE  ', NULL '  END || ' AS DESNODE1 ' ||
                   CASE WHEN RL.CODNODE2 IS NOT NULL THEN ', T060.'||RL.CODNODE2 ELSE  ', NULL '  END || ' AS CODNODE2 ' ||
                   CASE WHEN RL.CODNODE2 IS NOT NULL THEN ', T902_2.DESTABROW '  ELSE  ', NULL '  END || ' AS DESNODE2 ' ||
                   CASE WHEN RL.CODNODE3 IS NOT NULL THEN ', T060.'||RL.CODNODE3 ELSE  ', NULL '  END || ' AS CODNODE3 ' ||
                   CASE WHEN RL.CODNODE3 IS NOT NULL THEN ', T902_3.DESTABROW '  ELSE  ', NULL '  END || ' AS DESNODE3 ' ||
                   CASE WHEN RL.CODNODE4 IS NOT NULL THEN ', T060.'||RL.CODNODE4 ELSE  ', NULL '  END || ' AS CODNODE4 ' ||
                   CASE WHEN RL.CODNODE4 IS NOT NULL THEN ', T902_4.DESTABROW '  ELSE  ', NULL '  END || ' AS DESNODE4 ' ||
                   CASE WHEN RL.CODNODE5 IS NOT NULL THEN ', T060.'||RL.CODNODE5 ELSE  ', NULL '  END || ' AS CODNODE5 ' ||
                   CASE WHEN RL.CODNODE5 IS NOT NULL THEN ', T902_5.DESTABROW '  ELSE  ', NULL '  END || ' AS DESNODE5 ' ||
                   CASE WHEN RL.CODNODE6 IS NOT NULL THEN ', T060.'||RL.CODNODE6 ELSE  ', NULL '  END || ' AS CODNODE6 ' ||
                   CASE WHEN RL.CODNODE6 IS NOT NULL THEN ', T902_6.DESTABROW '  ELSE  ', NULL '  END || ' AS DESNODE6 ' ||
                   CASE WHEN RL.CODNODE7 IS NOT NULL THEN ', T060.'||RL.CODNODE7 ELSE  ', NULL '  END || ' AS CODNODE7 ' ||
                   CASE WHEN RL.CODNODE7 IS NOT NULL THEN ', T902_7.DESTABROW '  ELSE  ', NULL '  END || ' AS DESNODE7 ' ||
                   ', ''A'' AS ROWSTATUS  FROM T060ARTICLE T060 '||
                   CASE WHEN RL.CODNODE0 IS NOT NULL AND RL.CODNODE0 <> 'CODART' THEN ' LEFT JOIN T902TABROWS T902_0 ON (T902_0.CODSYS = T060.CODDIV AND T902_0.CODTAB = '''||RL.QTAB0||''' AND T902_0.CODTABROW = T060.'||RL.CODNODE0||')'ELSE NULL END ||
                   CASE WHEN RL.CODNODE1 IS NOT NULL THEN ' LEFT JOIN T902TABROWS T902_1 ON (T902_1.CODSYS = T060.CODDIV AND T902_1.CODTAB = '''|| RL.QTAB1||''' AND T902_1.CODTABROW = T060.'||RL.CODNODE1||')'ELSE NULL END ||
                   CASE WHEN RL.CODNODE2 IS NOT NULL THEN ' LEFT JOIN T902TABROWS T902_2 ON (T902_2.CODSYS = T060.CODDIV AND T902_2.CODTAB = '''|| RL.QTAB2 ||''' AND T902_2.CODTABROW = T060.'||RL.CODNODE2||')'ELSE NULL END ||
                   CASE WHEN RL.CODNODE3 IS NOT NULL THEN ' LEFT JOIN T902TABROWS T902_3 ON (T902_3.CODSYS = T060.CODDIV AND T902_3.CODTAB = '''|| RL.QTAB3 ||''' AND T902_3.CODTABROW = T060.'||RL.CODNODE3||')'ELSE NULL END ||
                   CASE WHEN RL.CODNODE4 IS NOT NULL THEN ' LEFT JOIN T902TABROWS T902_4 ON (T902_4.CODSYS = T060.CODDIV AND T902_4.CODTAB = '''|| RL.QTAB4 ||''' AND T902_4.CODTABROW = T060.'||RL.CODNODE4||')'ELSE NULL END ||
                   CASE WHEN RL.CODNODE5 IS NOT NULL THEN ' LEFT JOIN T902TABROWS T902_5 ON (T902_5.CODSYS = T060.CODDIV AND T902_5.CODTAB = '''|| RL.QTAB5 ||''' AND T902_5.CODTABROW = T060.'||RL.CODNODE5||')'ELSE NULL END ||
                   CASE WHEN RL.CODNODE6 IS NOT NULL THEN ' LEFT JOIN T902TABROWS T902_6 ON (T902_6.CODSYS = T060.CODDIV AND T902_6.CODTAB = '''|| RL.QTAB6 ||''' AND T902_6.CODTABROW = T060.'||RL.CODNODE6||')'ELSE NULL END ||
                   CASE WHEN RL.CODNODE7 IS NOT NULL THEN ' LEFT JOIN T902TABROWS T902_7 ON (T902_7.CODSYS = T060.CODDIV AND T902_7.CODTAB = '''|| RL.QTAB7 ||''' AND T902_7.CODTABROW = T060.'||RL.CODNODE7||')'ELSE NULL END ||

                   ' WHERE T060.CODART <> ''N/A'' AND T060.FLGANN = 0 AND T060.CODDIV = ''' ||RL.CODDIV||'''';



     -- on first loop it flags all rows as Cancelled Rowstatus='C'

     UPDATE TA5150PROMOARTICLES
        SET ROWSTATUS = 'C'
     WHERE  CODDIV = RL.CODDIV;


    OPEN cl_ta5150 FOR vl_myCursor || CHR(0);
    LOOP


      rl_ta5150 :=NULL;
      FETCH cl_ta5150 INTO rl_ta5150;
      EXIT WHEN cl_ta5150%NOTFOUND;

      BEGIN
      --
      vl_count_ta51 := vl_count_ta51 + 1;
      --

      -- Update existing record as A=Active
      UPDATE TA5150PROMOARTICLES
         SET ROWSTATUS = 'A',
             DESNODE0 = rl_ta5150.desnode0,
             CODNODE1 = rl_ta5150.codnode1,
             DESNODE1 = rl_ta5150.desnode1,
             CODNODE2 = rl_ta5150.codnode2,
             DESNODE2 = rl_ta5150.desnode2,
             CODNODE3 = rl_ta5150.codnode3,
             DESNODE3 = rl_ta5150.desnode3,
             CODNODE4 = rl_ta5150.codnode4,
             DESNODE4 = rl_ta5150.desnode4,
             CODNODE5 = rl_ta5150.codnode5,
             DESNODE5 = rl_ta5150.desnode5,
             CODNODE6 = rl_ta5150.codnode6,
             DESNODE6 = rl_ta5150.desnode6,
             CODNODE7 = rl_ta5150.codnode7,
             DESNODE7 = rl_ta5150.desnode7

       WHERE codnode0 = rl_ta5150.codnode0
         AND coddiv   = rl_ta5150.coddiv;

      --
      -- if not found in update we insert it
      IF SQL%ROWCOUNT = 0 THEN

            rl_ta5150.rowstatus := 'A' ; -- Active
            Insert into TA5150PROMOARTICLES VALUES rl_ta5150;
      END IF;


       EXCEPTION
            WHEN OTHERS THEN
          vl_status := -1;
          vl_message := 'Error inserting Promo TA5150PROMOARTICLES : codnode0=' ||
                        rl_ta5150.codnode0 || ' - ' || ' coddiv=' ||
                        rl_ta5150.coddiv || ' - ' ||
                        substr(dbms_utility.format_error_backtrace() || ' ' || SQLERRM, 1, 1000);
           --
           pkg_utils.log_new_detail_error(pi_progr_h,
                                          vl_progr_d_ta51,
                                          SQLCODE,
                                          vl_message);
      END;


      -- commit each HEAD CODDIV/CODNODE0
       if vl_status >=0 then
          vl_ins_ta51 := vl_ins_ta51 + 1;

         commit;
      else
         rollback;
         vl_status := 0;
      end if;

     END LOOP;
     CLOSE cl_ta5150;

    EXCEPTION WHEN OTHERS THEN
          rollback;
          vl_status := -1;
          vl_message :=vl_myCursor ;
          --
          pkg_utils.log_new_detail_error(pi_progr_h,
                                          vl_progr_d_ta51,
                                          SQLCODE,
                                          vl_message);
    END;
    END LOOP;


   PO_MSG := VL_MESSAGE;
   PO_STATUS := vl_status;
    --
    pkg_utils.log_end_detail(vidsysact  => pi_progr_h,
                             viddet     => vl_progr_d_ta51,
                             vcodstatus => 0,
                             vqtytot    =>  vl_count_ta51, -- how many records should have been processed
                             vqtyok     => vl_ins_ta51, -- how many records have been processed actually
                             vqtydisc   => ( vl_count_ta51 - vl_ins_ta51)); -- how many records haven't been processe


    --
  END LOAD_TA5150_PROMO_HIER;

 /*============================================================================*\
  /* Name: LOAD_TA5151_PROMODISPLAYS
       Loads SM1 tables:
      • TA5151PROMODISPLAYS - Promo display

     From
      • T060ARTICLE
      • T064PARTLIST

      Loading logic:
      Replaces totally TA5151PROMODISPLAYS.
      In case of error it makes total rollback and it keeps previous data.

     Author : Mariangela Bandiera
     Creation Date : 04 Dec 2013
     ----
     Updates :


    ============================================================================ */
  PROCEDURE LOAD_TA5151_PROMODISPLAYS(pi_progr_h  IN NUMBER,
                                      po_msg      OUT NOCOPY VARCHAR2,
                                      po_status   OUT NOCOPY NUMBER) IS

    --
    vl_progr_d_ta51      NUMBER := 0;
    vl_count_ta51        NUMBER := 0;


  BEGIN

    --
    vl_progr_d_ta51   := pkg_utils.log_new_detail(vidsysact   => pi_progr_h,
                                                  vcoddettype => 'TA5151PROMODISPLAY',
                                                  vdetnote    => 'TA5151PROMODISPLAY');



    DELETE TA5151PROMODISPLAYS;

    INSERT INTO TA5151PROMODISPLAYS  (coddiv,
                                      coddisplay,
                                      desdisplay,
                                      codproduct,
                                      codlevel,
                                      numcomponents,
                                      codtemporarydisplay)
    (SELECT t060.coddiv     as coddiv,
           t060.codart     as coddisplay,
           t060.desart     as desdisplay,
           t064.codartson  as codproduct,
           'CODART'        as codlevel,
           t064.qty        as numcomponents,
           son.codartsubst as codtemporarydisplay
      FROM t060article t060
      JOIN t064partlist t064 ON t064.codart = t060.codart AND
                                t064.coddiv = t060.coddiv
      JOIN t060article son   ON son.codart = t064.codartson AND
                                son.coddiv = t064.coddiv
       WHERE t060.codstatus = '0'
        AND  t060.flgdisplay <> 0
        );

      vl_count_ta51 := SQL%ROWCOUNT;

   commit;

   PO_MSG := 'Inserted '||vl_count_ta51||' artilces into TA5151PROMODISPLAYS';
   PO_STATUS := 0;
    --
   pkg_utils.log_end_detail(vidsysact  => pi_progr_h,
                             viddet     => vl_progr_d_ta51,
                             vcodstatus => 0,
                             vqtytot    => vl_count_ta51, -- how many records should have been processed
                             vqtyok     => vl_count_ta51, -- how many records have been processed actually
                             vqtydisc   => 0); -- how many records haven't been processe

    --
  EXCEPTION WHEN OTHERS THEN

     ROLLBACK;

       PO_MSG       := 'TA5151PROMODISPLAYS creation aborted. '||SUBSTR(dbms_utility.format_error_backtrace() || ' ' || SQLERRM, 1, 255);

       PO_STATUS := -1;
       PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                      vl_progr_d_ta51,
                                      SQLCODE,
                                      PO_MSG);



  END LOAD_TA5151_PROMODISPLAYS;

 /*============================================================================*\
  /* Name: LOAD_TA5152_PROMOARTICLE_LIST
      Loads SM1 tables
      • TA5152_PROMOARTICLE_LIST Promo Price List
      • Staging Area (SSA) tables
      • XIN_TA5152_PROMOARTICLE_LIST

      Loading logic:
      UPDATE + INSERT record is updated if already exists (checking by primary key) and it is not already locked, record is inserted if it does not exist yet.

      Validity Checks:
      • Old records will be set to dteend = sysdate
      Records will be loaded only if customer is present on T040PARTY

      Error handling:
      • All Errors will be logged in T852/T854 SM1 log tables and all staging area records will be stored into staging area log with sm1_status = 9.
      • Error on record,  it is discarded and import skip to next record to be loaded

     Input parameters :     PI_PROGR_H - unique sm1 job number ( T800SYSTEMACTIVITYLOG )
                            PI_SESSION_ID    - unique login session (T035LOGGEDUSERS)
     Outputparameters :     PO_MSG           - message of error if procedure exit with error
                            PO_STATUS        - 0 OK; -1 Error
     Author : Mariangela Bandiera
     Creation Date : 4 December 2013
     ----
     Updates :
     tfs 33200 fixed a bug on deleting no more present promo price ( it has not to compare DTEFROM field)

    ============================================================================ */
  PROCEDURE LOAD_TA5152_PROMOARTICLE_LIST(PI_PROGR_H    IN NUMBER,
                                          PI_SESSION_ID IN NUMBER,
                                          PO_MSG        OUT NOCOPY VARCHAR2,
                                          PO_STATUS     OUT NOCOPY NUMBER) IS


    -- Cursor on promo pricelist table TA5152PROMOARTICLE
    -- -----------------------------------------
    CURSOR CL_XIN_TA5152 IS
      SELECT
       *
        FROM  XIN_TA5152PROMOARTICLE
        WHERE SM1_CODPROCESS = PI_PROGR_H
        ORDER BY SM1_DTECRE,  KEYNAME, CODDIV, CODNODE, IDLEVEL, CODPRODUCT, LEVPRODUCT, DTESTART;

    --
    VL_MESSAGE_H   VARCHAR2(4000) := 'Error while loading promo list TA5152';
    VL_MESSAGE_D   VARCHAR2(4000) := NULL;
    --
    VL_PROGR_D_TA5152    NUMBER := 0;
    VL_COUNT_XIN_TA5152  NUMBER := 0;
    VL_INS_TA5152_TOT    NUMBER := 0;
    VL_INS_TA5152        NUMBER := 0;
    --
    --vl_MySql             VARCHAR2(4000):=NULL;
    VL_COUNT             NUMBER := 0;
    ---
    REC_TA5152      TA5152PROMOARTICLES_LIST%ROWTYPE    := NULL;
    REC_TA5152_PREV TA5152PROMOARTICLES_LIST%ROWTYPE    := NULL;
    REC_TA5152_INIT TA5152PROMOARTICLES_LIST%ROWTYPE    := NULL;
    RL_XIN_PREV     CL_XIN_TA5152%ROWTYPE;
    --
    VL_DES_TA5152     X_FIELD_INFO_ARRAY;-- Array with fields lengths
    --
    VL_STATUS NUMBER:= 0;
    VL_STEP   NUMBER:= 0; -- Used to ping t035
    --
    EX_EXIT  EXCEPTION;
    --
    VL_CODDIV VARCHAR2(30) := NULL;

  BEGIN

    -- init indexes and rebuild statistics
    P_XIN_INIT_INDEXES (PI_PROGR_H, 'TA5152PROMOARTICLE');
    -- clean loG

    P_XIN_CLEANUP_LOG (PI_PROGR_H, 'TA5152PROMOARTICLE');
    --

    VL_PROGR_D_TA5152 := PKG_UTILS.LOG_NEW_DETAIL(PI_PROGR_H,
                                                'PROMO LIST',
                                                'IMPORT --> TA5152PROMOARTICLE_LIST',
                                                 0,
                                                 NULL);



   BEGIN
        --
        -- ----------------------------------------------------------
        -- Init arrays with FIELD_NAME=LENGTH and FIELDNAME=SM1_DEFAULT for all fields of table
        -- ----------------------------------------------------------
        VL_DES_TA5152.DELETE;
        P_INIT_SM1_FIELD_ARRAY ('TA5152PROMOARTICLES_LIST',VL_DES_TA5152,VL_STATUS, VL_MESSAGE_H);
        execute immediate ( GL_INIT_REC) INTO REC_TA5152_INIT;

        IF (VL_STATUS <> 0 ) THEN
            VL_MESSAGE_D := GL_INIT_REC;
            RAISE EX_EXIT;
        END IF;
    EXCEPTION WHEN OTHERS THEN
        VL_MESSAGE_D := GL_INIT_REC;
        RAISE EX_EXIT;
    END;

    -- --------------------------------------------------------------
    -- Identifies Xin records to be loaded
    -- --------------------------------------------------------------
    BEGIN
        VL_MESSAGE_D := 'XIN_TA5152PROMOARTICLE_LIST';
        UPDATE XIN_TA5152PROMOARTICLE
        SET SM1_CODPROCESS = PI_PROGR_H,
            SM1_STATUS = 0,
            SM1_DTEPROCESS = XSYSDATE
            WHERE SM1_CODPROCESS = C_SM1_NULL_CODPROCESS;

        VL_COUNT_XIN_TA5152 := SQL%ROWCOUNT;

    COMMIT;
    EXCEPTION WHEN OTHERS THEN
      ROLLBACK;
      VL_MESSAGE_H := 'Error while Reading Staging area: '||VL_MESSAGE_D;
      RAISE EX_EXIT;

    END;


    -- --------------------------------------------------------------
    -- loop in main table TA5152PROMOARTICLE
    -- --------------------------------------------------------------
    FOR RL_XIN_TA5152 IN CL_XIN_TA5152 LOOP
        -- pings to t035 every 1000 cicles--
      VL_STEP := VL_STEP + 1;
      IF ( MOD(VL_STEP, 1000) = 0 ) THEN
         PKG_UTILS.user_ping(PI_SESSION_ID);
      END IF;

      -- COMMIT OF PREVIOUS SET

      IF ( NVL(RL_XIN_PREV.CODDIV    , '@')    <>  RL_XIN_TA5152.CODDIV     OR
           NVL(RL_XIN_PREV.CODNODE   , '@')    <>  RL_XIN_TA5152.CODNODE    OR
           NVL(RL_XIN_PREV.IDLEVEL   , '@')    <>  RL_XIN_TA5152.IDLEVEL    OR
           NVL(RL_XIN_PREV.CODPRODUCT, '@')    <>  RL_XIN_TA5152.CODPRODUCT OR
           NVL(RL_XIN_PREV.LEVPRODUCT, '@')    <>  RL_XIN_TA5152.LEVPRODUCT OR
           NVL(RL_XIN_PREV.KEYNAME   , '@')    <>  RL_XIN_TA5152.KEYNAME  ) THEN



       IF VL_STATUS = 0 THEN
         COMMIT;
         VL_INS_TA5152_TOT := VL_INS_TA5152_TOT + VL_INS_TA5152;
       ELSE
         ROLLBACK;
            UPDATE XIN_TA5152PROMOARTICLE
            SET  SM1_STATUS =  C_XINSTATUS_ERR
            WHERE CODDIV     = RL_XIN_PREV.CODDIV
             AND  CODNODE    = RL_XIN_PREV.CODNODE
             AND  IDLEVEL    = RL_XIN_PREV.IDLEVEL
             AND  CODPRODUCT = RL_XIN_PREV.CODPRODUCT
             AND  LEVPRODUCT = RL_XIN_PREV.LEVPRODUCT
             AND  KEYNAME    = RL_XIN_PREV.KEYNAME
            -- AND  DTESTART   = RL_XIN_PREV.DTESTART
             AND  SM1_CODPROCESS = PI_PROGR_H
             AND  SM1_DTECRE = RL_XIN_PREV.SM1_DTECRE
             AND  SM1_STATUS = C_XINSTATUS_OK;

             VL_STATUS := 0;
             COMMIT;
       END IF;

      VL_INS_TA5152 :=0;
      END IF;


      VL_MESSAGE_H :=   'Customer : '||RL_XIN_TA5152.codnode||' '||
                        'Division : '||RL_XIN_TA5152.CODDIV||' '||
                        'Product Code : '||RL_XIN_TA5152.codproduct||' '||
                        'Product Level : '||RL_XIN_TA5152.levproduct||' '||
                        'Key Name : '||RL_XIN_TA5152.KeyName;




      --VL_STATUS := 0;
      BEGIN --- HEAD TA5152
       -- Data Format Check
        VL_MESSAGE_D := 'Format Conversion ';
        REC_TA5152            := REC_TA5152_INIT;
        --
        REC_TA5152.CODDIV     := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_TA5152.CODDIV,  'CODDIV', VL_DES_TA5152,VL_STATUS, VL_MESSAGE_D);
        REC_TA5152.CODNODE    := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_TA5152.CODNODE, 'CODNODE', VL_DES_TA5152,VL_STATUS, VL_MESSAGE_D);
        REC_TA5152.IDLEVEL    := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_TA5152.IDLEVEL, 'IDLEVEL', VL_DES_TA5152,VL_STATUS, VL_MESSAGE_D);
        REC_TA5152.CODPRODUCT := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_TA5152.CODPRODUCT,'CODPRODUCT', VL_DES_TA5152,VL_STATUS, VL_MESSAGE_D);
        REC_TA5152.LEVPRODUCT := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_TA5152.LEVPRODUCT,'LEVPRODUCT', VL_DES_TA5152,VL_STATUS, VL_MESSAGE_D);
        REC_TA5152.KEYNAME    := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_TA5152.KEYNAME,  'KEYNAME', VL_DES_TA5152,VL_STATUS, VL_MESSAGE_D);
        REC_TA5152.DTESTART   := F_CHECK_FORMAT_D( VL_CODDIV, RL_XIN_TA5152.DTESTART, 'DTESTART', VL_DES_TA5152,VL_STATUS, VL_MESSAGE_D);
        REC_TA5152.DTEEND     := F_CHECK_FORMAT_D( VL_CODDIV, RL_XIN_TA5152.DTEEND,   'DTEEND', VL_DES_TA5152,VL_STATUS, VL_MESSAGE_D);
        REC_TA5152.VALUE      := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_TA5152.VALUE,   'VALUE', VL_DES_TA5152,VL_STATUS, VL_MESSAGE_D);

        IF (VL_STATUS <> 0 ) THEN

             VL_MESSAGE_H := SUBSTR(VL_MESSAGE_H||' '||VL_MESSAGE_D||' '||dbms_utility.format_error_backtrace() || ' ' || SQLERRM,1,4000);

             PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                           VL_PROGR_D_TA5152,
                                           SQLCODE,
                                           VL_MESSAGE_H);
        END IF;



        --- Validity checks:
        --- Customer needs to be present on T040PARTY
        --- Article  needs to be present on TA5150PROMOARTICLES
        BEGIN

           SELECT count(*) INTO vl_count
           FROM T040PARTY T040
           JOIN T041PARTYDIV T041 ON T040.CODPARTY = T041.CODPARTY
           WHERE T041.CODPARTY =  REC_TA5152.CODNODE
             AND T041.CODDIV   =  REC_TA5152.CODDIV;


    /*
        CODSYS  CODTAB        CODTABROW    DESTABROW  NUMOPTIONAL OPTINFO
        I001  SP_PRODHIERLEV  CODART       Referenza            0
        I001  SP_PRODHIERLEV  CODSAL2      Raggruppamento2      1 SAL2
        I001  SP_PRODHIERLEV  CODPRODMGR   Product Manager      2 PRMGR
        I001  SP_PRODHIERLEV  CODFAMMER    Famiglia             3 FAMME
        I001  SP_PRODHIERLEV  CODCATMER    Categoria            4 CATME
        I001  SP_PRODHIERLEV  CODLINMER    Linea                5 LINME
        I001  SP_PRODHIERLEV  CODBRAND     Marchio              6 BRAND
        I001  SP_PRODHIERLEV  CODSAL3      Raggruppamento 3     7 SAL3
        */

      /*   if ( vl_count > 0 ) then
             vl_MySql := null;

             vl_mySql := 'SELECT count(*) FROM TA5150PROMOARTICLES  T
                                          JOIN T906TABROWSX CONF ON CONF.CODSYS = T.CODDIV AND
                                                                    CONF.CODTAB = ''SP_PRODHIERLEV'' AND
                                                                    CONF.NUMOPTIONAL = '||REC_TA5152.LEVPRODUCT ||
                          '  WHERE CODNODE'||'CONF.NUMOPTIONAL'||' = CONF.CODTABROW AND CODDIV = '''||REC_TA5152.CODDIV||'''';

             EXECUTE IMMEDIATE ( vl_MySql ) into vl_count;
         end if;
          */
        EXCEPTION WHEN OTHERS THEN

                  VL_MESSAGE_H := SUBSTR(VL_MESSAGE_H||' '||VL_MESSAGE_D||' '||dbms_utility.format_error_backtrace() || ' ' || SQLERRM,1,4000);

                   PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                           VL_PROGR_D_TA5152,
                                           SQLCODE,
                                           VL_MESSAGE_H);
        END ;

        IF ( VL_COUNT = 0) THEN
                   VL_MESSAGE_H := SUBSTR(VL_MESSAGE_H||' Discarded because customer does not exists  '||dbms_utility.format_error_backtrace() || ' ' || SQLERRM,1,4000);

                   PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                           VL_PROGR_D_TA5152,
                                           SQLCODE,
                                           VL_MESSAGE_H);

        END IF;

        IF (VL_STATUS = 0 and VL_COUNT > 0) THEN

                   -- we close all prices ERP is no more sending to sm1
              IF ( NVL(REC_TA5152_PREV.CODDIV    , '@')    <>  REC_TA5152.CODDIV     OR
                   NVL(REC_TA5152_PREV.CODNODE   , '@')    <>  REC_TA5152.CODNODE    OR
                   NVL(REC_TA5152_PREV.IDLEVEL   , '9999') <>  REC_TA5152.IDLEVEL    OR
                   NVL(REC_TA5152_PREV.CODPRODUCT, '@')    <>  REC_TA5152.CODPRODUCT OR
                   NVL(REC_TA5152_PREV.LEVPRODUCT, '@')    <>  REC_TA5152.LEVPRODUCT OR
                   NVL(REC_TA5152_PREV.KEYNAME   , '@')    <>  REC_TA5152.KEYNAME /*OR
                   NVL(REC_TA5152_PREV.DTESTART, C_SM1_NULL_DATE) <> REC_TA5152.DTESTART*/ ) THEN
              BEGIN
                Update TA5152PROMOARTICLES_LIST SET DTEEND = xsysdate
                 WHERE KEYNAME    = REC_TA5152.KEYNAME
                   AND CODDIV     = REC_TA5152.CODDIV
                   AND CODNODE    = REC_TA5152.CODNODE
                   AND CODPRODUCT = REC_TA5152.CODPRODUCT
                   AND LEVPRODUCT = REC_TA5152.LEVPRODUCT
                   AND IDLEVEL    = REC_TA5152.IDLEVEL/*
                   AND DTESTART   = REC_TA5152.DTESTART*/;


              EXCEPTION WHEN OTHERS THEN

                  VL_STATUS := -1;
                  VL_MESSAGE_H := SUBSTR(VL_MESSAGE_H||' '||VL_MESSAGE_D||' '||dbms_utility.format_error_backtrace() || ' ' || SQLERRM,1,4000);

                   PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                           VL_PROGR_D_TA5152,
                                           SQLCODE,
                                           VL_MESSAGE_H);
              END ;

             END IF;

          -- when status <> 0 some fields have incorrect format. Log t800 has been already wrote by F_CHECK function
          -- Update article if already exists

           VL_MESSAGE_D := 'Update TA5152PROMOARTICLES_LIST ';
           UPDATE TA5152PROMOARTICLES_LIST TA5152
           SET
               -- when the field si set to updated by host it means that the value should be read from XIN
               -- otherwise it means that the field is managed by sm1 and it maintains its original value
                TA5152.VALUE = CASE VL_DES_TA5152('VALUE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA5152.VALUE ELSE TA5152.VALUE END,
                TA5152.DTEEND = CASE VL_DES_TA5152('DTEEND.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA5152.DTEEND ELSE TA5152.DTEEND END

         WHERE TA5152.CODDIV     = REC_TA5152.CODDIV
           AND TA5152.CODNODE    = REC_TA5152.CODNODE
           AND TA5152.IDLEVEL    = REC_TA5152.IDLEVEL
           AND TA5152.CODPRODUCT = REC_TA5152.CODPRODUCT
           AND TA5152.LEVPRODUCT = REC_TA5152.LEVPRODUCT
           AND TA5152.KEYNAME    = REC_TA5152.KEYNAME
           AND TA5152.DTESTART   = REC_TA5152.DTESTART;


        IF (SQL%ROWCOUNT = 0 ) THEN

              VL_MESSAGE_D := 'Insert TA5152PROMOARTICLE ';
              -- Record does not exists, we insert it
              INSERT INTO TA5152PROMOARTICLES_LIST VALUES REC_TA5152;

        END IF;
          VL_INS_TA5152 := VL_INS_TA5152 + 1;
        END IF; -- Record has been inserted

        EXCEPTION WHEN DUP_VAL_ON_INDEX THEN
           -- it could happen to have double records on staging area
           NULL;
        WHEN OTHERS THEN
             VL_STATUS := -1;
             VL_MESSAGE_H := SUBSTR(VL_MESSAGE_H||' '||VL_MESSAGE_D||' '||dbms_utility.format_error_backtrace() || ' ' || SQLERRM,1,4000);

             PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                           VL_PROGR_D_TA5152,
                                           SQLCODE,
                                           VL_MESSAGE_H);

        END; -- HEAD TA5152




    REC_TA5152_PREV := REC_TA5152;
    RL_XIN_PREV     := RL_XIN_TA5152;
    END LOOP;  -- TA5152PROMOARTICLE

     IF VL_STATUS = 0 THEN
         COMMIT;
          VL_INS_TA5152_TOT := VL_INS_TA5152_TOT + VL_INS_TA5152;
     ELSE
         ROLLBACK;

        UPDATE XIN_TA5152PROMOARTICLE
        SET  SM1_STATUS =  C_XINSTATUS_ERR
        WHERE CODDIV     = RL_XIN_PREV.CODDIV
         AND  CODNODE    = RL_XIN_PREV.CODNODE
         AND  IDLEVEL    = RL_XIN_PREV.IDLEVEL
         AND  CODPRODUCT = RL_XIN_PREV.CODPRODUCT
         AND  LEVPRODUCT = RL_XIN_PREV.LEVPRODUCT
         AND  KEYNAME    = RL_XIN_PREV.KEYNAME
        -- AND  DTESTART   = RL_XIN_PREV.DTESTART
         AND  SM1_CODPROCESS = PI_PROGR_H
         AND  SM1_DTECRE = RL_XIN_PREV.SM1_DTECRE
         AND  SM1_STATUS = C_XINSTATUS_OK;

         COMMIT;
    END IF;

    -- Moves records from staging area to log staging area
    P_XIN_MOVE_TO_LOG(PI_PROGR_H, VL_PROGR_D_TA5152,'TA5152PROMOARTICLE');

   -- Close Logs
    PKG_UTILS.LOG_END_DETAIL(PI_PROGR_H,
                             VL_PROGR_D_TA5152,
                             0,
                             VL_COUNT_XIN_TA5152,
                             VL_INS_TA5152_TOT,
                             VL_COUNT_XIN_TA5152 - VL_INS_TA5152_TOT);


    PO_MSG    := VL_INS_TA5152_TOT||'/'||VL_COUNT_XIN_TA5152||' Promo List loaded';
    PO_STATUS := VL_INS_TA5152_TOT;


    --
  EXCEPTION WHEN EX_EXIT THEN

          ROLLBACK;
          VL_MESSAGE_H       := VL_MESSAGE_H || TRIM(SUBSTR(dbms_utility.format_error_backtrace() || ' ' || SQLERRM, 1, 255));
          PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                         VL_PROGR_D_TA5152,
                                         SQLCODE,
                                         VL_MESSAGE_H);

          PO_MSG := VL_MESSAGE_H;
          PO_STATUS := -1;

   WHEN OTHERS THEN

          ROLLBACK;
          -- Moves records from staging area to log staging area
          P_XIN_MOVE_TO_LOG(PI_PROGR_H, VL_PROGR_D_TA5152,'TA5152PROMOARTICLE');

          VL_MESSAGE_H       := VL_MESSAGE_H || TRIM(SUBSTR(dbms_utility.format_error_backtrace() || ' ' || SQLERRM, 1, 255));
          PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                         VL_PROGR_D_TA5152,
                                         SQLCODE,
                                         VL_MESSAGE_H);

          PO_MSG := VL_MESSAGE_H;
          PO_STATUS := VL_STATUS;
  END LOAD_TA5152_PROMOARTICLE_LIST;

   /*============================================================================*\
  /* Name: LOAD_T050X_PROMO
       Loads SM1 tables:
      • TA5000PROMOACTION           - Promotional Action
      • TA5002PROMOACTIONACTIVITIES - Promotional action activities
      • TA5020PRODUCTS              - Promotional Action Products
      • TA5022PRODUCTACTIVITIES     - Product-Activities Association
      • TA5012PARTICIPANTS          - Promotional Action Participants
      • TA5014DELIVERYPOINTS        - Promotional Action Delivery points

      Staging Area (SSA) tables (in Chronological Order expected in SSA for each Promotion):

      Loading logic:

      Validity Checks:

      Error handling:
      • All Errors will be logged in T852/T854 SM1 log tables and all staging area records will be stored into staging area log with sm1_status = 9.
      • Error on head record,  it is discarded with all its details.
      • Error on detail record,  it is discarded with its head and all other head details

      How to delete an Activity:
      • Activities cannot be deleted by Integration Host

     Input parameters :     PI_PROGR_H - unique sm1 job number ( T800SYSTEMACTIVITYLOG )
                            PI_SESSION_ID    - unique login session (T035LOGGEDUSERS)
     Outputparameters :     PO_MSG           - message of error if procedure exit with error
                            PO_STATUS        - 0 OK; -1 Error
     Author : Ioana Vasilescu
     Creation Date : 1 February 2013
     ----
     Updates

    ============================================================================ */

    PROCEDURE LOAD_TA50X_PROMO(PI_PROGR_H    IN NUMBER,
                                PI_SESSION_ID IN NUMBER,
                                PO_MSG        OUT NOCOPY VARCHAR2,
                                PO_STATUS     OUT NOCOPY NUMBER) IS
    -- -----------------------------------------
    -- Cursor on main PROMO table TA5000PROMOACTION
    -- -----------------------------------------
    CURSOR CL_XIN_TA5000 IS
      SELECT *

        FROM XIN_TA5000PROMOACTION
       WHERE SM1_CODPROCESS = PI_PROGR_H

       ORDER BY IDACTION, SM1_DTECRE ASC;


    CURSOR CL_XIN_TA5002(CI_IDACTION VARCHAR2, CI_SM1_DTECRE DATE) IS
          SELECT *
       FROM XIN_TA5002PROMOACTIONA
          WHERE IDACTION = CI_IDACTION
          AND SM1_CODPROCESS =PI_PROGR_H
          AND SM1_DTECRE <= CI_SM1_DTECRE
          AND SM1_STATUS = C_XINSTATUS_OK
          ORDER BY  SM1_DTECRE ASC;


    CURSOR CL_XIN_TA5020(CI_IDACTION VARCHAR2, CI_SM1_DTECRE DATE) IS
        SELECT *
         FROM XIN_TA5020PRODUCTS
          WHERE IDACTION=CI_IDACTION
          AND SM1_CODPROCESS=PI_PROGR_H
          AND SM1_DTECRE <= CI_SM1_DTECRE
          AND SM1_STATUS = C_XINSTATUS_OK
          ORDER BY  SM1_DTECRE ASC;

    CURSOR CL_XIN_TA5022(CI_IDACTION VARCHAR2,CI_CODPRODUCT VARCHAR2,CI_LEVPRODUCT VARCHAR2, CI_SM1_DTECRE DATE) IS
        SELECT *
    FROM XIN_TA5022PRODUCTACTIV
          WHERE IDACTION=CI_IDACTION
          AND   CODPRODUCT = CI_CODPRODUCT
          AND   LEVPRODUCT = CI_LEVPRODUCT
          AND SM1_CODPROCESS=PI_PROGR_H
          AND SM1_DTECRE <= CI_SM1_DTECRE
          AND SM1_STATUS = C_XINSTATUS_OK
          ORDER BY  SM1_DTECRE ASC;

    CURSOR CL_XIN_TA5014(CI_IDACTION VARCHAR2, CI_SM1_DTECRE DATE) IS
        SELECT *
  FROM XIN_TA5014DELIVERYPOIN
          WHERE IDACTION=CI_IDACTION
          AND SM1_CODPROCESS=PI_PROGR_H
          AND SM1_DTECRE <= CI_SM1_DTECRE
          AND SM1_STATUS = C_XINSTATUS_OK
          ORDER BY  SM1_DTECRE ASC;

    CURSOR CL_XIN_TA5012(CI_IDACTION VARCHAR2, CI_SM1_DTECRE DATE) IS
        SELECT  *
  FROM XIN_TA5012PARTICIPANTS
          WHERE IDACTION=CI_IDACTION
          AND SM1_CODPROCESS=PI_PROGR_H
          AND SM1_DTECRE <= CI_SM1_DTECRE
          AND SM1_STATUS = C_XINSTATUS_OK
          ORDER BY  SM1_DTECRE ASC;

      --
    VL_MESSAGE_H VARCHAR2(2000) := 'Error while loading PROMO TA50X';
    VL_MESSAGE_D VARCHAR2(2000) := NULL;
    --
    VL_PROGR_D_TA5000   NUMBER := 0;
    VL_COUNT_XIN_TA5000 NUMBER := 0;
    VL_INS_TA5000       NUMBER := 0;
    --
    VL_PROGR_D_TA5002   NUMBER := 0;
    VL_COUNT_XIN_TA5002 NUMBER := 0;
    VL_INS_TA5002      NUMBER := 0;
    --
    VL_PROGR_D_TA5020   NUMBER := 0;
    VL_COUNT_XIN_TA5020 NUMBER := 0;
    VL_INS_TA5020       NUMBER := 0;
    --
    VL_PROGR_D_TA5022   NUMBER := 0;
    VL_COUNT_XIN_TA5022 NUMBER := 0;
    VL_INS_TA5022       NUMBER := 0;
    --
    VL_PROGR_D_TA5014   NUMBER := 0;
    VL_COUNT_XIN_TA5014 NUMBER := 0;
    VL_INS_TA5014       NUMBER := 0;
    --
    VL_PROGR_D_TA5012   NUMBER := 0;
    VL_COUNT_XIN_TA5012 NUMBER := 0;
    VL_INS_TA5012       NUMBER := 0;
     --
    vl_wf_stateid       TA2302WORKFLOWSTATES.STATEID%TYPE      := null;
    vl_wf_codstatehard  TA2302WORKFLOWSTATES.CODSTATEHARD%TYPE := null;

    --
    REC_TA5000  TA5000PROMOACTION%ROWTYPE := NULL;
    REC_TA5002  TA5002PROMOACTIONACTIVITIES%ROWTYPE := NULL;
    REC_TA5020  TA5020PRODUCTS%ROWTYPE := NULL;
    REC_TA5022  TA5022PRODUCTACTIVITIES%ROWTYPE := NULL;
    REC_TA5014  TA5014DELIVERYPOINTS%ROWTYPE := NULL;
    REC_TA5012  TA5012PARTICIPANTS%ROWTYPE := NULL;
    --
    REC_TA5000_INIT  TA5000PROMOACTION%ROWTYPE := NULL;
    REC_TA5002_INIT  TA5002PROMOACTIONACTIVITIES%ROWTYPE := NULL;
    REC_TA5020_INIT  TA5020PRODUCTS%ROWTYPE := NULL;
    REC_TA5022_INIT  TA5022PRODUCTACTIVITIES%ROWTYPE := NULL;
    REC_TA5014_INIT  TA5014DELIVERYPOINTS%ROWTYPE := NULL;
    REC_TA5012_INIT  TA5012PARTICIPANTS%ROWTYPE := NULL;

    --
    VL_DES_TA5000   X_FIELD_INFO_ARRAY; -- Array with fields db info
    VL_DES_TA5002   X_FIELD_INFO_ARRAY; -- Array with fields db info
    VL_DES_TA5020   X_FIELD_INFO_ARRAY; -- Array with fields db info
    VL_DES_TA5022   X_FIELD_INFO_ARRAY; -- Array with fields db info
    VL_DES_TA5014   X_FIELD_INFO_ARRAY; -- Array with fields db info
    VL_DES_TA5012   X_FIELD_INFO_ARRAY; -- Array with fields db info

    --
    VL_RECORD_LOCKED NUMBER := 0;
    VL_STATUS        NUMBER := 0;
    VL_STEP          NUMBER := 0; -- Used to ping t035
    --
    VL_IDACTION VARCHAR(255) := NULL;
    VL_CODACTIVITY VARCHAR(255) :=NULL;
    --
    EX_EXIT EXCEPTION;
    --
    VL_CODDIV VARCHAR2(30) := NULL;

    BEGIN

     -- init indexes and rebuild statistics
    P_XIN_INIT_INDEXES(PI_PROGR_H, 'TA5000PROMOACTION');
    P_XIN_INIT_INDEXES(PI_PROGR_H, 'TA5002PROMOACTIONA');
    P_XIN_INIT_INDEXES(PI_PROGR_H, 'TA5020PRODUCTS');
    P_XIN_INIT_INDEXES(PI_PROGR_H, 'TA5022PRODUCTACTIV');
    P_XIN_INIT_INDEXES(PI_PROGR_H, 'TA5014DELIVERYPOIN');
    P_XIN_INIT_INDEXES(PI_PROGR_H, 'TA5012PARTICIPANTS');

   -- clean loG
    P_XIN_CLEANUP_LOG(PI_PROGR_H, 'TA5000PROMOACTION');
    P_XIN_CLEANUP_LOG(PI_PROGR_H, 'TA5002PROMOACTIONA');
    P_XIN_CLEANUP_LOG(PI_PROGR_H, 'TA5020PRODUCTS');
    P_XIN_CLEANUP_LOG(PI_PROGR_H, 'TA5022PRODUCTACTIV');
    P_XIN_CLEANUP_LOG(PI_PROGR_H, 'TA5014DELIVERYPOIN');
    P_XIN_CLEANUP_LOG(PI_PROGR_H, 'TA5012PARTICIPANTS');

    --
    VL_PROGR_D_TA5000 := PKG_UTILS.LOG_NEW_DETAIL(PI_PROGR_H,
                                                'PROMO ACTION',
                                                'IMPORT --> TA5000PROMOACTION',
                                                0,
                                                NULL);
    --
    VL_PROGR_D_TA5002 := PKG_UTILS.LOG_NEW_DETAIL(PI_PROGR_H,
                                                'PROMO ACTION ACTIVITIES',
                                                'IMPORT --> TA5002PROMOACTIONACTIVITIES',
                                                0,
                                                NULL);
    --
    VL_PROGR_D_TA5020 := PKG_UTILS.LOG_NEW_DETAIL(PI_PROGR_H,
                                                'PROMO PRODUCTS',
                                                'IMPORT --> TA5020PRODUCTS',
                                                0,
                                                NULL);
    --
    VL_PROGR_D_TA5022 := PKG_UTILS.LOG_NEW_DETAIL(PI_PROGR_H,
                                                  'PROMO PRODUCT ACTIVITITES',
                                                  'IMPORT --> TA5022PRODUCTACTIVITIES',
                                                  0,
                                                  NULL);
    --
    VL_PROGR_D_TA5014 := PKG_UTILS.LOG_NEW_DETAIL(PI_PROGR_H,
                                                'PROMO DELIVERY POINTS',
                                                'IMPORT --> TA5014DELIVERYPOINTS',
                                                0,
                                                NULL);
    --
    VL_PROGR_D_TA5012 := PKG_UTILS.LOG_NEW_DETAIL(PI_PROGR_H,
                                                'PROMO PARTICIPANTS',
                                                'IMPORT --> TA5012PARTICIPANTS',
                                                0,
                                                NULL);



   BEGIN
        --
        -- ----------------------------------------------------------
        -- Init arrays with FIELD_NAME=LENGTH and FIELDNAME=SM1_DEFAULT for all fields of table
        -- ----------------------------------------------------------
        VL_DES_TA5000.DELETE;
        P_INIT_SM1_FIELD_ARRAY('TA5000PROMOACTION', VL_DES_TA5000, VL_STATUS, VL_MESSAGE_H);
        execute immediate ( GL_INIT_REC) INTO REC_TA5000_INIT;

        VL_DES_TA5002.DELETE;
        P_INIT_SM1_FIELD_ARRAY('TA5002PROMOACTIONACTIVITIES', VL_DES_TA5002, VL_STATUS, VL_MESSAGE_H);
        execute immediate ( GL_INIT_REC) INTO REC_TA5002_INIT;

         VL_DES_TA5020.DELETE;
        P_INIT_SM1_FIELD_ARRAY('TA5020PRODUCTS', VL_DES_TA5020, VL_STATUS, VL_MESSAGE_H);
        execute immediate ( GL_INIT_REC) INTO REC_TA5020_INIT;

         VL_DES_TA5022.DELETE;
        P_INIT_SM1_FIELD_ARRAY('TA5022PRODUCTACTIVITIES', VL_DES_TA5022, VL_STATUS, VL_MESSAGE_H);
        execute immediate ( GL_INIT_REC) INTO REC_TA5022_INIT;

         VL_DES_TA5014.DELETE;
        P_INIT_SM1_FIELD_ARRAY('TA5014DELIVERYPOINTS', VL_DES_TA5014, VL_STATUS, VL_MESSAGE_H);
        execute immediate ( GL_INIT_REC) INTO REC_TA5014_INIT;

         VL_DES_TA5012.DELETE;
        P_INIT_SM1_FIELD_ARRAY('TA5012PARTICIPANTS', VL_DES_TA5012, VL_STATUS, VL_MESSAGE_H);
        execute immediate ( GL_INIT_REC) INTO REC_TA5012_INIT;


        IF (VL_STATUS <> 0 ) THEN
            VL_MESSAGE_D := GL_INIT_REC;
            RAISE EX_EXIT;
        END IF;
    EXCEPTION WHEN OTHERS THEN
        VL_MESSAGE_D := GL_INIT_REC;
        RAISE EX_EXIT;
    END;



    -- --------------------------------------------------------------
    -- Work flow init status
    -- --------------------------------------------------------------
    BEGIN

    P_GET_WF_INIT_STATUS(C_WORKFLOWID_TA5000, 'TA5000PROMOACTION', vl_wf_stateid,vl_wf_codstatehard, VL_STATUS);

    if (vl_status <> 0 ) then
      VL_MESSAGE_H := 'Error retrieving Workflow init status';
      RAISE EX_EXIT;
    end if;

    EXCEPTION WHEN OTHERS THEN
      VL_MESSAGE_H := 'Error retrieving Workflow init status';
      RAISE EX_EXIT;
    END;
    -- ------------------------------------------------------------------



    -- --------------------------------------------------------------
    -- Identifies Xin records to be loaded
    -- --------------------------------------------------------------
   BEGIN
         VL_MESSAGE_D := 'XIN_TA5000PROMOACTION';
      UPDATE XIN_TA5000PROMOACTION
         SET SM1_CODPROCESS = PI_PROGR_H,
             SM1_STATUS     = 0,
             SM1_DTEPROCESS = XSYSDATE
       WHERE SM1_CODPROCESS = C_SM1_NULL_CODPROCESS;
      VL_COUNT_XIN_TA5000 := SQL%ROWCOUNT;

      VL_MESSAGE_D := 'XIN_TA5002PROMOACTIONA';
      UPDATE XIN_TA5002PROMOACTIONA D
         SET D.SM1_CODPROCESS = PI_PROGR_H,
             D.SM1_STATUS     = 0,
             D.SM1_DTEPROCESS = XSYSDATE
       WHERE D.IDACTION IN
             (SELECT H.IDACTION
                FROM XIN_TA5000PROMOACTION H
               WHERE H.SM1_CODPROCESS = PI_PROGR_H
                 AND H.SM1_DTECRE >= D.SM1_DTECRE)
         AND SM1_CODPROCESS = C_SM1_NULL_CODPROCESS;
      VL_COUNT_XIN_TA5002 := SQL%ROWCOUNT;

      VL_MESSAGE_D := 'XIN_TA5020PRODUCTS';
      UPDATE XIN_TA5020PRODUCTS D
         SET D.SM1_CODPROCESS = PI_PROGR_H,
             D.SM1_STATUS     = 0,
             D.SM1_DTEPROCESS = XSYSDATE
       WHERE D.IDACTION IN
             (SELECT H.IDACTION
                FROM XIN_TA5000PROMOACTION H
               WHERE H.SM1_CODPROCESS = PI_PROGR_H
                 AND H.SM1_DTECRE >= D.SM1_DTECRE)
         AND SM1_CODPROCESS = C_SM1_NULL_CODPROCESS;
      VL_COUNT_XIN_TA5020 := SQL%ROWCOUNT;

      VL_MESSAGE_D := 'XIN_TA5022PRODUCTACTIV';
      UPDATE XIN_TA5022PRODUCTACTIV D
         SET D.SM1_CODPROCESS = PI_PROGR_H,
             D.SM1_STATUS     = 0,
             D.SM1_DTEPROCESS = XSYSDATE
       WHERE D.IDACTION IN
             (SELECT H.IDACTION
                FROM XIN_TA5020PRODUCTS H
               WHERE H.SM1_CODPROCESS = PI_PROGR_H
                 AND H.SM1_DTECRE >= D.SM1_DTECRE)
         AND D.CODPRODUCT IN
            ( SELECT H.CODPRODUCT
                FROM XIN_TA5020PRODUCTS H
               WHERE H.SM1_CODPROCESS = PI_PROGR_H
                 AND H.SM1_DTECRE >= D.SM1_DTECRE)

         AND SM1_CODPROCESS = C_SM1_NULL_CODPROCESS;
      VL_COUNT_XIN_TA5022 := SQL%ROWCOUNT;

      VL_MESSAGE_D := 'XIN_TA5014DELIVERYPOIN';
      UPDATE XIN_TA5014DELIVERYPOIN D
         SET D.SM1_CODPROCESS = PI_PROGR_H,
             D.SM1_STATUS     = 0,
             D.SM1_DTEPROCESS = XSYSDATE
       WHERE D.IDACTION IN
             (SELECT H.IDACTION
                FROM XIN_TA5000PROMOACTION H
               WHERE H.SM1_CODPROCESS = PI_PROGR_H
                 AND H.SM1_DTECRE >= D.SM1_DTECRE)
         AND SM1_CODPROCESS = C_SM1_NULL_CODPROCESS;
      VL_COUNT_XIN_TA5014 := SQL%ROWCOUNT;

      VL_MESSAGE_D := 'XIN_TA5012PARTICIPANTS';
      UPDATE XIN_TA5012PARTICIPANTS D
         SET D.SM1_CODPROCESS = PI_PROGR_H,
             D.SM1_STATUS     = 0,
             D.SM1_DTEPROCESS = XSYSDATE
       WHERE D.IDACTION IN
             (SELECT H.IDACTION
                FROM XIN_TA5012PARTICIPANTS H
               WHERE H.SM1_CODPROCESS = PI_PROGR_H
                 AND H.SM1_DTECRE >= D.SM1_DTECRE)
         AND SM1_CODPROCESS = C_SM1_NULL_CODPROCESS;
      VL_COUNT_XIN_TA5012 := SQL%ROWCOUNT;

      COMMIT;
    EXCEPTION
      WHEN OTHERS THEN
        ROLLBACK;
        VL_MESSAGE_H := 'Error while Reading Staging area: ' ||
                        VL_MESSAGE_D;
        RAISE EX_EXIT;

   END;

     FOR RL_XIN_TA5000 IN CL_XIN_TA5000 LOOP
          -- pings to t035 every 1000 cicles--
      VL_STEP := VL_STEP + 1;
      IF (MOD(VL_STEP, 1000) = 0) THEN
        PKG_UTILS.user_ping(PI_SESSION_ID);
      END IF;
      --
      VL_STATUS        := 0;
      VL_RECORD_LOCKED := 0;
      --
      VL_MESSAGE_H := 'Promo action: ' || RL_XIN_TA5000.IDACTION;
      --
      VL_IDACTION := NULL;
     BEGIN
         --- HEAD TA5000

        -- Data Format Check
        VL_MESSAGE_D := 'Format Conversion ';
        VL_CODDIV:= RL_XIN_TA5000.CODDIV;

        REC_TA5000.DESACTION                := F_CHECK_FORMAT_S(VL_CODDIV, RL_XIN_TA5000.DESACTION,
                                                             'DESACTION',
                                                             VL_DES_TA5000,
                                                             VL_STATUS,
                                                             VL_MESSAGE_D);
        REC_TA5000.CODDIV                     :=  F_CHECK_FORMAT_S(VL_CODDIV, RL_XIN_TA5000.CODDIV,
                                                             'CODDIV',
                                                             VL_DES_TA5000,
                                                             VL_STATUS,
                                                             VL_MESSAGE_D);
        REC_TA5000.CODRESPONSIBLE              := F_CHECK_FORMAT_S(VL_CODDIV, RL_XIN_TA5000.CODRESPONSIBLE,
                                                             'CODRESPONSIBLE',
                                                             VL_DES_TA5000,
                                                             VL_STATUS,
                                                             VL_MESSAGE_D);
        REC_TA5000.CODCONTRACTOR                := F_CHECK_FORMAT_S(VL_CODDIV, RL_XIN_TA5000.CODCONTRACTOR,
                                                             'CODCONTRACTOR',
                                                             VL_DES_TA5000,
                                                             VL_STATUS,
                                                             VL_MESSAGE_D);
        REC_TA5000.LEVCONTRACTOR                := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_TA5000.LEVCONTRACTOR,
                                                             'LEVCONTRACTOR',
                                                             VL_DES_TA5000,
                                                             VL_STATUS,
                                                             VL_MESSAGE_D);
        REC_TA5000.TOTALPOTENTIAL                := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_TA5000.TOTALPOTENTIAL,
                                                             'TOTALPOTENTIAL',
                                                             VL_DES_TA5000,
                                                             VL_STATUS,
                                                             VL_MESSAGE_D);

        REC_TA5000.CODCOVERING                := F_CHECK_FORMAT_S(VL_CODDIV, RL_XIN_TA5000.CODCOVERING,
                                                             'CODCOVERING',
                                                             VL_DES_TA5000,
                                                             VL_STATUS,
                                                             VL_MESSAGE_D);
        REC_TA5000.DTESTARTSELLIN                := F_CHECK_FORMAT_D( VL_CODDIV, RL_XIN_TA5000.DTESTARTSELLIN,
                                                             'DTESTARTSELLIN',
                                                             VL_DES_TA5000,
                                                             VL_STATUS,
                                                             VL_MESSAGE_D);
        REC_TA5000.DTEENDSELLIN                := F_CHECK_FORMAT_D( VL_CODDIV, RL_XIN_TA5000.DTEENDSELLIN,
                                                             'DTEENDSELLIN',
                                                             VL_DES_TA5000,
                                                             VL_STATUS,
                                                             VL_MESSAGE_D);
        REC_TA5000.DELTASELLIN                := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_TA5000.DELTASELLIN,
                                                             'DELTASELLIN',
                                                             VL_DES_TA5000,
                                                             VL_STATUS,
                                                             VL_MESSAGE_D);
        REC_TA5000.DTESTARTSELLOUT                := F_CHECK_FORMAT_D( VL_CODDIV, RL_XIN_TA5000.DTESTARTSELLOUT,
                                                             'DTESTARTSELLOUT',
                                                             VL_DES_TA5000,
                                                             VL_STATUS,
                                                             VL_MESSAGE_D);
        REC_TA5000.DTEENDSELLOUT                := F_CHECK_FORMAT_D( VL_CODDIV, RL_XIN_TA5000.DTEENDSELLOUT,
                                                             'DTEENDSELLOUT',
                                                             VL_DES_TA5000,
                                                             VL_STATUS,
                                                             VL_MESSAGE_D);
        REC_TA5000.DTEABORT                := F_CHECK_FORMAT_D( VL_CODDIV, RL_XIN_TA5000.DTEABORT,
                                                             'DTEABORT',
                                                             VL_DES_TA5000,
                                                             VL_STATUS,
                                                             VL_MESSAGE_D);
        REC_TA5000.CODDEVELOPMENT                := F_CHECK_FORMAT_S(VL_CODDIV, RL_XIN_TA5000.CODDEVELOPMENT,
                                                             'CODDEVELOPMENT',
                                                             VL_DES_TA5000,
                                                             VL_STATUS,
                                                             VL_MESSAGE_D);
        REC_TA5000.CODCONTRACTUALMODE                := F_CHECK_FORMAT_S(VL_CODDIV, RL_XIN_TA5000.CODCONTRACTUALMODE,
                                                             'CODCONTRACTUALMODE',
                                                             VL_DES_TA5000,
                                                             VL_STATUS,
                                                             VL_MESSAGE_D);
        REC_TA5000.LEVPARTICIPANTS                := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_TA5000.LEVPARTICIPANTS,
                                                             'LEVPARTICIPANTS',
                                                             VL_DES_TA5000,
                                                             VL_STATUS,
                                                             VL_MESSAGE_D);
        REC_TA5000.FLGPARTICIPANTSBLOCKED                := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_TA5000.FLGPARTICIPANTSBLOCKED,
                                                             'FLGPARTICIPANTSBLOCKED',
                                                             VL_DES_TA5000,
                                                             VL_STATUS,
                                                             VL_MESSAGE_D);
        REC_TA5000.FLGDELIVERPOINTSBLOCKED                := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_TA5000.FLGDELIVERPOINTSBLOCKED,
                                                             'FLGDELIVERPOINTSBLOCKED',
                                                             VL_DES_TA5000,
                                                             VL_STATUS,
                                                             VL_MESSAGE_D);
        REC_TA5000.DELIVERYPOINTSFILTERSGROUPNAME          := F_CHECK_FORMAT_S(VL_CODDIV, RL_XIN_TA5000.DELIVERYPOINTSFILTERSGROUPNAME,
                                                             'DELIVERYPOINTSFILTERSGROUPNAME',
                                                             VL_DES_TA5000,
                                                             VL_STATUS,
                                                             VL_MESSAGE_D);

        REC_TA5000.PARENTIDACTION                := F_CHECK_FORMAT_S(VL_CODDIV, RL_XIN_TA5000.PARENTIDACTION,
                                                             'PARENTIDACTION',
                                                             VL_DES_TA5000,
                                                             VL_STATUS,
                                                             VL_MESSAGE_D);
        REC_TA5000.SOURCEIDACTION                := F_CHECK_FORMAT_S(VL_CODDIV, RL_XIN_TA5000.SOURCEIDACTION,
                                                             'SOURCEIDACTION',
                                                             VL_DES_TA5000,
                                                             VL_STATUS,
                                                             VL_MESSAGE_D);
        REC_TA5000.CODUSRCOPY                := F_CHECK_FORMAT_S(VL_CODDIV, RL_XIN_TA5000.CODUSRCOPY,
                                                             'CODUSRCOPY',
                                                             VL_DES_TA5000,
                                                             VL_STATUS,
                                                             VL_MESSAGE_D);

        REC_TA5000.DTESTARTNEGOTIATION                := F_CHECK_FORMAT_D( VL_CODDIV, RL_XIN_TA5000.DTESTARTNEGOTIATION,
                                                             'DTESTARTNEGOTIATION',
                                                             VL_DES_TA5000,
                                                             VL_STATUS,
                                                             VL_MESSAGE_D);
        REC_TA5000.DTEENDNEGOTIATION                := F_CHECK_FORMAT_D( VL_CODDIV, RL_XIN_TA5000.DTEENDNEGOTIATION,
                                                             'DTEENDNEGOTIATION',
                                                             VL_DES_TA5000,
                                                             VL_STATUS,
                                                             VL_MESSAGE_D);
        REC_TA5000.ATTRIBUTE1                := F_CHECK_FORMAT_S(VL_CODDIV, RL_XIN_TA5000.ATTRIBUTE1,
                                                             'ATTRIBUTE1',
                                                             VL_DES_TA5000,
                                                             VL_STATUS,
                                                             VL_MESSAGE_D);
        REC_TA5000.ATTRIBUTE2                := F_CHECK_FORMAT_S(VL_CODDIV, RL_XIN_TA5000.ATTRIBUTE2,
                                                             'ATTRIBUTE2',
                                                             VL_DES_TA5000,
                                                             VL_STATUS,
                                                             VL_MESSAGE_D);
        REC_TA5000.ATTRIBUTE3                := F_CHECK_FORMAT_S(VL_CODDIV, RL_XIN_TA5000.ATTRIBUTE3,
                                                             'ATTRIBUTE3',
                                                             VL_DES_TA5000,
                                                             VL_STATUS,
                                                             VL_MESSAGE_D);
        REC_TA5000.NUMATTRIBUTE1                := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_TA5000.NUMATTRIBUTE1,
                                                             'NUMATTRIBUTE1',
                                                             VL_DES_TA5000,
                                                             VL_STATUS,
                                                             VL_MESSAGE_D);
        REC_TA5000.NUMATTRIBUTE2                := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_TA5000.NUMATTRIBUTE2,
                                                             'NUMATTRIBUTE2',
                                                             VL_DES_TA5000,
                                                             VL_STATUS,
                                                             VL_MESSAGE_D);
        REC_TA5000.NUMATTRIBUTE3                := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_TA5000.NUMATTRIBUTE3,
                                                             'NUMATTRIBUTE2',
                                                             VL_DES_TA5000,
                                                             VL_STATUS,
                                                             VL_MESSAGE_D);
        --- Technical fields
        REC_TA5000.DTECRE                       := XSYSDATE;
        REC_TA5000.CODUSRCREREAL                := C_SYSUSR;
        REC_TA5000.CODUSRMODREAL                := C_SYSUSR;
        REC_TA5000.CODUSRMOD                    := C_SYSUSR;
        REC_TA5000.CODUSRCRE                     := C_SYSUSR;
        REC_TA5000.DTEMOD                       := XSYSDATE;
        -- workflow fields
        -- new promo is always confirmed
        REC_TA5000.IDWFSTATE      := vl_wf_codstatehard;
        REC_TA5000.IDWFMODEL      := C_WORKFLOWID_TA5000; -- Workflow for promo
        REC_TA5000.CODWFSTATEHARD := vl_wf_codstatehard; -- confirmed
        --LOCK FIELDS
        REC_TA5000.CODUSRLCK                :=C_SYSUSR ;
        REC_TA5000.DTELCK                   := XSYSDATE;
        REC_TA5000.IDSESSIONLCK             :=PI_SESSION_ID ;
        --DOCUMENT KEY
        REC_TA5000.DOCUMENTKEY              := PKG_UTILS.documentkey_for_ta5000(REC_TA5000.IDACTION);


        IF (VL_STATUS <> 0) THEN

          VL_MESSAGE_H := SUBSTR(VL_MESSAGE_H || ' ' || VL_MESSAGE_D || ' ' ||
                                 dbms_utility.format_error_backtrace() || ' ' || SQLERRM,
                                 1,
                                 4000);

          PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                         VL_PROGR_D_TA5000,
                                         SQLCODE,
                                         VL_MESSAGE_H);
        ELSE
        VL_IDACTION := NULL;
        BEGIN

         IF (VL_STATUS = 0) THEN
          -- Finds if it already exists
           SELECT IDACTION
              INTO VL_IDACTION
              FROM ta5000promoaction
             WHERE CODDIV          = REC_TA5000.CODDIV
               AND CODRESPONSIBLE  = REC_TA5000.CODRESPONSIBLE
               AND CODCONTRACTOR   = REC_TA5000.CODCONTRACTOR
               AND LEVCONTRACTOR   = REC_TA5000.LEVCONTRACTOR
               AND CODCOVERING     = REC_TA5000.CODCOVERING
               AND DTESTARTSELLIN  = REC_TA5000.DTESTARTSELLIN
               AND DTEENDSELLIN    = REC_TA5000.DTEENDSELLIN
               AND DTESTARTSELLOUT = REC_TA5000.DTESTARTSELLOUT
               AND DTEENDSELLOUT   = REC_TA5000.DTEENDSELLOUT
               AND LEVPARTICIPANTS = REC_TA5000.LEVPARTICIPANTS
               AND CODDEVELOPMENT  = REC_TA5000.CODDEVELOPMENT;
          -- when status <> 0 some fields have incorrect format. Log t800 has been already wrote by F_CHECK function
          -- Update article if already exists

          VL_MESSAGE_D := 'Update TA5000PROMOACTION ';

          UPDATE TA5000PROMOACTION
             SET -- when the field si set to updated by host it means that the value should be read from XIN
                 -- otherwise it means that the field is managed by sm1 and it maintains its original value
                 DESACTION = CASE VL_DES_TA5000('DESACTION')
                                           .FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA5000.DESACTION ELSE DESACTION END,
                 CODRESPONSIBLE = CASE VL_DES_TA5000('CODRESPONSIBLE')
                                           .FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA5000.CODRESPONSIBLE ELSE CODRESPONSIBLE END,
                 CODCONTRACTOR = CASE VL_DES_TA5000('CODCONTRACTOR')
                                           .FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA5000.CODCONTRACTOR ELSE CODCONTRACTOR END,
                 LEVCONTRACTOR = CASE VL_DES_TA5000('LEVCONTRACTOR')
                                           .FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA5000.LEVCONTRACTOR ELSE LEVCONTRACTOR END,
                 TOTALPOTENTIAL = CASE VL_DES_TA5000('TOTALPOTENTIAL')
                                           .FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA5000.TOTALPOTENTIAL ELSE TOTALPOTENTIAL END,
                 CODCOVERING = CASE VL_DES_TA5000('CODCOVERING')
                                           .FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA5000.CODCOVERING ELSE CODCOVERING END,
                 DTESTARTSELLIN = CASE VL_DES_TA5000('DTESTARTSELLIN')
                                           .FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA5000.DTESTARTSELLIN ELSE DTESTARTSELLIN END,
                 DTEENDSELLIN = CASE VL_DES_TA5000('DTEENDSELLIN')
                                           .FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA5000.DTEENDSELLIN ELSE DTEENDSELLIN END,
                 DELTASELLIN = CASE VL_DES_TA5000('DELTASELLIN')
                                           .FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA5000.DELTASELLIN ELSE DELTASELLIN END,
                 DTESTARTSELLOUT = CASE VL_DES_TA5000('DTESTARTSELLOUT')
                                           .FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA5000.DTESTARTSELLOUT ELSE DTESTARTSELLOUT END,
                 DTEENDSELLOUT = CASE VL_DES_TA5000('DTEENDSELLOUT')
                                           .FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA5000.DTEENDSELLOUT ELSE DTEENDSELLOUT END,
                 DTEABORT = CASE VL_DES_TA5000('DTEABORT')
                                           .FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA5000.DTEABORT ELSE DTEABORT END,
                 CODDEVELOPMENT = CASE VL_DES_TA5000('CODDEVELOPMENT')
                                           .FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA5000.CODDEVELOPMENT ELSE CODDEVELOPMENT END,
                 CODCONTRACTUALMODE = CASE VL_DES_TA5000('CODCONTRACTUALMODE')
                                           .FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA5000.CODCONTRACTUALMODE ELSE CODCONTRACTUALMODE END,
                 LEVPARTICIPANTS = CASE VL_DES_TA5000('LEVPARTICIPANTS')
                                           .FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA5000.LEVPARTICIPANTS ELSE LEVPARTICIPANTS END,
                 FLGPARTICIPANTSBLOCKED = CASE VL_DES_TA5000('FLGPARTICIPANTSBLOCKED')
                                           .FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA5000.FLGPARTICIPANTSBLOCKED ELSE FLGPARTICIPANTSBLOCKED END,
                 FLGDELIVERPOINTSBLOCKED = CASE VL_DES_TA5000('FLGDELIVERPOINTSBLOCKED')
                                           .FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA5000.FLGDELIVERPOINTSBLOCKED ELSE FLGDELIVERPOINTSBLOCKED END,
                 DELIVERYPOINTSFILTERSGROUPNAME = CASE VL_DES_TA5000('DELIVERYPOINTSFILTERSGROUPNAME')
                                           .FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA5000.DELIVERYPOINTSFILTERSGROUPNAME ELSE DELIVERYPOINTSFILTERSGROUPNAME END,
                 PARENTIDACTION = CASE VL_DES_TA5000('PARENTIDACTION')
                                           .FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA5000.PARENTIDACTION ELSE PARENTIDACTION END,
                 SOURCEIDACTION = CASE VL_DES_TA5000('SOURCEIDACTION')
                                           .FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA5000.SOURCEIDACTION ELSE SOURCEIDACTION END,
                 CODUSRCOPY = CASE VL_DES_TA5000('CODUSRCOPY')
                                           .FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA5000.CODUSRCOPY ELSE CODUSRCOPY END,
                 DTECRE = CASE VL_DES_TA5000('DTECRE')
                                           .FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA5000.DTECRE ELSE DTECRE END,
                 CODUSRCRE = CASE VL_DES_TA5000('CODUSRCRE')
                                           .FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA5000.CODUSRCRE ELSE CODUSRCRE END,
                 DTESTARTNEGOTIATION = CASE VL_DES_TA5000('DTESTARTNEGOTIATION')
                                           .FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA5000.DTESTARTNEGOTIATION ELSE DTESTARTNEGOTIATION END,
                 DTEENDNEGOTIATION = CASE VL_DES_TA5000('DTEENDNEGOTIATION')
                                           .FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA5000.DTEENDNEGOTIATION ELSE DTEENDNEGOTIATION END,
                 ATTRIBUTE1 = CASE VL_DES_TA5000('ATTRIBUTE1')
                                           .FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA5000.ATTRIBUTE1 ELSE ATTRIBUTE1 END,
                 ATTRIBUTE2 = CASE VL_DES_TA5000('ATTRIBUTE2')
                                           .FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA5000.ATTRIBUTE2 ELSE ATTRIBUTE2 END,
                 ATTRIBUTE3 = CASE VL_DES_TA5000('ATTRIBUTE3')
                                           .FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA5000.ATTRIBUTE3 ELSE ATTRIBUTE3 END,
                 NUMATTRIBUTE1 = CASE VL_DES_TA5000('NUMATTRIBUTE1')
                                           .FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA5000.NUMATTRIBUTE1 ELSE NUMATTRIBUTE1 END,
                 NUMATTRIBUTE2 = CASE VL_DES_TA5000('NUMATTRIBUTE2')
                                           .FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA5000.NUMATTRIBUTE2 ELSE NUMATTRIBUTE2 END,
                 NUMATTRIBUTE3 = CASE VL_DES_TA5000('NUMATTRIBUTE3')
                                           .FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA5000.NUMATTRIBUTE3 ELSE NUMATTRIBUTE3 END,
                 --- Technical fields
                 CODUSRMOD     = REC_TA5000.CODUSRMOD,
                 CODUSRMODREAL = REC_TA5000.CODUSRMODREAL,
                 DTEMOD        = REC_TA5000.DTEMOD,
                 -- lock fields
                 CODUSRLCK    = REC_TA5000.CODUSRLCK,
                 IDSESSIONLCK = REC_TA5000.IDSESSIONLCK,
                 DTELCK       = REC_TA5000.DTELCK

           WHERE IDACTION = VL_IDACTION
            and not exists ( select null from T035LOGGEDUSERS T035 where T035.IDSESSION = NVL(IDSESSIONLCK, '@') AND T035.LASTCHECK > TRUNC(XSYSDATE)-1 );

          -- no data found, it could be
          --   a. record does not exists
          --   b. record is locked by another sm1 user

            IF SQL%ROWCOUNT = 0 THEN

              VL_STATUS        := -1;
              VL_RECORD_LOCKED := -1;
              PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                             VL_PROGR_D_TA5000,
                                             SQLCODE,
                                             'Record is locked; import has failed :' ||
                                             VL_MESSAGE_H);
            END IF; -- Record has been inserted

          END IF;
          EXCEPTION
            WHEN OTHERS THEN

              -- calculate the id action and inserts it new
              VL_IDACTION := LPAD(REC_TA5000.CODUSRCRE,5,'0') || LPAD(REC_TA5000.CODDIV,5,'0')||'1'||LPAD(PKG_UTILS.fn_getprogressive('IDACTION'),9,'0');

              REC_TA5000.IDACTION    := VL_IDACTION;
              REC_TA5000.DOCUMENTKEY := PKG_UTILS.documentkey_for_ta5000(VL_IDACTION);

              VL_MESSAGE_D := 'Insert TA5000PROMOACTION ';
              -- Record does not exists, we insert it
              INSERT INTO TA5000PROMOACTION VALUES REC_TA5000;

                -- insert first step on workflow
              VL_MESSAGE_D := 'insert first step on workflow ';
              P_INS_WF_FIRST_STEP(PI_PROGR_H,VL_PROGR_D_TA5000, C_WORKFLOWID_TA5000, REC_TA5000.DOCUMENTKEY, vl_wf_stateid, vl_status );


          END;

      END IF;

      END; -- HEAD TA5000

    BEGIN
      -- -----------------------------------
      -- TA5002 PROMO ACTION ACTIVITIES
      -- -----------------------------------
          --
        IF (VL_STATUS = 0) THEN
          -- TA5002PROMOACTIONACTIVITIES
           FOR RL_XIN_TA5002 IN CL_XIN_TA5002(RL_XIN_TA5000.IDACTION,
                                         RL_XIN_TA5000.SM1_DTECRE) LOOP

            VL_MESSAGE_H := 'Action: ' || RL_XIN_TA5002.IDACTION || '/' ||
                            'Activity: ' || RL_XIN_TA5002.CODACTIVITY;

            VL_MESSAGE_D := 'Format Conversion ';

            REC_TA5002.IDACTION := REC_TA5000.IDACTION;
            REC_TA5002.CODACTIVITY := F_CHECK_FORMAT_S(VL_CODDIV, RL_XIN_TA5002.CODACTIVITY,
                                                  'CODACTIVITY',
                                                  VL_DES_TA5002,
                                                  VL_STATUS,
                                                  VL_MESSAGE_D);

            REC_TA5002.CONTRIBUTION1 := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_TA5002.CONTRIBUTION1,
                                                  'CONTRIBUTION1',
                                                  VL_DES_TA5002,
                                                  VL_STATUS,
                                                  VL_MESSAGE_D);
            REC_TA5002.CONTRIBUTION2 := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_TA5002.CONTRIBUTION2,
                                                  'CONTRIBUTION2',
                                                  VL_DES_TA5002,
                                                  VL_STATUS,
                                                  VL_MESSAGE_D);
            REC_TA5002.CONTRIBUTION3 := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_TA5002.CONTRIBUTION3,
                                                  'CONTRIBUTION3',
                                                  VL_DES_TA5002,
                                                  VL_STATUS,
                                                  VL_MESSAGE_D);
            REC_TA5002.REFERENCEAGENCY := F_CHECK_FORMAT_S(VL_CODDIV, RL_XIN_TA5002.REFERENCEAGENCY,
                                                  'REFERENCEAGENCY',
                                                  VL_DES_TA5002,
                                                  VL_STATUS,
                                                  VL_MESSAGE_D);
            REC_TA5002.ESTIMATEDCOST := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_TA5002.ESTIMATEDCOST,
                                                  'ESTIMATEDCOST',
                                                  VL_DES_TA5002,
                                                  VL_STATUS,
                                                  VL_MESSAGE_D);
            REC_TA5002.STRMEASURE1 := F_CHECK_FORMAT_S(VL_CODDIV, RL_XIN_TA5002.STRMEASURE1,
                                                  'STRMEASURE1',
                                                  VL_DES_TA5002,
                                                  VL_STATUS,
                                                  VL_MESSAGE_D);
            REC_TA5002.FLGMEASURE1 := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_TA5002.FLGMEASURE1,
                                                  'FLGMEASURE1',
                                                  VL_DES_TA5002,
                                                  VL_STATUS,
                                                  VL_MESSAGE_D);
            IF (VL_STATUS <> 0) THEN
              VL_MESSAGE_H := SUBSTR(VL_MESSAGE_H || ' ' || VL_MESSAGE_D || ' ' ||
                                     dbms_utility.format_error_backtrace() || ' ' || SQLERRM,
                                     1,
                                     4000);
              PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                             VL_PROGR_D_TA5002,
                                             SQLCODE,
                                             VL_MESSAGE_H);
            END IF;
            IF (VL_STATUS = 0) THEN
              --
              VL_MESSAGE_D := 'Update TA5002 ';
              UPDATE TA5002PROMOACTIONACTIVITIES
                 SET CONTRIBUTION1             = CASE VL_DES_TA5002('CONTRIBUTION1')
                                          .FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA5002.CONTRIBUTION1 ELSE CONTRIBUTION1 END,
                     CONTRIBUTION2             = CASE VL_DES_TA5002('CONTRIBUTION2')
                                          .FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA5002.CONTRIBUTION2 ELSE CONTRIBUTION2 END,
                     CONTRIBUTION3             = CASE VL_DES_TA5002('CONTRIBUTION3')
                                          .FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA5002.CONTRIBUTION3 ELSE CONTRIBUTION3 END,
                     REFERENCEAGENCY             = CASE VL_DES_TA5002('REFERENCEAGENCY')
                                          .FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA5002.REFERENCEAGENCY ELSE REFERENCEAGENCY END,
                     ESTIMATEDCOST             = CASE VL_DES_TA5002('ESTIMATEDCOST')
                                          .FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA5002.ESTIMATEDCOST ELSE ESTIMATEDCOST END,
                     STRMEASURE1             = CASE VL_DES_TA5002('STRMEASURE1')
                                          .FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA5002.STRMEASURE1 ELSE STRMEASURE1 END,
                     FLGMEASURE1             = CASE VL_DES_TA5002('FLGMEASURE1')
                                          .FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA5002.FLGMEASURE1 ELSE FLGMEASURE1 END

               WHERE IDACTION    = REC_TA5002.IDACTION
                 AND CODACTIVITY = REC_TA5002.CODACTIVITY;
              --
              VL_CODACTIVITY := REC_TA5002.CODACTIVITY;
              IF SQL%ROWCOUNT = 0 THEN
                -- record does not exists , we insert it
                VL_MESSAGE_D := 'Insert TA5002 ';
                INSERT INTO TA5002PROMOACTIONACTIVITIES VALUES REC_TA5002;
              END IF;
              VL_INS_TA5002 := VL_INS_TA5002 + 1;
              --
            END IF;
            --


           END LOOP; -- TA5002
        END IF; --( VL_STATUS = 0 AND VL_RECORD_LOCKED = 0 )
            EXCEPTION
        WHEN OTHERS THEN
          VL_STATUS    := -1;
          VL_MESSAGE_H := SUBSTR(VL_MESSAGE_H || ' ' || VL_MESSAGE_D || ' ' ||
                                 dbms_utility.format_error_backtrace() || ' ' || SQLERRM,
                                 1,
                                 4000);

          PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                         VL_PROGR_D_TA5002,
                                         SQLCODE,
                                         VL_MESSAGE_H);

      END; --- TA5002 PROMO ACTION ACTIVITIES

         --  TA5012PARTICIPANTS
         ---
        --
      IF (VL_STATUS = 0) THEN

          FOR RL_XIN_TA5012 IN CL_XIN_TA5012(RL_XIN_TA5000.IDACTION,
                                         RL_XIN_TA5000.SM1_DTECRE) LOOP

          VL_MESSAGE_H := 'Action: ' || RL_XIN_TA5012.IDACTION || '/' ||
                          'Participant: ' || RL_XIN_TA5012.CODPARTICIPANT;

          VL_MESSAGE_D := 'Format Conversion ';
        --  VL_CODDIV:= REC_TA5012.CODDIV;
          REC_TA5012.IDACTION := REC_TA5000.IDACTION;
          REC_TA5012.CODPARTICIPANT := F_CHECK_FORMAT_S(VL_CODDIV, RL_XIN_TA5012.CODPARTICIPANT,
                                                  'CODPARTICIPANT',
                                                  VL_DES_TA5012,
                                                  VL_STATUS,
                                                  VL_MESSAGE_D);
          REC_TA5012.FLGINCLUSION := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_TA5012.FLGINCLUSION,
                                                  'FLGINCLUSION',
                                                  VL_DES_TA5012,
                                                  VL_STATUS,
                                                  VL_MESSAGE_D);
          REC_TA5012.CODLASTSAVEDSTATUS := F_CHECK_FORMAT_S(VL_CODDIV, RL_XIN_TA5012.CODLASTSAVEDSTATUS,
                                                  'CODLASTSAVEDSTATUS',
                                                  VL_DES_TA5012,
                                                  VL_STATUS,
                                                  VL_MESSAGE_D);
          IF (VL_STATUS <> 0) THEN
              VL_MESSAGE_H := SUBSTR(VL_MESSAGE_H || ' ' || VL_MESSAGE_D || ' ' ||
                                     dbms_utility.format_error_backtrace() || ' ' || SQLERRM,
                                     1,
                                     4000);
              PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                             VL_PROGR_D_TA5012,
                                             SQLCODE,
                                             VL_MESSAGE_H);
          END IF;
          IF (VL_STATUS = 0) THEN
              --
              VL_MESSAGE_D := 'Update TA5012 ';
              UPDATE TA5012PARTICIPANTS
                 SET
                     FLGINCLUSION             = CASE VL_DES_TA5012('FLGINCLUSION.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA5012.FLGINCLUSION ELSE FLGINCLUSION END,
                     CODLASTSAVEDSTATUS       = CASE VL_DES_TA5012('CODLASTSAVEDSTATUS.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA5012.CODLASTSAVEDSTATUS ELSE CODLASTSAVEDSTATUS END
              WHERE IDACTION = REC_TA5012.IDACTION
                AND CODPARTICIPANT = REC_TA5012.CODPARTICIPANT;
              --
              IF SQL%ROWCOUNT = 0 THEN
                -- record does not exists , we insert it
                VL_MESSAGE_D := 'Insert TA5012 ';
                INSERT INTO TA5012PARTICIPANTS VALUES REC_TA5012;
              END IF;
              VL_INS_TA5012 := VL_INS_TA5012 + 1;

              --
              END IF;
           END LOOP; -- TA5012
         END IF;
        --
         ---
         --  TA5014PARTICIPANTS
         ---
         IF (VL_STATUS = 0) THEN

          FOR RL_XIN_TA5014 IN CL_XIN_TA5014(RL_XIN_TA5000.IDACTION,
                                         RL_XIN_TA5000.SM1_DTECRE) LOOP

          VL_MESSAGE_H := 'Action: ' || RL_XIN_TA5014.IDACTION || '/' ||
                          'Delivery point: ' || RL_XIN_TA5014.CODDELIVERYPOINT;

          VL_MESSAGE_D := 'Format Conversion ';
          --VL_CODDIV:= REC_TA5014.CODDIV;
          REC_TA5014.IDACTION := REC_TA5000.IDACTION;
          REC_TA5014.CODDELIVERYPOINT := F_CHECK_FORMAT_S(VL_CODDIV, RL_XIN_TA5014.CODDELIVERYPOINT,
                                                  'CODDELIVERYPOINT',
                                                  VL_DES_TA5014,
                                                  VL_STATUS,
                                                  VL_MESSAGE_D);
          REC_TA5014.DTESTART := F_CHECK_FORMAT_D( VL_CODDIV, RL_XIN_TA5014.DTESTART,
                                                  'DTESTART',
                                                  VL_DES_TA5014,
                                                  VL_STATUS,
                                                  VL_MESSAGE_D);
          REC_TA5014.DTEEND := F_CHECK_FORMAT_D( VL_CODDIV, RL_XIN_TA5014.DTEEND,
                                                  'DTEEND',
                                                  VL_DES_TA5014,
                                                  VL_STATUS,
                                                  VL_MESSAGE_D);
          REC_TA5014.FLGINCLUSION := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_TA5014.FLGINCLUSION,
                                                  'FLGINCLUSION',
                                                  VL_DES_TA5014,
                                                  VL_STATUS,
                                                  VL_MESSAGE_D);
          REC_TA5014.CODLASTSAVEDSTATUS := F_CHECK_FORMAT_S(VL_CODDIV, RL_XIN_TA5014.CODLASTSAVEDSTATUS,
                                                  'CODLASTSAVEDSTATUS',
                                                  VL_DES_TA5014,
                                                  VL_STATUS,
                                                  VL_MESSAGE_D);

          REC_TA5014.CODNODE0 := F_CHECK_FORMAT_S(VL_CODDIV, RL_XIN_TA5014.CODNODE0,
                                                  'CODNODE0',
                                                  VL_DES_TA5014,
                                                  VL_STATUS,
                                                  VL_MESSAGE_D);
          REC_TA5014.CODNODE1 := F_CHECK_FORMAT_S(VL_CODDIV, RL_XIN_TA5014.CODNODE1,
                                                  'CODNODE1',
                                                  VL_DES_TA5014,
                                                  VL_STATUS,
                                                  VL_MESSAGE_D);
          REC_TA5014.CODNODE2 := F_CHECK_FORMAT_S(VL_CODDIV, RL_XIN_TA5014.CODNODE2,
                                                  'CODNODE2',
                                                  VL_DES_TA5014,
                                                  VL_STATUS,
                                                  VL_MESSAGE_D);
          REC_TA5014.CODNODE3 := F_CHECK_FORMAT_S(VL_CODDIV, RL_XIN_TA5014.CODNODE3,
                                                  'CODNODE3',
                                                  VL_DES_TA5014,
                                                  VL_STATUS,
                                                  VL_MESSAGE_D);
          REC_TA5014.CODNODE4 := F_CHECK_FORMAT_S(VL_CODDIV, RL_XIN_TA5014.CODNODE4,
                                                  'CODNODE4',
                                                  VL_DES_TA5014,
                                                  VL_STATUS,
                                                  VL_MESSAGE_D);
          REC_TA5014.CODNODE5 := F_CHECK_FORMAT_S(VL_CODDIV, RL_XIN_TA5014.CODNODE5,
                                                  'CODNODE5',
                                                  VL_DES_TA5014,
                                                  VL_STATUS,
                                                  VL_MESSAGE_D);
          REC_TA5014.CODNODE6 := F_CHECK_FORMAT_S(VL_CODDIV, RL_XIN_TA5014.CODNODE6,
                                                  'CODNODE6',
                                                  VL_DES_TA5014,
                                                  VL_STATUS,
                                                  VL_MESSAGE_D);
          REC_TA5014.CODNODE7 := F_CHECK_FORMAT_S(VL_CODDIV, RL_XIN_TA5014.CODNODE7,
                                                  'CODNODE7',
                                                  VL_DES_TA5014,
                                                  VL_STATUS,
                                                  VL_MESSAGE_D);


          IF (VL_STATUS <> 0) THEN
              VL_MESSAGE_H := SUBSTR(VL_MESSAGE_H || ' ' || VL_MESSAGE_D || ' ' ||
                                     dbms_utility.format_error_backtrace() || ' ' || SQLERRM,
                                     1,
                                     4000);
              PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                             VL_PROGR_D_TA5014,
                                             SQLCODE,
                                             VL_MESSAGE_H);
            END IF;
          IF (VL_STATUS = 0) THEN
              --
              VL_MESSAGE_D := 'Update TA5014 ';
              UPDATE TA5014DELIVERYPOINTS
                 SET
                     DTESTART           = CASE VL_DES_TA5014('DTESTART.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA5014.DTESTART ELSE DTESTART END,
                     DTEEND             = CASE VL_DES_TA5014('DTEEND.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA5014.DTEEND ELSE DTEEND END,
                     FLGINCLUSION       = CASE VL_DES_TA5014('FLGINCLUSION.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA5014.FLGINCLUSION ELSE FLGINCLUSION END,
                     CODLASTSAVEDSTATUS = CASE VL_DES_TA5014('CODLASTSAVEDSTATUS.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA5014.CODLASTSAVEDSTATUS ELSE CODLASTSAVEDSTATUS END,
                     CODNODE0           = CASE VL_DES_TA5014('CODNODE0.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA5014.CODNODE0 ELSE CODNODE0 END,
                     CODNODE1           = CASE VL_DES_TA5014('CODNODE1.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA5014.CODNODE1 ELSE CODNODE1 END,
                     CODNODE2           = CASE VL_DES_TA5014('CODNODE2.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA5014.CODNODE2 ELSE CODNODE2 END,
                     CODNODE3           = CASE VL_DES_TA5014('CODNODE3.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA5014.CODNODE3 ELSE CODNODE3 END,
                     CODNODE4           = CASE VL_DES_TA5014('CODNODE4.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA5014.CODNODE4 ELSE CODNODE4 END,
                     CODNODE5           = CASE VL_DES_TA5014('CODNODE5.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA5014.CODNODE5 ELSE CODNODE5 END,
                     CODNODE6           = CASE VL_DES_TA5014('CODNODE6.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA5014.CODNODE6 ELSE CODNODE6 END,
                     CODNODE7           = CASE VL_DES_TA5014('CODNODE7.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA5014.CODNODE7 ELSE CODNODE7 END

              WHERE IDACTION         = REC_TA5014.IDACTION
                AND CODDELIVERYPOINT = REC_TA5014.CODDELIVERYPOINT;
              --
              IF SQL%ROWCOUNT = 0 THEN
                -- record does not exists , we insert it
                VL_MESSAGE_D := 'Insert TA5014 ';
                INSERT INTO TA5014DELIVERYPOINTS VALUES REC_TA5014;
              END IF;
              VL_INS_TA5014 := VL_INS_TA5014 + 1;

              --
              END IF;

           END LOOP; -- TA5014
         END IF;
         ---
         --  TA5020PRODUCTS
         ---
         IF (VL_STATUS = 0) THEN

          FOR RL_XIN_TA5020 IN CL_XIN_TA5020(RL_XIN_TA5000.IDACTION,
                                         RL_XIN_TA5000.SM1_DTECRE) LOOP

          VL_MESSAGE_H := 'Action: ' || RL_XIN_TA5020.IDACTION || '/' ||
                          'Product: ' || RL_XIN_TA5020.CODPRODUCT || '/' ||
                          'Level: ' || RL_XIN_TA5020.LEVPRODUCT;
         BEGIN
          VL_MESSAGE_D := 'Format Conversion ';
      --    VL_CODDIV := REC_TA5020.CODDIV;
          REC_TA5020.IDACTION := REC_TA5000.IDACTION;
          REC_TA5020.CODPRODUCT := F_CHECK_FORMAT_S(VL_CODDIV, RL_XIN_TA5020.CODPRODUCT,
                                                  'CODPRODUCT',
                                                  VL_DES_TA5020,
                                                  VL_STATUS,
                                                  VL_MESSAGE_D);

/*          REC_TA5020.CODCAUSE := F_CHECK_FORMAT_S(VL_CODDIV, RL_XIN_TA5020.CODCAUSE,
                                                  'CODCAUSE',
                                                  VL_DES_TA5020,
                                                  VL_STATUS,
                                                  VL_MESSAGE_D);
*/
          REC_TA5020.QTYESTIMATED := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_TA5020.QTYESTIMATED,
                                                  'QTYESTIMATED',
                                                  VL_DES_TA5020,
                                                  VL_STATUS,
                                                  VL_MESSAGE_D);
          REC_TA5020.QTYSIMULATED := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_TA5020.QTYSIMULATED,
                                                  'QTYSIMULATED',
                                                  VL_DES_TA5020,
                                                  VL_STATUS,
                                                  VL_MESSAGE_D);
          REC_TA5020.QTYBASELINE := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_TA5020.QTYBASELINE,
                                                  'QTYBASELINE',
                                                  VL_DES_TA5020,
                                                  VL_STATUS,
                                                  VL_MESSAGE_D);
          REC_TA5020.QTYUPLIFT := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_TA5020.QTYUPLIFT,
                                                  'QTYUPLIFT',
                                                  VL_DES_TA5020,
                                                  VL_STATUS,
                                                  VL_MESSAGE_D);
          REC_TA5020.DISCOUNTPERCENTAGE1 := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_TA5020.DISCOUNTPERCENTAGE1,
                                                  'DISCOUNTPERCENTAGE1',
                                                  VL_DES_TA5020,
                                                  VL_STATUS,
                                                  VL_MESSAGE_D);
          REC_TA5020.DISCOUNTPERCENTAGE2 := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_TA5020.DISCOUNTPERCENTAGE2,
                                                  'DISCOUNTPERCENTAGE2',
                                                  VL_DES_TA5020,
                                                  VL_STATUS,
                                                  VL_MESSAGE_D);
         REC_TA5020.DISCOUNTPERCENTAGE3 := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_TA5020.DISCOUNTPERCENTAGE3,
                                                  'DISCOUNTPERCENTAGE3',
                                                  VL_DES_TA5020,
                                                  VL_STATUS,
                                                  VL_MESSAGE_D);

         REC_TA5020.PIECEDISCOUNT1 := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_TA5020.PIECEDISCOUNT1,
                                                  'PIECEDISCOUNT1',
                                                  VL_DES_TA5020,
                                                  VL_STATUS,
                                                  VL_MESSAGE_D);
         REC_TA5020.PIECEDISCOUNT2 := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_TA5020.PIECEDISCOUNT2,
                                                  'PIECEDISCOUNT2',
                                                  VL_DES_TA5020,
                                                  VL_STATUS,
                                                  VL_MESSAGE_D);
         REC_TA5020.PIECEDISCOUNT3 := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_TA5020.PIECEDISCOUNT3,
                                                  'PIECEDISCOUNT3',
                                                  VL_DES_TA5020,
                                                  VL_STATUS,
                                                  VL_MESSAGE_D);
         REC_TA5020.GOODSDISCOUNTQTYTOBUY := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_TA5020.GOODSDISCOUNTQTYTOBUY,
                                                  'GOODSDISCOUNTQTYTOBUY',
                                                  VL_DES_TA5020,
                                                  VL_STATUS,
                                                  VL_MESSAGE_D);
         REC_TA5020.GOODSDISCOUNTQTYGIFT := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_TA5020.GOODSDISCOUNTQTYGIFT,
                                                  'GOODSDISCOUNTQTYGIFT',
                                                  VL_DES_TA5020,
                                                  VL_STATUS,
                                                  VL_MESSAGE_D);
         REC_TA5020.GOODSDISCOUNTUM := F_CHECK_FORMAT_S(VL_CODDIV, RL_XIN_TA5020.GOODSDISCOUNTUM,
                                                  'GOODSDISCOUNTUM',
                                                  VL_DES_TA5020,
                                                  VL_STATUS,
                                                  VL_MESSAGE_D);
         REC_TA5020.FREEDISCOUNTQTYTOBUY := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_TA5020.FREEDISCOUNTQTYTOBUY,
                                                  'FREEDISCOUNTQTYTOBUY',
                                                  VL_DES_TA5020,
                                                  VL_STATUS,
                                                  VL_MESSAGE_D);
         REC_TA5020.FREEDISCOUNTUM := F_CHECK_FORMAT_S(VL_CODDIV, RL_XIN_TA5020.FREEDISCOUNTUM,
                                                  'FREEDISCOUNTUM',
                                                  VL_DES_TA5020,
                                                  VL_STATUS,
                                                  VL_MESSAGE_D);
         REC_TA5020.FREEDISCOUNTQTYGIFT := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_TA5020.FREEDISCOUNTQTYGIFT,
                                                  'FREEDISCOUNTQTYGIFT',
                                                  VL_DES_TA5020,
                                                  VL_STATUS,
                                                  VL_MESSAGE_D);
         REC_TA5020.FREEDISCOUNTGIFTCODE := F_CHECK_FORMAT_S(VL_CODDIV, RL_XIN_TA5020.FREEDISCOUNTGIFTCODE,
                                                  'FREEDISCOUNTGIFTCODE',
                                                  VL_DES_TA5020,
                                                  VL_STATUS,
                                                  VL_MESSAGE_D);
         REC_TA5020.FREEDISCOUNTGIFTUM := F_CHECK_FORMAT_S(VL_CODDIV, RL_XIN_TA5020.FREEDISCOUNTGIFTUM,
                                                  'FREEDISCOUNTGIFTUM',
                                                  VL_DES_TA5020,
                                                  VL_STATUS,
                                                  VL_MESSAGE_D);
         REC_TA5020.ESTIMATEDDISCOUNTPERCENTAGE1 := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_TA5020.ESTIMATEDDISCOUNTPERCENTAGE1,
                                                  'ESTIMATEDDISCOUNTPERCENTAGE1',
                                                  VL_DES_TA5020,
                                                  VL_STATUS,
                                                  VL_MESSAGE_D);
         REC_TA5020.ESTIMATEDDISCOUNTPERCENTAGE2 := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_TA5020.ESTIMATEDDISCOUNTPERCENTAGE2,
                                                  'ESTIMATEDDISCOUNTPERCENTAGE2',
                                                  VL_DES_TA5020,
                                                  VL_STATUS,
                                                  VL_MESSAGE_D);
         REC_TA5020.ESTIMATEDDISCOUNTPERCENTAGE3 := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_TA5020.ESTIMATEDDISCOUNTPERCENTAGE3,
                                                  'ESTIMATEDDISCOUNTPERCENTAGE3',
                                                  VL_DES_TA5020,
                                                  VL_STATUS,
                                                  VL_MESSAGE_D);
         REC_TA5020.ESTIMATEDPIECEDISCOUNT1 := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_TA5020.ESTIMATEDPIECEDISCOUNT1,
                                                  'ESTIMATEDPIECEDISCOUNT1',
                                                  VL_DES_TA5020,
                                                  VL_STATUS,
                                                  VL_MESSAGE_D);
         REC_TA5020.ESTIMATEDPIECEDISCOUNT2 := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_TA5020.ESTIMATEDPIECEDISCOUNT2,
                                                  'ESTIMATEDPIECEDISCOUNT2',
                                                  VL_DES_TA5020,
                                                  VL_STATUS,
                                                  VL_MESSAGE_D);
         REC_TA5020.ESTIMATEDPIECEDISCOUNT3 := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_TA5020.ESTIMATEDPIECEDISCOUNT3,
                                                  'ESTIMATEDPIECEDISCOUNT3',
                                                  VL_DES_TA5020,
                                                  VL_STATUS,
                                                  VL_MESSAGE_D);
         REC_TA5020.ESTIMATEDGOODSDISCOUNT := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_TA5020.ESTIMATEDGOODSDISCOUNT,
                                                  'ESTIMATEDGOODSDISCOUNT',
                                                  VL_DES_TA5020,
                                                  VL_STATUS,
                                                  VL_MESSAGE_D);
         REC_TA5020.ESTIMATEDFREEDISCOUNT := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_TA5020.ESTIMATEDFREEDISCOUNT,
                                                  'ESTIMATEDFREEDISCOUNT',
                                                  VL_DES_TA5020,
                                                  VL_STATUS,
                                                  VL_MESSAGE_D);
         REC_TA5020.TOTALESTIMATEDDISCOUNT := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_TA5020.TOTALESTIMATEDDISCOUNT,
                                                  'TOTALESTIMATEDDISCOUNT',
                                                  VL_DES_TA5020,
                                                  VL_STATUS,
                                                  VL_MESSAGE_D);
         REC_TA5020.INCIDENCEDISCOUNTPERCENTAGE1 := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_TA5020.INCIDENCEDISCOUNTPERCENTAGE1,
                                                  'INCIDENCEDISCOUNTPERCENTAGE1',
                                                  VL_DES_TA5020,
                                                  VL_STATUS,
                                                  VL_MESSAGE_D);
         REC_TA5020.INCIDENCEDISCOUNTPERCENTAGE2 := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_TA5020.INCIDENCEDISCOUNTPERCENTAGE2,
                                                  'INCIDENCEDISCOUNTPERCENTAGE2',
                                                  VL_DES_TA5020,
                                                  VL_STATUS,
                                                  VL_MESSAGE_D);
         REC_TA5020.INCIDENCEDISCOUNTPERCENTAGE3 := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_TA5020.INCIDENCEDISCOUNTPERCENTAGE3,
                                                  'INCIDENCEDISCOUNTPERCENTAGE3',
                                                  VL_DES_TA5020,
                                                  VL_STATUS,
                                                  VL_MESSAGE_D);
         REC_TA5020.INCIDENCEPIECEDISCOUNT1 := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_TA5020.INCIDENCEPIECEDISCOUNT1,
                                                  'INCIDENCEPIECEDISCOUNT1',
                                                  VL_DES_TA5020,
                                                  VL_STATUS,
                                                  VL_MESSAGE_D);
         REC_TA5020.INCIDENCEPIECEDISCOUNT2 := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_TA5020.INCIDENCEPIECEDISCOUNT2,
                                                  'INCIDENCEPIECEDISCOUNT2',
                                                  VL_DES_TA5020,
                                                  VL_STATUS,
                                                  VL_MESSAGE_D);
         REC_TA5020.INCIDENCEPIECEDISCOUNT3 := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_TA5020.INCIDENCEPIECEDISCOUNT3,
                                                  'INCIDENCEPIECEDISCOUNT3',
                                                  VL_DES_TA5020,
                                                  VL_STATUS,
                                                  VL_MESSAGE_D);
         REC_TA5020.INCIDENCEGOODSDISCOUNT := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_TA5020.INCIDENCEGOODSDISCOUNT,
                                                  'INCIDENCEGOODSDISCOUNT',
                                                  VL_DES_TA5020,
                                                  VL_STATUS,
                                                  VL_MESSAGE_D);
         REC_TA5020.INCIDENCEFREEDISCOUNT := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_TA5020.INCIDENCEFREEDISCOUNT,
                                                  'INCIDENCEFREEDISCOUNT',
                                                  VL_DES_TA5020,
                                                  VL_STATUS,
                                                  VL_MESSAGE_D);
         REC_TA5020.TOTALINCIDENCEDISCOUNT := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_TA5020.TOTALINCIDENCEDISCOUNT,
                                                  'TOTALINCIDENCEDISCOUNT',
                                                  VL_DES_TA5020,
                                                  VL_STATUS,
                                                  VL_MESSAGE_D);
         REC_TA5020.CONTRIBUTION1 := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_TA5020.CONTRIBUTION1,
                                                  'CONTRIBUTION1',
                                                  VL_DES_TA5020,
                                                  VL_STATUS,
                                                  VL_MESSAGE_D);
         REC_TA5020.CONTRIBUTION2 := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_TA5020.CONTRIBUTION2,
                                                  'CONTRIBUTION2',
                                                  VL_DES_TA5020,
                                                  VL_STATUS,
                                                  VL_MESSAGE_D);
         REC_TA5020.CONTRIBUTION3 := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_TA5020.CONTRIBUTION3,
                                                  'CONTRIBUTION3',
                                                  VL_DES_TA5020,
                                                  VL_STATUS,
                                                  VL_MESSAGE_D);
         REC_TA5020.ESTIMATEDCOST := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_TA5020.ESTIMATEDCOST,
                                                  'ESTIMATEDCOST',
                                                  VL_DES_TA5020,
                                                  VL_STATUS,
                                                  VL_MESSAGE_D);
         REC_TA5020.PREPROMOPRICE := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_TA5020.PREPROMOPRICE,
                                                  'PREPROMOPRICE',
                                                  VL_DES_TA5020,
                                                  VL_STATUS,
                                                  VL_MESSAGE_D);
         REC_TA5020.FINALPRICE := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_TA5020.FINALPRICE,
                                                  'FINALPRICE',
                                                  VL_DES_TA5020,
                                                  VL_STATUS,
                                                  VL_MESSAGE_D);

         REC_TA5020.NETTURNOVER := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_TA5020.NETTURNOVER,
                                                  'NETTURNOVER',
                                                  VL_DES_TA5020,
                                                  VL_STATUS,
                                                  VL_MESSAGE_D);
         REC_TA5020.TOTALESTIMATED := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_TA5020.TOTALESTIMATED,
                                                  'TOTALESTIMATED',
                                                  VL_DES_TA5020,
                                                  VL_STATUS,
                                                  VL_MESSAGE_D);
         REC_TA5020.SELLOUTPRICE := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_TA5020.SELLOUTPRICE,
                                                  'SELLOUTPRICE',
                                                  VL_DES_TA5020,
                                                  VL_STATUS,
                                                  VL_MESSAGE_D);
        REC_TA5020.SELLOUTDISCOUNTPERCENTAGE := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_TA5020.SELLOUTDISCOUNTPERCENTAGE,
                                                  'SELLOUTDISCOUNTPERCENTAGE',
                                                  VL_DES_TA5020,
                                                  VL_STATUS,
                                                  VL_MESSAGE_D);
        REC_TA5020.FINALSELLOUTPRICE := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_TA5020.FINALSELLOUTPRICE,
                                                  'FINALSELLOUTPRICE',
                                                  VL_DES_TA5020,
                                                  VL_STATUS,
                                                  VL_MESSAGE_D);
        REC_TA5020.SELLOUTNETTURNOVER := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_TA5020.SELLOUTNETTURNOVER,
                                                  'SELLOUTNETTURNOVER',
                                                  VL_DES_TA5020,
                                                  VL_STATUS,
                                                  VL_MESSAGE_D);
        REC_TA5020.ESTIMATEDSELLOUTDISCOUNT := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_TA5020.ESTIMATEDSELLOUTDISCOUNT,
                                                  'ESTIMATEDSELLOUTDISCOUNT',
                                                  VL_DES_TA5020,
                                                  VL_STATUS,
                                                  VL_MESSAGE_D);
        REC_TA5020.TOTALESTIMATEDSELLOUT := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_TA5020.TOTALESTIMATEDSELLOUT,
                                                  'TOTALESTIMATEDSELLOUT',
                                                  VL_DES_TA5020,
                                                  VL_STATUS,
                                                  VL_MESSAGE_D);
        REC_TA5020.TOTALINCIDENCESELLOUT := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_TA5020.TOTALINCIDENCESELLOUT,
                                                  'TOTALINCIDENCESELLOUT',
                                                  VL_DES_TA5020,
                                                  VL_STATUS,
                                                  VL_MESSAGE_D);
        REC_TA5020.NUMMEASURE1 := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_TA5020.NUMMEASURE1,
                                                  'NUMMEASURE1',
                                                  VL_DES_TA5020,
                                                  VL_STATUS,
                                                  VL_MESSAGE_D);
        REC_TA5020.NUMMEASURE2 := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_TA5020.NUMMEASURE2,
                                                  'NUMMEASURE2',
                                                  VL_DES_TA5020,
                                                  VL_STATUS,
                                                  VL_MESSAGE_D);
        REC_TA5020.NUMMEASURE3 := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_TA5020.NUMMEASURE3,
                                                  'NUMMEASURE3',
                                                  VL_DES_TA5020,
                                                  VL_STATUS,
                                                  VL_MESSAGE_D);
        REC_TA5020.NUMMEASURE4 := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_TA5020.NUMMEASURE4,
                                                  'NUMMEASURE4',
                                                  VL_DES_TA5020,
                                                  VL_STATUS,
                                                  VL_MESSAGE_D);
        REC_TA5020.NUMMEASURE5 := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_TA5020.NUMMEASURE5,
                                                  'NUMMEASURE5',
                                                  VL_DES_TA5020,
                                                  VL_STATUS,
                                                  VL_MESSAGE_D);
        REC_TA5020.NUMMEASURE6 := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_TA5020.NUMMEASURE6,
                                                  'NUMMEASURE6',
                                                  VL_DES_TA5020,
                                                  VL_STATUS,
                                                  VL_MESSAGE_D);
        REC_TA5020.NUMMEASURE7 := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_TA5020.NUMMEASURE7,
                                                  'NUMMEASURE7',
                                                  VL_DES_TA5020,
                                                  VL_STATUS,
                                                  VL_MESSAGE_D);
        REC_TA5020.NUMMEASURE8 := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_TA5020.NUMMEASURE8,
                                                  'NUMMEASURE8',
                                                  VL_DES_TA5020,
                                                  VL_STATUS,
                                                  VL_MESSAGE_D);
        REC_TA5020.NUMMEASURE9 := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_TA5020.NUMMEASURE9,
                                                  'NUMMEASURE9',
                                                  VL_DES_TA5020,
                                                  VL_STATUS,
                                                  VL_MESSAGE_D);
        REC_TA5020.NUMMEASURE10 := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_TA5020.NUMMEASURE10,
                                                  'NUMMEASURE10',
                                                  VL_DES_TA5020,
                                                  VL_STATUS,
                                                  VL_MESSAGE_D);
        REC_TA5020.STRMEASURE1 := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_TA5020.STRMEASURE1,
                                                  'STRMEASURE1',
                                                  VL_DES_TA5020,
                                                  VL_STATUS,
                                                  VL_MESSAGE_D);
        REC_TA5020.STRMEASURE2 := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_TA5020.STRMEASURE2,
                                                  'STRMEASURE2',
                                                  VL_DES_TA5020,
                                                  VL_STATUS,
                                                  VL_MESSAGE_D);
        REC_TA5020.STRMEASURE3 := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_TA5020.STRMEASURE3,
                                                  'STRMEASURE3',
                                                  VL_DES_TA5020,
                                                  VL_STATUS,
                                                  VL_MESSAGE_D) ;
        REC_TA5020.STRMEASURE4 := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_TA5020.STRMEASURE4,
                                                  'STRMEASURE4',
                                                  VL_DES_TA5020,
                                                  VL_STATUS,
                                                  VL_MESSAGE_D);
        REC_TA5020.STRMEASURE5 := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_TA5020.STRMEASURE5,
                                                  'STRMEASURE5',
                                                  VL_DES_TA5020,
                                                  VL_STATUS,
                                                  VL_MESSAGE_D);
        REC_TA5020.STRMEASURE6 := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_TA5020.STRMEASURE6,
                                                  'STRMEASURE6',
                                                  VL_DES_TA5020,
                                                  VL_STATUS,
                                                  VL_MESSAGE_D);
        REC_TA5020.STRMEASURE7 := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_TA5020.STRMEASURE7,
                                                  'STRMEASURE7',
                                                  VL_DES_TA5020,
                                                  VL_STATUS,
                                                  VL_MESSAGE_D) ;
        REC_TA5020.STRMEASURE8 := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_TA5020.STRMEASURE8,
                                                  'STRMEASURE8',
                                                  VL_DES_TA5020,
                                                  VL_STATUS,
                                                  VL_MESSAGE_D) ;
        REC_TA5020.STRMEASURE9 := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_TA5020.STRMEASURE9,
                                                  'STRMEASURE9',
                                                  VL_DES_TA5020,
                                                  VL_STATUS,
                                                  VL_MESSAGE_D) ;
        REC_TA5020.STRMEASURE10 := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_TA5020.STRMEASURE10,
                                                  'STRMEASURE10',
                                                  VL_DES_TA5020,
                                                  VL_STATUS,
                                                  VL_MESSAGE_D);
        REC_TA5020.DTEMEASURE1 := F_CHECK_FORMAT_D( VL_CODDIV, RL_XIN_TA5020.DTEMEASURE1,
                                                  'DTEMEASURE1',
                                                  VL_DES_TA5020,
                                                  VL_STATUS,
                                                  VL_MESSAGE_D) ;
        REC_TA5020.DTEMEASURE2 := F_CHECK_FORMAT_D( VL_CODDIV, RL_XIN_TA5020.DTEMEASURE2,
                                                  'DTEMEASURE2',
                                                  VL_DES_TA5020,
                                                  VL_STATUS,
                                                  VL_MESSAGE_D) ;
        REC_TA5020.DTEMEASURE3 := F_CHECK_FORMAT_D( VL_CODDIV, RL_XIN_TA5020.DTEMEASURE3,
                                                  'DTEMEASURE3',
                                                  VL_DES_TA5020,
                                                  VL_STATUS,
                                                  VL_MESSAGE_D) ;
        REC_TA5020.DTEMEASURE4 := F_CHECK_FORMAT_D( VL_CODDIV, RL_XIN_TA5020.DTEMEASURE4,
                                                  'DTEMEASURE4',
                                                  VL_DES_TA5020,
                                                  VL_STATUS,
                                                  VL_MESSAGE_D) ;
        REC_TA5020.DTEMEASURE5 := F_CHECK_FORMAT_D( VL_CODDIV, RL_XIN_TA5020.DTEMEASURE5,
                                                  'DTEMEASURE5',
                                                  VL_DES_TA5020,
                                                  VL_STATUS,
                                                  VL_MESSAGE_D) ;
        REC_TA5020.DTEMEASURE6 := F_CHECK_FORMAT_D( VL_CODDIV, RL_XIN_TA5020.DTEMEASURE6,
                                                  'DTEMEASURE6',
                                                  VL_DES_TA5020,
                                                  VL_STATUS,
                                                  VL_MESSAGE_D) ;
        REC_TA5020.DTEMEASURE7 := F_CHECK_FORMAT_D( VL_CODDIV, RL_XIN_TA5020.DTEMEASURE7,
                                                  'DTEMEASURE7',
                                                  VL_DES_TA5020,
                                                  VL_STATUS,
                                                  VL_MESSAGE_D) ;
        REC_TA5020.DTEMEASURE8 := F_CHECK_FORMAT_D( VL_CODDIV, RL_XIN_TA5020.DTEMEASURE8,
                                                  'DTEMEASURE8',
                                                  VL_DES_TA5020,
                                                  VL_STATUS,
                                                  VL_MESSAGE_D) ;
        REC_TA5020.DTEMEASURE9 := F_CHECK_FORMAT_D( VL_CODDIV, RL_XIN_TA5020.DTEMEASURE9,
                                                  'DTEMEASURE9',
                                                  VL_DES_TA5020,
                                                  VL_STATUS,
                                                  VL_MESSAGE_D) ;

       REC_TA5020.DTEMEASURE10 := F_CHECK_FORMAT_D( VL_CODDIV, RL_XIN_TA5020.DTEMEASURE10,
                                                  'DTEMEASURE10',
                                                  VL_DES_TA5020,
                                                  VL_STATUS,
                                                  VL_MESSAGE_D) ;
       REC_TA5020.NUMMEASURE11 := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_TA5020.NUMMEASURE11,
                                                  'NUMMEASURE11',
                                                  VL_DES_TA5020,
                                                  VL_STATUS,
                                                  VL_MESSAGE_D) ;
       REC_TA5020.NUMMEASURE12 := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_TA5020.NUMMEASURE12,
                                                  'NUMMEASURE12',
                                                  VL_DES_TA5020,
                                                  VL_STATUS,
                                                  VL_MESSAGE_D) ;
       REC_TA5020.NUMMEASURE13 := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_TA5020.NUMMEASURE13,
                                                  'NUMMEASURE13',
                                                  VL_DES_TA5020,
                                                  VL_STATUS,
                                                  VL_MESSAGE_D) ;
       REC_TA5020.NUMMEASURE14 := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_TA5020.NUMMEASURE14,
                                                  'NUMMEASURE14',
                                                  VL_DES_TA5020,
                                                  VL_STATUS,
                                                  VL_MESSAGE_D) ;
       REC_TA5020.NUMMEASURE15 := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_TA5020.NUMMEASURE15,
                                                  'NUMMEASURE15',
                                                  VL_DES_TA5020,
                                                  VL_STATUS,
                                                  VL_MESSAGE_D) ;
       REC_TA5020.NUMMEASURE16 := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_TA5020.NUMMEASURE16,
                                                  'NUMMEASURE16',
                                                  VL_DES_TA5020,
                                                  VL_STATUS,
                                                  VL_MESSAGE_D) ;
       REC_TA5020.NUMMEASURE17 := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_TA5020.NUMMEASURE17,
                                                  'NUMMEASURE17',
                                                  VL_DES_TA5020,
                                                  VL_STATUS,
                                                  VL_MESSAGE_D) ;
       REC_TA5020.NUMMEASURE18 := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_TA5020.NUMMEASURE18,
                                                  'NUMMEASURE18',
                                                  VL_DES_TA5020,
                                                  VL_STATUS,
                                                  VL_MESSAGE_D) ;
       REC_TA5020.NUMMEASURE19 := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_TA5020.NUMMEASURE19,
                                                  'NUMMEASURE19',
                                                  VL_DES_TA5020,
                                                  VL_STATUS,
                                                  VL_MESSAGE_D) ;
       REC_TA5020.NUMMEASURE20 := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_TA5020.NUMMEASURE20,
                                                  'NUMMEASURE20',
                                                  VL_DES_TA5020,
                                                  VL_STATUS,
                                                  VL_MESSAGE_D) ;

       REC_TA5020.FLGMEASURE1 := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_TA5020.FLGMEASURE1,
                                                  'FLGMEASURE1',
                                                  VL_DES_TA5020,
                                                  VL_STATUS,
                                                  VL_MESSAGE_D) ;
       REC_TA5020.FLGMEASURE2 := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_TA5020.FLGMEASURE2,
                                                  'FLGMEASURE2',
                                                  VL_DES_TA5020,
                                                  VL_STATUS,
                                                  VL_MESSAGE_D) ;
       REC_TA5020.FLGMEASURE3 := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_TA5020.FLGMEASURE3,
                                                  'FLGMEASURE3',
                                                  VL_DES_TA5020,
                                                  VL_STATUS,
                                                  VL_MESSAGE_D) ;
       REC_TA5020.FLGMEASURE4 := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_TA5020.FLGMEASURE4,
                                                  'FLGMEASURE4',
                                                  VL_DES_TA5020,
                                                  VL_STATUS,
                                                  VL_MESSAGE_D) ;
       REC_TA5020.FLGMEASURE5 := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_TA5020.FLGMEASURE5,
                                                  'FLGMEASURE5',
                                                  VL_DES_TA5020,
                                                  VL_STATUS,
                                                  VL_MESSAGE_D) ;
       REC_TA5020.FLGMEASURE6 := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_TA5020.FLGMEASURE6,
                                                  'FLGMEASURE6',
                                                  VL_DES_TA5020,
                                                  VL_STATUS,
                                                  VL_MESSAGE_D) ;
      REC_TA5020.FLGMEASURE7 := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_TA5020.FLGMEASURE7,
                                                  'FLGMEASURE7',
                                                  VL_DES_TA5020,
                                                  VL_STATUS,
                                                  VL_MESSAGE_D) ;
      REC_TA5020.FLGMEASURE8 := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_TA5020.FLGMEASURE8,
                                                  'FLGMEASURE8',
                                                  VL_DES_TA5020,
                                                  VL_STATUS,
                                                  VL_MESSAGE_D) ;
      REC_TA5020.FLGMEASURE9 := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_TA5020.FLGMEASURE9,
                                                  'FLGMEASURE9',
                                                  VL_DES_TA5020,
                                                  VL_STATUS,
                                                  VL_MESSAGE_D) ;
      REC_TA5020.FLGMEASURE10 := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_TA5020.FLGMEASURE10,
                                                  'FLGMEASURE10',
                                                  VL_DES_TA5020,
                                                  VL_STATUS,
                                                  VL_MESSAGE_D) ;
      REC_TA5020.FB := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_TA5020.FB,
                                                  'FB',
                                                  VL_DES_TA5020,
                                                  VL_STATUS,
                                                  VL_MESSAGE_D) ;
      REC_TA5020.SELLOUTPROMOPRICE := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_TA5020.SELLOUTPROMOPRICE,
                                                  'SELLOUTPROMOPRICE',
                                                  VL_DES_TA5020,
                                                  VL_STATUS,
                                                  VL_MESSAGE_D) ;
      REC_TA5020.CONTRIBUTION_RETAILER := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_TA5020.CONTRIBUTION_RETAILER,
                                                  'CONTRIBUTION_RETAILER',
                                                  VL_DES_TA5020,
                                                  VL_STATUS,
                                                  VL_MESSAGE_D) ;


      REC_TA5020.QTYESTIMATEDDISPLAY := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_TA5020.QTYESTIMATEDDISPLAY,
                                                  'QTYESTIMATEDDISPLAY',
                                                  VL_DES_TA5020,
                                                  VL_STATUS,
                                                  VL_MESSAGE_D) ;



      REC_TA5020.NUMCOMPONENTS := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_TA5020.NUMCOMPONENTS,
                                                  'NUMCOMPONENTS',
                                                  VL_DES_TA5020,
                                                  VL_STATUS,
                                                  VL_MESSAGE_D) ;



      IF (VL_STATUS <> 0) THEN
              VL_MESSAGE_H := SUBSTR(VL_MESSAGE_H || ' ' || VL_MESSAGE_D || ' ' ||
                                     dbms_utility.format_error_backtrace() || ' ' || SQLERRM,
                                     1,
                                     4000);
              PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                             VL_PROGR_D_TA5020,
                                             SQLCODE,
                                             VL_MESSAGE_H);
       END IF;
       IF (VL_STATUS = 0) THEN
              --
              VL_MESSAGE_D := 'Update TA5020 ';
              UPDATE TA5020PRODUCTS
                 SET /*CODCAUSE             = CASE VL_DES_TA5020('CODCAUSE')
                                          .FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA5020.CODCAUSE ELSE CODCAUSE END, */
                     QTYESTIMATED             = CASE VL_DES_TA5020('QTYESTIMATED')
                                          .FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA5020.QTYESTIMATED ELSE QTYESTIMATED END,
                     QTYSIMULATED             = CASE VL_DES_TA5020('QTYSIMULATED')
                                          .FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA5020.QTYSIMULATED ELSE QTYSIMULATED END,
                     QTYBASELINE             = CASE VL_DES_TA5020('QTYBASELINE')
                                          .FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA5020.QTYBASELINE ELSE QTYBASELINE END,
                     QTYUPLIFT             = CASE VL_DES_TA5020('QTYUPLIFT')
                                          .FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA5020.QTYUPLIFT ELSE QTYUPLIFT END,
                     DISCOUNTPERCENTAGE1             = CASE VL_DES_TA5020('DISCOUNTPERCENTAGE1')
                                          .FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA5020.DISCOUNTPERCENTAGE1 ELSE DISCOUNTPERCENTAGE1 END,
                     DISCOUNTPERCENTAGE2             = CASE VL_DES_TA5020('DISCOUNTPERCENTAGE2')
                                          .FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA5020.DISCOUNTPERCENTAGE2 ELSE DISCOUNTPERCENTAGE2 END,
                     DISCOUNTPERCENTAGE3             = CASE VL_DES_TA5020('DISCOUNTPERCENTAGE3')
                                          .FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA5020.DISCOUNTPERCENTAGE3 ELSE DISCOUNTPERCENTAGE3 END,
                     PIECEDISCOUNT1             = CASE VL_DES_TA5020('PIECEDISCOUNT1')
                                          .FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA5020.PIECEDISCOUNT1 ELSE PIECEDISCOUNT1 END,
                     PIECEDISCOUNT2             = CASE VL_DES_TA5020('PIECEDISCOUNT2')
                                          .FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA5020.PIECEDISCOUNT2 ELSE PIECEDISCOUNT2 END,
                     PIECEDISCOUNT3             = CASE VL_DES_TA5020('PIECEDISCOUNT3')
                                          .FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA5020.PIECEDISCOUNT3 ELSE PIECEDISCOUNT3 END,
                     GOODSDISCOUNTQTYTOBUY             = CASE VL_DES_TA5020('GOODSDISCOUNTQTYTOBUY')
                                          .FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA5020.GOODSDISCOUNTQTYTOBUY ELSE GOODSDISCOUNTQTYTOBUY END,
                     GOODSDISCOUNTQTYGIFT             = CASE VL_DES_TA5020('GOODSDISCOUNTQTYGIFT')
                                          .FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA5020.GOODSDISCOUNTQTYGIFT ELSE GOODSDISCOUNTQTYGIFT END,
                     GOODSDISCOUNTUM             = CASE VL_DES_TA5020('GOODSDISCOUNTUM')
                                          .FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA5020.GOODSDISCOUNTUM ELSE GOODSDISCOUNTUM END,
                     FREEDISCOUNTQTYTOBUY             = CASE VL_DES_TA5020('FREEDISCOUNTQTYTOBUY')
                                          .FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA5020.FREEDISCOUNTQTYTOBUY ELSE FREEDISCOUNTQTYTOBUY END,
                     FREEDISCOUNTQTYGIFT             = CASE VL_DES_TA5020('FREEDISCOUNTQTYGIFT')
                                          .FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA5020.FREEDISCOUNTQTYGIFT ELSE FREEDISCOUNTQTYGIFT END,
                     FREEDISCOUNTGIFTCODE             = CASE VL_DES_TA5020('FREEDISCOUNTGIFTCODE')
                                          .FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA5020.FREEDISCOUNTGIFTCODE ELSE FREEDISCOUNTGIFTCODE END,
                     FREEDISCOUNTGIFTUM             = CASE VL_DES_TA5020('FREEDISCOUNTGIFTUM')
                                          .FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA5020.FREEDISCOUNTGIFTUM ELSE FREEDISCOUNTGIFTUM END,
                     ESTIMATEDDISCOUNTPERCENTAGE1             = CASE VL_DES_TA5020('ESTIMATEDDISCOUNTPERCENTAGE1')
                                          .FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA5020.ESTIMATEDDISCOUNTPERCENTAGE1 ELSE ESTIMATEDDISCOUNTPERCENTAGE1 END,
                     ESTIMATEDDISCOUNTPERCENTAGE2             = CASE VL_DES_TA5020('ESTIMATEDDISCOUNTPERCENTAGE2')
                                          .FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA5020.ESTIMATEDDISCOUNTPERCENTAGE2 ELSE ESTIMATEDDISCOUNTPERCENTAGE2 END,
                     ESTIMATEDDISCOUNTPERCENTAGE3             = CASE VL_DES_TA5020('ESTIMATEDDISCOUNTPERCENTAGE3')
                                          .FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA5020.ESTIMATEDDISCOUNTPERCENTAGE3 ELSE ESTIMATEDDISCOUNTPERCENTAGE3 END,
                     ESTIMATEDPIECEDISCOUNT1             = CASE VL_DES_TA5020('ESTIMATEDPIECEDISCOUNT1')
                                          .FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA5020.ESTIMATEDPIECEDISCOUNT1 ELSE ESTIMATEDPIECEDISCOUNT1 END,
                     ESTIMATEDPIECEDISCOUNT2             = CASE VL_DES_TA5020('ESTIMATEDPIECEDISCOUNT2')
                                          .FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA5020.ESTIMATEDPIECEDISCOUNT2 ELSE ESTIMATEDPIECEDISCOUNT2 END,
                     ESTIMATEDPIECEDISCOUNT3             = CASE VL_DES_TA5020('ESTIMATEDPIECEDISCOUNT3')
                                          .FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA5020.ESTIMATEDPIECEDISCOUNT3 ELSE ESTIMATEDPIECEDISCOUNT3 END,
                     ESTIMATEDFREEDISCOUNT             = CASE VL_DES_TA5020('ESTIMATEDFREEDISCOUNT')
                                          .FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA5020.ESTIMATEDFREEDISCOUNT ELSE ESTIMATEDFREEDISCOUNT END,
                     TOTALESTIMATEDDISCOUNT             = CASE VL_DES_TA5020('TOTALESTIMATEDDISCOUNT')
                                          .FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA5020.TOTALESTIMATEDDISCOUNT ELSE TOTALESTIMATEDDISCOUNT END,
                     INCIDENCEDISCOUNTPERCENTAGE1             = CASE VL_DES_TA5020('INCIDENCEDISCOUNTPERCENTAGE1')
                                          .FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA5020.INCIDENCEDISCOUNTPERCENTAGE1 ELSE INCIDENCEDISCOUNTPERCENTAGE1 END,
                     INCIDENCEDISCOUNTPERCENTAGE2             = CASE VL_DES_TA5020('INCIDENCEDISCOUNTPERCENTAGE2')
                                          .FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA5020.INCIDENCEDISCOUNTPERCENTAGE2 ELSE INCIDENCEDISCOUNTPERCENTAGE2 END,
                     INCIDENCEDISCOUNTPERCENTAGE3             = CASE VL_DES_TA5020('INCIDENCEDISCOUNTPERCENTAGE3')
                                          .FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA5020.INCIDENCEDISCOUNTPERCENTAGE3 ELSE INCIDENCEDISCOUNTPERCENTAGE3 END,
                     INCIDENCEPIECEDISCOUNT1             = CASE VL_DES_TA5020('INCIDENCEPIECEDISCOUNT1')
                                          .FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA5020.INCIDENCEPIECEDISCOUNT1 ELSE INCIDENCEPIECEDISCOUNT1 END,
                     INCIDENCEPIECEDISCOUNT2             = CASE VL_DES_TA5020('INCIDENCEPIECEDISCOUNT2')
                                          .FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA5020.INCIDENCEPIECEDISCOUNT2 ELSE INCIDENCEPIECEDISCOUNT2 END,
                     INCIDENCEPIECEDISCOUNT3             = CASE VL_DES_TA5020('INCIDENCEPIECEDISCOUNT3')
                                          .FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA5020.INCIDENCEPIECEDISCOUNT3 ELSE INCIDENCEPIECEDISCOUNT3 END,
                     INCIDENCEGOODSDISCOUNT             = CASE VL_DES_TA5020('INCIDENCEGOODSDISCOUNT')
                                          .FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA5020.INCIDENCEGOODSDISCOUNT ELSE INCIDENCEGOODSDISCOUNT END,
                     TOTALINCIDENCEDISCOUNT             = CASE VL_DES_TA5020('TOTALINCIDENCEDISCOUNT')
                                          .FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA5020.TOTALINCIDENCEDISCOUNT ELSE TOTALINCIDENCEDISCOUNT END,
                     CONTRIBUTION1             = CASE VL_DES_TA5020('CONTRIBUTION1')
                                          .FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA5020.CONTRIBUTION1 ELSE CONTRIBUTION1 END,
                     CONTRIBUTION2             = CASE VL_DES_TA5020('CONTRIBUTION2')
                                          .FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA5020.CONTRIBUTION2 ELSE CONTRIBUTION2 END,
                     CONTRIBUTION3             = CASE VL_DES_TA5020('CONTRIBUTION3')
                                          .FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA5020.CONTRIBUTION3 ELSE CONTRIBUTION3 END,
                     ESTIMATEDCOST             = CASE VL_DES_TA5020('ESTIMATEDCOST')
                                          .FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA5020.ESTIMATEDCOST ELSE ESTIMATEDCOST END,
                     PREPROMOPRICE             = CASE VL_DES_TA5020('PREPROMOPRICE')
                                          .FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA5020.PREPROMOPRICE ELSE PREPROMOPRICE END,
                     FINALPRICE             = CASE VL_DES_TA5020('FINALPRICE')
                                          .FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA5020.FINALPRICE ELSE FINALPRICE END,
                     NETTURNOVER             = CASE VL_DES_TA5020('NETTURNOVER')
                                          .FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA5020.NETTURNOVER ELSE NETTURNOVER END,
                     TOTALESTIMATED             = CASE VL_DES_TA5020('TOTALESTIMATED')
                                          .FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA5020.TOTALESTIMATED ELSE TOTALESTIMATED END,
                     TOTALINCIDENCE             = CASE VL_DES_TA5020('TOTALINCIDENCE')
                                          .FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA5020.TOTALINCIDENCE ELSE TOTALINCIDENCE END,
                     SELLOUTPRICE             = CASE VL_DES_TA5020('SELLOUTPRICE')
                                          .FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA5020.SELLOUTPRICE ELSE SELLOUTPRICE END,
                     SELLOUTDISCOUNTPERCENTAGE             = CASE VL_DES_TA5020('SELLOUTDISCOUNTPERCENTAGE')
                                          .FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA5020.SELLOUTDISCOUNTPERCENTAGE ELSE SELLOUTDISCOUNTPERCENTAGE END,
                     FINALSELLOUTPRICE             = CASE VL_DES_TA5020('FINALSELLOUTPRICE')
                                          .FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA5020.FINALSELLOUTPRICE ELSE FINALSELLOUTPRICE END,
                     SELLOUTNETTURNOVER             = CASE VL_DES_TA5020('SELLOUTNETTURNOVER')
                                          .FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA5020.SELLOUTNETTURNOVER ELSE SELLOUTNETTURNOVER END,
                     ESTIMATEDSELLOUTDISCOUNT             = CASE VL_DES_TA5020('ESTIMATEDSELLOUTDISCOUNT')
                                          .FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA5020.ESTIMATEDSELLOUTDISCOUNT ELSE ESTIMATEDSELLOUTDISCOUNT END,
                     TOTALESTIMATEDSELLOUT             = CASE VL_DES_TA5020('TOTALESTIMATEDSELLOUT')
                                          .FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA5020.TOTALESTIMATEDSELLOUT ELSE TOTALESTIMATEDSELLOUT END,
                     TOTALINCIDENCESELLOUT             = CASE VL_DES_TA5020('TOTALINCIDENCESELLOUT')
                                          .FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA5020.TOTALINCIDENCESELLOUT ELSE TOTALINCIDENCESELLOUT END,
                     NUMMEASURE1             = CASE VL_DES_TA5020('NUMMEASURE1')
                                          .FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA5020.NUMMEASURE1 ELSE NUMMEASURE1 END,
                     NUMMEASURE2             = CASE VL_DES_TA5020('NUMMEASURE2')
                                          .FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA5020.NUMMEASURE2 ELSE NUMMEASURE2 END,
                     NUMMEASURE3             = CASE VL_DES_TA5020('NUMMEASURE3')
                                          .FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA5020.NUMMEASURE3 ELSE NUMMEASURE3 END,
                     NUMMEASURE4             = CASE VL_DES_TA5020('NUMMEASURE4')
                                          .FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA5020.NUMMEASURE4 ELSE NUMMEASURE4 END,
                     NUMMEASURE5             = CASE VL_DES_TA5020('NUMMEASURE5')
                                          .FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA5020.NUMMEASURE5 ELSE NUMMEASURE5 END,
                     NUMMEASURE6             = CASE VL_DES_TA5020('NUMMEASURE6')
                                          .FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA5020.NUMMEASURE6 ELSE NUMMEASURE6 END,
                     NUMMEASURE7             = CASE VL_DES_TA5020('NUMMEASURE7')
                                          .FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA5020.NUMMEASURE7 ELSE NUMMEASURE7 END,
                     NUMMEASURE8             = CASE VL_DES_TA5020('NUMMEASURE8')
                                          .FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA5020.NUMMEASURE8 ELSE NUMMEASURE8 END,
                     NUMMEASURE9             = CASE VL_DES_TA5020('NUMMEASURE9')
                                          .FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA5020.NUMMEASURE9 ELSE NUMMEASURE9 END,
                     NUMMEASURE10             = CASE VL_DES_TA5020('NUMMEASURE10')
                                          .FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA5020.NUMMEASURE10 ELSE NUMMEASURE10 END,
                     STRMEASURE1             = CASE VL_DES_TA5020('STRMEASURE1')
                                          .FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA5020.STRMEASURE1 ELSE STRMEASURE1 END,
                     STRMEASURE2             = CASE VL_DES_TA5020('STRMEASURE2')
                                          .FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA5020.STRMEASURE2 ELSE STRMEASURE2 END,
                     STRMEASURE3             = CASE VL_DES_TA5020('STRMEASURE3')
                                          .FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA5020.STRMEASURE3 ELSE STRMEASURE3 END,
                     STRMEASURE4             = CASE VL_DES_TA5020('STRMEASURE4')
                                          .FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA5020.STRMEASURE4 ELSE STRMEASURE4 END,
                     STRMEASURE5             = CASE VL_DES_TA5020('STRMEASURE5')
                                          .FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA5020.STRMEASURE5 ELSE STRMEASURE5 END,
                     STRMEASURE6             = CASE VL_DES_TA5020('STRMEASURE6')
                                          .FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA5020.STRMEASURE6 ELSE STRMEASURE6 END,
                     STRMEASURE7             = CASE VL_DES_TA5020('STRMEASURE7')
                                          .FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA5020.STRMEASURE7 ELSE STRMEASURE7 END,
                     STRMEASURE8             = CASE VL_DES_TA5020('STRMEASURE8')
                                          .FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA5020.STRMEASURE8 ELSE STRMEASURE8 END,
                     STRMEASURE9             = CASE VL_DES_TA5020('STRMEASURE9')
                                          .FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA5020.STRMEASURE9 ELSE STRMEASURE9 END,
                     STRMEASURE10             = CASE VL_DES_TA5020('STRMEASURE10')
                                          .FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA5020.STRMEASURE10 ELSE STRMEASURE10 END,
                     DTEMEASURE1             = CASE VL_DES_TA5020('DTEMEASURE1')
                                          .FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA5020.DTEMEASURE1 ELSE DTEMEASURE1 END,
                     DTEMEASURE2             = CASE VL_DES_TA5020('DTEMEASURE2')
                                          .FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA5020.DTEMEASURE2 ELSE DTEMEASURE2 END,
                     DTEMEASURE3             = CASE VL_DES_TA5020('DTEMEASURE3')
                                          .FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA5020.DTEMEASURE3 ELSE DTEMEASURE3 END,
                     DTEMEASURE4             = CASE VL_DES_TA5020('DTEMEASURE4')
                                          .FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA5020.DTEMEASURE4 ELSE DTEMEASURE4 END,
                     DTEMEASURE5             = CASE VL_DES_TA5020('DTEMEASURE5')
                                          .FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA5020.DTEMEASURE5 ELSE DTEMEASURE5 END,
                     DTEMEASURE6             = CASE VL_DES_TA5020('DTEMEASURE6')
                                          .FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA5020.DTEMEASURE6 ELSE DTEMEASURE6 END,
                     DTEMEASURE7             = CASE VL_DES_TA5020('DTEMEASURE7')
                                          .FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA5020.DTEMEASURE7 ELSE DTEMEASURE7 END,
                     DTEMEASURE8             = CASE VL_DES_TA5020('DTEMEASURE8')
                                          .FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA5020.DTEMEASURE8 ELSE DTEMEASURE8 END,
                     DTEMEASURE9             = CASE VL_DES_TA5020('DTEMEASURE9')
                                          .FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA5020.DTEMEASURE9 ELSE DTEMEASURE9 END,
                     DTEMEASURE10             = CASE VL_DES_TA5020('DTEMEASURE10')
                                          .FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA5020.DTEMEASURE10 ELSE DTEMEASURE10 END,
                     NUMMEASURE11             = CASE VL_DES_TA5020('NUMMEASURE11')
                                          .FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA5020.NUMMEASURE11 ELSE NUMMEASURE11 END,
                     NUMMEASURE12             = CASE VL_DES_TA5020('NUMMEASURE12')
                                          .FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA5020.NUMMEASURE12 ELSE NUMMEASURE12 END,
                     NUMMEASURE13             = CASE VL_DES_TA5020('NUMMEASURE13')
                                          .FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA5020.NUMMEASURE13 ELSE NUMMEASURE13 END,
                     NUMMEASURE14             = CASE VL_DES_TA5020('NUMMEASURE14')
                                          .FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA5020.NUMMEASURE14 ELSE NUMMEASURE14 END,
                     NUMMEASURE15             = CASE VL_DES_TA5020('NUMMEASURE15')
                                          .FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA5020.NUMMEASURE15 ELSE NUMMEASURE15 END,
                     NUMMEASURE16             = CASE VL_DES_TA5020('NUMMEASURE16')
                                          .FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA5020.NUMMEASURE16 ELSE NUMMEASURE16 END,
                     NUMMEASURE17             = CASE VL_DES_TA5020('NUMMEASURE17')
                                          .FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA5020.NUMMEASURE17 ELSE NUMMEASURE17 END,
                     NUMMEASURE18             = CASE VL_DES_TA5020('NUMMEASURE18')
                                          .FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA5020.NUMMEASURE18 ELSE NUMMEASURE18 END,
                     NUMMEASURE19             = CASE VL_DES_TA5020('NUMMEASURE19')
                                          .FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA5020.NUMMEASURE19 ELSE NUMMEASURE19 END,
                     NUMMEASURE20             = CASE VL_DES_TA5020('NUMMEASURE20')
                                          .FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA5020.NUMMEASURE20 ELSE NUMMEASURE20 END,
                     FLGMEASURE1             = CASE VL_DES_TA5020('FLGMEASURE1')
                                          .FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA5020.FLGMEASURE1 ELSE FLGMEASURE1 END,
                     FLGMEASURE2             = CASE VL_DES_TA5020('FLGMEASURE2')
                                          .FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA5020.FLGMEASURE2 ELSE FLGMEASURE2 END,
                     FLGMEASURE3             = CASE VL_DES_TA5020('FLGMEASURE3')
                                          .FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA5020.FLGMEASURE3 ELSE FLGMEASURE3 END,
                     FLGMEASURE4             = CASE VL_DES_TA5020('FLGMEASURE4')
                                          .FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA5020.FLGMEASURE4 ELSE FLGMEASURE4 END,
                     FLGMEASURE5             = CASE VL_DES_TA5020('FLGMEASURE5')
                                          .FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA5020.FLGMEASURE5 ELSE FLGMEASURE5 END,
                     FLGMEASURE6             = CASE VL_DES_TA5020('FLGMEASURE6')
                                          .FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA5020.FLGMEASURE6 ELSE FLGMEASURE6 END,
                     FLGMEASURE7             = CASE VL_DES_TA5020('FLGMEASURE7')
                                          .FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA5020.FLGMEASURE7 ELSE FLGMEASURE7 END,
                     FLGMEASURE8             = CASE VL_DES_TA5020('FLGMEASURE8')
                                          .FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA5020.FLGMEASURE8 ELSE FLGMEASURE8 END,
                     FLGMEASURE9             = CASE VL_DES_TA5020('FLGMEASURE9')
                                          .FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA5020.FLGMEASURE9 ELSE FLGMEASURE9 END,
                     FLGMEASURE10             = CASE VL_DES_TA5020('FLGMEASURE10')
                                          .FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA5020.FLGMEASURE10 ELSE FLGMEASURE10 END,
                     FB             = CASE VL_DES_TA5020('FB')
                                          .FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA5020.FB ELSE FB END,
                     SELLOUTPROMOPRICE             = CASE VL_DES_TA5020('SELLOUTPROMOPRICE')
                                          .FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA5020.SELLOUTPROMOPRICE ELSE SELLOUTPROMOPRICE END,
                     CONTRIBUTION_RETAILER             = CASE VL_DES_TA5020('CONTRIBUTION_RETAILER')
                                          .FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA5020.CONTRIBUTION_RETAILER ELSE CONTRIBUTION_RETAILER END,

                     QTYESTIMATEDDISPLAY             = CASE VL_DES_TA5020('QTYESTIMATEDDISPLAY')
                                          .FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA5020.QTYESTIMATEDDISPLAY ELSE QTYESTIMATEDDISPLAY END,

                     NUMCOMPONENTS             = CASE VL_DES_TA5020('NUMCOMPONENTS')
                                          .FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA5020.NUMCOMPONENTS ELSE NUMCOMPONENTS END


              WHERE IDACTION = REC_TA5020.IDACTION
                    AND CODPRODUCT=REC_TA5020.CODPRODUCT
                    AND LEVPRODUCT=REC_TA5020.LEVPRODUCT;
              --
             IF SQL%ROWCOUNT = 0 THEN
                INSERT INTO TA5020PRODUCTS VALUES REC_TA5020;
                VL_INS_TA5020 := VL_INS_TA5020 + 1;
             END IF; -- Record has been updated

              --
           END IF;-- VL_STATUS
      EXCEPTION
                 WHEN OTHERS THEN
                 VL_STATUS    := -1;
                 VL_MESSAGE_H := SUBSTR(VL_MESSAGE_H || ' ' || VL_MESSAGE_D || ' ' ||
                                 dbms_utility.format_error_backtrace() || ' ' || SQLERRM,
                                 1,
                                 4000);

                 PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                         VL_PROGR_D_TA5020,
                                         SQLCODE,
                                         VL_MESSAGE_H);
      END;
       -- -----------------------------------
      -- TA5022 PRODUCT ACTIVITIES
      -- -----------------------------------
       BEGIN
        IF (VL_STATUS = 0) THEN
          FOR RL_XIN_TA5022 IN CL_XIN_TA5022(RL_XIN_TA5020.IDACTION,RL_XIN_TA5020.CODPRODUCT,RL_XIN_TA5020.LEVPRODUCT,
                                         RL_XIN_TA5020.SM1_DTECRE) LOOP

          VL_MESSAGE_H := 'PRODUCT: ' || RL_XIN_TA5022.IDACTION || '/' ||
                          'ACTIVITY: ' || RL_XIN_TA5022.CODACTIVITY;

          VL_MESSAGE_D := 'Format Conversion ';

          REC_TA5022.IDACTION := REC_TA5020.IDACTION;
          REC_TA5022.CODPRODUCT := REC_TA5020.CODPRODUCT;
          REC_TA5022.LEVPRODUCT := REC_TA5020.LEVPRODUCT;
          REC_TA5022.CODACTIVITY := F_CHECK_FORMAT_S(VL_CODDIV, RL_XIN_TA5022.CODACTIVITY,'CODACTIVITY',VL_DES_TA5022,VL_STATUS,VL_MESSAGE_D);
          REC_TA5022.CODDISPLAY := F_CHECK_FORMAT_S(VL_CODDIV, RL_XIN_TA5022.CODDISPLAY,'CODDISPLAY',VL_DES_TA5022,VL_STATUS,VL_MESSAGE_D);
          IF (VL_STATUS <> 0) THEN
              VL_MESSAGE_H := SUBSTR(VL_MESSAGE_H || ' ' || VL_MESSAGE_D || ' ' ||
                                     dbms_utility.format_error_backtrace() || ' ' || SQLERRM,
                                     1,
                                     4000);
              PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                             VL_PROGR_D_TA5022,
                                             SQLCODE,
                                             VL_MESSAGE_H);
          END IF;
          IF (VL_STATUS = 0) THEN
              --

           /* all fields of table are part of the primary key, there is no point in updating something
               UPDATE TA5022PRODUCTACTIVITIES
               SET  CODACTIVITY = REC_TA5022.CODACTIVITY
              WHERE IDACTION = REC_TA5022.IDACTION
                AND CODPRODUCT =REC_TA5022.CODPRODUCT
                AND LEVPRODUCT = REC_TA5022.LEVPRODUCT;

             IF SQL%ROWCOUNT = 0 THEN   */

                -- record does not exists , we insert it
                BEGIN
                VL_MESSAGE_D := 'Insert TA5022 ';
                INSERT INTO TA5022PRODUCTACTIVITIES VALUES REC_TA5022;
                VL_INS_TA5022 := VL_INS_TA5022 + 1;
                EXCEPTION WHEN OTHERS THEN
                  NULL; -- ALREADY EXISTS
                END;

              --
           -- END IF;
           END IF;
           END LOOP; -- TA5022
              END IF; -- VL_STATUS = 0 TA5022PRODUCTS
       END;
      END LOOP; -- TA5020
      END IF;
         -- if all records have been stored with success then it makes the commit
      IF VL_STATUS = 0 THEN
        VL_INS_TA5000 := VL_INS_TA5000 + 1;
        COMMIT;
      ELSE
        ROLLBACK;
        VL_STATUS := 0;

        UPDATE XIN_TA5000PROMOACTION
           SET SM1_STATUS = CASE WHEN VL_RECORD_LOCKED <> 0 THEN C_XINSTATUS_LOCK ELSE C_XINSTATUS_ERR END
         WHERE IDACTION = RL_XIN_TA5000.IDACTION
           AND SM1_CODPROCESS = PI_PROGR_H
           AND SM1_DTECRE = RL_XIN_TA5000.SM1_DTECRE
           AND SM1_STATUS = C_XINSTATUS_OK;

        UPDATE XIN_TA5002PROMOACTIONA
           SET SM1_STATUS = CASE WHEN VL_RECORD_LOCKED <> 0 THEN C_XINSTATUS_LOCK ELSE C_XINSTATUS_ERR END
         WHERE IDACTION = RL_XIN_TA5000.IDACTION
           AND SM1_CODPROCESS = PI_PROGR_H
           AND SM1_DTECRE <= RL_XIN_TA5000.SM1_DTECRE
           AND SM1_STATUS = C_XINSTATUS_OK;

        UPDATE XIN_TA5012PARTICIPANTS
           SET SM1_STATUS = CASE WHEN VL_RECORD_LOCKED <> 0 THEN C_XINSTATUS_LOCK ELSE C_XINSTATUS_ERR END
         WHERE IDACTION = RL_XIN_TA5000.IDACTION
           AND SM1_CODPROCESS = PI_PROGR_H
           AND SM1_DTECRE <= RL_XIN_TA5000.SM1_DTECRE
           AND SM1_STATUS = C_XINSTATUS_OK;

        UPDATE XIN_TA5014DELIVERYPOIN
           SET SM1_STATUS = CASE WHEN VL_RECORD_LOCKED <> 0 THEN C_XINSTATUS_LOCK ELSE C_XINSTATUS_ERR END
         WHERE IDACTION = RL_XIN_TA5000.IDACTION
           AND SM1_CODPROCESS = PI_PROGR_H
           AND SM1_DTECRE <= RL_XIN_TA5000.SM1_DTECRE
           AND SM1_STATUS = C_XINSTATUS_OK;

        UPDATE XIN_TA5020PRODUCTS
           SET SM1_STATUS = CASE WHEN VL_RECORD_LOCKED <> 0 THEN C_XINSTATUS_LOCK ELSE C_XINSTATUS_ERR END
         WHERE IDACTION = RL_XIN_TA5000.IDACTION
           AND SM1_CODPROCESS = PI_PROGR_H
           AND SM1_DTECRE <= RL_XIN_TA5000.SM1_DTECRE
           AND SM1_STATUS = C_XINSTATUS_OK;

        UPDATE XIN_TA5022PRODUCTACTIV
           SET SM1_STATUS = CASE WHEN VL_RECORD_LOCKED <> 0 THEN C_XINSTATUS_LOCK ELSE C_XINSTATUS_ERR END
         WHERE IDACTION = RL_XIN_TA5000.IDACTION
           AND SM1_CODPROCESS = PI_PROGR_H
           AND SM1_DTECRE <= RL_XIN_TA5000.SM1_DTECRE
           AND SM1_STATUS = C_XINSTATUS_OK;



        COMMIT;
      END IF;

      -- Releases Record
      UPDATE TA5000PROMOACTION
         SET DTELCK = NULL, IDSESSIONLCK = NULL, CODUSRLCK = NULL
       WHERE IDACTION = REC_TA5000.IDACTION
         AND IDSESSIONLCK = PI_SESSION_ID
         AND CODUSRLCK = C_SYSUSR;

      COMMIT;

     END LOOP;   --LOOP HEAD TA5000


   BEGIN

      -- Moves records from staging area to log staging area
      P_XIN_MOVE_TO_LOG(PI_PROGR_H, VL_PROGR_D_TA5012, 'TA5012PARTICIPANTS');
      P_XIN_MOVE_TO_LOG(PI_PROGR_H, VL_PROGR_D_TA5014, 'TA5014DELIVERYPOIN');
      P_XIN_MOVE_TO_LOG(PI_PROGR_H, VL_PROGR_D_TA5022, 'TA5022PRODUCTACTIV');
      P_XIN_MOVE_TO_LOG(PI_PROGR_H, VL_PROGR_D_TA5020, 'TA5020PRODUCTS');
      P_XIN_MOVE_TO_LOG(PI_PROGR_H, VL_PROGR_D_TA5002, 'TA5002PROMOACTIONA');
      P_XIN_MOVE_TO_LOG(PI_PROGR_H, VL_PROGR_D_TA5000, 'TA5000PROMOACTION'); --
    END;
    -- Close Logs


    --
    PKG_UTILS.LOG_END_DETAIL(PI_PROGR_H,
                             VL_PROGR_D_TA5012,
                             0,
                             VL_COUNT_XIN_TA5012,
                             VL_INS_TA5012,
                             VL_COUNT_XIN_TA5012 - VL_INS_TA5012);
    --
    PKG_UTILS.LOG_END_DETAIL(PI_PROGR_H,
                             VL_PROGR_D_TA5014,
                             0,
                             VL_COUNT_XIN_TA5014,
                             VL_INS_TA5014,
                             VL_COUNT_XIN_TA5014 - VL_INS_TA5014);
    --
    PKG_UTILS.LOG_END_DETAIL(PI_PROGR_H,
                             VL_PROGR_D_TA5022,
                             0,
                             VL_COUNT_XIN_TA5022,
                             VL_INS_TA5022,
                             VL_COUNT_XIN_TA5022 - VL_INS_TA5022);
    --
    PKG_UTILS.LOG_END_DETAIL(PI_PROGR_H,
                             VL_PROGR_D_TA5020,
                             0,
                             VL_COUNT_XIN_TA5020,
                             VL_INS_TA5020,
                             VL_COUNT_XIN_TA5020 - VL_INS_TA5020);
    --
    PKG_UTILS.LOG_END_DETAIL(PI_PROGR_H,
                             VL_PROGR_D_TA5002,
                             0,
                             VL_COUNT_XIN_TA5002,
                             VL_INS_TA5002,
                             VL_COUNT_XIN_TA5002 - VL_INS_TA5002);
    --
    PKG_UTILS.LOG_END_DETAIL(PI_PROGR_H,
                             VL_PROGR_D_TA5000,
                             0,
                             VL_COUNT_XIN_TA5000,
                             VL_INS_TA5000,
                             VL_COUNT_XIN_TA5000 - VL_INS_TA5000);

    PO_MSG    := VL_INS_TA5000 || '/' || VL_COUNT_XIN_TA5000 ||
                 ' Promo actions loaded';
    PO_STATUS := VL_INS_TA5000;

    --
  EXCEPTION
    WHEN EX_EXIT THEN

      ROLLBACK;
      VL_MESSAGE_H := VL_MESSAGE_H || TRIM(SUBSTR(dbms_utility.format_error_backtrace() || ' ' || SQLERRM, 1, 255));
      PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                     VL_PROGR_D_TA5000,
                                     SQLCODE,
                                     VL_MESSAGE_H);

      PO_MSG    := VL_MESSAGE_H;
      PO_STATUS := -1;

    WHEN OTHERS THEN

      ROLLBACK;

      BEGIN
        -- Release updated records
        UPDATE TA5000PROMOACTION
           SET DTELCK = NULL, IDSESSIONLCK = NULL, CODUSRLCK = NULL
         WHERE CODUSRLCK = C_SYSUSR
           AND IDSESSIONLCK = PI_SESSION_ID;
        COMMIT;

        -- Moves records from staging area to log staging area

        P_XIN_MOVE_TO_LOG(PI_PROGR_H, VL_PROGR_D_TA5012, 'TA5012PARTICIPANTS');
        P_XIN_MOVE_TO_LOG(PI_PROGR_H, VL_PROGR_D_TA5014, 'TA5014DELIVERYPOIN');
        P_XIN_MOVE_TO_LOG(PI_PROGR_H, VL_PROGR_D_TA5022,'TA5022PRODUCTACTIV');
        P_XIN_MOVE_TO_LOG(PI_PROGR_H, VL_PROGR_D_TA5020, 'TA5020PRODUCTS');
        P_XIN_MOVE_TO_LOG(PI_PROGR_H, VL_PROGR_D_TA5002, 'TA5002PROMOACTIONA');
        P_XIN_MOVE_TO_LOG(PI_PROGR_H, VL_PROGR_D_TA5000, 'TA5000PROMOACTION');

      END;

      VL_MESSAGE_H := VL_MESSAGE_H || TRIM(SUBSTR(dbms_utility.format_error_backtrace() || ' ' || SQLERRM, 1, 255));
      PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                     VL_PROGR_D_TA5000,
                                     SQLCODE,
                                     VL_MESSAGE_H);

      PO_MSG    := VL_MESSAGE_H;
      PO_STATUS := VL_STATUS;


  END LOAD_TA50X_PROMO;




 /*============================================================================*\
  /* Name: LOAD_TA105X_PASSIVEINVOICE

        Loads SM1 tables
      • TA1050PASSIVEINVOICES – Passive invoice head
      • TA1052INVOICEROWS – Passive invoice detail
      Staging Area (SSA) tables:
      • XIN_TA1050PASSIVEINVOI
      • XIN_TA1052INVOICEROWS

      Loading logic:
      DELETE + INSERT. Updates the Record when it already exists (checking by field DOCUMENTCODE/CODDIV) and it is not already locked, record is inserted if it does not exist yet.
      .Primary key of TA1050 DOCUMENTID is an internal progressive number we generate here with
      select * from t011prg t where codprg = 'CUSTINVOICEID'


      Validity Checks:

      • Records found  on XIN_ TA1052INVOICEROWS are loaded only if the invoice is present on TA1050PASSIVEINVOICES table.

      Error handling:
      • All Errors will be logged in T852/T854 SM1 log tables and all staging area records will be stored into staging area log with sm1_status = 9.
      • Error on head record,  it is discarded and import procedure skip to load next invoice.
      • Error on detail record,  it is discarded with all other details of same head and import procedure skip to load next invoice.

      How to delete an invoice: it is not possible to delete an invoice via data integration, you need to do it by SM1 software.

   Author : Mariangela Bandiera
     Creation Date : 2013
     ----
Updates
-- 2014 02 13; 013: Mbandiera; WI 28211; Changed Passive invoices loading logig from UPDATE/INSERT to DELETE/INSERT

    ============================================================================ */

  PROCEDURE LOAD_TA105X_PASSIVEINVOICE(PI_PROGR_H       IN NUMBER,
                                       PI_SESSION_ID    IN NUMBER,
                                       PO_MSG           OUT NOCOPY VARCHAR2,
                                       PO_STATUS        OUT NOCOPY NUMBER ) IS
    --
    -- Cursor on main Passive Invoice ssa
    --
    CURSOR CL_XIN_TA1050 IS
      SELECT
          *
        FROM  XIN_TA1050PASSIVEINVOI
        WHERE SM1_CODPROCESS = PI_PROGR_H
        -- BEAWARE : his order is mandatory for a correct loading, if it is needed to change it, the whole procedure must be reviewed
        ORDER BY DOCUMENTCODE, CODDIV, SM1_DTECRE ASC;

    --
    -- Rows
    --
    CURSOR CL_XIN_TA1052(CI_DOCUMENTCODE VARCHAR2, CI_CODDIV VARCHAR2, CI_SM1_DTECRE DATE) IS
      SELECT *
      --
        FROM XIN_TA1052INVOICEROWS
       WHERE DOCUMENTCODE = CI_DOCUMENTCODE
         AND CODDIV = CI_CODDIV
         AND SM1_CODPROCESS = PI_PROGR_H
         AND SM1_DTECRE <= CI_SM1_DTECRE
         AND SM1_STATUS = C_XINSTATUS_OK -- Only those that have not processed yet (in case of double record in xin)
          ORDER BY SM1_DTECRE;


    --
    VL_MESSAGE_H   VARCHAR2(4000) := 'Error while loading PASSIVE INVOICES TA105X';
    VL_MESSAGE_D   VARCHAR2(4000) := NULL;
    --
    vl_count       NUMBER := 0;
    --
    VL_PROGR_D_TA1050         NUMBER := 0;
    VL_COUNT_XIN_TA1050       NUMBER := 0;
    VL_INS_TA1050             NUMBER := 0;
    --
    VL_PROGR_D_TA1052         NUMBER := 0;
    VL_COUNT_XIN_TA1052       NUMBER := 0;
    VL_INS_TA1052             NUMBER := 0;
     --
    REC_TA1050      TA1050PASSIVEINVOICES%ROWTYPE     := NULL;
    REC_TA1052      TA1052INVOICEROWS%ROWTYPE         := NULL;
    --
    REC_TA1050_INIT TA1050PASSIVEINVOICES%ROWTYPE     := NULL;
    REC_TA1052_INIT TA1052INVOICEROWS%ROWTYPE         := NULL;

    VL_DES_TA1050     X_FIELD_INFO_ARRAY;
    VL_DES_TA1052     X_FIELD_INFO_ARRAY;-- Array with fields db info
    --
    vl_wf_stateid       TA2302WORKFLOWSTATES.STATEID%TYPE      := null;
    vl_wf_codstatehard  TA2302WORKFLOWSTATES.CODSTATEHARD%TYPE := null;
    --
    VL_RECORD_LOCKED NUMBER := 0;
    VL_DOCUMENTID NUMBER := 0;

    VL_STATUS NUMBER:= 0;
    VL_STEP   NUMBER:= 0; -- Used to ping t035
    --
    EX_EXIT  EXCEPTION;
    --
    VL_CODDIV VARCHAR2(30) := NULL;

  BEGIN

     -- init indexes and rebuild statistics

    P_XIN_INIT_INDEXES(PI_PROGR_H, 'TA1050PASSIVEINVOI');
    P_XIN_INIT_INDEXES(PI_PROGR_H, 'TA1052INVOICEROWS');

   -- clean loG

    P_XIN_CLEANUP_LOG (PI_PROGR_H, 'TA1050PASSIVEINVOI');
    P_XIN_CLEANUP_LOG (PI_PROGR_H, 'TA1052INVOICEROWS');
    --

    VL_PROGR_D_TA1050 := PKG_UTILS.LOG_NEW_DETAIL(PI_PROGR_H,
                                                     'PASSIVE INVOICE HEAD',
                                                     'IMPORT --> TA1050PASSIVEINVOI',
                                                      0,
                                                      NULL);
    --
    VL_PROGR_D_TA1052 := PKG_UTILS.LOG_NEW_DETAIL(PI_PROGR_H,
                                                     'PASSIVE INVOICE ROWS',
                                                     'IMPORT --> TA1052INVOICEROWS',
                                                      0,
                                                      NULL);



   BEGIN
        --
        -- ----------------------------------------------------------
        -- Init arrays with FIELD_NAME=LENGTH and FIELDNAME=SM1_DEFAULT for all fields of table
        -- ----------------------------------------------------------
        VL_DES_TA1050.DELETE;
        P_INIT_SM1_FIELD_ARRAY('TA1050PASSIVEINVOICES',VL_DES_TA1050,VL_STATUS, VL_MESSAGE_H);
        execute immediate ( GL_INIT_REC) INTO REC_TA1050_INIT;

        VL_DES_TA1052.DELETE;
        P_INIT_SM1_FIELD_ARRAY ('TA1052INVOICEROWS',VL_DES_TA1052,VL_STATUS, VL_MESSAGE_H);
       execute immediate ( GL_INIT_REC) INTO REC_TA1052_INIT;

        IF (VL_STATUS <> 0 ) THEN
            VL_MESSAGE_D := GL_INIT_REC;
            RAISE EX_EXIT;
        END IF;
    EXCEPTION WHEN OTHERS THEN
        VL_MESSAGE_D := GL_INIT_REC;
        RAISE EX_EXIT;
    END;


    -- --------------------------------------------------------------
    -- Work flow init status
    -- --------------------------------------------------------------
    BEGIN

    P_GET_WF_INIT_STATUS(C_WORKFLOWID_TA1050, 'TA1050PASSIVEINVOICES', vl_wf_stateid,vl_wf_codstatehard, VL_STATUS);

    if (vl_status <> 0 ) then
      VL_MESSAGE_H := 'Error retrieving Workflow init status';
      RAISE EX_EXIT;
    end if;

    EXCEPTION WHEN OTHERS THEN
      VL_MESSAGE_H := 'Error retrieving Workflow init status';
      RAISE EX_EXIT;
    END;
    -- ------------------------------------------------------------------

    -- --------------------------------------------------------------
    -- Identifies Xin records to be loaded
    -- --------------------------------------------------------------
    BEGIN
        VL_MESSAGE_D := 'XIN_TA1050PASSIVEINVOI';
        UPDATE XIN_TA1050PASSIVEINVOI
        SET SM1_CODPROCESS = PI_PROGR_H,
            SM1_STATUS = 0,
            SM1_DTEPROCESS = XSYSDATE
            WHERE SM1_CODPROCESS = C_SM1_NULL_CODPROCESS;
        VL_COUNT_XIN_TA1050 := SQL%ROWCOUNT;


        VL_MESSAGE_D := 'XIN_TA1052INVOICEROWS';
        UPDATE XIN_TA1052INVOICEROWS D
        SET D.SM1_CODPROCESS = PI_PROGR_H,
            D.SM1_STATUS = 0,
            D.SM1_DTEPROCESS = XSYSDATE
        WHERE (D.DOCUMENTCODE, D.CODDIV) IN (SELECT H.DOCUMENTCODE, H.CODDIV FROM XIN_TA1050PASSIVEINVOI H WHERE H.SM1_CODPROCESS = PI_PROGR_H AND H.SM1_DTECRE >= D.SM1_DTECRE )
        AND SM1_CODPROCESS = C_SM1_NULL_CODPROCESS;
       VL_COUNT_XIN_TA1052 := SQL%ROWCOUNT;



    COMMIT;
    EXCEPTION WHEN OTHERS THEN
      ROLLBACK;
      VL_MESSAGE_H := 'Error while Reading Staging area: '||VL_MESSAGE_D;
      RAISE EX_EXIT;
    END;
    -- --------------------------------------------------------------
    -- loop in main table TA1050PASSIVEINVOI
    -- --------------------------------------------------------------
    FOR RL_XIN_TA1050 IN CL_XIN_TA1050 LOOP
      -- pings to t035 every 1000 cicles--
      VL_STEP := VL_STEP + 1;
      IF ( MOD(VL_STEP, 1000) = 0 ) THEN
         PKG_UTILS.user_ping(PI_SESSION_ID);
      END IF;

      --
      VL_STATUS := 0;
      VL_RECORD_LOCKED := 0;
      --
      VL_MESSAGE_H :=   'Documentcode: '||RL_XIN_TA1050.DOCUMENTCODE || '/' ||
                        RL_XIN_TA1050.CODDIV;
      --
      BEGIN --- HEAD TA1050

      -- Data Format Check
        VL_MESSAGE_D := 'Format Conversion ';
        VL_CODDIV:= RL_XIN_TA1050.CODDIV;
        REC_TA1050.DOCUMENTCODE := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_TA1050.DOCUMENTCODE,'DOCUMENTCODE', VL_DES_TA1050,VL_STATUS, VL_MESSAGE_D);
        REC_TA1050.CODDIV := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_TA1050.CODDIV,'CODDIV', VL_DES_TA1050,VL_STATUS, VL_MESSAGE_D);
        REC_TA1050.CUSTOMERHIER := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_TA1050.CUSTOMERHIER,'CUSTOMERHIER', VL_DES_TA1050,VL_STATUS, VL_MESSAGE_D);
        REC_TA1050.CUSTOMERCODE := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_TA1050.CUSTOMERCODE,'CUSTOMERCODE', VL_DES_TA1050,VL_STATUS, VL_MESSAGE_D);
        REC_TA1050.CUSTOMERLEVEL := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_TA1050.CUSTOMERLEVEL,'CUSTOMERLEVEL', VL_DES_TA1050,VL_STATUS, VL_MESSAGE_D);
        REC_TA1050.CODINVOICETYPE := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_TA1050.CODINVOICETYPE,'CODINVOICETYPE', VL_DES_TA1050,VL_STATUS, VL_MESSAGE_D);
        REC_TA1050.DESINVOICE := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_TA1050.DESINVOICE,'DESINVOICE', VL_DES_TA1050,VL_STATUS, VL_MESSAGE_D);
        REC_TA1050.SUPPLIERCODE := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_TA1050.SUPPLIERCODE,'SUPPLIERCODE', VL_DES_TA1050,VL_STATUS, VL_MESSAGE_D);
        REC_TA1050.NETAMOUNT := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_TA1050.NETAMOUNT,'NETAMOUNT', VL_DES_TA1050,VL_STATUS, VL_MESSAGE_D);
        REC_TA1050.GROSSAMOUNT := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_TA1050.GROSSAMOUNT,'GROSSAMOUNT', VL_DES_TA1050,VL_STATUS, VL_MESSAGE_D);
        REC_TA1050.VATTOTALAMOUNT := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_TA1050.VATTOTALAMOUNT,'VATTOTALAMOUNT', VL_DES_TA1050,VL_STATUS, VL_MESSAGE_D);
        REC_TA1050.DELTAAMOUNT := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_TA1050.DELTAAMOUNT,'DELTAAMOUNT', VL_DES_TA1050,VL_STATUS, VL_MESSAGE_D);
        REC_TA1050.DOCUMENTYEAR := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_TA1050.DOCUMENTYEAR,'DOCUMENTYEAR', VL_DES_TA1050,VL_STATUS, VL_MESSAGE_D);
        REC_TA1050.DOCUMENTDATE := F_CHECK_FORMAT_D( VL_CODDIV, RL_XIN_TA1050.DOCUMENTDATE,'DOCUMENTDATE', VL_DES_TA1050,VL_STATUS, VL_MESSAGE_D);
        REC_TA1050.INVOICEDATE := F_CHECK_FORMAT_D(  VL_CODDIV,RL_XIN_TA1050.INVOICEDATE,'INVOICEDATE', VL_DES_TA1050,VL_STATUS, VL_MESSAGE_D);
        REC_TA1050.PAYMENTMODE := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_TA1050.PAYMENTMODE,'PAYMENTMODE', VL_DES_TA1050,VL_STATUS, VL_MESSAGE_D);
        REC_TA1050.DUEDATE := F_CHECK_FORMAT_D(  VL_CODDIV,RL_XIN_TA1050.DUEDATE,'DUEDATE', VL_DES_TA1050,VL_STATUS, VL_MESSAGE_D);
        REC_TA1050.FLGFROMHOST := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_TA1050.FLGFROMHOST,'FLGFROMHOST', VL_DES_TA1050,VL_STATUS, VL_MESSAGE_D);
        REC_TA1050.TAXAMOUNT := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_TA1050.TAXAMOUNT,'TAXAMOUNT', VL_DES_TA1050,VL_STATUS, VL_MESSAGE_D);
        REC_TA1050.CURRENCY := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_TA1050.CURRENCY,'CURRENCY', VL_DES_TA1050,VL_STATUS, VL_MESSAGE_D);
        REC_TA1050.SECONDARYCURRENCY := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_TA1050.SECONDARYCURRENCY,'SECONDARYCURRENCY', VL_DES_TA1050,VL_STATUS, VL_MESSAGE_D);
        REC_TA1050.CONVERSIONRATE := F_CHECK_FORMAT_N( VL_CODDIV, RL_XIN_TA1050.CONVERSIONRATE,'CONVERSIONRATE', VL_DES_TA1050,VL_STATUS, VL_MESSAGE_D);

        --- Technical fields
        REC_TA1050.DTECRE     := XSYSDATE;
        REC_TA1050.CODUSRMOD  := C_SYSUSR;
        REC_TA1050.DTEMOD     := XSYSDATE;
        -- workflow fields
        -- new invoice is always confirmed
        REC_TA1050.IDWFSTATE      := vl_wf_stateid;
        REC_TA1050.IDWFMODEL      := C_WORKFLOWID_TA1050; -- Workflow for products
        REC_TA1050.CODWFSTATEHARD := vl_wf_codstatehard; -- confirmed
        -- lock fields
        REC_TA1050.CODUSRLCK     := C_SYSUSR;
        REC_TA1050.IDSESSIONLCK  := PI_SESSION_ID;
        REC_TA1050.DTELCK        := XSYSDATE;

        IF (VL_STATUS <> 0 ) THEN

         VL_MESSAGE_H := SUBSTR(VL_MESSAGE_H||' '||VL_MESSAGE_D||' '||dbms_utility.format_error_backtrace() || ' ' || SQLERRM,1,4000);

             PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                           VL_PROGR_D_TA1050,
                                           SQLCODE,
                                           VL_MESSAGE_H);
        ELSE
        -- CHECK IF INVOICE CAN BE UPDATED BY ERP OR IT HAS ALREADY BE MANAGED BY SM1
          VL_COUNT := 0;
          BEGIN
          vl_documentid := 0;
          SELECT  ta1050.DOCUMENTID,
                  -- FLGFAKE <> -1  means the invoice has been already processed by sm1
                  (SELECT COUNT(*) FROM  TA1052INVOICEROWS TA1052 WHERE TA1052.DOCUMENTID = TA1050.DOCUMENTID AND TA1052.FLGFAKE <> -1 )
                  INTO VL_DOCUMENTID, vl_count
          FROM TA1050PASSIVEINVOICES TA1050

           WHERE TA1050.DOCUMENTCODE = REC_TA1050.DOCUMENTCODE
             AND TA1050.CODDIV   = REC_TA1050.CODDIV
             GROUP BY ta1050.DOCUMENTID  ;


           IF ( vl_count > 0 ) THEN

               VL_STATUS := -1;

               PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                               VL_PROGR_D_TA1050,
                                               SQLCODE,
                                               'Invoice has been already processed in SM1 ( TA1052.FLGFAKE<> -1); import has skipped this invoice :'||VL_MESSAGE_H);

           ELSIF ( nvl(VL_DOCUMENTID ,0) <> 0 ) THEN

             -- Invoice already exists and it can be updated
             -- Delete all  possible childs TA1052, TA1053, TA1054, TA1055
             BEGIN
              DELETE TA1055ICREPORT        WHERE DOCUMENTID = VL_DOCUMENTID;
              DELETE TA1054MATCHINGS       WHERE DOCUMENTID = VL_DOCUMENTID;
          --    DELETE TA1053ICDUEAMOUNTLOCK WHERE DOCUMENTID = VL_DOCUMENTID;
              DELETE TA1052INVOICEROWS     WHERE DOCUMENTID = VL_DOCUMENTID;

             EXCEPTION WHEN OTHERS THEN

               VL_STATUS := -1;
               VL_MESSAGE_H := SUBSTR(VL_MESSAGE_H||' '||VL_MESSAGE_D||' '||dbms_utility.format_error_backtrace() || ' ' || SQLERRM,1,4000);
               PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                           VL_PROGR_D_TA1050,
                                           SQLCODE,
                                           VL_MESSAGE_H);

             END;
          END IF;

          EXCEPTION WHEN NO_DATA_FOUND THEN
            vl_documentid := 0; -- NEW DOCUMENT
          WHEN OTHERS THEN
            VL_STATUS := -1;
               VL_MESSAGE_H := SUBSTR(VL_MESSAGE_H||' '||VL_MESSAGE_D||' '||dbms_utility.format_error_backtrace() || ' ' || SQLERRM,1,4000);
               PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                           VL_PROGR_D_TA1050,
                                           SQLCODE,
                                           VL_MESSAGE_H);

          END;



        END IF;

        IF (VL_STATUS = 0 ) THEN
          -- when status <> 0 some fields have incorrect format. Log t800 has been already wrote by F_CHECK function
          -- Update article if already exists
           IF nvl(VL_DOCUMENTID ,0) <> 0 THEN
               VL_MESSAGE_D := 'Update TA1050PASSIVEINVOICES ';

               UPDATE TA1050PASSIVEINVOICES
               SET
                   -- when the field si set to updated by host it means that the value should be read from XIN
                   -- otherwise it means that the field is managed by sm1 and it maintains its original value
                    CUSTOMERHIER = CASE VL_DES_TA1050('CUSTOMERHIER.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA1050.CUSTOMERHIER ELSE CUSTOMERHIER END,
                    CUSTOMERCODE = CASE VL_DES_TA1050('CUSTOMERCODE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA1050.CUSTOMERCODE ELSE CUSTOMERCODE END,
                    CUSTOMERLEVEL = CASE VL_DES_TA1050('CUSTOMERLEVEL.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA1050.CUSTOMERLEVEL ELSE CUSTOMERLEVEL END,
                    CODINVOICETYPE = CASE VL_DES_TA1050('CODINVOICETYPE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA1050.CODINVOICETYPE ELSE CODINVOICETYPE END,
                    DESINVOICE = CASE VL_DES_TA1050('DESINVOICE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA1050.DESINVOICE ELSE DESINVOICE END,
                    SUPPLIERCODE = CASE VL_DES_TA1050('SUPPLIERCODE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA1050.SUPPLIERCODE ELSE SUPPLIERCODE END,
                    NETAMOUNT = CASE VL_DES_TA1050('NETAMOUNT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA1050.NETAMOUNT ELSE NETAMOUNT END,
                    GROSSAMOUNT = CASE VL_DES_TA1050('GROSSAMOUNT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA1050.GROSSAMOUNT ELSE GROSSAMOUNT END,
                    VATTOTALAMOUNT = CASE VL_DES_TA1050('VATTOTALAMOUNT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA1050.VATTOTALAMOUNT ELSE VATTOTALAMOUNT END,
                    DELTAAMOUNT = CASE VL_DES_TA1050('DELTAAMOUNT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA1050.DELTAAMOUNT ELSE DELTAAMOUNT END,
                    DOCUMENTYEAR = CASE VL_DES_TA1050('DOCUMENTYEAR.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA1050.DOCUMENTYEAR ELSE DOCUMENTYEAR END,
                    DOCUMENTDATE = CASE VL_DES_TA1050('DOCUMENTDATE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA1050.DOCUMENTDATE ELSE DOCUMENTDATE END,
                    INVOICEDATE = CASE VL_DES_TA1050('INVOICEDATE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA1050.INVOICEDATE ELSE INVOICEDATE END,
                    PAYMENTMODE = CASE VL_DES_TA1050('PAYMENTMODE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA1050.PAYMENTMODE ELSE PAYMENTMODE END,
                    DUEDATE = CASE VL_DES_TA1050('DUEDATE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA1050.DUEDATE ELSE DUEDATE END,
                    FLGFROMHOST = CASE VL_DES_TA1050('FLGFROMHOST.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA1050.FLGFROMHOST ELSE FLGFROMHOST END,
                    TAXAMOUNT = CASE VL_DES_TA1050('TAXAMOUNT.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA1050.TAXAMOUNT ELSE TAXAMOUNT END,
                    CURRENCY = CASE VL_DES_TA1050('CURRENCY.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA1050.CURRENCY ELSE CURRENCY END,
                    SECONDARYCURRENCY = CASE VL_DES_TA1050('SECONDARYCURRENCY.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA1050.SECONDARYCURRENCY ELSE SECONDARYCURRENCY END,
                    CONVERSIONRATE = CASE VL_DES_TA1050('CONVERSIONRATE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA1050.CONVERSIONRATE ELSE CONVERSIONRATE END,
                    --- Technical fields
                    CODUSRMOD = REC_TA1050.CODUSRMOD,
                    DTEMOD    = REC_TA1050.DTEMOD,
                    -- lock fields
                    CODUSRLCK    = REC_TA1050.CODUSRLCK,
                    IDSESSIONLCK = REC_TA1050.IDSESSIONLCK,
                    DTELCK       = REC_TA1050.DTELCK

             WHERE DOCUMENTID = VL_DOCUMENTID
               and not exists ( select null from T035LOGGEDUSERS T035 where T035.IDSESSION = NVL(IDSESSIONLCK, 0) AND T035.LASTCHECK > TRUNC(XSYSDATE)-1 );


              -- no data found, record is locked by another sm1 user

              IF SQL%ROWCOUNT = 0 THEN

                 VL_STATUS := -1;
                  VL_RECORD_LOCKED := -1;
                  VL_MESSAGE_H := SUBSTR(VL_MESSAGE_H||' '||VL_MESSAGE_D||' '||dbms_utility.format_error_backtrace() || ' ' || SQLERRM,1,4000);
                  PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                                 VL_PROGR_D_TA1050,
                                                 SQLCODE,
                                                 'Record is locked; import has failed :'||VL_MESSAGE_H);
               END IF;
        ELSE -- VL_DOCUMENT ID IS NULL



              VL_MESSAGE_D := 'Insert TA1050PASSIVEINVOICES ';
              -- Record does not exists, we insert it
              -- Retrieves documentid
              PKG_UTILS.getprogressive('CUSTINVOICEID', vl_documentid);

              REC_TA1050.DOCUMENTID := vl_documentid;
              REC_TA1050.DOCUMENTKEY   := PKG_UTILS.documentkey_for_TA1050(VL_DOCUMENTID);

              INSERT INTO TA1050PASSIVEINVOICES VALUES REC_TA1050;

              -- insert first step on workflow
              VL_MESSAGE_D := 'insert first step on workflow ';
              P_INS_WF_FIRST_STEP(PI_PROGR_H,VL_PROGR_D_TA1050, C_WORKFLOWID_TA1050,REC_TA1050.DOCUMENTKEY, vl_wf_stateid, vl_status );



         END IF; -- Record has been updated
       END IF; -- VL_STATUS = 0

        EXCEPTION WHEN OTHERS THEN
             VL_STATUS := -1;
             VL_MESSAGE_H := SUBSTR(VL_MESSAGE_H||' '||VL_MESSAGE_D||' '||dbms_utility.format_error_backtrace() || ' ' || SQLERRM,1,4000);

             PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                           VL_PROGR_D_TA1050,
                                           SQLCODE,
                                           VL_MESSAGE_H);
        END; -- HEAD TA1050


        -- ROWS
        IF ( VL_STATUS = 0  ) THEN



              FOR RL_XIN_TA1052 IN CL_XIN_TA1052(RL_XIN_TA1050.DOCUMENTCODE, RL_XIN_TA1050.CODDIV, RL_XIN_TA1050.SM1_DTECRE) LOOP
              BEGIN -- ROWS TA1052
                SAVEPOINT S_TA1052INVOICEROWS;
                VL_MESSAGE_H := 'Measure Unit: '|| RL_XIN_TA1052.DOCUMENTCODE || '/' ||
                                  RL_XIN_TA1052.CODDIV;

               VL_MESSAGE_D := 'Invoice rows ';
                 VL_CODDIV:= RL_XIN_TA1052.CODDIV;
                 REC_TA1052.ROWNUMBER := F_CHECK_FORMAT_N( VL_CODDIV,RL_XIN_TA1052.ROWNUMBER,'ROWNUMBER', VL_DES_TA1052,VL_STATUS, VL_MESSAGE_D);
                 REC_TA1052.AMOUNT := F_CHECK_FORMAT_N( VL_CODDIV,RL_XIN_TA1052.AMOUNT,'AMOUNT', VL_DES_TA1052,VL_STATUS, VL_MESSAGE_D);
                 REC_TA1052.VATCODE := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_TA1052.VATCODE,'VATCODE', VL_DES_TA1052,VL_STATUS, VL_MESSAGE_D);
                 REC_TA1052.VATAMOUNT := F_CHECK_FORMAT_N(VL_CODDIV, RL_XIN_TA1052.VATAMOUNT,'VATAMOUNT', VL_DES_TA1052,VL_STATUS, VL_MESSAGE_D);
                 REC_TA1052.FLGFAKE := F_CHECK_FORMAT_N( VL_CODDIV,RL_XIN_TA1052.FLGFAKE,'FLGFAKE', VL_DES_TA1052,VL_STATUS, VL_MESSAGE_D);
                 REC_TA1052.BENEFICIARYHIER := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_TA1052.BENEFICIARYHIER,'BENEFICIARYHIER', VL_DES_TA1052,VL_STATUS, VL_MESSAGE_D);
                 REC_TA1052.BENEFICIARYCODE := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_TA1052.BENEFICIARYCODE,'BENEFICIARYCODE', VL_DES_TA1052,VL_STATUS, VL_MESSAGE_D);
                 REC_TA1052.BENEFICIARYLEVEL := F_CHECK_FORMAT_N( VL_CODDIV,RL_XIN_TA1052.BENEFICIARYLEVEL,'BENEFICIARYLEVEL', VL_DES_TA1052,VL_STATUS, VL_MESSAGE_D);
                 REC_TA1052.FLGCANCELED := F_CHECK_FORMAT_N( VL_CODDIV,RL_XIN_TA1052.FLGCANCELED,'FLGCANCELED', VL_DES_TA1052,VL_STATUS, VL_MESSAGE_D);
                 REC_TA1052.FLGCROSSCHARGE := F_CHECK_FORMAT_N(VL_CODDIV, RL_XIN_TA1052.FLGCROSSCHARGE,'FLGCROSSCHARGE', VL_DES_TA1052,VL_STATUS, VL_MESSAGE_D);
                 REC_TA1052.CROSSCHARGEDIVISION := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_TA1052.CROSSCHARGEDIVISION,'CROSSCHARGEDIVISION', VL_DES_TA1052,VL_STATUS, VL_MESSAGE_D);
                 REC_TA1052.DOCUMENTYEAR := F_CHECK_FORMAT_N(VL_CODDIV, RL_XIN_TA1052.DOCUMENTYEAR,'DOCUMENTYEAR', VL_DES_TA1052,VL_STATUS, VL_MESSAGE_D);
                 REC_TA1052.PRIZEID := F_CHECK_FORMAT_N( VL_CODDIV,RL_XIN_TA1052.PRIZEID,'PRIZEID', VL_DES_TA1052,VL_STATUS, VL_MESSAGE_D);
                 REC_TA1052.CONTOCOGE := F_CHECK_FORMAT_S(VL_CODDIV, RL_XIN_TA1052.CONTOCOGE,'CONTOCOGE', VL_DES_TA1052,VL_STATUS, VL_MESSAGE_D);
                 REC_TA1052.Documentid := REC_TA1050.Documentid;
                 IF ( VL_STATUS = 0 ) THEN
                   VL_MESSAGE_D := 'Insert TA1052 ';
                   INSERT INTO TA1052INVOICEROWS VALUES REC_TA1052;
                    VL_INS_TA1052 := VL_INS_TA1052 + 1;
                  END IF;
                 --
                EXCEPTION
                  WHEN OTHERS THEN
                     VL_STATUS := -1;
                     ROLLBACK TO S_TA1052INVOICEROWS;
                     VL_MESSAGE_H := SUBSTR(VL_MESSAGE_H||' '||VL_MESSAGE_D||' '||dbms_utility.format_error_backtrace() || ' ' || SQLERRM,1,4000);

                     PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                                     VL_PROGR_D_TA1052,
                                                     SQLCODE,
                                                     VL_MESSAGE_H);

                END; --- unit measure TA1052
                IF (VL_STATUS <> 0 ) THEN
                 -- set the status to err to the single record in order to go ahead to another detail
                UPDATE XIN_TA1052INVOICEROWS
                             SET SM1_STATUS = C_XINSTATUS_ERR
                             WHERE DOCUMENTCODE = RL_XIN_TA1052.DOCUMENTCODE
                              AND  CODDIV = RL_XIN_TA1052.CODDIV
                              AND  SM1_CODPROCESS = PI_PROGR_H
                              AND  SM1_STATUS  = C_XINSTATUS_OK
                              AND  SM1_DTECRE  = RL_XIN_TA1052.SM1_DTECRE;
                     --- VL_STATUS := 0; -- RE- SET THE STATUS TO 0 TO CONTINUE WITH THE OTHER DETAILS
               END IF;
              END LOOP;
      END IF; --( VL_STATUS = 0 AND VL_RECORD_LOCKED = 0 )


      -- if all records have been stored with success then it makes the commit
      IF VL_STATUS = 0 THEN
          VL_INS_TA1050 := VL_INS_TA1050 + 1;
          COMMIT;
      ELSE
        ROLLBACK;


        UPDATE XIN_TA1050PASSIVEINVOI
        SET   SM1_STATUS = CASE
                                  WHEN VL_RECORD_LOCKED <> 0  THEN C_XINSTATUS_LOCK
                                  ELSE C_XINSTATUS_ERR END
        WHERE DOCUMENTCODE = RL_XIN_TA1050.DOCUMENTCODE
         AND  CODDIV       = RL_XIN_TA1050.CODDIV
         AND  SM1_CODPROCESS = PI_PROGR_H
         AND  SM1_DTECRE     = RL_XIN_TA1050.SM1_DTECRE
         AND  SM1_STATUS     = C_XINSTATUS_OK;

        UPDATE XIN_TA1052INVOICEROWS
        SET  SM1_STATUS = CASE
                                  WHEN VL_RECORD_LOCKED <> 0  THEN C_XINSTATUS_LOCK
                                  ELSE C_XINSTATUS_ERR END
        WHERE DOCUMENTCODE = RL_XIN_TA1050.DOCUMENTCODE
         AND  CODDIV       = RL_XIN_TA1050.CODDIV
         AND  SM1_CODPROCESS = PI_PROGR_H
         AND  SM1_DTECRE     <= RL_XIN_TA1050.SM1_DTECRE
         AND  SM1_STATUS     = C_XINSTATUS_OK;

        COMMIT;
     END IF;


        -- Release updated records
        UPDATE TA1050PASSIVEINVOICES
        SET       DTELCK          = NULL,
                  IDSESSIONLCK    = NULL,
                  CODUSRLCK       = NULL
        WHERE DOCUMENTID = VL_DOCUMENTID
          AND CODDIV = VL_CODDIV
          AND CODUSRLCK = C_SYSUSR AND IDSESSIONLCK = PI_SESSION_ID;
        COMMIT;
    END LOOP;


    BEGIN


       -- Moves records from staging area to log staging area

       P_XIN_MOVE_TO_LOG(PI_PROGR_H,VL_PROGR_D_TA1052,'TA1052INVOICEROWS');
       P_XIN_MOVE_TO_LOG(PI_PROGR_H,VL_PROGR_D_TA1050,'TA1050PASSIVEINVOI');
       --
    END;



   -- Close Logs

    PKG_UTILS.LOG_END_DETAIL(PI_PROGR_H,
                                      VL_PROGR_D_TA1052,
                                      0,
                                      VL_COUNT_XIN_TA1052,
                                      VL_INS_TA1052,
                                      VL_COUNT_XIN_TA1052 - VL_INS_TA1052);
    --
    PKG_UTILS.LOG_END_DETAIL(PI_PROGR_H,
                                      VL_PROGR_D_TA1050,
                                      0,
                                      VL_COUNT_XIN_TA1050,
                                      VL_INS_TA1050,
                                      VL_COUNT_XIN_TA1050 - VL_INS_TA1050);





    PO_MSG := VL_INS_TA1050||' Passive Invoices loaded';
    PO_STATUS :=VL_INS_TA1050;



  EXCEPTION WHEN EX_EXIT THEN

          ROLLBACK;
          VL_MESSAGE_H       := VL_MESSAGE_H || TRIM(SUBSTR(dbms_utility.format_error_backtrace() || ' ' || SQLERRM, 1, 255));
          PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                                  VL_PROGR_D_TA1050,
                                                  SQLCODE,
                                                  VL_MESSAGE_H);

          PO_MSG := VL_MESSAGE_H;
          PO_STATUS := -1;

   WHEN OTHERS THEN

          ROLLBACK;

          BEGIN
              -- Release updated records
              UPDATE TA1050PASSIVEINVOICES
              SET       DTELCK          = NULL,
                        IDSESSIONLCK    = NULL,
                        CODUSRLCK       = NULL
              WHERE CODUSRLCK = C_SYSUSR AND IDSESSIONLCK = PI_SESSION_ID;
              COMMIT;

             -- Moves records from staging area to log staging area
             P_XIN_MOVE_TO_LOG(PI_PROGR_H,VL_PROGR_D_TA1052,'TA1052INVOICEROWS');
             P_XIN_MOVE_TO_LOG(PI_PROGR_H,VL_PROGR_D_TA1050,'TA1050PASSIVEINVOI');

          END;

          VL_MESSAGE_H       := VL_MESSAGE_H || TRIM(SUBSTR(dbms_utility.format_error_backtrace() || ' ' || SQLERRM, 1, 255));
          PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                                  VL_PROGR_D_TA1050,
                                                  SQLCODE,
                                                  VL_MESSAGE_H);

          PO_MSG := VL_MESSAGE_H;
          PO_STATUS := VL_STATUS;

  END LOAD_TA105X_PASSIVEINVOICE;
  --

  /*============================================================================*\
  /* Name: LOAD_TA1056_SUPPLIERS
        Loads SM1 tables
        • TA1056SUPPLIERS          Suppliers master data table
        • TA1057SUPPLIERDIVISIONS  Table that contains divisions for suppliers

        Staging Area (SSA) tables (Chronological Order expected in SSA  for each customer):
        1•  XIN_TA1056SUPPLIERS     Staging Area Table forSuppliers master data table
        2•  XIN_TA1057SUPPLIERDIVI  Staging Area Table forTable that contains divisions for suppliers


        Loading logic:
        • TA1056/7  UPDATE + INSERT each record is updated if already exists (checking by primary key) and it is not already locked, and inserted new if it does not exist yet.

        Validity Checks:
        • Suppliers on staging area XIN_TA1056 are loaded to SM1 main tables only if they are not already opened for update by a SM1 user. In that case records remain in staging area ready to be loaded on next import run.
        • Details Records found on  XIN_TA1057 are loaded only if there is the head record in XIN_TA1056 with same codsupplier

        Error handling:
        • All Errors will be logged in T852/T854 SM1 log tables and all staging area records will be stored into staging area log with sm1_status = 9.
        • Error on head record XIN_TA1056,  it is discarded with all its details.
        • Error on detail record XIN_TA1057 it is discarded with its head and all other supplier divisions

        How to delete :
        • a whole Supplier: Suppliers can be logically deleted by setting field XIN_TA1056SUPPLIERS.FLGANN=-1.

     Input parameters :     PI_PROGR_H - unique sm1 job number ( T800SYSTEMACTIVITYLOG )
                            PI_SESSION_ID    - unique login session (T035LOGGEDUSERS)
     Outputparameters :     PO_MSG           - message of error if procedure exit with error
                            PO_STATUS        - 0 OK; -1 Error
     Author : Mariangela Bandiera
     Creation Date : 13 February 2014
     ----
     Updates :


    ============================================================================ */

   PROCEDURE LOAD_TA1056_SUPPLIERS(PI_PROGR_H       IN NUMBER,
                                   PI_SESSION_ID    IN NUMBER,
                                   PO_MSG           OUT NOCOPY VARCHAR2,
                                   PO_STATUS        OUT NOCOPY NUMBER ) IS

    -- -----------------------------------------
    -- Cursor on main Customer table TA1056SUPPLIERS
    -- -----------------------------------------
    CURSOR CL_XIN_TA1056 IS
      SELECT
          *
        FROM  XIN_TA1056SUPPLIERS
        WHERE SM1_CODPROCESS = PI_PROGR_H
        ORDER BY SM1_DTECRE ASC;

    -- -------------------------------------
    -- Cursor on Division info TA1057SUPPLIERDIVI
    -- -------------------------------------
    CURSOR CL_XIN_TA1057(CI_SUPPLIERCODE VARCHAR2, CI_SM1_DTECRE DATE) IS
      SELECT *
        FROM XIN_TA1057SUPPLIERDIVI
       WHERE SUPPLIERCODE = CI_SUPPLIERCODE
         AND SM1_CODPROCESS = PI_PROGR_H
         AND SM1_DTECRE <= CI_SM1_DTECRE
         AND SM1_STATUS = C_XINSTATUS_OK -- Only those that have not processed yet (in case of double record in xin)
         ORDER BY SM1_DTECRE;


    --
    VL_MESSAGE_H   VARCHAR2(4000) := 'Error while loading SUPPLIERS TA1056/7';
    VL_MESSAGE_D   VARCHAR2(4000) := NULL;
    --
    VL_PROGR_D_TA1056    NUMBER := 0;
    VL_COUNT_XIN_TA1056  NUMBER := 0;
    VL_INS_TA1056        NUMBER := 0;
    --
    VL_PROGR_D_TA1057    NUMBER := 0;
    VL_COUNT_XIN_TA1057  NUMBER := 0;
    VL_INS_TA1057        NUMBER := 0;

    --
    REC_TA1056 TA1056SUPPLIERS%ROWTYPE          := NULL;
    REC_TA1057 TA1057SUPPLIERDIVISIONS%ROWTYPE  := NULL;
    --
    REC_TA1056_INIT TA1056SUPPLIERS%ROWTYPE         := NULL;
    REC_TA1057_INIT TA1057SUPPLIERDIVISIONS%ROWTYPE := NULL;

    --
    VL_DES_TA1056     X_FIELD_INFO_ARRAY;-- Array with fields db info
    VL_DES_TA1057     X_FIELD_INFO_ARRAY;-- Array with fields db info
    --
    VL_RECORD_LOCKED NUMBER := 0;
    VL_STATUS NUMBER:= 0;
    VL_COUNT  NUMBER:= 0;
    VL_STEP   NUMBER:= 0; -- Used to ping t035
    --
    EX_EXIT  EXCEPTION;
    --
    VL_CODDIV VARCHAR2(30) := NULL;

  BEGIN

     -- Rebuild indexes and compute statistics
    P_XIN_INIT_INDEXES (PI_PROGR_H, 'TA1056SUPPLIERS');
    P_XIN_INIT_INDEXES (PI_PROGR_H, 'TA1057SUPPLIERDIVI');
    -- Clean up older log

    P_XIN_CLEANUP_LOG (PI_PROGR_H, 'TA1056SUPPLIERS');
    P_XIN_CLEANUP_LOG (PI_PROGR_H, 'TA1057SUPPLIERDIVI');
    --

    VL_PROGR_D_TA1056 := PKG_UTILS.LOG_NEW_DETAIL(PI_PROGR_H,
                                                'SUPPLIER HEAD',
                                                'IMPORT --> TA1056SUPPLIERS',
                                                 0,
                                                 NULL);
    --
    VL_PROGR_D_TA1057 := PKG_UTILS.LOG_NEW_DETAIL(PI_PROGR_H,
                                                'SUPPLIER DIV INFO',
                                                 'IMPORT --> TA1057SUPPLIERDIVIONS',
                                                  0,
                                                   NULL);





   BEGIN
        --
        -- ----------------------------------------------------------
        -- Init arrays with FIELD_NAME=LENGTH and FIELDNAME=SM1_DEFAULT for all fields of table
        -- ----------------------------------------------------------
        VL_DES_TA1056.DELETE;
        P_INIT_SM1_FIELD_ARRAY ('TA1056SUPPLIERS',VL_DES_TA1056, VL_STATUS, VL_MESSAGE_H);
        execute immediate ( GL_INIT_REC) INTO REC_TA1056_INIT;

        VL_DES_TA1057.DELETE;
        P_INIT_SM1_FIELD_ARRAY ('TA1057SUPPLIERDIVISIONS',VL_DES_TA1057,VL_STATUS, VL_MESSAGE_H);
        execute immediate ( GL_INIT_REC) INTO REC_TA1057_INIT;

        IF (VL_STATUS <> 0 ) THEN
            VL_MESSAGE_D := GL_INIT_REC;
            RAISE EX_EXIT;
        END IF;
    EXCEPTION WHEN OTHERS THEN
        VL_MESSAGE_D := GL_INIT_REC;
        RAISE EX_EXIT;
    END;


    -- --------------------------------------------------------------
    -- Identifies Xin records to be loaded
    -- --------------------------------------------------------------
    BEGIN
        VL_MESSAGE_D := 'XIN_TA1056SUPPLIERS';
        UPDATE XIN_TA1056SUPPLIERS
        SET SM1_CODPROCESS = PI_PROGR_H,
            SM1_STATUS = 0,
            SM1_DTEPROCESS = XSYSDATE
            WHERE SM1_CODPROCESS = C_SM1_NULL_CODPROCESS;

        VL_COUNT_XIN_TA1056 := SQL%ROWCOUNT;


        VL_MESSAGE_D := 'XIN_TA1057SUPPLIERDIVI';
        UPDATE XIN_TA1057SUPPLIERDIVI D
        SET D.SM1_CODPROCESS = PI_PROGR_H,
            D.SM1_STATUS = 0,
            D.SM1_DTEPROCESS = XSYSDATE
        WHERE D.SUPPLIERCODE IN (SELECT H.SUPPLIERCODE FROM XIN_TA1056SUPPLIERS H WHERE H.SM1_CODPROCESS = PI_PROGR_H AND H.SM1_DTECRE >= D.SM1_DTECRE )
        AND SM1_CODPROCESS = C_SM1_NULL_CODPROCESS;
       VL_COUNT_XIN_TA1057 := SQL%ROWCOUNT;

    COMMIT;
    EXCEPTION WHEN OTHERS THEN
      ROLLBACK;
      VL_MESSAGE_H := 'Error while Reading Staging area: '||VL_MESSAGE_D;
      RAISE EX_EXIT;
    END;
    -- --------------------------------------------------------------
    -- loop in main table TA1056SUPPLIERS
    -- --------------------------------------------------------------
    FOR RL_XIN_TA1056 IN CL_XIN_TA1056 LOOP

      -- pings to t035 every 1000 cicles--
      VL_STEP := VL_STEP + 1;
      IF ( MOD(VL_STEP, 1000) = 0 ) THEN
         PKG_UTILS.user_ping(PI_SESSION_ID);
      END IF;

      --
      VL_STATUS := 0;
      VL_RECORD_LOCKED := 0;
      --
      VL_MESSAGE_H :=   'Supplier: '||RL_XIN_TA1056.SUPPLIERCODE;
      --
      BEGIN --- HEAD TA1056

       -- Data Format Check
        VL_MESSAGE_D := 'Format Conversion ';
        VL_CODDIV:= 'ALL';

        REC_TA1056.SUPPLIERCODE := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_TA1056.SUPPLIERCODE,'SUPPLIERCODE', VL_DES_TA1056,VL_STATUS, VL_MESSAGE_D);
        REC_TA1056.DESSUPPLIER  := F_CHECK_FORMAT_S( VL_CODDIV,  RL_XIN_TA1056.DESSUPPLIER,'DESSUPPLIER', VL_DES_TA1056,VL_STATUS, VL_MESSAGE_D);
        REC_TA1056.ADDRESS      := F_CHECK_FORMAT_S( VL_CODDIV,  RL_XIN_TA1056.ADDRESS,'ADDRESS', VL_DES_TA1056,VL_STATUS, VL_MESSAGE_D);
        REC_TA1056.CITY         := F_CHECK_FORMAT_S( VL_CODDIV,  RL_XIN_TA1056.CITY,'CITY', VL_DES_TA1056,VL_STATUS, VL_MESSAGE_D);
        REC_TA1056.ZONECODE     := F_CHECK_FORMAT_S( VL_CODDIV,  RL_XIN_TA1056.ZONECODE,'ZONECODE', VL_DES_TA1056,VL_STATUS, VL_MESSAGE_D);
        REC_TA1056.PHONENUMBER  := F_CHECK_FORMAT_S( VL_CODDIV,  RL_XIN_TA1056.PHONENUMBER,'PHONENUMBER', VL_DES_TA1056,VL_STATUS, VL_MESSAGE_D);
        REC_TA1056.VATCODE      := F_CHECK_FORMAT_S( VL_CODDIV,  RL_XIN_TA1056.VATCODE,'VATCODE', VL_DES_TA1056,VL_STATUS, VL_MESSAGE_D);
        REC_TA1056.FLGANN       := F_CHECK_FORMAT_N( VL_CODDIV,  RL_XIN_TA1056.FLGANN,'FLGANN', VL_DES_TA1056,VL_STATUS, VL_MESSAGE_D);
        REC_TA1056.STARTDATE    := F_CHECK_FORMAT_D( VL_CODDIV,  RL_XIN_TA1056.STARTDATE,'STARTDATE', VL_DES_TA1056,VL_STATUS, VL_MESSAGE_D);
        REC_TA1056.ENDDATE      := F_CHECK_FORMAT_D( VL_CODDIV,  RL_XIN_TA1056.ENDDATE,'ENDDATE', VL_DES_TA1056,VL_STATUS, VL_MESSAGE_D);

       --- Technical fields
        REC_TA1056.DTECRE     := XSYSDATE;
        REC_TA1056.CODUSRMOD  := C_SYSUSR;
        REC_TA1056.DTEMOD     := XSYSDATE;
        -- lock fields
        REC_TA1056.CODUSRLCK     := C_SYSUSR;
        REC_TA1056.IDSESSIONLCK  := PI_SESSION_ID;
        REC_TA1056.DTELCK        := XSYSDATE;
        -- DocumentKey
        REC_TA1056.DOCUMENTKEY   := NULL;--MISSING
        IF (VL_STATUS <> 0 ) THEN

         VL_MESSAGE_H := SUBSTR(VL_MESSAGE_H||' '||VL_MESSAGE_D||' '||dbms_utility.format_error_backtrace() || ' ' || SQLERRM,1,4000);

             PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                           VL_PROGR_D_TA1056,
                                           SQLCODE,
                                           VL_MESSAGE_H);
        END IF;

        IF (VL_STATUS = 0 ) THEN
          -- when status <> 0 some fields have incorrect format. Log t800 has been already wrote by F_CHECK function
          -- Update article if already exists

           VL_MESSAGE_D := 'Update TA1056SUPPLIERS ';
           UPDATE TA1056SUPPLIERS
           SET
               -- when the field si set to updated by host it means that the value should be read from XIN
               -- otherwise it means that the field is managed by sm1 and it maintains its original value
                DESSUPPLIER = CASE VL_DES_TA1056('DESSUPPLIER.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA1056.DESSUPPLIER ELSE DESSUPPLIER END,
                ADDRESS = CASE VL_DES_TA1056('ADDRESS.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA1056.ADDRESS ELSE ADDRESS END,
                CITY = CASE VL_DES_TA1056('CITY.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA1056.CITY ELSE CITY END,
                ZONECODE = CASE VL_DES_TA1056('ZONECODE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA1056.ZONECODE ELSE ZONECODE END,
                PHONENUMBER = CASE VL_DES_TA1056('PHONENUMBER.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA1056.PHONENUMBER ELSE PHONENUMBER END,
                VATCODE = CASE VL_DES_TA1056('VATCODE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA1056.VATCODE ELSE VATCODE END,
                FLGANN = CASE VL_DES_TA1056('FLGANN.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA1056.FLGANN ELSE FLGANN END,
                STARTDATE = CASE VL_DES_TA1056('STARTDATE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA1056.STARTDATE ELSE STARTDATE END,
                ENDDATE = CASE VL_DES_TA1056('ENDDATE.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA1056.ENDDATE ELSE ENDDATE END,
                --- Technical fields
                CODUSRMOD = REC_TA1056.CODUSRMOD,
                DTEMOD    = REC_TA1056.DTEMOD,
                -- lock fields
                CODUSRLCK    = REC_TA1056.CODUSRLCK,
                IDSESSIONLCK = REC_TA1056.IDSESSIONLCK,
                DTELCK       = REC_TA1056.DTELCK

         WHERE SUPPLIERCODE = REC_TA1056.SUPPLIERCODE
         and not exists ( select null from T035LOGGEDUSERS T035 where T035.IDSESSION = NVL(IDSESSIONLCK, 0) AND T035.LASTCHECK > TRUNC(XSYSDATE)-1 );

        -- no data found, it could be
        --   a. record does not exists
        --   b. record is locked by another sm1 user

        IF SQL%ROWCOUNT = 0 THEN

          VL_COUNT := 0;
          SELECT COUNT(*) INTO VL_COUNT FROM TA1056SUPPLIERS
           WHERE SUPPLIERCODE = REC_TA1056.SUPPLIERCODE;

          IF ( VL_COUNT = 0 ) THEN
              VL_MESSAGE_D := 'Insert TA1056SUPPLIERS ';
              -- Record does not exists, we insert it
              INSERT INTO TA1056SUPPLIERS VALUES REC_TA1056;
           ELSE
            VL_STATUS := -1;
            VL_RECORD_LOCKED := -1;
            PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                           VL_PROGR_D_TA1056,
                                           SQLCODE,
                                           'Record is locked; import has failed :'||VL_MESSAGE_H);

          END IF; -- Record has been inserted
        END IF; -- Record has been updated
        END IF; -- VL_STATUS = 0

        EXCEPTION WHEN OTHERS THEN
             VL_STATUS := -1;
             VL_MESSAGE_H := SUBSTR(VL_MESSAGE_H||' '||VL_MESSAGE_D||' '||dbms_utility.format_error_backtrace() || ' ' || SQLERRM,1,4000);

             PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                           VL_PROGR_D_TA1056,
                                           SQLCODE,
                                           VL_MESSAGE_H);
        END; -- HEAD TA1056

        -- -----------------------------------
        -- TA1057SUPPLIERDIVI DIVISION INFO
        -- -----------------------------------
        BEGIN
        --
        IF ( VL_STATUS = 0  ) THEN
              -- Division info TA1057SUPPLIERDIVI

              FOR RL_XIN_TA1057 IN CL_XIN_TA1057(RL_XIN_TA1056.SUPPLIERCODE, RL_XIN_TA1056.SM1_DTECRE) LOOP

                VL_MESSAGE_H := 'Supplier: '|| RL_XIN_TA1057.SUPPLIERCODE || '/' ||
                                'Division: '|| RL_XIN_TA1057.CODDIV;

                VL_MESSAGE_D := 'Format Conversion ';
                VL_CODDIV:= RL_XIN_TA1057.CODDIV;
                REC_TA1057.SUPPLIERCODE := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_TA1057.SUPPLIERCODE,'SUPPLIERCODE', VL_DES_TA1057,VL_STATUS, VL_MESSAGE_D);
                REC_TA1057.CODDIV       := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_TA1057.CODDIV,'CODDIV', VL_DES_TA1057,VL_STATUS, VL_MESSAGE_D);
                REC_TA1057.CODPAYMOD    := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_TA1057.CODPAYMOD,'CODPAYMOD', VL_DES_TA1057,VL_STATUS, VL_MESSAGE_D);
                REC_TA1057.CODPAYTERM   := F_CHECK_FORMAT_S( VL_CODDIV, RL_XIN_TA1057.CODPAYTERM,'CODPAYTERM', VL_DES_TA1057,VL_STATUS, VL_MESSAGE_D);

                 IF (VL_STATUS <> 0 ) THEN
                   VL_MESSAGE_H := SUBSTR(VL_MESSAGE_H||' '||VL_MESSAGE_D||' '||dbms_utility.format_error_backtrace() || ' ' || SQLERRM,1,4000);
                   PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                           VL_PROGR_D_TA1057,
                                           SQLCODE,
                                           VL_MESSAGE_H);
                 END IF;

                IF (VL_STATUS = 0 ) THEN
                --
                VL_MESSAGE_D := 'Update TA1057 ';
                UPDATE TA1057SUPPLIERDIVISIONS
                   SET
                     CODPAYMOD  = CASE VL_DES_TA1057('CODPAYMOD.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA1057.CODPAYMOD ELSE CODPAYMOD END,
                     CODPAYTERM = CASE VL_DES_TA1057('CODPAYTERM.ALL').FLG_SM1 WHEN C_UPDATED_BY_HOST THEN REC_TA1057.CODPAYTERM ELSE CODPAYTERM END

                 WHERE SUPPLIERCODE = REC_TA1057.SUPPLIERCODE
                   AND CODDIV       = REC_TA1057.CODDIV;
                --
                IF SQL%ROWCOUNT = 0 THEN
                  -- record does not exists , we insert it
                  VL_MESSAGE_D := 'Insert TA1057 ';
                  INSERT INTO TA1057SUPPLIERDIVISIONS VALUES REC_TA1057;
                END IF;
                VL_INS_TA1057 := VL_INS_TA1057 + 1;
                --
                END IF;

      END LOOP; -- TA1057

      END IF; --( VL_STATUS = 0 AND VL_RECORD_LOCKED = 0 )
        --
      EXCEPTION
        WHEN OTHERS THEN
           VL_STATUS := -1;
           VL_MESSAGE_H := SUBSTR(VL_MESSAGE_H||' '||VL_MESSAGE_D||' '||dbms_utility.format_error_backtrace() || ' ' || SQLERRM,1,4000);

           PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                           VL_PROGR_D_TA1057,
                                           SQLCODE,
                                           VL_MESSAGE_H);

      END; --- DIVISION INFO TA1057


      -- Into the loop we set only records on error
      IF ( VL_STATUS <> 0 OR VL_RECORD_LOCKED <> 0 ) THEN
              ROLLBACK;
              UPDATE XIN_TA1056SUPPLIERS
              SET   SM1_STATUS = CASE
                                      WHEN VL_RECORD_LOCKED <> 0  THEN C_XINSTATUS_LOCK
                                      ELSE C_XINSTATUS_ERR END
              WHERE SUPPLIERCODE = RL_XIN_TA1056.SUPPLIERCODE
               AND  SM1_CODPROCESS = PI_PROGR_H
               AND  SM1_DTECRE     = RL_XIN_TA1056.SM1_DTECRE
               AND  SM1_STATUS     = C_XINSTATUS_OK;


              UPDATE XIN_TA1057SUPPLIERDIVI
              SET SM1_STATUS = CASE
                                    WHEN VL_RECORD_LOCKED <> 0  THEN C_XINSTATUS_LOCK
                                    ELSE C_XINSTATUS_ERR END
              WHERE SUPPLIERCODE = RL_XIN_TA1056.SUPPLIERCODE
               AND  SM1_CODPROCESS = PI_PROGR_H
               AND  SM1_DTECRE <= RL_XIN_TA1056.SM1_DTECRE
               AND  SM1_STATUS     = C_XINSTATUS_OK;

             COMMIT;
        ELSE
          VL_INS_TA1056 := VL_INS_TA1056 + 1;
          COMMIT;
        END IF;


       -- Release Record
        UPDATE TA1056SUPPLIERS
        SET       DTELCK          = NULL,
                  IDSESSIONLCK    = NULL,
                  CODUSRLCK       = NULL
        WHERE SUPPLIERCODE     = REC_TA1056.SUPPLIERCODE
          AND IDSESSIONLCK = PI_SESSION_ID
          AND CODUSRLCK    = C_SYSUSR;

        COMMIT;

    END LOOP;  -- TA1056SUPPLIERS



    BEGIN

       -- Moves records from staging area to log staging area
       P_XIN_MOVE_TO_LOG(PI_PROGR_H, VL_PROGR_D_TA1057,'TA1057SUPPLIERDIVI');
       P_XIN_MOVE_TO_LOG(PI_PROGR_H, VL_PROGR_D_TA1056,'TA1056SUPPLIERS');       --
    END;



   -- Close Logs

    --
    --
    PKG_UTILS.LOG_END_DETAIL(PI_PROGR_H,
                                      VL_PROGR_D_TA1057,
                                      0,
                                      VL_COUNT_XIN_TA1057,
                                      VL_INS_TA1057,
                                      VL_COUNT_XIN_TA1057 - VL_INS_TA1057);
    --
    PKG_UTILS.LOG_END_DETAIL(PI_PROGR_H,
                                      VL_PROGR_D_TA1056,
                                      0,
                                      VL_COUNT_XIN_TA1056,
                                      VL_INS_TA1056,
                                      VL_COUNT_XIN_TA1056 - VL_INS_TA1056);


    PO_MSG    := VL_INS_TA1056||'/'||VL_COUNT_XIN_TA1056||' Suppliers loaded';
    PO_STATUS := VL_INS_TA1056;


    --
  EXCEPTION WHEN EX_EXIT THEN

          ROLLBACK;
          VL_MESSAGE_H       := VL_MESSAGE_H || TRIM(SUBSTR(dbms_utility.format_error_backtrace() || ' ' || SQLERRM, 1, 255));
          PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                                  VL_PROGR_D_TA1056,
                                                  SQLCODE,
                                                  VL_MESSAGE_H);

          PO_MSG := VL_MESSAGE_H;
          PO_STATUS := -1;

   WHEN OTHERS THEN

          ROLLBACK;

          BEGIN
              -- Release updated records
              UPDATE TA1056SUPPLIERS
              SET       DTELCK          = NULL,
                        IDSESSIONLCK    = NULL,
                        CODUSRLCK       = NULL
              WHERE CODUSRLCK = C_SYSUSR AND IDSESSIONLCK = PI_SESSION_ID;
              COMMIT;

             -- Moves records from staging area to log staging area
             P_XIN_MOVE_TO_LOG(PI_PROGR_H, VL_PROGR_D_TA1057,'TA1057SUPPLIERDIVI');
             P_XIN_MOVE_TO_LOG(PI_PROGR_H, VL_PROGR_D_TA1056,'TA1056SUPPLIERS');

          END;

          VL_MESSAGE_H       := VL_MESSAGE_H || TRIM(SUBSTR(dbms_utility.format_error_backtrace() || ' ' || SQLERRM, 1, 255));
          PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                                  VL_PROGR_D_TA1056,
                                                  SQLCODE,
                                                  VL_MESSAGE_H);

          PO_MSG := VL_MESSAGE_H;
          PO_STATUS := VL_STATUS;

  END LOAD_TA1056_SUPPLIERS;
  --

  /*============================================================================*\
  /* Name: CHECK_VALIDITY_IN_QTABS
        Performs checks against data in SM1 decoding tablee :

        • Customers is already present in Customer Master data table.

        Error handling:
        • All Errors will be logged in T852/T854 SM1 log tables.

     Input parameters :     PI_CODDIV    - Division code
                            PI_DATA_NAME - Decoding code to be queried from QTABS_C.CODTAB
                            PI_DATA      - Decoding value to be queried from QTABS_C.COD
     Outputparameters :     PO_STATUS    - 0 OK; -1 Error 
                            PO_MESSAGE   - message of error if procedure exit with error
     Author : ravi.gopeechund.sa@everis.com
     Creation Date : 03/03/2021
     ----
  ============================================================================ */      
  PROCEDURE CHECK_VALIDITY_IN_QTABS(PI_CODDIV    IN VARCHAR2,
                                    PI_DATA_NAME IN VARCHAR2,
                                    PI_DATA      IN VARCHAR2,
                                    PO_STATUS    OUT NUMBER,
                                    PO_MESSAGE   OUT VARCHAR2) IS
    VL_DECODE NUMBER;
  BEGIN

    SELECT COUNT(1)
      INTO VL_DECODE
      FROM QTABS
     WHERE 1 = 1
       AND CODSYS = NVL(PI_CODDIV, 'ALL')
       AND CODTAB = PI_DATA_NAME
       AND COD = PI_DATA;
    
    IF (VL_DECODE = 0) THEN
      PO_MESSAGE := 'No decode found for CODTAB: ' || PI_DATA_NAME ||
                    '; division: ' || PI_CODDIV || '; value: ' || PI_DATA || ';';
      PO_STATUS  := -1;
    ELSE 
      PO_STATUS := 0;
    END IF;

  EXCEPTION    
    WHEN OTHERS THEN
      PO_MESSAGE := 'Error occurred during decoding for CODTAB: ' ||
                    PI_DATA_NAME || '; division: ' || PI_CODDIV ||
                    '; value: ' || PI_DATA || ';' ||
                    TRIM(SUBSTR(dbms_utility.format_error_backtrace() || ' ' ||
                                SQLERRM,
                                1,
                                255));
      PO_STATUS  := -1;
  END;
  
  /*============================================================================*\
    Name: LOAD_T041_PAYMOD_SYG
        Loads SM1 table :
        • T041PARTYDIV              Customer master data table by division

        Staging Area (SSA) tables :
        1•  XIN_T041_PAYMOD         Staging Area Table for customers payment mode

        Loading logic:
        • UPDATE each record is updated if already exists.

        Validity Checks:
        • Customers is already present in Customer Master data table.

        Error handling:
        • All Errors will be logged in T852/T854 SM1 log tables and all staging area records will be stored into staging area log with sm1_status = 9.

     Input parameters :     PI_PROGR_H       - unique sm1 job number ( T800SYSTEMACTIVITYLOG )
                            PI_SESSION_ID    - unique login session (T035LOGGEDUSERS)
     Outputparameters :     PO_MSG           - message of error if procedure exit with error
                            PO_STATUS        - 0 OK; -1 Error
     Author : ravi.gopeechund.sa@everis.com
     Creation Date : 03/03/2021
     ----
  ============================================================================ */
  PROCEDURE LOAD_T041_PAYMOD_SYG(PI_PROGR_H       IN NUMBER,
                                 PI_SESSION_ID    IN NUMBER,
                                 PO_MSG           OUT NOCOPY VARCHAR2,
                                 PO_STATUS        OUT NOCOPY NUMBER) IS

    -- -----------------------------------------
    -- Cursor on Payment mode table
    -- -----------------------------------------
    CURSOR CL_XIN_T041_PAYMOD IS
      SELECT *
        FROM XIN_T041_PAYMOD
       WHERE SM1_CODPROCESS = PI_PROGR_H
       ORDER BY CODPARTY, SM1_DTECRE;
    --
    VL_MESSAGE_H   VARCHAR2(4000) := NULL;
    VL_MESSAGE_D   VARCHAR2(4000) := NULL;
    --
    VL_PROGR_D_T041    NUMBER := 0;
    VL_COUNT_XIN_T041  NUMBER := 0;
    VL_INS_T041        NUMBER := 0;
    VL_COUNT_CUSTOMER NUMBER := 0;
    --
    VL_RECORD_LOCKED NUMBER := 0;
    VL_STATUS NUMBER:= 0;
    VL_STEP   NUMBER:= 0;
    --
    EX_EXIT  EXCEPTION;
    --  
  BEGIN
    -- Rebuild indexes and compute statistics
    P_XIN_INIT_INDEXES (PI_PROGR_H, 'T041PARTYDIV');
    -- clean log
    P_XIN_CLEANUP_LOG (PI_PROGR_H, 'T041_PAYMOD');
    
    VL_PROGR_D_T041 := PKG_UTILS.LOG_NEW_DETAIL(PI_PROGR_H,
                                                'CUSTOMER PAYMENT MODE',
                                                'IMPORT --> Customer payment mode for SYG division',
                                                 0,
                                                 NULL);
    
    -- --------------------------------------------------------------
    -- Identifies Xin records to be loaded
    -- --------------------------------------------------------------
    BEGIN

      UPDATE XIN_T041_PAYMOD D
         SET D.SM1_CODPROCESS = PI_PROGR_H,
             D.SM1_STATUS = 0,
             D.SM1_DTEPROCESS = XSYSDATE
       WHERE 1=1
         AND NVL(SM1_CODPROCESS, 0) = C_SM1_NULL_CODPROCESS
         AND CODDIV = 'SYG';
          
      VL_COUNT_XIN_T041 := SQL%ROWCOUNT;
      COMMIT;
       
    EXCEPTION
      WHEN OTHERS THEN
        ROLLBACK;
        VL_MESSAGE_H := 'Error while Reading Staging area: ' || TRIM(SUBSTR(dbms_utility.format_error_backtrace() || ' ' || SQLERRM, 1, 255));
        RAISE EX_EXIT;
    END;
    
    -- --------------------------------------------------------------
    -- loop through table XIN_T041_PAYMOD
    -- --------------------------------------------------------------
    FOR RL_XIN_T041_PAYMOD IN CL_XIN_T041_PAYMOD LOOP

      -- pings to t035 every 1000 cicles--
      VL_STEP := VL_STEP + 1;
      IF (MOD(VL_STEP, 1000) = 0) THEN
         PKG_UTILS.user_ping(PI_SESSION_ID);
      END IF;

      --
      VL_STATUS := 0;
      VL_RECORD_LOCKED := 0;
      VL_COUNT_CUSTOMER := 0;
      --
      VL_MESSAGE_H := 'Customer: ' || RL_XIN_T041_PAYMOD.CODPARTY || ' ' || 'Division: ' || RL_XIN_T041_PAYMOD.CODDIV || ' Format Conversion => ';
      --
      BEGIN
        
        -- 1. Check and log error if customer does not exist in master data
        SELECT COUNT(1)
          INTO VL_COUNT_CUSTOMER
          FROM T041PARTYDIV
         WHERE 1 = 1
           AND CODPARTY = GET_CUSTOMER_CODE(RL_XIN_T041_PAYMOD.CODDIV,RL_XIN_T041_PAYMOD.CODPARTY)
           AND CODDIV = RL_XIN_T041_PAYMOD.CODDIV;
        
        IF (VL_COUNT_CUSTOMER = 0) THEN
          VL_STATUS := -1;
          VL_MESSAGE_H := VL_MESSAGE_H || ' / ' || 'Combination of Customer and division does not exist';
        END IF;
        
        -- 2. Check and log error if payment mode is null
        IF (RL_XIN_T041_PAYMOD.CODPAYMOD IS NULL) THEN
          VL_STATUS := -1;
          VL_MESSAGE_H := VL_MESSAGE_H ||' / ' || 'Payment mode (CODPAYMOD) is mandatory';
        END IF;
        
        -- 3. Check and log error if payment term is null
        IF (RL_XIN_T041_PAYMOD.CODPAYTRM IS NULL) THEN
          VL_STATUS := -1;
          VL_MESSAGE_H := VL_MESSAGE_H || ' / ' || 'Payment term (CODPAYTRM) is mandatory';
        END IF;
        
        -- 4. Check if CODPAYMOD is valid in SM1
        IF (VL_STATUS = 0) THEN
          CHECK_VALIDITY_IN_QTABS(PI_CODDIV    => RL_XIN_T041_PAYMOD.CODDIV,
                                  PI_DATA_NAME => 'CPMOD',
                                  PI_DATA      => RL_XIN_T041_PAYMOD.CODPAYMOD,
                                  PO_STATUS    => VL_STATUS,
                                  PO_MESSAGE   => VL_MESSAGE_D);
          VL_MESSAGE_H := VL_MESSAGE_H || ' / ' || VL_MESSAGE_D;
        END IF;
                
        -- Check if errors exist and mark record as error in staging table
        IF (VL_STATUS <> 0) THEN
          
          UPDATE XIN_T041_PAYMOD
             SET SM1_STATUS = C_XINSTATUS_ERR
           WHERE CODPARTY = GET_CUSTOMER_CODE(RL_XIN_T041_PAYMOD.CODDIV,RL_XIN_T041_PAYMOD.CODPARTY)
             AND CODDIV = RL_XIN_T041_PAYMOD.CODDIV
             AND SM1_CODPROCESS = PI_PROGR_H
             AND SM1_STATUS = C_XINSTATUS_OK;

          -- Log error message and go to next iteration
          PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                         VL_PROGR_D_T041,
                                         SQLCODE,
                                         SUBSTR(VL_MESSAGE_H,1,4000));
        END IF;
        
        -- Update core table if no errors raised during data transformation
        IF (VL_STATUS = 0) THEN
          
          VL_MESSAGE_D := 'Update T041 ';
          UPDATE T041PARTYDIV
             SET CODPAYMOD = TRIM(RL_XIN_T041_PAYMOD.CODPAYMOD),
                 CODPAYTRM = TRIM(RL_XIN_T041_PAYMOD.CODPAYTRM)
           WHERE 1=1
             AND CODPARTY = GET_CUSTOMER_CODE(RL_XIN_T041_PAYMOD.CODDIV,RL_XIN_T041_PAYMOD.CODPARTY)
             AND CODDIV   = RL_XIN_T041_PAYMOD.CODDIV;
             
          VL_INS_T041 := VL_INS_T041 + 1;
          
        END IF;
        
      EXCEPTION
        WHEN OTHERS THEN
          VL_STATUS := -1;
          VL_MESSAGE_H := SUBSTR(VL_MESSAGE_H ||' ' || VL_MESSAGE_D || ' ' || dbms_utility.format_error_backtrace() || ' ' || SQLERRM,1,4000);
          PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                         VL_PROGR_D_T041,
                                         SQLCODE,
                                         VL_MESSAGE_H);

      END;

    END LOOP;
    COMMIT;
    
    -- Move data from XIN to log
    P_XIN_MOVE_TO_LOG(PI_PROGR_H, VL_PROGR_D_T041,'T041_PAYMOD');
   
    PKG_UTILS.LOG_END_DETAIL(PI_PROGR_H,
                             VL_PROGR_D_T041,
                             0,
                             VL_COUNT_XIN_T041,
                             VL_INS_T041,
                             VL_COUNT_XIN_T041 - VL_INS_T041);

    PO_MSG    := VL_INS_T041 || '/' || VL_COUNT_XIN_T041 || ' Customer payment modes loaded';
    PO_STATUS := VL_STATUS;
    
  EXCEPTION
    WHEN EX_EXIT THEN
      ROLLBACK;
      VL_MESSAGE_H := VL_MESSAGE_H || TRIM(SUBSTR(dbms_utility.format_error_backtrace() || ' ' || SQLERRM, 1, 255));
      PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                     VL_PROGR_D_T041,
                                     SQLCODE,
                                     VL_MESSAGE_H);

      PO_MSG := VL_MESSAGE_H;
      PO_STATUS := -1;

    WHEN OTHERS THEN
      ROLLBACK;
      P_XIN_MOVE_TO_LOG(PI_PROGR_H, VL_PROGR_D_T041,'T041PARTYDIV');
      VL_MESSAGE_H := VL_MESSAGE_H || TRIM(SUBSTR(dbms_utility.format_error_backtrace() || ' ' || SQLERRM, 1, 255));
     
      PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                     VL_PROGR_D_T041,
                                     SQLCODE,
                                     VL_MESSAGE_H);

      PO_MSG := VL_MESSAGE_H;
      PO_STATUS := VL_STATUS;

  END LOAD_T041_PAYMOD_SYG;
  
  /*============================================================================*\
  /* Name: LOAD_T048_CREDIT_SYG
      Loads SM1 tables
      • T048PARTYAMOUNT Invoice customer financial data: customer credit, exposition, etc..
      • Staging Area (SSA) tables
      • XIN_ T048PARTYAMOUNT

      Loading logic:
      UPDATE + INSERT record is updated if already exists (checking by primary key) and it is not already locked, record is inserted if it does not exist yet.

      Validity Checks:
      • Record found on  XIN_T048PARTYAMOUNT is loaded only if there is the head record in T040PARTY.

      Error handling:
      • All Errors will be logged in T852/T854 SM1 log tables and all staging area records will be stored into staging area log with sm1_status = 9.
      • Error on record,  it is discarded and import skip to next record to be loaded

      How to delete a record : you cannot delete records in T048PARTYAMOUNT by integration host.


     Input parameters :     PI_PROGR_H       - unique sm1 job number ( T800SYSTEMACTIVITYLOG )
                            PI_SESSION_ID    - unique login session (T035LOGGEDUSERS)
     Outputparameters :     PO_MSG           - message of error if procedure exit with error
                            PO_STATUS        - 0 OK; -1 Error
     Author : ravi.gopeechund.sa@everis.com
     Creation Date : 03/03/2021
     ----
   ============================================================================ */
  PROCEDURE LOAD_T048_CREDIT_SYG(PI_PROGR_H       IN NUMBER,
                                 PI_SESSION_ID    IN NUMBER,
                                 PO_MSG           OUT NOCOPY VARCHAR2,
                                 PO_STATUS        OUT NOCOPY NUMBER ) IS

    -- -----------------------------------------
    -- Cursor on Customer Credit table T048PARTYAMOUNT
    -- -----------------------------------------
    CURSOR CL_XIN_T048 IS
      SELECT *
        FROM XIN_T048PARTYAMOUNT
       WHERE SM1_CODPROCESS = PI_PROGR_H
       ORDER BY CODPARTY, SM1_DTECRE;

    --
    VL_MESSAGE_H   VARCHAR2(4000) := 'Error while loading CUSTOMERS Credit T048';
    VL_MESSAGE_D   VARCHAR2(4000) := NULL;
    --
    VL_PROGR_D_T048    NUMBER := 0;
    VL_COUNT_XIN_T048  NUMBER := 0;
    VL_INS_T048        NUMBER := 0;
    --
    REC_T048 T048PARTYAMOUNT%ROWTYPE    := NULL;
    REC_T048_INIT T048PARTYAMOUNT%ROWTYPE    := NULL;
    --
    VL_STATUS NUMBER:= 0;
    VL_COUNT  NUMBER:= 0;
    --
    EX_EXIT  EXCEPTION;
    --
    VL_STEP   NUMBER:= 0; -- Used to ping t035

  BEGIN

    -- init indexes and rebuild statistics
    P_XIN_INIT_INDEXES (PI_PROGR_H, 'T048PARTYAMOUNT');
    -- clean log
    P_XIN_CLEANUP_LOG (PI_PROGR_H, 'T048PARTYAMOUNT');
    --
    VL_PROGR_D_T048 := PKG_UTILS.LOG_NEW_DETAIL(PI_PROGR_H,
                                                'CUSTOMER CREDIT',
                                                'IMPORT --> Customer credit limit for SYG division',
                                                 0,
                                                 NULL);

    -- --------------------------------------------------------------
    -- Identifies Xin records to be loaded
    -- --------------------------------------------------------------
    BEGIN
      
        UPDATE XIN_T048PARTYAMOUNT
           SET SM1_CODPROCESS = PI_PROGR_H,
               SM1_STATUS = 0,
               SM1_DTEPROCESS = XSYSDATE
         WHERE SM1_CODPROCESS = C_SM1_NULL_CODPROCESS
           AND CODDIV = 'SYG';

        VL_COUNT_XIN_T048 := SQL%ROWCOUNT;

        COMMIT;
    EXCEPTION WHEN OTHERS THEN
      ROLLBACK;
      VL_MESSAGE_H := 'Error while Reading Staging area: XIN_T048PARTYAMOUNT' || TRIM(SUBSTR(dbms_utility.format_error_backtrace() || ' ' || SQLERRM, 1, 255));
      RAISE EX_EXIT;

    END;
    -- --------------------------------------------------------------
    -- loop in main table T048PARTYAMOUNT
    -- --------------------------------------------------------------
    FOR RL_XIN_T048 IN CL_XIN_T048 LOOP
      -- pings to t035 every 1000 cicles--
      VL_STEP := VL_STEP + 1;
      IF ( MOD(VL_STEP, 1000) = 0 ) THEN
         PKG_UTILS.user_ping(PI_SESSION_ID);
      END IF;

      --
      VL_STATUS := 0;
      VL_MESSAGE_H := 'Customer: ' || RL_XIN_T048.CODPARTY || ' ' || 'Division: ' || RL_XIN_T048.CODDIV || ' ' || 'Format Conversion => ';
      --
      BEGIN
        
        -- 1. Check and log error if Customer code is null
        IF (RL_XIN_T048.CODPARTY IS NULL) THEN
          VL_STATUS := -1;
          VL_MESSAGE_H := VL_MESSAGE_H ||' / ' || 'Customer code (CODPARTY) is mandatory';
        END IF;
        
        -- 2. Check and log error if Ordered amount is null
        IF (RL_XIN_T048.VALORDERED IS NULL) THEN
          VL_STATUS := -1;
          VL_MESSAGE_H := VL_MESSAGE_H || ' / ' || 'Ordered amount (VALORDERED) is mandatory';
        END IF;
        
        -- 3. Check and log error if Delivered amount is null
        IF (RL_XIN_T048.VALDELIVERED IS NULL) THEN
          VL_STATUS := -1;
          VL_MESSAGE_H := VL_MESSAGE_H || ' / ' || 'Delivered amount (VALDELIVERED) is mandatory';
        END IF;
        
        -- 4. Check and log error if Expired invoices amount is null
        IF (RL_XIN_T048.VALMATURED IS NULL) THEN
          VL_STATUS := -1;
          VL_MESSAGE_H := VL_MESSAGE_H || ' / ' || 'Expired invoices amount (VALMATURED) is mandatory';
        END IF; 
        
        -- 5. Check and log error if Not expired invoices amount is null
        IF (RL_XIN_T048.VALNOTMATURED IS NULL) THEN
          VL_STATUS := -1;
          VL_MESSAGE_H := VL_MESSAGE_H || ' / ' || 'Not expired invoices amount (VALNOTMATURED) is mandatory';
        END IF;    
        
         -- 6. Check and log error if Total exposition amount is null
        IF (RL_XIN_T048.VALEXPOSED IS NULL) THEN
          VL_STATUS := -1;
          VL_MESSAGE_H := VL_MESSAGE_H || ' / ' || 'Total exposition amount (VALEXPOSED) is mandatory';
        END IF; 

        -- 7. Check and log error if Division code is null
        IF (RL_XIN_T048.CODDIV IS NULL) THEN
          VL_STATUS := -1;
          VL_MESSAGE_H := VL_MESSAGE_H || ' / ' || 'Division code (CODDIV) is mandatory';
        END IF;
        
        -- 8. Check and log error if Customer credit amount is null
        IF (RL_XIN_T048.VALCREDIT IS NULL) THEN
          VL_STATUS := -1;
          VL_MESSAGE_H := VL_MESSAGE_H || ' / ' || 'Customer credit amount (VALCREDIT) is mandatory';
        END IF;      
        
        -- 9. Check and log error if Customer delta amount is null
        IF (RL_XIN_T048.VALDELTA IS NULL) THEN
          VL_STATUS := -1;
          VL_MESSAGE_H := VL_MESSAGE_H || ' / ' || 'Customer delta amount (VALDELTA) is mandatory';
        END IF;

        -- 10. Check if Customer exist in SM1
        VL_COUNT := 0;
        SELECT COUNT(1)
          INTO VL_COUNT
          FROM T041PARTYDIV
         WHERE CODPARTY = GET_CUSTOMER_CODE(RL_XIN_T048.CODDIV,RL_XIN_T048.CODPARTY)
           AND CODDIV = RL_XIN_T048.CODDIV;

        IF (VL_COUNT = 0) THEN
           VL_STATUS := -1;
           VL_MESSAGE_H := VL_MESSAGE_H || ' / ' || 'Customer does not exist';
        END IF;

        IF (VL_STATUS = 0) THEN
          REC_T048 := REC_T048_INIT;
          
          REC_T048.CODPARTY      := TRIM(GET_CUSTOMER_CODE(REC_T048.CODDIV,RL_XIN_T048.CODPARTY));
          REC_T048.VALORDERED    := TRIM(RL_XIN_T048.VALORDERED);
          REC_T048.VALDELIVERED  := TRIM(RL_XIN_T048.VALDELIVERED);
          REC_T048.VALMATURED    := TRIM(RL_XIN_T048.VALMATURED);
          REC_T048.VALNOTMATURED := TRIM(RL_XIN_T048.VALNOTMATURED);
          REC_T048.VALEXPOSED    := TRIM(RL_XIN_T048.VALEXPOSED);
          REC_T048.CODDIV        := TRIM(RL_XIN_T048.CODDIV);
          REC_T048.VALCREDIT     := TRIM(RL_XIN_T048.VALCREDIT);
          REC_T048.VALDELTA      := TRIM(RL_XIN_T048.VALDELTA);

          -- Default date fields
          REC_T048.DTEVALIDCREDIT := SYSDATE;
          REC_T048.DTEMODCREDIT := SYSDATE;
          REC_T048.DTEMODORDERDX := SYSDATE;
          REC_T048.DTELASTCHECK := SYSDATE;
          REC_T048.DTEMAXCONT := SYSDATE;
          
          --- Technical fields
          REC_T048.DTEMOD     := XSYSDATE;
        END IF;

        IF (VL_STATUS <> 0) THEN
           VL_MESSAGE_H := SUBSTR(VL_MESSAGE_H || ' ' || VL_MESSAGE_D,1,4000);
           PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                          VL_PROGR_D_T048,
                                          SQLCODE,
                                          VL_MESSAGE_H);
        END IF;

        IF (VL_STATUS = 0 ) THEN
          -- Update article if already exists
          VL_MESSAGE_D := 'Update T048PartyAmount ';
          UPDATE T048PARTYAMOUNT
            SET VALORDERED     = REC_T048.VALORDERED,
                VALDELIVERED   = REC_T048.VALDELIVERED,
                VALMATURED     = REC_T048.VALMATURED,
                VALNOTMATURED  = REC_T048.VALNOTMATURED,
                VALEXPOSED     = REC_T048.VALEXPOSED,
                VALCREDIT      = REC_T048.VALCREDIT,
                VALDELTA       = REC_T048.VALDELTA,
                -- Default date fields
                DTEVALIDCREDIT = REC_T048.DTEVALIDCREDIT,
                DTEMODCREDIT   = REC_T048.DTEMODCREDIT,
                DTEMODORDERDX  = REC_T048.DTEMODORDERDX,
                DTELASTCHECK   = REC_T048.DTELASTCHECK,
                DTEMAXCONT     = REC_T048.DTEMAXCONT,
                --- Technical fields
                DTEMOD = REC_T048.DTEMOD
          WHERE CODPARTY = GET_CUSTOMER_CODE(REC_T048.CODDIV,RL_XIN_T048.CODPARTY)
            AND CODDIV = REC_T048.CODDIV;

          -- Create record if credit limit does not exist in SM1
          IF SQL%ROWCOUNT = 0 THEN
            VL_MESSAGE_D := 'Insert T048PartyAmount ';
            INSERT INTO T048PARTYAMOUNT VALUES REC_T048;
          END IF;
          
          VL_INS_T048 := VL_INS_T048 + 1;
        END IF;

      EXCEPTION 
        WHEN OTHERS THEN
          VL_STATUS := -1;
          VL_MESSAGE_H := SUBSTR(VL_MESSAGE_H || ' ' || VL_MESSAGE_D || ' ' || dbms_utility.format_error_backtrace() || ' ' || SQLERRM,1,4000);
          PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                        VL_PROGR_D_T048,
                                        SQLCODE,
                                        VL_MESSAGE_H);
      END;

      IF (VL_STATUS <> 0) THEN
        UPDATE XIN_T048PARTYAMOUNT
           SET SM1_STATUS = C_XINSTATUS_ERR
         WHERE CODPARTY = GET_CUSTOMER_CODE(REC_T048.CODDIV,RL_XIN_T048.CODPARTY)
           AND CODDIV = RL_XIN_T048.CODDIV
           AND SM1_CODPROCESS = PI_PROGR_H
           AND SM1_STATUS = C_XINSTATUS_OK;
      END IF;
      
    END LOOP;
    COMMIT;

    -- Moves records from staging area to log staging area
    P_XIN_MOVE_TO_LOG(PI_PROGR_H, VL_PROGR_D_T048,'T048PARTYAMOUNT');

    -- Close Logs
    PKG_UTILS.LOG_END_DETAIL(PI_PROGR_H,
                             VL_PROGR_D_T048,
                             0,
                             VL_COUNT_XIN_T048,
                             VL_INS_T048,
                             VL_COUNT_XIN_T048 - VL_INS_T048);

    PO_MSG    := VL_INS_T048||'/'||VL_COUNT_XIN_T048||' Credit info loaded';
    PO_STATUS := VL_INS_T048;

  EXCEPTION
    WHEN EX_EXIT THEN

      ROLLBACK;
      VL_MESSAGE_H       := VL_MESSAGE_H || TRIM(SUBSTR(dbms_utility.format_error_backtrace() || ' ' || SQLERRM, 1, 255));
      PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                     VL_PROGR_D_T048,
                                     SQLCODE,
                                     VL_MESSAGE_H);

      PO_MSG := VL_MESSAGE_H;
      PO_STATUS := -1;

    WHEN OTHERS THEN

      ROLLBACK;
      -- Moves records from staging area to log staging area
      P_XIN_MOVE_TO_LOG(PI_PROGR_H, VL_PROGR_D_T048,'T048PARTYAMOUNT');

      VL_MESSAGE_H       := VL_MESSAGE_H || TRIM(SUBSTR(dbms_utility.format_error_backtrace() || ' ' || SQLERRM, 1, 255));
      PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                     VL_PROGR_D_T048,
                                     SQLCODE,
                                     VL_MESSAGE_H);

      PO_MSG := VL_MESSAGE_H;
      PO_STATUS := VL_STATUS;

  END LOAD_T048_CREDIT_SYG;
  
  /*============================================================================*\
  Name: LOAD_T060_PRODUCTS_SYG
      Loads SM1 table :
      • T060ARTICLE               Products master data table by division

      Staging Area (SSA) tables :
      1•  XIN_T060ARTICLE         Staging Area Table for products

      Loading logic:
      • UPDATE each record is updated if already exists.

      Validity Checks:
      • Check for mandatory fields.
      • Check for validity of data in QTABS.      

      Error handling:
      • All Errors will be logged in T852/T854 SM1 log tables.

   Input parameters :     PI_PROGR_H       - unique sm1 job number ( T800SYSTEMACTIVITYLOG )
                          PI_SESSION_ID    - unique login session (T035LOGGEDUSERS)
   Outputparameters :     PO_MSG           - message of error if procedure exit with error
                          PO_STATUS        - 0 OK; -1 Error
   Author : ravi.gopeechund.sa@everis.com
   Creation Date : 03/03/2021
   ----
  ============================================================================ */
  PROCEDURE LOAD_T060_PRODUCTS_SYG(PI_PROGR_H  IN NUMBER,
                                   PI_SESSION_ID    IN NUMBER,
                                   PO_MSG           OUT NOCOPY VARCHAR2,
                                   PO_STATUS        OUT NOCOPY NUMBER ) IS
    --
    -- Cursor on main Product table
    --
    CURSOR CL_XIN_T060 IS
      SELECT *
        FROM XIN_T060ARTICLE
       WHERE SM1_CODPROCESS = PI_PROGR_H
       ORDER BY CODART,
                CODDIV,
                SM1_DTECRE;
        
    --
    VL_MESSAGE_H   VARCHAR2(4000) := 'Error while loading PRODUCTS T06X';
    VL_MESSAGE_D   VARCHAR2(4000) := NULL;
    --
    VL_PROGR_D_T060         NUMBER := 0;
    VL_COUNT_XIN_T060       NUMBER := 0;
    VL_INS_T060             NUMBER := 0;
    --
    REC_T060      T060ARTICLE%ROWTYPE     := NULL;
    REC_T060_INIT T060ARTICLE%ROWTYPE     := NULL;
    --

    VL_STATUS   NUMBER:= 0;
    VL_COUNT    NUMBER:= 0;
    VL_STEP     NUMBER:= 0;
    --
    EX_EXIT  EXCEPTION;

  BEGIN

    -- Rebuild indexes and compute statistics
    P_XIN_INIT_INDEXES (PI_PROGR_H, 'T060ARTICLE');
    -- Clean up older log
    P_XIN_CLEANUP_LOG (PI_PROGR_H, 'T060ARTICLE');
    --

    VL_PROGR_D_T060 := PKG_UTILS.LOG_NEW_DETAIL(PI_PROGR_H,
                                                'PRODUCTS HEAD',
                                                'IMPORT --> Products for SYG division',
                                                0,
                                                NULL);

    -- --------------------------------------------------------------
    -- Identifies Xin records to be loaded
    -- --------------------------------------------------------------
    BEGIN
      
      UPDATE XIN_T060ARTICLE
         SET SM1_CODPROCESS = PI_PROGR_H,
             SM1_STATUS = 0,
             SM1_DTEPROCESS = XSYSDATE
       WHERE SM1_CODPROCESS = C_SM1_NULL_CODPROCESS
         AND CODDIV = 'SYG';
          
      VL_COUNT_XIN_T060 := SQL%ROWCOUNT;
      COMMIT;
      
    EXCEPTION
      WHEN OTHERS THEN
        ROLLBACK;
        VL_MESSAGE_H := 'Error while Reading Staging area: ' || TRIM(SUBSTR(dbms_utility.format_error_backtrace() || ' ' || SQLERRM, 1, 255));
        RAISE EX_EXIT;
    END;

    -- --------------------------------------------------------------
    -- loop in main table XIN_T060ARTICLE
    -- --------------------------------------------------------------
    FOR RL_XIN_T060 IN CL_XIN_T060 LOOP
      -- pings to t035 every 1000 cicles--
      VL_STEP := VL_STEP + 1;
      IF ( MOD(VL_STEP, 1000) = 0 ) THEN
         PKG_UTILS.user_ping(PI_SESSION_ID);
      END IF;

      --
      VL_STATUS := 0;
      --
      VL_MESSAGE_H := 'Product: '||RL_XIN_T060.CODART || '/' || RL_XIN_T060.CODDIV  || ' ' || 'Format Conversion => ';
      --
      BEGIN
        
        REC_T060 := REC_T060_INIT;
        
        -- 1. Check and log error if Product code is null
        IF (RL_XIN_T060.CODART IS NULL) THEN
          VL_STATUS := -1;
          VL_MESSAGE_H := VL_MESSAGE_H || ' / ' || 'Product code (CODART) is mandatory';
        END IF;
        
        -- 2. Check and log error if Divison code is null
        IF (RL_XIN_T060.CODDIV IS NULL) THEN
          VL_STATUS := -1;
          VL_MESSAGE_H := VL_MESSAGE_H || ' / ' || 'Divison code (CODDIV) is mandatory';
        END IF;
        
        -- 3. Check and log error if Product description is null
        IF (RL_XIN_T060.DESART IS NULL) THEN
          VL_STATUS := -1;
          VL_MESSAGE_H := VL_MESSAGE_H || ' / ' || 'Product description (DESART) is mandatory';
        END IF;
        
        -- 4. Check and log error if Primary order unit of measure is null
        IF (RL_XIN_T060.UMORD1 IS NULL) THEN
          VL_STATUS := -1;
          VL_MESSAGE_H := VL_MESSAGE_H || ' / ' || 'Primary order unit of measure (UMORD1) is mandatory';
        END IF;
        
        -- 5. Check if CODCATMER is valid in SM1
        IF (VL_STATUS = 0 AND RL_XIN_T060.CODCATMER IS NOT NULL) THEN
          CHECK_VALIDITY_IN_QTABS(PI_CODDIV    => RL_XIN_T060.CODDIV,
                                  PI_DATA_NAME => 'CATME',
                                  PI_DATA      => RL_XIN_T060.CODCATMER,
                                  PO_STATUS    => VL_STATUS,
                                  PO_MESSAGE   => VL_MESSAGE_D);
          VL_MESSAGE_H := VL_MESSAGE_H || ' / ' || VL_MESSAGE_D;
        END IF;

        -- 6. Check if CODBRAND is valid in SM1
        IF (VL_STATUS = 0 AND RL_XIN_T060.CODBRAND IS NOT NULL) THEN
          CHECK_VALIDITY_IN_QTABS(PI_CODDIV    => RL_XIN_T060.CODDIV,
                                  PI_DATA_NAME => 'BRAND',
                                  PI_DATA      => RL_XIN_T060.CODBRAND,
                                  PO_STATUS    => VL_STATUS,
                                  PO_MESSAGE   => VL_MESSAGE_D);
          VL_MESSAGE_H := VL_MESSAGE_H || ' / ' || VL_MESSAGE_D;
        END IF;

        -- 7. Check if CODFRMT is valid in SM1
        IF (VL_STATUS = 0 AND RL_XIN_T060.CODFRMT IS NOT NULL) THEN
          CHECK_VALIDITY_IN_QTABS(PI_CODDIV    => RL_XIN_T060.CODDIV,
                                  PI_DATA_NAME => 'FRMT',
                                  PI_DATA      => RL_XIN_T060.CODFRMT,
                                  PO_STATUS    => VL_STATUS,
                                  PO_MESSAGE   => VL_MESSAGE_D);
          VL_MESSAGE_H := VL_MESSAGE_H || ' / ' || VL_MESSAGE_D;
        END IF;
        
        -- 8. Check if UMVOLUME is valid in SM1
        IF (VL_STATUS = 0 AND RL_XIN_T060.UMVOLUME IS NOT NULL) THEN
          CHECK_VALIDITY_IN_QTABS(PI_CODDIV    => RL_XIN_T060.CODDIV,
                                  PI_DATA_NAME => 'UMART',
                                  PI_DATA      => RL_XIN_T060.UMVOLUME,
                                  PO_STATUS    => VL_STATUS,
                                  PO_MESSAGE   => VL_MESSAGE_D);
          VL_MESSAGE_H := VL_MESSAGE_H || ' / ' || VL_MESSAGE_D;
        END IF;
        
        -- 8. Check if UMORD1 is valid in SM1
        IF (VL_STATUS = 0 AND RL_XIN_T060.UMORD1 IS NOT NULL) THEN
          CHECK_VALIDITY_IN_QTABS(PI_CODDIV    => RL_XIN_T060.CODDIV,
                                  PI_DATA_NAME => 'UMART',
                                  PI_DATA      => RL_XIN_T060.UMORD1,
                                  PO_STATUS    => VL_STATUS,
                                  PO_MESSAGE   => VL_MESSAGE_D);
          VL_MESSAGE_H := VL_MESSAGE_H || ' / ' || VL_MESSAGE_D;
        END IF;
        
        VL_MESSAGE_D := '';
        
        IF (VL_STATUS = 0) THEN
          --
          REC_T060.CODART         := GET_PRODUCT_CODE(RL_XIN_T060.CODDIV,RL_XIN_T060.CODART);
          REC_T060.CODDIV         := RL_XIN_T060.CODDIV;
          REC_T060.DESART         := RL_XIN_T060.DESART;
          REC_T060.DESART2        := RL_XIN_T060.DESART2;
          REC_T060.CODEAN13       := RL_XIN_T060.CODEAN13;
          REC_T060.CODCATMER      := RL_XIN_T060.CODCATMER;
          REC_T060.CODBRAND       := RL_XIN_T060.CODBRAND;
          REC_T060.CODFRMT        := RL_XIN_T060.CODFRMT;
          REC_T060.VALHEIGHT      := RL_XIN_T060.VALHEIGHT;
          REC_T060.VALWIDTH       := RL_XIN_T060.VALWIDTH;
          REC_T060.VALDEPTH       := RL_XIN_T060.VALDEPTH;
          REC_T060.VALVOLUME      := RL_XIN_T060.VALVOLUME;
          REC_T060.UMVOLUME       := RL_XIN_T060.UMVOLUME;
          REC_T060.UMORD1         := RL_XIN_T060.UMORD1;
          REC_T060.CODSTATUS      := NVL(RL_XIN_T060.CODSTATUS,0);
          REC_T060.NUMSHELFLIFE   := RL_XIN_T060.NUMSHELFLIFE;
          --- Technical fields
          REC_T060.DTECRE         := XSYSDATE;
          REC_T060.CODUSRMOD      := C_SYSUSR;
          REC_T060.CODUSRMODREAL  := C_SYSUSR;
          REC_T060.CODUSRCREREAL  := C_SYSUSR;
          REC_T060.DTEMOD         := XSYSDATE;
          -- Workflow fields
          REC_T060.IDWFSTATE      := 4;
          REC_T060.IDWFMODEL      := 60;
          REC_T060.CODWFSTATEHARD := 'BOZ';
          -- Lock fields
          REC_T060.CODUSRLCK     := C_SYSUSR;
          REC_T060.IDSESSIONLCK  := PI_SESSION_ID;
          REC_T060.DTELCK        := XSYSDATE;
          -- DocumentKey
          REC_T060.DOCUMENTKEY   := PKG_UTILS.documentkey_for_t060(REC_T060.CODART, REC_T060.CODDIV);
        END IF;
        
        IF (VL_STATUS <> 0 ) THEN
          VL_MESSAGE_H := SUBSTR(VL_MESSAGE_H || ' ' || VL_MESSAGE_D,1,4000);
          PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                         VL_PROGR_D_T060,
                                         SQLCODE,
                                         VL_MESSAGE_H);
        END IF;

        IF (VL_STATUS = 0) THEN
          
          -- when status <> 0 some fields have incorrect format. Log t800 has been already wrote by F_CHECK function
          -- Update article if already exists
          VL_MESSAGE_D := 'Update T060article ';

          UPDATE T060ARTICLE
             SET CODART       = GET_PRODUCT_CODE(REC_T060.CODDIV,REC_T060.CODART),
                 CODDIV       = REC_T060.CODDIV,
                 DESART       = REC_T060.DESART,
                 DESART2      = REC_T060.DESART2,
                 CODEAN13     = REC_T060.CODEAN13,
                 CODCATMER    = REC_T060.CODCATMER,
                 CODBRAND     = REC_T060.CODBRAND,
                 CODFRMT      = REC_T060.CODFRMT,
                 VALHEIGHT    = REC_T060.VALHEIGHT,
                 VALWIDTH     = REC_T060.VALWIDTH,
                 VALDEPTH     = REC_T060.VALDEPTH,
                 VALVOLUME    = REC_T060.VALVOLUME,
                 UMVOLUME     = REC_T060.UMVOLUME,
                 UMORD1       = REC_T060.UMORD1,
                 NUMSHELFLIFE = REC_T060.NUMSHELFLIFE,
                 --- Technical fields
                 CODUSRMOD    = REC_T060.CODUSRMOD,
                 DTEMOD       = REC_T060.DTEMOD,
                 -- lock fields
                 CODUSRLCK    = REC_T060.CODUSRLCK,
                 IDSESSIONLCK = REC_T060.IDSESSIONLCK,
                 DTELCK       = REC_T060.DTELCK
           WHERE CODART = GET_PRODUCT_CODE(REC_T060.CODDIV,REC_T060.CODART) 
             AND CODDIV = REC_T060.CODDIV
             AND NOT EXISTS (SELECT NULL 
                               FROM T035LOGGEDUSERS T035 
                              WHERE T035.IDSESSION = NVL(IDSESSIONLCK, '@') 
                               AND T035.LASTCHECK > TRUNC(XSYSDATE)-1 );

          IF (SQL%ROWCOUNT = 0) THEN
            VL_COUNT := 0;
            SELECT COUNT(*)
              INTO VL_COUNT
              FROM T060ARTICLE
             WHERE CODART = GET_PRODUCT_CODE(REC_T060.CODDIV,REC_T060.CODART)
               AND CODDIV   = REC_T060.CODDIV;

            IF (VL_COUNT = 0) THEN
              VL_MESSAGE_D := 'Insert T060article ';
              INSERT INTO T060ARTICLE VALUES REC_T060;
            END IF;
          END IF;

          VL_INS_T060 := VL_INS_T060 + 1;
        END IF;

      EXCEPTION 
        WHEN OTHERS THEN
          VL_STATUS := -1;
          VL_MESSAGE_H := SUBSTR(VL_MESSAGE_H||' '||VL_MESSAGE_D||' '||dbms_utility.format_error_backtrace() || ' ' || SQLERRM,1,4000);

          PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                       VL_PROGR_D_T060,
                                       SQLCODE,
                                       VL_MESSAGE_H);
      END;

      IF (VL_STATUS <> 0) THEN
        
        UPDATE XIN_T060ARTICLE
           SET SM1_STATUS = C_XINSTATUS_ERR
         WHERE CODART = GET_PRODUCT_CODE(RL_XIN_T060.CODDIV,RL_XIN_T060.CODART)
           AND CODDIV = RL_XIN_T060.CODDIV
           AND SM1_CODPROCESS = PI_PROGR_H
           AND SM1_DTECRE = RL_XIN_T060.SM1_DTECRE
           AND SM1_STATUS = C_XINSTATUS_OK;

      END IF;

      -- Release updated records
      UPDATE T060ARTICLE
         SET DTELCK = NULL,
             IDSESSIONLCK = NULL,
             CODUSRLCK = NULL
       WHERE CODART = GET_PRODUCT_CODE(REC_T060.CODDIV,REC_T060.CODART)
         AND CODDIV = REC_T060.CODDIV
         AND CODUSRLCK = C_SYSUSR
         AND IDSESSIONLCK = PI_SESSION_ID;

    END LOOP;
    COMMIT;

    -- Moves records from staging area to log staging area
    P_XIN_MOVE_TO_LOG(PI_PROGR_H,VL_PROGR_D_T060,'T060ARTICLE');

    -- Closes logs
    PKG_UTILS.LOG_END_DETAIL(PI_PROGR_H,
                             VL_PROGR_D_T060,
                             0,
                             VL_COUNT_XIN_T060,
                             VL_INS_T060,
                             VL_COUNT_XIN_T060 - VL_INS_T060);

    PO_MSG := VL_INS_T060||' products loaded';
    PO_STATUS :=VL_INS_T060;

  EXCEPTION
    WHEN EX_EXIT THEN

      ROLLBACK;
      VL_MESSAGE_H       := VL_MESSAGE_H || TRIM(SUBSTR(dbms_utility.format_error_backtrace() || ' ' || SQLERRM, 1, 255));
      PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                              VL_PROGR_D_T060,
                                              SQLCODE,
                                              VL_MESSAGE_H);

      PO_MSG := VL_MESSAGE_H;
      PO_STATUS := -1;

    WHEN OTHERS THEN

      ROLLBACK;
      -- Release updated records
      UPDATE T060ARTICLE
         SET DTELCK          = NULL,
             IDSESSIONLCK    = NULL,
             CODUSRLCK       = NULL
       WHERE CODUSRLCK = C_SYSUSR 
         AND IDSESSIONLCK = PI_SESSION_ID;
      COMMIT;

      -- Moves records from staging area to log staging area
      P_XIN_MOVE_TO_LOG(PI_PROGR_H, VL_PROGR_D_T060, 'T060ARTICLE');

      VL_MESSAGE_H       := VL_MESSAGE_H || TRIM(SUBSTR(dbms_utility.format_error_backtrace() || ' ' || SQLERRM, 1, 255));
      PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                     VL_PROGR_D_T060,
                                     SQLCODE,
                                     VL_MESSAGE_H);

      PO_MSG := VL_MESSAGE_H;
      PO_STATUS := VL_STATUS;

  END LOAD_T060_PRODUCTS_SYG;
  
  /*============================================================================*\
  Name: LOAD_T062_PRODUCTSUOM_SYG
      Loads SM1 table :
      • T062UMCONV               Products units of mesaure data table by division

      Staging Area (SSA) tables :
      1•  XIN_T062UMCONV         Staging Area Table for products units of measure

      Loading logic:
      • UPDATE each record is updated if already exists.

      Validity Checks:
      • Check for mandatory fields.
      • Check for validity of data in QTABS.      

      Error handling:
      • All Errors will be logged in T852/T854 SM1 log tables.

   Input parameters :     PI_PROGR_H       - unique sm1 job number ( T800SYSTEMACTIVITYLOG )
                          PI_SESSION_ID    - unique login session (T035LOGGEDUSERS)
   Outputparameters :     PO_MSG           - message of error if procedure exit with error
                          PO_STATUS        - 0 OK; -1 Error
   Author : ravi.gopeechund.sa@everis.com
   Creation Date : 03/03/2021
   ----
  ============================================================================ */
  PROCEDURE LOAD_T062_PRODUCTSUOM_SYG(PI_PROGR_H    IN NUMBER,
                                      PI_SESSION_ID IN NUMBER,
                                      PO_MSG        OUT NOCOPY VARCHAR2,
                                      PO_STATUS     OUT NOCOPY NUMBER) IS
    --
    -- Unit Measure
    --
    CURSOR CL_XIN_T062 IS
      SELECT *
        FROM XIN_T062UMCONV
       WHERE SM1_CODPROCESS = PI_PROGR_H
         AND SM1_STATUS = C_XINSTATUS_OK
       ORDER BY SM1_DTECRE;

    --
    VL_MESSAGE_H VARCHAR2(4000) := 'Error while loading PRODUCTS T06X';
    VL_MESSAGE_D VARCHAR2(4000) := NULL;
    --
    VL_PROGR_D_T062   NUMBER := 0;
    VL_COUNT_XIN_T062 NUMBER := 0;
    VL_INS_T062       NUMBER := 0;
    --
    REC_T062      T062UMCONV%ROWTYPE := NULL;
    REC_T062_INIT T062UMCONV%ROWTYPE := NULL;
    --
    VL_STATUS NUMBER := 0;
    VL_STEP     NUMBER := 0; -- Used to ping t035
    --
    EX_EXIT EXCEPTION;

  BEGIN

    -- Rebuild indexes and compute statistics
    P_XIN_INIT_INDEXES(PI_PROGR_H, 'T062UMCONV');
    -- Clean up older log
    P_XIN_CLEANUP_LOG(PI_PROGR_H, 'T062UMCONV');
    --
    VL_PROGR_D_T062 := PKG_UTILS.LOG_NEW_DETAIL(PI_PROGR_H,
                                                'UNIT OF MEASURE',
                                                'IMPORT --> Products unit of measure for SYG division',
                                                0,
                                                NULL);

    -- --------------------------------------------------------------
    -- Identifies Xin records to be loaded
    -- --------------------------------------------------------------
    BEGIN
    
      UPDATE XIN_T062UMCONV D
         SET D.SM1_CODPROCESS = PI_PROGR_H,
             D.SM1_STATUS     = 0,
             D.SM1_DTEPROCESS = XSYSDATE
       WHERE SM1_CODPROCESS = C_SM1_NULL_CODPROCESS
         AND CODDIV = 'SYG';
      COMMIT;
      
    EXCEPTION
      WHEN OTHERS THEN
        ROLLBACK;
        VL_MESSAGE_H := 'Error while Reading Staging area: XIN_T062UMCONV' || TRIM(SUBSTR(dbms_utility.format_error_backtrace() || ' ' || SQLERRM, 1, 255));
        RAISE EX_EXIT;
    END;

    FOR RL_XIN_T062 IN CL_XIN_T062 LOOP
   
      -- pings to t035 every 1000 cicles--
      VL_STEP := VL_STEP + 1;
      IF (MOD(VL_STEP, 1000) = 0) THEN
        PKG_UTILS.user_ping(PI_SESSION_ID);
      END IF;
    
      VL_STATUS    := 0;
      VL_MESSAGE_H := 'Measure Unit: ' || RL_XIN_T062.CODART || ' ' ||
                      RL_XIN_T062.CODDIV || ' ' || RL_XIN_T062.UMFROM || ' ' ||
                      RL_XIN_T062.UMTO || ' ' || 'Format Conversion => ';
      
      BEGIN
              
        -- 1. Check and log error if Product code is null
        IF (RL_XIN_T062.CODART IS NULL) THEN
          VL_STATUS := -1;
          VL_MESSAGE_H := VL_MESSAGE_H || ' / ' || 'Product code (CODART) is mandatory';
        END IF;
        
        -- 2. Check and log error if Divison code is null
        IF (RL_XIN_T062.CODDIV IS NULL) THEN
          VL_STATUS := -1;
          VL_MESSAGE_H := VL_MESSAGE_H || ' / ' || 'Divison code (CODDIV) is mandatory';
        END IF;
        
        -- 3. Check and log error if From unit of measure is null
        IF (RL_XIN_T062.UMFROM IS NULL) THEN
          VL_STATUS := -1;
          VL_MESSAGE_H := VL_MESSAGE_H || ' / ' || 'From unit of measure (UMFROM) is mandatory';
        END IF;
        
        -- 4. Check and log error if To unit of measure is null
        IF (RL_XIN_T062.UMTO IS NULL) THEN
          VL_STATUS := -1;
          VL_MESSAGE_H := VL_MESSAGE_H || ' / ' || 'To unit of measure (UMTO) is mandatory';
        END IF;
        
        -- 5. Check and log error if Conversion factor is null
        IF (RL_XIN_T062.VALCONVFACT IS NULL) THEN
          VL_STATUS := -1;
          VL_MESSAGE_H := VL_MESSAGE_H || ' / ' || 'Conversion factor (VALCONVFACT) is mandatory';
        END IF;
        
        -- 6. Check and log error if Reverse conversion factor is null
        IF (RL_XIN_T062.VALCONVFACTREV IS NULL) THEN
          VL_STATUS := -1;
          VL_MESSAGE_H := VL_MESSAGE_H || ' / ' || 'Reverse conversion factor (VALCONVFACTREV) is mandatory';
        END IF;

        -- 7. Check if UMFROM is valid in SM1
        IF (VL_STATUS = 0 AND RL_XIN_T062.UMFROM IS NOT NULL) THEN
          CHECK_VALIDITY_IN_QTABS(PI_CODDIV    => RL_XIN_T062.CODDIV,
                                  PI_DATA_NAME => 'UMART',
                                  PI_DATA      => RL_XIN_T062.UMFROM,
                                  PO_STATUS    => VL_STATUS,
                                  PO_MESSAGE   => VL_MESSAGE_D);
          VL_MESSAGE_H := VL_MESSAGE_H || ' / ' || VL_MESSAGE_D;
        END IF;
        
        -- 8. Check if UMTO is valid in SM1
        IF (VL_STATUS = 0 AND RL_XIN_T062.UMTO IS NOT NULL) THEN
          CHECK_VALIDITY_IN_QTABS(PI_CODDIV    => RL_XIN_T062.CODDIV,
                                  PI_DATA_NAME => 'UMART',
                                  PI_DATA      => RL_XIN_T062.UMTO,
                                  PO_STATUS    => VL_STATUS,
                                  PO_MESSAGE   => VL_MESSAGE_D);
          VL_MESSAGE_H := VL_MESSAGE_H || ' / ' || VL_MESSAGE_D;
        END IF;
        
        IF (VL_STATUS = 0) THEN
          REC_T062     := REC_T062_INIT;
          --
          REC_T062.CODART         := GET_PRODUCT_CODE(RL_XIN_T062.CODDIV,RL_XIN_T062.CODART);
          REC_T062.CODDIV         := RL_XIN_T062.CODDIV;
          REC_T062.UMFROM         := RL_XIN_T062.UMFROM;
          REC_T062.UMTO           := RL_XIN_T062.UMTO;
          ---
          REC_T062.VALCONVFACT    := NVL(RL_XIN_T062.VALCONVFACT, 1);
          REC_T062.VALCONVFACTREV := CASE 
                                       WHEN RL_XIN_T062.VALCONVFACTREV IS NULL THEN
                                         CASE 
                                           WHEN NVL(REC_T062.VALCONVFACT,0) <> 0 THEN 
                                             1/REC_T062.VALCONVFACT
                                            ELSE 1
                                         END
                                       ELSE 
                                         RL_XIN_T062.VALCONVFACTREV
                                     END;
          REC_T062.CODEAN11        := RL_XIN_T062.CODEAN11;

          IF (REC_T062.VALCONVFACT = 0 OR REC_T062.VALCONVFACTREV = 0) THEN
            VL_MESSAGE_D := ' Conversion Factor is 0. Record will be discarded ';
            VL_STATUS  := -1;
          END IF;
        END IF;
      
        IF (VL_STATUS = 0) THEN
        
          BEGIN
            VL_MESSAGE_D := 'Insert T062 ';
            INSERT INTO T062UMCONV VALUES REC_T062;
          EXCEPTION
            WHEN DUP_VAL_ON_INDEX THEN
              --- Case where the same conversion is present twice ( e.g. records come from sap package)
              UPDATE T062UMCONV t
                 SET T.UMTO           = REC_T062.UMTO,
                     T.VALCONVFACT    = REC_T062.VALCONVFACT,
                     T.VALCONVFACTREV = REC_T062.VALCONVFACTREV,
                     T.CODEAN11       = REC_T062.CODEAN11
               WHERE T.CODART = GET_PRODUCT_CODE(REC_T062.CODDIV,REC_T062.CODART)
                 AND T.CODDIV = REC_T062.CODDIV
                 AND T.UMFROM = REC_T062.UMFROM;
          END;
          VL_INS_T062 := VL_INS_T062 + 1;
        
        ELSE
          VL_MESSAGE_H := SUBSTR(VL_MESSAGE_H,1,4000);
          PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                         VL_PROGR_D_T062,
                                         SQLCODE,
                                         VL_MESSAGE_H);
        END IF;
      EXCEPTION
        WHEN OTHERS THEN
          VL_STATUS  := -1;
          VL_MESSAGE_H := SUBSTR(VL_MESSAGE_H || ' ' || VL_MESSAGE_D || ' ' ||
                                 dbms_utility.format_error_backtrace() || ' ' ||
                                 SQLERRM,
                                 1,
                                 4000);
        
          PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                         VL_PROGR_D_T062,
                                         SQLCODE,
                                         VL_MESSAGE_H);
      END;
      
      IF VL_STATUS <> 0 THEN
              
        UPDATE XIN_T062UMCONV T
           SET SM1_STATUS = C_XINSTATUS_ERR
         WHERE T.CODART = GET_PRODUCT_CODE(REC_T062.CODDIV,REC_T062.CODART)
           AND T.CODDIV = REC_T062.CODDIV
           AND T.UMFROM = REC_T062.UMFROM
           AND T.UMTO = REC_T062.UMTO
           AND T.SM1_STATUS = C_XINSTATUS_OK
           AND T.SM1_CODPROCESS = PI_PROGR_H;
      
      END IF;
    END LOOP;
    COMMIT;

    -- Moves records from staging area to log staging area
    P_XIN_MOVE_TO_LOG(PI_PROGR_H, VL_PROGR_D_T062, 'T062UMCONV');

    -- Closes logs
    PKG_UTILS.LOG_END_DETAIL(PI_PROGR_H,
                             VL_PROGR_D_T062,
                             0,
                             VL_COUNT_XIN_T062,
                             VL_INS_T062,
                             VL_COUNT_XIN_T062 - VL_INS_T062);

    PO_MSG    := VL_INS_T062 || ' products unit of measure loaded';
    PO_STATUS := VL_INS_T062;

  EXCEPTION
    WHEN EX_EXIT THEN
    
      ROLLBACK;
      VL_MESSAGE_H := VL_MESSAGE_H || TRIM(SUBSTR(dbms_utility.format_error_backtrace() || ' ' ||
                                                  SQLERRM,
                                                  1,
                                                  255));
      PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                     VL_PROGR_D_T062,
                                     SQLCODE,
                                     VL_MESSAGE_H);
    
      PO_MSG    := VL_MESSAGE_H;
      PO_STATUS := -1;
    
    WHEN OTHERS THEN
    
      ROLLBACK;
      UPDATE T060ARTICLE
         SET DTELCK = NULL, IDSESSIONLCK = NULL, CODUSRLCK = NULL
       WHERE CODUSRLCK = C_SYSUSR
         AND IDSESSIONLCK = PI_SESSION_ID;
      COMMIT;
      
      -- Moves records from staging area to log staging area
      P_XIN_MOVE_TO_LOG(PI_PROGR_H, VL_PROGR_D_T062, 'T062UMCONV');
    
      VL_MESSAGE_H := VL_MESSAGE_H || TRIM(SUBSTR(dbms_utility.format_error_backtrace() || ' ' ||
                                                  SQLERRM,
                                                  1,
                                                  255));
      PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                     VL_PROGR_D_T062,
                                     SQLCODE,
                                     VL_MESSAGE_H);
    
      PO_MSG    := VL_MESSAGE_H;
      PO_STATUS := VL_STATUS;
    
  END LOAD_T062_PRODUCTSUOM_SYG;

  /*============================================================================*\
    Name: LOAD_T100_ORDERS_50_SYG
    
    Loads SM1 tables:
        • T100ORDHEAD- Order Head
        • T106ORDROW  - Order Row
        
    Staging Area (SSA) tables, Chronological Order expected in SSA (for each decode set):
        1.  XIN_T100ORDHEAD
        2.  XIN_T106ORDROW

    Loading logic:
      UPDATE+INSERT
      Steps:
      
       1- Recognize SM1 order from external order SAP
           XIN_T100.NUMORDREF not null : it is a SM1 Order
           XIN_T100.NUMORDREF is null : it is an external Order
          then it must be populated:
               XIN_T100.NUMORDHOST : order unique code from erp
               XIN_T100.CODUSR : erp dummy user "SAP"

       2- assign new NUMORD to external order SAP/JDE/Others ( da contatore T011 ORDPRGNUM o ORDPRGNUM_<ERP>)
       3- row matching (logically cancel the no more present  - add new rows -- determine new numrow)
       4- determine row status from quantities (backorder-delivered-cancelled)----
       5- detrmine head status from row status
       6- calculate header quantities

     Validity Checks:
        • Orders found on staging area are loaded to SM1 main tables only if they are not already opened for update by a SM1 user. In that case records remain in staging area ready to be loaded on next import run.
        • Detail Records found on XIN_T106ORDROW are loaded only if there is the head record in XIN_T100ORDHEAD.

     Error handling:
        • All Errors will be logged in T852/T854 SM1 log tables and all staging area records will be stored into staging area log with sm1_status = 9.
        • Error on head record,  it is discarded with all its details.
        • Error on detail record, it is discarded and import procedure skips to next detail.

     How to delete
        • You cannot delete an order by  ERP interface, you can set it to CANCELLED status

     Input parameters :     PI_PROGR_H       - unique sm1 job number ( T800SYSTEMACTIVITYLOG )
                            PI_SESSION_ID    - unique login session (T035LOGGEDUSERS)

     Outputparameters :     PO_MSG           - message of error if procedure exit with error
                            PO_STATUS        - 0 OK; -1 Error
   Author : ravi.gopeechund.sa@everis.com
   Creation Date : 03/03/2021
   ----
  ============================================================================ */
  PROCEDURE LOAD_T100_ORDERS_50_SYG(PI_PROGR_H       IN NUMBER,
                                    PI_SESSION_ID    IN NUMBER,
                                    PO_MSG           OUT NOCOPY VARCHAR2,
                                    PO_STATUS        OUT NOCOPY NUMBER ) IS

    -- -----------------------------------------
    -- Cursor on Orde Heads xin_t100ordhead
    -- -----------------------------------------
    CURSOR CL_XIN_T100 IS
      SELECT *
        FROM XIN_T100ORDHEAD
       WHERE SM1_CODPROCESS = PI_PROGR_H
       ORDER BY NUMORDHOST, SM1_DTECRE;
    -- -----------------------------------------
    -- Cursor on Order Rows xin_t106_ordrow
    -- -----------------------------------------
    CURSOR CL_XIN_T106(CI_NUMORD VARCHAR2) IS
      SELECT ORDROW.*, T.Codwhs AS VANWHS
        FROM XIN_T106ORDROW ORDROW
       INNER JOIN T100ORDHEAD T
          ON ORDROW.NUMORD = T.NUMORD
       WHERE ORDROW.NUMORD = CI_NUMORD
         AND ORDROW.SM1_CODPROCESS = PI_PROGR_H
         AND ORDROW.SM1_STATUS = C_XINSTATUS_OK
       ORDER BY ORDROW.NUMROW;

    --
    VL_MESSAGE_H   VARCHAR2(4000) := 'Error while loading Orders T100/T106';
    VL_MESSAGE_D   VARCHAR2(4000) := NULL;
    --
    VL_PROGR_D_T100    NUMBER := 0;
    VL_COUNT_XIN_T100  NUMBER := 0;
    VL_INS_T100        NUMBER := 0;
    --
    VL_PROGR_D_T106    NUMBER := 0;
    VL_COUNT_XIN_T106  NUMBER := 0;
    VL_INS_T106        NUMBER := 0;
    --
    REC_T100      T100ORDHEAD%ROWTYPE := NULL;
    REC_T100_INIT T100ORDHEAD%ROWTYPE := NULL;
    REC_T106      T106ORDROW%ROWTYPE := NULL;
    REC_T106_INIT T106ORDROW%ROWTYPE := NULL;
    --
    VL_DES_T100     X_FIELD_INFO_ARRAY;
    VL_DES_T106     X_FIELD_INFO_ARRAY;
    --
    VL_RECORD_LOCKED NUMBER := 0;

    VL_STATUS NUMBER:= 0;
    VL_STEP   NUMBER:= 0; -- Used to ping t035
    --
    EX_EXIT  EXCEPTION;
    --
    VL_CODDIV VARCHAR2(30) := NULL;
    vl_ins_upd VARCHAR2(3) := NULL;

  BEGIN

    -- init indexes and rebuild statistics
    P_XIN_INIT_INDEXES (PI_PROGR_H, 'T100ORDHEAD');
    P_XIN_INIT_INDEXES (PI_PROGR_H, 'T106ORDROW');
    -- clean log
    P_XIN_CLEANUP_LOG (PI_PROGR_H, 'T100ORDHEAD');
    P_XIN_CLEANUP_LOG (PI_PROGR_H, 'T106ORDROW');

    VL_PROGR_D_T100 := PKG_UTILS.LOG_NEW_DETAIL(PI_PROGR_H,
                                       'ORDER HEAD',
                                       'IMPORT --> Vanload orders for SYG division (Order type=50)',
                                        0,
                                        NULL);
    VL_PROGR_D_T106 := PKG_UTILS.LOG_NEW_DETAIL(PI_PROGR_H,
                                       'ORDER ROWS',
                                       'IMPORT --> Vanload orders for SYG division (Order type=50)',
                                        0,
                                        NULL);

    -- retrieves configuration parameters
    LOAD_T10X_CONF_STEP0(VL_MESSAGE_H, VL_STATUS);

    IF (vl_status <> 0 ) THEN
      PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                    VL_PROGR_D_T100,
                                    SQLCODE,
                                    VL_MESSAGE_H);

      RAISE EX_EXIT;
    END IF;
    BEGIN

      --
      -- ----------------------------------------------------------
      -- Init arrays with FIELD_NAME=LENGTH and FIELDNAME=SM1_DEFAULT for all fields of table
      -- ----------------------------------------------------------
      VL_DES_T100.DELETE;
      P_INIT_SM1_FIELD_ARRAY ('T100ORDHEAD', VL_DES_T100, VL_STATUS, VL_MESSAGE_H);
      EXECUTE IMMEDIATE (GL_INIT_REC) INTO REC_T100_INIT;

      VL_DES_T106.DELETE;
      P_INIT_SM1_FIELD_ARRAY ('T106ORDROW', VL_DES_T106, VL_STATUS, VL_MESSAGE_H);
      EXECUTE IMMEDIATE (GL_INIT_REC) INTO REC_T106_INIT;

      IF (VL_STATUS <> 0) THEN
        VL_MESSAGE_D := GL_INIT_REC;
        RAISE EX_EXIT;
      END IF;
        
    EXCEPTION
      WHEN OTHERS THEN
        VL_MESSAGE_D := GL_INIT_REC;
        RAISE EX_EXIT;
    END;

    -- --------------------------------------------------------------
    -- Identifies Xin records to be loaded
    -- --------------------------------------------------------------
    BEGIN
      
      VL_MESSAGE_D := 'XIN_T100ORDHEAD';
      UPDATE XIN_T100ORDHEAD
         SET SM1_CODPROCESS = PI_PROGR_H,
             SM1_STATUS     = 0,
             SM1_DTEPROCESS = XSYSDATE
       WHERE NVL(SM1_CODPROCESS, 0) = C_SM1_NULL_CODPROCESS
         AND CODDIV = 'SYG'
         AND CODTYPORD = '50';
      VL_COUNT_XIN_T100 := SQL%ROWCOUNT;

      VL_MESSAGE_D := 'XIN_T106ORDROW';
      UPDATE XIN_T106ORDROW D
         SET D.SM1_CODPROCESS = PI_PROGR_H,
             D.SM1_STATUS     = 0,
             D.SM1_DTEPROCESS = XSYSDATE
       WHERE NVL(D.SM1_CODPROCESS, 0) = C_SM1_NULL_CODPROCESS
         AND D.NUMORD IN (SELECT H.NUMORD
                            FROM XIN_T100ORDHEAD H
                           WHERE H.SM1_CODPROCESS = PI_PROGR_H
                             AND CODDIV = 'SYG'
                             AND CODTYPORD = '50');
      VL_COUNT_XIN_T106 := SQL%ROWCOUNT;
      COMMIT;

    EXCEPTION
      WHEN OTHERS THEN
        ROLLBACK;
        VL_MESSAGE_H := 'Error while Reading Staging area: ' || VL_MESSAGE_D || TRIM(SUBSTR(dbms_utility.format_error_backtrace() || ' ' || SQLERRM, 1, 255));
        RAISE EX_EXIT;

    END;

    -- --------------------------------------------------------------
    -- loop in main table T100ORDHEAD
    -- --------------------------------------------------------------
    FOR RL_XIN_T100 IN CL_XIN_T100 LOOP
      
      -- pings to t035 every 100 cicles--
      VL_STEP := VL_STEP + 1;
      IF ( MOD(VL_STEP, 100) = 0 ) THEN
         PKG_UTILS.user_ping(PI_SESSION_ID);
      END IF;

      --
      VL_STATUS := 0;
      VL_MESSAGE_H := 'Order NumordHost : ' || RL_XIN_T100.NUMORDHOST || ' Format Conversion => ';
      VL_MESSAGE_D := '';
      --
      BEGIN

        -- Data Format Check
        VL_CODDIV := 'ALL';
        REC_T100 := REC_T100_INIT;
        
        -- 1. Check and log error if Order number is null
        IF (RL_XIN_T100.NUMORD IS NULL) THEN
          VL_STATUS := -1;
          VL_MESSAGE_H := VL_MESSAGE_H || ' / ' || 'Order number (NUMORD) is mandatory';
        END IF;
        
        -- 2. Check and log error if User code is null
        IF (RL_XIN_T100.CODUSR IS NULL) THEN
          VL_STATUS := -1;
          VL_MESSAGE_H := VL_MESSAGE_H || ' / ' || 'User code (CODUSR) is mandatory';
        END IF;

        -- 3. Check and log error if Order type is null
        IF (RL_XIN_T100.CODTYPORD IS NULL) THEN
          VL_STATUS := -1;
          VL_MESSAGE_H := VL_MESSAGE_H || ' / ' || 'Order type (CODTYPORD) is mandatory';
        END IF;
        
        -- 4. Check and log error if Division code is null
        IF (RL_XIN_T100.CODDIV IS NULL) THEN
          VL_STATUS := -1;
          VL_MESSAGE_H := VL_MESSAGE_H || ' / ' || 'Division code (CODDIV) is mandatory';
        END IF;
        
        -- 5. Check and log error if Order date is null
        IF (RL_XIN_T100.DTEORD IS NULL) THEN
          VL_STATUS := -1;
          VL_MESSAGE_H := VL_MESSAGE_H || ' / ' || 'Order date (DTEORD) is mandatory';
        END IF;
        
        -- 6. Check and log error if Order delivery date is null
        IF (RL_XIN_T100.DTEDELIV IS NULL) THEN
          VL_STATUS := -1;
          VL_MESSAGE_H := VL_MESSAGE_H || ' / ' || 'Order delivery date (DTEDELIV) is mandatory';
        END IF;
        
        -- 7. Check and log error if Delivery customer code is null
        IF (RL_XIN_T100.CODCUSTDELIV IS NULL) THEN
          VL_STATUS := -1;
          VL_MESSAGE_H := VL_MESSAGE_H || ' / ' || 'Delivery customer code (CODCUSTDELIV) is mandatory';
        END IF;
        
        -- 8. Check and log error if Invoice customer code is null
        IF (RL_XIN_T100.CODCUSTINV IS NULL) THEN
          VL_STATUS := -1;
          VL_MESSAGE_H := VL_MESSAGE_H || ' / ' || 'Invoice customer code (CODCUSTINV) is mandatory';
        END IF;
        
        -- 9. Check and log error if Mobile warehouse code is null
        IF (RL_XIN_T100.CODWHS IS NULL) THEN
          VL_STATUS := -1;
          VL_MESSAGE_H := VL_MESSAGE_H || ' / ' || 'Mobile warehouse code (CODWHS) is mandatory';
        END IF;
        
        IF (VL_STATUS = 0) THEN
          REC_T100.NUMORD               := RL_XIN_T100.NUMORD;
          REC_T100.CODUSR               := RL_XIN_T100.CODUSR;
          --
          REC_T100.CODEUSR              := RL_XIN_T100.CODEUSR;
          REC_T100.CODTYPORD            := RL_XIN_T100.CODTYPORD;
          REC_T100.CODSTATUS            := RL_XIN_T100.CODSTATUS;
          REC_T100.CODDIV               := RL_XIN_T100.CODDIV;
          REC_T100.DTEORD               := TO_DATE(RL_XIN_T100.DTEORD, C_SAP_FORMAT_DATE);
          REC_T100.DTEDELIV             := TO_DATE(RL_XIN_T100.DTEDELIV, C_SAP_FORMAT_DATE);
          REC_T100.DTEEVA               := TO_DATE(RL_XIN_T100.DTEEVA, C_SAP_FORMAT_DATE);
          REC_T100.CODPAYTRM            := RL_XIN_T100.CODPAYTRM;
          REC_T100.CODPAYMOD            := RL_XIN_T100.CODPAYMOD;
          REC_T100.CODCUSTDELIV         := RL_XIN_T100.CODCUSTDELIV;
          REC_T100.CODVATMGMT           := RL_XIN_T100.CODVATMGMT;
          REC_T100.CODCUSTINV           := GET_CUSTOMER_CODE(RL_XIN_T100.CODDIV,RL_XIN_T100.CODCUSTINV);
          REC_T100.CODCUR               := RL_XIN_T100.CODCUR;
          REC_T100.NUMORDREF            := RL_XIN_T100.NUMORDREF;
          REC_T100.NUMORDHOST           := RL_XIN_T100.NUMORDHOST;
          REC_T100.NUMORDCUST           := RL_XIN_T100.NUMORDCUST;
          REC_T100.DTEORDCUST           := TO_DATE(RL_XIN_T100.DTEORDCUST, C_SAP_FORMAT_DATE);
          REC_T100.CODMODSHIP           := RL_XIN_T100.CODMODSHIP;
          REC_T100.CODAGREEMENT         := RL_XIN_T100.CODAGREEMENT;
          REC_T100.DTEAUT               := TO_DATE(RL_XIN_T100.DTEAUT, C_SAP_FORMAT_DATE);
          REC_T100.GROSSAMOUNT          := RL_XIN_T100.GROSSAMOUNT;
          REC_T100.NETAMOUNT            := RL_XIN_T100.NETAMOUNT;
          REC_T100.TAXAMOUNT            := RL_XIN_T100.TAXAMOUNT;
          REC_T100.VATAMOUNT            := RL_XIN_T100.VATAMOUNT;
          REC_T100.INCREASEAMOUNT       := RL_XIN_T100.INCREASEAMOUNT;
          REC_T100.DISCOUNTAMOUNT       := RL_XIN_T100.DISCOUNTAMOUNT;
          REC_T100.GIFTAMOUNT           := RL_XIN_T100.GIFTAMOUNT;
          REC_T100.QTYTOT               := RL_XIN_T100.QTYTOT;
          REC_T100.UMQTYTOT             := RL_XIN_T100.UMQTYTOT;
          REC_T100.FLGRETURN            := RL_XIN_T100.FLGRETURN;
          REC_T100.FLGHOSTED            := RL_XIN_T100.FLGHOSTED;
          REC_T100.FLGCONFIRMED         := RL_XIN_T100.FLGCONFIRMED;
          REC_T100.CODWHS               := RL_XIN_T100.CODWHS;
          REC_T100.DTEPRICE             := TO_DATE(RL_XIN_T100.DTEPRICE, C_SAP_FORMAT_DATE);
          REC_T100.FLGCHECKPROMO        := RL_XIN_T100.FLGCHECKPROMO;
          REC_T100.DISCOUNTAMOUNTOUTINV := RL_XIN_T100.DISCOUNTAMOUNTOUTINV;
          REC_T100.DTEDELIVTO           := TO_DATE(RL_XIN_T100.DTEDELIVTO, C_SAP_FORMAT_DATE);
          REC_T100.FLGUMORD2            := RL_XIN_T100.FLGUMORD2;
          REC_T100.NETAMOUNTTEO         := RL_XIN_T100.NETAMOUNTTEO;
          REC_T100.NETAMOUNTMIN         := RL_XIN_T100.NETAMOUNTMIN;
          REC_T100.NETAMOUNTMAX         := RL_XIN_T100.NETAMOUNTMAX;
          REC_T100.BACKAMOUNT           := RL_XIN_T100.BACKAMOUNT;
          REC_T100.TOTPALLETS           := RL_XIN_T100.TOTPALLETS;
          REC_T100.GROSSWEIGHT          := RL_XIN_T100.GROSSWEIGHT;
          REC_T100.TOTMC                := RL_XIN_T100.TOTMC;
          REC_T100.DTEPROPDELIV         := TO_DATE(RL_XIN_T100.DTEPROPDELIV, C_SAP_FORMAT_DATE);
          REC_T100.FLGPROCESSEDEDI      := RL_XIN_T100.FLGPROCESSEDEDI;
          REC_T100.FLGEDI               := RL_XIN_T100.FLGEDI;
          REC_T100.DTEDELIV2            := TO_DATE(RL_XIN_T100.DTEDELIV2, C_SAP_FORMAT_DATE);
          REC_T100.DTEDELIV3            := TO_DATE(RL_XIN_T100.DTEDELIV3, C_SAP_FORMAT_DATE);
          REC_T100.DTEDELIV4            := TO_DATE(RL_XIN_T100.DTEDELIV4, C_SAP_FORMAT_DATE);
          --
          IF (LENGTH(TRIM(TO_CHAR(RL_XIN_T100.DTECLOSE))) <> 0 AND RL_XIN_T100.DTECLOSE IS NOT NULL) THEN
            REC_T100.DTECLOSE  := TO_DATE(RL_XIN_T100.DTECLOSE, C_SAP_FORMAT_DATE);
          ELSE
            REC_T100.DTECLOSE  := F_CHECK_FORMAT_D( VL_CODDIV, TO_DATE(RL_XIN_T100.DTECLOSE, C_SAP_FORMAT_DATE),'DTECLOSE', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
          END IF;
          --
          REC_T100.FLGPROCESSEDASSET    := RL_XIN_T100.FLGPROCESSEDASSET;
          --- Technical fields
          REC_T100.CODUSRMOD     := C_SYSUSR;
          REC_T100.DTEMOD        := XSYSDATE;
          REC_T100.CODUSRMODREAL := C_SYSUSR;
          REC_T100.CODUSRCREREAL := C_SYSUSR;
          -- lock fields
          REC_T100.CODUSRLCK     := C_SYSUSR;
          REC_T100.IDSESSIONLCK  := PI_SESSION_ID;
          REC_T100.DTELCK        := XSYSDATE;
        END IF;

        IF (VL_STATUS <> 0) THEN
          VL_MESSAGE_H := SUBSTR(VL_MESSAGE_H || ' ' || VL_MESSAGE_D,1,4000);
          PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                         VL_PROGR_D_T100,
                                         SQLCODE,
                                         VL_MESSAGE_H);
        END IF;
 
        BEGIN
          IF (VL_STATUS = 0) THEN
            
            -- Before updating all rows, we mark them all to recognize those no more sent by ERP
            -- we use a prefix on CODSTATUS
            UPDATE T106ORDROW T
               SET T.codstatus = C_T106_STATUS_PREFIX || t.codstatus,
                   t.qtyord = '0',
                   t.qtyinv = '0' -- not returned rows from SAGE should be set as zero qty in SM1
             WHERE t.numord = REC_T100.NUMORD;

            VL_MESSAGE_H := RL_XIN_T100.NUMORDHOST || '&' || RL_XIN_T100.SM1_DTECRE;
            VL_MESSAGE_D := '';
            
            FOR RL_XIN_T106 IN CL_XIN_T106(RL_XIN_T100.NUMORD) LOOP
              
              VL_MESSAGE_H := 'Row info: ' || REC_T100.NUMORD || '/' || RL_XIN_T106.CODDIV || '/' || RL_XIN_T106.NUMROWHOST || ' Format Conversion => ';
              VL_STATUS := 0;
              
              VL_CODDIV := RL_XIN_T106.CODDIV;
              REC_T106  := REC_T106_INIT;
              
              -- 1. Check and log error if User code is null
              IF (RL_XIN_T106.CODUSR IS NULL) THEN
                VL_STATUS := -1;
                VL_MESSAGE_H := VL_MESSAGE_H || ' / ' || 'User code (CODUSR) is mandatory';
              END IF;
              
              -- 2. Check and log error if NUMORD is null
              IF (RL_XIN_T106.NUMORD IS NULL) THEN
                VL_STATUS := -1;
                VL_MESSAGE_H := VL_MESSAGE_H || ' / ' || 'Order number (NUMORD) is mandatory';
              END IF;
              
              -- 3. Check and log error if NUMROW is null
              IF (RL_XIN_T106.NUMROW IS NULL) THEN
                VL_STATUS := -1;
                VL_MESSAGE_H := VL_MESSAGE_H || ' / ' || 'Order row number (NUMROW) is mandatory';
              END IF;
              
              -- 4. Check and log error if CODART is null
              IF (RL_XIN_T106.CODART IS NULL) THEN
                VL_STATUS := -1;
                VL_MESSAGE_H := VL_MESSAGE_H || ' / ' || 'Product code (CODART) is mandatory';
              END IF;
              
              -- 5. Check and log error if CODDIV is null
              IF (RL_XIN_T106.CODDIV IS NULL) THEN
                VL_STATUS := -1;
                VL_MESSAGE_H := VL_MESSAGE_H || ' / ' || 'Division code (CODDIV) is mandatory';
              END IF;
              
              -- 6. Check and log error if UMORD is null
              IF (RL_XIN_T106.UMORD IS NULL) THEN
                VL_STATUS := -1;
                VL_MESSAGE_H := VL_MESSAGE_H || ' / ' || 'Order unit of measure (UMORD) is mandatory';
              END IF;
              
              -- 7. Check and log error if DESART is null
              IF (RL_XIN_T106.DESART IS NULL) THEN
                VL_STATUS := -1;
                VL_MESSAGE_H := VL_MESSAGE_H || ' / ' || 'Product description (DESART) is mandatory';
              END IF;
              
              -- 8. Check and log error if QTYORD is null
              IF (RL_XIN_T106.QTYORD IS NULL) THEN
                VL_STATUS := -1;
                VL_MESSAGE_H := VL_MESSAGE_H || ' / ' || 'Ordered quantity (QTYORD) is mandatory';
              END IF;
              
              IF (VL_STATUS = 0) THEN
                REC_T106.NUMORD := REC_T100.NUMORD;
                REC_T106.CODUSR := REC_T100.CODUSR;
                --
                REC_T106.NUMROW    := RL_XIN_T106.NUMROW;
                REC_T106.CODART    := GET_PRODUCT_CODE(RL_XIN_T106.CODDIV,RL_XIN_T106.CODART);
                REC_T106.CODDIV    := RL_XIN_T106.CODDIV;
                REC_T106.UMORD     := RL_XIN_T106.UMORD;
                REC_T106.DESART    := RL_XIN_T106.DESART;
                REC_T106.QTYORD    := RL_XIN_T106.QTYORD;
                REC_T106.QTYBCKORD := RL_XIN_T106.QTYBCKORD;
                REC_T106.QTYANN    := RL_XIN_T106.QTYANN;
                REC_T106.QTYDEL    := RL_XIN_T106.QTYDEL;
                REC_T106.UMINV     := REC_T106.UMORD;
                REC_T106.QTYINV    := REC_T106.QTYORD;
                REC_T106.CODTYPROW := RL_XIN_T106.CODTYPROW;
                REC_T106.CODLIST   := RL_XIN_T106.CODLIST;
                REC_T106.DTEDELIV  := TO_DATE(RL_XIN_T106.DTEDELIV, C_SAP_FORMAT_DATE);
                REC_T106.DTEPROPDELIV := TO_DATE(RL_XIN_T106.DTEPROPDELIV, C_SAP_FORMAT_DATE);
                REC_T106.CODSTATUS    := RL_XIN_T106.CODSTATUS;
                REC_T106.CODSHIPPER   := RL_XIN_T106.CODSHIPPER;
                REC_T106.NUMDOCREF    := RL_XIN_T106.NUMDOCREF;
                REC_T106.DTEDOCREF    := TO_DATE(RL_XIN_T106.DTEDOCREF, C_SAP_FORMAT_DATE);
                REC_T106.GROSSAMOUNT  := RL_XIN_T106.GROSSAMOUNT;
                REC_T106.NUMINV       := RL_XIN_T106.NUMINV;
                REC_T106.NETAMOUNT    := RL_XIN_T106.NETAMOUNT;
                REC_T106.DTEINV       := TO_DATE(RL_XIN_T106.DTEINV, C_SAP_FORMAT_DATE);
                REC_T106.TAXAMOUNT    := RL_XIN_T106.TAXAMOUNT;
                REC_T106.VATAMOUNT    := RL_XIN_T106.VATAMOUNT;
                REC_T106.INCREASEAMOUNT :=  RL_XIN_T106.INCREASEAMOUNT;
                REC_T106.DISCOUNTAMOUNT :=  RL_XIN_T106.DISCOUNTAMOUNT;
                REC_T106.GIFTAMOUNT     :=  RL_XIN_T106.GIFTAMOUNT;
                REC_T106.ENDUSERPRICE   :=  RL_XIN_T106.ENDUSERPRICE;
                REC_T106.CODAZCAPP      :=  RL_XIN_T106.CODAZCAPP;
                REC_T106.FLGEFFBCKORD   :=  RL_XIN_T106.FLGEFFBCKORD;
                REC_T106.CODBCKORDCAUSE :=  RL_XIN_T106.CODBCKORDCAUSE;
                REC_T106.GROSSARTAMOUNT :=  RL_XIN_T106.GROSSARTAMOUNT;
                REC_T106.NETARTAMOUNT   :=  RL_XIN_T106.NETARTAMOUNT;
                REC_T106.CODSRC         :=  RL_XIN_T106.CODSRC;
                REC_T106.CODSRCREF      :=  RL_XIN_T106.CODSRCREF;
                REC_T106.CODBENCAUSE    :=  RL_XIN_T106.CODBENCAUSE;
                REC_T106.CODBENSUBCAUSE :=  RL_XIN_T106.CODBENSUBCAUSE;
                REC_T106.BENNOTE        :=  RL_XIN_T106.BENNOTE;
                REC_T106.AZCTOAPPLY     :=  RL_XIN_T106.AZCTOAPPLY;
                REC_T106.CODOPERATION   :=  RL_XIN_T106.CODOPERATION;
                REC_T106.DISCOUNTAMOUNTOUTINV :=  RL_XIN_T106.DISCOUNTAMOUNTOUTINV;
                REC_T106.CODACCAPP            :=  RL_XIN_T106.CODACCAPP;
                REC_T106.CODTYPROWCAUSE       :=  RL_XIN_T106.CODTYPROWCAUSE;
                REC_T106.CODARTCUST           :=  RL_XIN_T106.CODARTCUST;
                REC_T106.QTYRESO              :=  RL_XIN_T106.QTYRESO;
                REC_T106.NUMORDRESO           :=  RL_XIN_T106.NUMORDRESO;
                REC_T106.CODBLCCAUSE          :=  RL_XIN_T106.CODBLCCAUSE;
                REC_T106.CODARTKITREF         :=  RL_XIN_T106.CODARTKITREF;
                REC_T106.NUMROWKITREF         :=  RL_XIN_T106.NUMROWKITREF;
                REC_T106.CODCAUSEKIT          :=  RL_XIN_T106.CODCAUSEKIT;
                REC_T106.NETARTAMOUNTTEO      :=  RL_XIN_T106.NETARTAMOUNTTEO;
                REC_T106.NETAMOUNTTEO         :=  RL_XIN_T106.NETAMOUNTTEO;
                REC_T106.NETAMOUNTMIN         :=  RL_XIN_T106.NETAMOUNTMIN;
                REC_T106.NETAMOUNTMAX         :=  RL_XIN_T106.NETAMOUNTMAX;
                REC_T106.NETDIFF              :=  RL_XIN_T106.NETDIFF;
                REC_T106.COD_ABBINAMENTO_KIT  :=  RL_XIN_T106.COD_ABBINAMENTO_KIT;
                REC_T106.NUMROWORIG           :=  RL_XIN_T106.NUMROWORIG;
                REC_T106.FLGFIRSTSON          :=  RL_XIN_T106.FLGFIRSTSON;
                REC_T106.NETARTAMOUNTCUST     :=  RL_XIN_T106.NETARTAMOUNTCUST;
                REC_T106.NETARTAMOUNTCUST2    :=  RL_XIN_T106.NETARTAMOUNTCUST2;
                REC_T106.GROSSARTAMOUNTCUST   :=  RL_XIN_T106.GROSSARTAMOUNTCUST;
                REC_T106.NETAMOUNTCUST        :=  RL_XIN_T106.NETAMOUNTCUST;
                REC_T106.QTYORDEDI            :=  RL_XIN_T106.QTYORDEDI;
                REC_T106.CODEAN               :=  RL_XIN_T106.CODEAN;
                REC_T106.UMORDEDI             :=  RL_XIN_T106.UMORDEDI;
                REC_T106.NUMROWREF            :=  RL_XIN_T106.NUMROWREF;
                REC_T106.FLGOMGPROMO          :=  RL_XIN_T106.FLGOMGPROMO;
                REC_T106.GROSSARTAMOUNTORD    :=  RL_XIN_T106.GROSSARTAMOUNTORD;
                REC_T106.GROSSARTAMOUNTDELTA  :=  RL_XIN_T106.GROSSARTAMOUNTDELTA;
                REC_T106.FLGOMGDISCLIST       :=  RL_XIN_T106.FLGOMGDISCLIST;
                REC_T106.CODCNVPDA            :=  RL_XIN_T106.CODCNVPDA;
                REC_T106.DTEEVA               :=  TO_DATE(RL_XIN_T106.DTEEVA, C_SAP_FORMAT_DATE);
                REC_T106.CODPAYTRM            :=  RL_XIN_T106.CODPAYTRM;
                REC_T106.CODPAYMOD            :=  RL_XIN_T106.CODPAYMOD;
                REC_T106.NUMROWHOST           :=  RL_XIN_T106.NUMROWHOST;
                REC_T106.CODMODSHIP           :=  RL_XIN_T106.CODMODSHIP;
                REC_T106.CODMODDELIV          :=  RL_XIN_T106.CODMODDELIV;
                REC_T106.DTEPRICE             :=  TO_DATE(RL_XIN_T106.DTEPRICE, C_SAP_FORMAT_DATE);
                REC_T106.DTEDELIVTO           :=  TO_DATE(RL_XIN_T106.DTEDELIVTO, C_SAP_FORMAT_DATE);
                REC_T106.CODROWGROUP          :=  RL_XIN_T106.CODROWGROUP;
                REC_T106.NETAMOUNTGIFT        :=  RL_XIN_T106.NETAMOUNTGIFT;
                REC_T106.NETARTAMOUNTEDI      :=  RL_XIN_T106.NETARTAMOUNTEDI;
                REC_T106.GROSSARTAMOUNTEDI    :=  RL_XIN_T106.GROSSARTAMOUNTEDI;
                REC_T106.QTYORDORIG           :=  RL_XIN_T106.QTYORDORIG;
                REC_T106.QTYALLOCATED         :=  RL_XIN_T106.QTYALLOCATED;
                REC_T106.RETURNAMOUNT         :=  RL_XIN_T106.RETURNAMOUNT;
                REC_T106.NUMORDHOST           :=  RL_XIN_T100.NUMORDHOST;
                REC_T106.CODWHS               :=  RL_XIN_T100.CODWHS;
              END IF;
              
              IF (VL_STATUS <> 0) THEN
                VL_MESSAGE_H := SUBSTR(VL_MESSAGE_H || ' ' || VL_MESSAGE_D,1,4000);
                PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                               VL_PROGR_D_T106, 
                                               SQLCODE,
                                               VL_MESSAGE_H);
              ELSE
                VL_INS_UPD := NULL;
                -- Recognize order lines; inserts new rows ; check the row
                LOAD_T10X_ROW_STEP2(PI_PROGR_H,
                                    VL_PROGR_D_T106,
                                    REC_T106,
                                    VL_INS_UPD,
                                    VL_STATUS);
              END IF;
              
              IF (VL_STATUS = 0) THEN
                IF (VL_INS_UPD = 'UPD') THEN
                  
                  VL_MESSAGE_D := 'Update T106 ';
                  UPDATE T106ORDROW
                     SET UMORD = REC_T106.UMORD,
                         DESART = REC_T106.DESART,
                         QTYORD = REC_T106.QTYORD,
                         QTYINV = REC_T106.QTYINV,
                         QTYBCKORD = REC_T106.QTYBCKORD,
                         CODSTATUS = REC_T106.CODSTATUS,
                         NUMORDHOST = REC_T106.NUMORDHOST,
                         NUMROWHOST = REC_T106.NUMROWHOST,
                         CODWHS = REC_T106.CODWHS
                   WHERE NUMORD = REC_T106.NUMORD
                     AND NUMROW = REC_T106.NUMROW;

                 ELSE
                   
                    VL_MESSAGE_D := 'Insert T106 ';
                    INSERT INTO T106ORDROW VALUES REC_T106;
                    
                END IF;
                VL_INS_T106 := VL_INS_T106 + 1;
              END IF;

           END LOOP;
          END IF;
          
          -- Update T100 if checks have been completed successfully
          IF (VL_STATUS = 0) THEN
            
            UPDATE T100ORDHEAD
              SET -- when the field si set to updated by host it means that the value should be read from XIN
                  -- otherwise it means that the field is managed by sm1 and it maintains its original value
                  CODEUSR              = REC_T100.CODEUSR,
                  CODTYPORD            = REC_T100.CODTYPORD,
                  CODSTATUS            = REC_T100.CODSTATUS,
                  CODDIV               = REC_T100.CODDIV,
                  DTEORD               = REC_T100.DTEORD,
                  DTEDELIV             = REC_T100.DTEDELIV,
                  DTEEVA               = REC_T100.DTEEVA,
                  CODPAYTRM            = REC_T100.CODPAYTRM,
                  CODPAYMOD            = REC_T100.CODPAYMOD,
                  CODCUSTDELIV         = REC_T100.CODCUSTDELIV,
                  CODVATMGMT           = REC_T100.CODVATMGMT,
                  CODCUSTINV           = GET_CUSTOMER_CODE(REC_T100.CODDIV,REC_T100.CODCUSTINV),
                  CODCUR               = REC_T100.CODCUR,
                  NUMORDREF            = REC_T100.NUMORDREF,
                  NUMORDHOST           = REC_T100.NUMORDHOST,
                  NUMORDCUST           = REC_T100.NUMORDCUST,
                  DTEORDCUST           = REC_T100.DTEORDCUST,
                  CODMODSHIP           = REC_T100.CODMODSHIP,
                  CODAGREEMENT         = REC_T100.CODAGREEMENT,
                  DTEAUT               = REC_T100.DTEAUT,
                  GROSSAMOUNT          = REC_T100.GROSSAMOUNT,
                  NETAMOUNT            = REC_T100.NETAMOUNT,
                  TAXAMOUNT            = REC_T100.TAXAMOUNT,
                  VATAMOUNT            = REC_T100.VATAMOUNT,
                  INCREASEAMOUNT       = REC_T100.INCREASEAMOUNT,
                  DISCOUNTAMOUNT       = REC_T100.DISCOUNTAMOUNT,
                  GIFTAMOUNT           = REC_T100.GIFTAMOUNT,
                  QTYTOT               = REC_T100.QTYTOT,
                  UMQTYTOT             = REC_T100.UMQTYTOT,
                  FLGRETURN            = REC_T100.FLGRETURN,
                  FLGHOSTED            = REC_T100.FLGHOSTED,
                  FLGCONFIRMED         = REC_T100.FLGCONFIRMED,
                  CODWHS               = REC_T100.CODWHS,
                  DTEPRICE             = REC_T100.DTEPRICE,
                  FLGCHECKPROMO        = REC_T100.FLGCHECKPROMO,
                  DISCOUNTAMOUNTOUTINV = REC_T100.DISCOUNTAMOUNTOUTINV,
                  DTEDELIVTO           = REC_T100.DTEDELIVTO,
                  FLGUMORD2            = REC_T100.FLGUMORD2,
                  NETAMOUNTTEO         = REC_T100.NETAMOUNTTEO,
                  NETAMOUNTMIN         = REC_T100.NETAMOUNTMIN,
                  NETAMOUNTMAX         = REC_T100.NETAMOUNTMAX,
                  BACKAMOUNT           = REC_T100.BACKAMOUNT,
                  TOTPALLETS           = REC_T100.TOTPALLETS,
                  GROSSWEIGHT          = REC_T100.GROSSWEIGHT,
                  TOTMC                = REC_T100.TOTMC,
                  DTEPROPDELIV         = REC_T100.DTEPROPDELIV,
                  FLGPROCESSEDEDI      = REC_T100.FLGPROCESSEDEDI,
                  FLGEDI               = REC_T100.FLGEDI,
                  DTEDELIV2            = REC_T100.DTEDELIV2,
                  DTEDELIV3            = REC_T100.DTEDELIV3,
                  DTEDELIV4            = REC_T100.DTEDELIV4,
                  DTECLOSE             = REC_T100.DTECLOSE,
                  FLGPROCESSEDASSET    = REC_T100.FLGPROCESSEDASSET,
                  --- Technical fields
                  CODUSRMOD    = REC_T100.CODUSRMOD,
                  DTEMOD       = REC_T100.DTEMOD,
                  -- lock fields
                  CODUSRLCK    = REC_T100.CODUSRLCK,
                  IDSESSIONLCK = REC_T100.IDSESSIONLCK,
                  DTELCK       = REC_T100.DTELCK
                  
            WHERE NUMORD = REC_T100.NUMORD
              AND CODUSR = REC_T100.CODUSR
              AND (IDSESSIONLCK = REC_T100.IDSESSIONLCK OR NOT EXISTS
                   (SELECT NULL
                      FROM T035LOGGEDUSERS T035
                     WHERE T035.IDSESSION = NVL(IDSESSIONLCK, '@')
                       AND T035.LASTCHECK > TRUNC(XSYSDATE) - 1));

          END IF;

        EXCEPTION
          WHEN OTHERS THEN
            VL_STATUS := -1;
            VL_MESSAGE_H := SUBSTR(VL_MESSAGE_H || ' ' || VL_MESSAGE_D || ' ' || dbms_utility.format_error_backtrace() || ' ' || SQLERRM,1,4000);

            PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                           VL_PROGR_D_T106,
                                           SQLCODE,
                                           VL_MESSAGE_H);
        END;
      EXCEPTION
        WHEN OTHERS THEN
          VL_STATUS := -1;
          VL_MESSAGE_H := SUBSTR(VL_MESSAGE_H||' '||VL_MESSAGE_D||' '||dbms_utility.format_error_backtrace() || ' ' || SQLERRM,1,4000);

          PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                         VL_PROGR_D_T100,
                                         SQLCODE,
                                         VL_MESSAGE_H);
      END;

      -- if all records have been stored with success then it makes the final commit
      IF VL_STATUS = 0 THEN
         VL_INS_T100 := VL_INS_T100 + 1;
      END IF;
      
      IF (VL_STATUS <> 0 OR VL_RECORD_LOCKED <> 0) THEN
        UPDATE XIN_T106ORDROW
           SET SM1_STATUS = CASE
                              WHEN VL_RECORD_LOCKED <> 0 THEN
                               C_XINSTATUS_LOCK
                              ELSE
                               C_XINSTATUS_ERR
                            END
         WHERE CODUSR = RL_XIN_T100.CODUSR
           AND SM1_CODPROCESS = PI_PROGR_H
           AND SM1_DTECRE = RL_XIN_T100.SM1_DTECRE
           AND SM1_STATUS = C_XINSTATUS_OK;
            
        -- TO CHECK this update is  not correct in case of double record .
        UPDATE XIN_T100ORDHEAD
           SET SM1_STATUS = CASE
                              WHEN VL_RECORD_LOCKED <> 0 THEN
                               C_XINSTATUS_LOCK
                              ELSE
                               C_XINSTATUS_ERR
                            END
         WHERE CODUSR = RL_XIN_T100.CODUSR
           AND SM1_CODPROCESS = PI_PROGR_H
           AND SM1_DTECRE <= RL_XIN_T100.SM1_DTECRE
           AND SM1_STATUS = C_XINSTATUS_OK;
      END IF;

      -- Release updated records
      UPDATE T100ORDHEAD
         SET DTELCK = NULL, IDSESSIONLCK = NULL, CODUSRLCK = NULL
       WHERE CODUSR = REC_T100.CODUSR
         AND CODUSRLCK = C_SYSUSR
         AND IDSESSIONLCK = PI_SESSION_ID;
    END LOOP;
    COMMIT;

    -- Moves records from staging area to log staging area
    P_XIN_MOVE_TO_LOG(PI_PROGR_H, VL_PROGR_D_T100,'T106ORDROW');
    P_XIN_MOVE_TO_LOG(PI_PROGR_H, VL_PROGR_D_T100,'T100ORDHEAD');

    -- Close Logs
    PKG_UTILS.LOG_END_DETAIL(PI_PROGR_H,
                             VL_PROGR_D_T106,
                             0,
                             VL_COUNT_XIN_T106,
                             VL_INS_T106,
                             VL_COUNT_XIN_T106 - VL_INS_T106);

    PKG_UTILS.LOG_END_DETAIL(PI_PROGR_H,
                             VL_PROGR_D_T100,
                             0,
                             VL_COUNT_XIN_T100,
                             VL_INS_T100,
                             VL_COUNT_XIN_T100 - VL_INS_T100);

    PO_MSG    := VL_INS_T100||'/'||VL_COUNT_XIN_T100||' Orders loaded';
    PO_STATUS := VL_INS_T100;
  EXCEPTION
    WHEN EX_EXIT THEN

      ROLLBACK;
      VL_MESSAGE_H       := VL_MESSAGE_H || TRIM(SUBSTR(dbms_utility.format_error_backtrace() || ' ' || SQLERRM, 1, 255));
      PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                     VL_PROGR_D_T100,
                                     SQLCODE,
                                     VL_MESSAGE_H);

      PO_MSG := VL_MESSAGE_H;
      PO_STATUS := -1;

    WHEN OTHERS THEN

      ROLLBACK;
      UPDATE T100ORDHEAD
         SET DTELCK = NULL, IDSESSIONLCK = NULL, CODUSRLCK = NULL
       WHERE CODUSRLCK = C_SYSUSR
         AND IDSESSIONLCK = PI_SESSION_ID;
      COMMIT;
      -- Moves records from staging area to log staging area
      P_XIN_MOVE_TO_LOG(PI_PROGR_H, VL_PROGR_D_T100,'T106ORDROW');
      P_XIN_MOVE_TO_LOG(PI_PROGR_H, VL_PROGR_D_T100,'T100ORDHEAD');

      VL_MESSAGE_H       := VL_MESSAGE_H || TRIM(SUBSTR(dbms_utility.format_error_backtrace() || ' ' || SQLERRM, 1, 255));

      PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                     VL_PROGR_D_T100,
                                     SQLCODE,
                                     VL_MESSAGE_H);

      PO_MSG := VL_MESSAGE_H;
      PO_STATUS := VL_STATUS;

  END LOAD_T100_ORDERS_50_SYG;
  
  /*============================================================================*\
    Name: LOAD_T100_ORDERS_51_SYG
    
    Loads SM1 tables:
        • T100ORDHEAD- Order Head
        • T106ORDROW  - Order Row
        
    Staging Area (SSA) tables, Chronological Order expected in SSA (for each decode set):
        1.  XIN_T100ORDHEAD
        2.  XIN_T106ORDROW

    Loading logic:
      UPDATE+INSERT
      Steps:
      
       1- Recognize SM1 order from external order SAP
           XIN_T100.NUMORDREF not null : it is a SM1 Order
           XIN_T100.NUMORDREF is null : it is an external Order
          then it must be populated:
               XIN_T100.NUMORDHOST : order unique code from erp
               XIN_T100.CODUSR : erp dummy user "SAP"

       2- assign new NUMORD to external order SAP/JDE/Others
       3- row matching (logically cancel the no more present  - add new rows -- determine new numrow)
       4- determine row status from quantities (backorder-delivered-cancelled)----
       5- detrmine head status from row status
       6- calculate header quantities

    Validity Checks:
        • Orders found on staging area are loaded to SM1 main tables only if they are not already opened for update by a SM1 user. In that case records remain in staging area ready to be loaded on next import run.
        • Detail Records found on XIN_T106ORDROW are loaded only if there is the head record in XIN_T100ORDHEAD.

    Error handling:
        • All Errors will be logged in T852/T854 SM1 log tables and all staging area records will be stored into staging area log with sm1_status = 9.
        • Error on head record,  it is discarded with all its details.
        • Error on detail record, it is discarded and import procedure skips to next detail.

    How to delete
        • You cannot delete an order by  ERP interface, you can set it to CANCELLED status

    Input parameters :     PI_PROGR_H       - unique sm1 job number ( T800SYSTEMACTIVITYLOG )
                           PI_SESSION_ID    - unique login session (T035LOGGEDUSERS)

    Outputparameters :     PO_MSG           - message of error if procedure exit with error
                           PO_STATUS        - 0 OK; -1 Error
   Author : ravi.gopeechund.sa@everis.com
   Creation Date : 03/03/2021
   ----
  ============================================================================ */
  PROCEDURE LOAD_T100_ORDERS_51_SYG(PI_PROGR_H     IN NUMBER,
                                    PI_SESSION_ID  IN NUMBER,
                                    PO_MSG         OUT NOCOPY VARCHAR2,
                                    PO_STATUS      OUT NOCOPY NUMBER) IS
                                    
    -- -----------------------------------------
    -- Cursor on Orde Heads xin_t100ordhead
    -- -----------------------------------------
    CURSOR CL_XIN_T100 IS
      SELECT *
        FROM XIN_T100ORDHEAD
       WHERE SM1_CODPROCESS = PI_PROGR_H
       ORDER BY NUMORDHOST, SM1_DTECRE;
    -- -----------------------------------------
    -- Cursor on Order Rows xin_t106_ordrow
    -- -----------------------------------------
    CURSOR CL_XIN_T106(CI_NUMORD VARCHAR2) IS
      SELECT ORDROW.*, T.Codwhs AS VANWHS
        FROM XIN_T106ORDROW ORDROW
       INNER JOIN T100ORDHEAD T
          ON ORDROW.NUMORD = T.NUMORD
       WHERE ORDROW.NUMORD = CI_NUMORD
         AND ORDROW.SM1_CODPROCESS = PI_PROGR_H
         AND ORDROW.SM1_STATUS = C_XINSTATUS_OK
       ORDER BY ORDROW.NUMROW;
    --

    VL_MESSAGE_H   VARCHAR2(4000) := 'Error while loading Orders T100/T106';
    VL_MESSAGE_D   VARCHAR2(4000) := NULL;
    --
    VL_PROGR_D_T100    NUMBER := 0;
    VL_COUNT_XIN_T100  NUMBER := 0;
    VL_INS_T100        NUMBER := 0;
    --
    VL_PROGR_D_T106    NUMBER := 0;
    VL_COUNT_XIN_T106  NUMBER := 0;
    VL_INS_T106        NUMBER := 0;
    --
    REC_T100      T100ORDHEAD%ROWTYPE    := NULL;
    REC_T100_INIT T100ORDHEAD%ROWTYPE    := NULL;
    REC_T106      T106ORDROW%ROWTYPE := NULL;
    REC_T106_INIT T106ORDROW%ROWTYPE := NULL;
    --
    VL_DES_T100     X_FIELD_INFO_ARRAY;
    VL_DES_T106     X_FIELD_INFO_ARRAY;
    --
    VL_RECORD_LOCKED NUMBER := 0;

    VL_STATUS NUMBER:= 0;
    VL_STEP   NUMBER:= 0; -- Used to ping t035
    --
    EX_EXIT  EXCEPTION;
    --
    VL_CODDIV VARCHAR2(30) := NULL;
    vl_ins_upd VARCHAR2(3) := NULL;

  BEGIN

    -- init indexes and rebuild statistics
    P_XIN_INIT_INDEXES (PI_PROGR_H, 'T100ORDHEAD');
    P_XIN_INIT_INDEXES (PI_PROGR_H, 'T106ORDROW');
    -- clean log
    P_XIN_CLEANUP_LOG (PI_PROGR_H, 'T100ORDHEAD');
    P_XIN_CLEANUP_LOG (PI_PROGR_H, 'T106ORDROW');

    VL_PROGR_D_T100 := PKG_UTILS.LOG_NEW_DETAIL(PI_PROGR_H,
                                       'ORDER HEAD',
                                       'IMPORT --> Van integration orders for SYG division (Order type=51)',
                                        0,
                                        NULL);
    VL_PROGR_D_T106 := PKG_UTILS.LOG_NEW_DETAIL(PI_PROGR_H,
                                       'ORDER ROWS',

                                       'IMPORT --> Van integration orders for SYG division (Order type=51)',
                                        0,
                                        NULL);

    -- Retrieves configuration parameters
    LOAD_T10X_CONF_STEP0(VL_MESSAGE_H,VL_STATUS);

    IF (VL_STATUS <> 0 ) THEN
      PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                    VL_PROGR_D_T100,
                                    SQLCODE,
                                    VL_MESSAGE_H);
      RAISE EX_EXIT;
    END IF;
    
    BEGIN
      --
      -- ----------------------------------------------------------
      -- Init arrays with FIELD_NAME=LENGTH and FIELDNAME=SM1_DEFAULT for all fields of table
      -- ----------------------------------------------------------
      VL_DES_T100.DELETE;
      P_INIT_SM1_FIELD_ARRAY ('T100ORDHEAD', VL_DES_T100, VL_STATUS, VL_MESSAGE_H);
      EXECUTE IMMEDIATE ( GL_INIT_REC) INTO REC_T100_INIT;


      VL_DES_T106.DELETE;
      P_INIT_SM1_FIELD_ARRAY ('T106ORDROW', VL_DES_T106, VL_STATUS, VL_MESSAGE_H);
      EXECUTE IMMEDIATE ( GL_INIT_REC) INTO REC_T106_INIT;

      IF (VL_STATUS <> 0 ) THEN
          VL_MESSAGE_D := GL_INIT_REC;
          RAISE EX_EXIT;
      END IF;
    EXCEPTION
      WHEN OTHERS THEN
        VL_MESSAGE_D := GL_INIT_REC;
        RAISE EX_EXIT;
    END;

    -- --------------------------------------------------------------
    -- Identifies Xin records to be loaded
    -- --------------------------------------------------------------
    BEGIN
      VL_MESSAGE_D := 'XIN_T100ORDHEAD';
      UPDATE XIN_T100ORDHEAD
         SET SM1_CODPROCESS = PI_PROGR_H,
             SM1_STATUS     = 0,
             SM1_DTEPROCESS = XSYSDATE
       WHERE NVL(SM1_CODPROCESS, 0) = C_SM1_NULL_CODPROCESS
         AND CODDIV = 'SYG'
         AND CODTYPORD = '51';
      VL_COUNT_XIN_T100 := SQL%ROWCOUNT;

      VL_MESSAGE_D := 'XIN_T106ORDROW';
      UPDATE XIN_T106ORDROW D
         SET D.SM1_CODPROCESS = PI_PROGR_H,
             D.SM1_STATUS     = 0,
             D.SM1_DTEPROCESS = XSYSDATE
       WHERE NVL(D.SM1_CODPROCESS, 0) = C_SM1_NULL_CODPROCESS
         AND D.NUMORD IN (SELECT H.NUMORD
                            FROM XIN_T100ORDHEAD H
                           WHERE H.SM1_CODPROCESS = PI_PROGR_H
                             AND CODDIV = 'SYG'
                             AND CODTYPORD = '51');
      VL_COUNT_XIN_T106 := SQL%ROWCOUNT;
      COMMIT;
    EXCEPTION
      WHEN OTHERS THEN
        ROLLBACK;
        VL_MESSAGE_H := 'Error while Reading Staging area: ' || VL_MESSAGE_D || TRIM(SUBSTR(dbms_utility.format_error_backtrace() || ' ' || SQLERRM, 1, 255));
        RAISE EX_EXIT;
    END;

    -- --------------------------------------------------------------
    -- loop in main table T100ORDHEAD
    -- --------------------------------------------------------------
    FOR RL_XIN_T100 IN CL_XIN_T100 LOOP
      
      -- pings to t035 every 100 cicles--
      VL_STEP := VL_STEP + 1;
      IF ( MOD(VL_STEP, 100) = 0 ) THEN
         PKG_UTILS.user_ping(PI_SESSION_ID);
      END IF;

      --
      VL_STATUS := 0;
      VL_MESSAGE_H := 'Order NumordHost : ' || RL_XIN_T100.NUMORDHOST || ' Format Conversion => ';
      VL_MESSAGE_D := '';
      --
      BEGIN

        -- Data Format Check
        VL_CODDIV := 'ALL';
        REC_T100 := REC_T100_INIT;
        
        -- 1. Check and log error if Order number is null
        IF (RL_XIN_T100.NUMORD IS NULL) THEN
          VL_STATUS := -1;
          VL_MESSAGE_H := VL_MESSAGE_H || ' / ' || 'Order number(NUMORD) is mandatory';
        END IF;
        
        -- 2. Check and log error if User code is null
        IF (RL_XIN_T100.CODUSR IS NULL) THEN
          VL_STATUS := -1;
          VL_MESSAGE_H := VL_MESSAGE_H || ' / ' || 'User code (CODUSR) is mandatory';
        END IF;

        -- 3. Check and log error if Order type is null
        IF (RL_XIN_T100.CODTYPORD IS NULL) THEN
          VL_STATUS := -1;
          VL_MESSAGE_H := VL_MESSAGE_H || ' / ' || 'Order type (CODTYPORD) is mandatory';
        END IF;
        
        -- 4. Check and log error if Division code is null
        IF (RL_XIN_T100.CODDIV IS NULL) THEN
          VL_STATUS := -1;
          VL_MESSAGE_H := VL_MESSAGE_H || ' / ' || 'Division code (CODDIV) is mandatory';
        END IF;
        
        -- 5. Check and log error if Order date is null
        IF (RL_XIN_T100.DTEORD IS NULL) THEN
          VL_STATUS := -1;
          VL_MESSAGE_H := VL_MESSAGE_H || ' / ' || 'Order date (DTEORD) is mandatory';
        END IF;
        
        -- 6. Check and log error if Order delivery date is null
        IF (RL_XIN_T100.DTEDELIV IS NULL) THEN
          VL_STATUS := -1;
          VL_MESSAGE_H := VL_MESSAGE_H || ' / ' || 'Order delivery date (DTEDELIV) is mandatory';
        END IF;
        
        -- 7. Check and log error if Delivery customer code is null
        IF (RL_XIN_T100.CODCUSTDELIV IS NULL) THEN
          VL_STATUS := -1;
          VL_MESSAGE_H := VL_MESSAGE_H || ' / ' || 'Delivery customer code (CODCUSTDELIV) is mandatory';
        END IF;
        
        -- 8. Check and log error if Invoice customer code is null
        IF (RL_XIN_T100.CODCUSTINV IS NULL) THEN
          VL_STATUS := -1;
          VL_MESSAGE_H := VL_MESSAGE_H || ' / ' || 'Invoice customer code (CODCUSTINV) is mandatory';
        END IF;
        
        -- 9. Check and log error if Mobile warehouse code is null
        IF (RL_XIN_T100.CODWHS IS NULL) THEN
          VL_STATUS := -1;
          VL_MESSAGE_H := VL_MESSAGE_H || ' / ' || 'Mobile warehouse code (CODWHS) is mandatory';
        END IF;

        IF (VL_STATUS = 0) THEN
          REC_T100.NUMORD               := RL_XIN_T100.NUMORD;
          REC_T100.CODUSR               := RL_XIN_T100.CODUSR;
          --
          REC_T100.CODEUSR              := RL_XIN_T100.CODEUSR;
          REC_T100.CODTYPORD            := RL_XIN_T100.CODTYPORD;
          REC_T100.CODSTATUS            := RL_XIN_T100.CODSTATUS;
          REC_T100.CODDIV               := RL_XIN_T100.CODDIV;
          REC_T100.DTEORD               := TO_DATE(RL_XIN_T100.DTEORD, C_SAP_FORMAT_DATE);
          REC_T100.DTEDELIV             := TO_DATE(RL_XIN_T100.DTEDELIV, C_SAP_FORMAT_DATE);
          REC_T100.DTEEVA               := TO_DATE(RL_XIN_T100.DTEEVA, C_SAP_FORMAT_DATE);
          REC_T100.CODPAYTRM            := RL_XIN_T100.CODPAYTRM;
          REC_T100.CODPAYMOD            := RL_XIN_T100.CODPAYMOD;
          REC_T100.CODCUSTDELIV         := RL_XIN_T100.CODCUSTDELIV;
          REC_T100.CODVATMGMT           := RL_XIN_T100.CODVATMGMT;
          REC_T100.CODCUSTINV           := GET_CUSTOMER_CODE(RL_XIN_T100.CODDIV,RL_XIN_T100.CODCUSTINV);
          REC_T100.CODCUR               := RL_XIN_T100.CODCUR;
          REC_T100.NUMORDREF            := RL_XIN_T100.NUMORDREF;
          REC_T100.NUMORDHOST           := RL_XIN_T100.NUMORDHOST;
          REC_T100.NUMORDCUST           := RL_XIN_T100.NUMORDCUST;
          REC_T100.DTEORDCUST           := TO_DATE(RL_XIN_T100.DTEORDCUST, C_SAP_FORMAT_DATE);
          REC_T100.CODMODSHIP           := RL_XIN_T100.CODMODSHIP;
          REC_T100.CODAGREEMENT         := RL_XIN_T100.CODAGREEMENT;
          REC_T100.DTEAUT               := TO_DATE(RL_XIN_T100.DTEAUT, C_SAP_FORMAT_DATE);
          REC_T100.GROSSAMOUNT          := RL_XIN_T100.GROSSAMOUNT;
          REC_T100.NETAMOUNT            := RL_XIN_T100.NETAMOUNT;
          REC_T100.TAXAMOUNT            := RL_XIN_T100.TAXAMOUNT;
          REC_T100.VATAMOUNT            := RL_XIN_T100.VATAMOUNT;
          REC_T100.INCREASEAMOUNT       := RL_XIN_T100.INCREASEAMOUNT;
          REC_T100.DISCOUNTAMOUNT       := RL_XIN_T100.DISCOUNTAMOUNT;
          REC_T100.GIFTAMOUNT           := RL_XIN_T100.GIFTAMOUNT;
          REC_T100.QTYTOT               := RL_XIN_T100.QTYTOT;
          REC_T100.UMQTYTOT             := RL_XIN_T100.UMQTYTOT;
          REC_T100.FLGRETURN            := RL_XIN_T100.FLGRETURN;
          REC_T100.FLGHOSTED            := RL_XIN_T100.FLGHOSTED;
          REC_T100.FLGCONFIRMED         := RL_XIN_T100.FLGCONFIRMED;
          REC_T100.CODWHS               := RL_XIN_T100.CODWHS;
          REC_T100.DTEPRICE             := TO_DATE(RL_XIN_T100.DTEPRICE, C_SAP_FORMAT_DATE);
          REC_T100.FLGCHECKPROMO        := RL_XIN_T100.FLGCHECKPROMO;
          REC_T100.DISCOUNTAMOUNTOUTINV := RL_XIN_T100.DISCOUNTAMOUNTOUTINV;
          REC_T100.DTEDELIVTO           := TO_DATE(RL_XIN_T100.DTEDELIVTO, C_SAP_FORMAT_DATE);
          REC_T100.FLGUMORD2            := RL_XIN_T100.FLGUMORD2;
          REC_T100.NETAMOUNTTEO         := RL_XIN_T100.NETAMOUNTTEO;
          REC_T100.NETAMOUNTMIN         := RL_XIN_T100.NETAMOUNTMIN;
          REC_T100.NETAMOUNTMAX         := RL_XIN_T100.NETAMOUNTMAX;
          REC_T100.BACKAMOUNT           := RL_XIN_T100.BACKAMOUNT;
          REC_T100.TOTPALLETS           := RL_XIN_T100.TOTPALLETS;
          REC_T100.GROSSWEIGHT          := RL_XIN_T100.GROSSWEIGHT;
          REC_T100.TOTMC                := RL_XIN_T100.TOTMC;
          REC_T100.DTEPROPDELIV         := TO_DATE(RL_XIN_T100.DTEPROPDELIV, C_SAP_FORMAT_DATE);
          REC_T100.FLGPROCESSEDEDI      := RL_XIN_T100.FLGPROCESSEDEDI;
          REC_T100.FLGEDI               := RL_XIN_T100.FLGEDI;
          REC_T100.DTEDELIV2            := TO_DATE(RL_XIN_T100.DTEDELIV2, C_SAP_FORMAT_DATE);
          REC_T100.DTEDELIV3            := TO_DATE(RL_XIN_T100.DTEDELIV3, C_SAP_FORMAT_DATE);
          REC_T100.DTEDELIV4            := TO_DATE(RL_XIN_T100.DTEDELIV4, C_SAP_FORMAT_DATE);
          --
          IF (LENGTH(TRIM(TO_CHAR(RL_XIN_T100.DTECLOSE))) <> 0 AND RL_XIN_T100.DTECLOSE IS NOT NULL) THEN
            REC_T100.DTECLOSE  := TO_DATE(RL_XIN_T100.DTECLOSE, C_SAP_FORMAT_DATE);
          ELSE
            REC_T100.DTECLOSE  := F_CHECK_FORMAT_D( VL_CODDIV, TO_DATE(RL_XIN_T100.DTECLOSE, C_SAP_FORMAT_DATE),'DTECLOSE', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
          END IF;
          --
          REC_T100.FLGPROCESSEDASSET    := RL_XIN_T100.FLGPROCESSEDASSET;
          --- Technical fields
          REC_T100.CODUSRMOD     := C_SYSUSR;
          REC_T100.DTEMOD        := XSYSDATE;
          REC_T100.CODUSRMODREAL := C_SYSUSR;
          REC_T100.CODUSRCREREAL := C_SYSUSR;
          -- lock fields
          REC_T100.CODUSRLCK     := C_SYSUSR;
          REC_T100.IDSESSIONLCK  := PI_SESSION_ID;
          REC_T100.DTELCK        := XSYSDATE;
        END IF;

        IF (VL_STATUS <> 0) THEN
          VL_MESSAGE_H := SUBSTR(VL_MESSAGE_H || ' ' || VL_MESSAGE_D,1,4000);
          PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                         VL_PROGR_D_T100,
                                         SQLCODE,
                                         VL_MESSAGE_H);
        END IF;

        BEGIN
          --
          IF (VL_STATUS = 0) THEN
            -- Before updating all rows, we mark them all to recognize those no more sent by ERP
            -- we use a prefix on CODSTATUS
            UPDATE T106ORDROW T
               SET T.codstatus = C_T106_STATUS_PREFIX || t.codstatus,
                   t.qtyord = '0',
                   t.qtyinv = '0'
             WHERE t.numord = REC_T100.NUMORD;

            FOR RL_XIN_T106 IN CL_XIN_T106(RL_XIN_T100.NUMORD) LOOP

              VL_MESSAGE_H := 'Row info: '|| REC_T100.NUMORD|| '/' ||
                               REC_T100.CODUSR|| '/' ||
                               RL_XIN_T106.CODDIV || '/' ||
                               RL_XIN_T106.NUMROWHOST || ' Format Conversion => ';
              VL_STATUS := 0;
              
              VL_CODDIV := RL_XIN_T106.CODDIV;
              REC_T106  := REC_T106_INIT;

              -- 1. Check and log error if User code is null
              IF (RL_XIN_T106.CODUSR IS NULL) THEN
                VL_STATUS := -1;
                VL_MESSAGE_H := VL_MESSAGE_H || ' / ' || 'User code (CODUSR) is mandatory';
              END IF;
              
              -- 2. Check and log error if NUMORD is null
              IF (RL_XIN_T106.NUMORD IS NULL) THEN
                VL_STATUS := -1;
                VL_MESSAGE_H := VL_MESSAGE_H || ' / ' || 'Order number (NUMORD) is mandatory';
              END IF;
              
              -- 3. Check and log error if NUMROW is null
              IF (RL_XIN_T106.NUMROW IS NULL) THEN
                VL_STATUS := -1;
                VL_MESSAGE_H := VL_MESSAGE_H || ' / ' || 'Order row number (NUMROW) is mandatory';
              END IF;
              
              -- 4. Check and log error if CODART is null
              IF (RL_XIN_T106.CODART IS NULL) THEN
                VL_STATUS := -1;
                VL_MESSAGE_H := VL_MESSAGE_H || ' / ' || 'Product code (CODART) is mandatory';
              END IF;
              
              -- 5. Check and log error if CODDIV is null
              IF (RL_XIN_T106.CODDIV IS NULL) THEN
                VL_STATUS := -1;
                VL_MESSAGE_H := VL_MESSAGE_H || ' / ' || 'Division code CODDIV) is mandatory';
              END IF;
              
              -- 6. Check and log error if UMORD is null
              IF (RL_XIN_T106.UMORD IS NULL) THEN
                VL_STATUS := -1;
                VL_MESSAGE_H := VL_MESSAGE_H || ' / ' || 'Order unit of measure (UMORD) is mandatory';
              END IF;
              
              -- 7. Check and log error if DESART is null
              IF (RL_XIN_T106.DESART IS NULL) THEN
                VL_STATUS := -1;
                VL_MESSAGE_H := VL_MESSAGE_H || ' / ' || 'Product description (DESART) is mandatory';
              END IF;
              
              -- 8. Check and log error if QTYORD is null
              IF (RL_XIN_T106.QTYORD IS NULL) THEN
                VL_STATUS := -1;
                VL_MESSAGE_H := VL_MESSAGE_H || ' / ' || 'Ordered quantity (QTYORD) is mandatory';
              END IF;
                           
              -- 9. Check and log error if CODTYPROW is null
              IF (RL_XIN_T106.CODTYPROW IS NULL) THEN
                VL_STATUS := -1;
                VL_MESSAGE_H := VL_MESSAGE_H || ' / ' || 'Order row type code (CODTYPROW) is mandatory';
              END IF;
              
              -- 10. Check and log error if CODWHS is null
              IF (RL_XIN_T106.CODWHS IS NULL) THEN
                VL_STATUS := -1;
                VL_MESSAGE_H := VL_MESSAGE_H || ' / ' || 'Mobile warehouse code (CODWHS) is mandatory';
              END IF;

              IF (VL_STATUS = 0) THEN
                REC_T106.NUMORD := REC_T100.NUMORD;
                REC_T106.CODUSR := REC_T100.CODUSR;
                --
                REC_T106.NUMROW    := RL_XIN_T106.NUMROW;
                REC_T106.CODART    := GET_PRODUCT_CODE(RL_XIN_T106.CODDIV,RL_XIN_T106.CODART);
                REC_T106.CODDIV    := RL_XIN_T106.CODDIV;
                REC_T106.UMORD     := RL_XIN_T106.UMORD;
                REC_T106.DESART    := RL_XIN_T106.DESART;
                REC_T106.QTYORD    := RL_XIN_T106.QTYORD;
                REC_T106.QTYBCKORD := RL_XIN_T106.QTYBCKORD;
                REC_T106.QTYANN    := RL_XIN_T106.QTYANN;
                REC_T106.QTYDEL    := RL_XIN_T106.QTYDEL;
                REC_T106.UMINV     := REC_T106.UMORD;
                REC_T106.QTYINV    := REC_T106.QTYORD;
                REC_T106.CODTYPROW := RL_XIN_T106.CODTYPROW;
                REC_T106.CODLIST   := RL_XIN_T106.CODLIST;
                REC_T106.DTEDELIV  := TO_DATE(RL_XIN_T106.DTEDELIV, C_SAP_FORMAT_DATE);
                REC_T106.DTEPROPDELIV := TO_DATE(RL_XIN_T106.DTEPROPDELIV, C_SAP_FORMAT_DATE);
                REC_T106.CODSTATUS    := RL_XIN_T106.CODSTATUS;
                REC_T106.CODSHIPPER   := RL_XIN_T106.CODSHIPPER;
                REC_T106.NUMDOCREF    := RL_XIN_T106.NUMDOCREF;
                REC_T106.DTEDOCREF    := TO_DATE(RL_XIN_T106.DTEDOCREF, C_SAP_FORMAT_DATE);
                REC_T106.GROSSAMOUNT  := RL_XIN_T106.GROSSAMOUNT;
                REC_T106.NUMINV       := RL_XIN_T106.NUMINV;
                REC_T106.NETAMOUNT    := RL_XIN_T106.NETAMOUNT;
                REC_T106.DTEINV       := TO_DATE(RL_XIN_T106.DTEINV, C_SAP_FORMAT_DATE);
                REC_T106.TAXAMOUNT    := RL_XIN_T106.TAXAMOUNT;
                REC_T106.VATAMOUNT    := RL_XIN_T106.VATAMOUNT;
                REC_T106.INCREASEAMOUNT :=  RL_XIN_T106.INCREASEAMOUNT;
                REC_T106.DISCOUNTAMOUNT :=  RL_XIN_T106.DISCOUNTAMOUNT;
                REC_T106.GIFTAMOUNT     :=  RL_XIN_T106.GIFTAMOUNT;
                REC_T106.ENDUSERPRICE   :=  RL_XIN_T106.ENDUSERPRICE;
                REC_T106.CODAZCAPP      :=  RL_XIN_T106.CODAZCAPP;
                REC_T106.FLGEFFBCKORD   :=  RL_XIN_T106.FLGEFFBCKORD;
                REC_T106.CODBCKORDCAUSE :=  RL_XIN_T106.CODBCKORDCAUSE;
                REC_T106.GROSSARTAMOUNT :=  RL_XIN_T106.GROSSARTAMOUNT;
                REC_T106.NETARTAMOUNT   :=  RL_XIN_T106.NETARTAMOUNT;
                REC_T106.CODSRC         :=  RL_XIN_T106.CODSRC;
                REC_T106.CODSRCREF      :=  RL_XIN_T106.CODSRCREF;
                REC_T106.CODBENCAUSE    :=  RL_XIN_T106.CODBENCAUSE;
                REC_T106.CODBENSUBCAUSE :=  RL_XIN_T106.CODBENSUBCAUSE;
                REC_T106.BENNOTE        :=  RL_XIN_T106.BENNOTE;
                REC_T106.AZCTOAPPLY     :=  RL_XIN_T106.AZCTOAPPLY;
                REC_T106.CODOPERATION   :=  RL_XIN_T106.CODOPERATION;
                REC_T106.DISCOUNTAMOUNTOUTINV :=  RL_XIN_T106.DISCOUNTAMOUNTOUTINV;
                REC_T106.CODACCAPP            :=  RL_XIN_T106.CODACCAPP;
                REC_T106.CODTYPROWCAUSE       :=  RL_XIN_T106.CODTYPROWCAUSE;
                REC_T106.CODARTCUST           :=  RL_XIN_T106.CODARTCUST;
                REC_T106.QTYRESO              :=  RL_XIN_T106.QTYRESO;
                REC_T106.NUMORDRESO           :=  RL_XIN_T106.NUMORDRESO;
                REC_T106.CODBLCCAUSE          :=  RL_XIN_T106.CODBLCCAUSE;
                REC_T106.CODARTKITREF         :=  RL_XIN_T106.CODARTKITREF;
                REC_T106.NUMROWKITREF         :=  RL_XIN_T106.NUMROWKITREF;
                REC_T106.CODCAUSEKIT          :=  RL_XIN_T106.CODCAUSEKIT;
                REC_T106.NETARTAMOUNTTEO      :=  RL_XIN_T106.NETARTAMOUNTTEO;
                REC_T106.NETAMOUNTTEO         :=  RL_XIN_T106.NETAMOUNTTEO;
                REC_T106.NETAMOUNTMIN         :=  RL_XIN_T106.NETAMOUNTMIN;
                REC_T106.NETAMOUNTMAX         :=  RL_XIN_T106.NETAMOUNTMAX;
                REC_T106.NETDIFF              :=  RL_XIN_T106.NETDIFF;
                REC_T106.COD_ABBINAMENTO_KIT  :=  RL_XIN_T106.COD_ABBINAMENTO_KIT;
                REC_T106.NUMROWORIG           :=  RL_XIN_T106.NUMROWORIG;
                REC_T106.FLGFIRSTSON          :=  RL_XIN_T106.FLGFIRSTSON;
                REC_T106.NETARTAMOUNTCUST     :=  RL_XIN_T106.NETARTAMOUNTCUST;
                REC_T106.NETARTAMOUNTCUST2    :=  RL_XIN_T106.NETARTAMOUNTCUST2;
                REC_T106.GROSSARTAMOUNTCUST   :=  RL_XIN_T106.GROSSARTAMOUNTCUST;
                REC_T106.NETAMOUNTCUST        :=  RL_XIN_T106.NETAMOUNTCUST;
                REC_T106.QTYORDEDI            :=  RL_XIN_T106.QTYORDEDI;
                REC_T106.CODEAN               :=  RL_XIN_T106.CODEAN;
                REC_T106.UMORDEDI             :=  RL_XIN_T106.UMORDEDI;
                REC_T106.NUMROWREF            :=  RL_XIN_T106.NUMROWREF;
                REC_T106.FLGOMGPROMO          :=  RL_XIN_T106.FLGOMGPROMO;
                REC_T106.GROSSARTAMOUNTORD    :=  RL_XIN_T106.GROSSARTAMOUNTORD;
                REC_T106.GROSSARTAMOUNTDELTA  :=  RL_XIN_T106.GROSSARTAMOUNTDELTA;
                REC_T106.FLGOMGDISCLIST       :=  RL_XIN_T106.FLGOMGDISCLIST;
                REC_T106.CODCNVPDA            :=  RL_XIN_T106.CODCNVPDA;
                REC_T106.DTEEVA               :=  TO_DATE(RL_XIN_T106.DTEEVA, C_SAP_FORMAT_DATE);
                REC_T106.CODPAYTRM            :=  RL_XIN_T106.CODPAYTRM;
                REC_T106.CODPAYMOD            :=  RL_XIN_T106.CODPAYMOD;
                REC_T106.NUMROWHOST           :=  RL_XIN_T106.NUMROWHOST;
                REC_T106.CODMODSHIP           :=  RL_XIN_T106.CODMODSHIP;
                REC_T106.CODMODDELIV          :=  RL_XIN_T106.CODMODDELIV;
                REC_T106.DTEPRICE             :=  TO_DATE(RL_XIN_T106.DTEPRICE, C_SAP_FORMAT_DATE);
                REC_T106.DTEDELIVTO           :=  TO_DATE(RL_XIN_T106.DTEDELIVTO, C_SAP_FORMAT_DATE);
                REC_T106.CODROWGROUP          :=  RL_XIN_T106.CODROWGROUP;
                REC_T106.NETAMOUNTGIFT        :=  RL_XIN_T106.NETAMOUNTGIFT;
                REC_T106.NETARTAMOUNTEDI      :=  RL_XIN_T106.NETARTAMOUNTEDI;
                REC_T106.GROSSARTAMOUNTEDI    :=  RL_XIN_T106.GROSSARTAMOUNTEDI;
                REC_T106.QTYORDORIG           :=  RL_XIN_T106.QTYORDORIG;
                REC_T106.QTYALLOCATED         :=  RL_XIN_T106.QTYALLOCATED;
                REC_T106.RETURNAMOUNT         :=  RL_XIN_T106.RETURNAMOUNT;
                REC_T106.NUMORDHOST           :=  RL_XIN_T100.NUMORDHOST;
                REC_T106.CODWHS               :=  RL_XIN_T100.CODWHS;
              END IF;
              
              IF (VL_STATUS <> 0) THEN
                VL_MESSAGE_H := SUBSTR(VL_MESSAGE_H || ' ' || VL_MESSAGE_D,1,4000);
                PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                               VL_PROGR_D_T106,
                                               SQLCODE,
                                               VL_MESSAGE_H);
              ELSE

                VL_INS_UPD := NULL;
                -- Recognize order lines; inserts new rows ; check the row
                LOAD_T10X_ROW_STEP2(PI_PROGR_H,
                                    VL_PROGR_D_T106,
                                    REC_T106,
                                    VL_INS_UPD,
                                    VL_STATUS);

              END IF;
              
              IF (VL_STATUS = 0) then
                IF (VL_INS_UPD = 'UPD') THEN
                  VL_MESSAGE_D := 'Update T106 ';
                  UPDATE T106ORDROW
                     SET UMORD = REC_T106.UMORD,
                         DESART = REC_T106.DESART,
                         QTYORD = REC_T106.QTYORD,
                         QTYINV = REC_T106.QTYINV,
                         QTYBCKORD = REC_T106.QTYBCKORD,
                         CODSTATUS = REC_T106.CODSTATUS,
                         NUMORDHOST = REC_T106.NUMORDHOST,
                         NUMROWHOST = REC_T106.NUMROWHOST
                   WHERE NUMORD = REC_T106.NUMORD
                     AND NUMROW = REC_T106.NUMROW;
                ELSE
                  -- record does not exists , we insert it
                  VL_MESSAGE_D := 'Insert T106 ';
                  INSERT INTO T106ORDROW VALUES REC_T106;
                END IF;
                
                VL_INS_T106 := VL_INS_T106 + 1;
              END IF;

            END LOOP;
          END IF;
        EXCEPTION
          WHEN OTHERS THEN
            VL_STATUS := -1;
            VL_MESSAGE_H := SUBSTR(VL_MESSAGE_H || ' ' || VL_MESSAGE_D || ' ' || dbms_utility.format_error_backtrace() || ' ' || SQLERRM,1,4000);
            PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                           VL_PROGR_D_T106,
                                           SQLCODE,
                                           VL_MESSAGE_H);
        END;

        -- Update T100 if checks have been completed successfully
        IF (VL_STATUS = 0) THEN
          
          VL_MESSAGE_D := 'Update T100ORDHEAD ';
          UPDATE T100ORDHEAD
             SET -- when the field si set to updated by host it means that the value should be read from XIN
                 -- otherwise it means that the field is managed by sm1 and it maintains its original value
                 CODEUSR              = REC_T100.CODEUSR,
                 CODTYPORD            = REC_T100.CODTYPORD,
                 CODSTATUS            = REC_T100.CODSTATUS,
                 CODDIV               = REC_T100.CODDIV,
                 DTEORD               = REC_T100.DTEORD,
                 DTEDELIV             = REC_T100.DTEDELIV,
                 DTEEVA               = REC_T100.DTEEVA,
                 CODPAYTRM            = REC_T100.CODPAYTRM,
                 CODPAYMOD            = REC_T100.CODPAYMOD,
                 CODCUSTDELIV         = REC_T100.CODCUSTDELIV,
                 CODVATMGMT           = REC_T100.CODVATMGMT,
                 CODCUSTINV           = GET_CUSTOMER_CODE(REC_T100.CODDIV,REC_T100.CODCUSTINV),
                 CODCUR               = REC_T100.CODCUR,
                 NUMORDREF            = REC_T100.NUMORDREF,
                 NUMORDHOST           = REC_T100.NUMORDHOST,
                 NUMORDCUST           = REC_T100.NUMORDCUST,
                 DTEORDCUST           = REC_T100.DTEORDCUST,
                 CODMODSHIP           = REC_T100.CODMODSHIP,
                 CODAGREEMENT         = REC_T100.CODAGREEMENT,
                 DTEAUT               = REC_T100.DTEAUT,
                 GROSSAMOUNT          = REC_T100.GROSSAMOUNT,
                 NETAMOUNT            = REC_T100.NETAMOUNT,
                 TAXAMOUNT            = REC_T100.TAXAMOUNT,
                 VATAMOUNT            = REC_T100.VATAMOUNT,
                 INCREASEAMOUNT       = REC_T100.INCREASEAMOUNT,
                 DISCOUNTAMOUNT       = REC_T100.DISCOUNTAMOUNT,
                 GIFTAMOUNT           = REC_T100.GIFTAMOUNT,
                 QTYTOT               = REC_T100.QTYTOT,
                 UMQTYTOT             = REC_T100.UMQTYTOT,
                 FLGRETURN            = REC_T100.FLGRETURN,
                 FLGHOSTED            = REC_T100.FLGHOSTED,
                 FLGCONFIRMED         = REC_T100.FLGCONFIRMED,
                 CODWHS               = REC_T100.CODWHS,
                 DTEPRICE             = REC_T100.DTEPRICE,
                 FLGCHECKPROMO        = REC_T100.FLGCHECKPROMO,
                 DISCOUNTAMOUNTOUTINV = REC_T100.DISCOUNTAMOUNTOUTINV,
                 DTEDELIVTO           = REC_T100.DTEDELIVTO,
                 FLGUMORD2            = REC_T100.FLGUMORD2,
                 NETAMOUNTTEO         = REC_T100.NETAMOUNTTEO,
                 NETAMOUNTMIN         = REC_T100.NETAMOUNTMIN,
                 NETAMOUNTMAX         = REC_T100.NETAMOUNTMAX,
                 BACKAMOUNT           = REC_T100.BACKAMOUNT,
                 TOTPALLETS           = REC_T100.TOTPALLETS,
                 GROSSWEIGHT          = REC_T100.GROSSWEIGHT,
                 TOTMC                = REC_T100.TOTMC,
                 DTEPROPDELIV         = REC_T100.DTEPROPDELIV,
                 FLGPROCESSEDEDI      = REC_T100.FLGPROCESSEDEDI,
                 FLGEDI               = REC_T100.FLGEDI,
                 DTEDELIV2            = REC_T100.DTEDELIV2,
                 DTEDELIV3            = REC_T100.DTEDELIV3,
                 DTEDELIV4            = REC_T100.DTEDELIV4,
                 DTECLOSE             = REC_T100.DTECLOSE,
                 FLGPROCESSEDASSET    = REC_T100.FLGPROCESSEDASSET,
                 --- Technical fields
                 CODUSRMOD = REC_T100.CODUSRMOD,
                 DTEMOD    = REC_T100.DTEMOD,
                 -- lock fields
                 CODUSRLCK    = REC_T100.CODUSRLCK,
                 IDSESSIONLCK = REC_T100.IDSESSIONLCK,
                 DTELCK       = REC_T100.DTELCK

           WHERE NUMORD = REC_T100.NUMORD
             AND CODUSR = REC_T100.CODUSR
             AND (IDSESSIONLCK = REC_T100.IDSESSIONLCK OR NOT EXISTS
                   (SELECT NULL FROM T035LOGGEDUSERS T035 WHERE T035.IDSESSION = NVL(IDSESSIONLCK, '@') AND T035.LASTCHECK > TRUNC(XSYSDATE)-1 ));

        END IF;        
        
      EXCEPTION
        WHEN OTHERS THEN
          VL_STATUS := -1;
          VL_MESSAGE_H := SUBSTR(VL_MESSAGE_H || ' ' || VL_MESSAGE_D || ' ' || dbms_utility.format_error_backtrace() || ' ' || SQLERRM,1,4000);
          PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                         VL_PROGR_D_T100,
                                         SQLCODE,
                                         VL_MESSAGE_H);

      END;

      -- if all records have been stored with success then it makes the final commit
      IF VL_STATUS = 0 THEN
         VL_INS_T100 := VL_INS_T100 + 1;
      END IF;

      IF (VL_STATUS <> 0 OR VL_RECORD_LOCKED <> 0) THEN
        UPDATE XIN_T106ORDROW
           SET SM1_STATUS = CASE
                              WHEN VL_RECORD_LOCKED <> 0 THEN
                               C_XINSTATUS_LOCK
                              ELSE
                               C_XINSTATUS_ERR
                            END
         WHERE CODUSR = RL_XIN_T100.CODUSR
           AND SM1_CODPROCESS = PI_PROGR_H
           AND SM1_DTECRE = RL_XIN_T100.SM1_DTECRE
           AND SM1_STATUS = C_XINSTATUS_OK;
            
        -- TO CHECK this update is not correct in case of double record .
        UPDATE XIN_T100ORDHEAD
           SET SM1_STATUS = CASE
                              WHEN VL_RECORD_LOCKED <> 0 THEN
                               C_XINSTATUS_LOCK
                              ELSE
                               C_XINSTATUS_ERR
                            END
         WHERE CODUSR = RL_XIN_T100.CODUSR
           AND SM1_CODPROCESS = PI_PROGR_H
           AND SM1_DTECRE <= RL_XIN_T100.SM1_DTECRE
           AND SM1_STATUS = C_XINSTATUS_OK;
        COMMIT;
      END IF;

      -- Release updated records
      UPDATE T100ORDHEAD
         SET DTELCK = NULL, IDSESSIONLCK = NULL, CODUSRLCK = NULL
       WHERE CODUSR = REC_T100.CODUSR
         AND CODUSRLCK = C_SYSUSR
         AND IDSESSIONLCK = PI_SESSION_ID;
    END LOOP;
    COMMIT;

    -- Moves records from staging area to log staging area
    P_XIN_MOVE_TO_LOG(PI_PROGR_H, VL_PROGR_D_T100,'T106ORDROW');
    P_XIN_MOVE_TO_LOG(PI_PROGR_H, VL_PROGR_D_T100,'T100ORDHEAD');

    -- Close Logs
    PKG_UTILS.LOG_END_DETAIL(PI_PROGR_H,
                             VL_PROGR_D_T106,
                             0,
                             VL_COUNT_XIN_T106,
                             VL_INS_T106,
                             VL_COUNT_XIN_T106 - VL_INS_T106);

    PKG_UTILS.LOG_END_DETAIL(PI_PROGR_H,
                             VL_PROGR_D_T100,
                             0,
                             VL_COUNT_XIN_T100,
                             VL_INS_T100,
                             VL_COUNT_XIN_T100 - VL_INS_T100);

    PO_MSG    := VL_INS_T100||'/'||VL_COUNT_XIN_T100||' Orders loaded';
    PO_STATUS := VL_INS_T100;
    --
  EXCEPTION
    WHEN EX_EXIT THEN

      ROLLBACK;
      VL_MESSAGE_H       := VL_MESSAGE_H || TRIM(SUBSTR(dbms_utility.format_error_backtrace() || ' ' || SQLERRM, 1, 255));
      PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                     VL_PROGR_D_T100,
                                     SQLCODE,
                                     VL_MESSAGE_H);

      PO_MSG := VL_MESSAGE_H;
      PO_STATUS := -1;

    WHEN OTHERS THEN

      ROLLBACK;
      UPDATE T100ORDHEAD
      SET       DTELCK          = NULL,
                IDSESSIONLCK    = NULL,
                CODUSRLCK       = NULL
      WHERE CODUSRLCK = C_SYSUSR AND IDSESSIONLCK = PI_SESSION_ID;
      COMMIT;
      -- Moves records from staging area to log staging area
      P_XIN_MOVE_TO_LOG(PI_PROGR_H, VL_PROGR_D_T100,'T106ORDROW');
      P_XIN_MOVE_TO_LOG(PI_PROGR_H, VL_PROGR_D_T100,'T100ORDHEAD');

      VL_MESSAGE_H       := VL_MESSAGE_H || TRIM(SUBSTR(dbms_utility.format_error_backtrace() || ' ' || SQLERRM, 1, 255));

      PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                     VL_PROGR_D_T100,
                                     SQLCODE,
                                     VL_MESSAGE_H);

      PO_MSG := VL_MESSAGE_H;
      PO_STATUS := VL_STATUS;
  END LOAD_T100_ORDERS_51_SYG;
  
  /*============================================================================*\
    Name: LOAD_T100_ORDERS_KD_SYG
    
    Loads SM1 tables:
        • T100ORDHEAD- Order Head
        • T106ORDROW  - Order Row
        
    Staging Area (SSA) tables, Chronological Order expected in SSA (for each decode set):
        1.  XIN_T100ORDHEAD
        2.  XIN_T106ORDROW

    Loading logic:
      UPDATE+INSERT
      Steps:
      
       1- Recognize SM1 order from external order SAP
           XIN_T100.NUMORDREF not null : it is a SM1 Order
           XIN_T100.NUMORDREF is null : it is an external Order
          then it must be populated:
               XIN_T100.NUMORDHOST : order unique code from erp
               XIN_T100.CODUSR : erp dummy user "SAP"

       2- assign new NUMORD to external order SAP/JDE/Others
       3- row matching (logically cancel the no more present  - add new rows -- determine new numrow)
       4- determine row status from quantities (backorder-delivered-cancelled)----
       5- detrmine head status from row status
       6- calculate header quantities

    Validity Checks:
        • Orders found on staging area are loaded to SM1 main tables only if they are not already opened for update by a SM1 user. In that case records remain in staging area ready to be loaded on next import run.
        • Detail Records found on XIN_T106ORDROW are loaded only if there is the head record in XIN_T100ORDHEAD.

    Error handling:
        • All Errors will be logged in T852/T854 SM1 log tables and all staging area records will be stored into staging area log with sm1_status = 9.
        • Error on head record,  it is discarded with all its details.
        • Error on detail record, it is discarded and import procedure skips to next detail.

    How to delete
        • You cannot delete an order by  ERP interface, you can set it to CANCELLED status

    Input parameters :     PI_PROGR_H       - unique sm1 job number ( T800SYSTEMACTIVITYLOG )
                           PI_SESSION_ID    - unique login session (T035LOGGEDUSERS)

    Outputparameters :     PO_MSG           - message of error if procedure exit with error
                           PO_STATUS        - 0 OK; -1 Error
   Author : ravi.gopeechund.sa@everis.com
   Creation Date : 03/03/2021
   ----
  ============================================================================ */
  PROCEDURE LOAD_T100_ORDERS_KD_SYG(PI_PROGR_H     IN NUMBER,
                                    PI_SESSION_ID  IN NUMBER,
                                    PO_MSG         OUT NOCOPY VARCHAR2,
                                    PO_STATUS      OUT NOCOPY NUMBER ) IS
    -- -----------------------------------------
    -- Cursor on Order Heads xin_t100ordhead
    -- -----------------------------------------
    CURSOR CL_XIN_T100 IS
      SELECT *
        FROM XIN_T100ORDHEAD
       WHERE SM1_CODPROCESS = PI_PROGR_H
       ORDER BY NUMORDHOST, SM1_DTECRE;
    -- -----------------------------------------
    -- Cursor on Order Rows xin_t106_ordrow
    -- -----------------------------------------
    CURSOR CL_XIN_T106(CI_NUMORD VARCHAR2) IS
      SELECT ORDROW.*, T.Codwhs AS VANWHS
        FROM XIN_T106ORDROW ORDROW
       INNER JOIN T100ORDHEAD T
          ON ORDROW.NUMORD = T.NUMORD
       WHERE ORDROW.NUMORD = CI_NUMORD
         AND ORDROW.SM1_CODPROCESS = PI_PROGR_H
         AND ORDROW.SM1_STATUS = C_XINSTATUS_OK
       ORDER BY ORDROW.NUMROW;
    --

    VL_MESSAGE_H   VARCHAR2(4000) := 'Error while loading Orders T100/T106';
    VL_MESSAGE_D   VARCHAR2(4000) := NULL;
    --
    VL_PROGR_D_T100    NUMBER := 0;
    VL_COUNT_XIN_T100  NUMBER := 0;
    VL_INS_T100        NUMBER := 0;
    VL_FLG_BCKORD      NUMBER := 0;
    --
    VL_PROGR_D_T106    NUMBER := 0;
    VL_COUNT_XIN_T106  NUMBER := 0;
    VL_INS_T106        NUMBER := 0;
    --
    REC_T100      T100ORDHEAD%ROWTYPE    := NULL;
    REC_T100_INIT T100ORDHEAD%ROWTYPE    := NULL;
    REC_T106      T106ORDROW%ROWTYPE := NULL;
    REC_T106_INIT T106ORDROW%ROWTYPE := NULL;
    --
    VL_DES_T100     X_FIELD_INFO_ARRAY;
    VL_DES_T106     X_FIELD_INFO_ARRAY;
    --
    VL_RECORD_LOCKED NUMBER := 0;

    VL_STATUS NUMBER:= 0;
    VL_STEP   NUMBER:= 0; -- Used to ping t035
    --
    EX_EXIT  EXCEPTION;
    --
    vl_ins_upd VARCHAR2(3) := NULL;

  BEGIN

    -- init indexes and rebuild statistics
    P_XIN_INIT_INDEXES (PI_PROGR_H, 'T100ORDHEAD');
    P_XIN_INIT_INDEXES (PI_PROGR_H, 'T106ORDROW');
    -- clean log
    P_XIN_CLEANUP_LOG (PI_PROGR_H, 'T100ORDHEAD');
    P_XIN_CLEANUP_LOG (PI_PROGR_H, 'T106ORDROW');

    VL_PROGR_D_T100 := PKG_UTILS.LOG_NEW_DETAIL(PI_PROGR_H,
                                       'ORDER HEAD',
                                       'IMPORT --> KD orders for SYG division (Order type=0)',
                                        0,
                                        NULL);
    VL_PROGR_D_T106 := PKG_UTILS.LOG_NEW_DETAIL(PI_PROGR_H,
                                       'ORDER ROWS',
                                       'IMPORT --> KD orders for SYG division (Order type=0)',
                                        0,
                                        NULL);

    -- retrieves configuration parameters
    LOAD_T10X_CONF_STEP0(VL_MESSAGE_H,VL_STATUS);

    IF (VL_STATUS <> 0) THEN
      PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                     VL_PROGR_D_T100,
                                     SQLCODE,
                                     VL_MESSAGE_H);

      RAISE EX_EXIT;
    END IF;
    
    -- --------------------------------------------------------------
    -- Identifies Xin records to be loaded
    -- --------------------------------------------------------------
    BEGIN
      
      VL_MESSAGE_D := 'XIN_T100ORDHEAD';
      UPDATE XIN_T100ORDHEAD
         SET SM1_CODPROCESS = PI_PROGR_H,
             SM1_STATUS     = 0,
             SM1_DTEPROCESS = XSYSDATE
       WHERE NVL(SM1_CODPROCESS, 0) = C_SM1_NULL_CODPROCESS
         AND CODTYPORD = '0'
         AND CODSTATUS = '15';
      VL_COUNT_XIN_T100 := SQL%ROWCOUNT;
      
      VL_MESSAGE_D := 'XIN_T106ORDROW';
      UPDATE XIN_T106ORDROW D
         SET D.SM1_CODPROCESS = PI_PROGR_H,
             D.SM1_STATUS     = 0,
             D.SM1_DTEPROCESS = XSYSDATE
       WHERE NVL(D.SM1_CODPROCESS, 0) = C_SM1_NULL_CODPROCESS
         AND D.NUMORD IN
             (SELECT H.NUMORD
                FROM XIN_T100ORDHEAD H
               WHERE H.SM1_CODPROCESS = PI_PROGR_H);
               
      VL_COUNT_XIN_T106 := SQL%ROWCOUNT;
      COMMIT;
      
    EXCEPTION
      WHEN OTHERS THEN
        ROLLBACK;
        VL_MESSAGE_H := 'Error while Reading Staging area: ' || VL_MESSAGE_D || TRIM(SUBSTR(dbms_utility.format_error_backtrace() || ' ' || SQLERRM, 1, 255));
        RAISE EX_EXIT;
    END;

    -- --------------------------------------------------------------
    -- loop in main table T100ORDHEAD
    -- --------------------------------------------------------------
    FOR RL_XIN_T100 IN CL_XIN_T100 LOOP
      
      -- pings to t035 every 100 cicles--
      VL_STEP := VL_STEP + 1;
      IF ( MOD(VL_STEP, 100) = 0 ) THEN
        PKG_UTILS.user_ping(PI_SESSION_ID);
      END IF;

      --
      VL_STATUS := 0;
      VL_MESSAGE_H := 'Order NumordHost : ' || RL_XIN_T100.NUMORDHOST || ' Format Conversion => ';
      --
      BEGIN
        
        -- Data Format Check
        REC_T100 := REC_T100_INIT;
        
        -- 1. Check and log error if Order number is null
        IF (RL_XIN_T100.NUMORD IS NULL) THEN
          VL_STATUS := -1;
          VL_MESSAGE_H := VL_MESSAGE_H || ' / ' || 'Order number (NUMORD) is mandatory';
        END IF;
        
        -- 2. Check and log error if User code is null
        IF (RL_XIN_T100.CODUSR IS NULL) THEN
          VL_STATUS := -1;
          VL_MESSAGE_H := VL_MESSAGE_H || ' / ' || 'User code (CODUSR) is mandatory';
        END IF;

        -- 3. Check and log error if Order type is null
        IF (RL_XIN_T100.CODTYPORD IS NULL) THEN
          VL_STATUS := -1;
          VL_MESSAGE_H := VL_MESSAGE_H || ' / ' || 'Order type (CODTYPORD) is mandatory';
        END IF;
        
        -- 4. Check and log error if Division code is null
        IF (RL_XIN_T100.CODDIV IS NULL) THEN
          VL_STATUS := -1;
          VL_MESSAGE_H := VL_MESSAGE_H || ' / ' || 'Division code (CODDIV) is mandatory';
        END IF;
        
        -- 5. Check and log error if Order date is null
        IF (RL_XIN_T100.DTEORD IS NULL) THEN
          VL_STATUS := -1;
          VL_MESSAGE_H := VL_MESSAGE_H || ' / ' || 'Order date (DTEORD) is mandatory';
        END IF;
        
        -- 6. Check and log error if Order delivery date is null
        IF (RL_XIN_T100.DTEDELIV IS NULL) THEN
          VL_STATUS := -1;
          VL_MESSAGE_H := VL_MESSAGE_H || ' / ' || 'Order delivery date (DTEDELIV) is mandatory';
        END IF;
        
        -- 7. Check and log error if Delivery customer code is null
        IF (RL_XIN_T100.CODCUSTDELIV IS NULL) THEN
          VL_STATUS := -1;
          VL_MESSAGE_H := VL_MESSAGE_H || ' / ' || 'Delivery customer code (CODCUSTDELIV) is mandatory';
        END IF;
        
        -- 8. Check and log error if Invoice customer code is null
        IF (RL_XIN_T100.CODCUSTINV IS NULL) THEN
          VL_STATUS := -1;
          VL_MESSAGE_H := VL_MESSAGE_H || ' / ' || 'Invoice customer code (CODCUSTINV) is mandatory';
        END IF;
        
        -- 9. Check and log error if Mobile warehouse code is null
        IF (RL_XIN_T100.CODWHS IS NULL) THEN
          VL_STATUS := -1;
          VL_MESSAGE_H := VL_MESSAGE_H || ' / ' || 'Mobile warehouse code (CODWHS) is mandatory';
        END IF;
        
        IF (VL_STATUS = 0) THEN
          REC_T100.CODUSR               :=  RL_XIN_T100.CODUSR;
          REC_T100.NUMORD               :=  RL_XIN_T100.NUMORD;
          --                         
          REC_T100.CODEUSR              :=  RL_XIN_T100.CODEUSR;
          REC_T100.CODTYPORD            :=  RL_XIN_T100.CODTYPORD;
          REC_T100.CODSTATUS            :=  RL_XIN_T100.CODSTATUS;
          REC_T100.CODDIV               :=  RL_XIN_T100.CODDIV;
          REC_T100.CODBLCCAUSE          :=  RL_XIN_T100.CODBLCCAUSE;
          REC_T100.DTEORD               :=  TO_DATE(RL_XIN_T100.DTEORD, C_SAP_FORMAT_DATE);
          REC_T100.DTEDELIV             :=  TO_DATE(RL_XIN_T100.DTEDELIV, C_SAP_FORMAT_DATE);
          REC_T100.CODTYPDELIV          :=  RL_XIN_T100.CODTYPDELIV;
          REC_T100.DTEEVA               :=  TO_DATE(RL_XIN_T100.DTEEVA, C_SAP_FORMAT_DATE);
          REC_T100.CODPAYTRM            :=  RL_XIN_T100.CODPAYTRM;
          REC_T100.CODPAYMOD            :=  RL_XIN_T100.CODPAYMOD;
          REC_T100.CODCUSTDELIV         :=  RL_XIN_T100.CODCUSTDELIV;
          REC_T100.CODVATMGMT           :=  RL_XIN_T100.CODVATMGMT;
          REC_T100.CODCUSTINV           :=  RL_XIN_T100.CODCUSTINV;
          REC_T100.CODLIST              :=  RL_XIN_T100.CODLIST;
          REC_T100.CODCUR               :=  RL_XIN_T100.CODCUR;
          REC_T100.NUMORDREF            :=  RL_XIN_T100.NUMORDREF;
          REC_T100.NUMORDHOST           :=  RL_XIN_T100.NUMORDHOST;
          REC_T100.NUMORDCUST           :=  RL_XIN_T100.NUMORDCUST;
          REC_T100.DTEORDCUST           :=  TO_DATE(RL_XIN_T100.DTEORDCUST, C_SAP_FORMAT_DATE);
          REC_T100.CODASSORTMENT        :=  RL_XIN_T100.CODASSORTMENT;
          REC_T100.CODCANVASS           :=  RL_XIN_T100.CODCANVASS;
          REC_T100.CODMODSHIP           :=  RL_XIN_T100.CODMODSHIP;
          REC_T100.CODMODDELIV          :=  RL_XIN_T100.CODMODDELIV;
          REC_T100.CODAGREEMENT         :=  RL_XIN_T100.CODAGREEMENT;
          REC_T100.DESAGREEMENT         :=  RL_XIN_T100.DESAGREEMENT;
          REC_T100.CODUSRAUT            :=  RL_XIN_T100.CODUSRAUT;
          REC_T100.CODAGREECLASS        :=  RL_XIN_T100.CODAGREECLASS;
          REC_T100.DTEAUT               :=  TO_DATE(RL_XIN_T100.DTEAUT, C_SAP_FORMAT_DATE);
          REC_T100.CODTYPAUT            :=  RL_XIN_T100.CODTYPAUT;
          REC_T100.DESAUT               :=  RL_XIN_T100.DESAUT;
          REC_T100.GROSSAMOUNT          :=  RL_XIN_T100.GROSSAMOUNT;
          REC_T100.NETAMOUNT            :=  RL_XIN_T100.NETAMOUNT;
          REC_T100.TAXAMOUNT            :=  RL_XIN_T100.TAXAMOUNT;
          REC_T100.VATAMOUNT            :=  RL_XIN_T100.VATAMOUNT;
          REC_T100.INCREASEAMOUNT       :=  RL_XIN_T100.INCREASEAMOUNT;
          REC_T100.DISCOUNTAMOUNT       :=  RL_XIN_T100.DISCOUNTAMOUNT;
          REC_T100.GIFTAMOUNT           :=  RL_XIN_T100.GIFTAMOUNT;
          REC_T100.FLGANN               :=  RL_XIN_T100.FLGANN;
          REC_T100.CODABI               :=  RL_XIN_T100.CODABI;
          REC_T100.CODCAB               :=  RL_XIN_T100.CODCAB;
          REC_T100.DESBAN               :=  RL_XIN_T100.DESBAN;
          REC_T100.DESBRA               :=  RL_XIN_T100.DESBRA;
          REC_T100.DESADDR              :=  RL_XIN_T100.DESADDR;
          REC_T100.DESLOC               :=  RL_XIN_T100.DESLOC;
          REC_T100.DESPRV               :=  RL_XIN_T100.DESPRV;
          REC_T100.QTYTOT               :=  RL_XIN_T100.QTYTOT;
          REC_T100.CODPRV               :=  RL_XIN_T100.CODPRV;
          REC_T100.UMQTYTOT             :=  RL_XIN_T100.UMQTYTOT;
          REC_T100.CODACCOUNT           :=  RL_XIN_T100.CODACCOUNT;
          REC_T100.FLGRETURN            :=  RL_XIN_T100.FLGRETURN;
          REC_T100.FLGHOSTED            :=  RL_XIN_T100.FLGHOSTED;
          REC_T100.FLGCONFIRMED         :=  RL_XIN_T100.FLGCONFIRMED;
          REC_T100.CODWHS               :=  RL_XIN_T100.CODWHS;
          REC_T100.CODSHIPPER           :=  RL_XIN_T100.CODSHIPPER;
          REC_T100.CODAZCAPP            :=  RL_XIN_T100.CODAZCAPP;
          REC_T100.CODAZCBEN            :=  RL_XIN_T100.CODAZCBEN;
          REC_T100.DTEPRICE             :=  TO_DATE(RL_XIN_T100.DTEPRICE, C_SAP_FORMAT_DATE);
          REC_T100.CODTYPSALE           :=  RL_XIN_T100.CODTYPSALE;
          REC_T100.FLGCHECKPROMO        :=  RL_XIN_T100.FLGCHECKPROMO;
          REC_T100.CODAGREETYPE         :=  RL_XIN_T100.CODAGREETYPE;
          REC_T100.CODSTATUSMAN         :=  RL_XIN_T100.CODSTATUSMAN;
          REC_T100.DISCOUNTAMOUNTOUTINV :=  RL_XIN_T100.DISCOUNTAMOUNTOUTINV;
          REC_T100.CODTYPORDCUST        :=  RL_XIN_T100.CODTYPORDCUST;
          REC_T100.CODUSR3              :=  RL_XIN_T100.CODUSR3;
          REC_T100.DTEDELIVTO           :=  TO_DATE(RL_XIN_T100.DTEDELIVTO, C_SAP_FORMAT_DATE);
          REC_T100.CODCIN               :=  RL_XIN_T100.CODCIN;
          REC_T100.FLGUMORD2            :=  RL_XIN_T100.FLGUMORD2;
          REC_T100.NETAMOUNTTEO         :=  RL_XIN_T100.NETAMOUNTTEO;
          REC_T100.NETAMOUNTMIN         :=  RL_XIN_T100.NETAMOUNTMIN;
          REC_T100.NETAMOUNTMAX         :=  RL_XIN_T100.NETAMOUNTMAX;
          REC_T100.CODUSR4              :=  RL_XIN_T100.CODUSR4;
          REC_T100.CODUSR2              :=  RL_XIN_T100.CODUSR2;
          REC_T100.CODBUYEREDI          :=  RL_XIN_T100.CODBUYEREDI;
          REC_T100.CODCUSTINVEDI        :=  RL_XIN_T100.CODCUSTINVEDI;
          REC_T100.CODCUSTDELIVEDI      :=  RL_XIN_T100.CODCUSTDELIVEDI;
          REC_T100.CODSELLEREDI         :=  RL_XIN_T100.CODSELLEREDI;
          REC_T100.CODUSR6              :=  RL_XIN_T100.CODUSR6;
          REC_T100.CODPDV               :=  RL_XIN_T100.CODPDV;
          REC_T100.CODCUSTCONC          :=  RL_XIN_T100.CODCUSTCONC;
          REC_T100.CODIBAN              :=  RL_XIN_T100.CODIBAN;
          REC_T100.BACKAMOUNT           :=  RL_XIN_T100.BACKAMOUNT;
          REC_T100.TOTPALLETS           :=  RL_XIN_T100.TOTPALLETS;
          REC_T100.GROSSWEIGHT          :=  RL_XIN_T100.GROSSWEIGHT;
          REC_T100.TOTMC                :=  RL_XIN_T100.TOTMC;
          REC_T100.DTEPROPDELIV         :=  TO_DATE(RL_XIN_T100.DTEPROPDELIV, C_SAP_FORMAT_DATE);
          REC_T100.CODUSR5              :=  RL_XIN_T100.CODUSR5;
          REC_T100.IDSURVEY             :=  RL_XIN_T100.IDSURVEY;
          REC_T100.CODCUSTSALE          :=  RL_XIN_T100.CODCUSTSALE;
          REC_T100.FLGPROCESSEDEDI      :=  RL_XIN_T100.FLGPROCESSEDEDI;
          REC_T100.FLGEDI               :=  RL_XIN_T100.FLGEDI;
          REC_T100.NUMESENZIONE         :=  RL_XIN_T100.NUMESENZIONE;
          REC_T100.DTEDELIV2            :=  TO_DATE(RL_XIN_T100.DTEDELIV2, C_SAP_FORMAT_DATE);
          REC_T100.DTEDELIV3            :=  TO_DATE(RL_XIN_T100.DTEDELIV3, C_SAP_FORMAT_DATE);
          REC_T100.DTEDELIV4            :=  TO_DATE(RL_XIN_T100.DTEDELIV4, C_SAP_FORMAT_DATE);
          REC_T100.DTEDELIV5            :=  TO_DATE(RL_XIN_T100.DTEDELIV5, C_SAP_FORMAT_DATE);
          REC_T100.IDROUTE              :=  RL_XIN_T100.IDROUTE;
          REC_T100.NUMDOC               :=  RL_XIN_T100.NUMDOC;
          -- DTECLOSE
          IF(LENGTH(TRIM(TO_CHAR(RL_XIN_T100.DTECLOSE))) <> 0 AND RL_XIN_T100.DTECLOSE IS NOT NULL) THEN
            REC_T100.DTECLOSE   := TO_DATE(RL_XIN_T100.DTECLOSE, C_SAP_FORMAT_DATE);
          ELSE
            REC_T100.DTECLOSE   := F_CHECK_FORMAT_D('ALL', TO_DATE(RL_XIN_T100.DTECLOSE, C_SAP_FORMAT_DATE),'DTECLOSE', VL_DES_T100,VL_STATUS, VL_MESSAGE_D);
          END IF;
          REC_T100.RETURNAMOUNT         := RL_XIN_T100.RETURNAMOUNT;
          REC_T100.Z_FLGPICKINGDONE     := RL_XIN_T100.Z_FLGPICKINGDONE;
          REC_T100.Z_FLGCREATEBACKORDER := RL_XIN_T100.Z_FLGCREATEBACKORDER;
          --- Technical fields
          REC_T100.DTECRE     := XSYSDATE;
          REC_T100.CODUSRMOD  := C_SYSUSR;
          REC_T100.DTEMOD     := XSYSDATE;
          REC_T100.CODUSRMODREAL := C_SYSUSR;
          REC_T100.CODUSRCREREAL := C_SYSUSR;
          -- lock fields
          REC_T100.CODUSRLCK     := C_SYSUSR;
          REC_T100.IDSESSIONLCK  := PI_SESSION_ID;
          REC_T100.DTELCK        := XSYSDATE;
        END IF;

        IF (VL_STATUS <> 0) THEN
          VL_MESSAGE_H := SUBSTR(VL_MESSAGE_H || ' ' || VL_MESSAGE_D,1,4000);
          PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                         VL_PROGR_D_T100,
                                         SQLCODE,
                                         VL_MESSAGE_H);
        ELSE
          -- Recocgnize SM1 Orders and fit in REC_T100 record updated values
          -- inserts new orders coming from ERP
          LOAD_T10X_HEAD_STEP1(PI_PROGR_H,
                               VL_PROGR_D_T100,
                               REC_T100,
                               VL_STATUS);
        END IF;
       
        BEGIN
          
          IF (VL_STATUS = 0) THEN
            -- Before updating all rows, we mark them all to recognize those no more sent by ERP
            -- we use a prefix on CODSTATUS
            UPDATE T106ORDROW T
               SET T.codstatus = C_T106_STATUS_PREFIX || t.codstatus,
                   t.qtyord = '0',
                   t.qtyinv = '0'
             WHERE t.numord = REC_T100.NUMORD;
            
            VL_FLG_BCKORD := 0;
            
            FOR RL_XIN_T106 IN CL_XIN_T106(RL_XIN_T100.NUMORD) LOOP

              VL_MESSAGE_H := 'Row info: ' || REC_T100.NUMORD|| '/' ||
                                             REC_T100.CODUSR|| '/' ||
                                             RL_XIN_T100.CODDIV || '/' ||
                                             RL_XIN_T106.NUMROWHOST || ' Format Conversion => ';

              VL_STATUS := 0;
              REC_T106  := REC_T106_INIT;
             
              -- 1. Check and log error if NUMORD is null
              IF (RL_XIN_T106.NUMORD IS NULL) THEN
                VL_STATUS := -1;
                VL_MESSAGE_H := VL_MESSAGE_H || ' / ' || 'Order number (NUMORD) is mandatory';
              END IF;
              
              -- 2. Check and log error if NUMROW is null
              IF (RL_XIN_T106.NUMROW IS NULL) THEN
                VL_STATUS := -1;
                VL_MESSAGE_H := VL_MESSAGE_H || ' / ' || 'Order row number (NUMROW) is mandatory';
              END IF;
              
              -- 3. Check and log error if CODART is null
              IF (RL_XIN_T106.CODART IS NULL) THEN
                VL_STATUS := -1;
                VL_MESSAGE_H := VL_MESSAGE_H || ' / ' || 'Product code (CODART) is mandatory';
              END IF;
              
              -- 4. Check and log error if UMORD is null
              IF (RL_XIN_T106.UMORD IS NULL) THEN
                VL_STATUS := -1;
                VL_MESSAGE_H := VL_MESSAGE_H || ' / ' || 'Order unit of measure (UMORD) is mandatory';
              END IF;
              
              -- 5. Check and log error if DESART is null
              IF (RL_XIN_T106.DESART IS NULL) THEN
                VL_STATUS := -1;
                VL_MESSAGE_H := VL_MESSAGE_H || ' / ' || 'Product description (DESART) is mandatory';
              END IF;
              
              -- 6. Check and log error if QTYORD is null
              IF (RL_XIN_T106.QTYORD IS NULL) THEN
                VL_STATUS := -1;
                VL_MESSAGE_H := VL_MESSAGE_H || ' / ' || 'Ordered quantity (QTYORD) is mandatory';
              END IF;
              
              IF (VL_STATUS = 0) THEN
                REC_T106.NUMORD := REC_T100.NUMORD;
                REC_T106.CODUSR := REC_T100.CODUSR;
                --
                REC_T106.NUMROW    :=  RL_XIN_T106.NUMROW;
                REC_T106.CODART    :=  RL_XIN_T106.CODART;
                REC_T106.CODDIV    :=  RL_XIN_T100.CODDIV;
                REC_T106.UMORD     :=  RL_XIN_T106.UMORD;
                REC_T106.DESART    :=  RL_XIN_T106.DESART;
                REC_T106.QTYORD    :=  RL_XIN_T106.QTYORD;
                REC_T106.QTYBCKORD :=  RL_XIN_T106.QTYBCKORD;
                REC_T106.QTYANN    :=  RL_XIN_T106.QTYANN;
                REC_T106.QTYDEL    :=  RL_XIN_T106.QTYDEL;
                REC_T106.UMINV     :=  REC_T106.UMORD;
                REC_T106.QTYINV    :=  REC_T106.QTYORD;
                REC_T106.CODTYPROW :=  RL_XIN_T106.CODTYPROW;
                REC_T106.CODLIST   :=  RL_XIN_T106.CODLIST;
                REC_T106.DTEDELIV  :=  RL_XIN_T106.DTEDELIV;
                REC_T106.DTEPROPDELIV := RL_XIN_T106.DTEPROPDELIV;
                REC_T106.CODSTATUS    := RL_XIN_T106.CODSTATUS;
                REC_T106.CODSHIPPER   :=  RL_XIN_T106.CODSHIPPER;
                REC_T106.NUMDOCREF    :=  RL_XIN_T106.NUMDOCREF;
                REC_T106.DTEDOCREF    :=  RL_XIN_T106.DTEDOCREF;
                REC_T106.GROSSAMOUNT  :=  RL_XIN_T106.GROSSAMOUNT;
                REC_T106.NUMINV       :=  RL_XIN_T106.NUMINV;
                REC_T106.NETAMOUNT    :=  RL_XIN_T106.NETAMOUNT;
                REC_T106.DTEINV       := RL_XIN_T106.DTEINV;
                REC_T106.TAXAMOUNT    :=  RL_XIN_T106.TAXAMOUNT;
                REC_T106.VATAMOUNT    :=  RL_XIN_T106.VATAMOUNT;
                REC_T106.INCREASEAMOUNT :=  RL_XIN_T106.INCREASEAMOUNT;
                REC_T106.DISCOUNTAMOUNT :=  RL_XIN_T106.DISCOUNTAMOUNT;
                REC_T106.GIFTAMOUNT     :=  RL_XIN_T106.GIFTAMOUNT;
                REC_T106.ENDUSERPRICE   :=  RL_XIN_T106.ENDUSERPRICE;
                REC_T106.CODAZCAPP      :=  RL_XIN_T106.CODAZCAPP;
                REC_T106.FLGEFFBCKORD   :=  RL_XIN_T106.FLGEFFBCKORD;
                REC_T106.CODBCKORDCAUSE :=  RL_XIN_T106.CODBCKORDCAUSE;
                REC_T106.GROSSARTAMOUNT :=  RL_XIN_T106.GROSSARTAMOUNT;
                REC_T106.NETARTAMOUNT   :=  RL_XIN_T106.NETARTAMOUNT;
                REC_T106.CODSRC         :=  RL_XIN_T106.CODSRC;
                REC_T106.CODSRCREF      :=  RL_XIN_T106.CODSRCREF;
                REC_T106.CODBENCAUSE    :=  RL_XIN_T106.CODBENCAUSE;
                REC_T106.CODBENSUBCAUSE :=  RL_XIN_T106.CODBENSUBCAUSE;
                REC_T106.BENNOTE        :=  RL_XIN_T106.BENNOTE;
                REC_T106.AZCTOAPPLY     :=  RL_XIN_T106.AZCTOAPPLY;
                REC_T106.CODOPERATION   :=  RL_XIN_T106.CODOPERATION;
                REC_T106.DISCOUNTAMOUNTOUTINV :=  RL_XIN_T106.DISCOUNTAMOUNTOUTINV;
                REC_T106.CODACCAPP            :=  RL_XIN_T106.CODACCAPP;
                REC_T106.CODTYPROWCAUSE       :=  RL_XIN_T106.CODTYPROWCAUSE;
                REC_T106.CODARTCUST           :=  RL_XIN_T106.CODARTCUST;
                REC_T106.QTYRESO              :=  RL_XIN_T106.QTYRESO;
                REC_T106.NUMORDRESO           :=  RL_XIN_T106.NUMORDRESO;
                REC_T106.CODBLCCAUSE          :=  RL_XIN_T106.CODBLCCAUSE;
                REC_T106.CODARTKITREF         :=  RL_XIN_T106.CODARTKITREF;
                REC_T106.NUMROWKITREF         :=  RL_XIN_T106.NUMROWKITREF;
                REC_T106.CODCAUSEKIT          :=  RL_XIN_T106.CODCAUSEKIT;
                REC_T106.NETARTAMOUNTTEO      :=  RL_XIN_T106.NETARTAMOUNTTEO;
                REC_T106.NETAMOUNTTEO         :=  RL_XIN_T106.NETAMOUNTTEO;
                REC_T106.NETAMOUNTMIN         :=  RL_XIN_T106.NETAMOUNTMIN;
                REC_T106.NETAMOUNTMAX         :=  RL_XIN_T106.NETAMOUNTMAX;
                REC_T106.NETDIFF              :=  RL_XIN_T106.NETDIFF;
                REC_T106.COD_ABBINAMENTO_KIT  :=  RL_XIN_T106.COD_ABBINAMENTO_KIT;
                REC_T106.FLGFIRSTSON          :=  RL_XIN_T106.FLGFIRSTSON;
                REC_T106.NETARTAMOUNTCUST     :=  RL_XIN_T106.NETARTAMOUNTCUST;
                REC_T106.NETARTAMOUNTCUST2    :=  RL_XIN_T106.NETARTAMOUNTCUST2;
                REC_T106.GROSSARTAMOUNTCUST   :=  RL_XIN_T106.GROSSARTAMOUNTCUST;
                REC_T106.NETAMOUNTCUST        :=  RL_XIN_T106.NETAMOUNTCUST;
                REC_T106.QTYORDEDI            :=  RL_XIN_T106.QTYORDEDI;
                REC_T106.CODEAN               :=  RL_XIN_T106.CODEAN;
                REC_T106.UMORDEDI             :=  RL_XIN_T106.UMORDEDI;
                REC_T106.NUMROWREF            :=  RL_XIN_T106.NUMROWREF;
                REC_T106.FLGOMGPROMO          :=  RL_XIN_T106.FLGOMGPROMO;
                REC_T106.GROSSARTAMOUNTORD    :=  RL_XIN_T106.GROSSARTAMOUNTORD;
                REC_T106.GROSSARTAMOUNTDELTA  :=  RL_XIN_T106.GROSSARTAMOUNTDELTA;
                REC_T106.FLGOMGDISCLIST       :=  RL_XIN_T106.FLGOMGDISCLIST;
                REC_T106.CODCNVPDA            :=  RL_XIN_T106.CODCNVPDA;
                REC_T106.DTEEVA               :=  RL_XIN_T106.DTEEVA;
                REC_T106.CODPAYTRM            :=  RL_XIN_T106.CODPAYTRM;
                REC_T106.CODPAYMOD            :=  RL_XIN_T106.CODPAYMOD;
                REC_T106.NUMORDHOST           :=  RL_XIN_T100.NUMORDHOST;
                REC_T106.NUMROWHOST           :=  RL_XIN_T106.NUMROWHOST;
                REC_T106.CODMODSHIP           :=  RL_XIN_T106.CODMODSHIP;
                REC_T106.CODMODDELIV          :=  RL_XIN_T106.CODMODDELIV;
                REC_T106.CODWHS               :=  RL_XIN_T106.VANWHS;
                REC_T106.DTEPRICE             :=  RL_XIN_T106.DTEPRICE;
                REC_T106.DTEDELIVTO           :=  RL_XIN_T106.DTEDELIVTO;
                REC_T106.CODROWGROUP          :=  RL_XIN_T106.CODROWGROUP;
                REC_T106.NETAMOUNTGIFT        :=  RL_XIN_T106.NETAMOUNTGIFT;
                REC_T106.NETARTAMOUNTEDI      :=  RL_XIN_T106.NETARTAMOUNTEDI;
                REC_T106.GROSSARTAMOUNTEDI    :=  RL_XIN_T106.GROSSARTAMOUNTEDI;
                REC_T106.QTYORDORIG           :=  RL_XIN_T106.QTYORDORIG;
                REC_T106.QTYALLOCATED         :=  RL_XIN_T106.QTYALLOCATED;
                REC_T106.RETURNAMOUNT         :=  RL_XIN_T106.RETURNAMOUNT;
                --
                IF((REC_T106.QTYORDORIG) - (REC_T106.QTYORD) > 0) THEN
                  VL_FLG_BCKORD := -1;
                END IF;
              END IF;

              IF (VL_STATUS <> 0) THEN
                VL_MESSAGE_H := SUBSTR(VL_MESSAGE_H || ' ' || VL_MESSAGE_D,1,4000);
                PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                               VL_PROGR_D_T106,
                                               SQLCODE,
                                               VL_MESSAGE_H);
              ELSE
                VL_INS_UPD := NULL;
                -- Recognize order lines; inserts new rows ; check the row
                LOAD_T10X_ROW_STEP2(PI_PROGR_H,
                                    VL_PROGR_D_T106,
                                    REC_T106,
                                    VL_INS_UPD,
                                    VL_STATUS);
              END IF;
              --
              IF (VL_STATUS = 0 ) THEN
                IF (vl_ins_upd = 'UPD') THEN
                  VL_MESSAGE_D := 'Update T106 ';
                    UPDATE T106ORDROW
                       SET UMORD = REC_T106.UMORD,
                           DESART = REC_T106.DESART,
                           QTYORD = REC_T106.QTYORD,
                           QTYBCKORD = REC_T106.QTYBCKORD,
                           QTYINV = REC_T106.QTYINV,
                           CODSTATUS = REC_T106.CODSTATUS,
                           NUMORDHOST = REC_T106.NUMORDHOST,
                           NUMROWHOST = REC_T106.NUMROWHOST,
                           QTYORDORIG = REC_T106.QTYORDORIG,
                           QTYALLOCATED = REC_T106.QTYALLOCATED
                     WHERE NUMORD = REC_T106.NUMORD
                       AND NUMROW = REC_T106.NUMROW;
                ELSE
                    VL_MESSAGE_D := 'Insert T106 ';
                    INSERT INTO T106ORDROW VALUES REC_T106;
                END IF;
                VL_INS_T106 := VL_INS_T106 + 1;
              END IF;
            END LOOP;
          END IF;
        EXCEPTION
          WHEN OTHERS THEN
            VL_STATUS := -1;
            VL_MESSAGE_H := SUBSTR(VL_MESSAGE_H||' '||VL_MESSAGE_D||' '||dbms_utility.format_error_backtrace() || ' ' || SQLERRM,1,4000);
            PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                           VL_PROGR_D_T106,
                                           SQLCODE,
                                           VL_MESSAGE_H);
        END;
      
        IF (VL_STATUS = 0) THEN

          VL_MESSAGE_D := 'Update T100ORDHEAD ';
          UPDATE T100ORDHEAD
             SET -- when the field si set to updated by host it means that the value should be read from XIN
                 -- otherwise it means that the field is managed by sm1 and it maintains its original value
                 CODUSR               = REC_T100.CODUSR,
                 CODEUSR              = REC_T100.CODEUSR,
                 CODTYPORD            = REC_T100.CODTYPORD,
                 CODSTATUS            = REC_T100.CODSTATUS,
                 DTEORD               = REC_T100.DTEORD,
                 DTEDELIV             = REC_T100.DTEDELIV,
                 DTEEVA               = REC_T100.DTEEVA,
                 CODPAYTRM            = REC_T100.CODPAYTRM,
                 CODPAYMOD            = REC_T100.CODPAYMOD,
                 CODCUSTDELIV         = REC_T100.CODCUSTDELIV,
                 CODCUSTINV           = REC_T100.CODCUSTINV,
                 CODCUR               = REC_T100.CODCUR,
                 NUMORDREF            = REC_T100.NUMORDREF,
                 NUMORDHOST           = REC_T100.NUMORDHOST,
                 NUMORDCUST           = REC_T100.NUMORDCUST,
                 DTEORDCUST           = REC_T100.DTEORDCUST,
                 CODMODSHIP           = REC_T100.CODMODSHIP,
                 CODAGREEMENT         = REC_T100.CODAGREEMENT,
                 DTEAUT               = REC_T100.DTEAUT,
                 GROSSAMOUNT          = REC_T100.GROSSAMOUNT,
                 NETAMOUNT            = REC_T100.NETAMOUNT,
                 TAXAMOUNT            = REC_T100.TAXAMOUNT,
                 VATAMOUNT            = REC_T100.VATAMOUNT,
                 INCREASEAMOUNT       = REC_T100.INCREASEAMOUNT,
                 DISCOUNTAMOUNT       = REC_T100.DISCOUNTAMOUNT,
                 GIFTAMOUNT           = REC_T100.GIFTAMOUNT,
                 QTYTOT               = REC_T100.QTYTOT,
                 UMQTYTOT             = REC_T100.UMQTYTOT,
                 FLGRETURN            = REC_T100.FLGRETURN,
                 FLGHOSTED            = REC_T100.FLGHOSTED,
                 FLGCONFIRMED         = REC_T100.FLGCONFIRMED,
                 CODWHS               = REC_T100.CODWHS,
                 CODSHIPPER           = REC_T100.CODSHIPPER,
                 DTEPRICE             = REC_T100.DTEPRICE,
                 FLGCHECKPROMO        = REC_T100.FLGCHECKPROMO,
                 DISCOUNTAMOUNTOUTINV = REC_T100.DISCOUNTAMOUNTOUTINV,
                 DTEDELIVTO           = REC_T100.DTEDELIVTO,
                 FLGUMORD2            = REC_T100.FLGUMORD2,
                 NETAMOUNTTEO         = REC_T100.NETAMOUNTTEO,
                 NETAMOUNTMIN         = REC_T100.NETAMOUNTMIN,
                 NETAMOUNTMAX         = REC_T100.NETAMOUNTMAX,
                 BACKAMOUNT           = REC_T100.BACKAMOUNT,
                 TOTPALLETS           = REC_T100.TOTPALLETS,
                 GROSSWEIGHT          = REC_T100.GROSSWEIGHT,
                 TOTMC                = REC_T100.TOTMC,
                 DTEPROPDELIV         = REC_T100.DTEPROPDELIV,
                 FLGPROCESSEDEDI      = REC_T100.FLGPROCESSEDEDI,
                 FLGEDI               = REC_T100.FLGEDI,
                 DTEDELIV2            = REC_T100.DTEDELIV2,
                 DTEDELIV3            = REC_T100.DTEDELIV3,
                 DTEDELIV4            = REC_T100.DTEDELIV4,
                 Z_FLGPICKINGDONE     = REC_T100.Z_FLGPICKINGDONE,
                 Z_FLGCREATEBACKORDER = VL_FLG_BCKORD,
                 --- Technical fields
                 CODUSRMOD = REC_T100.CODUSRMOD,
                 DTEMOD    = REC_T100.DTEMOD,
                 -- lock fields
                 CODUSRLCK    = REC_T100.CODUSRLCK,
                 IDSESSIONLCK = REC_T100.IDSESSIONLCK,
                 DTELCK       = REC_T100.DTELCK

           WHERE NUMORD = REC_T100.NUMORD
             AND CODUSR = REC_T100.CODUSR
             AND (IDSESSIONLCK = REC_T100.IDSESSIONLCK OR NOT EXISTS
                  (SELECT NULL
                     FROM T035LOGGEDUSERS T035
                    WHERE T035.IDSESSION = NVL(IDSESSIONLCK, '@')
                      AND T035.LASTCHECK > TRUNC(XSYSDATE) - 1));
        END IF;

      EXCEPTION
        WHEN OTHERS THEN
          VL_STATUS := -1;
          VL_MESSAGE_H := SUBSTR(VL_MESSAGE_H||' '||VL_MESSAGE_D||' '||dbms_utility.format_error_backtrace() || ' ' || SQLERRM,1,4000);
          PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                       VL_PROGR_D_T100,
                                       SQLCODE,
                                       VL_MESSAGE_H);
      END;

      -- if all records have been stored with success then it makes the final commit
      IF VL_STATUS = 0 THEN
        VL_INS_T100 := VL_INS_T100 + 1;
      END IF;

      IF (VL_STATUS <> 0 OR VL_RECORD_LOCKED <> 0) THEN
        UPDATE XIN_T106ORDROW
           SET SM1_STATUS = CASE
                              WHEN VL_RECORD_LOCKED <> 0 THEN
                               C_XINSTATUS_LOCK
                              ELSE
                               C_XINSTATUS_ERR
                            END
         WHERE CODUSR = RL_XIN_T100.CODUSR
           AND SM1_CODPROCESS = PI_PROGR_H
           AND SM1_DTECRE = RL_XIN_T100.SM1_DTECRE
           AND SM1_STATUS = C_XINSTATUS_OK;

        -- TO CHECK this update is  not correct in case of double record .
        UPDATE XIN_T100ORDHEAD
           SET SM1_STATUS = CASE
                              WHEN VL_RECORD_LOCKED <> 0 THEN
                               C_XINSTATUS_LOCK
                              ELSE
                               C_XINSTATUS_ERR
                            END
         WHERE CODUSR = RL_XIN_T100.CODUSR
           AND SM1_CODPROCESS = PI_PROGR_H
           AND SM1_DTECRE <= RL_XIN_T100.SM1_DTECRE
           AND SM1_STATUS = C_XINSTATUS_OK;

      END IF;

      -- Release updated records
      UPDATE T100ORDHEAD
         SET DTELCK = NULL, IDSESSIONLCK = NULL, CODUSRLCK = NULL
       WHERE CODUSR = REC_T100.CODUSR
         AND CODUSRLCK = C_SYSUSR
         AND IDSESSIONLCK = PI_SESSION_ID;

    END LOOP;
    COMMIT;

    -- Moves records from staging area to log staging area
    P_XIN_MOVE_TO_LOG(PI_PROGR_H, VL_PROGR_D_T100,'T106ORDROW');
    P_XIN_MOVE_TO_LOG(PI_PROGR_H, VL_PROGR_D_T100,'T100ORDHEAD');

    -- Close Logs
    PKG_UTILS.LOG_END_DETAIL(PI_PROGR_H,
                             VL_PROGR_D_T106,
                             0,
                             VL_COUNT_XIN_T106,
                             VL_INS_T106,
                             VL_COUNT_XIN_T106 - VL_INS_T106);

    PKG_UTILS.LOG_END_DETAIL(PI_PROGR_H,
                             VL_PROGR_D_T100,
                             0,
                             VL_COUNT_XIN_T100,
                             VL_INS_T100,
                             VL_COUNT_XIN_T100 - VL_INS_T100);


    PO_MSG    := VL_INS_T100||'/'||VL_COUNT_XIN_T100||' Orders loaded';
    PO_STATUS := VL_INS_T100;

    --
  EXCEPTION
    WHEN EX_EXIT THEN

      ROLLBACK;
      VL_MESSAGE_H       := VL_MESSAGE_H || TRIM(SUBSTR(dbms_utility.format_error_backtrace() || ' ' || SQLERRM, 1, 255));
      PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                     VL_PROGR_D_T100,
                                     SQLCODE,
                                     VL_MESSAGE_H);

      PO_MSG := VL_MESSAGE_H;
      PO_STATUS := -1;

    WHEN OTHERS THEN

      ROLLBACK;
      -- Release updated records
      UPDATE T100ORDHEAD
         SET DTELCK = NULL, IDSESSIONLCK = NULL, CODUSRLCK = NULL
       WHERE CODUSRLCK = C_SYSUSR
         AND IDSESSIONLCK = PI_SESSION_ID;
      COMMIT;
      -- Moves records from staging area to log staging area
      P_XIN_MOVE_TO_LOG(PI_PROGR_H, VL_PROGR_D_T100,'T106ORDROW');
      P_XIN_MOVE_TO_LOG(PI_PROGR_H, VL_PROGR_D_T100,'T100ORDHEAD');

      VL_MESSAGE_H       := VL_MESSAGE_H || TRIM(SUBSTR(dbms_utility.format_error_backtrace() || ' ' || SQLERRM, 1, 255));

      PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                     VL_PROGR_D_T100,
                                     SQLCODE,
                                     VL_MESSAGE_H);

      PO_MSG := VL_MESSAGE_H;
      PO_STATUS := VL_STATUS;

  END LOAD_T100_ORDERS_KD_SYG;
    
  /*============================================================================*\
    Name: LOAD_TA3100_BUDGET_SYG
    
    Loads SM1 tables:
        • TA3100BUDGETGROUP - Sales budget header 
        • TA3102BUDGET      - Sales budget detail
        • TA3104BUDGETOPERATIONS
        
    Staging Area (SSA) tables:
        1.  XIN_TA3100BUDGET

    Loading logic:
      UPDATE+INSERT

    Validity Checks:
    
    Error handling:
        • All Errors will be logged in T852/T854 SM1 log tables and all staging area records will be stored into staging area log with sm1_status = 9.
        • Error on head record,  it is discarded with all its details.
        • Error on detail record, it is discarded and import procedure skips to next detail.

    How to delete
        • You cannot delete an order by  ERP interface, you can set it to CANCELLED status

    Input parameters :     PI_PROGR_H       - unique sm1 job number (T800SYSTEMACTIVITYLOG)
                           PI_SESSION_ID    - unique login session (T035LOGGEDUSERS)

    Outputparameters :     PO_MSG           - message of error if procedure exit with error
                           PO_STATUS        - 0 OK; -1 Error
   Author : ravi.gopeechund.sa@everis.com
   Creation Date : 03/03/2021
   ----
  ============================================================================ */
  PROCEDURE LOAD_TA3100_BUDGET_SYG(PI_PROGR_H     IN NUMBER,
                                   PI_SESSION_ID  IN NUMBER,
                                   PO_MSG         OUT NOCOPY VARCHAR2,
                                   PO_STATUS      OUT NOCOPY NUMBER ) IS

    CURSOR CL_ROUTES IS
      SELECT BID,
             CODBUDGETTYPE,
             DESBUDGETGROUP,
             CODNATURE,
             CODUM,
             DTESTART,
             DTEEND,
             CODSTATUS,
             FLGNEGATIVEALLOWED,
             CODLEVEL,
             VALDEFAULT,
             CODART,
             CODUSR,
             CODDIV,
             VALBALANCE,
             DTEBALANCECALCULATION,
             CODOPERATIONTYPE,
             VALMOVEMENT,
             ROWNUM
        FROM XIN_TA3100BUDGET
       WHERE SM1STATUS = C_XINSTATUS_LOCK
         AND CODDIV = 'SYG'
       ORDER BY CODOPERATIONTYPE;

    RL_ROUTES CL_ROUTES%ROWTYPE;
    --
    VL_MESSAGE_H         VARCHAR2(4000);
    VL_PRCLOAD           NUMBER(3) := 100;
    VL_FLGSALESREP       NUMBER(3) := -1;
    VL_FLGANN            NUMBER(3) := 0;
    VL_CODUSRCRE         varchar2(100) := 'SYS';
    VL_CODUSRMOD         varchar2(100) := 'SYS';
    VL_IDSESSIONLCK      varchar2(100) := '';
    VL_CODUSRLCK         varchar2(100) := '';
    VL_CODUSRMODREAL     varchar2(100) := 'SYS';
    VL_DOCKEYBUDET       varchar2(255) := 0;
    VL_CODUSRCREREAL     varchar2(100) := 'SYS';
    VL_DOCUMENTKEY       varchar2(255) := 0;
    VL_TRANSACTIONDOCKEY varchar2(100) := '';
    VL_OPDATEMOD         varchar2(100) := '';
    VL_IDBUDGETENDDATEUP varchar2(100) := '';
    --
    VL_IDBUDGETGROUP varchar2(100) := 0;
    VL_IDBUGET       varchar2(100) := 0;
    VL_IDOPERATION   varchar2(100) := 0;
    VL_STATICID      varchar2(100) := 0;
    vl_RecordCount   NUMBER(9) := 0;
    vl_WHS_Count     NUMBER(9) := 0;
    --   
    VL_PROGR_D_T3100    NUMBER := 0;
    VL_COUNT_XIN_T3100  NUMBER := 0;
    VL_INS_T3100        NUMBER := 0;
    VL_STATUS           NUMBER := 0;
    
    EX_EXIT EXCEPTION;
    
  BEGIN
    
    VL_PROGR_D_T3100 := PKG_UTILS.LOG_NEW_DETAIL(PI_PROGR_H,
                                                 'BUDGET HEAD',
                                                 'IMPORT --> Sales budget header for SYG division',
                                                 0,
                                                 NULL);
                                                   
    -- --------------------------------------------------------------
    -- Identifies Xin records to be loaded
    -- --------------------------------------------------------------
    BEGIN
        
      UPDATE XIN_TA3100BUDGET
         SET SM1STATUS = C_XINSTATUS_LOCK
       WHERE SM1STATUS = 0
         AND CODDIV = 'SYG';
      VL_COUNT_XIN_T3100 := SQL%ROWCOUNT;
      COMMIT;
        
    EXCEPTION
      WHEN OTHERS THEN
        ROLLBACK;
        VL_MESSAGE_H := 'Error while Reading Staging area: XIN_TA3100BUDGET' || TRIM(SUBSTR(dbms_utility.format_error_backtrace() || ' ' || SQLERRM, 1, 255));
        RAISE EX_EXIT;
    END;
                                        
    FOR rl_routes IN cl_routes LOOP
      
      VL_STATUS := 0;
      VL_MESSAGE_H := 'DESBUDGETGROUP: ' || rl_routes.DESBUDGETGROUP || '/' ||
                      'DTESTART: ' || rl_routes.DTESTART || '/' ||
                      'DTEEND: ' || rl_routes.DTEEND || '/' ||
                      'CODDIV: ' || rl_routes.CODDIV || ' ';
  
      -- 1. Check and log error if CODBUDGETTYPE is null
      IF (rl_routes.CODBUDGETTYPE IS NULL) THEN
        VL_STATUS := -1;
        VL_MESSAGE_H := VL_MESSAGE_H || ' / ' || 'Budget typology (CODBUDGETTYPE) is mandatory';
      END IF;
  
      -- 2. Check and log error if DESBUDGETGROUP is null
      IF (rl_routes.DESBUDGETGROUP IS NULL) THEN
        VL_STATUS := -1;
        VL_MESSAGE_H := VL_MESSAGE_H || ' / ' || 'Sales budget description (DESBUDGETGROUP) is mandatory';
      END IF;
      
      -- 3. Check and log error if CODBUDGETTYPE is null
      IF (rl_routes.CODNATURE IS NULL) THEN
        VL_STATUS := -1;
        VL_MESSAGE_H := VL_MESSAGE_H || ' / ' || 'Budget nature (CODNATURE) is mandatory';
      END IF; 
  
      -- 4. Check and log error if CODUM is null
      IF (rl_routes.CODUM IS NULL) THEN
        VL_STATUS := -1;
        VL_MESSAGE_H := VL_MESSAGE_H || ' / ' || 'Budget unit of measure (CODUM) is mandatory';
      END IF;
  
      -- 5. Check and log error if DTESTART is null
      IF (rl_routes.DTESTART IS NULL) THEN
        VL_STATUS := -1;
        VL_MESSAGE_H := VL_MESSAGE_H || ' / ' || 'Start date (DTESTART) is mandatory';
      END IF;
  
      -- 6. Check and log error if DTEEND is null
      IF (rl_routes.DTEEND IS NULL) THEN
        VL_STATUS := -1;
        VL_MESSAGE_H := VL_MESSAGE_H || ' / ' || 'End date (DTEEND) is mandatory';
      END IF;
  
      -- 7. Check and log error if CODSTATUS is null
      IF (rl_routes.CODSTATUS IS NULL) THEN
        VL_STATUS := -1;
        VL_MESSAGE_H := VL_MESSAGE_H || ' / ' || 'Sales budget status (CODSTATUS) is mandatory';
      END IF;
  
      -- 8. Check and log error if FLGNEGATIVEALLOWED is null
      IF (rl_routes.FLGNEGATIVEALLOWED IS NULL) THEN
        VL_STATUS := -1;
        VL_MESSAGE_H := VL_MESSAGE_H || ' / ' || 'Flag negative allowed (FLGNEGATIVEALLOWED) is mandatory';
      END IF;
  
      -- 9. Check and log error if CODLEVEL is null
      IF (rl_routes.CODLEVEL IS NULL) THEN
        VL_STATUS := -1;
        VL_MESSAGE_H := VL_MESSAGE_H || ' / ' || 'User level the budget is assigned to (CODLEVEL) is mandatory';
      END IF;
  
      -- 10. Check and log error if VALDEFAULT is null
      IF (rl_routes.VALDEFAULT IS NULL) THEN
        VL_STATUS := -1;
        VL_MESSAGE_H := VL_MESSAGE_H || ' / ' || 'Budgets default initialization value (VALDEFAULT) is mandatory';
      END IF;
  
      -- 11. Check and log error if CODART is null
      IF (rl_routes.CODART IS NULL) THEN
        VL_STATUS := -1;
        VL_MESSAGE_H := VL_MESSAGE_H || ' / ' || 'Product associated with the budget group (CODART) is mandatory';
      END IF;
  
      -- 12. Check and log error if CODUSR is null
      IF (rl_routes.CODUSR IS NULL) THEN
        VL_STATUS := -1;
        VL_MESSAGE_H := VL_MESSAGE_H || ' / ' || 'User associated to the budget (CODUSR) is mandatory';
      END IF;
  
      -- 13. Check and log error if CODDIV is null
      IF (rl_routes.CODDIV IS NULL) THEN
        VL_STATUS := -1;
        VL_MESSAGE_H := VL_MESSAGE_H || ' / ' || 'Division Code (CODDIV) is mandatory';
      END IF;
  
      -- 14. Check and log error if VALBALANCE is null
      IF (rl_routes.VALBALANCE IS NULL) THEN
        VL_STATUS := -1;
        VL_MESSAGE_H := VL_MESSAGE_H || ' / ' || 'Budget balance value (VALBALANCE) is mandatory';
      END IF;
  
      -- 15. Check and log error if DTEBALANCECALCULATION is null
      IF (rl_routes.DTEBALANCECALCULATION IS NULL) THEN
        VL_STATUS := -1;
        VL_MESSAGE_H := VL_MESSAGE_H || ' / ' || 'Budget value last calculation date (DTEBALANCECALCULATION) is mandatory';
      END IF;
  
      -- 16. Check and log error if CODOPERATIONTYPE is null
      IF (rl_routes.CODOPERATIONTYPE IS NULL) THEN
        VL_STATUS := -1;
        VL_MESSAGE_H := VL_MESSAGE_H || ' / ' || 'Operation type (CODOPERATIONTYPE) is mandatory';
      END IF;

      IF (rl_routes.DTESTART >= TRUNC(SYSDATE)) THEN
        IF (VL_STATUS = 0) THEN
      
          vl_RecordCount   := 0;
          vl_WHS_Count     := 0;
          VL_IDBUDGETGROUP := '';
          VL_IDBUGET       := '';
          VL_STATICID      := '';
          VL_DOCUMENTKEY   := '';
          VL_DOCKEYBUDET   := '';
        
          SELECT COUNT(*)
            INTO VL_RECORDCOUNT
            FROM XIN_VIEW_PROC_IMPORTBUDGET
           WHERE TRIM(UPPER(CODBUDGETTYPE)) =
                 TRIM(UPPER(TO_CHAR(RL_ROUTES.CODBUDGETTYPE)))
             AND TRIM(UPPER(CODSTATUS)) = '0'
             AND TRIM(UPPER(CODLEVEL)) = TRIM(UPPER(RL_ROUTES.CODLEVEL))
             AND TRIM(UPPER(CODDIV)) = TRIM(UPPER(TO_CHAR(RL_ROUTES.CODDIV)))
             AND TRIM(UPPER(CODART)) = TRIM(UPPER(TO_CHAR(GET_PRODUCT_CODE(RL_ROUTES.CODDIV,RL_ROUTES.CODART))))
             AND (DTESTART <= RL_ROUTES.DTEEND)
             AND (RL_ROUTES.DTESTART <= DTEEND);
        
          IF (vl_RecordCount = 0) THEN
          
            VL_IDBUDGETGROUP := 0;
            VL_DOCKEYBUDET   := 0;
          
            VL_MESSAGE_H := 'id -  ' || rl_routes.bid;
          
            --// Generating ID here
            SELECT TO_CHAR(SYSTIMESTAMP, 'yyMMddHHmmssFF3')
              INTO VL_IDBUDGETGROUP
              FROM DUAL;
          
            VL_IDBUDGETGROUP := VL_IDBUDGETGROUP + rl_routes.ROWNUM;
            VL_STATICID      := VL_IDBUDGETGROUP;
            VL_IDBUDGETGROUP := CONCAT('000000000000000', VL_IDBUDGETGROUP);
            VL_DOCUMENTKEY   := CONCAT('BudgetGroup|', VL_IDBUDGETGROUP);
          
            INSERT INTO TA3100BUDGETGROUP
              (IDBUDGETGROUP,
               DESBUDGETGROUP,
               CODBUDGETTYPE,
               CODNATURE,
               CODUM,
               DTESTART,
               DTEEND,
               CODSTATUS,
               FLGNEGATIVEALLOWED,
               CODLEVEL,
               CODDIV,
               PRCLOAD,
               FLGSALESREP,
               FLGANN,
               CODUSRCRE,
               DTECRE,
               CODUSRMOD,
               DTEMOD,
               IDSESSIONLCK,
               CODUSRLCK,
               DTELCK,
               DTETOHOST,
               CODUSRMODREAL,
               CODUSRCREREAL,
               DOCUMENTKEY,
               VALDEFAULT,
               CODART)
            VALUES
              (VL_IDBUDGETGROUP,
               trim(rl_routes.DESBUDGETGROUP),
               trim(rl_routes.CODBUDGETTYPE),
               trim(rl_routes.CODNATURE),
               trim(rl_routes.CODUM),
               trim(rl_routes.DTESTART),
               trim(rl_routes.DTEEND),
               trim(rl_routes.CODSTATUS),
               trim(rl_routes.FLGNEGATIVEALLOWED),
               trim(rl_routes.CODLEVEL),
               trim(rl_routes.CODDIV),
               trim(VL_PRCLOAD),
               trim(VL_FLGSALESREP),
               trim(VL_FLGANN),
               trim(VL_CODUSRCRE),
               trim(xsysdate),
               trim(VL_CODUSRMOD),
               trim(xsysdate),
               trim(VL_IDSESSIONLCK),
               trim(VL_CODUSRLCK),
               '',
               '',
               trim(VL_CODUSRMODREAL),
               trim(VL_CODUSRCREREAL),
               trim(VL_DOCUMENTKEY),
               trim(rl_routes.VALDEFAULT),
               trim(GET_PRODUCT_CODE(rl_routes.CODDIV,rl_routes.CODART)));
          
            SELECT CONCAT(TO_CHAR('000000000000000'),
                          to_char(systimestamp, 'yyMMddHHmmssFF3'))
              INTO VL_DOCKEYBUDET
              FROM DUAL;
          
            VL_IDBUGET     := VL_STATICID;
            VL_DOCKEYBUDET := CONCAT('000000000000000',
                                     VL_DOCKEYBUDET + rl_routes.ROWNUM); -- adding rownumber to avoid duplicated when timestap is same
            VL_DOCUMENTKEY := CONCAT('Budget|', VL_DOCKEYBUDET);
          
            INSERT INTO TA3102BUDGET
              (IDBUGET,
               IDBUDGETGROUP,
               CODUSR,
               CODDIV,
               VALBALANCE,
               DTEBALANCECALCULATION,
               DTEEND,
               FLGANN,
               CODUSRCRE,
               DTECRE,
               CODUSRMOD,
               DTEMOD,
               IDSESSIONLCK,
               CODUSRLCK,
               DTELCK,
               DTETOHOST,
               CODUSRMODREAL,
               CODUSRCREREAL,
               DOCUMENTKEY)
            VALUES
              (VL_DOCKEYBUDET,
               VL_IDBUDGETGROUP,
               trim(rl_routes.CODUSR),
               trim(rl_routes.CODDIV),
               trim(rl_routes.VALDEFAULT), -- during initialization VALDEFAULT,VALBALANCE & VALMOVEMENT should be equal
               trim(rl_routes.DTEBALANCECALCULATION),
               trim(rl_routes.DTEEND),
               VL_FLGANN,
               '',
               TO_DATE('12/30/1899', 'MM/DD/YYYY'),
               '',
               xsysdate,
               VL_IDSESSIONLCK,
               VL_CODUSRLCK,
               '',
               '',
               VL_CODUSRMODREAL,
               VL_CODUSRCREREAL,
               VL_DOCUMENTKEY);
          
            SELECT CONCAT(TO_CHAR('000000000000000'),
                          to_char(systimestamp, 'yyMMddHHmmssFF3'))
              INTO VL_IDOPERATION
              FROM DUAL;
          
            INSERT INTO TA3104BUDGETOPERATIONS
              (IDBUGET,
               IDOPERATION,
               CODUSR,
               DTEMOD,
               CODOPERATIONTYPE,
               TRANSACTIONDOCKEY,
               DTETOSERVER,
               VALMOVEMENT)
            VALUES
              (VL_DOCKEYBUDET,
               VL_IDOPERATION,
               VL_CODUSRCRE,
               trim(xsysdate),
               'I',
               VL_TRANSACTIONDOCKEY,
               '',
               trim(rl_routes.VALDEFAULT)); -- during initialization VALDEFAULT,VALBALANCE & VALMOVEMENT should be equal
          
            VL_MESSAGE_H := ' Row Created ';
            INSERT INTO LOG_XIN_TA3100BUDGET
              (logid_xin, discription, status, xin_proc, datetime)
            Values
              (rl_routes.bid,
               VL_MESSAGE_H,
               1,
               'Z_SP_IMPORT_BUDGET_XIN',
               xsysdate);
          
            -- Update SM1 Status in XIN_TA3100BUDGET table as 1
            UPDATE XIN_TA3100BUDGET
               SET sm1status = 1
             WHERE bid = rl_routes.bid;
          
            VL_MESSAGE_H := ' XIN_TA3100BUDGET sm1status = 1 Updated ';
            INSERT INTO LOG_XIN_TA3100BUDGET
              (logid_xin, discription, status, xin_proc, datetime)
            Values
              (rl_routes.bid,
               VL_MESSAGE_H,
               1,
               'Z_SP_IMPORT_BUDGET_XIN',
               xsysdate);
          
          END IF;
        
          IF (vl_RecordCount >= 1) THEN
          
            SELECT COUNT(*)
              INTO vl_whs_Count
              FROM XIN_VIEW_PROC_IMPORTBUDGET
             WHERE TRIM(UPPER(CODBUDGETTYPE)) =
                   TRIM(UPPER(TO_CHAR(rl_routes.CODBUDGETTYPE)))
               AND trim(UPPER(CODSTATUS)) = '0'
               AND TRIM(UPPER(CODLEVEL)) = trim(UPPER(rl_routes.CODLEVEL))
               AND TRIM(UPPER(CODDIV)) = TRIM(UPPER(TO_CHAR(rl_routes.CODDIV)))
               AND TRIM(UPPER(CODART)) = TRIM(UPPER(TO_CHAR(GET_PRODUCT_CODE(RL_ROUTES.CODDIV,RL_ROUTES.CODART))))
               AND TRIM(UPPER(B_CODUSR)) =
                   TRIM(UPPER(TO_CHAR(rl_routes.CODUSR)))
               AND (DTESTART <= rl_routes.DTEEND)
               AND (rl_routes.DTESTART <= DTEEND);
          
            IF (vl_whs_Count >= 1) THEN
            
              SELECT max(C_DTEMOD)
                INTO VL_OPDATEMOD
                FROM XIN_VIEW_PROC_IMPORTBUDGET
               WHERE TRIM(UPPER(CODBUDGETTYPE)) =
                     TRIM(UPPER(TO_CHAR(rl_routes.CODBUDGETTYPE)))
                 AND trim(UPPER(CODSTATUS)) = '0'
                 AND TRIM(UPPER(CODLEVEL)) = trim(UPPER(rl_routes.CODLEVEL))
                 AND TRIM(UPPER(CODDIV)) =
                     TRIM(UPPER(TO_CHAR(rl_routes.CODDIV)))
                 AND TRIM(UPPER(CODART)) =
                     TRIM(UPPER(TO_CHAR(GET_PRODUCT_CODE(RL_ROUTES.CODDIV,RL_ROUTES.CODART))))
                 AND TRIM(UPPER(B_CODUSR)) =
                     TRIM(UPPER(TO_CHAR(rl_routes.CODUSR)))
                 AND (DTESTART <= rl_routes.DTEEND)
                 AND (rl_routes.DTESTART <= DTEEND);
            
              SELECT IDBUDGETGROUP, B_IDBUGET, C_IDOPERATION, DTEEND
                INTO VL_IDBUDGETGROUP,
                     VL_IDBUGET,
                     VL_IDOPERATION,
                     VL_IDBUDGETENDDATEUP
                FROM XIN_VIEW_PROC_IMPORTBUDGET
               WHERE TRIM(UPPER(CODBUDGETTYPE)) =
                     TRIM(UPPER(TO_CHAR(rl_routes.CODBUDGETTYPE)))
                 AND trim(UPPER(CODSTATUS)) = '0'
                 AND TRIM(UPPER(CODLEVEL)) = trim(UPPER(rl_routes.CODLEVEL))
                 AND TRIM(UPPER(CODDIV)) =
                     TRIM(UPPER(TO_CHAR(rl_routes.CODDIV)))
                 AND TRIM(UPPER(CODART)) =
                     TRIM(UPPER(TO_CHAR(GET_PRODUCT_CODE(RL_ROUTES.CODDIV,RL_ROUTES.CODART))))
                 AND (DTESTART <= rl_routes.DTEEND)
                 AND (rl_routes.DTESTART <= DTEEND)
                 AND ROWNUM = 1
               ORDER BY C_DTEMOD DESC;
            
              IF (VL_OPDATEMOD < rl_routes.DTEEND AND
                 rl_routes.DTEEND >= SYSDATE AND
                 VL_IDBUDGETENDDATEUP >= SYSDATE) THEN
                -- end date of new budget should not be less than the last operation date,  for updation
              
                UPDATE TA3100BUDGETGROUP
                   SET DESBUDGETGROUP     = trim(rl_routes.DESBUDGETGROUP),
                       DTEEND            =
                       (rl_routes.DTEEND),
                       CODSTATUS         =
                       (rl_routes.CODSTATUS),
                       FLGNEGATIVEALLOWED =
                       (rl_routes.FLGNEGATIVEALLOWED)
                 WHERE IDBUDGETGROUP = VL_IDBUDGETGROUP; -- remaining fields can't change once it is created
              
                UPDATE TA3102BUDGET
                   SET DTEBALANCECALCULATION = TRUNC(SYSDATE),
                       DTEMOD                = xsysdate,
                       VALBALANCE            = VALBALANCE +
                                               trim(rl_routes.VALMOVEMENT) -- old balance + new movement = new balance
                 WHERE IDBUDGETGROUP = VL_IDBUDGETGROUP
                   AND IDBUGET = VL_IDBUGET;
              
                SELECT CONCAT(TO_CHAR('000000000000000'),
                              to_char(systimestamp, 'yyMMddHHmmssFF3'))
                  INTO VL_IDOPERATION
                  FROM DUAL;
              
                INSERT INTO TA3104BUDGETOPERATIONS
                  (
                   
                   IDBUGET,
                   IDOPERATION,
                   CODUSR,
                   DTEMOD,
                   CODOPERATIONTYPE,
                   TRANSACTIONDOCKEY,
                   DTETOSERVER,
                   VALMOVEMENT)
                VALUES
                  (VL_IDBUGET,
                   VL_IDOPERATION,
                   VL_CODUSRCRE,
                   trim(xsysdate),
                   'M',
                   VL_TRANSACTIONDOCKEY,
                   '',
                   trim(rl_routes.VALMOVEMENT));
              
                VL_MESSAGE_H := ' Row Updated ';
                INSERT INTO LOG_XIN_TA3100BUDGET
                  (logid_xin, discription, status, xin_proc, datetime)
                Values
                  (rl_routes.bid,
                   VL_MESSAGE_H,
                   1,
                   'Z_SP_IMPORT_BUDGET_XIN',
                   xsysdate);
              
                -- Update SM1 Status in XIN_TA3100BUDGET table as 1
                UPDATE XIN_TA3100BUDGET
                   SET sm1status = 1
                 WHERE bid = rl_routes.bid;
              
                VL_MESSAGE_H := ' XIN_TA3100BUDGET sm1status = 1 Updated ';
                INSERT INTO LOG_XIN_TA3100BUDGET
                  (logid_xin, discription, status, xin_proc, datetime)
                Values
                  (rl_routes.bid,
                   VL_MESSAGE_H,
                   1,
                   'Z_SP_IMPORT_BUDGET_XIN',
                   xsysdate);
              
              ELSE
              
                UPDATE TA3100BUDGETGROUP
                   SET DESBUDGETGROUP     = trim(rl_routes.DESBUDGETGROUP), -- since last  opeartion date is higher than dteend of new budget , dteend won't get updated
                       CODSTATUS         =
                       (rl_routes.CODSTATUS),
                       FLGNEGATIVEALLOWED =
                       (rl_routes.FLGNEGATIVEALLOWED)
                 WHERE IDBUDGETGROUP = VL_IDBUDGETGROUP; -- remaining fields can't change once it is created
              
                UPDATE TA3102BUDGET
                   SET DTEBALANCECALCULATION = TRUNC(SYSDATE),
                       DTEMOD                = xsysdate,
                       VALBALANCE            = VALBALANCE +
                                               trim(rl_routes.VALMOVEMENT) -- old balance + new movement = new balance
                 WHERE IDBUDGETGROUP = VL_IDBUDGETGROUP
                   AND IDBUGET = VL_IDBUGET;
              
                SELECT CONCAT(TO_CHAR('000000000000000'),
                              to_char(systimestamp, 'yyMMddHHmmssFF3'))
                  INTO VL_IDOPERATION
                  FROM DUAL;
              
                INSERT INTO TA3104BUDGETOPERATIONS
                  (IDBUGET,
                   IDOPERATION,
                   CODUSR,
                   DTEMOD,
                   CODOPERATIONTYPE,
                   TRANSACTIONDOCKEY,
                   DTETOSERVER,
                   VALMOVEMENT)
                VALUES
                  (VL_IDBUGET,
                   VL_IDOPERATION,
                   VL_CODUSRCRE,
                   trim(xsysdate),
                   'M',
                   VL_TRANSACTIONDOCKEY,
                   '',
                   trim(rl_routes.VALMOVEMENT));
              
                VL_MESSAGE_H := ' Row Updated ';
                INSERT INTO LOG_XIN_TA3100BUDGET
                  (logid_xin, discription, status, xin_proc, datetime)
                Values
                  (rl_routes.bid,
                   VL_MESSAGE_H,
                   1,
                   'Z_SP_IMPORT_BUDGET_XIN',
                   xsysdate);
              
                -- Update SM1 Status in XIN_TA3100BUDGET table as 1
                UPDATE XIN_TA3100BUDGET
                   SET sm1status = 1
                 WHERE bid = rl_routes.bid;
                VL_MESSAGE_H := ' XIN_TA3100BUDGET sm1status = 1 Updated ';
                INSERT INTO LOG_XIN_TA3100BUDGET
                  (logid_xin, discription, status, xin_proc, datetime)
                Values
                  (rl_routes.bid,
                   VL_MESSAGE_H,
                   1,
                   'Z_SP_IMPORT_BUDGET_XIN',
                   xsysdate);
              
              END IF;
            
            ELSE
            
              SELECT IDBUDGETGROUP, DTEEND
                INTO VL_IDBUDGETGROUP, VL_IDBUDGETENDDATEUP
                FROM XIN_VIEW_PROC_IMPORTBUDGET
               WHERE TRIM(UPPER(CODBUDGETTYPE)) =
                     TRIM(UPPER(TO_CHAR(rl_routes.CODBUDGETTYPE)))
                 AND trim(UPPER(CODSTATUS)) = '0'
                 AND TRIM(UPPER(CODLEVEL)) = trim(UPPER(rl_routes.CODLEVEL))
                 AND TRIM(UPPER(CODDIV)) =
                     TRIM(UPPER(TO_CHAR(rl_routes.CODDIV)))
                 AND TRIM(UPPER(CODART)) =
                     TRIM(UPPER(TO_CHAR(GET_PRODUCT_CODE(RL_ROUTES.CODDIV,RL_ROUTES.CODART))))
                 AND (DTESTART <= rl_routes.DTEEND)
                 AND (rl_routes.DTESTART <= DTEEND)
                 AND ROWNUM = 1
               ORDER BY C_DTEMOD DESC;
            
              IF (rl_routes.DTEEND >= SYSDATE AND
                 VL_IDBUDGETENDDATEUP >= SYSDATE) THEN
              
                -- end date of new budget and old budget should be after sysdate  for updation
                UPDATE TA3100BUDGETGROUP
                   SET DESBUDGETGROUP     = trim(rl_routes.DESBUDGETGROUP),
                       DTEEND            =
                       (rl_routes.DTEEND),
                       CODSTATUS         =
                       (rl_routes.CODSTATUS),
                       FLGNEGATIVEALLOWED =
                       (rl_routes.FLGNEGATIVEALLOWED)
                 WHERE IDBUDGETGROUP = VL_IDBUDGETGROUP; -- remaining fields can't change once it is created
              
                SELECT CONCAT(TO_CHAR('000000000000000'),
                              to_char(systimestamp, 'yyMMddHHmmssFF3'))
                  INTO VL_DOCKEYBUDET
                  FROM DUAL;
              
                VL_DOCKEYBUDET := CONCAT('000000000000000',
                                         VL_DOCKEYBUDET + rl_routes.ROWNUM); -- adding rownumber to avoid duplicated when timestap is same
                VL_DOCUMENTKEY := CONCAT('Budget|', VL_DOCKEYBUDET);
              
                INSERT INTO TA3102BUDGET
                  (IDBUGET,
                   IDBUDGETGROUP,
                   CODUSR,
                   CODDIV,
                   VALBALANCE,
                   DTEBALANCECALCULATION,
                   DTEEND,
                   FLGANN,
                   CODUSRCRE,
                   DTECRE,
                   CODUSRMOD,
                   DTEMOD,
                   IDSESSIONLCK,
                   CODUSRLCK,
                   DTELCK,
                   DTETOHOST,
                   CODUSRMODREAL,
                   CODUSRCREREAL,
                   DOCUMENTKEY)
                VALUES
                  (VL_DOCKEYBUDET,
                   VL_IDBUDGETGROUP,
                   trim(rl_routes.CODUSR),
                   trim(rl_routes.CODDIV),
                   trim(rl_routes.VALDEFAULT), -- during initialization VALDEFAULT,VALBALANCE & VALMOVEMENT should be equal
                   trim(rl_routes.DTEBALANCECALCULATION),
                   trim(rl_routes.DTEEND),
                   VL_FLGANN,
                   '',
                   TO_DATE('12/30/1899', 'MM/DD/YYYY'),
                   '',
                   xsysdate,
                   VL_IDSESSIONLCK,
                   VL_CODUSRLCK,
                   '',
                   '',
                   VL_CODUSRMODREAL,
                   VL_CODUSRCREREAL,
                   VL_DOCUMENTKEY);
              
                SELECT CONCAT(TO_CHAR('000000000000000'),
                              to_char(systimestamp, 'yyMMddHHmmssFF3'))
                  INTO VL_IDOPERATION
                  FROM DUAL;
              
                INSERT INTO TA3104BUDGETOPERATIONS
                  (IDBUGET,
                   IDOPERATION,
                   CODUSR,
                   DTEMOD,
                   CODOPERATIONTYPE,
                   TRANSACTIONDOCKEY,
                   DTETOSERVER,
                   VALMOVEMENT)
                VALUES
                  (VL_DOCKEYBUDET,
                   VL_IDOPERATION,
                   VL_CODUSRCRE,
                   trim(xsysdate),
                   'I',
                   VL_TRANSACTIONDOCKEY,
                   '',
                   trim(rl_routes.VALDEFAULT)); -- during initialization VALDEFAULT,VALBALANCE & VALMOVEMENT should be equal
              
                VL_MESSAGE_H := ' Row Created ';
                INSERT INTO LOG_XIN_TA3100BUDGET
                  (logid_xin, discription, status, xin_proc, datetime)
                Values
                  (rl_routes.bid,
                   VL_MESSAGE_H,
                   1,
                   'Z_SP_IMPORT_BUDGET_XIN',
                   xsysdate);
              
                -- Update SM1 Status in XIN_TA3100BUDGET table as 1
                UPDATE XIN_TA3100BUDGET
                   SET sm1status = 1
                 WHERE bid = rl_routes.bid;
              
                VL_MESSAGE_H := ' XIN_TA3100BUDGET sm1status = 1 Updated ';
                INSERT INTO LOG_XIN_TA3100BUDGET
                  (logid_xin, discription, status, xin_proc, datetime)
                Values
                  (rl_routes.bid,
                   VL_MESSAGE_H,
                   1,
                   'Z_SP_IMPORT_BUDGET_XIN',
                   xsysdate);
              
              ELSE
              
                UPDATE TA3100BUDGETGROUP
                   SET DESBUDGETGROUP     = trim(rl_routes.DESBUDGETGROUP), -- since last  opeartion date is higher than dteend of new budget , dteend won't get updated
                       CODSTATUS         =
                       (rl_routes.CODSTATUS),
                       FLGNEGATIVEALLOWED =
                       (rl_routes.FLGNEGATIVEALLOWED)
                 WHERE IDBUDGETGROUP = VL_IDBUDGETGROUP; -- remaining fields can't change once it is created
              
                SELECT CONCAT(TO_CHAR('000000000000000'),
                              to_char(systimestamp, 'yyMMddHHmmssFF3'))
                  INTO VL_DOCKEYBUDET
                  FROM DUAL;
              
                VL_DOCKEYBUDET := CONCAT('000000000000000',
                                         VL_DOCKEYBUDET + rl_routes.ROWNUM); -- adding rownumber to avoid duplicated when timestap is same
                VL_DOCUMENTKEY := CONCAT('Budget|', VL_DOCKEYBUDET);
              
                INSERT INTO TA3102BUDGET
                  (IDBUGET,
                   IDBUDGETGROUP,
                   CODUSR,
                   CODDIV,
                   VALBALANCE,
                   DTEBALANCECALCULATION,
                   DTEEND,
                   FLGANN,
                   CODUSRCRE,
                   DTECRE,
                   CODUSRMOD,
                   DTEMOD,
                   IDSESSIONLCK,
                   CODUSRLCK,
                   DTELCK,
                   DTETOHOST,
                   CODUSRMODREAL,
                   CODUSRCREREAL,
                   DOCUMENTKEY)
                VALUES
                  (VL_DOCKEYBUDET,
                   VL_IDBUDGETGROUP,
                   trim(rl_routes.CODUSR),
                   trim(rl_routes.CODDIV),
                   trim(rl_routes.VALDEFAULT), -- during initialization VALDEFAULT,VALBALANCE & VALMOVEMENT should be equal
                   trim(rl_routes.DTEBALANCECALCULATION),
                   trim(rl_routes.DTEEND),
                   VL_FLGANN,
                   '',
                   TO_DATE('12/30/1899', 'MM/DD/YYYY'),
                   '',
                   xsysdate,
                   VL_IDSESSIONLCK,
                   VL_CODUSRLCK,
                   '',
                   '',
                   VL_CODUSRMODREAL,
                   VL_CODUSRCREREAL,
                   VL_DOCUMENTKEY);
              
                SELECT CONCAT(TO_CHAR('000000000000000'),
                              to_char(systimestamp, 'yyMMddHHmmssFF3'))
                  INTO VL_IDOPERATION
                  FROM DUAL;
              
                INSERT INTO TA3104BUDGETOPERATIONS
                  (IDBUGET,
                   IDOPERATION,
                   CODUSR,
                   DTEMOD,
                   CODOPERATIONTYPE,
                   TRANSACTIONDOCKEY,
                   DTETOSERVER,
                   VALMOVEMENT)
                VALUES
                  (VL_DOCKEYBUDET,
                   VL_IDOPERATION,
                   VL_CODUSRCRE,
                   trim(xsysdate),
                   'I',
                   VL_TRANSACTIONDOCKEY,
                   '',
                   trim(rl_routes.VALDEFAULT)); -- during initialization VALDEFAULT,VALBALANCE & VALMOVEMENT should be equal
              
                VL_MESSAGE_H := ' Row Created ';
                INSERT INTO LOG_XIN_TA3100BUDGET
                  (logid_xin, discription, status, xin_proc, datetime)
                Values
                  (rl_routes.bid,
                   VL_MESSAGE_H,
                   1,
                   'Z_SP_IMPORT_BUDGET_XIN',
                   xsysdate);
              
                -- Update SM1 Status in XIN_TA3100BUDGET table as 1
                UPDATE XIN_TA3100BUDGET
                   SET sm1status = 1
                 WHERE bid = rl_routes.bid;
              
                VL_MESSAGE_H := ' XIN_TA3100BUDGET sm1status = 1 Updated ';
                INSERT INTO LOG_XIN_TA3100BUDGET
                  (logid_xin, discription, status, xin_proc, datetime)
                Values
                  (rl_routes.bid,
                   VL_MESSAGE_H,
                   1,
                   'Z_SP_IMPORT_BUDGET_XIN',
                   xsysdate);
              
              END IF;
            END IF;
          END IF;
          
          VL_INS_T3100 := VL_INS_T3100 + 1;
        END IF;
      ELSE
        VL_STATUS := -1;
        VL_MESSAGE_H := VL_MESSAGE_H || ' / ' || ' ERROR : Start date is less than today';
      END IF;
      
      IF (VL_STATUS <> 0) THEN
        PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                       VL_PROGR_D_T3100,
                                       SQLCODE,
                                       VL_MESSAGE_H);
        UPDATE XIN_TA3100BUDGET
           SET sm1status = 9
         WHERE bid = rl_routes.bid;
      END IF;
    END LOOP;
    COMMIT;
    
    BEGIN
        
      UPDATE XIN_TA3100BUDGET
         SET SM1STATUS = 0
       WHERE SM1STATUS = C_XINSTATUS_LOCK
         AND CODDIV = 'SYG';
      COMMIT;
        
    EXCEPTION
      WHEN OTHERS THEN
        ROLLBACK;
        VL_MESSAGE_H := 'Error while updating Staging area: XIN_TA3100BUDGET';
        RAISE EX_EXIT;
    END;
    
    PKG_UTILS.LOG_END_DETAIL(PI_PROGR_H,
                             VL_PROGR_D_T3100,
                             0,
                             VL_COUNT_XIN_T3100,
                             VL_INS_T3100,
                             VL_COUNT_XIN_T3100 - VL_INS_T3100);

    PO_MSG    := VL_INS_T3100 || '/' || VL_COUNT_XIN_T3100 || ' Budgets loaded';
    PO_STATUS := VL_INS_T3100;
        
  EXCEPTION
    WHEN EX_EXIT THEN

      ROLLBACK;
      VL_MESSAGE_H       := VL_MESSAGE_H || TRIM(SUBSTR(dbms_utility.format_error_backtrace() || ' ' || SQLERRM, 1, 255));
      PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                     VL_PROGR_D_T3100,
                                     SQLCODE,
                                     VL_MESSAGE_H);

      PO_MSG := VL_MESSAGE_H;
      PO_STATUS := -1;
  
    WHEN OTHERS THEN
      VL_STATUS := -1;

      ROLLBACK;
      VL_MESSAGE_H       := VL_MESSAGE_H || TRIM(SUBSTR(dbms_utility.format_error_backtrace() || ' ' || SQLERRM, 1, 255));
      PKG_UTILS.LOG_NEW_DETAIL_ERROR(PI_PROGR_H,
                                     VL_PROGR_D_T3100,
                                     SQLCODE,
                                     VL_MESSAGE_H);

      PO_MSG := VL_MESSAGE_H;
      PO_STATUS := VL_STATUS;
    
  END LOAD_TA3100_BUDGET_SYG;

  /*============================================================================*/
  /*                 Main procedure for loading data                            */

  -- This is the Main wrapper to all the procedure in this package
  -- Updates:

  -- 2014 07 14; 020: Mbandiera; WI 32087;  some changes in T078WHSBALANCE import
  -- T078 loading will be splitted from T060 import . it will be a loading procedure  aside the article one.

  -- 2013 12 04; 012; Mbandiera; WI 28211; TA5150 AND TA5151 created after Product loading
  --                                       when SM1 PROMO module is active
  /*============================================================================*/
  PROCEDURE MAINLOAD(PI_OPERATION    IN VARCHAR2,
                   PO_CODPROCESS    OUT NUMBER,
                   PO_MSG           OUT VARCHAR2,
                   PO_STATUS        OUT NUMBER,
                   PI_CODE_CHAR_A IN VARCHAR2 DEFAULT NULL,
                   PI_CODE_CHAR_B  IN VARCHAR2 DEFAULT NULL,
                   PI_CODE_NUM_A IN NUMBER DEFAULT NULL,
                   PI_CODE_NUM_B  IN NUMBER DEFAULT NULL,
                   PI_DATE_A       IN DATE DEFAULT NULL,
                   PI_DATE_B        IN DATE DEFAULT NULL) IS
    --

    VL_MESSAGE_H   VARCHAR2(4000) := 'Error while loading PKG_XTEL_IMPORT_C.MAINLOAD';
    VL_MESSAGE_D   VARCHAR2(4000) := NULL;
    --
    VL_PROGR_D NUMBER := NULL;
    VL_OPERATION      VARCHAR2(30) := TRIM(UPPER(PI_OPERATION));
    --
    VL_SESSION_ID NUMBER := 0;
    --
    EX_EXIT EXCEPTION;
    --
    VL_PROMO_MODULE_ACTIVATED NUMBER(1);
    --
  BEGIN

    -- -----------------------------------------------------
     -- Open the log on T800SYSTEMACTIVITYLOG
    PO_CODPROCESS := PKG_UTILS.LOG_START('IMPORT',
                                         VL_OPERATION,
                                         NULL,
                                         NULL,
                                         'PKG_XTEL_IMPORT_C');

    -- ------------------------------------------------------


    -- set format for Numbers:
    -- DECIMAL SEPARATOR . (point)
    -- GROUPING SEPARATON (null)
    EXECUTE IMMEDIATE (' alter session set NLS_NUMERIC_CHARACTERS =  ''. ''');
    EXECUTE IMMEDIATE (' alter session set NLS_LENGTH_SEMANTICS =  ''BYTE''');

    -- F_CHECK if the parameter is missing
    IF VL_OPERATION IS NULL THEN
      VL_MESSAGE_D   := 'Parameter "Operation" Missing';
      RAISE EX_EXIT;
    END IF;


    --LOGIN
    -- Second parameter = 0  because the package must not start again when is already running with same operation
    -- you can run loading CUSTOMERS and PRODUCTS at same time, but you cannot run PRODUCTS if there is another product job running
    VL_SESSION_ID := F_USER_LOGIN('SYSH',0,'PKG_XTEL_IMPORT_C-'||VL_OPERATION,NULL);

    IF VL_SESSION_ID IS NULL THEN
         VL_MESSAGE_D   :=  'Import Procedure Cannot Run. Uer SYSH is already logged in';
         RAISE EX_EXIT;
    END IF;

    -- -------------------------------------------
    --- we control if Promo Module is activated
    --- When Promo Module is activated
      --- Promo Product Hierarchy (TA5150) and
      --- Promo Product Display list (TA5151)
    --- must be refresched after Product loading
    -- --------------------------------------------

    VL_PROMO_MODULE_ACTIVATED := 0;
    BEGIN
     SELECT count(*) into VL_PROMO_MODULE_ACTIVATED FROM TA5100PROMOCONFIG t WHERE t.codpromoconfig = 'PROMO';
    EXCEPTION WHEN OTHERS THEN
      VL_PROMO_MODULE_ACTIVATED := 0;
    END;


    -- Load decode tables T900 - T902
    IF VL_OPERATION = 'ALL' OR VL_OPERATION = 'DECODE_TAB' THEN

      -- pi_code_char_a = HEAD+DET it reards t900 and t902
      -- pi_code_char_a = !HEAD+DET it reards only t902

      LOAD_T90X_DECODES(PO_CODPROCESS,VL_SESSION_ID, PI_CODE_CHAR_A, PO_MSG, PO_STATUS);

    END IF;

      -- Load decode table T920EXCHANGERAT
    IF VL_OPERATION = 'ALL' OR VL_OPERATION = 'EXCHANGE_RATES' THEN

        LOAD_T920_EXCHANGERATES(PO_CODPROCESS,VL_SESSION_ID, PO_MSG, PO_STATUS);

    END IF;

    -- Load Users T030 - T031
    IF VL_OPERATION = 'ALL' OR VL_OPERATION = 'USERS' THEN
      LOAD_T03X_USERS(PO_CODPROCESS,VL_SESSION_ID, PO_MSG, PO_STATUS);
    END IF;
    --
    --
    -- CLoad Customers TA1056 - T041 - T042 - T045 - T046 - T047 - T049
    IF VL_OPERATION = 'ALL' OR VL_OPERATION = 'CUSTOMERS' THEN
       LOAD_T04X_CUSTOMERS(PO_CODPROCESS,VL_SESSION_ID, PO_MSG, PO_STATUS);
    END IF;
    --
    -- CLoad Customers Credit info T048PARTYAMOUNT
    IF VL_OPERATION = 'ALL' OR VL_OPERATION = 'CUSTOMER_CREDIT' THEN
      LOAD_T048_CREDIT(PO_CODPROCESS,VL_SESSION_ID, PO_MSG, PO_STATUS);
    END IF;

    --
    -- CLoad links between PDV adn PDC TA1110PDV_PDC
    IF VL_OPERATION = 'ALL' OR VL_OPERATION = 'PDV_PDC_LINK' THEN
      LOAD_TA1110_PDV_PDC(PO_CODPROCESS,VL_SESSION_ID, PO_MSG, PO_STATUS);
    END IF;

    --
    -- Load Articles T060 ARTICLE
    IF VL_OPERATION = 'ALL' OR VL_OPERATION = 'PRODUCTS' THEN
      LOAD_T06X_PRODUCTS(PO_CODPROCESS,VL_SESSION_ID, PO_MSG, PO_STATUS);

      IF ( PO_STATUS >= 0 AND VL_PROMO_MODULE_ACTIVATED > 0 ) THEN

          LOAD_TA5150_PROMO_HIER(PO_CODPROCESS, PO_MSG, PO_STATUS);
          LOAD_TA5151_PROMODISPLAYS(PO_CODPROCESS, PO_MSG, PO_STATUS);

      END IF;
    END IF;
    --
    -- Load Articles T064PARTLIST KIT
    IF VL_OPERATION = 'ALL' OR VL_OPERATION = 'KIT' THEN
      LOAD_T064_PARTLIST(PO_CODPROCESS,VL_SESSION_ID, PO_MSG, PO_STATUS);
   END IF;

      --
    -- Load Articles T078WHSBALANCE
    IF VL_OPERATION = 'ALL' OR VL_OPERATION = 'WHSBALANCE' THEN
      LOAD_T078_WHSBALANCE(PO_CODPROCESS,VL_SESSION_ID, PO_MSG, PO_STATUS);
    END IF;

     --
    -- Load Price List T070 - T074
    IF VL_OPERATION = 'ALL' OR VL_OPERATION = 'PRICE_LIST' THEN
      LOAD_T07X_PRICELIST(PO_CODPROCESS,VL_SESSION_ID, PO_MSG, PO_STATUS);
    END IF;

      -- Load Hierarchies TB0042
    IF VL_OPERATION = 'ALL' OR VL_OPERATION = 'HIERARCHIES' THEN
      LOAD_TB0042_HIERARCHIES(PO_CODPROCESS,VL_SESSION_ID, PO_MSG, PO_STATUS);
    END IF;
    --
      -- Customer Responsibility T043
    IF VL_OPERATION = 'ALL' OR VL_OPERATION = 'RESPONSIBILITY' THEN
      PKG_SM1_CUSTOM.AGGIORNA_UTENTI_T043(PO_CODPROCESS,NULL);
    END IF;


      -- Load Suppliers TA1056 TA1057
    IF VL_OPERATION = 'ALL' OR VL_OPERATION = 'SUPPLIERS'  THEN
      LOAD_TA1056_SUPPLIERS(PO_CODPROCESS,VL_SESSION_ID, PO_MSG, PO_STATUS);
    END IF;


         --
    -- Load Open Invoices T096PARTYBALANCE
    IF VL_OPERATION = 'ALL' OR VL_OPERATION = 'OPEN_INVOICES' THEN
      LOAD_T096_OPEN_INVOICES(PO_CODPROCESS,VL_SESSION_ID, PO_MSG, PO_STATUS);
    END IF;

      -- Load Orders T100ORDHEAD/T106ORDROW
    IF VL_OPERATION = 'ALL' OR VL_OPERATION = 'ORDERS' THEN
      LOAD_T100_ORDERS(PO_CODPROCESS,VL_SESSION_ID, PO_MSG, PO_STATUS);
    END IF;
    
       IF VL_OPERATION = 'ALL' OR VL_OPERATION = 'ORDERS_KD' THEN
      LOAD_T100_ORDERS_KD(PO_CODPROCESS,VL_SESSION_ID, PO_MSG, PO_STATUS);
    END IF;
    
    IF VL_OPERATION = 'ALL' OR VL_OPERATION = 'ORDERS_50' THEN
      LOAD_T100_ORDERS_50(PO_CODPROCESS,VL_SESSION_ID, PO_MSG, PO_STATUS);
    END IF;
    IF VL_OPERATION = 'ALL' OR VL_OPERATION = 'ORDERS_51' THEN
      LOAD_T100_ORDERS_51(PO_CODPROCESS,VL_SESSION_ID, PO_MSG, PO_STATUS);
    END IF;
    IF VL_OPERATION = 'ALL' OR VL_OPERATION = 'LOAD_T100_ORDERS_SYG' THEN
      LOAD_T100_ORDERS_SYG(PO_CODPROCESS,VL_SESSION_ID, PO_MSG, PO_STATUS);
    END IF;
      IF VL_OPERATION = 'ALL' OR VL_OPERATION = 'LOAD_T100_ORDERS_SYG_51' THEN
      LOAD_T100_ORDERS_SYG_51(PO_CODPROCESS,VL_SESSION_ID, PO_MSG, PO_STATUS);
    END IF;
         --
    -- Load Open Invoices T660CONT_ATT
    IF VL_OPERATION = 'ALL' OR VL_OPERATION = 'INVOICES' THEN
      LOAD_T660_INVOICES(PO_CODPROCESS,VL_SESSION_ID, PO_MSG, PO_STATUS);
    END IF;

            --
    -- Load Projected Invoices T661REAL
    IF VL_OPERATION = 'ALL' OR VL_OPERATION = 'PROJECTED_INVOICES' THEN
      LOAD_T661_REAL(PO_CODPROCESS,VL_SESSION_ID, PO_MSG, PO_STATUS);
    END IF;


    -- Load Passive Invoices ta1050/ta1052
    IF VL_OPERATION = 'ALL' OR VL_OPERATION = 'PASSIVE_INVOICES' THEN
      LOAD_TA105X_PASSIVEINVOICE(PO_CODPROCESS,VL_SESSION_ID, PO_MSG, PO_STATUS);
    END IF;
           --
    -- Load Activities on survey tables TA0191
    IF VL_OPERATION = 'ALL' OR VL_OPERATION = 'SURVEYS' THEN
      LOAD_TA019X_SURVEYS(PO_CODPROCESS,VL_SESSION_ID, PO_MSG, PO_STATUS);
    END IF;



    -- Load Promotions product hierarchy table TA5152PROMOARTICLES_LIST ( ONLY IF PROMO MODULE HAS BEEN ACTIVATED )
    IF VL_OPERATION = 'ALL' OR VL_OPERATION = 'PROMO_LIST' AND VL_PROMO_MODULE_ACTIVATED > 0 THEN
      LOAD_TA5152_PROMOARTICLE_LIST(PO_CODPROCESS,VL_SESSION_ID, PO_MSG, PO_STATUS);
    END IF;

    -- Load Promotions tables TA500X
    IF VL_OPERATION = 'ALL' OR VL_OPERATION = 'PROMO'  THEN
      LOAD_TA50X_PROMO(PO_CODPROCESS,VL_SESSION_ID, PO_MSG, PO_STATUS);

    END IF;
  
    -- Load customer payment mode for SYG division
    IF VL_OPERATION = 'ALL' OR VL_OPERATION = 'PAYMOD_SYG' THEN
      LOAD_T041_PAYMOD_SYG(PO_CODPROCESS, VL_SESSION_ID, PO_MSG, PO_STATUS);
    END IF;
    
    -- Load customer credit limit for SYG division
    IF VL_OPERATION = 'ALL' OR VL_OPERATION = 'CREDITLIMIT_SYG' THEN
      LOAD_T048_CREDIT_SYG(PO_CODPROCESS, VL_SESSION_ID, PO_MSG, PO_STATUS);
    END IF;
    
    -- Load products for SYG Division
    IF VL_OPERATION = 'ALL' OR VL_OPERATION = 'PRODUCTS_SYG' THEN
      LOAD_T060_PRODUCTS_SYG(PO_CODPROCESS, VL_SESSION_ID, PO_MSG, PO_STATUS);
    END IF;
    
    -- Load products unit of measure for SYG Division
    IF VL_OPERATION = 'ALL' OR VL_OPERATION = 'PRODUCTSUOM_SYG' THEN
      LOAD_T062_PRODUCTSUOM_SYG(PO_CODPROCESS, VL_SESSION_ID, PO_MSG, PO_STATUS);
    END IF;
   
    -- Load vanload orders for SYG Division
    IF VL_OPERATION = 'ALL' OR VL_OPERATION = 'ORDERS_50_SYG' THEN
      LOAD_T100_ORDERS_50_SYG(PO_CODPROCESS,VL_SESSION_ID, PO_MSG, PO_STATUS);
    END IF;
    
    -- Load van integration orders for SYG Division
    IF VL_OPERATION = 'ALL' OR VL_OPERATION = 'ORDERS_51_SYG' THEN
      LOAD_T100_ORDERS_51_SYG(PO_CODPROCESS,VL_SESSION_ID, PO_MSG, PO_STATUS);
    END IF;
    
    -- Load KD Order Response for SYG Division
    IF VL_OPERATION = 'ALL' OR VL_OPERATION = 'ORDERS_KD_SYG' THEN
      LOAD_T100_ORDERS_KD_SYG(PO_CODPROCESS,VL_SESSION_ID, PO_MSG, PO_STATUS);
    END IF;
    
    -- Load KD Budget for SYG Division
    IF VL_OPERATION = 'ALL' OR VL_OPERATION = 'KD_BUDGET_SYG' THEN
      LOAD_TA3100_BUDGET_SYG(PO_CODPROCESS,VL_SESSION_ID, PO_MSG, PO_STATUS);
    END IF;
    
    -- Load Presales Budget for SYG Division
    IF VL_OPERATION = 'ALL' OR VL_OPERATION = 'PRESALES_BUDGET_SYG' THEN
      LOAD_TA3100_BUDGET_SYG(PO_CODPROCESS,VL_SESSION_ID, PO_MSG, PO_STATUS);
    END IF;
    
    -- Closes log on T800
    PKG_UTILS.LOG_END(PO_CODPROCESS, 0);



    -- ------------------------
    -- COMING SOON ....????.....
    --- ------------------------
    -- Carica Articoli Sostitutivi T066
    -- Carica Articoli Decodificati T068
    -- Carica Listini Sconto T075 - T076 - T073
    -- Carica Assortimenti T080
    -- Carica Proposte T666
    -- -------------------------



    --LOGOUT USER
    PKG_UTILS.USER_LOGOUT(VL_SESSION_ID);
  EXCEPTION
   WHEN EX_EXIT THEN

     ROLLBACK;

      VL_PROGR_D := PKG_UTILS.LOG_NEW_DETAIL(PO_CODPROCESS,
                                            'LOG',
                                            'MAINLOAD ERROR ',
                                            0,
                                            NULL);

      VL_MESSAGE_H := SUBSTR(VL_MESSAGE_H||' '||VL_MESSAGE_D||' '||dbms_utility.format_error_backtrace() || ' ' || SQLERRM,1,2000);

      PKG_UTILS.LOG_NEW_DETAIL_ERROR(PO_CODPROCESS,
                                              VL_PROGR_D,
                                              SQLCODE,
                                              VL_MESSAGE_H);

      --
      PKG_UTILS.LOG_END_DETAIL(PO_CODPROCESS,
                                        VL_PROGR_D,
                                        0,
                                        1,
                                        1,
                                        0);
      --
      PKG_UTILS.LOG_END(PO_CODPROCESS, 0);

      PO_MSG := VL_MESSAGE_H;
      PO_STATUS := -1;

    WHEN OTHERS THEN

     ROLLBACK;
      --LOGOUT USER
      PKG_UTILS.USER_LOGOUT(VL_SESSION_ID);

      -- Manage errors in Load operation
      IF PO_CODPROCESS IS NULL THEN
      PO_CODPROCESS := PKG_UTILS.LOG_START('IMPORT',
                                        'LOG',
                                         NULL,
                                         NULL,
                                        'PKG_XTEL_IMPORT_C');
      END IF;

      VL_PROGR_D := PKG_UTILS.LOG_NEW_DETAIL(PO_CODPROCESS,
                                             'LOG',
                                             'MAINLOAD ERROR ',
                                              0,
                                             NULL);
      VL_MESSAGE_H := SUBSTR(VL_MESSAGE_H||' '||VL_MESSAGE_D||' '||dbms_utility.format_error_backtrace() || ' ' || SQLERRM,1,2000);

      PKG_UTILS.LOG_NEW_DETAIL_ERROR(PO_CODPROCESS,
                                     VL_PROGR_D,
                                     SQLCODE,
                                     VL_MESSAGE_H);
      --
      PKG_UTILS.LOG_END_DETAIL(PO_CODPROCESS,
                                        VL_PROGR_D,
                                        0,
                                        1,
                                        1,
                                        0);
      --
      PKG_UTILS.LOG_END(PO_CODPROCESS, 0);

      PO_MSG := VL_MESSAGE_H;
      PO_STATUS := -1;

      --
  END MAINLOAD;

END PKG_XTEL_IMPORT_C;

/*EOS*/
/
